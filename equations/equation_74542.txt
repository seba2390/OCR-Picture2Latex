\begin{align}g_t(x) = ( f(x) -y )\cdot \diag\{\phi'( (M \circ W(t))^\top\cdot x)\} \cdot a\end{align}