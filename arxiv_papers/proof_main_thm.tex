\subsection{Proofs for Theorem \ref{error_bound}}\label{main2}
Before proving the theorem, we first present some useful results that will be used in the proof of Theorem \ref{error_bound}. Lemma \ref{error_rademacher} upper bounds the difference between empirical loss and population loss by an application of bounded difference inequality and a standard symmetrization argument. Lemma \ref{error_dtv} relates excess risks with the total variation distance between probability distributions. For notation simplicity, we denote $\E_{(x,y)\sim\P_{\phi,\psi}(x,y)}$ by $\E_{\phi,\psi}$ in the following. We further denote by $\E$ the expectation taken over the  ground truth parameter, i.e., $\E:=\E_{(x,y)\sim\P_{\phi^* ,\psi^* }(x,y)}$.

\begin{lemma} \label{error_rademacher}
Suppose that $\ell(\cdot,\cdot)$ is a $L$-bounded loss function. For any given $\phi \in \Phi$, with probability at least $1-\delta$, 
\%
\sup_{\psi \in \Psi}\bigg|\mathbb{E} [\ell (g_{\phi, \psi}(x),y)] - \frac{1}{n}\sum_{j=1}^{n} \ell (g_{\phi, \psi}(x_{j}),y_{j}) \bigg| \leq R_{n} (\ell \circ \mathcal{G}_{\phi, \Psi}) + L\sqrt{\frac{2\log (2/\delta)}{n}},
\%
where $R_{n} (\ell \circ \mathcal{G}_{\phi, \Psi})$ is the Rademacher complexity of the function class $\ell \circ \mathcal{G}_{\phi, \Psi}$ defined in Theorem \ref{error_bound}.
\end{lemma}
\begin{proof}[Proof of Lemma \ref{error_rademacher}]
First notice that, 
when a pair $(x_{j},y_{j})$ changes, since $\ell$ is $L$-bounded, the random variable 
\%
\sup_{\psi \in \Psi} \bigg( \mathbb{E} [\ell (g_{\phi, \psi}(x),y)] - \frac{1}{n}\sum_{j=1}^{n} \ell (g_{\phi, \psi}(x_{j}),y_{j}) \bigg )
\%
can change by no more than $2L/n$. McDiarmidâ€™s inequality implies that with probability at least $1-\delta/2$,
\begin{align}
& \sup_{\psi \in \Psi} \bigg ( \mathbb{E}[\ell (g_{\phi, \psi}(x),y)] - \frac{1}{n}\sum_{j=1}^{n} \ell (g_{\phi, \psi}(x_{j}),y_{j}) \bigg ) \notag \\
& \leq \mathbb{E} \bigg[\sup_{\psi \in \Psi} \bigg ( \mathbb{E}[\ell (g_{\phi, \psi}(x),y)] - \frac{1}{n}\sum_{j=1}^{n} \ell (g_{\phi, \psi}(x_{j}),y_{j})\bigg) \bigg]+ L \sqrt{\frac{2\log (2/\delta)}{n}}.
\end{align}
Let $\{x_{j}',y_{j}'\}_{j=1}^{n}$ be independent copies of $\{x_j,y_j\}^{n}_{j=1}$ and $\{\sigma_{j}\}_{j=1}^{n}$ be i.i.d. Rademacher random variables. Using the standard symmetrization technique, we have
\begin{align}
& \mathbb{E} \bigg[\sup_{\psi \in \Psi}\bigg( \mathbb{E}[\ell (g_{\phi, \psi}(x),y)] - \frac{1}{n}\sum_{j=1}^{n} \ell (g_{\phi, \psi}(x_{j}),y_{j}) \bigg) \bigg] \notag \\
& = \mathbb{E} \bigg[\sup_{\psi \in \Psi} \mathbb{E} \bigg[\frac{1}{n}\sum_{j=1}^{n} \ell (g_{\phi, \psi}(x_{j}'),y_{j}') - \frac{1}{n}\sum_{j=1}^{n} \ell (g_{\phi, \psi}(x_{j}),y_{j}) \bigg| \{x_{j},y_{j}\}_{j=1}^{n} \bigg] \bigg] \notag \\
& \leq \mathbb{E} \bigg[\sup_{\psi \in \Psi} \bigg( \frac{1}{n}\sum_{j=1}^{n} \ell (g_{\phi, \psi}(x_{j}'),y_{j}') - \frac{1}{n}\sum_{j=1}^{n} \ell (g_{\phi, \psi}(x_{j}),y_{j}) \bigg) \bigg] \notag \\
& \leq  \mathbb{E} \bigg[\sup_{\psi \in \Psi}  \frac{1}{n}\sum_{j=1}^{n} \sigma_{j}\bigg( \ell (g_{\phi, \psi}(x_{j}'),y_{j}') -  \ell (g_{\phi, \psi}(x_{j}),y_{j}) \bigg) \bigg] \notag \\
&\leq 2 \mathbb{E} \bigg[\sup_{\psi \in \Psi}  \frac{1}{n}\sum_{j=1}^{n} \sigma_{j} \ell (g_{\phi, \psi}(x_{j}),y_{j}) \bigg] \notag \\
& = R_{n} (\ell \circ \mathcal{G}_{\phi, \Psi}).
\end{align}
Therefore, with probability at least $1-\delta/2$, 
\%
\sup_{\psi \in \Psi}\bigg( \mathbb{E} [\ell (g_{\phi, \psi}(x),y)] - \frac{1}{n}\sum_{j=1}^{n} \ell (g_{\phi, \psi}(x_{j}),y_{j}) \bigg) \leq R_{n} (\ell \circ \mathcal{G}_{\phi, \Psi}) + L\sqrt{\frac{2\log (2/\delta)}{n}}
\%
Similarly, with probability at least $1-\delta/2$, 
\%
\sup_{\psi \in \Psi}\bigg( \frac{1}{n}\sum_{j=1}^{n} \ell (g_{\phi, \psi}(x_{j}),y_{j}) - \mathbb{E} [\ell (g_{\phi, \psi}(x),y)] \bigg) \leq R_{n} (\ell \circ \mathcal{G}_{\phi, \Psi}) + L\sqrt{\frac{2\log (2/\delta)}{n}}
\%
Combine these together,  we prove Lemma \ref{error_rademacher}. 
\end{proof}


\begin{lemma} \label{error_dtv}
Suppose that $\ell(\cdot,\cdot)$ is a $L$-bounded loss function. Then, it holds for any $\phi \in \Phi, \psi \in \Psi$ that
\begin{align} 
\mathbb{E}[\ell (g_{\phi, \psi}(x),y)] - \mathbb{E} [\ell (g_{\phi^{*},\psi^{*}}(x),y)] \leq 4L \cdot d_\mathrm{TV} (\P_{\phi,\psi}(x,y),\P_{\phi^{*},\psi^{*}}(x,y)).
\end{align}

\end{lemma}
\begin{proof}[Proof of Lemma \ref{error_dtv}]
\begin{align}\label{092701}
&\mathbb{E}_{\phi^{*}, \psi^{*}} [\ell (g_{\phi, \psi}(x),y)] - \mathbb{E}_{\phi^{*},\psi^{*}} [\ell (g_{\phi^{*},\psi^{*}}(x),y)] \notag \\ 
&=\mathbb{E}_{\phi^{*}, \psi^{*}} [\ell (g_{\phi, \psi}(x),y)] - \mathbb{E}_{\phi, \psi} [\ell (g_{\phi, \psi}(x),y)] \notag \\
&\quad+ \mathbb{E}_{\phi, \psi} [\ell (g_{\phi, \psi}(x),y)] - \mathbb{E}_{\phi, \psi} [\ell (g_{\phi^{*}, \psi^{*}}(x),y)] \notag \\
&\quad+ \mathbb{E}_{\phi, \psi} [\ell (g_{\phi^{*}, \psi^{*}}(x),y)] - \mathbb{E}_{\phi^{*},\psi^{*}} [\ell (g_{\phi^{*},\psi^{*}}(x),y)].
\end{align}
First notice that, by definition of $g_{\phi,\psi}$, 
\%\label{092702}
\mathbb{E}_{\phi, \psi} [\ell (g_{\phi, \psi}(x),y)] - \mathbb{E}_{\phi, \psi} [\ell (g_{\phi^{*}, \psi^{*}}(x),y)]  \leq 0.
\%
For the other two terms, based on the fact that $\ell$ is $L$-bounded, we have
\begin{align}\label{092703}
&|\mathbb{E}_{\phi^{*}, \psi^{*}} [\ell (g_{\phi, \psi}(x),y)] - \mathbb{E}_{\phi, \psi} [\ell (g_{\phi, \psi}(x),y)]| \notag \\ 
&= \left| \int \ell (g_{\phi, \psi}(x),y) p_{\phi_{*}, \psi_{*}} (x,y) \mathrm{d}x\mathrm{d}y - \int \ell (g_{\phi, \psi}(x),y) p_{\phi, \psi} (x,y) \mathrm{d}x\mathrm{d}y \right| \notag \\
&= \left| \int \ell (g_{\phi, \psi}(x),y) (p_{\phi_{*}, \psi_{*}} (x,y)-p_{\phi, \psi} (x,y)) \mathrm{d}x\mathrm{d}y \right| \notag \\
& \leq \int |\ell (g_{\phi, \psi}(x),y)| |(p_{\phi_{*}, \psi_{*}} (x,y)-p_{\phi, \psi} (x,y))| \mathrm{d}x\mathrm{d}y \notag \\
& \leq \int L |(p_{\phi_{*}, \psi_{*}} (x,y)-p_{\phi, \psi} (x,y))| \mathrm{d}x\mathrm{d}y \notag \\
&= 2L \cdot d_\mathrm{TV} (P_{\phi,\psi}(x,y),P_{\phi^{*},\psi^{*}}(x,y)).
\end{align}
Similarly, it holds that
\%\label{092704}
|\mathbb{E}_{\phi^{*}, \psi^{*}} [\ell (g_{\phi^{*}, \psi^{*}}(x),y)] - \mathbb{E}_{\phi, \psi} [\ell (g_{\phi^{*}, \psi^{*}}(x),y)]| \leq 2L \cdot d_\mathrm{TV} (P_{\phi,\psi}(x,y),P_{\phi^{*},\psi^{*}}(x,y)).
\%
Combining \eqref{092701}, \eqref{092702}, \eqref{092703} and \eqref{092704}, we obtain
\begin{align}
&\mathbb{E}_{\phi^{*}, \psi^{*}} [\ell (g_{\phi, \psi}(x),y)] - \mathbb{E}_{\phi^{*},\psi^{*}} [\ell (g_{\phi^{*},\psi^{*}}(x),y)] \leq 4L \cdot d_\mathrm{TV} (P_{\phi,\psi}(x,y),P_{\phi^{*},\psi^{*}}(x,y)).
\end{align}
\end{proof}

With Lemma \ref{error_rademacher} and Lemma \ref{error_dtv}, we are able to state our proofs for Theorem \ref{error_bound} in the following. The main idea of the proof is decomposing the risk. And a key observation is that the labeled data $\{x_j,y_j\}^{n}_{j=1}$ are independent of the pretrained $\hat\phi$, which is learned from the unlabeled data $\{x_i\}^m_{i=1}$.
\begin{proof}[Proof of Theorem  \ref{error_bound}] 
Let 
\begin{align}
\tilde{\psi} := \argmin_{\psi \in \Psi} d_\mathrm{TV} (P_{\hat{\phi},\psi}(x,y),P_{\phi^{*},\psi^{*}}(x,y)).
\end{align}
And for any $\phi \in \Phi, \psi \in \Psi$, we define
\%
\Delta_{\phi,\psi}:= \mathbb{E}_{\phi^{*}, \psi^{*}} [\ell (g_{\phi, \psi}(x),y)] - \frac{1}{n}\sum_{j=1}^{n} \ell (g_{\phi, \psi}(x_{j}),y_{j}).
\%
Recall that the excess risk is defined in \eqref{error}. It then holds that
\begin{align}\label{092705}
\operatorname{Error}_{\ell}(\hat{\phi}, \hat{\psi}) &= \mathbb{E}_{\phi^{*}, \psi^{*}} [\ell (g_{\hat{\phi}, \hat{\psi}}(x),y)] - \mathbb{E}_{\phi^{*},\psi^{*}} [\ell (g_{\phi^{*},\psi^{*}}(x),y)] \notag \\
&= \mathbb{E}_{\phi^{*}, \psi^{*}} [\ell (g_{\hat{\phi}, \hat{\psi}}(x),y)] - \frac{1}{n}\sum_{j=1}^{n} \ell (g_{\hat{\phi}, \hat{\psi}}(x_{j}),y_{j}) \notag \\
&\quad+ \frac{1}{n}\sum_{j=1}^{n} \ell (g_{\hat{\phi}, \hat{\psi}}(x_{j}),y_{j}) - \frac{1}{n}\sum_{j=1}^{n} \ell (g_{\hat{\phi}, \tilde{\psi}}(x_{j}),y_{j}) \quad (\leq 0, \text{ by ERM in Algorithm \ref{mle+erm}}) \notag \\
&\quad+ \frac{1}{n}\sum_{j=1}^{n} \ell (g_{\hat{\phi}, \tilde{\psi}}(x_{j}),y_{j}) - \mathbb{E}_{\phi^{*}, \psi^{*}} [\ell (g_{\hat{\phi}, \tilde{\psi}}(x),y)] \notag \\
&\quad+ \mathbb{E}_{\phi^{*}, \psi^{*}} [\ell (g_{\hat{\phi}, \tilde{\psi}}(x),y)] - \mathbb{E}_{\phi^{*},\psi^{*}} [\ell (g_{\phi^{*},\psi^{*}}(x),y)] \notag \\
& \leq\Delta_{\hat{\phi}, \hat{\psi}} - \Delta_{\hat{\phi}, \tilde{\psi}} + \mathbb{E}_{\phi^{*}, \psi^{*}} [\ell (g_{\hat{\phi}, \tilde{\psi}}(x),y)] - \mathbb{E}_{\phi^{*},\psi^{*}} [\ell (g_{\phi^{*},\psi^{*}}(x),y)].
\end{align}
By lemma \ref{error_dtv}, we have
\begin{align}\label{092706}
&\mathbb{E}_{\phi^{*}, \psi^{*}} [\ell (g_{\hat{\phi}, \tilde{\psi}}(x),y)] - \mathbb{E}_{\phi^{*},\psi^{*}} [\ell (g_{\phi^{*},\psi^{*}}(x),y)] \notag \\
&\leq 4L \cdot d_\mathrm{TV} (P_{\hat{\phi},\tilde{\psi}}(x,y),P_{\phi^{*},\psi^{*}}(x,y)) \notag \\
&= 4L \cdot \min_{\psi \in \Psi} d_\mathrm{TV} (P_{\hat{\phi},\psi}(x,y),P_{\phi^{*},\psi^{*}}(x,y)) \quad (\text{by definition of } \tilde{\psi}) \notag \\
& \leq 4\kappa L  \cdot d_\mathrm{TV} (P_{\hat{\phi}}(x,s),P_{\phi^{*}}(x,s)).
\end{align}
The last line holds, since by Assumption \ref{invariance}, for any $\hat{\phi} \in\Phi$, we choose $T_1$ that satisfies \eqref{informative} and $T_2$ that satisfies \eqref{101701}. Let $\psi=T^{-1}_2\circ\psi^* $. It then holds that
\begin{align}
 \min_{\psi \in \Psi} d_\mathrm{TV} (P_{\hat{\phi},\psi}(x,y),P_{\phi^{*},\psi^{*}}(x,y)) &\leq 
\TV\big(\P_{\hat{\phi},\psi}(x,y),\P_{\phi^* ,\psi^* }(x,y)\big) \notag \\
&=\TV\big(\P_{T_1\circ\hat{\phi},\psi^* }(x,y),\P_{\phi^* ,\psi^* }(x,y)\big) \notag \\
&\leq\TV\big(\P_{T_1\circ\hat{\phi}}(x,z),\P_{\phi^* }(x,z)\big) \notag \\
&\leq \kappa \cdot\TV\big(\P_{\hat{\phi}}(x,s),\P_{\phi^* }(x,s)\big).
\end{align}
Combining \eqref{092705} and \eqref{092706}, we have
\% \label{decomposition}
\operatorname{Error}_{\ell}(\hat{\phi}, \hat{\psi}) \leq \Delta_{\hat{\phi}, \hat{\psi}} - \Delta_{\hat{\phi}, \tilde{\psi}} + 4\kappa L  \cdot d_\mathrm{TV} (P_{\hat{\phi}}(x,s),P_{\phi^{*}}(x,s)).
\%

We define the following events
\%
D:= \left\{ d_\mathrm{TV} (P_{\hat{\phi}}(x,s),P_{\phi^{*}}(x,s)) \leq 3 \sqrt{\frac{1}{m} \log \frac{2N(\mathcal{P}_{\mathcal{X} \times \mathcal{S}}(\Phi), 1 / m)}{\delta}} \right\}
\%
and 
\%
R:= \left\{ \sup_{\psi \in \Psi}|\Delta_{\hat{\phi},\psi}| \leq R_{n} (\ell \circ \mathcal{G}_{\hat{\phi}, \Psi}) + L\sqrt{\frac{2\log (4/\delta)}{n}}  \right\}.
\%
It holds that
\begin{align}\label{092710}
\P(D \cap R) & = \mathbb{E} [\mathds{1}_{D \cap R} ]= \mathbb{E} [ \mathbb{E}[ \mathds{1}_{D} \mathds{1}_{R} | \hat{\phi} ] ] = \mathbb{E} [ \mathds{1}_{D} \mathbb{E}[ \mathds{1}_{R} | \hat{\phi} ] ] = \mathbb{E} [\mathds{1}_{D} \mathbb{P}(R | \hat{\phi} ) ],
\end{align}
where the third equation follows from the fact that $D$ is $\hat{\phi}$-measurable. Note that $\{x_{j},y_{j}\}_{j=1}^{n}$ is independent of $\hat{\phi}$. By Lemma \ref{error_rademacher}, for any given $\hat{\phi}$, with probability at least $1-\delta/2$, 
\%
\sup_{\psi \in \Psi}|\Delta_{\hat{\phi},\psi}| \leq R_{n} (\ell \circ \mathcal{G}_{\hat{\phi}, \Psi}) + L\sqrt{\frac{2\log (4/\delta)}{n}},
\%
i.e.,
\%\label{092708}
\P(R|\hat{\phi}) \geq 1-\delta/2.
\%
By Lemma \ref{tv_mle}, with probability at least $1-\delta/2$, the output of the first step of our algorithm $\hat{\phi}$, satisfies
\%
d_\mathrm{TV} (P_{\hat{\phi}}(x,s),P_{\phi^{*}}(x,s)) \leq 3\sqrt{\frac{1}{m} \log \frac{2N(\mathcal{P}_{\mathcal{X} \times \mathcal{S}}(\Phi), 1 / m)}{\delta}}
\%
i.e.,
\%\label{092709}
\P(D) \geq 1-\delta/2.
\%
By \eqref{092710}, \eqref{092708} and \eqref{092709}, we have
\begin{align}
\P(D \cap R) \geq (1-\delta/2)^{2} \geq 1-\delta.
\end{align}
Then, under event $D\cap R$, by our decomposition (\ref{decomposition}), we have
\begin{align}
\operatorname{Error}_{\ell}(\hat{\phi}, \hat{\psi}) &\leq \Delta_{\hat{\phi}, \hat{\psi}} - \Delta_{\hat{\phi}, \tilde{\psi}} + 4\kappa L  \cdot d_\mathrm{TV} (P_{\hat{\phi}}(x,s),P_{\phi^{*}}(x,s)) \notag \\
&\leq 2 \sup_{\psi \in \Psi}|\Delta_{\hat{\phi},\psi}|+ 4\kappa L  \cdot d_\mathrm{TV} (P_{\hat{\phi}}(x,s),P_{\phi^{*}}(x,s)) \notag \\
&\leq 2 R_{n} (\ell \circ \mathcal{G}_{\hat{\phi}, \Psi}) + 2L\sqrt{\frac{2\log (4/\delta)}{n}} + 12\kappa  L \sqrt{\frac{1}{m} \log \frac{2N(\mathcal{P}_{\mathcal{X} \times \mathcal{S}}(\Phi), 1 / m)}{\delta}} \notag \\
&\leq 2\max_{\phi \in \Phi} R_{n} (\ell \circ \mathcal{G}_{\phi, \Psi}) + 2L\sqrt{\frac{2\log (4/\delta)}{n}} + 12\kappa L \sqrt{\frac{1}{m} \log \frac{2N(\mathcal{P}_{\mathcal{X} \times \mathcal{S}}(\Phi), 1 / m)}{\delta}}.
\end{align}
Thus, we prove Theorem \ref{error_bound}.

\end{proof}
 