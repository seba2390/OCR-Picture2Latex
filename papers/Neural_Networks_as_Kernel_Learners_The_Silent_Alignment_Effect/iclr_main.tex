
\documentclass{article} % For LaTeX2e
\usepackage{iclr_preprint,times}
%\usepackage{iclr2022_conference,times}
% Optional math commands from https://github.com/goodfeli/dlbook_notation.
\input{math_commands.tex}

\usepackage{hyperref}
\usepackage{enumitem}
\usepackage{url}
\usepackage{graphicx}
\usepackage{subfigure}
\usepackage{amsthm}

\def\x{\bm x}
\def\w{\bm w}
\def\W{\bm W}
\def\d{\partial}

\newtheorem{lemma}{Lemma}
\newtheorem{theorem}{Theorem}

\newcommand{\cep}[1]{\textcolor{purple}{[Cengiz: #1]}}
\newcommand{\bb}[1]{\textcolor{red}{[Blake: #1]}}
\newcommand{\aba}[1]{\textcolor{blue}{[Alex: #1]}}


\title{Neural Networks as Kernel Learners: The Silent Alignment Effect}

% Authors must not appear in the submitted version. They should be hidden
% as long as the \iclrfinalcopy macro remains commented out below.
% Non-anonymous submissions will be rejected without review.

\author{Alexander Atanasov\thanks{These authors contributed equally.}\text{  \,}$^{\S}$$^{\ddagger}$, \text{ } Blake Bordelon$^{*}$$^{\dagger}$$^{\ddagger}$ \& Cengiz Pehlevan$^{\dagger}$$^{\ddagger}$  \\
\S Department of Physics
\\
$^{\dagger}$John A. Paulson School of Engineering and Applied Sciences\\
$^{\ddagger}$Center for Brain Science\\
\, Harvard University\\
\, Cambridge, MA 02138, USA \\
\,\texttt{\{atanasov,blake\_bordelon,cpehlevan\}@g.harvard.edu} \\
}

% The \author macro works with any number of authors. There are two commands
% used to separate the names and addresses of multiple authors: \And and \AND.
%
% Using \And between authors leaves it to \LaTeX{} to determine where to break
% the lines. Using \AND forces a linebreak at that point. So, if \LaTeX{}
% puts 3 of 4 authors names on the first line, and the last on the second
% line, try using \AND instead of \And before the third author name.

\newcommand{\fix}{\marginpar{FIX}}
\newcommand{\new}{\marginpar{NEW}}

%\iclrfinalcopy 
% Uncomment for camera-ready version, but NOT for submission.
\begin{document}


\maketitle

\begin{abstract}

Neural networks in the lazy training regime converge to kernel machines. Can neural networks in the rich feature learning regime learn a kernel machine with a data-dependent kernel? We demonstrate that this can indeed happen due to a phenomenon we term \textit{silent alignment}, which requires that the tangent kernel of a network evolves in eigenstructure while small  and before the loss appreciably decreases, and grows only in overall scale afterwards. 
We empirically show that such an effect takes place in homogenous neural networks with small initialization and whitened data. We provide an analytical treatment of this effect in the fully connected linear network case. In general, we find that the kernel develops a low-rank contribution in the early phase of training, and then evolves in overall scale, yielding a function equivalent to a kernel regression solution with the final network's tangent kernel. The early spectral learning of the kernel depends on the depth.  We also demonstrate that non-whitened data can weaken the silent alignment effect.

\end{abstract}





\section{Introduction}


Despite the numerous empirical successes of deep learning, much of the underlying theory remains poorly understood. One promising direction forward to an interpretable account of deep learning is in the study of the relationship between deep neural networks and kernel machines. Several studies in recent years have shown that gradient flow on infinitely wide neural networks with a certain parameterization gives rise to linearized dynamics in parameter space \citep{Lee2019WideNN, liu_belkin} and consequently a kernel regression solution with a kernel known as the neural tangent kernel (NTK) in function space \citep{Jacot2018NeuralTK, Arora2019OnEC}. Kernel machines enjoy firmer theoretical footing than deep neural networks, which allows one to accurately study their training and generalization \citep{RasmussenW06, Scholkopf2002}. Moreover, they share many of the phenomena that overparameterized neural networks exhibit, such as interpolating the training data \citep{zhang_rethinking, liang_rahklin_interpolate, belkin_deep_kernel_understand}. However, the exact equivalence between neural networks and kernel machines breaks for finite width networks. % initialized with small weights \citep{Chizat2019OnLT, GEIGER20211}. 
Further, the regime with approximately static kernel, also referred to as the lazy training regime \citep{Chizat2019OnLT}, cannot account for the ability of deep networks to adapt their internal representations to the structure of the data, a phenomenon widely believed to be crucial to their success. 

%Recent work has established that neural networks can operate in two different regimes depending on the scale of the initial network output and the network's parameterization. In the lazy training regime, the network's parameter gradients do not move very much through training, though the network's output interpolates the training data. In such a regime, when trained with gradient flow on MSE loss, the network converges to a kernel machine with a {\it data-independent} kernel known as the neural tangent kernel (NTK) \citep{Jacot2018NeuralTK, Arora2019OnEC, Arora2020Harnessing, Lee2019WideNN}. The correspondence between networks in the lazy regime and kernel machines has motivated many works exploring how the lazy regime differs from the rich regime of neural network training, where the network learns data-dependent features \citep{Ghorbani2019LimitationsOL, Lee2020FiniteVI, Yang2020FeatureLI, ghorbani_outperform, GEIGER20211, Paccolat_2021, liu2021loss, yang2021tensor, woodworth, Dyer2020Asymptotics, Aitken2020OnTA, Andreassen2020AsymptoticsOW,zavatone2021asymptotics,fort2020deep,Baratin2021ImplicitRV, huang_ntk_hierarchy, shan2021rapid}. 

In this present study, we pursue an alternative perspective on the NTK, and ask whether a neural network with an NTK that changes significantly during training can ever be a kernel machine for a {\it data-dependent} kernel: i.e. does there exist a kernel function $K$ for which the final neural network function $f$ is $f(\x) \approx \sum_{\mu=1}^P \alpha^\mu K(\x,\x^\mu)$ with coefficients $\alpha^\mu$ that depend only on the training data? We answer in the affirmative: that a large class of neural networks at small initialization trained on approximately whitened data are accurately approximated as kernel regression solutions with their final, data-dependent NTKs up to an error dependent on initialization scale. %However, the final NTK completely describes the learned function, up to an error dependent on initialization scale. 
Hence, our results provide a further concrete link between kernel machines and deep learning which, unlike the infinite width limit, allows for the kernel to be shaped by the data. 
%considered the same question and gave a general solution with coefficients $\alpha^\mu$ as functions of the test point $\x$, so it is not a representer theorem in the traditional sense. 

The phenomenon we study consists of two training phases. In the first phase, the kernel starts off small in overall scale and quickly aligns its eigenvectors toward task-relevant directions. In the second phase, the kernel increases in overall scale, causing the network to learn a kernel regression solution with the final NTK. We call this phenomenon the \textit{silent alignment effect} because the feature learning happens before the loss appreciably decreases. 
%
%We demonstrate this effect analytically in linear networks at small initialization trained on whitened data. We show empirically that a similar effect happens in nonlinear networks with ReLu and Tanh activations. We further show in Appendix \ref{app:anisotropy} that the silent alignment effect is not present in highly anisotropic data, and that the final neural network output is not a kernel regression with the final NTK.
%
Our contributions are the following
\begin{enumerate}[leftmargin=*]
    \item In Section \ref{sec:silent_align_theory}, we demonstrate the silent alignment effect by considering a simplified model where the kernel evolves while small and then subsequently increases only in scale. We theoretically show that if these conditions are met, the final neural network is a kernel machine that uses the final, data-dependent NTK. A proof is provided in Appendix \ref{app:kernel_ev_scale}.
    \item In Section \ref{sec:two_layer_linear}, we provide an analysis of the NTK evolution of two layer linear MLPs with scalar target function with small initialization. If the input training data is whitened, the kernel aligns its eigenvectors towards the direction of the optimal linear function early on during training while the loss does not decrease appreciably. After this, the kernel changes in scale only, showing this setup satisfies the requirements for silent alignment discussed in Section \ref{sec:silent_align_theory}.
    \item In Section \ref{sec:deep_linear}, we extend our analysis to deep MLPs by showing that the time required for alignment scales with initialization the same way as the time for the loss to decrease appreciably. Still, these time scales can be sufficiently separated to lead to the silent alignment effect for which we provide empirical evidence. We further present an explicit formula for the final kernel in linear networks of any depth and width when trained from small initialization, showing that the final NTK aligns to task-relevant directions.
    
    \item In Section \ref{sec:nonlinear_anisotropy}, we show empirically that the silent alignment phenomenon carries over to nonlinear networks trained with ReLU and Tanh activations on isotropic data, as well as linear and nonlinear networks with multiple output classes. For anisotropic data, we show that the NTK must necessarily change its eigenvectors when the loss is significantly decreasing, destroying the silent alignment phenomenon. In these cases, the final neural network output deviates from a kernel machine that uses the final NTK.
\end{enumerate}


\subsection{Related Works}

\cite{Jacot2018NeuralTK} demonstrated that infinitely wide neural networks initialized with an appropriate parameterization and trained on mean square error loss evolve their predictions as a linear dynamical system with the NTK at initalization. %A parameter space view of this phenomenon showed that wide neural networks with this parameterization behave as a linear function of the parameters during gradient descent \citep{Lee2019WideNN, liu_belkin}. % These works initiated a flurry of research activity into the convergence \citep{du2018gradient,chizat_convergence} and functional biases of wide neural networks and their generalization capabilities \citep{Bietti2019OnTI, bordelon_icml_learning_curve, cohen_learning_curves, Canatar2021SpectralBA, loureiro_lenka_feature_maps, simon2021neural}.
A limitation of this kernel regime is that the neural network internal representations and the kernel function do not evolve during training. Conditions under which such lazy training can happen is studied further in \citep{Chizat2019OnLT,liu_belkin}. \citet{domingos2020model} recently %asked whether neural networks in the feature learning regime learn functions that solve a kernel interpolation problem for some data dependent kernel. He 
showed that every model, including neural networks, trained with gradient descent leads to a kernel model with a path kernel and coefficients $\alpha^\mu$ that depend on the test point $\x$. This dependence on $\x$ makes the construction not a kernel method in the traditional sense that we pursue here (see Remark 1 in \citep{domingos2020model}).
%  We demonstrate that, under special circumstances, neural networks can learn a kernel machine in the traditional sense, with the final data-dependent NTK.


% Using the static kernel limit as a starting point, several works have proposed perturbative analysis of the learning process, computing expansions to network observables in powers of $1/\text{network width}$. For instance, leading order corrections to the NTK limit of training were obtained by \cite{Dyer2020Asymptotics, Aitken2020OnTA, Andreassen2020AsymptoticsOW,naveh2021predicting} as well as the hierarchy of ODEs derived by \cite{huang_ntk_hierarchy}. The leading order corrections in this approach show the kernel evolving throughout gradient descent in a data-dependent manner. This approach has been shown to successfully predict observables in large but finite width networks but the perturbative approach can break down when learning rate is large \citep{lewkowycz2021the}. Similar perturbative analysis has been carried out for Bayesian neural networks in the large but finite width regime, revealing corrections which adapt the NNGP kernels of each layer in data-dependent manner \citep{yaida, roberts2021principles,zavatone2021asymptotics}.

Phenomenological studies and models of kernel evolution have been recently invoked to gain insight into the difference between lazy and feature learning regimes of neural networks. These include analysis of NTK dynamics which revealed that the NTK in the feature learning regime aligns its eigenvectors to the labels throughout training, causing non-linear prediction dynamics \citep{fort2020deep, Baratin2021ImplicitRV, shan2021rapid, woodworth, chen2020labelaware, GEIGER20211, bai2020taylorized}.  Experiments have shown that lazy learning can be faster but less robust than feature learning \citep{Flesch} and that the generalization advantage that feature learning provides to the final predictor is heavily task and architecture dependent \citep{lee2020finite}. \cite{fort2020deep} found that networks can undergo a rapid change of kernel early on in training after which the network's output function is well-approximated by a kernel method with a data-dependent NTK. Our findings are consistent with these results.
% In the case of whitened data we can demonstrate a strong correlation between the final NTK and the output of the network function, while for anisotropic data we see this effect weakens, but is still present. 

\cite{stoger2021small} recently obtained a similar multiple-phase training dynamics involving an early alignment phase followed by spectral learning and refinement phases in the setting of low-rank matrix recovery. Their results share qualitative similarities with our analysis of deep linear networks. The second phase after alignment, where the kernel's eigenspectrum grows, was studied in linear networks in \citep{jacot2021deep}, where it is referred to as the saddle-to-saddle regime. 

Unlike prior works \citep{Dyer2020Asymptotics, Aitken2020OnTA, Andreassen2020AsymptoticsOW}, our results do not rely on perturbative expansions in network width. Also unlike the work of \cite{Saxe14exactsolutions}, our solutions for the evolution of the kernel do not depend on choosing a specific set of initial conditions, but rather follow only from assumptions of small initialization and whitened data.


 
%\begin{itemize}
%    \item Using the analytic solutions of (cite Saxe, Ganguli), one can give an analytic expression for the NTK in linear networks with special initialization as a function of time. 
%    \item Linear networks with small initialization undergo an early alignment phase where the singular vectors of the input and output weights align to the singular vectors of the input-output correlations of the data. During this phase, the loss does not decrease substantially. 
%    \item Further during this phase, although the norm of the NTK stays small, its principal components and relative eigenvalues are learned from the input-output correlations of the data.
%    \item For whitened data, the alignment phase is immediately followed by a saddle-to-saddle phase where the eigenvalues of the input-output correlations are learned. During this phase, both the loss and the kernel change drastically in magnitude. 
%    \item For linear networks trained on whitened data, kernel regression with the final NTK agrees with the network function.
%    \item Empirically, the separation of alignment and spectral learning  persists across a variety of nonlinear networks with small initialization. \textcolor{blue}{Should we add ``on whitened data''?}
%    \item \textcolor{blue}{Really want to say something more about unwhitened data}
%    \item Task specificity incorporated in the structure of the kernel \dots generalization/transfer learning
%\end{itemize}

%\begin{itemize}
%    \item NTK literature: Jacot, Lee, 
%    \item Kernel evolution literature; Baratin, Fort etc
%    \item Linear networks: Saxe Ganguli
%    \item Learning phases in sparse matrix recovery: St\"oger Soltanolkotabi
%\end{itemize}

\section{The Silent Alignment Effect and Approximate Kernel Solution}\label{sec:silent_align_theory}

Neural networks in the overparameterized regime can find many interpolators: the precise function that the network converges to is controlled by the time evolution of the NTK. As a concrete example, we will consider learning a scalar target function with mean square error loss through gradient flow. Let $\x \in \mathbb{R}^D$ represent an arbitrary input to the network $f(\x)$ and let $\{ \x^\mu, y^\mu\}_{\mu=1}^P$ be a supervised learning training set. Under gradient flow the parameters $\bm \theta$ of the neural network will evolve, so the output function is time-dependent and we write this as $f(\x,t)$. The evolution for the predictions of the network on a test point can be written in terms of the NTK $K(\x,\x',t) = \frac{\partial f(\x,t)}{\partial \bm \theta} \cdot \frac{\partial f(\x',t)}{\partial \bm\theta}$ as  
\begin{align}
    \frac{d}{dt} f(\x,t) = \eta \sum_{\mu} K(\x,\x^\mu, t) (y^\mu - f(\x^\mu,t)),
\end{align}
where $\eta$ is the learning rate.
If one had access to the dynamics of $K(\x,\x^\mu,t)$ throughout all $t$, one could solve for the final learned function $f^*$ with integrating factors under conditions discussed in Appendix \ref{app:integrating_factor}
\begin{align}\label{eq:integ_factor}
    f^*(\x) = f_0(\x) +  \sum_{\mu \nu} \int_{0}^{\infty} dt \ \bm k_t(\bm x)^\mu \left[\exp\left( - \eta \int_{0}^{t} \bm K_{t'}\, dt'  \right) \right]_{\mu \nu} \left( y^\nu - f_0(\x^\nu) \right).
\end{align}
Here, $\bm k_t(\x)^{\mu} = K(\bm x,\x^\mu,t)$, $[\bm K_t]_{\mu,\nu} = K(\bm x^\mu,\bm x^{\nu},t )$, and $y^\mu - f_0(\x^\mu)$ is the initial error on point $\bm x^\mu$.  We see that the final function has contributions throughout the full training interval $t \in (0,\infty)$.  The seminal work by \cite{Jacot2018NeuralTK} considers an infinite-width limit of neural networks, where the kernel function $K_t(\x,\x')$ stays constant throughout training time. In this setting where the kernel is constant and $f_0(\x^\mu) \approx 0$, then we obtain a true kernel regression solution $f(\x) = \sum_{\mu, \nu} \bm k(\x)^\mu \bm K^{-1}_{\mu \nu} y^\nu$ for a kernel $K(\x,\x')$ which does not depend on the training data.

Much less is known about what happens in the rich, feature learning regime of neural networks, where the kernel evolves significantly during time in a data-dependent manner. In this paper, we consider a setting where the initial kernel is small in scale, aligns its eigenfunctions early on during gradient descent, and then increases only in scale monotonically. As a concrete phenomenological model, consider depth $L$ networks with homogenous activation functions with weights initialized with variance $\sigma^2$. At initialization $K_0(\x,\x') \sim O(\sigma^{2L-2}) , f_0(\x) \sim O(\sigma^L)$ (see Appendix \ref{app:kernel_ev_scale}). We further assume that after time $\tau$, the kernel only evolves in scale in a constant direction
\begin{align}
    K(\x,\x',t) = \begin{cases} 
      \sigma^{2L-2} \tilde K(\x,\x',t) & t \leq \tau \\
      g(t) K_{\infty}(\x,\x') & t > \tau
   \end{cases},
\end{align}
where $\tilde K(\x,\x',t)$ evolves from an initial kernel at time $t=0$ to $K_{\infty}(\x,\x')$ by $t = \tau$ and $g(t)$ increases monotonically from $\sigma^{2L-2}$ to $1$. In this model, one also obtains a kernel regression solution in the limit where $\sigma \to 0$ with the final, rather than the initial kernel: $f(\x) = \bm k_{\infty}(\x) \cdot \bm K_{\infty}^{-1} \bm y + O(\sigma^{L})$. We provide a proof of this in the Appendix \ref{app:kernel_ev_scale}. 

%\cep{Remove this paragraph and the corresponding appendix. It is undeveloped and really a side point.} \aba{Will check with Blake before implementing}In this setting, feature learning happens before the kernel grows substantially in scale. Unlike previous proposed metrics of laziness and richness of gradient-based training \citep{Chizat2019OnLT}, our analysis in Appendix \ref{app:kernel_ev_scale} indicates that a proper metric of feature learning should be insensitive to mere changes in the kernel's overall scale. Indeed, if the kernel evolves from the initial NTK in scale only $K(\x,\x',t) = g(t) K_0(\x,\x')$, then the learned function is the same as kernel regression with the initial NTK. 

The assumption that the kernel evolves early on in gradient descent before increasing only in scale may seem overly strict as a model of kernel evolution. However, we analytically show in Sections \ref{sec:two_layer_linear} and \ref{sec:deep_linear}  that this can happen in deep linear networks initialized with small weights, and consequently that the final learned function is a kernel regression with the final NTK. Moreover, we show that for a linear network with small weight initialization, the final NTK depends on the training data in a universal and predictable way.

We show empirically that our results carry over to nonlinear networks with ReLU and tanh activations under the condition that the data is whitened. For example, see Figure \ref{fig:relu_demo_silent_alignment}, where we show the silent alignment effect on ReLU networks with whitened MNIST and CIFAR-10 images. We define alignment as the overlap between the kernel and the target function $\frac{\bm y^\top \bm K \bm y}{\|\bm K\|_F |\bm y|^2}$, where $\bm y \in \mathbb{R}^P$ is a vector of the target values, quantifying the projection of the labels onto the kernel, as discussed in \citep{cortes2012algorithms}. This quantity increases early in training but quickly stabilizes around its asymptotic value before the loss decreases. Though \Eqref{eq:integ_factor} was derived under assumption of gradient flow with constant learning rate, the underlying conclusions can hold in more realistic settings as well. In Figure \ref{fig:relu_demo_silent_alignment} (d) and (e) we show learning dynamics and network predictions for Wide-ResNet \citep{zagoruyko2017wide} on whitened CIFAR-10 trained with the Adam optimizer \citep{kingma2014adam} with learning rate $10^{-5}$, which exhibits silent alignment and strong correlation with the final NTK predictor. In the unwhitened setting, this effect is partially degraded, as we discuss in Section \ref{sec:nonlinear_anisotropy} and Appendix \ref{app:res_net_experiment}. Our results suggest that the final NTK may be useful for analyzing generalization and transfer as we discuss for the linear case in Appendix \ref{app:transfer_theory}. 


\begin{figure}[t]
    \centering
    %\subfigure[Linear Dynamics]{\includegraphics[width=0.33\linewidth]{figures/loss_kernel_whitened_linear.pdf}}
    %\subfigure[Linear Predictions]{\includegraphics[width=0.33\linewidth]{figures/prediction_comp_whitened_linear (1).pdf}}
    \subfigure[Whitened Data MLP Dynamics]{\includegraphics[width=0.32\linewidth]{figures/loss_kernel_whitened_relu2.pdf}}
    \subfigure[Prediction MNIST]{\includegraphics[width=0.32\linewidth]{figures/prediction_comp_whitened_relu.pdf}}
    %\subfigure[ReLU Dynamics]{\includegraphics[width=0.33\linewidth]{figures/cifar_loss_kernel_whitened_relu.pdf}}
    \subfigure[Prediction CIFAR-10]{\includegraphics[width=0.32\linewidth]{figures/cifar_prediction_comp_whitened_relu.pdf}}
    \subfigure[Wide Res-Net Dynamics]{\includegraphics[width=0.32\linewidth]{figures/resnet_loss_alignment_curve_whitened.pdf}}
    \subfigure[Prediction Res-Net]{\includegraphics[width=0.32\linewidth]{figures/cifar_prediction_comp_whitened_resnet_more_data.pdf}}
    \caption{A demonstration of the Silent Alignment effect. (a) We trained a 2-layer ReLU MLP on $P = 1000$ MNIST images of handwritten $0$'s and $1$'s which were whitened. Early in training, around $t \approx 50$, the NTK aligns to the target function and stay fixed (green). The kernel's overall scale (orange) and the loss (blue) begin to move at around $t=300$. The analytic solution for the maximal final alignment value in linear networks is overlayed (dashed green), see Appendix \ref{app:NTK_final_deep_linear}. (b)  We compare the predictions of the NTK and the trained network on MNIST test points. Due to silent alignment, the final learned function is well described as a kernel regression solution with the final NTK $K_{\infty}$. However, regression with the initial NTK is not a good model of the network's predictions. (c) The same experiment on $P =1000$ whitened CIFAR-10 images from the first two classes. Here we use MSE loss on a width $100$ network with initialization scale $\sigma=0.1$. (d) Wide-ResNet with width multiplier $k=4$ and blocksize of $b=1$ trained with $P=100$ training points from the first two classes of CIFAR-10. The dashed orange line marks when the kernel starts growing significantly, by which point the alignment has already finished. (e) Predictions of the final NTK are strongly correlated with the final NN function.  }
    \label{fig:relu_demo_silent_alignment}
\end{figure}

 
\section{Kernel Evolution in 2 Layer Linear Networks}\label{sec:two_layer_linear}


We will first study shallow linear networks trained with small initialization before providing analysis for deeper networks in Section \ref{sec:deep_linear}. We will focus our discussion in this section on the scalar output case but we will provide similar analysis in the multiple output channel case in a subsequent section.  We stress, though we have systematically tracked the error incurred at each step, we have focused on transparency over rigor in the following derivation. We demonstrate that our analytic solutions match empirical simulations in Appendix \ref{subsec:solns_to_full_training}. 

We assume the $P$ data points $\bm x^\mu \in \mathbb{R}^{D}, \mu = 1, \dots, P$ of zero mean with correlation matrix $\bm\Sigma = \frac1P \sum_{\mu=1}^P \bm x^\mu {\bm x^\mu}^\top$. Further, we  assume that the target values are generated by a linear teacher function $y^\mu = s \bm { \beta}_T \cdot \bm x^{\mu}$ for a unit vector $\bm{ \beta}_T$. The scalar $s$ merely quantifies the size of the supervised learning signal: the variance of $|\bm y|^2 = s^2 \bm\beta^\top_T \bm\Sigma \bm \beta_T$. We define the two-layer linear neural network with $N$ hidden units as $f(\x) = \bm a^\top \bm W \bm x$. Concretely, we initialize the weights with standard parameterization $a_i \sim\mathcal{N}(0,\sigma^2/N), W_{ij} \sim\mathcal{N}(0,\sigma^2/D)$. Understanding the role of $\sigma$ in the dynamics will be crucial to our study. We analyze gradient flow dynamics on MSE cost $L = \frac{1}{2 P} \sum_{\mu} \left( f(\bm x^\mu) - y^\mu  \right)^2$. 

Under gradient flow with learning rate $\eta = 1$, the weight matrices in each layer evolve as
\begin{align}
    \frac{d}{dt} \bm a = - \frac{\d L}{\d \bm a} = \bm W \bm \Sigma \left( s \bm\beta_T - \bm W^\top \bm a \right), \quad
    \frac{d}{dt} \W = - \frac{\d L}{\d \bm W} =  \bm a \left( s \bm \beta_T - \bm W^\top \bm a \right)^\top \bm \Sigma.
\end{align}
The NTK takes the following form throughout training.
\begin{align}\label{eq:kernel_evolution}
    K(\bm x, \bm x'; t) = \bm x^\top \bm W^\top  \bm W \bm x' + |\bm a|^2 \bm x^\top \bm x'.
\end{align}
Note that while the second term, a simple isotropic linear kernel, does not reflect the nature of the learning task, the first term $\bm x^\top \bm W^\top \bm W \bm x'$ can evolve to yield an anisotropic kernel that has learned a representation from the data.  

\subsection{Phases of Training in Two Layer Linear Network}

We next show that there are essentially two phases of training when training a two-layer linear network from small initialization on whitened-input data. 
\begin{itemize}[leftmargin=*]
    \item Phase I: An alignment phase which occurs for $t \sim \frac{1}{s}$. In this phase the weights align to their low rank structure and the kernel picks up a rank-one term of the form $\bm x^\top \bm \beta \bm \beta^\top \bm x'$. In this setting, since the network is initialized near $\bm W, \bm a = \bm 0$, which is a saddle point of the loss function, the gradient of the loss is small. Consequently, the magnitudes of the weights and kernel evolve slowly.
    \item Phase II: A data fitting phase which begins around $t \sim \frac{1}{s} \log(s  \sigma^{- 2} )$. In this phase, the system escapes the initial saddle point $\bm W, \bm a =  0$ and loss decreases to zero. In this setting both the kernel's overall scale and the scale of the function $f(\x,t)$ increase substantially. 
\end{itemize}
If Phase I and Phase II are well separated in time, which can be guaranteed by making $\sigma$ small, then the final function solves a kernel interpolation problem for the NTK which is only sensitive to the geometry of gradients in the final basin of attraction. In fact, in the linear case, the kernel interpolation at every point along the gradient descent trajectory would give the final solution as we show in Appendix \ref{app:all_ntk_learn_same}. A visual summary of these phases is provided in Figure \ref{fig:phase_one_two_visual}. 


\begin{figure}
    \centering
    \subfigure[ Initialization]{\includegraphics[width=0.23\linewidth]{figures/kernel_contour_init.pdf}}
    \subfigure[Phase 1]{\includegraphics[width=0.23\linewidth]{figures/kernel_contour_transition.pdf}}
    \subfigure[Phase 2]{\includegraphics[width=0.23\linewidth]{figures/kernel_contour_final.pdf}}
    \caption{The evolution of the kernel's eigenfunctions happens during the early alignment phase for $t_1 \approx \frac{1}{s}$, but significant evolution in the network predictions happens for $t > t_2 = \frac{1}{2}\log( s \sigma^{-2})$. (a) Contour plot of kernel's norm for linear functions $f(\x) = \bm\beta \cdot \x$. The black line represents the space of weights which interpolate the training set, ie $\bm X^\top \bm\beta = \bm y$. At initialization, the kernel is isotropic, resulting in spherically symmetric level sets of RKHS norm. The network function is represented as a blue dot. (b) During Phase I, the kernel's eigenfunctions have evolved, enhancing power in the direction of the min-norm interpolator, but the network function has not moved far from the origin. (c) In Phase II, the network function $\bm W^\top \bm a$ moves from the origin to the final solution.} 
    \label{fig:phase_one_two_visual}
\end{figure}



\subsubsection{Phase I: Early Alignment for Small Initialization}
%for orthogonal    For $P > D$, the underparameterized setting, this means $\Sigma = \bm I$. For the overparameterized setting $P < D$, the condition is that $\bm \Sigma = \bm I$ on the $P$-dimensional subspace spanned by the training data and $0$ in the orthogonal directions. We let $\bm\beta$ represent the unit vector pointing in the direction of the optimal solution. In the over-parameterized case, the vector $\bm\beta$ is the component of $\beta_T$ in the subspace spanned by the training data $\{\x^\mu \}_{\mu=1}^P$. In the underparameterized case, where the input dimension is less than $P > D$, the beta$ vector is exactly the teacher $\bm\beta_T$. 

In this section we show how the kernel aligns to the correct eigenspace early in training. 
We focus on the whitened setting, where the data matrix $\bm X$ has all of its nonzero singular values equal. We let $\bm\beta$ represent the normalized component of $\bm\beta_T$ in the span of the training data $\{ \x^\mu \}$. We will discuss general $\bm\Sigma$ in section \ref{sec:unwhite_two_layer}.  We approximate the dynamics early in training by recognizing that the network output is small due to the small initialization.  Early on, the dynamics are given by:
\begin{align}
    \frac{d}{dt} \bm  a = s \bm W \bm\beta + O(\sigma^3)  \ , \quad
    \frac{d}{dt} \bm  W =  s \bm a \bm \beta^\top + O(\sigma^3).
\end{align}
Truncating terms order $\sigma^3$ and higher, we can solve for the kernel's dynamics early on in training
\begin{align}\label{eq:approx_align}
    K(\x,\x';t) = q_0 \cosh(2\eta st) \ \x^\top \left[ \bm\beta \bm\beta^\top +  \bm I \right] \x' +  O(\sigma^2), \quad t \ll s^{-1} \log(s/\sigma^2).
\end{align}
where $q_0$ is an initialization dependent quantity, see Appendix \ref{app:two_layer_phase_one}. The bound on the error is obtained in Appendix \ref{sec:phase_one_error}. We see that the kernel picks up a rank one-correction $\bm\beta \bm\beta^\top$ which points in the direction of the task vector $\bm \beta$, indicating that the kernel evolves in a direction sensitive to the target function $y = s \bm\beta_T \cdot \bm x$. This term grows exponentially during the early stages of training, and overwhelms the original kernel $K_0$ with timescale $1/s$. Though the neural network has not yet achieved low loss in this phase, the alignment of the kernel and learned representation has consequences for the transfer ability of the network on correlated tasks as we show in Appendix \ref{app:transfer_theory}.


%\subsection{Early Alignment for Small Initialization} 

%Take $\mathbf P = \mathbf W^{2} \mathbf W^{1}$ where $\mathbf W^{(1)} \in \mathbb{R}^{N\times D}, \mathbf W^{(2)} \in \mathbb{R}^{C \times N}$ are Gaussian random matrices whose entries have variance $\sigma^2 /D, \sigma^2 / N$ respectively. Early in training, for small initialization we have 
%$$  \dot{\mathbf P} \sim \mathbf W^{(2)} \mathbf W^{(2) \top} \mathbf \Sigma_{31} + \mathbf\Sigma_{31} \mathbf W^{(1) \top} \mathbf W^{(1)} + O(\sigma^4) $$

%Let $\mathbf \Sigma_{31} = \sum_{\alpha} s_\alpha \mathbf u_{\alpha} \mathbf v_{\alpha}^\top$. We would like to characterize the statistical properties of the following quantities to show early alignment

%$$ c_{\alpha\beta} = \mathbf u_{\alpha}^\top \dot{\mathbf P} \mathbf v_{\beta} =  s_\beta  \mathbf u_{\alpha }^\top \mathbf W^{(2)} \mathbf W^{(2) \top} \mathbf u_{\beta} + s_{\alpha} \mathbf v_{\alpha}^\top \mathbf W^{(1) \top} \mathbf W^{(1)} \mathbf v_{\beta}$$


%Working out the first two moments yields
%$$ \left< c_{\alpha \beta} \right> = 2 s_{\alpha} \sigma^2 \delta_{\alpha\beta}  $$

%$$  \left< c_{\alpha \beta}^2 \right> =  4 s_{\alpha}^2 \sigma^4 \delta_{\alpha\beta} + \left( \frac{N}{D^2} s_{\alpha}^2 + \frac{1}{N} s_{\beta}^2 \right) \sigma^4\left( 1+ \delta_{\alpha\beta} \right)  $$

%We thus find that the diagonal elements $\alpha = \beta$ have nonzero $O(1)$ average and twice the variance as the off-diagonal terms $\alpha \neq \beta$. Consider the linear scaling $D = \gamma N$. This yields the following for the projection of the weight updates on the $(\alpha,\beta)$ pair of singular vectors


\subsubsection{Phase II: Spectral Learning}

We now assume that the weights have approached their low rank structure, as predicted from the previous analysis of Phase I dynamics, and study the subsequent NTK evolution. We will show that, under the assumption of whitening, the kernel only evolves in overall scale.

First, following \citep{fukumizu1998effect, arora_cohen_linear_acc,Du2018AlgorithmicRI}, we note the following conservation law $\frac{d}{dt} \left[ \bm a(t) \bm a(t)^\top - \bm W(t) \bm W(t)^\top \right] = 0$ which holds for all time. If we assume small initial weight variance $\sigma^2$, $\bm a \bm a^\top - \bm W \bm  W^\top = O(\sigma^2) \approx 0$ at initialization, and stays that way during the training due to the conservation law. This condition is surprisingly informative, since it indicates that $\bm W$ is rank-one up to $O(\sigma)$ corrections. From the analysis of the alignment phase, we also have that $\bm W^\top \bm W \propto \bm \beta \bm \beta^\top$. These two observations uniquely determine the rank one structure of $\bm W$ to be $\bm a \bm \beta^\top+O(\sigma)$. Thus, from \eqref{eq:kernel_evolution} it follows that in Phase II, the kernel evolution takes the form 
\begin{align}
    K(\x,\x';t) = u(t)^2 \x^\top  \left[ \bm\beta \bm\beta^\top + \bm I \right] \x' + O(\sigma),
\end{align}
where $u(t)^2 = |\bm a|^2$. This demonstrates that the kernel only changes in overall scale during Phase II. 

Once the weights are aligned with this scheme, we can get an expression for the evolution of $u(t)^2$ analytically, $u(t)^2 = s e^{2st} (e^{2st} - 1 + s / u_0^2)^{-1}$, using the results of \citep{fukumizu1998effect,Saxe14exactsolutions} as we discuss in \ref{subsec:phase2}. This is a sigmoidal curve which starts at $u_0^2$ and approaches $s$. The transition time where active learning begins occurs when $e^{st} \approx s/u_0^2 \implies t \approx s^{-1} \log( s/\sigma^2)$. This analysis demonstrates that the kernel only evolves in scale during this second phase in training from the small initial value $u_0^2 \sim O(\sigma^2)$ to its asymptote. 

Hence, kernel evolution in this scenario is equivalent to the assumptions discussed in Section \ref{sec:silent_align_theory}, with $g(t) = u(t)^2$, showing that the final solution is well approximated by kernel regression with the final NTK. We stress that the timescale for the first phase $t_1 \sim 1/s$, where eigenvectors evolve, is independent of the scale of the initialization $\sigma^2$, whereas the second phase occurs around $t_2 \approx t_1 \log(s/\sigma^2)$. This separation of timescales $t_1 \ll t_2$ for small $\sigma$ guarantees the silent alignment effect.   We illustrate these learning curves and for varying $\sigma$ in Figure \ref{fig:two_layer_theory_expt}.

%This long delay time $t_2$ for the function's predictions to begin significantly changing is a consequence of initializing the network close to a saddle-point at $\bm a, \bm W = \bm 0$ and is not present in shallow learning, rather only appearing in networks of depth two. The loss has barely decreased at all by the time the kernel has reached its final eigenstructure.



%\subsection{Training on Unwhitened Data}
%When training on unwhitened data, the kernel initially aligns to 
%\begin{align}
%    K(\x,\x') \sim e^{2st} \x^\top \left[ \frac{\bm\Sigma \bm\beta \bm\beta \bm\Sigma}{\bm\beta^\top \bm\Sigma^2 \bm\beta}  + \bm I  \right] \x' + K_0(\x,\x')
%\end{align}


%\textcolor{blue}{I think it would be good to put the multi-class setting \textit{here} or in the appendix. }\cep{I think it is good after deep linear networks.}

\subsection{Unwhitened data}\label{sec:unwhite_two_layer}
% In this section we show that the unwhitened.
When data is unwhitened, the right singular vector of $\bm W$ aligns with $\bm\Sigma \bm \beta$ early in training, as we show in Appendix \ref{app:two_layer_unwhitened}. This happens since, early on, the dynamics for the first layer are $\frac{d}{dt} \bm W \sim \bm a(t) \bm\beta^\top \bm\Sigma$. Thus the early time kernel will have a rank-one spike in the $\bm \Sigma \bm \beta$ direction. However, this configuration is not stable as the network outputs grow. In fact, at late time $\bm W$ must realign to converge to $\bm W \propto \bm a \bm \beta^\top$ since the network function converges to the optimum and $f = \bm a^\top \bm W \x = s \bm\beta \cdot \x$, which is the minimum $\ell_2$ norm solution (Appendix \ref{app:inductive_deep_linear}). Thus, the final kernel will always look like $K_{\infty}(\x,\x') = s \x^\top \left[\bm \beta \bm\beta^\top +  \bm I \right] \x'$. However, since the realignment of $\bm W$'s singular vectors happens \textit{during the Phase II spectral learning}, the kernel is not constant up to overall scale, violating the conditions for silent alignment. We note that the learned function still is a kernel regression solution of the final NTK, which is a peculiarity of the linear network case, but this is not achieved through the silent alignment phenomenon as we explain in Appendix \ref{app:two_layer_unwhitened}.


\section{Extension to Deep Linear Networks}\label{sec:deep_linear}
We next consider scalar target functions approximated by deep linear neural networks and show that many of the insights from the two layer network carry over. The neural network function $f : \mathbb{R}^{D} \to \mathbb{R}$ takes the form $f(\x) = {\bm w^{L}}^\top \bm W^{L-1} ... \bm W^{1} \x$. The gradient flow dynamics under mean squared error (MSE) loss become
\begin{align}
    \frac{d}{dt} \bm W^{\ell} = - \eta \frac{\partial L}{\partial \bm W^{\ell}} = \eta \left( \prod_{\ell' > \ell} \bm W^{\ell'} \right)^{\top} \left( s \bm \beta - \bm{\tilde{w}} \right)^\top \bm \Sigma \left( \prod_{\ell' < \ell} \bm W^{\ell' } \right)^\top,
\end{align}
where $\bm{\tilde{w}} = \bm W^{1 \top} \bm W^{2 \top} ... \bm w^{L } \in \mathbb{R}^{D}$ is shorthand for the effective one-layer linear network weights. % Here, we have included the possibility of using different learning rates $\eta_\ell$ for different layers. 
Inspired by observations made in prior works \citep{fukumizu1998effect,arora_cohen_linear_acc, Du2018AlgorithmicRI}, we again note that the following set of conservation laws hold during the dynamics of gradient descent $\frac{d}{dt} \left[  \bm W^{\ell} \bm W^{\ell \top} -  \bm W^{\ell+1 \top} \bm W^{\ell + 1} \right] = 0$. This condition indicates a balance in the size of weight updates in adjacent layers and simplifies the analysis of linear networks. This balancing condition between weights of adjacent layers is not specific to MSE loss, but will also hold for any loss function, see Appendix \ref{app:other_loss_fns}. We will use this condition to characterize the NTK's evolution.



\subsection{NTK Under Small Initialization}\label{sec:small_init}
We now consider the effects of small initialization. When the initial weight variance $\sigma^2$ is sufficiently small, $\bm W^{\ell} \bm W^{\ell \top} - \bm W^{\ell+1 \top} \bm W^{\ell + 1} = O(\sigma^2 ) \approx 0$ at initialization.\footnote{Though we focus on neglecting the $O(\sigma^2)$ initial weight matrices in the main text, an approximate analysis for wide networks at finite $\sigma^2$ and large width is provided in Appendix \ref{app:refined_balance}, which reveals additional dependence on relative layer widths.} 
This conservation law implies that these matrices remain approximately equal throughout training. Performing an SVD on each matrix and inductively using the above formula from the last layer to the first, we find that all matrices will be approximately rank-one $\bm w^{L} =  u(t) \bm r_{L}(t) \ , \ \bm W^{\ell} = u(t) \bm r_{\ell+1}(t) \bm r_{\ell}(t)^\top$, where $\bm r_{\ell}(t)$ are unit vectors. Using only this balancing condition and expanding to leading order in $\sigma$, we find that the NTK's dynamics look like
\begin{align}
    K(\bm x, \bm x', t) &=  u(t)^{2(L-1)} \x^\top \left[ (L-1) \bm r_1(t) \bm r_1(t)^\top +  \bm I \right] \x'  + O(\sigma).
\end{align}
We derive this formula in the Appendix \ref{app:ntk_formula_deep_linear}. We observe that the NTK consists of a rank-$1$ correction to the isotropic linear kernel $\x \cdot \x'$ with the rank-one spike pointing along the $\bm r_{1}(t)$ direction. This is true dynamically throughout training under the assumption of small $\sigma$. At convergence $\bm r(t) \to \bm\beta$, which is the unique fixed point reachable through gradient descent. We discuss evolution of $u(t)$ below. The alignment of the NTK with the direction $\bm\beta$ increases with depth $L$. 

%We note that the strength of feature learning $A / B$, is enhanced with depth $L$ and with an increase in the ratio of $\eta_1 / \eta_L$, the ratio of the learning rate for the first and last layer. This is qualitatively similar to the finding in \citep{Yang2020FeatureLI} which shows that to have stable maximal feature learning in an infinite neural network, the first layer should have enhanced effective learning rate compared to the NTK parameterization. We show how alignment depends on depth in Figure \ref{fig:align_vs_depth}.  We will now discuss the difference of the dynamics in the whitened and unwhitened input data case.



\subsubsection{Whitened Data vs Anisotropic Data}\label{sec:white_vs_unwhite}

We now argue that in the case where the input data is whitened, the trained network function is again a kernel machine that uses the final NTK. The unit vector $\bm r_1(t)$ quickly aligns to $\bm\beta$ since the first layer weight matrix evolves in the rank-one direction $\frac{d}{dt} \bm W^{1} = \bm v(t) \bm \beta^\top$ throughout training for a time dependent vector function $\bm v(t)$. As a consequence, early in training the top eigenvector of the NTK aligns to $\bm\beta$. Due to gradient descent dynamics,  $\bm W^{1 \top} \bm W^1$ grows only in the $\bm\beta \bm\beta^\top$ direction. Since the $\bm r_1$ quickly aligns to $\bm\beta$ due to $\bm W^1$ growing only along the $\bm\beta$ direction, then the global scalar function $c(t) = u(t)^L$ satisfies the dynamics $\dot{c}(t)= c(t)^{2-2/L} \left[ s- c(t) \right]$ in the whitened data case, which is consistent with the dynamics obtained when starting from the orthogonal initialization scheme of \citet{Saxe14exactsolutions}. We show in the Appendix \ref{app:deep_linear_dynamics_ct} that spectral learning occurs over a timescale on the order of $t_{1/2} \approx \frac{L}{s (L-2)} \sigma^{-L+2}$, where $t_{1/2}$ is the time required to reach half the value of the initial loss. We discuss this scaling in detail in Figure \ref{fig:time_to_align_learn_deep}, showing that although the timescale of alignment shares the same scaling with $\sigma$ for $L > 2$, empirically alignment in deep networks occurs faster than spectral learning. Hence, the silent alignment conditions of Section 2 are satisfied. In the case where the data is unwhitened, the $\bm r_1(t)$ vector aligns with $\bm\Sigma \bm \beta$ early in training. This happens since, early on, the dynamics for the first layer are $\frac{d}{dt} \bm W^1 \sim \bm v(t) \bm\beta^\top \bm\Sigma$ for time dependent vector $\bm v(t)$. However, for the same reasons we discussed in Section \ref{sec:unwhite_two_layer} the kernel must realign at late times, violating the conditions for silent alignment. 


\begin{figure}
    \centering
    \subfigure[ODE Time to Learn]{\includegraphics[width=0.29\linewidth]{figures/deep_time_to_half_loss.pdf}}
    \subfigure[$L=3$ Dynamics]{\includegraphics[width=0.32\linewidth]{figures/depth_3_time_to_align.pdf}}
    \subfigure[Time To Learn $L=3$]{\includegraphics[width=0.32\linewidth]{figures/depth_3_learn_time_scaling.pdf}}
    \caption{Time scales are not strongly separated for deep networks ($L \geq 3$), but alignment is consistently achieved  before loss decreases. (a) Time to half loss scales in a power law with $\sigma$ for networks with $L \geq 3$: $t_{1/2} \sim \frac{L}{(L-2)} \sigma^{-L+2}$ (black dashed) is compared with numerically integrating the dynamics $\dot{c}(t) = c^{2-2/L}(s-c)$ (solid). The power law scaling of $t_{1/2}$ with $\sigma$ is qualitatively different than what happens for $L =2$, where we identified logarithmic scaling $t_{1/2} \sim \log(\sigma^{-2})$. (b) Linear networks with $D=30$ inputs and $N=50$ hidden units trained on synthetic whitened data with $|\bm\beta|=1$. We show for a $L=3$ linear network the cosine similarity of $\bm W^{1 \top} \bm W^1$ with $\bm \beta \bm \beta^\top$ (dashed) and the loss (solid) for different initialization scales. (c) The time to get to $1/2$ the initial loss and the time for the cosine similarity of $\bm W^{1\top} \bm W^1$ with $\bm \beta \bm\beta^\top$ to reach $1/2$ both scale as $\sigma^{-L+2}$, however one can see that alignment occurs before half loss is achieved.  }
    \label{fig:time_to_align_learn_deep}
\end{figure}

%\cep{What is the conclusion here? Do we get two phases again? Is there silent alignment? Timescales?} \bb{Looks like alignment dynamics and spectral learning timescales are both of order $\sigma^{-L+2}$.}



%$\bm r_1(t) \propto \bm\Sigma \bm \beta$ is not stable as $u(t)$ increases. In fact, at late time $\bm r_1(t)$ must realign to converge to $\lim_{t \to \infty} \bm r_1(t) = \bm\beta$ since the network function converges to the optimum and $f = \lim_{t\to\infty} u^L(t) \bm r_1(t) \cdot \bm x = s \bm\beta \cdot \x$. This means that the final kernel will always look like $K_{\infty}(\x,\x') = s^{2-2/L} \x^\top \left[ A \bm \beta \bm\beta^\top + B \bm I \right] \x'$. However, since the realignment of $\bm r_1(t)$ happens \textit{during the phase II spectral learning}, the kernel is not constant up to overall scale, violating the conditions for silent alignment. 

\subsection{Multiple Output Channels}

We next discuss the case where the network has multiple $C$ output channels. Each network output, we denote as $f_c(\x')$ resulting in $C^2$ kernel sub-blocks $K_{c,c'}(\x,\x') = \nabla f_c(\x) \cdot \nabla f_{c'}(\x')$. In this context, the balanced condition $\bm W^{\ell} \bm W^{\ell \top} \approx \bm W^{\ell +1 \top} \bm W^{\ell+1}$ implies that each of the weight matrices is rank-$C$, implying a rank-$C$ kernel. We give an explicit formula for this kernel in Appendix \ref{app:multi-class}. For concreteness, consider whitened input data $\bm\Sigma = \bm I$ and a teacher with weights $\bm\beta \in \mathbb{R}^{C \times D}$. The singular value decomposition of the teacher weights $\bm\beta = \sum_{\alpha} s_{\alpha} \bm z_{\alpha} \bm v_{\alpha}^\top$ determines the evolution of each mode \citep{Saxe14exactsolutions}. Each singular mode begins to be learned at $t_{\alpha} = \frac{1}{s_\alpha} \log\left( s_{\alpha} u_0^{-2} \right)$. To guarantee silent alignment, we need all of the Phase I time constants to be smaller than all of the Phase II time constants. In the case of a two layer network, this is equivalent to the condition $\frac{1}{s_{min}} \ll \frac{1}{s_{max}} \log\left( s_{max} u_0^{-2} \right)$ so that the kernel alignment timescales are well separated from the timescales of spectral learning. We see that alignment precedes learning in Figure \ref{fig:multi-class} (a). For deeper networks, as discussed in \ref{sec:white_vs_unwhite}, alignment scales in the same way as the time for learning. 



\section{Silent Alignment on Real Data and ReLU nets}\label{sec:nonlinear_anisotropy}

In this section, we empirically demonstrate that many of the phenomena described in the previous sections carry over to the nonlinear homogenous networks with small initialization provided that the data is not highly anisotropic. A similar separation in timescales is expected in the nonlinear $L$-homogenous case since, early in training, the kernel evolves more quickly than the network predictions. This argument is based on a phenomenon discussed by  \citet{Chizat2019OnLT}. Consider an initial scaling of the parameters by $\sigma$. We find that the relative change in the loss compared to the relative change in the features has the form $\frac{|\frac{d}{dt} \nabla f| }{|\nabla f|} \frac{\mathcal L}{|\frac{d}{dt} \mathcal L|} \approx O(\sigma^{-L})$ which becomes very large for small initialization $\sigma$ as we show in Appendix \ref{app:laziness}. This indicates, that from small initialization, the parameter gradients and NTK evolve much more quickly than the loss. This is a necessary, but not sufficient condition for the silent alignment effect. To guarantee the silent alignment, the gradients must be finished evolving except for overall scale by the time the loss appreciably decreases. However, we showed that for whitened data that nonlinear ReLU networks do in fact enjoy the separation of timescales necessary for the silent alignment effect in Figure \ref{fig:relu_demo_silent_alignment}. In even more realistic settings, like ResNet in Figure \ref{fig:relu_demo_silent_alignment} (d), we also see signatures of the silent alignment effect since the kernel does not grow in magnitude until the alignment has stabilized. 

We now explore how anisotropic data can interfere with silent alignment. We consider the partial whitening transformation: let the singular value decomposition of the data matrix be $\bm X = \bm U \bm S \bm V^\top$ and construct a new partially whitened dataset $\bm X_{\gamma} = \bm U \bm S^{\gamma} \bm V^\top$, where $\gamma \in (0,1)$. As $\gamma \to 0$ the dataset becomes closer to perfectly whitened. We compute loss and kernel aligment for depth 2 ReLU MLPs on a subset of CIFAR-10 and show results in Figure \ref{fig:cifar_anisotropy_partial_whiten}. As $\gamma \to 0$ the agreement between the final NTK and the learned neural network function becomes much closer, since the kernel alignment curve is stable after a smaller number of training steps. As the data becomes more anisotropic, the kernel's dynamics become less trivial at later time: rather than evolving only in scale, the alignment with the target function varies in a non-trivial way while the loss is decreasing. As a consequence, the NN function deviates from a kernel machine with the final NTK.



\begin{figure}[ht]
    \centering
    \subfigure[Input Spectra]{\includegraphics[width=0.3\linewidth]{figures/cifar_singularvals_vary_gamma.pdf}}
    \subfigure[Train Loss]{\includegraphics[width=0.3\linewidth]{figures/cifar_loss_vary_gamma.pdf}}
    \subfigure[Test Error]{\includegraphics[width=0.3\linewidth]{figures/cifar_test_loss_vary_gamma.pdf}}
    \subfigure[Kernel Norm]{\includegraphics[width=0.3\linewidth]{figures/cifar_kernel_norm_vary_gamma.pdf}}
    \subfigure[Phase I alignment]{\includegraphics[width=0.3\linewidth]{figures/cifar_kernel_alignment_vary_gamma.pdf}}
    \subfigure[Predictor Comparison]{\includegraphics[width=0.3\linewidth]{figures/cifar_estimation_NTK_vary_gamma.pdf}}
    \caption{Anisotropy in the data introduces multiple timescales which can interfere with the silent alignment effect in a ReLU network. Here we train an MLP to do two-class regression using Adam at learning rate $5\times 10^{-3}$. (a) We consider the partial whitening transformation on the 1000 CIFAR-10 images $\lambda_k \to \lambda_k^{\gamma}$ for $\gamma \in (0,1)$ for covariance eigenvalues $\bm\Sigma \bm v_k = \lambda_k \bm v_k$. (b) The loss dynamics for unwhitened data have a multitude of timescales rather than a single sigmoidal learning curve. As a consequence, kernel alignment does not happen all at once before the loss decreases and the final solution is not a kernel machine with the final NTK. (c) The test error on classification.  (d) Anisotropic data gives a slower evolution in the kernel's Frobenius norm. (e) The kernel alignment very rapidly approaches an asymptote for whitened data but exhibits a longer timescale for the anisotropic data. (f) The final NTK predictor gives a better predictor for the neural network when the data is whitened, but still substantially outperforms the initial kernel even in the anisotropic case.  }
    \label{fig:cifar_anisotropy_partial_whiten}
\end{figure}


%\begin{figure}[h]
%    \centering
%    \subfigure[Input Spectra]{\includegraphics[width=0.3\linewidth]{figures/singularvals_vary_gamma.pdf}}
%    \subfigure[Loss Dynamics]{\includegraphics[width=0.3\linewidth]{figures/loss_vary_gamma (1).pdf}}
%    \subfigure[Frobenius Norm of Kernel]{\includegraphics[width=0.3\linewidth]{figures/kernel_norm_vary_gamma.pdf}}
%    \subfigure[Phase I alignment]{\includegraphics[width=0.3\linewidth]{figures/kernel_alignment_vary_gamma.pdf}}
%    \subfigure[Predictor Comparison]{\includegraphics[width=0.3\linewidth]{figures/estimation_NTK_vary_gamma.pdf}}
%    \caption{Anisotropy in the data introduces multiple timescales which can interfere with the silent alignment effect in a ReLU network. (a) We consider the partial whitening transformation on the 1000 MNIST images $\lambda_k \to \lambda_k^{\gamma}$ for $\gamma \in (0,1)$ for covariance eigenvalues $\bm\Sigma \bm v_k = \lambda_k \bm v_k$. (b) The loss dynamics for unwhitened data has a multitude of timescales rather than a single sigmoidal learning curve. (c) Likewise the kernel continues growing in norm over a much wider range of times. (d) The kernel alignment very rapidly approaches an asymptote.   }
%    \label{fig:my_label}
%\end{figure}




\section{Conclusion}

We provided an example of a case where neural networks can learn a kernel regression solution while in the rich regime. Our silent alignment phenomenon requires a separation of timescales between the evolution of the NTK's eigenfunctions and relative eigenvalues and a separate phase where the NTK grows only in scale. We demonstrate that, if these conditions are satisfied, then the final neural network function satisfies a representer theorem for the final NTK. We show analytically that these assumptions are realized in linear neural networks with small initialization trained on approximately whitened data and observe that the results hold for nonlinear networks and networks with multiple outputs. We demonstrate that silent alignment is highly sensitive to anisotropy in the input data.

Our results demonstrate that representation learning is not necessarily at odds with the learned neural network function being a kernel regression solution; i.e. a superposition of a kernel function on the training data. While we provide one mechanism for a richly trained neural network to learn a kernel regression solution through the silent alignment effect, perhaps other temporal dynamics of the NTK could also give rise to the neural network learning a kernel machine for a data-dependent kernel. Further, by asking whether neural networks behave as kernel machine for some data-dependent kernel function, one can hopefully shed light on their generalization properties and transfer learning capabilities \citep{ bordelon_icml_learning_curve, Canatar2021SpectralBA,loureiro_lenka_feature_maps, GEIGER20211} and see Appendix \ref{app:transfer_theory}.

%Because the setting here allowed for the dynamics of the kernel to be solved without assumptions on width, depth, we see this paper as a step forward in studying the interplay between representation learning and kernel methods for neural networks. 
%Rather, our theory relied strongly on structural assumptions on the data and small initialization. Although we showed that such an effect could exist in theory, we also demonstrate that silent alignment effect is highly sensitive to anisotropy in the input data.  %In future work, we hope to extend this analysis to neural networks trained on the broader class of unwhitened datasets. 


\subsubsection*{Acknowledgments}
% Use unnumbered third level headings for the acknowledgments. All
% acknowledgments, including those to funding agencies, go at the end of the paper.
CP acknowledges support from the Harvard Data Science Initiative. AA acknowledges support from an NDSEG Fellowship and a Hertz Fellowship. BB acknowledges the support of the NSF-Simons Center for Mathematical and Statistical Analysis of Biology at Harvard (award \#1764269) and the Harvard Q-Bio Initiative. We thank Jacob Zavatone-Veth and Abdul Canatar for helpful discussions and feedback.


\bibliography{iclr2022_conference}
\bibliographystyle{iclr2022_conference}

\newpage 
\begin{appendix}

{\Large Appendix}


\counterwithin{figure}{section}

\section{Derivation of Equation \ref{eq:integ_factor}}\label{app:integrating_factor}

\subsection{Training Point Predictions with Time Varying Kernel}\label{app:integrating_factor1}
Given a training set of $P$ data points $\{ (\x^\mu, y^\mu) \}_{\mu=1}^P$, the dynamics of the network training errors $[\bm \Delta_t]^\mu := f(\bm x^\mu, t) - y^\mu$ close in terms of a time-varying neural tangent kernel $[\bm K_t]_{\mu \nu} = K(\bm x^\mu, \bm x^\nu, t)$
\begin{align}
    \frac{d}{dt} \bm\Delta_t = - \bm K_t \bm \Delta_t .
\end{align}
We introduce the transition matrix $\bm\Phi_t \in \mathbb{R}^{P \times P}$ which has the property that $\bm\Delta_t = \bm \Phi_t \bm\Delta_0$ and $\bm\Phi_0 = \bm I$, we obtain the matrix evolution equation $\dot{\bm\Phi}_t = - \bm K_t \bm \Phi_t$. This equation can be solved formally in terms of the Peano-Baker series \citep{baake2011peano, brockett2015finite}
\begin{align}
    \bm\Phi_t = & \bm I - \int_0^t ds_1 \bm K_{s_1}  + \int_0^t ds_1 \bm K_{s_1} \int_0^{s_1} ds_2   \bm K_{s_2}
    \\
    &- \int_0^t ds_1 \bm K_{s_1}\int_0^{s_1} ds_2 \bm K_{s_2} \int_0^{s_2} ds_3 \bm K_{s_3}+ ... 
\end{align}
which can easily be verified to solve $\frac{d}{dt} \bm \Phi(t) = - \bm K(t) \bm \Phi(t)$ with initial condition $\bm\Phi(0) = \bm I$. Under the condition that $\int_0^t \bm K(t)$ commutes with $\bm K(t)$, which is true in the settings of interest in this paper, specifically the setting discussed in Appendix \ref{app:kernel_ev_scale}, we can simplify the Peano-Baker series into a simple matrix exponential
\begin{align}
    \bm\Phi_t &= \bm I - \left[ \int_0^t ds \bm K_s \right] + \frac{1}{2} \left[ \int_0^t ds \bm K_s \right]^2 - \frac{1}{6} \left[ \int_0^t ds \bm K_s \right]^3  ... + \frac{(-1)^k}{k!} \left[ \int_0^t ds \bm K_s \right]^k + ... \nonumber
    \\
    &= \exp\left( - \int_0^t \bm K_s ds \right) .
\end{align}

Thus, under the condition that $\bm K_t $ commutes with $\int_0^t \bm K_s ds$ we can exactly solve for the training error dynamics in terms of integrating factors
\begin{align}
    \bm\Delta_t = \bm\Phi_t \bm\Delta_0 = \exp\left( - \int_0^t \bm K_s ds \right) \bm\Delta_0 .
\end{align}
We expect this formula to hold approximately whenever the eigenvectors of $\bm K$ are approximately equal to the eigenvectors of $\int_0^t \bm K_s ds$.  

\subsection{Test Point Predictions with Time Varying Kernel}
Given access to the value of the function on training points, one can evaluate the function on test points. We have that the evolution of the function on a test point $f(\bm x)$ is given by
\begin{equation}
    \frac{d}{dt} f_t(\bm x) = - \bm k_t (\bm x) \bm \Delta_t,
\end{equation}
where $[\bm k_t (\bm x)]^\mu := K(\bm x, \bm x^\mu, t)$. This gives the final value of $f$ to be
\begin{equation}
    f^*(\bm x) := f_{\infty}(\bm x) = f_0(\bm x) + \int_0^\infty dt \, \bm k_t(\bm x)^\mu \left[\exp\left(- \eta \int_0^t \bm K_{t'} dt' \right) \right] (\bm y - \bm f_0).
\end{equation}
This is exactly equation \ref{eq:integ_factor}.


%\section{Additional Experiments}

%\subsection{MNIST Anisotropy}\label{app:anisotropy}
%\begin{figure}[h]
%    \centering
%    \subfigure[Input Spectra]{\includegraphics[width=0.3\linewidth]{figures/singularvals_vary_gamma.pdf}}
%    \subfigure[Loss Dynamics]{\includegraphics[width=0.3\linewidth]{figures/loss_vary_gamma (1).pdf}}
%    \subfigure[Frobenius Norm of Kernel]{\includegraphics[width=0.3\linewidth]{figures/kernel_norm_vary_gamma.pdf}}
%    \subfigure[Phase I alignment]{\includegraphics[width=0.3\linewidth]{figures/kernel_alignment_vary_gamma.pdf}}
%    \subfigure[Predictor Comparison]{\includegraphics[width=0.3\linewidth]{figures/estimation_NTK_vary_gamma.pdf}}
%    \caption{Anisotropy in the data introduces multiple timescales which can interfere with the silent alignment effect in a ReLU network. (a) We consider the partial whitening transformation on the 1000 MNIST images $\lambda_k \to \lambda_k^{\gamma}$ for $\gamma \in (0,1)$ for covariance eigenvalues $\bm\Sigma \bm v_k = \lambda_k \bm v_k$. (b) The loss dynamics for unwhitened data has a multitude of timescales rather than a single sigmoidal learning curve. (c) Likewise the kernel continues growing in norm over a much wider range of times. (d) The kernel alignment very rapidly approaches an asymptote.   }
%    \label{fig:my_label}
%\end{figure}
%\subsection{Silent Alignment in Deeper Networks}




\section{Kernel Evolution in Scale Only}\label{app:kernel_ev_scale}

We consider the model of kernel evolution introduced in Section \ref{sec:silent_align_theory} where the kernel evolves only in scale for $t > \tau(\epsilon)$ and is of small overall size for $t < \tau(\epsilon)$,
\begin{equation}\label{eq:cases}
    K(x,x',t) = \begin{cases} 
      \epsilon K_0(x,x',t) & t \leq \tau(\epsilon) \\
      g(t) K_{\infty}(x,x') & t > \tau(\epsilon)
   \end{cases}.
\end{equation}
This model allows for alignment of the kernel while small in the time window $t \in (0,\tau)$, followed by scale growth only for $t \in (\tau,\infty)$. The time threshold $\tau$ will generally depend on the initial kernel scale $\epsilon$. For example, in depth $L$ linear MLPs, $\epsilon \sim \sigma^{2L-2}$ and $\tau \sim \sigma^{-L+2}$ with initialization scale $\sigma$ as we show in Figure \ref{fig:align_vs_depth}. We will define a differentiable function $h(t) = \int_{\tau}^t  g(t') dt'$ so that $h'(t) = g(t)$, $h(\tau) = 0$, and $\lim_{t\to\infty} h(t) = \infty$. This last condition follows from $g$'s continuity and the assumption that $\lim_{t\to\infty} g(t) = 1$. We will first show that the final neural network has the form $f(\x) = f_0(\x) +  \bm k_{\infty}(x) \cdot \bm K_{\infty}^{-1} (\bm y - \bm f_0) + O(\epsilon \tau(\epsilon))$. First, we need to calculate the errors $\bm\Delta(t) = \bm y - \bm f(t) \in \mathbb{R}^P$ made on the $P$ training examples. These satisfy the dynamics
\begin{equation}
    \frac{d}{dt} \bm \Delta(t)  = - \begin{cases} 
      \epsilon \bm K_0(t) \bm \Delta(t)  & t \leq \tau \\
      h'(t) \bm K_{\infty} \bm\Delta(t) & t > \tau
   \end{cases},
\end{equation}
where $\bm K_0(t), \bm K_{\infty} \in \mathbb{R}^{P \times P}$ are $P\times P$ gram matrices; e.g. $[\bm K_{0}(t)]_{\mu \nu} = K_0(\x^\mu,\x^\nu,t)$. The vector $\bm k(\x)$ has entries given by $[\bm k(\x)]_{\mu} = K(\x,\x^\mu)$. For $t \in (0,\tau)$, the error vector follows the dynamics
\begin{align}\label{eq:Delta_change}
    \frac{d}{dt} \bm\Delta(t) = - \epsilon \bm K_0(t) \bm\Delta(t).
\end{align}
Introducing operator norm of a matrix, $|\bm \Phi|_{op} = \max_{|\bm v|_2=1} |\bm \Phi \bm v|_2$, we will now bound the operator norm of the change in the transition matrix $\bm \Phi(t)$ introduced in section \ref{app:integrating_factor1}.
\begin{lemma}\label{lemma:phase1}
    Let $k_0 = \max_{t \in (0,\tau)} |\bm K_0(t)|_{op}$ represent the maximum operator norm of $\bm K_0$ achieved on the interval $(0,\tau)$. Let $\bm \Phi(t) \in \mathbb{R}^{P\times P}$ be the transition matrix for the linear dynamics of equation \ref{eq:Delta_change} so that $\frac{d}{dt} \bm \Phi(t) = - \epsilon \bm K_0(t) \bm\Phi(t)$ and $\bm\Phi(0) = \bm I$. Then,
    \begin{equation}
        |\bm \Phi(\tau) - \bm \Phi(0)|_{op} < \epsilon \tau(\epsilon) k_0.
    \end{equation}
\end{lemma}
\begin{proof}
    We begin by noting that, due to the triangle inequality, 
    \begin{equation}
    \begin{aligned}
        |\bm\Phi(\tau) - \bm \Phi(0)|_{op} = \epsilon \left| \int_0^\tau  \bm K_0(t) \bm \Phi(t) dt \right|_{op} \leq \epsilon \int_0^\tau  \left| \bm K_0(t) \bm\Phi(t) \right|_{op} dt
        \\
        \leq \epsilon \int_0^\tau  \left| \bm K_0(t) \right| \left| \bm\Phi(t) \right|_{op} dt \leq \epsilon k_0 \int_0^\tau  \left| \bm\Phi(t) \right|_{op} dt.
    \end{aligned}
    \end{equation}
We will now establish that $|\bm\Phi(t)|_{op} \leq 1$. Note that for any vector $\bm v \in \mathbb{R}^P$ that
\begin{align}
    \frac{1}{2} \frac{d}{dt} |\bm\Phi(t) \bm v |_2^2 = \bm v^\top \bm \Phi^\top \dot{\bm\Phi}(t) \bm v =- \epsilon \bm v^\top \bm \Phi(t)^\top \bm K(t) \bm\Phi(t) \bm v \leq 0,
\end{align}
where the final inequality follows from the fact that $\bm K(t)$ is positive semidefinite for all $t$. Therefore we have shown that $|\bm \Phi(t)|_{op} \leq |\bm\Phi(0)|_{op} = |\bm I|_{op} = 1$. Using this inequality, we find that
\begin{align}
    |\bm\Phi(\tau) - \bm \Phi(0)|_{op} \leq \epsilon k_0 \int_0^\tau  |\bm\Phi(t)|_{op} \ dt \leq \epsilon k_0 \tau(\epsilon).
\end{align}
\end{proof}
%Let $\mathcal L(t) = \frac{1}{2} |\bm\Delta(t)|^2 = \frac{1}{2} |\bm f(t) - \bm y|^2$ represent the training loss at time $t$. This satisfies
%\begin{align}
%    \frac{d}{dt} \mathcal L(t) = \bm\Delta(t)^\top \dot{\bm\Delta}(t) = - \epsilon  \bm\Delta(t)^\top \bm K_0(t) \bm\Delta(t) \geq - \epsilon k_0 \mathcal{L}(t)
%\end{align}
%Integrating this up to time $\tau$ implies that $\mathcal{L}(\tau) \geq \exp(-\epsilon \tau(\epsilon) k_0) \mathcal{L}_0 \geq \mathcal{L}_0 - O(\epsilon \tau(\epsilon)) $. Thus,
With the above Lemma \ref{lemma:phase1}, we can bound the discrepancy $\bm\Delta(\tau)$ and $\bm\Delta(0)$, namely
\begin{equation}
\begin{aligned}
    |\bm\Delta(\tau) - \bm\Delta(0)|_2 &= |(\bm\Phi(\tau) - \bm\Phi(0) ) \bm\Delta(0)|_2\\
    &\leq |\bm \Phi(\tau) - \bm\Phi(0)|_{op} |\bm\Delta(0)|_2 \leq \epsilon k_0 \tau(\epsilon) |\bm\Delta(0)|_2.
\end{aligned}
\end{equation}
This inequality must therefore hold entry-wise as well, so that
\begin{align}\label{eq:Delta_tau}
    \bm\Delta(\tau)  = \bm\Delta(0) + O(\epsilon k_0 \tau(\epsilon)) .
\end{align} 
We will now establish how the training predictions $\bm\Delta(t)$ evolve for the second interval $t \in (\tau,\infty)$.
\begin{lemma}\label{lemma:phase2}
    Suppose that from $t\in(\tau,\infty)$ that $\bm\Delta(t)$ obeys the dynamics $\frac{d}{dt} \bm\Delta(t) = - h'(t) \bm K_{\infty} \bm\Delta(t)$ where $\bm \Delta(\tau)$ is as in equation \ref{eq:Delta_tau}. Then, for all $t \in (\tau,\infty)$, 
    \begin{equation}
\begin{aligned}
    \bm\Delta(t) &=   \exp\left( - h(t) \bm K_{\infty}  \right) \left[  (\bm y - \bm f_0) +  O(\epsilon \tau(\epsilon) k_0) \right] .
\end{aligned}
\end{equation}
\end{lemma}
\begin{proof}
    The differential equation can be solved through eigendecomposition and integrating factors. Let $\Delta_k(t)$ represent the $k$-th component of $\bm\Delta(t)$ in the eigenbasis of $\bm K_{\infty}$ which is static for $t\in(\tau,\infty)$. Let the corresponding eigenvalue of $\bm K_{\infty}$ be $\lambda_k$. The scalar variable $\Delta_k(t)$ obeys the dynamics
    \begin{align}
        \frac{d}{dt} \Delta_k(t) = - \lambda_k h'(t)  \Delta_k(t).
    \end{align}
    This can be solved with integrating factors, noting that $\frac{d}{dt} \left[ e^{\lambda_k h(t) } \Delta_k(t) \right] = 0$. This implies that $\Delta_k(t) = e^{-\lambda_k h(t)} \Delta_k(\tau)$. Written as a vector, $\bm\Delta(t) = \exp\left( - h(t) \bm K_{\infty} \right) \bm\Delta(\tau)$. Since by Lemma \ref{lemma:phase1} we have $\bm\Delta(\tau) = \bm\Delta(0) + O(\epsilon k_0 \tau(\epsilon))$, we obtain the desired result.
\end{proof}
We will now combine the results of the previous two lemmas which analyze the evolution of the network predictions on the training set to give our main silent alignment result, which specifies what the neural network function predicts for an arbitrary test point $\x$.
\begin{theorem}
Let the kernel have dynamics of Equation \ref{eq:cases} where $g(t)$ is a continuous, integrable function with $\lim_{t \to \infty} g(t) = 1$. The function learned by the neural network is
\begin{align}
    f(\x) - f_0(\x)  = \bm k_{\infty}(\x) \cdot \bm K_{\infty}^{-1} \bm y + O_{\epsilon}(\epsilon \tau(\epsilon) ).
\end{align}
\end{theorem}
\begin{proof}
Using Lemma \ref{lemma:phase1} and \ref{lemma:phase2}, we know the full dynamics for training predictions $\bm\Delta(t)$. Using $\bm\Delta(t)$, we can solve for the final predictor $f(\x)$ by integrating dynamics $\dot{f}(\x,t) = \bm k(\x,t) \cdot \bm\Delta(t)$.
\begin{align}
    f(\x) - f_0(\x) &=  \epsilon \int_0^{\tau} \bm k_{0}(\x,t) \cdot \bm\Delta(t) dt + \bm k_{\infty}(\x) \cdot  \int_{\tau}^{\infty}  \ h'(t) \exp\left( -h(t) \bm K_{\infty} \right)  \bm\Delta(\tau) dt 
    %&=   \bm k_{\infty}(\x) \cdot \int_{0}^{\infty}  \ \exp\left( -h \bm K_{\infty}\right) \bm\Delta_0 dh + O(\epsilon) =  \bm k_{\infty}(\x) \cdot \bm K_{\infty}^{-1} \bm\Delta_0 + O(\epsilon).
\end{align}
We will now bound the first term. Taking $\tilde{k}_0 = \max_{t\in(0,\tau) ,\x \in \mathbb{R}^D} |\bm k_0(\x, t)|_2$, we get that
\begin{equation}
\begin{aligned}
   \left|\epsilon \int_0^\tau \bm k_0(\x,t) \cdot \bm\Delta(t) \right| &\leq \epsilon \int_0^\tau |\bm k(\x)| |\bm\Delta(t)| dt \leq \epsilon (1+\epsilon \tau(\epsilon) k_0 )|\bm\Delta_0| \int_0^\tau |\bm k_0(\x,t)| dt \nonumber \\
   &\leq \epsilon \tau(\epsilon) \tilde{k}_0 (1+\epsilon \tau(\epsilon) k_0 )  |\bm\Delta(0)| = O_{\epsilon}(\epsilon \tau(\epsilon)).
\end{aligned}
\end{equation}
We can now integrate the matrix exponential in the second term, using the fact that
\begin{align}
    \int_{\tau}^{\infty} h'(t) \exp\left( -h(t) \bm K_{\infty} \right) dt = \int_0^\infty \exp\left( -h \bm K_{\infty} \right) dh = \bm K_{\infty}^{-1}.
\end{align}
Using the fact that $\bm\Delta(\tau) = \bm\Delta(0) + O(\tau(\epsilon) \epsilon)$ from Lemma \ref{lemma:phase1}, we arrive at the desired result
\begin{align}
    f(\x) - f_0(\x) = \bm k_{\infty}(\x) \bm K_{\infty}^{-1} \bm\Delta_0 + O_{\epsilon}(\epsilon \tau(\epsilon)) .
\end{align}
\end{proof}
We have now established that, given the kernel dynamics in \Eqref{eq:cases}, $f(\x) - f_0(\x)$ converges to the kernel regression solution with final NTK as $\epsilon \to 0$ provided $\lim_{\epsilon \to 0} \epsilon \tau(\epsilon) = 0$. This is generic in the settings we consider in this paper for networks with small initialization. In this small initialization setting, $f_0$ is also negligible so that $f(\x)$ itself is a kernel regression solution. For example, in a linear depth $L$ neural network with initial weight scale $\sigma$, the initial scale of the kernel is $\epsilon \sim \sigma^{2L-2}$ while the time to alignment scales as $\tau \sim \sigma^{2-L}$ thus $\epsilon \tau \sim \sigma^{L}$ can be made arbitrarily small by taking $\sigma \to 0$. Lastly, the initial network outputs $f_0(\x) \sim \sigma^L$ can also be made arbitrarily small. 

% Up to this point, we have established that $f(\x) = f_0(\x) +  \bm k_{\infty}(\x) \cdot \bm K_{\infty}^{-1} (\bm y - \bm f_0) + O(\epsilon \tau(\epsilon))$. This establishes that the predictor $f(\x) - f_0(\x)$ is arbitrarily close to a kernel regression solution on labels $\bm y - \bm f_0$ provided that the kernel evolves only while small in scale during the first phase $t < \tau$.


% For depth $L$ neural networks with homogenous activations and small initialization, $\epsilon = \sigma^{2L-2}$, and $f_0 \sim O(\sigma^{L})$. Using this assumption of homogeneity, we have
% \begin{align}
%     f(\x) = f_0(\x) +   + O(\sigma^{L}) .
% \end{align}
% This argument establishes that, if the kernel and initial network function start out small in overall scale, and the kernel obeys the dynamics discussed above, then the final learned network function $f(\x)$ is a kernel regression solution with the final NTK.

%\subsection{Metrics for Laziness}

%The analysis of the previous section indicates that if the NTK evolves only in overall scale, the network is effectively in the lazy learning limit. Concretely, if $K(\x,\x',t) = g(t) K_0(\x,\x')$ for initial NTK, $K_0$, then the learned function has the form $f(\x) = \bm k_0(\x) \bm K_0^{-1} \bm y$. This suggests that a valid measure of feature learning must be insensitive to changes in kernel scale only. Some proposals of measures of richness and laziness are sensitive to changes in overall scale. For example, if $L$ represents the loss function, the metric of \cite{Chizat2019OnLT} exhibits scale dependence
%\begin{align}
%    \kappa =  \frac{\left|\frac{d}{dt} \nabla f(t)\right|}{|\nabla f(t)|} \left|\frac{L(t)}{L'(t)} \right|.
%\end{align}
%It was argued that if this quantity is large, then the features are changing significantly and the network cannot be considered to be in the lazy regime. However, suppose that, for all time $\nabla f = g(t) \nabla f_0$. In this case the metric $\kappa$ takes the form
%\begin{align}
%    \kappa = \left| \frac{g'(t)}{g(t)} \frac{L(t)}{L'(t)} \right| .
%\end{align}
%This quantity could be large even though the kernel is changing in a way which does not correspond to feature learning. Thus, we suggest alternative scale free (s.f.) metrics such as
%\begin{align}
%    \kappa_{\text{s.f.}}^{(1)} =  \left| \frac{d}{dt} \frac{\nabla f(t)}{|\nabla f(t)|} \right| \left|\frac{L(t)}{L'(t)} \right| \ , \quad \  \kappa_{\text{s.f.}}^{(2)} = \left| \frac{d}{dt} \frac{\bm K(t)}{\|\bm K(t)\|}  \right| \left|\frac{L(t)}{L'(t)} \right| .
%\end{align}
%The first quantity $\kappa_{\text{s.f.}}^{(1)}$ is zero if features change in scale only $\nabla f = g(t) \nabla f_0$ and the second metric $\kappa_{\text{s.f.}}^{(2)}$ is zero if $\bm K(t)=g(t) \bm K_0$, giving a sensible notion of lazy learning.
% Maybe mention something about the latter metric being easier to compute in practice.

\section{Phases of Learning at Small Initialization} 


%\subsection{Initial Gradients aligned with Input-Output Correlation Directions}
%In this section, we show that after starting from Gaussian initialization, the initial gradients cause alignment of the network weights to the eigenbasis of the input-output correlation matrix
%\begin{align}
%    \bm\Sigma_{31} = \frac{1}{P} \sum_{\mu=1}^P \bm y^\mu \bm x^{\mu \top}
%\end{align}
%Take $\bm P = \bm W^{2} \bm W^{1}$ where $\bm W^{(1)} \in \mathbb{R}^{N\times D}, \bm W^{(2)} \in \mathbb{R}^{C \times N}$ are Gaussian random matrices whose entries have variance $\sigma^2 /D, \sigma^2 / N$ respectively. Early in training, for small initialization we have 
%\begin{align}
%    \dot{\bm P} \sim \bm W^{(2)} \bm W^{(2) \top} \bm \Sigma_{31} + \bm \Sigma_{31} \bm W^{(1) \top} \bm W^{(1)} + O(\sigma^4)
%\end{align} 
%Let $\mathbf \Sigma_{31} = \sum_{\alpha} s_\alpha \mathbf u_{\alpha} \mathbf v_{\alpha}^\top$. We would like to characterize the statistical properties of the following quantities to show early alignment
%\begin{align}
%  c_{\alpha\beta} = \bm u_{\alpha}^\top \dot{\bm P} \bm v_{\beta} =  s_\beta  \bm u_{\alpha }^\top \bm W^{(2)} \bm W^{(2) \top} \bm u_{\beta} + s_{\alpha} \bm v_{\alpha}^\top \bm W^{(1) \top} \bm W^{(1)} \bm v_{\beta}  
%\end{align}

%Working out the first two moments, yields
%\begin{align}
%   \left< c_{\alpha \beta} \right> &= 2 s_{\alpha} \sigma^2 \delta_{\alpha\beta}  \\
%    \left< c_{\alpha \beta}^2 \right> &=  4 s_{\alpha}^2 \sigma^4 \delta_{\alpha\beta} + \left( \frac{N}{D^2} s_{\alpha}^2 + \frac{1}{N} s_{\beta}^2 \right) \sigma^4\left( 1+ \delta_{\alpha\beta} \right).
%\end{align}
%We thus find that the diagonal elements $\alpha = \beta$ have nonzero $O(1)$ average and twice the variance as the off-diagonal terms $\alpha \neq \beta$. Consider the linear scaling $D = \gamma N$. Thus, we have the following for the projection of the weight updates on the $(\alpha,\beta)$ pair of singular vectors

%$$ c_{\alpha,\beta} = 2 s_{\alpha} \sigma^2 \delta_{\alpha\beta} \pm \frac{\sigma^2 \sqrt{ \left( \gamma^{-2} s_{\alpha}^2 + s_{\beta}^2 \right) ( 1+ \delta_{\alpha\beta}) }}{\sqrt N} + O(\sigma^4)  $$

%Thus, for small initialization and large width $N$ the  $c_{\alpha,\beta}$ coefficients concentrate around $2s_{\alpha} \sigma^2 \delta_{\alpha\beta}$. This indicates that the network will evolve separately along different singular modes of the input-output correlation matrix $\mathbf\Sigma_{31}$. Note the preceding argument did not need an assumption on the whitening of the data, as $\Sigma^{11}$ will enter as $O(\sigma^4)$.

\subsection{Phase I: Two layer Network and Kernel Alignment}\label{app:two_layer_phase_one}\label{subsec:phase1}

We now present an analysis distinct from that of the previous subsection to go beyond the first step of gradient descent. The NTK for the two layer linear network has the form $K = \x^\top \bm M \x'$ with $\bm M = \bm W^\top \bm W + |\bm a|^2 \bm I$. Our goal is to determine the eigendecomposition of $\bm M$. Introduce the variables $q(t) = \frac{1}{2} \bm\beta^\top \bm M \bm\beta = \frac{1}{2} \left[ |\bm a|^2 + \bm\beta^\top \bm W^\top \bm W \bm\beta \right]$ and $r(t) = \bm a^\top \bm W \bm \beta $. These dynamics form a closed two dimensional linear system early in training
\begin{equation}
\begin{aligned}
   \frac{d}{dt} \begin{bmatrix}
    q(t) \\ r(t)
    \end{bmatrix} 
    &= 2 \eta s \begin{bmatrix}
        0 & 1 \\
        1 & 0 
        \end{bmatrix}\begin{bmatrix}
    q(t) \\ r(t)
    \end{bmatrix} + O(\sigma^3) \ , \quad   t,\sigma \to 0 
    \\  \implies \begin{bmatrix}
    q(t) \\ r(t)
    \end{bmatrix} &=
    \frac{1}{2}(q_0+r_0) \begin{bmatrix} 1  \\ 1 \end{bmatrix} e^{2 \eta st} + \frac{1}{2}(q_0-r_0) \begin{bmatrix} 1  \\ -1 \end{bmatrix} e^{-2 \eta s t} + O(\sigma^3)
\end{aligned}
\end{equation}
The variable $q(t)$ represents the alignment of the NTK with the optimal direction $\bm \beta$ while $r(t)$ defines the alignment of the network with the teacher. We see that this alignment increases exponentially with timescale $t \sim \eta^{-1} s^{-1}$. While the above equations hold for early time and small initialization for any initial condition $q_0, r_0$, we can further estimate these initial values under random initialization provided the input dimension is large. We stress that this limit is not necessary for the silent alignment, but allows for a nice simplification. For Gaussian initialization $a_i \sim \mathcal N(0,\sigma^2/N), W_{ij} \sim \mathcal{N}(0,\sigma^2/D)$ with large $D$, we have
\begin{align}\label{eq:qr}
    \left<q_0\right> = \frac{\sigma^2}{2} \left( 1 + \frac{N}{D}  \right) \ , \ \left<r_0\right>= 0 \ , \ \left<r_0^2\right> = \frac{\sigma^4}{D}.
\end{align}
In the large $D$ limit, we have with high probability $q_0 \gg r_0$ and thus $r(t) = q_0 \sinh(2 \eta st)$ and $q = q_0 \cosh(2 \eta st)$.  Note that this gives the quantities $q(t) = \frac{1}{2} \bm\beta^\top \bm M(t) \bm\beta, r(t) = \bm\beta^\top \bm W^\top \bm a$ early in training. Now consider a unit vector $\bm v$ which is orthogonal to the solution $\bm \beta^\top \bm v = 0$. We find that the projection of $\mathbf M$ along this direction evolves dynamically as: 
\begin{equation}
\begin{aligned}
        \frac{d}{d t} \bm{v}^\top \bm M(t) \bm v &= 2 \bm v^\top \left[ \bm \beta \bm a^\top \bm W  + \bm \beta^\top \bm W^\top \bm a  \bm I   \right] \bm v
    \\
    &= 2 r(t).
\end{aligned}
\end{equation}
We can conclude that $\bm v^\top \bm M \bm v$ is equal to $q(t)$ up to an additive initialization constant. We see that this is evolving half as quickly as $\bm \beta^\top \bm M \bm \beta = 2 q(t)$. Since $\bm v^\top \bm M_0 \bm v \sim O(\sigma^2)$ is small compared to the exponentially growing $\bm M(t)$, the only matrix that satisfies these two conditions must necessarily take the form
\begin{align}
    \bm M(t) = q_0 \cosh(2\eta s t) \left[ \bm\beta \bm\beta^\top + \bm I \right] + \bm M_0.
\end{align}
The first term, which is growing exponentially in $t$ will eventually overwhelm the randomly initialized kernel $\bm M_0$, which is $O(\sigma^2)$.

\subsection{Phase I: Error in the Leading Order Approximation}\label{sec:phase_one_error}

In solving the equations of the previous section, we truncated the full gradient descent equations at order $\sigma^3$. It is important to confirm that the error generated by this truncation remains bounded. We will argue by self-consistency. The full equations are
\begin{align}
    \frac{d}{dt} \bm a =  \bm W \left( s \bm\beta - \bm W^\top \bm a \right), \quad
    \frac{d}{dt} \W =  \bm a \left( s \bm \beta - \bm W^\top  \bm a  \right)^\top.
\end{align}
One can use these equations to solve for the dynamics of the $r, q$ variables:
    \begin{align}
    \frac{d}{dt} q(t) &= 2 s r - \bm \beta^\top \left[\bm W^\top \bm a \bm a^\top \bm W + \bm a^\top \bm W \bm W^\top \bm a \right] \bm \beta = 2 s r - [2 r^2 + \sum_{\bm v_i \perp \bm \beta}  (\bm a^\top \bm W \bm v_i)^2 ] \label{eq:align1} \\
    \frac{d}{dt} r(t) &= 2 s q - \bm a^\top [ \bm W \bm W^\top + \bm a \bm a^\top] \bm W \bm \beta = 2 s q - 2 |\bm a|^2 r + \bm a^\top [\bm a \bm a^\top - \bm W \bm W^\top] \bm W \beta\label{eq:align2}
    \end{align}
The second equality in \eqref{eq:align1} comes from inserting a complete basis of states including $\bm \beta$ and $\bm v_i \perp \bm \beta$ into the last term of the left-hand side. The second equality in \eqref{eq:align2} comes from writing $\bm W \bm W^\top + \bm a \bm a^\top = 2 \bm a \bm a^\top + (\bm W \bm W^\top - \bm a \bm a^\top)$. Note that the final term in brackets on the right hand side is a conserved quantity for linear networks, and so is always of order $O(\sigma^2)$.

Assuming the solutions for $q, r$ are valid to order $\sigma^2$, we get that $\frac{d}{dt} \bm a^\top \bm W \bm v_i = O(\sigma^4)$.
\begin{align}
    \frac{d}{dt} \bm a^\top \bm W \bm v_i = (\bm\beta-\hat{\bm\beta})^\top \bm W^\top \bm W \bm v_i + |\bm a|^2 (\bm\beta - \bm{\hat \beta})^\top \bm v_i 
\end{align}

Further noting that because of the conservation law $\bm a \bm a^\top - \bm W \bm W^\top = O(\sigma^2)$ is also constant in time. This gives us that
\begin{equation}
    | \bm a^\top [\bm a \bm a^\top - \bm W \bm W^\top] \bm W \bm \beta | \leq \sigma^2 | \bm a^\top\bm W \bm \beta | = \sigma^2 r.
\end{equation}
We now note that $r, |\bm a|^2$ both grow as a ($\sigma, s$-independent) constant times  times $\sigma^2 e^{2 s t}$. The correction to the dynamics of both equations is then bounded by a constant times $\sigma^4 e^{4 s t}$.
This will be less than $\sigma^2$ as long as $t$ satisfies
\begin{equation}
    t \ll \frac{1}{4 s} \log \left( \frac{s}{\sigma^2} \right).
\end{equation}
For $\sigma^2 \ll s$, the alignment time $t=1/s$ falls within this range and we are guaranteed alignment to the Ganguli-Saxe configuration.

The error of the full solution at time $t$ can be bounded by the integral of this error bound from $0$ to $t$, namely a constant times $\sigma^4/ s$. As long as $s \gg \sigma^4$, we are guaranteed that the error of the kernel is $O(\sigma^2)$ as given in \eqref{eq:approx_align}.


\subsection{Phase I: Two Layer Analysis with Unwhitened Data}\label{app:two_layer_unwhitened} 

We now study the same linearization around the initial fixed point used in the main text but for the two layer network with unwhitened data. In this case,
\begin{align}
    \frac{d}{dt} \bm a  &\sim s \bm W \bm\Sigma \bm\beta,
    \\
    \frac{d}{dt} \bm W &\sim s \bm a \bm \beta^\top \bm\Sigma.
\end{align}
which holds asymptotically as $t / \log(\sigma^{-1})  \to 0$.
We introduce the following variables which form a closed linear dynamical system
\begin{equation}
\begin{aligned}
    r_1(t) &= \bm \beta^\top \bm W^\top \bm a ,
    \\
    r_2(t) &= |\bm a|^2 ,
    \\
    r_3(t) &= \bm \beta^\top \bm W^\top \bm W \bm \Sigma \bm \beta  ,
    \\
    r_4(t) &= \bm \beta^\top \bm\Sigma \bm W^\top \bm a ,
    \\
    r_5(t) &= \bm\beta^\top \bm \Sigma \bm W^\top \bm W \bm \Sigma \bm \beta.
\end{aligned}
\end{equation}
Introduce the constants $a = \bm\beta^\top \bm \Sigma \bm\beta \ , \ b = \bm\beta^\top \bm\Sigma^2 \bm\beta$. Using the weight dynamics, it is straightforward to show that
\begin{align}
    \dot{\bm r}(t) \sim s \begin{bmatrix}
    0 & a & 1 & 0 & 0 \\
    0 & 0 & 0 & 2 & 0 \\
    b & 0 & 0 & a & 0 \\
    0 & b & 0 & 0 & 1 \\
    0 & 0 & 0 & 2b & 0
    \end{bmatrix} \bm r(t) \ , \ t \ll \log( \sigma^{-2} ).
\end{align}

This matrix has eigenvalues $\lambda \in \{0, -\sqrt{b}, \sqrt{b}, - 2\sqrt{b}, 2\sqrt{b}\}$. Since there are only two positive eigenvalues $\sqrt{b}, 2\sqrt{b}$, it suffices to consider evolution along those two eigendirections, where the kernel and neural network function will be amplified. Evolution along these direcions give
\begin{align}
    \bm r(t) \sim c_1 e^{s \sqrt{b} t} \begin{bmatrix}
    1 \\
    0 \\
    \sqrt{b} \\
    0 \\
    0
    \end{bmatrix} + c_2 e^{2 s  \sqrt{b} t}
    \begin{bmatrix}
    a
    \\
    \sqrt{b}
    \\
    a\sqrt{b}
    \\
    b
    \\
    b\sqrt{b}
    \end{bmatrix} ,
\end{align}
where $c_1,c_2$ are constants determined by intialization. At large time, the large eigenvalue mode $\lambda = 2\sqrt{b}$ will dominate. Decomposing $\bm W = \bm W_0 + \bm a(t) \left[ v_1(t) \bm\beta + v_2(t) \bm \Sigma \bm\beta \right]^{\top}$ we find that the only self consistent solution is $v_1(t) = 0, v_2(t) = b^{-1/2}$. This implies that the kernel evolution will take the form
\begin{equation}
\begin{aligned}
    K(\x,\x',t) &\sim K(\x,\x',0) + |\bm a(t)|^2  \x^\top \bm M \x',
    \\
    \bm M &= \left[ \frac{1}{\sqrt{\bm\beta^\top \bm\Sigma^2 \bm \beta}} \bm \Sigma \bm \beta\bm\beta^\top \bm\Sigma +  \bm I  \right].
\end{aligned}
\end{equation}
We see that the kernel evolves along the directions $\bm\Sigma\bm\beta$ early in training for unwhitened data. We visualize the two stages of learning for unwhitened data in Figure \ref{fig:anisotropic_visual}. 
\begin{figure}
    \centering
    \subfigure[Initialization]{\includegraphics[width=0.32\linewidth]{figures/kernel_contour_init_anisotropic.pdf}}
    \subfigure[Transition Time]{\includegraphics[width=0.32\linewidth]{figures/kernel_contour_transition_anisotropic.pdf}}
    \subfigure[Min $\ell_2$ norm solution]{\includegraphics[width=0.32\linewidth]{figures/kernel_contour_final_anisotropic.pdf}}
    \caption{Kernel evolution on anisotropic data consists of two alignment phases. (a) At initialization the level curves of $\bm\beta^\top \bm M^{-1} \bm\beta$ exhibit spherical symmetry. (b) After the initial phase I alignment, the matrix $\bm M$ exhibits a spike in the $\bm\Sigma \bm \beta$ direction. (c) At long times, the network function and kernel's spiked direction need to converge to the minimum $\ell_2$ norm solution as we explain in \ref{app:inductive_deep_linear}. This requires realignment of the kernel at late times, eliminating the preconditions for the silent alignment effect.  }
    \label{fig:anisotropic_visual}
\end{figure}

\subsection{Phase II: Whitened Data}\label{subsec:phase2}

Consider a two layer network $f = \bm a^\top \bm W \x$ where balance has been achieved $\bm W = u(t) \bm{\hat a} \bm\beta^\top$ and $\bm a(t) = u(t) \bm{\hat{a}}$. Once this balance condition is stable for fixed $\bm{\hat a}$, we can calculate the time derivative of $u(t)$
\begin{align}
    \frac{d}{dt} \bm a(t) = \dot{u}(t) \bm{\hat a} = u(t) \left[ s - u(t)^2 \right] \bm{\hat a}.
\end{align}
Letting $c(t) = u(t)^2$, we find that $\dot{c}(t) = 2 u(t)^2 \left[ s- u(t)^2  \right] = 2 c(t) \left[ s-c(t) \right]$, which is the two layer dynamics derived in \cite{Saxe14exactsolutions}. This dynamics has solution $c(t) = \frac{s e^{2st}}{e^{2st} -1 + s/c_0}$.

\subsection{Solutions to the full training dynamics of linear networks at small initialization}\label{subsec:solns_to_full_training}

By combining the analyses of the subsection \ref{subsec:phase1} with the exact solutions discussed in \ref{subsec:phase2} we can match both solutions to obtain formulas for $r(t)$ and $q(t)$ for the entire network's training path that are exact up to $O(\sigma^2)$ corrections. Up to $O(\sigma^2)$ we then have that
\begin{align}
    r(t) &= s \frac{2 \sinh(2 s t)}{(e^{2 s t } - 1) + 2s/q_0 },\\
    q(t) &= s \frac{2 \cosh(2 s t)}{(e^{2 s t } - 1) + 2s/q_0 }.
\end{align}
This yields that the initialization constant $q_0/2$ plays the effective role of $c_0$ in the Ganguli-Saxe solution for phase II. Equation \ref{eq:qr} yields the expected value of this initialization constant. We have empirically verified that these exact equations hold to high accuracy across a variety network sizes, initialization scales, and whitened datasets. We illustrate some of these in figure \ref{fig:qr}.



\begin{figure}
    \centering
    \subfigure[Loss Dynamics]{\includegraphics[width=0.3\linewidth]{figures/loss_curve_vs_sigma.pdf}}
    %\subfigure[Kernel Norm Dynamics]{\includegraphics[width=0.32\linewidth]{figures/kernel_norm_vs_sigma.pdf}}
    \subfigure[Time to $L_t = 0.5$]{\includegraphics[width=0.3\linewidth]{figures/sigma_vs_half_time.pdf}}
    \subfigure[Alignment $\sigma = 10^{-4}$.]{\includegraphics[width=0.3\linewidth]{figures/loss_evolution_vs_alignment.pdf}}
    %\subfigure[Loss curve vs. $\eta_1/\eta_2$]{\includegraphics[width=0.28\linewidth]{figures/vary_eta_1.pdf}}
    %\subfigure[Ratio of $K$ Eigenvalues]{\includegraphics[width=0.28\linewidth]{figures/vary_eta_1_alignment.pdf}}
    
    \caption{Initialization scale controls the time spent in phase I, where the network escapes the saddle point near $\bm W, \bm a= \bm 0$ and the kernel aligns to the task. (a) The loss curves for two-layer linear networks with small initialization follow sigmoidal trajectories as in \cite{Saxe14exactsolutions} which transition from their maximum to minimum at a time which decreases with initialization scale. Theory is shown in black dashed lines. (b) Verification of the Phase I time $t_{1/2}$, measured as the time for the loss to reach one half its original value. This scales logarithmically with $\sigma^{2}$. (c) The alignment of the kernel eigenfunctions happens before the loss appreciably decreases for $\sigma = 10^{-4}$, evidenced by the kernel alignment curve. The analytically obtained maximum alignment value is overlayed in dashed green.}
    \label{fig:two_layer_theory_expt}
\end{figure}

\begin{figure}[h]
    \centering
    \subfigure[Synthetic]{\includegraphics[width=0.32\linewidth]{figures/qr_synthetic.pdf}}
    \subfigure[Whitened MNIST]{\includegraphics[width=0.32\linewidth]{figures/qr_MNIST.pdf}}
    \caption{Overlay of empirical and exact solutions for $q(t), r(t)$ in two layer linear feedforward networks for synthetic and two-class MNIST whitened datasets. (a) We take $D=25, N=10$.  (b) We take $D=784, N=100$.}
    \label{fig:qr}
\end{figure}

\section{Balancing of Weights in Deep Linear Networks}\label{app:other_loss_fns}

The balance condition discussed in the main text holds for deep linear trained with any loss function of the form $\mathcal{L} = \sum_\mu \ell(f^\mu,y^\mu)$ (not just MSE) since, as was shown by \cite{arora_cohen_linear_acc,Du2018AlgorithmicRI}
\begin{equation}
\begin{aligned}
    \frac{1}{\eta}\frac{d}{d t} \left(  \bm W^{\ell} \bm W^{\ell \top} \right)&= \sum_{\mu} \frac{\partial \ell}{\partial f^\mu} \left[ \frac{\partial f^\mu}{\partial \bm W^{\ell}} \bm W^{\ell \top} + \bm W^{\ell} \frac{\partial f^\mu}{\partial \bm W^{\ell}}^\top \right]
    \\
    &= \sum_{\mu} \frac{\partial \ell}{\partial f^\mu} \left[ \frac{\partial f^\mu}{\partial \bm W^{\ell+1}}^\top \bm W^{\ell+1} + \bm W^{\ell+1 \top} \frac{\partial f^\mu}{\partial \bm W^{\ell+1}} \right]\\
    &= \frac{1}{\eta} \frac{d}{d t} \left( \bm W^{\ell+1 \top} \bm W^{\ell+1} \right) .
\end{aligned}
\end{equation}

The second line follows from the first since the following quantities are identical
\begin{align}
    \frac{\partial f^\mu}{\partial \bm W^{\ell}} \bm W^{\ell \top} &= \bm W^{\ell+1 \top} ... \bm W^{L-1 \top}\bm w^L \left( \x^{\mu \top} \bm W^{1 \top} ... \bm W^{\ell-1 \top} \right) \bm W^{\ell \top},
    \\
    \bm W^{\ell+1 \top }\frac{\partial f^\mu}{\partial \bm W^{\ell+1}} &= \bm W^{\ell+1 \top} \left( \bm W^{\ell \top} ... \bm w^L \right) \x^{\mu\top} \bm W^{1\top} ... \bm W^{\ell \top}.
\end{align}
By inspection these two quantities are equal. Thus we have, for any loss function, a deep linear network has the following conservation laws
\begin{align}
    \frac{d}{dt} \left[ \bm W^{\ell} \bm W^{\ell\top} - \bm W^{\ell+1 \top} \bm W^{\ell+1} \right] = 0 .
\end{align}
We show in the next section that this balancing condition is very helpful in identifying the time evolution of the neural tangent kernel. In the case where the network has a single output, we can inductively prove that each layer's weight matrix is $\bm W^{\ell} = u(t) \bm r_{\ell+1}(t) \bm r_\ell(t)^\top$. We will assume this formula is true for layer $\ell+1$ and prove it must hold for layer $\ell$ since
\begin{align}
     \bm W^{\ell} \bm W^{\ell \top} = \bm W^{\ell + 1 \top} \bm W^{\ell+1} =  u(t)^2 \bm r_{\ell+1}(t) \bm r_{\ell+1}(t)^\top.
\end{align}
This implies that $\bm W^{\ell}$ is rank one with right singular vector equal to $\bm r_{\ell+1}(t)$. Thus, the decomposition for each layer the form $\bm W^{\ell} = u(t) \bm r_{\ell+1}(t) \bm r_{\ell}(t)^\top$ for some unit vector $\bm r_{\ell}(t)$. Similar analysis can be performed for the multi-class setting.


\section{NTK Formula for Deep Linear Networks}\label{app:ntk_formula_deep_linear}

The neural tangent kernel for a linear network $f(\x) = \bm w^{L \top} \bm W^{L-1} ... \bm W^1 \x$ is defined as an inner-product over all gradients
\begin{equation}
    \begin{aligned}
    K(\x,\x') &= \sum_{\ell=1}^L \left< \frac{\partial f(\x)}{\partial \bm W^{\ell }} , \frac{\partial f(\x')}{\partial \bm W^{\ell }} \right>
    \\
    &= \left| \prod_{\ell=2}^L \bm W^{\ell} \right|^2 \x \cdot \x' + \sum_{\ell=2}^L \left|\prod_{\ell' > \ell} \bm W^{\ell'} \right|^2  \x^\top \bm W^{1\top} ... \bm W^{\ell-1 \top} \bm W^{\ell-1} ... \bm W^{1} \x' .
\end{aligned}
\end{equation}
Under the balanced assumption that $\bm W^{\ell} = u(t) \bm r_{\ell+1}(t) \bm r_{\ell}(t)^\top + O(\sigma)$, expanding the kernel to leading order in $\sigma$ yields the following form:
\begin{align}
    K(\x,\x') = u(t)^{2L-2} \x^\top \left[ (L-1) \bm I + \bm r_1(t) \bm r_1(t)^\top \right] \bm x' + O(\sigma),
\end{align}
%where the coefficients $A, B$ can be calculated in terms of the per-layer learning rate
%\begin{align}
%    B = \prod_{\ell \neq 1} \frac{\eta_{\ell}}{\eta_L} \ , \ A = \sum_{\ell = 2}^L \prod_{\ell' \neq \ell} \frac{\eta_{\ell'}}{\eta_L}.
%\end{align}
%Suppose that all learning rates in the second and higher layers are equal $\eta_2 = \eta_3 = ... = \eta_L = \eta$. In this case, the ratio of the kernel eigenvalues are 
%\begin{align}
%    \frac{A}{B} = (L-1) \frac{\eta_1}{\eta} ,
%\end{align}
%showing that deeper networks and faster learning rates in the first layer give more dramatic alignment. In Figure \ref{fig:relative_lr} we show that the predicted strength of feature learning in two layer linear network can be altered by the relative learning rate of the first and second layer. In particular, enhancing the first layer's learning rate gives more dramatic feature learning, quantified as the ratio of the NTK's maximal to minimal eigenvalue.

%\begin{figure}[h]
%    \centering
%     \subfigure[Loss curve vs. $\eta_1/\eta_2$]{\includegraphics[width=0.32\linewidth]{figures/vary_eta_1.pdf}}
%    \subfigure[Ratio of $K$ Eigenvalues vs Learning Rates]{\includegraphics[width=0.32\linewidth]{figures/vary_eta_1_alignment.pdf}}
%    \subfigure[Ratio of $K$ Eigenvalues vs Depth]{\includegraphics[width=0.32\linewidth]{figures/depth_dependence_of_lambdas.pdf}}
%    \caption{(a) Enhancing the learning rate of the first layer increases the slope of the loss curve near the transition time. (b) The size of the rank-one spike in the kernel grows linearly with the first layer's relative learning rate $\eta_1 / \eta_2$.}
%    \label{fig:relative_lr}
%\end{figure}

\begin{figure}[ht]
    \centering
    \includegraphics[width=0.32\linewidth]{figures/vary_depth_loss.pdf}
    \includegraphics[width=0.32\linewidth]{figures/vary_depth_kernel_align.pdf}
    \includegraphics[width=0.32\linewidth]{figures/vary_depth_first_layer_align.pdf}
    \caption{The depth dependence of loss dynamics, kernel alignment and the alignment of first layer weights in a linear network on synthetic whitened data in $D=30$ dimensions. (a) The loss reaches half its initial value after $t \sim \sigma^{-L + 2}$ steps for $L>2$. The decay rate of the loss becomes sharper with depth. (b) Final kernel alignment increases monotonically with depth $L$ and approaches $1$ as $L \to \infty$. (c) The alignment of the first layer weights $\bm W_1$ with the optimal direction $\bm\beta$ approaches $1$ for all models.  }
    \label{fig:my_label}
\end{figure}


\begin{figure}[ht]
    \centering
     \subfigure[Loss]{\includegraphics[width=0.32\linewidth]{figures/MLP_loss_dynamics_vs_depth_P3000.pdf}}
    \subfigure[Alignment]{\includegraphics[width=0.32\linewidth]{figures/MLP_align_dynamics_vs_depth_P3000.pdf}}
    \subfigure[Test Comparison]{\includegraphics[width=0.32\linewidth]{figures/MLP_predictor_agreement_P3000.pdf}}
    \caption{ReLU networks across depths trained on two-class whitened CIFAR. The hidden widths are all of size 100. We use 3k train points and 7k test points. (a) The loss exhibits the same scaling as $\sigma^{-L+2}$ as in the linear setting. (b) Deep networks with nonlinearities are seen to undergo the silent alignment effect early on in training. The dashed lines indicate when the kernel has grown to 10\% of its final value. (c) The trained network outputs on test data match closely the kernel regression with the final learned kernel, but do not match regression the initial kernel.}
    \label{fig:two_layer_relu_mnist}
\end{figure}





\subsection{Deep Linear Network Dynamics Under Balance}\label{app:deep_linear_dynamics_ct}

In this section, we will consider the dynamics of the variable $u$ once the balance condition is satisfied. Let $\bm w_L = \bm{\hat w} u(t)$. Then the dynamics for $u(t)$ under the balancing assumption is
\begin{align}
    \frac{d}{dt} \bm w_L =  \bm{\hat w} \frac{d}{dt} u(t) = \left( \prod_{\ell=1}^{L-1} \bm W^{\ell} \right) ( s - u(t)^L )  \prod_{\ell=1}^{L-1} \bm W^{\ell} \bm\beta = u(t)^{2L-2} ( s - u(t)^L ) \bm{\hat w},
\end{align}
which implies the fact $\dot{u}(t) = u(t)^{L-1}(s-u(t)^L)$. Changing variables to $c(t) = u(t)^L$ we obtain 
\begin{align}
    \dot{c}(t) = u(t)^{L-1} \dot{u} = u(t)^{2L-2} (s-u(t)^L) = c(t)^{2-2/L} (s-c(t)).
\end{align}
When $c_0^L$ is initialized to a very small value compared to $s$ we can 
\begin{equation}
\begin{aligned}
    \frac{d}{dt} c(t) \sim c(t)^{2-2/L} s \ &\implies  \left[ c(t)^{-1+ 2/L} - c_0^{-1 + 2/L} \right] =  - \frac{L-2}{L} st
    \\
    \implies c(t) &= \left[ c_0^{- \frac{L-2}{L} } - \frac{\left(L-2\right)}{L} st  \right]^{- \frac{L}{L-2}}.
\end{aligned}
\end{equation}
This implies a timescale to learn of $t \sim s^{-1} \frac{L}{L-2} \sigma^{-L+2}$.

We can approximate the timescale for the first layer's singular vector $\bm r_1(t)$ to align to $\bm\beta$ as well. Let $\bm v$ be a vector orthogonal to $\bm\beta$. 
\begin{align}
    \frac{d}{dt} \frac{|\bm W^{(1)} \bm\beta|^2}{|\bm W^{(1)} \bm v|^2} = \frac{2 \bm\beta^\top \bm W^{(1) \top} ...\bm w_L}{|\bm W^{(1)} \bm v|^2} \sim O( \sigma^{L-2}).
\end{align}
This suggests that alignment in a deep network should also occur on a timescale of $t \sim \sigma^{-L + 2}$. While there is no strict separation of timescales in terms of the scaling of alignment and learning with $\sigma$, we find that alignment tends to precede a significant drop in the loss as we show in Figure \ref{fig:time_to_align_learn_deep}.

% \begin{figure}
%     \centering
%     \includegraphics[width=0.32\linewidth]{figures/depth_3_cifar_singularvals_vary_gamma.pdf}
%     \includegraphics[width=0.32\linewidth]{figures/depth_3_cifar_loss_vary_gamma.pdf}
%     \includegraphics[width=0.32\linewidth]{figures/depth_3_cifar_kernel_norm_vary_gamma.pdf}
%     \includegraphics[width=0.32\linewidth]{figures/kernel_alignment_vary_gamma.pdf}
%     \includegraphics[width=0.32\linewidth]{figures/depth_3_cifar_estimation_NTK_vary_gamma.pdf}
%     \caption{The same experiment as in Figure \ref{fig:cifar_anisotropy_partial_whiten} but with a deeper $L=3$ network. }
%     \label{fig:deeper_figure_6}
% \end{figure}

\subsection{Final NTK for Deep Linear Networks}\label{app:NTK_final_deep_linear}
Independent of the structure of the data, the first vector $\bm r_1 \to \bm\beta$ and the final NTK has the following form:
\begin{align}
    K(\x,\x') = s^{2L-2} \x^\top \left[ (L-1) \bm\beta \bm\beta^\top +  \bm I \right] \x' + O(\sigma).
\end{align}
This formula is merely a consequence of the balancing condition and convergence to the optimum $u(t)^L \to s$. We provide empirical support that final kernel alignment increases with depth in Figure \ref{fig:align_vs_depth}.

\subsection{Formula for the Intermediate NNGP Kernels}

Let $\bm\beta$ represent the unit vector pointing in the optimal direction for the scalar output case. To calculate this, all that needs to be assumed is that the network has converged to its optimum and that the weights satisfy the balance property so that $\bm W^{\ell} = u^* \bm r_{\ell+1}^* \bm r_{\ell}^*$. By the convergence assumption $u^* = s^{1/L}$ and $\bm r_1^* = \bm\beta$. We stress that this holds for arbitrary input correlation structure $\bm\Sigma$, the final NNGP kernel for layer $\ell$ can also be computed. Expanding the weights and collecting terms at leading order in $\sigma$ yields:
\begin{align}
    K_{\ell}(\x,\x') \sim s^{2\ell / L}  \x^\top \bm \beta \bm\beta^\top \x'  + O(\sigma).
\end{align}
Evaluating on the training set gives $\bm K_{\ell} = \left( \bm y \bm y^\top  \right)^{\ell/L} \in \mathbb{R}^{P \times P}$.

\begin{figure}[t]
    \centering
    \subfigure[Alignment Dynamics and Depth]{\includegraphics[width=0.4\linewidth]{figures/cifar_subsample_align_vs_depth.pdf}}
    \subfigure[Initial and Final NTKs]{\includegraphics[width=0.42\linewidth]{figures/cifar_subsample_kernel_learning.pdf}}
    \caption{The final NTK for a deep linear network aligns with the class specific directions with strength that depends on network depth $L$. This experiment is a partially whitened ($\gamma=0.25$ see Section \ref{sec:nonlinear_anisotropy}) subset of $100$ CIFAR-10 images. (a) The dynamics of alignment for different depth models. (b) The final gram matrix has the form $\bm K_{\infty} \propto (L-1) \bm y \bm y^\top + \bm K_0$, illustrating why alignment of the final NTK to class structure increases with depth $L$. }
    \label{fig:align_vs_depth}
\end{figure}



\section{Generalization Error in Transfer Learning Task}\label{app:transfer_theory}

%In the th section, we analyzed linear networks and showed that the kernel evolution and feature learning does not change which function the linear network converges to. However, 
The structure of the final kernel can alter the ability of the network to flexibly transfer to new tasks with a small amount of data. In this section, we examine how learned intermediate representations compares with the inductive bias of the original isotropic kernel $\x \cdot \x'$.  In particular, we study the offline generalization performance of kernels of the form
\begin{align}
    K(\x,\x'; A) = \x^\top \left[ A \bm\beta \bm\beta^\top + \bm I \right] \x'.
\end{align}

In Section \ref{sec:deep_linear} we showed that $A$ could be altered by changing the network depth. Concretely, our transfer learning problem consists of training a linear probe on one of the intermediate layers of the network (\cite{alain2016understanding, cohen2020separability}). This would also produce a kernel regression solution for kernel $K(\x,\x',A)$ with $A$ which depends on the chosen layer and the depth of the network. For simplicity, we  assume that the data are generated according to a simple Gaussian distribution $\x \sim \mathcal{N}(0,\bm I)$ and that the target values are generated with a linear function $y(\x) = \bm w \cdot \x$. We  decompose the new task vector $\bm w = \alpha \bm\beta + \sqrt{(1-\alpha^2)} \bm w_{\perp}$ where $\bm w_{\perp} \cdot \bm \beta = 0$. The expected generalization error after training with $P$ samples can be computed with methods from the physics of disordered systems \citep{bordelon_icml_learning_curve, Canatar2021SpectralBA, loureiro_lenka_feature_maps}.   For any $A>0$, the easiest transfer task is $\bm w = \bm\beta$ ($\alpha = 1$). If $\bm w = \bm \beta$, increasing the alignment $A$ strictly decreases the generalization error. This is illustrated in Figure \ref{fig:generalization}.
    

\begin{figure}[h]
    \centering
    \subfigure[$\alpha = 0.75$]{\includegraphics[width=0.32\linewidth]{figures/theory_offline_learning_curve.pdf}}
    \subfigure[$A=1$]{\includegraphics[width=0.32\linewidth]{figures/theory_offline_learning_curve_vs_alpha.pdf}}
    \subfigure[Fixed $P$]{\includegraphics[width=0.32\linewidth]{figures/theory_offline_transfer_alpha_vs_A_heat.pdf}}
    \caption{The offline generalization error in a transfer task with the learned linear kernel $K = \x^\top \left[ A \bm \beta^\top \bm \beta^\top + \bm I \right] \x'$ and $y_{new} = \left[ \alpha \bm\beta + \sqrt{(1-\alpha^2)} \bm w_{\perp} \right] \cdot \x$. (a) For a new transfer task which is correlated with the learned function $\beta$, neural networks with large feature learning $A$ give lower generalization error at small sample sizes. (b) For fixed $A=1$, the tasks $\bm w$ which are strongly correlated with $\bm\beta$ are easier to learn during transfer. (c) The lowest generalization error in a transfer learning setup occurs when feature learning strength $A$ and correlation between tasks $\alpha$ are both large.}
    \label{fig:generalization}
\end{figure}


\subsection{Derivation of Learning Curves}
We will discuss the average case generalization error in the transfer learning setting. Prior work has shown that the generalization performance of kernel regression can be calculated through a kernel eigenvalue problem \citep{bordelon_icml_learning_curve,Canatar2021SpectralBA, loureiro_lenka_feature_maps}
\begin{align}
   \left< K(\x,\x') \phi_k(\x) \right>_{\x} = \lambda_k \phi_k(\x).
\end{align}
Once this integral eigenvalue problem is solved for eigenvalues $\lambda_k$ and orthonormal eigenfunctions $\phi_k$, the average case generalization error at $P$ training examples is
\begin{align}
    E_g = \frac{1}{1-\gamma} \sum_k \frac{\left< y(\x) \phi_k(\x) \right>^2}{(\lambda_k P + \kappa)^2} \ , \ \kappa = \lambda + \kappa \sum_{k} \frac{\lambda_k}{\lambda_k P + \kappa} \ , \ \gamma = P \sum_k \frac{\lambda_k^2}{(\lambda_k P + \kappa)^2}.
\end{align}

In our case, we are interested in the generalization performance of the linear kernel
\begin{align}
    K(\x,\x') = \x^\top \left[ \bm\beta \bm\beta^\top + \bm I \right] \x' .
\end{align}
Since $K$ is a linear kernel, its eigenfunctions should be linear functions $\phi_k(\x) = \bm\phi_k \cdot \x$. Assuming that the data distribution has identity covariance, we find
\begin{align}
    \left< \x^\top \left[ A \bm\beta \bm\beta^\top + \bm I \right] \x'  \bm\phi_k^\top \x  \right> = \bm\phi_k^\top \left[ A \bm\beta \bm\beta^\top + \bm I \right] \x' = \lambda_k \bm\phi_k^\top \x'.
\end{align}
This implies that the $\bm\phi_k$ vectors are eigenvectors of $\bm M$. The first eigenvector is $\bm\phi_1 = \bm \beta$ with eigenvalue $\lambda_1 = A + 1$. The other $D-1$ eigenvectors can be chosen as any frame in the $D-1$ dimensional subspace orthogonal to $\bm\beta$. Each of these $D-1$ eigenvectors has eigenvalue $\lambda_k = 1$. Using these results, and the fact that $\bm w = \alpha \bm \phi_1 + \sqrt{1-\alpha^2} \bm w_{\perp}$, we can calculate the expected generalization error.

\begin{equation}
\begin{aligned}
    E_g &= \frac{1}{1-\gamma} \left[ \frac{\alpha^2}{((1+A)P + \kappa)^2} + \frac{1-\alpha^2}{( P + \kappa )^2} \right] \nonumber
    \\
    \kappa &= \lambda + \kappa  \left[ \frac{1+A}{(1+A)P + \kappa} + \frac{D-1}{ P + \kappa} \right] \ ,  \ \gamma = P \left[ \frac{(1+A)^2}{((1+A)P + \kappa)^2} + \frac{D-1}{ (P + \kappa)^2} \right].
\end{aligned}
\end{equation}
By the result proven in \cite{Canatar2021SpectralBA}, the lowest possible error for fixed $A$ occurs by maximizing the fraction of variance along the large eigenvalue direction, corresponding to $\alpha = \pm 1$.





\section{Linear NTKs During GD Learn The Same Function}\label{app:all_ntk_learn_same}
In the overparameterized setting where $D > P$, all linear networks discussed in the Section \ref{sec:deep_linear} converge to the minimum norm interpolator when the data is whitened. Specifically, letting the learned neural network function be written as $f(x) = \bm{\hat\beta}^\top \x$, and the data matrix $\bm X \in \mathbb{R}^{D \times P}$ and target labels $\bm y\in\mathbb{R}^{P}$ represent the training data. The solution vector $\bm\beta$ solves the constrained optimization problem
\begin{align}
    \min_{\bm{\hat\beta}} ||\bm{\hat\beta}||^2 \ , \ \text{s.t.} \ \bm X^\top \bm{\hat\beta} = \bm y,
\end{align}
which is the kernel regression solution for the initial kernel $K_0(x,x') = \x \cdot \x'$. This is unsurprising due to a symmetry argument: when $\bm\beta_0 \approx 0$, the only privileged point on the affine space $\bm X^\top \bm \beta = \bm y$ is the point closest to the origin, which is precisely the solution above. Surprisingly, the final pseudo-inverse solution $s \bm\beta$ also minimizes the RKHS norms for any of the kernels throughout gradient descent. Up to an overall scale, the kernels throughout evolution take the form $K(\x,\x';t) = \bm x^\top \left[ A(t) \bm\beta \bm\beta^\top + \bm I \right] \bm x'$ (see Section \ref{sec:small_init}) which would induce the following kernel interpolation problems 
\begin{align}
    \min_{\bm{\hat \beta}} \ \bm{\hat \beta}^\top \left[ A(t) \bm\beta \bm\beta^\top + \bm I \right]^{-1} \bm{\hat \beta} \ , \ \text{s.t.} \ \bm X^\top \bm{\hat\beta} = \bm y.
\end{align}
The solution to this optimization problem is indeed the kernel regression solution with kernel $K(t)$ since the learned function takes the form $f(x) = \sum_{\mu} \alpha^\mu K(\x,\x^\mu,t)$ with $\bm\alpha = \bm K(t)^{-1} \bm y$. Using the Sherman-Morrison rule, we show that the solution to each of these problems $t \geq 0$ gives the same result, namely the pseudo-inverse solution. This can be seen from the following
\begin{align}
    \bm{\hat \beta}^\top \left[ A(t) \bm\beta \bm\beta^\top + \bm I \right]^{-1} \bm{\hat \beta} = |\bm{\hat \beta}|^2- \frac{A(t)}{1+A(t)} \left( \bm\beta \cdot \bm{\hat \beta} \right)^2.
\end{align}

Now, we let $\bm{\hat \beta} = s\bm \beta + \bm \beta_{\perp}$, where $\bm\beta \cdot \bm \beta_{\perp} = 0$. This is the general decomposition for the set of interpolators which have the property $\bm X^\top \left[ \bm \beta + \bm\beta_{\perp} \right] = \bm y$.  
\begin{align}
    \min_{\bm\beta_{\perp}} |\bm \beta_{\perp}|^2.
\end{align}
The solution is merely to set $\bm\beta_{\perp} = 0$. Thus the optimal solution is therefore the same for any finite value of $A$. However, the final RKHS norm of the learned function $\bm\beta^\top \left[A(t) \bm \beta \bm \beta^\top + \bm I \right]^{-1} \bm\beta$ decreases with time, indicating that the kernel becomes more aligned with the pseudo-inverse direction as $A$ increases.

\subsection{Deep Linear Networks From Small Initialization Learn Pseudo-Inverse}\label{app:inductive_deep_linear}

In this subsection of the appendix, we will use our theoretical technology for balanced linear networks to demonstrate the universal learned function for \textit{any data}, not just whitened input, providing an alternative derivation to the result proven in Theorem 7 of \cite{yun2020unifying}. This analysis is performed in the $\sigma \to 0$ limit, where $\bm W_{\ell} = u(t) \bm r_{\ell+1}(t) \bm r_{\ell}(t)^\top$ as we showed in Section \ref{app:other_loss_fns}. Under this condition the learned function $f(\x) = \bm{\hat \beta} \cdot \x$ is defined through weights $\bm{\hat{\beta}} = \bm W_1^\top \W_2^\top ... \w_L = u(t)^L \bm r_1(t)$. We see that the direction of the learned function is controlled entirely by $\bm r_1(t)$. It suffices to prove that $\bm r_1(t) \in \text{span}\{\x_1,...,\x_P\}$ for all $t$ to show that the network learns the pseudo-inverse solution $\bm \beta^* = \bm X (\bm X^\top \bm X)^{-1} \bm y$, where $\bm X \in \mathbb{R}^{D \times P}$ and $\bm y \in \mathbb{R}^{P}$ are the training data and targets respectively.  Note that by gradient descent, we have
\begin{align}
    \frac{d}{dt} \bm W_1(t) = \bm W_2^\top ... \w_L  \sum_\mu  (y_\mu - f_\mu(t)) \x_\mu^\top = u(t)^{L-1} \bm r_2(t) \sum_\mu  (y_\mu - f_\mu(t)) \x_\mu^\top.
\end{align}
From the balance condition $\bm W_1(t) = u(t) \bm r_2(t) \bm r_1(t)^\top$, we also have
\begin{align}
    \frac{d}{dt} \bm W_1(t) = \left[ \dot{u}(t) \bm r_2(t) + u(t) \dot{\bm r_2}(t) \right] \bm r_1(t)^\top + u(t) \bm r_2(t) \dot{\bm r_1}(t)^\top.
\end{align}

Equating the two above expressions for $\frac{d}{dt} \bm W_1(t)$ and taking an inner product with $\bm r_2(t)$ from the left gives the following
\begin{align}
    u(t) \dot{ \bm r}_1(t) = u(t)^{L-1} \sum_\mu (y_\mu - f_\mu(t) ) \x^\mu - \left[ \dot{u}(t) + u(t)  \bm r_2(t) \cdot \dot{\bm r}_2(t) \right] \bm r_1(t).
\end{align}

Thus, if $\bm r_1(t) \in \text{span}\{ \x_1,...,\x_P \}$ then $\dot{\bm r}_1(t) \in \text{span}\{ \x_1,...,\x_P \}$ so that the full dynamics of $\bm r_1(t)$ lie in the subspace spanned by the training data. At initialization, we have $\dot{\W}_1(t) \propto \bm z(t) \sum_\mu \bm  y^\mu x_\mu^\top + O(\sigma^3)$ so the initial $\bm r_1$ vector will indeed align with the span of the training data in the $\sigma \to 0$ limit.

By the fact that $\bm{\hat \beta} = u(t)^L \bm r_1(t)$, the learned linear coefficients $\hat{\bm{\beta}}$ must also be in $\text{span}\{ \x_1,...,\x_P \}$ so $\bm{\hat \beta} = \sum_\mu \alpha_\mu \x_\mu$.  These must also interpolate the data provided $D \geq P$, giving the following condition 
\begin{align}
    \bm{\hat \beta} \cdot \x^\nu = \sum_{\mu} \x_{\nu} \cdot \x_\mu \alpha_\mu = y_\nu \implies \bm\alpha = (\bm X^\top \bm X)^{-1} \bm y \implies \bm{\hat \beta} = \bm X (\bm X^\top \bm X)^{-1} \bm y.
\end{align}
This is exactly the minimum $\ell_2$ norm interpolating solution which solves 
\begin{align}
    \min_{\bm{\hat \beta}} |\bm{\hat \beta}|_2^2 \ , \ \text{s.t.} \ , \ \bm X^\top \bm{\hat \beta } = \bm y.
\end{align}

While anisotropy of the data makes no impact on what function is ultimately learned in the linear network case, the anisotropy can have a signficant influence on whether the preconditions for silent alignment are satisfied in a nonlinear network, which can prevent the final function from being a NTK regressor with final NTK.

\section{Final Kernel in Multi-Class Networks}\label{app:multi-class}

For a network with $C$ output channel, balancing and alignment guarantee that the configuration of the network is orthogonal and balanced as in the setting of \cite{Saxe14exactsolutions}. One can then integrate each mode separately to obtain the final kernel as
\begin{equation}
\begin{aligned}
    \bm W^{\ell} &=  \sum_{\alpha=1}^C u_{\alpha}(t) \bm r_{\ell+1}^{\alpha}(t) \bm r_{\ell}^{\alpha}(t)^\top \ , \ K_{c,c'}(\x,\x') = \x^\top \bm M_{c,c'} \x',
    \\
    M_{c,c'} &= \delta_{c,c'} \sum_{\alpha} u_{\alpha}^{2(L-1)}(t) \bm r_1^{\alpha} \bm r_1^{\alpha}  +  \sum_{\ell=1}^{L-1} \sum_{\alpha} u_{\alpha}^{2(L-\ell)}(t) \bm e_c^\top \bm r_L^{\alpha} \bm r_L^{\alpha \top} \bm e_{c'}  \sum_{\beta} u_{\beta}^{2(\ell-1)}(t) \bm r_1^{\beta} \bm r_1^{\beta \top},
\end{aligned}
\end{equation}
where the Cartesian unit vectors $\bm e_c \in \mathbb{R}^{C}$ are one-hot on class output $c$. This shows that the contributions to the kernel depend on how well the class output channels align with the unit vectors $\bm r_L^{\alpha}$. Further, the singular values $u_{\alpha}$ can evolve at different timescales depending on the structure of the data. 

Specifically, for a depth $L$ network, both the the alignment time $t_\alpha^{(L)}$ and the time to learn a given singular value $s_\alpha$ scale as $s_\alpha^{-1} \sigma^{2-L}$, as shown in appendix E.1. The differences in alignment times $\Delta t_{\alpha \beta} := t_{\alpha}^{(L)} - t_{\beta}^{(L)}$ for modes $s_\alpha, s_\beta$ therefores scales as $\Delta t_{\alpha \beta}^{(L)} = \sigma^{2-L} \Delta t_{\alpha \beta}^{(2)}$.

\begin{figure}[ht]
    \centering
    \subfigure[Linear depth 2]{\includegraphics[width=0.32\linewidth]{figures/multi-output_alignment_depth_2_linear.pdf}}
    \subfigure[Linear depth 4]{\includegraphics[width=0.32\linewidth]{figures/multi-output_alignment_depth_4_linear.pdf}}
    \subfigure[Tanh depth 3]{\includegraphics[width=0.32\linewidth]{figures/multi-output_alignment_depth_3_tanh.pdf}}
    
    \caption{Demonstration of a separation between alignment and spectral learning phases across networks trained on multi-class data. Here we train on whitened MNIST. Each network has $\sigma$ so that $\sigma^L = 10^{-4}$ for $L$ the depth of the network. (a) Depth two multi-class dynamics are very similar to single class. The analytically predicted final alignment is in dashed green. (b) For deeper multi-class networks, each singular values is learned far apart in time, and alignment does not as clearly precede loss decay.  (c) Similar dynamics are obtained for tanh networks. Note for deeper networks there is a stronger separation of the times to learn each singular value, resulting in the ten separated drops in the loss.}
    \label{fig:multi-class}
\end{figure}



\subsection{Final NNGP in multi-output case}

We can also gain intuition about the learned representations in each layer by looking at the NNGP kernels, which merely take inner-products between layer activations for different inputs. Let $\bm\beta \in \mathbb{R}^{C \times D}$ represent the optimal weight matrix which has the property (in the over-parameterized case) $\bm\beta \bm x^\mu = \bm y^\mu$. At the optimum, the neural network must learn $\bm\beta = \bm W^{L} ... \bm W^1$. Computing the SVD of $\bm\beta = \sum_\alpha \beta_{\alpha} \bm z_{\alpha} \bm v_{\alpha}^\top$ reveals that $u^*_\alpha = \beta_\alpha^{1/L}$ and $\bm r^1_\alpha= \bm v_{\alpha}$ and $\bm r^{L}_\alpha = \bm z_\alpha$. Using these facts, it is easy to derive the final NNGP kernel for layer $\ell$. 

\begin{equation}
\begin{aligned}
    K_{\ell}(\x,\x') &= \x^\top \bm W^{1 \top } ... \bm W^{\ell \top} \bm W^{\ell } ... \bm W^{1} \x' \\
    &= \x^\top \left[  \sum_\alpha \left( u_\alpha^* \right)^{2\ell} \bm r_\alpha^1 \bm r_\alpha^{1\top} \right] \x' = \x^\top \left[ \bm\beta^\top \bm\beta \right]^{\ell/L} \x'.
\end{aligned}
\end{equation}

Evaluating on the training set $\bm X \in \mathbb{R}^{D \times P}$ gives $\bm K_{\ell} = \bm X^\top \left[ \bm\beta^\top \bm\beta \right]^{\ell/L} \bm X$, which interpolates between $\bm X^\top \bm X$ at layer $\ell=0$ and $\bm Y^\top \bm Y$ at layer $L$.

\subsection{More Refined Balancing Analysis}\label{app:refined_balance}

We can derive corrections to our decomposition of the kernel by including the initial conditions in our derived conservation laws. In particular, we will consider balancing for large width networks. Note that the network does not need to be in the lazy regime. The balancing condition is
\begin{align}
    \bm W^{\ell}(t) \bm W^{\ell \top}(t) - \bm W^{\ell + 1 \top}(t) \bm W^{\ell + 1}(t) = \bm W^{\ell}_0\bm W^{\ell \top}_0 - \bm W^{\ell + 1 \top}_0 \bm W^{\ell + 1}_0.
\end{align}

Note that $\bm W^{\ell}_0 \in \mathbb{R}^{N_{\ell+1} \times N_{\ell}}$ has entries with zero mean and variance $\sigma^2/N_{\ell}$ in the standard parameterization. The products of initial matrices are therefore Wishart distributed. For sufficiently large widths, we can approximate the initial weight matrix products with their expectation over the random initialization
\begin{align}
    \bm W^{\ell}_0\bm W^{\ell \top}_0 - \bm W^{\ell + 1 \top}_0 \bm W^{\ell + 1}_0 \approx \sigma^2 \left(1 - \frac{N_{\ell+2}}{N_{\ell+1}} \right) \bm I.
\end{align}
This concentration becomes more accurate as the widths $N_{\ell}, N_{\ell+1} \to \infty$. For the last layer if the number of classes $C = N_L$ is sufficiently large, we also obtain similar concentration for the last layer $\bm W^{L \top} \bm W^{L} \approx \sigma^2 \frac{N_L}{N_{L-1}} \bm I$. Repeating the backward induction on the conservation law, we find the following recursively defined singular value decompositions 
\begin{equation}
    \begin{aligned}
    \bm W^{\ell} &= \sum_{\alpha} u_\alpha^{\ell}(t) \bm r_{\ell+1}^{\alpha}(t) \bm r_{\ell}^{\alpha}(t)^\top,
    \\ u^{\ell}_{\alpha}(t)^2 &= u_{\alpha}^{\ell+1}(t)^2 + \sigma^2 \left( 1 - \frac{N_{\ell+2}}{N_{\ell+1}} \right) = u_{\alpha}^{L}(t)^2 + \sigma^2 g_\ell ,
    \\
    g_{\ell} &= L - \ell - \sum_{k=\ell}^{L-1} \frac{N_{k+1}}{N_k} .
    \end{aligned}
\end{equation}
We note that the corrections $g_\ell$ vanish if all layers $k > \ell$ have the same width. Let $u_{\alpha} = u^{(L)}_{\alpha}(t)$. The condition for convergence is 
\begin{align}
    \prod_{\ell} \left[ u_{\alpha}^{\left(\ell\right)} \right]^2 = \prod_{\ell} \left[ (u_{\alpha})^2 + \sigma^2 g_{\ell} \right] = s_{\alpha}^2.
\end{align}
In the $\sigma^2 \to 0$ limit, we can solve that $u_{\alpha} \sim s^{1/L}$ as before. However, we can now obtain leading order corrections (in $\sigma^2$) which take the form of the form
\begin{align}
    \left[ u_{\alpha} \right]^2 \sim s^{2}_{\alpha} - \frac{g \sigma^2}{2L s_{\alpha}^{1/L}} \ , \ \sigma^2 \to 0  \ , \ g = \sum_{\ell=1}^L g_{\ell} = \frac{L(L-1)}{2} - \sum_{\ell=1}^L \sum_{k=\ell}^{L} \frac{N_{k+1}}{N_k},
\end{align}
which reveals that the size of the correction depends not only on $\sigma$ but also on the depth and network widths. Suppose all network widths were equal $N_{\ell} = N_k$, then the term $g = 0$ and there is no contribution from the first moment of the random weights.

\section{Laziness in Homogenous Networks}\label{app:laziness}

In this section we recapitulate the argument found in  \cite{Chizat2019OnLT}. The goal is to estimate how rapidly the gradient features on a test point $\nabla f(\x)$ change compared to the loss early in training. Let $\bm f \in \mathbb{R}^P$ represent the function outputs on the training set. We will compute the time derivatives of the loss and the network gradients.
\begin{align}
    \left|\frac{d}{dt} \nabla_{\bm\theta} f(\x) \right| &= \left|\nabla^2 f(\x) \cdot \frac{d \bm\theta}{dt} \right| = \left| \nabla^2 f(\x) \cdot \sum_\mu (y^\mu  - f^\mu) \nabla f^\mu \right|   ,
    \\ \left|\frac{d}{dt} \mathcal L \right| &= \left|\frac{d \bm\theta}{dt} \right|^2 = \left|\nabla \bm f \cdot (\bm y - \bm f) \right|^2.
\end{align}
Here, $|\cdot |_{op}$ denotes the operator norm of a matrix.
We are interested in the ratio of the loss' time derivative to the gradient's time derivative. With an initialization scale of $\bm f \sim O(\sigma^L)$ we find
\begin{align}
    \frac{\left|\frac{d}{dt} \nabla f (\x) \right|}{|\nabla \bm f|} \frac{\mathcal L}{\left| \frac{d}{dt} \mathcal L \right|} = \frac{|\nabla^2 f(\x) \cdot \sum_\mu (y^\mu - f^\mu) \nabla f^\mu| |\bm y - \bm f|^2}{|\nabla \bm f| |\nabla \bm f \cdot (\bm y - \bm f)|^2} \approx \frac{|\nabla^2 f(\x) \cdot \sum_\mu y^\mu \nabla f^\mu| |\bm y|^2}{|\nabla \bm f| |\nabla \bm f \cdot \bm y|^2},
\end{align}
where in the last step we approximated $y^\mu - f^\mu \approx y^\mu$ for small initialization scale since $y^\mu \sim O(1)$ and $f^\mu \sim O(\sigma^L)$. Now we will estimate the scale of each of the terms above. For a homogenous model $\nabla f \sim O(\sigma^{L-1})$ and $\nabla^2 f \sim O(\sigma^{L-2})$. Counting powers of $\sigma$ in numerator and denominator, we find that this quantity of interest scales as
\begin{align}
    \frac{\left|\frac{d}{dt} \nabla f (\x) \right|}{|\nabla \bm f|} \frac{\mathcal L}{\left| \frac{d}{dt} \mathcal L \right|} = O(\sigma^{-L}).
\end{align}
This result indicates that, from small initialization, the gradient NTK features and thus the kernel itself will evolve much more rapidly than the loss. This effect can be amplified by increasing depth and decreasing initialization scale.
\end{appendix}



\section{ResNet Experimental Details}\label{app:res_net_experiment}

Below, we provide the alignment and loss dynamics for wide resnet for CIFAR-10 with $100$ training points. Because the loss decreases significantly before the kernel reaches its final alignment value, the final NTK is not perfectly correlated with the final neural network function. The wide ResNet model is taken from \cite{Novak2020Neural} and is based on the original architecture of \cite{zagoruyko2017wide} with  a widening factor of $k=4$ and a single block per ResNet group $b=1$, giving a final network with $8$ trainable layers. For both Figure \ref{fig:relu_demo_silent_alignment} (d) and (e) as well as Figure \ref{fig:unwhitened_relu} use Adam with a learning rate of $\eta = 10^{-5}$ and initial weight scale of $\sigma = 0.3$ in standard parameterization for all intermediate blocks. For the first conv layer, we used $\sigma = 6.0$. We find that small initial weight variance in the first layer gives rise to less stable learning and worse kernel alignment. 
\begin{figure}[h]
    \centering
    \subfigure[Dynamics]{\includegraphics[width=0.4\linewidth]{figures/resnet_loss_alignment_curve_unwhitened.pdf}}
    \subfigure[Predictions]{\includegraphics[width=0.4\linewidth]{figures/cifar_prediction_comp_unwhitened_resnet_more_data.pdf}}
    \caption{The dynamics and predictions of a Wide-Resnet with $k=4$ and $b=1$ on $P=100$ unwhited CIFAR-10 images from the first two classes.}
    \label{fig:unwhitened_relu}
\end{figure}

Below, in Figure \ref{fig:deeper_res_net}, we provide comprehensive results for different depths which we control by increasing the number of blocks per group $b$, corresponding to WRNs with $6b+1$ trainable conv layers.  
\begin{figure}
    \centering
    \subfigure[Training Loss]{\includegraphics[width=0.4\linewidth]{figures/res_loss_dynamics_vs_depth_P100.pdf}}
    \subfigure[Kernel Norm]{\includegraphics[width=0.4\linewidth]{figures/res_norm_dynamics_vs_depth_P100.pdf}}
    \subfigure[Alignment Dynamics]{\includegraphics[width=0.4\linewidth]{figures/res_align_dynamics_vs_depth_P100.pdf}}
    \subfigure[Predictor Comparison]{\includegraphics[width=0.4\linewidth]{figures/deep_res_predictor_agreement_P100.pdf}}
    \caption{The silent alignment effect is preserved across a large range of depths in WideResNet trained on whitened CIFAR-10 images. The number of blocks per group $b$ alters the total number of conv layers ($6b + 1$ total conv layers). (a) The deeper models train faster with Adam. (b) The final NTK norm increases with depth. (c) The alignment achieves close to its final value by the time the kernel norm reaches $10\%$ of its final value (dashed line), indicating successful silent alignment. (d) The neural network predictions are very close to the predictions of the final NTK but is not accurately predicted by the initial NTK. }
    \label{fig:deeper_res_net}
\end{figure}

\begin{figure}
    \centering
    \subfigure[Train Loss Dynamics]{\includegraphics[width=0.4\linewidth]{figures/res_loss_dynamics_vs_width_P100.pdf}}
    \subfigure[Kernel Norm]{\includegraphics[width=0.4\linewidth]{figures/res_norm_dynamics_vs_width_P100.pdf}}
    \subfigure[Alignment]{\includegraphics[width=0.4\linewidth]{figures/res_align_dynamics_vs_width_P100.pdf}}
    \subfigure[Predictor Comparison]{\includegraphics[width=0.4\linewidth]{figures/deep_res_predictor_agreement_vs_width_P100.pdf}}
    \caption{Varying the ResNet widening parameter $k$ also alters the kernel and loss dynamics. (a)  The loss curve for $b=2$ WRNs with widening factor $k$. Wider networks train more quickly. (b) The kernel norm increases more rapidly for wider networks but changes by a smaller amount. (c) Alignment reaches close to its asymptote by the time the kernel norm grows to $10\%$ its final value (dashed). (d) The final kernel is a much better predictor of the NN function than the initial kernel. }
    \label{fig:my_label}
\end{figure}


\subsection{Adaptive Optimizers and the Relevant Kernel}
Many adaptive gradient methods compute updates to parameters $\theta_j$ according to
\begin{align}
    \dot{\theta}_{j}(t) =  - \eta_{j}(t) \frac{\partial \mathcal L}{\partial \theta_{j,t}} 
\end{align}
where $\eta_{j}(t)$ are time-varying functions which are computed in terms of the history of gradient moments for parameter $\theta_j$ or in terms of its instantaneous gradient. The relevant kernel at time $t$ which governs instantaneous evolution of network predictions is
\begin{align}
    K(\x,\x', t) = \sum_j \eta_j(t) \frac{\partial f(\x, t)}{\partial \theta_j} \frac{\partial f(\x',t)}{\partial \theta_j} 
\end{align}
since $\dot{f}(\x) =\sum_\mu K(\x,\x^\mu,t) (y^\mu - f(\x^\mu, t))$. Though we do not calculate this kernel which is relevant to the adaptive learning rate scheme since it is not supported in Neural Tangents API, this could be a worthy future investigation. 


\end{document}
