 \appendix
\section{Auxiliary definitions}
\begin{small}
\noindent $\HB{\ctx}$:
\begin{quote}
$
\begin{array}{l}
\HB{\emptyctx}=\emptyset\\
{\HB{\Block{\dvs\,\Dec{\T}{\x}{\ctx}\,\decs}{\e}}=\HB{\ctx}\cup\dom{\dvs}\cup\dom{\decs}}\cup\{x\}\\
\end{array}
$
\end{quote}
\noindent
$\FV{\e}$:
\begin{quote}
$
\begin{array}{l}
\FV{\x}=\{\x\}\\
\FV{\FieldAccess{\e}{\f}}=\FV{\e}\\
\FV{\MethCall{\e_0}{\m}{\e_1,\ldots,\e_n}}=\FV{\e_0}\cup\ldots\cup\FV{\e_n}\\
\FV{\FieldAssign{\e}{\f}{\e'}}=\FV{\e}\cup\FV{\e'}\\
\FV{\ConstrCall{\C}{\e_1,\ldots,\e_n}}=\FV{\e_1}\cup\ldots\cup\FV{\e_n}\\
\FV{\Block\decs{\e}}=\FV{\decs}\cup(\FV{\e}\setminus\dom\decs)\\
\FV{\Dec{\T_1}{\x_1}{\e_1}\ldots\Dec{\T_n}{\x_n}{\e_n}}=
(\FV{\e_1}\cup\ldots\cup\FV{\e_n})\setminus\{\x_1,\ldots,\x_n\}
\end{array}
$
\end{quote}


\noindent
$\Subst{\e}{\val}{\x}$:
\begin{quote}
$
\begin{array}{l}
\Subst{\x}{\val}{\x}=\e\\
\Subst{\z}{\val}{\x}=\z\ \mbox{if}\ \z\neq\x\\
\Subst{\FieldAccess{\e}{\f}}{\val}{\x}=
\FieldAccess{\Subst{\e}{\val}{\x}}{\f}
\\
\Subst{\MethCall{\e_0}{\m}{\e_1,\ldots,\e_n}}{\val}{\x}=
\MethCall{\Subst{\e_0}{\val}{\x}}{\m}{\Subst{\e_1}{\val}{\x},\ldots,\Subst{\e_n}{\val}{\x}}
\\
\Subst{(\FieldAssign{\e}{\f}{\e'})}{\val}{\x}=
\FieldAssign{\Subst{\e}{\val}{\x}}{\f}{\Subst{\e'}{\val}{\x}}
\\
\Subst{\ConstrCall{\C}{\e_1,\ldots,\e_n}}{\val}{\x}=
\ConstrCall{\C}{\Subst{\e_1}{\val}{\x},\ldots,\Subst{\e_n}{\val}{\x}}\\
\Subst{\Block{\decs}{\e}}{\val}{\x}=
\Block{\Subst{\decs}{\val}{\x}}{\Subst\e{\val}{\x}}
\mbox{ if }\x\notin\dom\decs
\\
\Subst{\Block\decs{\e}}{\val}{\x}=
\Block\decs{\e}
\mbox{ if }\x\in\dom\decs\\
{\Subst{(\Dec{{\T}_1}{\x_1}{\e_1}\ldots\Dec{{\T}_n}{\x_n}{\e_n})}{\val}{\x}=
\Dec{{\T}_1}{\x_1}{\Subst{\e_1}{\val}{\x}}\ldots\Dec{{\T}_n}{\x_n}{\Subst{\e_n}{\val}{\x}}}
\end{array}
$
\end{quote}
\end{small}

\section{Proofs omitted from \refToSection{results}}\label{app:proofs}
%In this section we give {the} proofs of the lemmas of \refToSection{results}. 
%
%\subsection{Proofs for the Canonical Form Theorem}
\label{sect:proof-cf}

\noindent
{\bf Proof of \refToLemma{nonStructural}}.
%\begin{proof}
By induction on type derivations.\\
If the last rule in $\deriv$ is a structural rule, then   $\deriv'=\deriv$.\\
If the last rule in $\deriv$ is \rn{T-sub}, by induction hypothesis on 
the sub-derivation of the premise of \rn{T-sub} and transitivity of $\leq$ we derive the result.\\
Let $\deriv$ end with an application of \rn{T-Capsule} of \rn{T-Imm}, then
\begin{center}
$
\deriv_p:\AuxTypeCheck{{\Gamma}}{\LentLocked\ (\domMut{\Gamma}{\setminus}\LentLocked)}{\emptyset}{\StronglyLocked''}{\e}{\Type{\mu'}{\C}}
$
\end{center}
where $\StronglyLocked''=\StronglyLocked$ or $\StronglyLocked''=\domGeqMut(\Gamma)$, is the sub-derivation of the premise of the last rule. Note that the mutable group is always empty. By induction hypothesis on 
$\deriv_p$, there is a sub-derivation of $\deriv'$ of $\deriv_p$
such that $\deriv':\AuxTypeCheck{{\Gamma}}{\LentLocked'}{\MutGroup'}{\StronglyLocked'}{\e}{\Type{\mu''}{\C}}$ ends with the application of a structural rule, and 
$\LentLocked\ (\domMut{\Gamma}{\setminus}\LentLocked)=\LentLocked'\ \MutGroup'$. This proves the result. \\
If the last rule applied is \rn{T-Unrst} 
$\AuxTypeCheck{{\Gamma}}{\LentLocked}{\MutGroup}{\emptyset}{\e}{\Type{\mu}{\C}}$, by induction hypothesis on 
the sub-derivation of the premise of the rule, we derive the result. \\
If the last rule applied is \rn{T-Swap},  let $\LentLocked=\LentLocked_1\ \xs_1$ 
\begin{center}
$\deriv_p:\AuxTypeCheck{\Gamma}{\LentLocked_1\ \xs}{\MutGroup_1}{\StronglyLocked}{\e}{\Type{\mu'}{\C}}$
\end{center}
By induction hypothesis on $\deriv_p$ there is a sub-derivation $\deriv'$
such that $\deriv':\AuxTypeCheck{{\Gamma}}{\LentLocked'}{\MutGroup'}{\StronglyLocked'}{\e}{\Type{\mu''}{\C}}$ ends with the application of a structural rule,  
 $\LentLocked_1\ \xs\ \xs_1=\LentLocked'\ \xs'$, and either $\mu'=\capsule$ or $\mu'=\imm$ or $\mu''\leq\mu'$. Since $\LentLocked=\LentLocked_1\ \xs_1$
 we have that $\LentLocked\ \xs=\LentLocked'\ \xs'$, moreover, since $\mu'\leq\mu$ by transitivity of 
 $\leq$ we have the result. \qed
%\end{proof}

\medskip
\noindent
{\bf Proof of \refToLemma{typeVars}}. 
By induction on the derivation $\TypeCheck{\Gamma}{\LentLocked}{\StronglyLocked}{{\x}}{\T}$.
Consider the last rule applied in the derivation.\\
If the last rule is \rn{T-var}, then either $\T=\Gamma(x)$ or $\T=\Type{\lent}{\C}$ if $\Gamma(x)=\Type{\mutable}{\C}$ and $\x\in\LentLocked$. 
Therefore, in both cases $\Gamma(x)\leq\T$.
Otherwise the last rule applied must be a non-structural rule.\\
If the last rule applied is \rn{T-sub}, the result follows by induction hypothesis, and
transitivity of $\leq$.\\
If the last rule applied is \rn{T-swap}, then $\TypeCheck{\Gamma}{\LentLocked'}{\StronglyLocked}{{\x}}{\T'}$, where 
$\T'\leq\T$. Therefore, again by induction induction hypothesis, and
transitivity of $\leq$ we get the result.\\
If the last rule applied is \rn{T-unrst} the result follows by induction hypothesis.\\
If the last rule applied is \rn{T-Capsule}, then
$\TypeCheck{\Gamma}{\LentLocked\ \xs}{\StronglyLocked}{{\x}}{\Type{\mutable}{\C}}$
where $\xs=\domMut{\Gamma}{\setminus}\LentLocked$, and $\T=\Type{\capsule}{\C}$.
By induction hypothesis, $\Gamma(x)\leq\Type{\mutable}{\C}$. So, either 
$\Gamma(x)=\Type{\capsule}{\C}$ or $\Gamma(x)=\Type{\mutable}{\C}$. In the first case
$\Gamma(x)=\T$. The second case is not possible, since $\x\in\LentLocked\ \xs$, and therefore 
$\TypeCheck{\Gamma}{\LentLocked\ \xs}{\StronglyLocked}{{\x}}{\Type{\lent}{\C}}$,
so rule \rn{T-Capsule} cannot be applied. \\
Finally, if the last rule applied is \rn{T-Imm}, it must be that
$\TypeCheck{\Gamma}{\LentLocked\ \xs}{\domGeqMut(\Gamma) }{\x}{\Type{{\readable}}{\C}}$.
So, $\x\not\in\domGeqMut(\Gamma)$, and therefore $\Gamma(x)=\Type{\capsule}{\C}$ or 
$\Gamma(x)=\Type{\imm}{\C}$. In both cases $\Gamma(x)\leq\T=\Type{\imm}{\C}$.\\
Let $\TypeCheck{\Gamma}{\LentLocked}{\StronglyLocked}{{\x}}{\Type{\mu}{\C}}$ with
$\mu\leq\imm$. We have that $\Gamma(x)\leq\Type{\mu}{\C}$. Therefore, if
$\LentLocked'$ and $\StronglyLocked'$ are such that  $\WellFormedTypeCtx{\Gamma};{\LentLocked'};\StronglyLocked'$,
then $\x\not\in\LentLocked'$ and $\x\not\in\StronglyLocked'$. So 
$\TypeCheck{\Gamma}{\LentLocked'}{\StronglyLocked'}{{\x}}{\Type{\mu}{\C}}$.\qed

\medskip
\noindent
{\bf Proof of \refToLemma{inversionBlock}}. 
Let $\deriv:\AuxTypeCheck{{\Gamma}}{\LentLocked}{\MutGroup}{\StronglyLocked}{\Block{\decs}{\val}}{\Type{\mu}{\C}}$.
From \refToLemma{nonStructural} there is a sub-derivation $\deriv':\AuxTypeCheck{{\Gamma}}{\LentLocked''}{\MutGroup''}{\StronglyLocked''}{\Block{\decs}{\val}}{\Type{\mu'}{\C}}$ of $\deriv$ which ends with an application of rule \rn{T-Block}
such that  
\begin{enumerate}[(a)]
\item $\LentLocked\ \xs=\LentLocked''\ \xs''$ and
\item $\mu\not=\imm$ and $\mu\not=\capsule$ implies $\mu'\leq\mu$.
\end{enumerate}
 From rule \rn{T-block} and \refToLemma{typeStruct}.1 we have that
\begin{enumerate}[(a)]\addtocounter{enumi}{2}
\item $\DecsOK{\SubstFun{\Gamma}{\TypeEnv{\decs}}}{\LentLocked'}{\StronglyLocked'}{\decs}$ and
 $\TypeCheck{{\SubstFun{\Gamma}{\TypeEnv{\decs}}}}{{\LentLocked'}}{\StronglyLocked'}{\val}{\Type{\mu'}{\C}}$
where
  \item $\LessEq{(\ \LentLocked''\ \xs''\ ){\setminus}\dom{\TypeEnv{\decs}}}{\LentLocked'\ \xs'}$.
\end{enumerate}
From (a) and (d) we derive that $\LessEq{(\ \LentLocked\ \xs\ ){\setminus}\dom{\TypeEnv{\decs}}}{\LentLocked'\ \xs'}$ which, with (b) and (c), proves the result.\qed


\medskip
\noindent
{\bf Proof of \refToLemma{constrMut}}.
\begin{enumerate}
\item
From \refToLemma{typeStruct} we have that $\AuxTypeCheck{\Gamma}{\LentLocked}{\MutGroup}{\StronglyLocked}{\ConstrCall{\C}{\z_1,\ldots,\z_n}}{\Type{\mutable}{\C}}$ is derived applying rule \rn{T-New}. Therefore  $\AuxTypeCheck{\Gamma}{\LentLocked}{\MutGroup}{\StronglyLocked}{\z_i}{\Type{\mu_i}{\C_i}}$ $\Range{i}{1}{n}$.
If $\T_i=\mutable$, then $\z_i\not\in\LentLocked$ and therefore $\z_i\in\xs$. If $\T_i=\imm$, from 
\refToLemma{typeVars}, we have $\AuxTypeCheck{\Gamma}{\LentLocked}{\MutGroup}{\StronglyLocked}{\z_i}{\Type{\mu}{\C}}$ with $\mu\leq\imm$.
\item 
Let  $\deriv:\AuxTypeCheck{\Gamma}{\LentLocked}{\emptyset}{\domGeqMut(\Gamma) }{\ConstrCall{\C}{\z_1,\ldots,\z_n}}{\Type{\readable}{\C}}$. There is a sub-derivation $\deriv'$ of $\deriv$ ending with
an application of \rn{T-New}, which can be either the premise of rule \rn{T-Sub} or of rule \rn{T-Swap}.\\
In the first case, $\AuxTypeCheck{\Gamma}{\LentLocked}{\emptyset}{\domGeqMut(\Gamma) }{{\ConstrCall{\C}{\xs}}}{\Type{\mutable}{\C}}$. 
Therefore, from clause 1. of this lemma, since the current mutable group is empty, we have that
for all $i\in1..n$, $\TypeCheck{\Gamma}{\LentLocked}{\StronglyLocked}{\z_i}{\Type{\imm}{\C_i}}$.\\
In the second case,
$\AuxTypeCheck{\Gamma}{\LentLocked'}{\MutGroup'}{\domGeqMut(\Gamma) }{{\ConstrCall{\C}{\z_1,\ldots,\z_n}}}{\Type{\mutable}{\C}}$ for some 
$\LentLocked'\ \xs'=\LentLocked$.  Assume that, for some $i$, $1\leq i\leq n$,  $\T_i=\Type{\mu_i}{\C_i}$ with
$\mu_i\geq\mutable$, and therefore, $\z_i\in\domGeqMut(\Gamma)$. 
Rule \rn{T-Var} is not be applicable to derive a type for $\z_i$. (Rule \rn{T-UnRst} is not applicable to unlock
variables, since the variable has type $\Type{\mu_i}{\C_i}$ with $\mu_i\geq\mutable$.)
Therefore, for all $i\in1..n$, we have that
$\Gamma(\z_i)=\Type{\mu}{\C_i}$ with $\mu\leq\imm$. 
\end{enumerate}
\qed



\medskip
\noindent
{\bf Proof of \refToLemma{blockMut}}. Let  $\AuxTypeCheck{\Gamma}{\LentLocked}{\MutGroup}{\StronglyLocked}{\Block{\dvs}{\cOrx}}{\Type{\mutable}{\C}}$ where $\cOrx=\x$ or $\cOrx=\ConstrCall{\C}{\_}$. From \refToLemma{inversionBlock}
\begin{enumerate}[(a)]
\item  $\AuxTypeCheck{{\SubstFun{\Gamma}{\TypeEnv{\dvs}}}}{{\LentLocked'}}{\MutGroup'}{\StronglyLocked'}{\cOrx}{\Type{\mu'}{\C}}$ 
\item $\AuxDecsOK{\SubstFun{\Gamma}{\TypeEnv{\dvs}}}{\LentLocked'}{\MutGroup'}{\StronglyLocked'}{\Dec{\Type{\mu_i}{\C_i}}{\z_i}{\stVal_i}}$  $\Range{i}{1}{n}$
\item $\LessEq{(\LentLocked\ \xs){\setminus}\dom{\TypeEnv{\dvs}}}{\LentLocked'\ \xs'}$ and
\item $\mu'\leq\mutable$.
\end{enumerate}
We may assume that $\mu'=\mutable$, since $\mu'=\capsule$ would imply that (a) was obtained by a \rn{T-Capsule} rule and so $\TypeCheck{{\SubstFun{\Gamma}{\TypeEnv{\dvs}}}}{{\LentLocked'\ xs'}}{\StronglyLocked'}{\cOrx}{\Type{\mutable}{\C}}$.\\
From the definition of well-formed right-values of 
\refToFigure{wellformed} we have that $\dvs=\Reduct{\dvs}{\FV{\cOrx}}$, that is $\Range{j}{1}{n}$ we have that $\connected{\dvs}{\FV{\cOrx}}{\z_j}$.\\
We want to prove that $\Range{j}{1}{n}$, if $\connected{\dvs}{\FV{\cOrx}}{\z_j}$ and 
$\SubstFun{\Gamma}{\TypeEnv{\dvs}}(z_j)=\Type{\mutable}{\C_j}$, then 
\begin{itemize}
\item $\z_j\in\xs'$, and
\item if $\z\in\FV{\stVal_j}$ and $\Gamma[\TypeEnv{\dvs}](z)=\Type{\mutable}{\D}$, then $\z\in\xs'$, otherwise 
 $\Gamma[\TypeEnv{\dvs}](z)=\Type{\mu}{\D}$ with $\mu\leq\imm$.
\end{itemize}
By definition of connected, either $\z_j\in\FV{\cOrx}$ or 
 $\z_j\in\FV{\stVal_i}$ and $\connected{\dvs}{\FV{\cOrx}}{\z_i}$.\\
If \underline{$\z_j\in\FV{\cOrx}$ and $\cOrx=\ConstrCall{\C}{\_}$} by (a), (d) and \refToLemma{constrMut}.1 we have that either $\z_j\in\xs'$
or $\Gamma[\TypeEnv{\dvs}](z_j)=\Type{\mu}{\D}$ with $\mu\leq\imm$. \\
If \underline{$\z_j\in\FV{\cOrx}$ and $\cOrx=\z_j$} then, from (a) and (d) we get $\z_j\in\xs'$ ($\z_j\in\LentLocked'$ would
imply $\AuxTypeCheck{{\SubstFun{\Gamma}{\TypeEnv{\dvs}}}}{{\LentLocked'}}{\MutGroup'}{\StronglyLocked'}{\cOrx}{\Type{\lent}{\C}}$ ). \\
If \underline{$\z_j\in\FV{\stVal_i}$ and $\connected{\dvs}{\FV{\cOrx}}{\z_i}$}, by inductive hypothesis
on the connection relation, we have that 
\begin{enumerate}[(1)]
\item $\z_i\in\xs'$, and
\item if $\z\in\FV{\stVal_i}$ and $\Gamma[\TypeEnv{\dvs}](z)=\Type{\mutable}{\D}$, then $\z\in\xs'$, otherwise 
 $\Gamma[\TypeEnv{\dvs}](z)=\Type{\mu}{\D}$ with $\mu\leq\imm$.
\end{enumerate}
From (b) and Definition \ref{def:wellTypedDefsNew} we derive that
$\AuxTypeCheck{\Gamma[\TypeEnv{\dvs}]}{\LentLocked}{\xs'}{\StronglyLocked}{\stVal_i}{\Type{\mutable}{\C_i}}$.
If  $\z_j$ is such that $\SubstFun{\Gamma}{\TypeEnv{\dvs}}(z_j)=\Type{\mutable}{\C_j}$, from (2), $\z_j\in\xs'$.
Again, from (b) and Definition \ref{def:wellTypedDefsNew} we derive that
$\AuxTypeCheck{\Gamma[\TypeEnv{\dvs}]}{\LentLocked}{\xs'}{\StronglyLocked}{\stVal_j}{\Type{\mutable}{\C_j}}$.
Let $\z\in\FV{\stVal_j}$. If $\stVal_j=\ConstrCall{\D}{\_}$
then from \refToLemma{constrMut}.1 we derive the result. 
If $\stVal_j=\Block{\dvs'}{\cOrx'}$, then by inductive
hypothesis on $\Block{\dvs'}{\cOrx'}$ we have that either $\z\in\xs'$ or $\Gamma[\TypeEnv{\dvs}](z)=\Type{\mu}{\D}$ with $\mu\leq\imm$.
\qed


%\subsection{Proofs for the soundness theorems}
\label{sect:proof-sound}

\noindent
{\bf Proof of \refToLemma{subCtx}}. By induction on $\genCtx$. 
%\begin{enumerate}
For $\genCtx=\emptyctx$ clause 1 derives from \refToLemma{nonStructural}, and clause 2 is obvious. \\
%\item
If $\genCtx=\Block{\decs'\ \Dec{\T}{\x}{\genCtxP}\ \decs''}{\val}$, then $\TypeCheck{\Gamma}{\LentLocked}{\StronglyLocked}{\Block{\decs'\ \Dec{\T_x}{\x}{\GenCtxP{\e}}\ \decs''}{\val}}{\T}$. Let $\decs$ be $\decs'\ \Dec{\T_x}{\x}{\GenCtxP{\e}}\ \decs''$.  From \refToLemma{inversionBlock}, we have that $\DecsOK{\SubstFun{\Gamma}{\TypeEnv{\decs}}}{\LentLocked'} {\StronglyLocked'}{\decs}$ where
\begin{enumerate}[(a)]
  \item $\LessEq{(\ \LentLocked\ \xs\ ){\setminus}\dom{\TypeEnv{\decs}}}{\LentLocked'\ \xs'}$.
\end{enumerate}
From $\DecsOK{\SubstFun{\Gamma}{\TypeEnv{\decs}}}{\LentLocked'}{\StronglyLocked'}{\decs}$ we get 
$\DecsOK{\SubstFun{\Gamma}{\TypeEnv{\decs}}}{\LentLocked'}{\StronglyLocked'}{\Dec{\Dec{\Type{\mu_x}{\C_x}}{\x}{\GenCtxP{\e}}}{\x}{\GenCtxP{\e}}}$.\\
We have two cases: either $\mu_x\not=\lent$ and
\begin{itemize}
\item $\deriv_x:\AuxTypeCheck{\SubstFun{\Gamma}{\TypeEnv{\decs}}}{\LentLocked'}{\MutGroup'}{\StronglyLocked'}{{\GenCtxP{\e}}}{\SubstFun{\Gamma}{\TypeEnv{\decs}}(x)}$
\end{itemize}
 or $\mu_x\not=\lent$ and
\begin{itemize}
\item $\deriv'_x:\AuxTypeCheck{\SubstFun{\Gamma}{\TypeEnv{\decs}}}{\LentLocked''}{\MutGroup''}{\StronglyLocked'}{{\GenCtxP{\e}}}{\SubstFun{\Gamma}{\TypeEnv{\decs}}(x)}$ with $\x\in\xs''$ and 
\item $\LentLocked'\ \xs'=\LentLocked''\ \xs''$.
\end{itemize}
In both cases, applying the inductive hypothesis to $\genCtxP$ we derive that 
$\deriv':\TypeCheck{\SubstFun{\SubstFun{\Gamma}{\TypeEnv{\decs}}}{\TypeEnv{\ctx}}}{\LentLocked'''}{\StronglyLocked'''}{{\e}}{\T''}$ for some
$\LentLocked'''$, $\StronglyLocked'''$ and $\T''$ such that 
\begin{enumerate} [(A)]
  \item $\LessEq{(\LentLocked'\ \xs'=\LentLocked''\ \xs''){\setminus}\dom{\TypeEnv{\genCtxP}}}{\LentLocked'''\ \xs'''}$, and
  \item the last rule applied in $\deriv'$ is a structural rule.
\end{enumerate}
Since $\TypeEnv{\genCtx}=\SubstFun{\TypeEnv{\decs}}{\TypeEnv{\genCtxP}}$, from (a), (A) and transitivity of $\Extends{}{}{}$ we derive 
\begin{center}
$\LessEq{(\LentLocked\ \xs){\setminus}\dom{\TypeEnv{\genCtx}}}{\LentLocked'''\ \xs'''}$.
\end{center}
This proves clause 1.\\
Let $\e'$ is such that 
$\deriv'':\TypeCheck{\SubstFun{\SubstFun{\Gamma}{\TypeEnv{\decs}}}{\TypeEnv{\ctx}}}{\LentLocked''}{\StronglyLocked''}{{\e'}}{\T''}$. By induction hypothesis on $\genCtxP$, substituting $\deriv'$ with $\deriv''$ in $\deriv_x$ (or $\deriv'_x$) we obtain $\DecsOK{\SubstFun{\Gamma}{\TypeEnv{\decs}}}{\LentLocked'}{\StronglyLocked'}{\Dec{\Dec{\Type{\mu_x}{\C_x}}{\x}{\GenCtxP{\e}}}{\x}{\GenCtxP{\e}}}$. Applying rule \rn{T-block} we get  a derivation for
$\TypeCheck{\Gamma}{\LentLocked}{\StronglyLocked}{\Block{\decs'\ \Dec{\T_x}{\x}{\GenCtxP{\e'}}\ \decs''}{\val}}{\T}$,
which proves clause 2.\\
%\end{enumerate}
The proofs for the other general contexts similar and easier.
%\PGComm{Maybe a hint to the other cases, in particular when $\dom{\TypeEnv{\genCtx}}=\emptyset$!}
 \qed

\medskip
\noindent
{\bf Proof of \refToLemma{fieldAccess}}.  
\begin{enumerate}
  \item From \refToLemma{subCtx}.1, taking $\genCtx=\FieldAccess{\emptyctx}{\f_i}$, we have that 
  \begin{enumerate} [(a)]
\item  $\AuxTypeCheck{\Gamma}{\LentLocked'}{\MutGroup'}{\StronglyLocked'}{{\ConstrCall{\C}{\xs}}}{\Type{\mutable}{\C}}$ (ending with with an application of \rn{T-New}) and
\item 
 $\LentLocked\ \xs=\LentLocked'\ \xs'$.
\end{enumerate}
From (a) we get $\TypeCheck{{\TypeEnv{\ctx}}}{\LentLocked'}{\StronglyLocked'}{\x_i}{\Type{\mu_i}{\C_i}}$.\\
If $\mu_i=\imm$, then from \refToLemma{typeVars} we have that $\TypeCheck{\Gamma}{\LentLocked}{\StronglyLocked}{\x_i}{\Type{\mu_i}{\C_i}}$. From rule \rn{T-Field-Access} derive that $\mu=\mu_i$. Therefore, from (b) we get $\TypeCheck{\Gamma}{\LentLocked}{\StronglyLocked}{\x_i}{\Type{\mu}{\C_i}}$.\\
Let $\mu_i=\mutable$. If $\x_i\in\xs$, from (a) we derive  $\x_i\in\xs'$. Therefore, from (b)
$\LentLocked=\LentLocked'$. Since $\mu\geq\mutable$ (with an application of
\rn{T-Sub} if needed) we derive  $\TypeCheck{{\TypeEnv{\ctx}}}{\LentLocked}{\StronglyLocked}{\x_i}{\Type{\mu}{\C_i}}$.
If $\x_i\in\LentLocked$, then before rule \rn{T-New} we have to apply \rn{T-Swap}  (to exchange the group containing $\x_i$ with $\xs$). Since rule \rn{T-New} produces a type with $\mutable$ modifier, applying rule \rn{T-Swap} 
we get a $\lent$ modifier. Therefore from (b) also $\mu=\lent$ and
$\TypeCheck{\Gamma}{\LentLocked}{\StronglyLocked}{\x_i}{\Type{\mu}{\C_i}}$. 
 
 \item If $\stVal=\ConstrCall{\C}{\xs}$, the result follows from clause 1 of this lemma. \\
 Let $\stVal=\Block{\dvs}{\cOrx}$ where 
$\dvs=\Dec{\T_1}{\z_1}{\stVal_1}\cdots\Dec{\T_n}{\z_n}{\stVal_n}$, and  
$\cOrx=\ConstrCall{\C}{\xs}$ or $\cOrx=x$ and $\T_i=\Type{\mu_i}{\C_i}$.
If $\AuxTypeCheck{\Gamma}{\LentLocked}{\MutGroup}{\StronglyLocked}{\FieldAccess{\stVal}{\f_i}}{\Type{\mu'}{C_i}}$,
from rule \rn{T-Field-Access}, we have that 
  \begin{enumerate} [(a)]
\item  $\AuxTypeCheck{\Gamma}{\LentLocked'}{\MutGroup'}{\StronglyLocked'}{\Block{\dvs}{\cOrx}}{\Type{\mu}{\C}}$, and
\item if $\mu_i\neq\mutable$ then $\mu'=\mu_i$, otherwise $\mu'=\mu$
\end{enumerate}
From \refToLemma{inversionBlock} we have
  \begin{enumerate} [(a)]\addtocounter{enumii}{2}
\item  $\AuxDecsOK{\SubstFun{\Gamma}{\TypeEnv{\decs}}}{\LentLocked'}{\MutGroup'}{\StronglyLocked'}{\dvs}$
\item  $\AuxTypeCheck{{\SubstFun{\Gamma}{\TypeEnv{\dvs}}}}{{\LentLocked'}}{\MutGroup'}{\StronglyLocked'}{\cOrx}
{\Type{\mu''}{\C}}$ 
\item $\LessEq{(\LentLocked\ \xs){\setminus}\dom{\TypeEnv{\decs}}}{\LentLocked'\ \xs'}$ and
\item $\mu\not=\imm$ and $\mu\not=\capsule$ implies $\mu''\leq\mu$. 
\end{enumerate}
If $\cOrx=\ConstrCall{\C}{\xs}$, then  $\fieldOf{\stVal}{i}=\Block{\dvs}{\x_i}$.
From (b), (c) and rule \rn{T-Block}
 \begin{enumerate} [(a)]\addtocounter{enumii}{6}
\item  $\AuxTypeCheck{\Gamma}{\LentLocked'}{\MutGroup'}{\StronglyLocked'}{\Block{\dvs}{\x_i}}{\Type{\mu_i}{\C_i}}$ 
\end{enumerate}
%By cases on $\mu_i$.\\
If \underline{$\mu_i\neq\mutable$}, from (b) the result holds.\\
If \underline{$\mu_i=\mutable$}, and $\mu\leq\imm$, then (a) is obtained by either rule \rn{T-Capsule} or \rn{T-imm}. 
The same recovery rule can be applied to (g). If $\mu\geq\mutable$, result is obtained by (g) applying rule \rn{T-sub},
if needed.\\
If $\cOrx=\x$, then  $\fieldOf{\stVal}{i}=\Block{\dvs}{\val}$ if $\dvs(\x)=\Dec{\_}{\x}{\stVal'}$ and $\fieldOf{\stVal'}{i}=\val$.
In this case the result follow by induction on $\stVal'$.
\item By case analysis on the result of $\fieldOf{\stVal}{i}$, using the proof of the previous case we can see that, typing depends only on $\Gamma$ and therefore the result holds.
\end{enumerate}
\qed

\medskip
\noindent
{\bf Proof of \refToLemma{fieldAssign}}.
From rule  \rn{T-Field-Assign}, we have that
$\AuxTypeCheck{{\Gamma}}{\LentLocked}{\MutGroup}{\StronglyLocked}{\x}{\mutable\,\C}$ for some $\C$
and $\AuxTypeCheck{{\Gamma}}{\LentLocked}{\MutGroup}{\StronglyLocked}{\valPrime}{\Type{\mu}{\_}}$ where $\mu=\mutable$ or $\mu=\imm$. Therefore, from \refToLemma{typeVars} we have that $\Gamma(\x)\leq\Type{\mutable}{\C}$, and 
$\x\in\xs$.
Since $\mu=\mutable$ or $\mu=\imm$, from Canonical Form Theorem.2 and 3 we have that for all  $\y\in\FV{\valPrime}$, $\y\in\xs$ or $\TypeCheck{{\Gamma}}{\LentLocked}{\StronglyLocked}{\y}{\Type{\mu}{\_}}$ with $\mu\leq\imm$.
\qed

\medskip
\noindent
{\bf Proof of  \refToTheorem{subjectReductionShort}} (rules \rn{field-assign}, and \rn{mut-move})\\
Consider \underline{rule \rn{field-assign}}.
Let   $\decs'=\dvs\ \Dec{\Type{\mu_x}{\C}}{\x}{\ConstrCall{\C}{\xs}}\ \Dec{\T_z}{\z}{\ctx_z[{\FieldAssign{\x}{\f}{{\valPrime}}}]}\ \decs$, 
\begin{enumerate} [(1)]
\item $\e=\Ctx{\Block{\dvs\ \Dec{\Type{\mu_x}{\C}}{\x}{\ConstrCall{\C}{\xs}}\ \Dec{\T_z}{\z}{\ctx_z[{\FieldAssign{\x}{\f}{{\valPrime}}}]}\ \decs}{\val}}$, and 
\item $\e'=\Ctx{\Block{\dvs\ \Dec{\Type{\mu_x}{\C}}{\x}{\ConstrCall{\C}{\xs'}}\ \Dec{\T_z}{\z}{\ctx_z[\valPrime]}\ \decs}{\val}}$, 
\end{enumerate}
where $\fields{\C}=\Field{\T_1}{\f_1}\ldots\Field{\T_n}{\f_n}$ with $\f=\f_i$ and
\begin{enumerate}[(1)]\addtocounter{enumi}{2}
\item ${\mu\geq\mutable}$,  
\item ${\noCapture{\x}{\HB{\ctx_z}},\noCapture{\valPrime}{\HB{\ctx_z}}}$ and
\item $\xs'$ is obtained by $\xs$ replacing $\x_i$ with $\valPrime$.
\end{enumerate}
Let $\Gamma'=\TypeEnv{\ctx}[\TypeEnv{\decs'}]$, from (1) and Lemma \ref{lemma:subCtx}.1 for some
$\T'$, $\LentLocked$ and $\StronglyLocked$
\begin{enumerate} [(a)]
\item $\AuxTypeCheck{\Gamma'[\TypeEnv{\ctx_z}]}{\LentLocked}{\MutGroup}{\StronglyLocked}{\FieldAssign{\x}{\f}{{\valPrime}}}{\T'}$ and
  \item the last rule applied in the derivation is \rn{T-Field-assign}.  
 \end{enumerate}
From (1), \refToLemma{subCtx}.1 and \refToLemma{inversionBlock}, for some $\LentLocked'$ and $\StronglyLocked'$
\begin{enumerate} [(a)]\addtocounter{enumi}{2}
\item $\AuxDecsOK{\Gamma'}{\LentLocked'}{\MutGroup'}{\StronglyLocked'}{\Dec{\Type{\mu_x}{\C}}{\x}{\ConstrCall{\C}{\xs}}}$, i.e., 
\begin{enumerate}[i.]
\item $\AuxTypeCheck{\Gamma'}{\LentLocked'}{\MutGroup'}{\StronglyLocked'}{\ConstrCall{\C}{\xs}}{\Gamma'(\x)}$ if $\mu_x\not=\lent$
\item $\AuxTypeCheck{\Gamma'}{\LentLocked_x}{\MutGroup_x}{\StronglyLocked'}{\ConstrCall{\C}{\xs}}{\Gamma'(\x)}$ if $\mu_x=\lent$ and $\LentLocked'\ \xs'=\LentLocked_x\ \xs_x$ where $\x\in\xs_x$
\end{enumerate}
\item 
 $\LessEq{(\LentLocked'\ \xs'){\setminus}\dom{\TypeEnv{\ctx_z}}}{\LentLocked\ \xs}$.
\end{enumerate}
From (a) and rule \rn{T-Field-filed -Assign} we get $\T'=\T_i$
\begin{enumerate} [(a)]\addtocounter{enumi}{4}
\item $\AuxTypeCheck{\Gamma'[\TypeEnv{\ctx_z}]}{\LentLocked}{\MutGroup}{\StronglyLocked}{{{\valPrime}}}{\T'}$
\item $\x\in\xs$, and
\item  from \refToLemma{fieldAssign},  and (4): for all
$\y\in\FV{\valPrime}$ such that $\TypeCheck{\Gamma'[\TypeEnv{\ctx_z}]}{\LentLocked}{\StronglyLocked}{\y}{\Type{\mu}{\_}}$ with $\mu\geq\mutable$ we have that $\y\in\xs$
\end{enumerate}
From (c).i and (c).ii and rule \rn{T-New}, we have that $\AuxTypeCheck{\Gamma'}{\LentLocked'}{\MutGroup'}{\StronglyLocked'}{\x_i}{\T'}$ (if $\mu_x\not=\lent$) or  $\AuxTypeCheck{\Gamma'}{\LentLocked_x}{\MutGroup_x}{\StronglyLocked'}{\x_i}{\T'}$ (otherwise). 
Note that, in both cases $\x$ is in the current mutable group. Therefore, from (d), (g),
(e), (4), and \refToLemma{weakening} we have that
$\AuxTypeCheck{\Gamma'}{\LentLocked'}{\MutGroup'}{\StronglyLocked'}{\valPrime}{\T'}$ (if $\mu_x\not=\lent$) or  $\AuxTypeCheck{\Gamma'}{\LentLocked_x}{\MutGroup_x}{\StronglyLocked'}{\valPrime}{\T'}$ (otherwise).
From rule \rn{T-New}, (5) and \refToLemma{subCtx}.2 
\begin{enumerate} [(a)]\addtocounter{enumi}{7}
\item $\AuxDecsOK{\Gamma'}{\LentLocked'}{\MutGroup'}{\StronglyLocked'}{\Dec{\Type{\mu_x}{\C}}{\x}{\ConstrCall{\C}{\xs'}}}$, 
\end{enumerate}
Let $\decs''=\dvs\ \Dec{\Type{\mu_x}{\C}}{\x}{\ConstrCall{\C}{\xs'}}\ \Dec{\T_z}{\z}{\ctx_z[{\FieldAssign{\x}{\f}{{\valPrime}}}]}\ \decs$, $\ctxP=\ctx[\TypeEnv{\decs'}[\ctx_z]]$, and $\ctx''=\ctx[\TypeEnv{\decs''}[\ctx_z]]$. By definition of type context 
$\TypeEnv{\ctx''}=\TypeEnv{\ctx'}=\Gamma'[\TypeEnv{\ctx_z}]$. Therefore, from (h), (a), and (e) 
\begin{itemize}
\item $\AuxTypeCheck{\TypeEnv{\ctx''}}{\LentLocked}{\MutGroup}{\StronglyLocked}{\FieldAssign{\x}{\f}{{\valPrime}}}{\T'}$, and 
\item $\AuxTypeCheck{\TypeEnv{\ctx''}}{\LentLocked}{\MutGroup}{\StronglyLocked}{{{\valPrime}}}{\T'}$.
\end{itemize}
From \refToLemma{subCtx}.2 we get $\TypeCheckGround{\e'}{\T}$.


\medskip\noindent
Consider \underline{rule \rn{mut-move}}.
In this case  
\begin{enumerate}[(1)]
\item $\e=\Ctx{\Block{\dvs'\ \Dec{\Type{\mu_x}{\C}}{\x}{\Block{\dvs\ \dvs''}{\val}}\ \decs'}{\val'}}$, and 
\item $\e'=\Ctx{\Block{\dvs'\ \dvs\ \Dec{\Type{\mu_x}{\C}}{\x}{\Block{\dvs''}{\val}}\ \decs'}{\val'}}$, 
\end{enumerate}
where 
\begin{enumerate}[(1)]\addtocounter{enumi}{2}
\item $\mu_x \geq \mutable$,  
\item $\noCapture{\Block{\dvs'\ \decs'}{\val'}}{\dom{\dvs}}$ and 
\item $\noCapture{\dvs}{\dom{\dvs''}}$. 
\end{enumerate}
Let $\decs=\dvs'\ \Dec{\Type{\mu}{\C}}{\x}{\Block{\dvs\ \dvs''}{\val}}\ \decs'$. From $\IsWellTyped{{\e}:\T}$ and \refToLemma{subCtx} we get that, for some $\T_b$, $\LentLocked''$, $\xs''$, and $\StronglyLocked''$,
\begin{itemize}
  \item [$(\ast)$]$\AuxTypeCheck{\TypeEnv{\ctx}}{\LentLocked''}{\MutGroup''}{\StronglyLocked''}{\Block{\decs}{\val'}}{\T_b}$
\end{itemize}
Let $\Gamma=\TypeEnv{\dvs'},\TypeEnv{\decs'}\TypeDec{\Type{\mu}{\C}}{x}$. 
From $(\ast)$ and  \refToLemma{inversionBlock} for some $\T'$, $\mu'$, $\LentLocked'$, $\xs'$, and $\StronglyLocked'$
\begin{enumerate} [(A)]
\item $\AuxDecsOK{{\SubstFun{\TypeEnv{\ctx}}{\Gamma}}}{\LentLocked'}{\MutGroup'}{\StronglyLocked'}{\dvs'\ \decs'}$,
\item $\AuxDecsOK{{\SubstFun{\TypeEnv{\ctx}}{\Gamma}}}{\LentLocked'}{\MutGroup'}{\StronglyLocked'}{{\Block{\dvs\ \dvs''}{\val}}}$, i.e.
\begin{enumerate}[i.]
\item $\AuxTypeCheck{{\SubstFun{\TypeEnv{\ctx}}{\Gamma}}}{\LentLocked'}{\MutGroup'}{\StronglyLocked'}{{\Block{\dvs\ \dvs''}{\val}}}{{\SubstFun{\TypeEnv{\ctx}}{\Gamma}}(\x)}$ if $\mu_x\neq\lent$
\item $\AuxTypeCheck{{\SubstFun{\TypeEnv{\ctx}}{\Gamma}}}{\LentLocked_x}{\MutGroup_x}{\StronglyLocked'}{{\Block{\dvs\ \dvs''}{\val}}}{{\SubstFun{\TypeEnv{\ctx}}{\Gamma}}(\x)}$ if $\mu_x=\lent$ and $\LentLocked'\ \xs'=\LentLocked_x\ \xs_x$ where $\x\in\xs_x$
\end{enumerate}
\item $\AuxTypeCheck{\SubstFun{\TypeEnv{\ctx}}{\Gamma}}{\LentLocked'}{\MutGroup'}{\StronglyLocked'}{\val'}{\T'}$ 
\item $\LessEq{(\LentLocked''\ \xs''){\setminus}\dom{\Gamma}}{\LentLocked'\ \xs'}$
%\item  $\StronglyLocked''{\setminus}\dom{\Gamma}\subseteq\StronglyLocked'$.
\end{enumerate}
Let $\Gamma'=\TypeEnv{\dvs\,\dvs'}$. From (B), and \refToLemma{inversionBlock}, for some $\T''$, $\LentLocked$, and $\StronglyLocked$
we have that
\begin{enumerate} [(a)]
\item $\DecsOK{{\SubstFun{\TypeEnv{\ctx}}{\SubstFun{\Gamma}{\Gamma'}}}}{\LentLocked}{\StronglyLocked}{\dvs}$,
\item $\DecsOK{{\SubstFun{\TypeEnv{\ctx}}{\SubstFun{\Gamma}{\Gamma'}}}}{\LentLocked}{\StronglyLocked}{\dvs''}$, and
\item $\TypeCheck{{\SubstFun{\TypeEnv{\ctx}}{\SubstFun{\Gamma}{\Gamma'}}}}{\LentLocked}{\StronglyLocked}{\val}{\Type{\mu}{\C}}
$ with $\mu\leq\mu_x$
\end{enumerate}
From (4) and the fact that we can assume that $x\not\in\dom{\dvs}$, we derive
$\SubstFun{\Gamma}{\TypeEnv{\dvs\,\dvs''}}=\SubstFun{\Gamma,\TypeEnv{\dvs}}{\TypeEnv{\dvs''}}$.
Therefore, from (b), (c), and rule \rn{T-block}, followed by rule \rn{T-sub} (in case $\mu<\mu_x$) we derive
\begin{itemize}
\item [(C1)] $\TypeCheck{{\SubstFun{\TypeEnv{\ctx}}{\Gamma,\TypeEnv{\dvs}}}}{\LentLocked'}{\StronglyLocked'}{{\Block{\dvs''}{\val}}}{\Type{\mu_x}{\C}}
$
\end{itemize}
From (a), (5), and \refToLemma{weakening}, we have
\begin{itemize}
\item [(a1)] $\DecsOK{{\SubstFun{\TypeEnv{\ctx}}{{\Gamma,\TypeEnv{\dvs}}}}}{\LentLocked'}{\StronglyLocked'}{\dvs}$
\end{itemize}
From (4), {the fact that, for well-formedness of
declarations $x\not\in\dom{\dvs}$}, and \refToLemma{weakening}, we derive
\begin{itemize}
\item [(A1)] $\DecsOK{{\SubstFun{\TypeEnv{\ctx}}{\Gamma,\TypeEnv{\dvs}}}}{\LentLocked'}{\StronglyLocked'}{\dvs'}$,
\item [(B1)] $\DecsOK{{\SubstFun{\TypeEnv{\ctx}}{\Gamma,\TypeEnv{\dvs}}}}{\LentLocked'}{\StronglyLocked'}{\decs'}$, and
\item [(D1)] $\TypeCheck{\SubstFun{\TypeEnv{\ctx}}{\Gamma,\TypeEnv{\dvs}}}{\LentLocked'}{\StronglyLocked'}{\val'}{\T'}$
\end{itemize}
Therefore, from (A1), (B1), (C1), (D1), (a1), (E) and (F), applying rule \rn{T-lock}, we derive
\begin{center}
$\TypeCheck{{\TypeEnv{\ctx}}}{\LentLocked''}{\StronglyLocked''}{\Block{\dvs'\ \dvs\ \Dec{\Type{\mu}{\C}}{\x}{\Block{\decs}{\val}}\ \decs'}{\val'}}{\T_b}$.
\end{center}
From \refToLemma{subCtx}.2, we derive $\TypeCheckGround{\e'}{\T}$.
\qed

\medskip
\noindent
{\bf Proof of \refToLemma{decomposition}}.
By induction on $\e$. \\
If $\e=\x$ or $\e=\ConstrCall{\C}{{\xs}}$, then $\e$ is a well-formed value.\\
If $\e$ is  $\FieldAccess{{\val}}{\f}$, or $\MethCall{{\val}}{\m}{{\vals}}$,
or $\FieldAssign{{\val}}{\f}{\val}$, then with $\ctx=\emptyctx$ and $\preRedex=\e$
we have that $\e=\Ctx{\preRedex}$.\\
If $\e=\ConstrCall{\C}{{\vals}}$ and
$\exists\val\in\{\vals\}\ \notRef{\val}$, then applying congruence \rn{New} and \rn{Body} we get
$\congruence{\e}{\Block{\Dec{\T_1}{y_1}{\val_1}\cdots\Dec{\T_n}{y_n}{\val_n}}{\ConstrCall{\C}{{\xs}}}}$.
Therefore, either for all $i$, $1\leq i\leq n$, $\WFdv{\Dec{\T}{\y_i}{\val_i}}$, or there is
an $i$, $1\leq i\leq n$,  such that $\not\WFdv{\Dec{\T}{\y_i}{\val_i}}$. In the first case the lemma holds, and in the
second with $\ctx=\emptyctx$ and $\preRedex=\Block{\Dec{\T_1}{y_1}{\val_1}\cdots\Dec{\T_n}{y_n}{\val_n}}{\ConstrCall{\C}{{\xs}}}$
we have that $\e=\Ctx{\preRedex}$. \\
Let us now consider blocks.\\
If $\e=\Block{\dvs}{\val}$, since $\Block{\dvs}{\val}$ is a value,
from Proposition \ref{lemma:congruenceValue}, either $\congruence{\Block{\dvs}{\val}}{\x}$ or 
$\congruence{\Block{\dvs}{\val}}{\stVal}$ for some $\WFrv{\stVal}$. In the first case, 
and if $\stVal=\ConstrCall{\C}{{\xs}}$, then the lemma holds. 
In the second, let $\stVal=\Block{\dvs'}{\cOrx}$; either for all $\dv\in\dvs'$
we have that $\WFdv{\dv}$, or there is $\dv'\in\dvs'$ such that $\not\WFdv{\dv'}$, in which
case with $\ctx=\emptyctx$ and $\preRedex=\Block{\dvs'}{\cOrx}$ we have $\congruence{\e}{\Ctx{\preRedex}}$. \\
If $\e=\Block{\dvs\ \Dec{\T}{\x}{\e'}\ \decs}{\val}$ with $\WFdv{\dvs}$, we have that 
either $\e'=\val'$ and $\not\WFdv{\Dec{\T}{\x}{\val'}}$ or $\e'$ is not a value.\\
In the first case, define $\ctx=\emptyctx$ and $\preRedex=\e$, we derive that $\e=\Ctx{\preRedex}$.
In the second,
by induction hypothesis on $\e'$, we have that
$\e'=\CtxP{\preRedex}$ for some $\ctxP$ and $\rho$. Define $\ctx=\Block{\dvs\ \Dec{\T}{\x}{\ctxP}\ \decs}{\val}$.
We get that $\e=\Ctx{\rho}$.\qed











