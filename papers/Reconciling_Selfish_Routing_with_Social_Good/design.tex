\section{Balanced Network Flow Design}\label{sec:design}
In this section, we first give an overview of the challenges of coming up with (designing) a flow that balances %balancing
 the fairness and the social cost in the network. Drawing on results from previous sections, we highlight how the different solution concepts play important roles in balancing between the two objectives, minimizing social cost vs increasing fairness. We then present techniques to design edge flows with desired fairness level and low social cost. Finally, we show how introducing randomness can help in designing balanced network flows. 
 

\smallskip\noindent\textbf{Central planner in flow design.} The task of a central planner has two components: 1) design an edge flow or path flow and 2) induce the designed flow by implementing a proper routing mechanism. 
 
The $\theta$-EF and $\theta$-UNE flows have the promise of coming up with a path flow which is both fair and has good social cost in a typical network. This is discussed through the example given in Section \ref{sec:exampleBalncedNetwork}. Unfortunately though, designing $\theta$-EF and $\theta$-UNE path flows is NP-hard as noted in  Section~\ref{sec:complex}. Moreover, there exist networks where  a $\theta$-EF flow with the lowest social cost is indeed a $\theta$-PNE, i.e.,  under a worst case framework the PoS($\theta$-EF) equals the PoS($\theta$-PNE) (recall Lemma \ref{lemm:POSequality}). Therefore, we focus on designing $\theta$-PNE flows that have both low social cost and low {\efu}. 
 
We discuss two main approaches of designing  such %$\theta$-PNE 
flows. One approach is the use of a modified potential function technique (Christodoulou et al.~\cite{christodoulou2011performance}) and the second approach is the bounded toll approach (Bonifacci et al.~\cite{bonifaci2011efficiency}). Here we clarify that we do not need to place tolls on the edges. We can virtually calculate the resulting edge flow and suggest to the central planner to induce this flow.

We further propose a randomized routing approach which tries to incentivize users to follow a given flow by making the average (over the randomness in the algorithm) latency of each user small. We show how the solution concepts play an important role in the variance reduction of the randomized routing. 

 
\subsection{Improved balance using path flow: An example}\label{sec:exampleBalncedNetwork} 
 In this subsection, we argue that finding an appropriate path flow decomposition (as opposed to just specifying an edge flow) is critical to combining the goals of fairness and low social cost.  In fact, even in worst case examples, where a positive path may be very unfair (significantly longer than another path), there exist path flows that are completely fair. 

% worst case example shows instance where SO edge flow has bad positive path

\smallskip\noindent\textbf{Worst Case Example.} Consider the instance depicted in Figure \ref{fig:badEgCasc} where we have $n$ stages of two parallel links connected in series. For any $i\in [n]$, in the $i$-th stage the top link $e_u(i)$ has a constant latency of $\ell_u = (2-\epsilon)$ and the bottom link $e_b(i)$ has latency function $\ell_b(x) = x$.  Here  $n\epsilon/2 \leq 1$. For a total demand of $1$, the social optimum in the network passes $(1-\epsilon/2)$ flow through the bottom link and the remaining flow through the top link for every stage. Whereas, the Nash equilibrium flow passes $1$ unit flow through the bottom link. The  $maxpath/minpath$ ratio  of the SO flow is equal to $2$, which is the worst possible under linear latencies. The same conclusion holds for any class of latency functions by replacing $x$ with $\ell(x)$ and $(2-\epsilon)$ with $\ell^*(d)-\epsilon$. Here $d$ is total demand, $\ell^*(x)= \ell(x)+x\ell'(x)$ and $\gamma(\mc{L})= \ell^*(d)/\ell(d)$. This was noted in Correa et al.~\cite{correa2004computational}.   

% this shows fair path flow decomposition of SO in above example

\smallskip\noindent\textbf{Balanced UNE and EF flow.} This worst case example admits an almost balanced path flow under the SO flow.
Let $p_i$ be a path that uses the top edge from $i$-th stage and the bottom edge in the other stages, for each $i\in [n]$ and let $p_0$ be the path using only bottom edges from each stage. We consider the path flow decomposition of the social optimum where $\epsilon/2$ flow passes through path $p_i$,  for all $i\in [n]$, and the remaining flow, if any, passes through path $p_0$. We can easily check this is a valid path flow and  a 
$\left(1+ \frac{1}{n}\right)$-UNE. 
Note that the term $\left(1+ \frac{1}{n}\right)$ approaches $1$ as $n$ becomes 
large. Moreover, for $n\epsilon/2=1$, the path $p_0$ is not used and this flow is indeed a $1$-EF flow. This shows that even worst case examples in terms of edge flow can produce a path flow with near optimal results.


\smallskip\noindent\textbf{Balanced PNE.} Moreover, it is also possible to bring down the {\efu} by compromising on the social cost slightly. Let $k$ stages out of a total of $n$ stages be in SO locally and the other $(n-k)$ stages be in NE locally. This flow is a 
$\left(\frac{n+k(1-\epsilon)}{n-k\epsilon/2}\right)$-PNE, whereas the social cost is $\left(n -k\epsilon^2/4\right)$. This presents us with a complete spectrum of balanced flows.  
%-------------------------------------------Figure---------------------------------------------------
\begin{figure}[!htb]
\centerline{\includegraphics[width=0.5\linewidth]{badExample}}
\caption{Improved Balance: Example}
\label{fig:badEgCasc}
\end{figure}
%-------------------------------------------Figure---------------------------------------------------

\subsection{Edge Flow Design based on Modified Potential Functions}\label{sec:designSubPoteFunc}
Consider the flow minimizing a modified potential, specified by $\bm{x}^* = \argmin_{\bm{x}\in \mc{D}_E} \sum_e \int_0^{x_e}\phi_e(t)dt$. 
From Theorem 4 in~\cite{christodoulou2011performance}  we know  that if for all edges $e$ and for all $x\geq 0$, this modified potential $\phi_e(x)$ satisfies $ \ell_e(x)/\theta\leq \phi_e(x)\leq \ell_e(x)$, then $\bm{x}^*$ is a $\theta$-PNE. Further, we can bound the inefficiency of the flow $\bm{x}^*$ as the PoA($1$-PNE) under the modified potential functions. This gives us an upper bound for the PoS($\theta$-PNE). From the inclusion of the $\theta$ flows in Lemma~\ref{lemm:PNEvUNEvEF}, this is the upper bound for both PoS($\theta$-UNE) and PoS($\theta$-EF). 

 
\input{thetaNashNew.tex}

% The bounded toll method of finding good flow
\subsection{Edge Flow Design based on Bounded Tolls} 
In the routing games literature a natural way to enforce the socially optimal flows has been to place tolls on the edges. Among the many variations of this problem a practical one is to consider tolls that are bounded on every edge, which may not attain the social optimum but reduce the social cost of the best equilibrium, namely they lower the price of stability. Bonifacci et al. in~\cite{bonifaci2011efficiency} considered a version of bounded tolls where each edge $e$ has an upper bound on its toll given by $\epsilon \ell_e(x)$ for all $x\geq 0$. Call this an $\epsilon$-bounded toll. The following lemma shows how we can use this idea in the context of computing good $\theta$-PNE flows.

\begin{lemma}
The $1$-PNE under tolled latency functions, with  $\epsilon$-bounded tolls, is a $(1+\epsilon)$-PNE under the original latency functions.
\end{lemma}
\begin{proof}
Let $\hat{\bm{x}}$  be a $1$-PNE under the tolled latency functions $\{\tau_e(\cdot)\}_{e\in E}$. For any commodity $k$ let $p$ be a positive path under this flow and $q$ be any other path. The tolled cost of $p$ is less or equal to the tolled cost of $q$, i.e. $\sum_{e\in p}\tau_e(\hat{x}_e)\leq \sum_{e\in q}\tau_e(\hat{x}_e)$. As the tolls are $\epsilon$-bounded we have $\tau_e(x)\in [0,\epsilon\ell_e(x)]$, hence the original latencies of the two paths satisfy the bound $\ell_p(\hat{\bm{x}}) \leq (1+\epsilon) \ell_q(\bm{x}^b)$. Therefore, $\hat{\bm{x}}$ is a $(1+\epsilon)$-PNE under the original latency functions $\ell_e(\cdot)$.
\end{proof}
    
This presents us with another strategy where we use latency functions with $(\theta-1)$ bounded tolls and obtain the resulting equilibrium as a $\theta$-PNE that also has good social cost. For example, %Specifically, 
Bonifacci et al.~\cite{bonifaci2011efficiency} considered tolls of the form $\min \{x\ell'_e(x), \epsilon \ell_e(x)\}$ and showed that for polynomial latency functions the cost of the tolled equilibrium flow is upper bounded by PoS($\theta$-PNE) of instances with polynomial latency functions. As another example, Fotakis et al.~\cite{fotakis2015improving}, in a setting technically similar  to that of bounded tolls,  provide, for series parallel graphs, an upper bound   on the PoS for general latencies in class $\mathcal{D}$, which, in our setting, equals to %$PoA_\gamma(\mathcal{D})\leq\rho_\gamma(\mathcal{D})=
$\max\Big\{1,\frac{1}{1-\beta_\theta(\mathcal{D})}\Big\}$, with
$\beta_\theta(\mathcal{D})=\sup_{\ell\in \mathcal{D}, x\geq
y\geq0}\frac{y(\ell(x)-\ell(y))-(\theta-1)(x-y)\ell(x)}{x\ell(x)}$.   
 

\subsection{Randomized Routing}
In this section, we introduce the idea of randomized routing in traffic networks as a way of implementing a given flow.
The design of deterministic routes in a given network presents us with the dichotomy that flows with good social cost have inherent unfairness. Therefore, in many cases, if we want to improve the social cost we must assign some user a long path which causes dissatisfaction on her part. We can get out of this seemingly unavoidable situation through the use of randomization in route assignment.
In randomized routing (RR) the central planner tries to induce a specific path flow $\bm{f}$ in the network, by assigning each user randomly to some route. For any commodity $k$ and a user with this commodity, the randomized routing assigns the user to a path $p\in \mc{P}^k$ with probability $f_p/ d_k$. In what follows, we formalize the routing process within a distributed framework.
 
\textbf{User Identity.}  Let us represent each infinitesimal user with commodity $k$ using a real number that takes value from $[0,1]$. Therefore, we can label each user by a tuple $(k,id)$ where $k$ represents the commodity and $id\in[0,1]$. 

\textbf{Path ordering.} Given a path flow $\bm{f}$ we can impose an arbitrary order on the set of `used' paths for each commodity $k$, i.e. $\left(p_k(i) : i \in \{1, \dots, |\mc{P}^k_{u}|\}\right)$. Here the ordering means the ids in range $\Big[\frac{\sum_{j=1}^{(i-1)} f_{p_k(j)}}{d_k}, \frac{\sum_{j=1}^{i} f_{p_k(j)}}{d_k}\Big)$ are assigned to path $p_k(i)$. 

\textbf{Hash functions.} Under this ordering with the given flow $\bm{f}$ we can define a hash function $h_x: [0,1]\times\mc{K}\rightarrow \mathbb{N}$ as $h_x(k,id)= p_k(i^*)$ where $i^* = \argmax\left\{i:  \text{frac}(id+x) \leq \sum_{j=1}^{i} f_{p_k(j)}/ d_k \right\}$. Here $\text{frac}(x)$ gives the fractional part of $x$. This hash function divides the real line $[0,1]$ into intervals and assigns the $i$-th interval to the $i$-th path. The length of the $i$-th interval is proportional to the flow in $i$-th path. Given a path flow with polynomially many `used' paths it is possible to compute this hash function efficiently (with some quantization).  
 
\textbf{Algorithm.} The randomized routing can be implemented as a distributed system as presented below.
\begin{enumerate}
\item The central planner picks $X$ uniformly at random from $[0,1]$.
\item Given a path flow $\bm{f}$ the central planner computes the hash function $h_X$ and broadcasts it. 
\item Upon receiving the hash function $h_X$, a user $(k,id)$ chooses the path $p = h_X(k,id)$.
\end{enumerate}
 

\textbf{Performance.} In the next lemma, we characterize some properties of the randomized routing when the central planner induces a  $\theta$-UNE or $\theta$-EF flow.
\begin{theorem}
A randomized routing (RR) under a flow $\bm{f}\in \theta$-UNE  $\cup$  $\theta$-EF has the following properties:
\begin{enumerate}
\item RR induces the original flow $\bm{f}$.
\item Each user with commodity $k$ experiences the latency $\bar{\ell}_k = (\sum_{p\in \mc{P}_{u}^k} f_p \ell_p(\bm{f}))/d_k$ in expectation. Therefore, the RR produces a $1$-EF flow in expectation. 
\item The standard deviation of the latency seen by a typical user with commodity $k$ is upper bounded by $\frac{(\theta-1)}{4\sqrt{\theta}}\bar{\ell}_k $.
\end{enumerate}
\label{thm:RR}
\end{theorem}
\begin{proof}
The RR performs a randomized rotation of the user ids and then assigns the paths according to the new ids. Here the change of the ordering does not affect the amount of flow any path $p$ is assigned to, i.e. path $p$ is assigned exactly $f_p$ amount of flow. The randomized routing induces the flow $\bm{f}$. 

For some user $(k,id)$, the randomized rotation creates the new id $(k,y)$ where $y = \text{frac}(id+X)$. For $X\sim U([0,1])$ we get $y\sim U([0,1])$ from basic probability theory. This implies that the probability that user $(k,id)$ is assigned a path $p_k(i)$ is $f_{p_k(i)}$ for any $i$. Therefore, the expected latency for user $(k,id)$ is $\bar{\ell}_k = (\sum_{p\in \mc{P}_{u}^k} f_p \ell_p(\bm{f}))/d_k$.

Let the maximum path in $\mc{P}_u^k$ has length $L_k$ and the minimum path has length $l_k$, for each $k$. From the Bhatia-Davis bound~\cite{bhatia2000better} on the variance of a random variable we get that the variance of the latency of any user with commodity $k$ is bounded from above by $(L_k - \bar{\ell}_k)(\bar{\ell}_k - l_k)$. Further, we know that $L_k \leq \theta l_k$ as $\bm{f}\in \theta$-UNE  $\cup$  $\theta$-EF. Through simple algebra we obtain the upper bound on the variance as $\frac{(\theta-1)^2}{16\theta}{\bar{\ell}}_k^2$.  
\end{proof}
  
\begin{remark}
In Section~\ref{sec:complex}, we showed that the computation of the optimal $\theta$-UNE or $\theta$-EF flows is NP-hard. %in this paper. 
For this reason, in this section we turned to computing a $\theta$-PNE with low social cost and then proceeded to compute a path flow from this edge flow. Any path flow we computed here is $\theta$-UNE or $\theta$-EF by Lemma~\ref{lemm:PNEvUNEvEF}. There is also the possibility of improving $\theta$ by avoiding a long `positive' path. A candidate method for this improvement can be the technique mentioned in Proposition~\ref{lemma:correa1}, whereby we start from a path flow with more than $|A|$ used paths, and gradually eliminate current longest and shortest paths to make the resulting flow more fair.  
\end{remark}


