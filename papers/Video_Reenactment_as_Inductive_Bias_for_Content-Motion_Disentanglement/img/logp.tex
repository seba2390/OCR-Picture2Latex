% !TeX spellcheck = en_US
\makeatletter%
\begin{tikzpicture}[
pics/named code/.style={code={\tikz@fig@mustbenamed%
  \begin{scope}[local bounding box/.expanded=\tikz@fig@name]#1\end{scope}%
}},
%pics/named code/.style={code={\tikz@fig@mustbenamed%
%    \node[inner sep=1pt, outer sep=1pt, anchor=center] (\tikz@fig@name) {\begin{tikzpicture}#1\end{tikzpicture}};%
%}},
% Encoder-Decoder pics
coder long height/.store in=\longheight,
coder long height=1,
coder short height/.store in=\shortheight,
coder short height=.5,
coder width/.store in=\width,
coder width=0.6,
coder fill/.store in=\coderfill,
coder text/.store in=\codertext,
coder label/.store in=\coderlabel,
latent label left/.store in=\latentlabelleft,
latent label right/.store in=\latentlabelright,
coder style hidden/.style={#1},
coder style hidden/.default={coder label=, coder text=white, coder fill=black,},
% note that pic should be centered at 0,0
pics/encoder tb/.style = {named code={%
  \tikzset{coder style hidden, #1}%
  \coordinate (-center) at (0, 0);
  \coordinate (-east) at (0,-\width/2);
  \coordinate (-west) at (0, \width/2);
  \coordinate (-north east) at (-\shortheight/2, -\width/2);
  \coordinate (-south east) at (\shortheight/2 , -\width/2);
  \coordinate (-north west) at (-\longheight/2 ,  \width/2);
  \coordinate (-south west) at (\longheight/2  ,  \width/2);
  \draw[fill=\coderfill] (-west) -- (-north west) -- (-north east) -- (-south east) -- (-south west) -- (-west);
  \node[text=\codertext, anchor=center] at (-center)  {\normalsize\coderlabel};%
}},
pics/encoder lr/.style = {named code={%
    \tikzset{coder style hidden, #1}%
    \coordinate (-center) at (0, 0);
    \coordinate (-west) at (-\width/2,0);
    \coordinate (-north west) at (-\width/2, \longheight/2);
    \coordinate (-north east) at (\width/2, \shortheight/2);
    \coordinate (-east) at (\width/2, 0);
    \coordinate (-south east) at (\width/2, -\shortheight/2);
    \coordinate (-south west) at (-\width/2, -\longheight/2);
    \draw[fill=\coderfill] (-west) -- (-north west) -- (-north east) -- (-south east) -- (-south west) -- (-west);
    \node[text=\codertext, anchor=center] at (-center)  {\coderlabel};%
}},
pics/decoder bt/.style = {named code={%
  \tikzset{coder style hidden, #1}%
  \coordinate (-center) at (0, 0);
  \coordinate (-east) at (0,  \width/2);
  \coordinate (-west) at (0, -\width/2);
  \coordinate (-north east) at (-\longheight/2 , \width/2);
  \coordinate (-south east) at ( \longheight/2 , \width/2);
  \coordinate (-north west) at (-\shortheight/2,-\width/2);
  \coordinate (-south west) at ( \shortheight/2,-\width/2);
  \draw[fill=\coderfill] (-west) -- (-north west) -- (-north east) -- (-south east) -- (-south west) -- (-west);
  \node[text=\codertext, anchor=center] at (-center)  {\normalsize\coderlabel};%
}},
pics/decoder rl/.style = {named code={%
  \tikzset{coder style hidden, #1}%
  \coordinate (-center) at (0, 0);
  \coordinate (-west) at (-\width/2,0);
  \coordinate (-north west) at (-\width/2, \shortheight/2);
  \coordinate (-north east) at (\width/2, \longheight/2);
  \coordinate (-east) at (\width/2, 0);
  \coordinate (-south east) at (\width/2, -\longheight/2);
  \coordinate (-south west) at (-\width/2, -\shortheight/2);
  \draw[fill=\coderfill] (-west) -- (-north west) -- (-north east) -- (-south east) -- (-south west) -- (-west);
  \node[text=\codertext, anchor=center] at (-center)  {\coderlabel};%
}},
chunk width/.store in=\wch,
chunk height/.store in=\hch,
chunk size/.store in=\sch,
chunk depth/.store in=\dch,
chunk fill/.store in=\chunkfill,
chunk text/.store in=\chunktext,
chunk label/.store in=\chunklabel,
chunk seq label/.store in=\chunkseqlabel,
chunk style/.style={#1},
chunk style/.default={chunk label=, chunk text=black, chunk fill=white,font=\tiny},
% note that pic should be centered at 0,0
pics/chunk/.style = {named code={%
  \tikzset{chunk style, #1}%
  \draw[fill=\chunkfill] (-\wch/2,-\hch/2) rectangle (\wch/2,\hch/2);
  %todo this part causes alignment issues
  \draw[fill=\chunkfill, rounded corners=0] (\wch/2,-\hch/2) -- (\wch/2+\dch,-\hch/2+\dch/2) -- (\wch/2+\dch,\hch/2+\dch/2) -- (\wch/2,\hch/2) -- (\wch/2,-\hch/2);
  \draw[fill=\chunkfill, rounded corners=0] (\wch/2,\hch/2) -- (\wch/2+\dch,\hch/2+\dch/2) -- (-\wch/2+\dch,\hch/2+\dch/2) -- (-\wch/2,\hch/2) -- (\wch/2,\hch/2);
  \node[text=\chunktext, anchor=center, inner sep=0pt, outer sep=0pt] at (0,0) {\chunklabel};%
}},
pics/chunk seq/.style = {named code={%
  \tikzset{chunk style, #1}%
  \pic[] (-1) at (-2*\sch,0) {chunk={chunk label=$\chunkseqlabel_{1}$, chunk width=\sch, chunk height=\sch}};%
  \pic[] (-2) at (-\sch,0) {chunk={chunk label=$\chunkseqlabel_{2}$, chunk width=\sch, chunk height=\sch}};%
  \pic[] (-dots) at (\sch/2,0) {chunk={chunk label=$\dots$, chunk width=2*\sch, chunk height=\sch}};%
  \pic[] (-n) at (2*\sch,0) {chunk={chunk label=$\chunkseqlabel_{O}$, chunk width=\sch, chunk height=\sch}};%
}},%
pics/chunk grid/.style = {named code={%
  \tikzset{chunk style, #1}%
  \pic[] (-n1) at (-2*\sch,-\sch) {chunk={chunk label={$\rho_{O,1}$}, chunk width=\sch, chunk height=\sch}};%
  \pic[] (-n2) at (-\sch,-\sch) {chunk={chunk label={$\rho_{O,2}$}, chunk width=\sch, chunk height=\sch}};%
  \pic[] at (\sch/2,-\sch) {chunk={chunk label=$\dots$, chunk width=2*\sch, chunk height=\sch}};%
  \pic[] (-nn) at (2*\sch,-\sch) {chunk={chunk label={$\rho_{O,O}$}, chunk width=\sch, chunk height=\sch}};%
  \pic[] at (-2*\sch,\sch/2) {chunk={chunk label=$\vdots$, chunk width=\sch, chunk height=2*\sch}};%
  \pic[] at (-\sch,\sch/2) {chunk={chunk label=$\vdots$, chunk width=\sch, chunk height=2*\sch}};%
  \pic[] at (\sch/2,\sch/2) {chunk={chunk label={$\rho_{i,j}$}, chunk width=2*\sch, chunk height=2*\sch}};%
  \pic[] at (2*\sch,\sch/2) {chunk={chunk label=$\vdots$, chunk width=\sch, chunk height=2*\sch}};%
  \pic[] (-21) at (-2*\sch,2*\sch) {chunk={chunk label={$\rho_{2,1}$}, chunk width=\sch, chunk height=\sch}};%
  \pic[] (-22) at (-\sch,2*\sch) {chunk={chunk label={$\rho_{2,2}$}, chunk width=\sch, chunk height=\sch}};%
  \pic[] at (\sch/2,2*\sch) {chunk={chunk label=$\dots$, chunk width=2*\sch, chunk height=\sch}};%
  \pic[] (-2n) at (2*\sch,2*\sch) {chunk={chunk label={$\rho_{2,O}$}, chunk width=\sch, chunk height=\sch}};%
  \pic[] (-11) at (-2*\sch,3*\sch) {chunk={chunk label={$\rho_{1,1}$}, chunk width=\sch, chunk height=\sch}};%
  \pic[] (-12) at (-\sch,3*\sch) {chunk={chunk label={$\rho_{1,2}$}, chunk width=\sch, chunk height=\sch}};%
  \pic[] at (\sch/2,3*\sch) {chunk={chunk label=$\dots$, chunk width=2*\sch, chunk height=\sch}};%
  \pic[] (-1n) at (2*\sch,3*\sch) {chunk={chunk label={$\rho_{1,O}$}, chunk width=\sch, chunk height=\sch}};%
}},%
block heigth/.store in=\hb,
block fill/.store in=\blockfill,
block text/.store in=\blocktext,
block label/.store in=\blocklabel,
block style/.style={#1},
block style/.default={block label=, block text=black, block fill=white,},
comp heigth/.store in=\ch,
comp label/.store in=\complabel,
mult heigth/.store in=\mh,
pics/z block/.style = {named code={%
  \tikzset{block style, #1}%
  \draw[fill=\blockfill] (-\hb/3.236,-\hb/2) rectangle (\hb/3.236,\hb/2);
  \node[text=\blocktext, anchor=center] at (0,0.4*\hb) {\tiny $\blocklabel_1$};
  \draw[] (-\hb/3.236,0.3*\hb) -- (\hb/3.236,0.3*\hb);
  \node[text=\blocktext, anchor=center] at (0,0.2*\hb) {\tiny $\blocklabel_2$};
  \draw[] (-\hb/3.236,0.1*\hb) -- (\hb/3.236,0.1*\hb);
  \node[text=\blocktext, anchor=center] at (0,-0.05*\hb) {\tiny $\vdots$};
  \draw[] (-\hb/3.236,-0.3*\hb) -- (\hb/3.236,-0.3*\hb);
  \node[text=\blocktext, anchor=center] at (0,-0.4*\hb) {\tiny $\blocklabel_O$};
}},
pics/z block comp/.style = {named code={%
  \tikzset{block style, #1}%
  \draw[fill=\blockfill] (-\ch/1.618,-\ch/2) rectangle (0,\ch/2);
  \pic[] at (\ch/3.236,0) {z block={block heigth=\ch, block label=w}};
  \node[text=\blocktext, anchor=center] at (-\ch/3.236,0) {\tiny \complabel};
}},
pics/z block mult/.style = {named code={%
  \tikzset{block style, #1}%
  \pic[] at (0,0) {z block comp={comp heigth=\mh, comp label=$z_1$}};
  \draw[fill=\blockfill] (-\mh/1.618,-\mh*.5) rectangle (\mh/1.618,-\mh*.9);
  \node[text=\blocktext, anchor=center] at (0,-\mh*.65) {$\vdots$};
  \pic[] at (0,-\mh*1.4) {z block comp={comp heigth=\mh, comp label=$z_O$}};
}},
loss/.style={
  shorten <=2.5pt, 
  shorten > = 2.5pt,
  <->,
  >=latex,
  draw=#1,
  text=#1,
  my node/.style={%
    text width=20pt,
    inner sep=1pt,
    text centered,
    circle,
    rounded corners,
    fill=white, 
    draw,
  },
  every node/.style={my node},
  my node,
  fill=none,
},
loss/.default=black,
font=\tiny,
flow/.style={rounded corners, -{latex}},
ll/.style={-{latex}, dashed, blue!80, line width = 1},
lr/.style={-{latex}, dashed, red!80,  line width = 0.75},
lrbl/.style={-{latex}, lr, bend left=60, looseness=.6},
lrbr/.style={-{latex}, lr, bend right=60, looseness=0.6},
rr/.style={-{latex}, dashed, blue!40!green!80,  line width = 0.75},
% for the matrix (makes the line thiner)
table/.style={
  row sep=-\pgflinewidth,
  column sep=-\pgflinewidth,
  nodes={draw, anchor=center},
  nodes={inner sep=0pt, outer sep=0pt,},
  execute at empty cell={\node[draw=none]{};},
},
% make all nodes the minium same size
every node/.style={
  minimum height=1.8em, minimum width=1.8em,
},
% tight style for labels (removes all white space around them)
tight/.style={
  outer sep=0pt, inner sep=0pt, minimum width=1em, minimum height=1em,
},
node distance=.5,
]
\makeatother

%% Original video
\matrix[table, matrix of math nodes] (x) {
  x_1 & x_2 & \dots & x_O \\
};

%% Encoders
\pic[right = 1 of x] (ea) {encoder lr={coder label={$q_\phi$}}};
\pic[below= .75 of ea] (em) {encoder lr={coder label={$q_\gamma$}}};


%% Latent vectors
\matrix[matrix of math nodes, right=of ea, nodes={draw, anchor=center}] (latz) {
 z_1 & z_2 & \dots & z_O \\
};
\matrix[matrix of math nodes, right=of em, nodes={draw, anchor=center}] (latw) {
  w_1 & w_2 & \dots & w_O \\
};

%% Combined latent space
\matrix[table, matrix of math nodes, nodes in empty cells, below=.125 of latw, nodes={minimum height=1em}] (lat) {
  & w_1 \\
  & \dots \\
  & w_O \\
  & \\
  & w_1 \\
  & \dots \\
  & w_O \\
};
\node[draw, fill=white, fit=(lat-1-1)(lat-3-1), inner sep=0pt, outer sep=0pt] {$z_1$};
\node[draw, fill=white, fit=(lat-4-1)(lat-4-2), inner sep=0pt, outer sep=0pt, minimum height=1em] {$\dots$};
\node[draw, fill=white, fit=(lat-5-1)(lat-7-1), inner sep=0pt, outer sep=0pt] {$z_O$};

%% Grid of parameters
\matrix[matrix of math nodes, table, nodes in empty cells] (grid) at (x |- lat) {
  \rho_{1,1} & \rho_{1,2} & \dots & \rho_{1,O} \\
  \rho_{2,1} & \rho_{2,2} & \dots & \rho_{2,O} \\
  \rvdots & \rvdots & \rho_{j,k} & \rvdots \\
  \rho_{O,1} & \rho_{O,2} & \dots & \rho_{O,O} \\
};

%% Generated video
\matrix[table, matrix of math nodes, below=of grid] (x') {
  \hat{x}_1 & \hat{x}_2 & \dots & \hat{x}_O \\
};

%% Priors
\node[loss=black, right=1 of latz] (pz) {$p(z)$};
\node[loss=black, right=1 of latw] (pw) {$p(w_k)$};

%% Decoder
\pic[] (d) at (em |- grid) {decoder rl={coder label={$p_\theta$}}};


%% Flow
\draw[flow] (x.east) -- (ea.west);
\draw[flow] (x.east) -| ($(x.east |- em.west)!.5!(em.west)$) -- (em.west);

\draw[flow] (ea) -- (latz);
\draw[flow] (em) -- (latw);

\draw[flow] ($(latz.east)+(0,-.25em)$) -| (lat -| {$(latz.east)!.5!(pz.west)$}) -- (lat);
\draw[flow] ($(latw.east)+(0,-.25em)$) -| (lat -| {$(latw.east)!.5!(pw.west)$}) -- (lat);

\draw[flow] (lat) -- (d);
\draw[flow] (d) -- (grid);

\draw[ll] (latz) --node[circle, above=2.5pt, blue, tight] {\small $\mathcal{L}_a$} (pz);
\draw[ll] (latw) --node[circle, above=2.5pt, blue, fill=white, tight] {\small $\mathcal{L}_m$} (pw);

%% Loss reconstruction
\path (grid-1-1.west) edge[lrbl] (x-1-1.south);
\path (grid-2-1.west) edge[lrbl] (x-1-1.south);
\path (grid-4-1.west) edge[lrbl] (x-1-1.south);

\path (grid-1-4.east) edge[lrbr] (x-1-4.south);
\path (grid-2-4.east) edge[lrbr] (x-1-4.south);
\path (grid-4-4.east) edge[lrbr] node[circle, fill=white, above left, xshift=0pt, yshift=5pt, tight] {\small $\mathcal{L}_r$} (x-1-4.south);


%% Sampling
\path (grid-4-1.south) edge[rr] (x'-1-1.north);
\path (grid-4-2.south) edge[rr] (x'-1-2.north);
\path (grid-4-4.south) edge[rr] (x'-1-4.north);

%% Labels
\node[above=-7pt of x.north west, anchor=south west] {\scriptsize Input video};
\node[above=-0pt of grid] {\scriptsize Chunk posteriors'};
\node[above=-7pt of grid] {\scriptsize parameters};
\node[below=-7pt of x'.south west, anchor=north west] {\scriptsize Reconstructed video};
\node[below=-5pt of lat] {\scriptsize Combined latent representations};

\node[below=0pt of em] {\scriptsize Encoders};
\node[below=0pt of d] {\scriptsize Decoder};

\node[above=-7pt of latz.north west, anchor=south west] {\scriptsize Appearance representations};
\node[above=-7pt of latw.north west, anchor=south west] {\scriptsize Motion representations};

\node[blue!40!green, fill=white, tight] at ($(grid.south)!.5!(x'.north)$) {\scriptsize Sampling};

\end{tikzpicture}%
\makeatother%