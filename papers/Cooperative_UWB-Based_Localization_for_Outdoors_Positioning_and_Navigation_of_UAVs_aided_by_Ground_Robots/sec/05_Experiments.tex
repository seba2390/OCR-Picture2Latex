%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%                                          %%
%%              EXPERIMENTS                 %%
%%                                          %%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{figure*}
    \centering
    \begin{subfigure}{0.32\textwidth}
        \centering
        \setlength\figureheight{\textwidth}
        \setlength\figurewidth{\textwidth}
        \footnotesize{\input{tex/square_boxplot_position_xy}}
        \caption{Positioning $xy$ error.}
        \label{fig:square_pos_xy}
    \end{subfigure}
    \begin{subfigure}{0.32\textwidth}
        \centering
        \setlength\figureheight{\textwidth}
        \setlength\figurewidth{\textwidth}
        \footnotesize{\input{tex/square_boxplot_position_z}}
        \caption{Positioning $z$ error.}
        \label{fig:square_pos_z}
    \end{subfigure}
        \begin{subfigure}{0.32\textwidth}
        \centering
        \setlength\figureheight{\textwidth}
        \setlength\figurewidth{\textwidth}
        \footnotesize{\input{tex/square_boxplot_navi_xy}}
        \caption{Navigation $xy$ error.}
        \label{fig:square_nav}
    \end{subfigure}
    \caption{Positioning and navigation errors over a flight following a squared shape of 8 by 8\,m, at three different altitudes (5, 10 and 20\,m). The altitude is set to a constant so only the XY error is calculated for the UWB-based navigation. The legend has been omitted due to limited space, with the colors representing, from left to right in each group, anchors separated by 0.6\,m, 1.2\,m, 3\,m, 4\,m, 12\,m and 16\,m.}
    \label{fig:square_sim}
\end{figure*}   

\section{Experimental Results}

In this sections, we study the performance of the UWB-based cooperative localization system both in simulation and field experiments. 
%In the outdoor environment, we compared the performances of GPS, VIO and UWB system.


% \subsection{Results}


% Compare uwb with mavros, just for taking a look
%%% up and down positioning
\begin{figure}
    \centering
    \begin{subfigure}{0.49\textwidth}
        \centering
        \setlength\figureheight{0.42\textwidth}
        \setlength\figurewidth{0.95\textwidth}
        \footnotesize{\input{tex/up_down_boxplot}}
        \caption{Positioning error based on different anchor distribution settings when doing up and down navigation during a vertical flight.}
        \label{fig:up_down_pos}
    \end{subfigure}
    
    \vspace{1em}
    \begin{subfigure}{0.49\textwidth}
        \centering
        \setlength\figureheight{0.42\textwidth}
        \setlength\figurewidth{0.95\textwidth}
        \footnotesize{\input{tex/up_down_boxplot_nav}}
        \caption{Navigation error based on different anchor distribution settings when doing up and down navigation during a vertical flight.}
        \label{fig:up_down_nav}
    \end{subfigure}
    \caption{Positioning and navigation errors over a vertical flight to an altitude of 30\,m. The navigation error includes only the planar distance to the vertical line the drone is set to follow.}
    \label{fig:updown_sim}
\end{figure}

\subsection{Simulation Results}

The positioning and navigation errors for vertical flights are shown in Fig.~\ref{fig:updown_sim}. We observe that the positioning error consistently decreases as the anchors become more separated. For the small UGV setting, the error goes over 1\,m almost 20\% of the time, being highly unstable. It is worth noticing that the navigation error becomes relatively stable with the large UGV anchor distribution (1.2\,m separation). Navigation errors are in general lower than their positioning counterparts as the control of the drone is less affected by individual ranging errors, and these tend to average to zero as time passes. It is also worth noticing that the altitude error is significantly lower in all cases when compared to the planar $xy$ error.

Figure~\ref{fig:square_sim} then shows the results of flights following a square pattern. We can see that if UWB systems based on fixed anchors separated more than 10\,m are utilized, then the navigation error can be consistently maintained below 10\,cm. In the case of relying on small or large UGVs, the error is in the tens of centimeters, providing a competitive alternative to RTK-GNSS systems with higher deployment flexibility and lower system complexity.


% Compare with (0,0)
% %%% up and down navigation errror
% \begin{figure*}
%     \centering
%     \setlength\figureheight{0.33\textwidth}
%     \setlength\figurewidth{\textwidth}
%     \footnotesize{\input{fig/up_down_boxplot_xy}}
%     \caption{Navigation error based on different anchor distribution settings when doing up and down navigation}
%     \label{fig:up_down}
% \end{figure*}

% %%%% Square Positioning
%  \begin{figure*}
%     \centering
%     \setlength\figureheight{0.33\textwidth}
%     \setlength\figurewidth{\textwidth}
%     \footnotesize{\input{fig/square_boxplot_old_data}}
%     % \footnotesize{\input{fig/square_boxplot_old_data}} % before we modified the speed, but looks also good
%     % \footnotesize{\input{fig/square_fig_boxplot}} % Old drawing way
%     \caption{Positioning error based on different anchor distribution settings when doing square navigation at height of 5, 10 and 20 meters}
%     \label{fig:square_position_err}
% \end{figure*}

% %%%% Square Navigation
%  \begin{figure*}
%     \centering
%     \setlength\figureheight{0.33\textwidth}
%     \setlength\figurewidth{\textwidth}
%     \footnotesize{\input{fig/square_fig_boxplot_new}}
%     % \footnotesize{\input{fig/square_navi_boxplot_new_data}} % before we modified the speed, but looks also good
%     % \footnotesize{\input{fig/navi_error}} % Old drawing way
%     \caption{Navigation error based on different anchor distribution settings when doing square navigation at height of 5, 10 and 20 meters}
%     \label{fig:square_position_err}
% \end{figure*}



%  \begin{figure*}
%     \centering
%     \setlength\figureheight{0.33\textwidth}
%     \setlength\figurewidth{\textwidth}
%     \footnotesize{\input{fig/square_traj}}
%     \caption{Trajectories based on uwb positioning at the height of 20m}
%     \label{fig:square_all_together}
% \end{figure*}


%  \begin{figure*}
%     \centering
%     \setlength\figureheight{0.33\textwidth}
%     \setlength\figurewidth{\textwidth}
%     \footnotesize{\input{fig/square_fig_boxplot}}
%     \caption{Coordinates positioning error based on different anchor distribution settings when doing square navigation at height of 5, 10 and 20 meters}
%     \label{fig:square_all_heights}
% \end{figure*}


\begin{figure}
    \centering
    \includegraphics[width=0.49\textwidth]{fig/3d_trajectory.png}
    \caption{Partial trajectory of the UAV during the outdoors experiment. VIO is not included because it becomes unusable once the UAV reaches 8\,m of altitude.}
    \label{fig:trajectory}
\end{figure}


\begin{figure}
    \centering
    \setlength\figureheight{0.42\textwidth}
    \setlength\figurewidth{0.49\textwidth}
    \scriptsize{\input{tex/vio_uwb_gps_err}}
    \caption{Planar and vertical errors of the different methods during the outdoors flight. The VIO has low error but was only valid for the first few seconds of flight.}
    \label{fig:uwb_vio_gps_err}
\end{figure}


\subsection{Experimental results}

Results from outdoors experiments with real robots are reported in Fig.~\ref{fig:trajectory} and Fig.~\ref{fig:uwb_vio_gps_err}. The former shows a partial extract from the trajectory in 3D, where we can observe that the UWB error is significantly smaller even when the altitude reaches 30\,m. In the latter plot we can see that the overall error more than 5\,min flight time. The cooperative UWB approach particularly outperforms both VIO and GNSS estimations in terms of vertical accuracy. In terms of planar $xy$ error, VIO is more accurate but only during the first few seconds of flight, before it rapidly loses accuracy and diverges when the UAV altitude increases. In any case, the cooperative UWB-based localization provides consistent accuracy throughout the flight and therefore has potential for better collection of aerial data through autonomous flights.

% \begin{figure*}
%     \centering
%     % \setlength\figureheight{0.2\textwidth}
%     \setlength\figurewidth{0.35\textwidth}
%     \scriptsize{\input{fig/uwb_gps_vio_trajectory}}
%     \caption{Trajectory  during VIO works}
%     \label{fig:uwb_vio_gps_err}
% \end{figure*}

%  \begin{figure*}
%     \centering
%     % \setlength\figureheight{0.2\textwidth}
%     \setlength\figurewidth{0.3\textwidth}
%     \scriptsize{\input{fig/uwb_gps_vio_error_boxplot}}
%     \caption{Error during VIO works}
%     \label{fig:uwb_vio_gps_err}
% \end{figure*}
