%
\documentclass[journal]{IEEEtran}
\usepackage{times,amsmath,amssymb,amsfonts,graphicx,epsfig,cite,psfrag}
\usepackage{algorithmicx,algorithm}
%\usepackage{algpseudocode}
%\usepackage{amsthm}
\usepackage{color}
%\usepackage{hyperref}
%

\def\alphabf{\boldsymbol \alpha}
\def\betabf{\boldsymbol \beta }
\def\gammabf{\boldsymbol \gamma }
\def\gammacal{\Calsymbol \gamma }
\def\deltabf{\boldsymbol \delta }
\def\epsilonbf{\boldsymbol \epsilon }
\def\zetabf{\boldsymbol \zeta }
\def\etabf{\boldsymbol \eta }
\def\iotabf{\boldsymbol \iota }
\def\kappabf{\boldsymbol \kappa }
\def\lambdabf{\boldsymbol \lambda }
\def\mubf{\boldsymbol \mu }
\def\nubf{\boldsymbol \nu }
\def\xibf{\boldsymbol \xi }
\def\pibf{\boldsymbol \pi }
\def\rhobf{\boldsymbol \rho }
\def\sigmabf{\boldsymbol \sigma }
\def\taubf{\boldsymbol \tau }
\def\upsilonbf{\boldsymbol \upsilon }
\def\phibf{\boldsymbol \phi }
\def\chibf{\boldsymbol \chi }
\def\psibf{\boldsymbol \psi }
\def\omegabf{\boldsymbol \omega }
\def\Sigmabf{\boldsymbol \Sigma}
\def\Upsilonbf{\boldsymbol \Upsilon}
\def\Phibf{\boldsymbol \Phi}
\def\Psibf{\boldsymbol \Psi}
\def\Omegabf{\boldsymbol \Omega}
\def\Deltabf{\boldsymbol \Delta}
\def\Gammabf{\boldsymbol \Gamma}
\def\Thetabf{\boldsymbol \Theta}
\def\Lambdabf{\boldsymbol \Lambda}
\def\Xibf{\boldsymbol \Xi}
\def\Pibf{{\bf \Pi}}
\def\abf{{\bf a}}
\def\bbf{{\bf b}}
\def\cbf{{\bf c}}
\def\dbf{{\bf d}}
\def\ebf{{\bf e}}
\def\fbf{{\bf f}}
\def\gbf{{\bf g}}
\def\hbf{{\bf h}}
\def\ibf{{\bf i}}
\def\jbf{{\bf j}}
\def\kbf{{\bf k}}
\def\lbf{{\bf l}}
\def\mbf{{\bf m}}
\def\nbf{{\bf n}}
\def\obf{{\bf o}}
\def\pbf{{\bf p}}
\def\qbf{{\bf q}}
\def\rbf{{\bf r}}
\def\sbf{{\bf s}}
\def\tbf{{\bf t}}
\def\ubf{{\bf u}}
\def\vbf{{\bf v}}
\def\wbf{{\bf w}}
\def\xbf{{\bf x}}
\def\ybf{{\bf y}}
\def\zbf{{\bf z}}
\def\rbf{{\bf r}}
\def\xbf{{\bf x}}
\def\ybf{{\bf y}}
\def\Abf{{\bf A}}
\def\Bbf{{\bf B}}
\def\Cbf{{\bf C}}
\def\Dbf{{\bf D}}
\def\Ebf{{\bf E}}
\def\Fbf{{\bf F}}
\def\Gbf{{\bf G}}
\def\Hbf{{\bf H}}
\def\Ibf{{\bf I}}
\def\Jbf{{\bf J}}
\def\Kbf{{\bf K}}
\def\Lbf{{\bf L}}
\def\Mbf{{\bf M}}
\def\Nbf{{\bf N}}
\def\Obf{{\bf O}}
\def\Pbf{{\bf P}}
\def\Qbf{{\bf Q}}
\def\Rbf{{\bf R}}
\def\Sbf{{\bf S}}
\def\Tbf{{\bf T}}
\def\Ubf{{\bf U}}
\def\Vbf{{\bf V}}
\def\Wbf{{\bf W}}
\def\Xbf{{\bf X}}
\def\Ybf{{\bf Y}}
\def\Zbf{{\bf Z}}
\def\Ac{{\cal A}}
\def\Bc{{\cal B}}
\def\Cc{{\cal C}}
\def\Dc{{\cal D}}
\def\Ec{{\cal E}}
\def\Fc{{\cal F}}
\def\Gc{{\cal G}}
\def\Hc{{\cal H}}
\def\Ic{{\cal I}}
\def\Jc{{\cal J}}
\def\Kc{{\cal K}}
\def\Lc{{\cal L}}
\def\Mc{{\cal M}}
\def\Nc{{\cal N}}
\def\Oc{{\cal O}}
\def\Pc{{\cal P}}
\def\Qc{{\cal Q}}
\def\Rc{{\cal R}}
\def\Sc{{\cal S}}
\def\Tc{{\cal T}}
\def\Uc{{\cal U}}
\def\Vc{{\cal V}}
\def\Wc{{\cal W}}
\def\Xc{{\cal X}}
\def\Yc{{\cal Y}}
\def\Zc{{\cal Z}}
\def\defeq{荏翎汶蝈禧苣屐翎烬
\def\eg{{\it e.g.,\ \/}}
\def\etal{{\it et al. \/}}
\def\viz{{\it viz.,\ \/}}
\def\ie{{\it i.e.,\ \/}}
\def\nn{\nonumber}
\def\tcb{\textcolor{blue}}
\def\w{\textrm{w}}

\newcommand{\mbbE}{\mathbb{E}}
\newtheorem{theorem}{Theorem}
\newtheorem{lemma}{Lemma}
\newtheorem{proposition}{Proposition}
\newtheorem{problem}{Problem}
\newtheorem{subproblem}[problem]{Problem}

\begin{document}

\title{Residential Energy Storage Management with Bidirectional Energy Control }
\author{\IEEEauthorblockN {Tianyi Li, and Min Dong, \textit{Senior Member, IEEE}
\thanks{This work was supported by the National Sciences and Engineering Research Council of Canada under Discovery Grant RGPIN-2014-05181.}
\thanks{Tianyi Li was with Department of Electrical, Computer and Software Engineering, University of Ontario Institute of Technology, Oshawa, Ontario L1H 7K4, Canada. He is now with Huawei Technologies Co., Ltd, Markham, Ontario L3R 5A4, Canada (email: lty616@hotmail.com).}}
\thanks{Min Dong is with Department of Electrical, Computer and Software Engineering, University of Ontario Institute of Technology, Oshawa, Ontario L1H 7K4, Canada (email: min.dong@uoit.ca).}}
\markboth{IEEE Transactions on Smart Grid}{}
\maketitle


\begin{abstract}
We consider the residential energy storage management system with integrated renewable generation and the  availability of bidirectional energy flow from and to the grid through buying and selling. We  propose a real-time bidirectional energy control algorithm, aiming to minimize the net system cost from energy buying and selling as well as battery deterioration and storage inefficiency within a given time period, subject to the battery operational constraints and energy buying and selling constraints. We formulate the problem as a stochastic  control optimization problem. We then modify and transform this difficult problem into one that enables us to develop the real-time energy control algorithm through  Lyapunov optimization.
Our developed algorithm is applicable to arbitrary and unknown statistics of  renewable generation, load, and electricity prices. It provides a simple closed-form control solution based on only current system states, and requires a minimum complexity for real-time implementation. Furthermore, the   solution structure reveals how the battery energy level and energy prices  affect the energy flow direction and storage decision. The proposed algorithm possesses a bounded performance guarantee to that of the optimal non-causal $T$-slot look-ahead control policy.
Simulation shows the effectiveness of our proposed algorithm as compared with  alternative real-time and non-causal algorithms, and demonstrates the effect of selling-to-buying price ratio and battery inefficiency on the storage behavior and system cost.
\end{abstract}
\begin{IEEEkeywords}
Energy Storage, renewable generation, energy selling, home energy management, Lyapunov optimization, real-time control
\end{IEEEkeywords}

\section{Introduction} \label{sec:Introduction}

Energy storage and renewable energy integration are considered key solutions for  future power grid infrastructure and services to meet the fast rising energy demand and maintain energy sustainability \cite{dek10,CastilloGayme:Elsevier14}. For the grid operator, energy storage  can be exploited to shift energy across time to meet the demand and counter the fluctuation of intermittent renewable generation to improve grid reliability \cite{CastilloGayme:Elsevier14,SuGamal:TPS13,SunDongLiang:JSTSP14,SunLiangDongTaylor:TPS16,SunDongLiang:TSG16,ZhangGatsis_TSE13}. For the electricity  customer, local energy storage can provide means  for energy management to  control energy flow in response to the demand-side management signal and to reduce electricity cost. For example, dynamic pricing is one of main demand-side management techniques to relieve grid congestion \cite{Faruquietal:ElectrJ09,Wong&Sen&Ha&Chiang:JSAC2012}. Its effectiveness relies on the customer-side energy management solution to effectively control energy flow and demand in response to the price change. With local  renewable generation and energy storage introduced to residential and commercial customers, there are potentially greater flexibility in energy control  to respond to the dynamic pricing and demand fluctuation, as well as maximally harness the energy from renewable source to reduce electricity bills \cite{Wang&etal:TSG14,He&Zhang_TSG12,Li&Dong:JSAC15,Li&Dong:TSG16,Zhang&Schaar:JTSP14,MoghadamZhangMa:SGCOM14}.


With more local renewable generation at customers available, the utility retailer now allows customers to sell energy back to the utility at a price dynamically controlled by the utility in an attempt to harness energy from distributed renewable generation at customers and further improve stability and reliability \cite{ackermann2001overview}.   This means both renewable generation and previously stored energy, either bought from the grid or harnessed from the renewable source can be sold for profit by the customer. The ability to sell energy back to the grid enables bidirectional  energy flow between the energy storage system and the grid. This also gives the customer  a greater control capability to manage energy storage and usage    based on the dynamic pricing for both buying and selling. The repayment provides return for the  storage investment and further reduce the net cost at the customer. An intelligent energy  management solution exploring these features to    effectively manage storage and control the energy flow,  especially at a real-time manner, is  crucially needed to maximize the benefits.

Developing an effective energy management system faces many challenges. For the energy storage system itself, the renewable source is intermittent and   random, and its statistical characteristics over each day are often inheritably  time-varying, making it difficult to predict.
The benefit of storage, either for electricity supply or for  energy selling back,  also comes at the cost of battery operation that should not be neglected.
The bidirectional energy flow between the energy storage system and the grid under  dynamic pricing complicates  the energy control of the system when facing future uncertainty, and creates more challenges. More control decisions need to be made for energy flows  among storage battery, the grid, the renewable generation, and the load. The potential profit from energy selling under the unpredictable pricing complicates the control decisions  in terms of when and how much to sell, store, or use. Moreover, the battery capacity limitation further makes the control decisions coupled over time and difficult to
optimize. In this paper, we aim to develop a real-time energy control solution that  addresses these challenges and effectively reduces the net system cost at minimum required knowledge of unpredictable system dynamics.



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\subsection{Related Works}
Energy storage has been considered at the power grid operator or aggregator to combat the fluctuation of renewable generation, with many works in literature on storage control and assessment of its role in renewable generation \cite{CastilloGayme:Elsevier14}, for power balancing with fixed load \cite{SuGamal:TPS13,SunDongLiang:JSTSP14} or flexible load control \cite{ZhangGatsis_TSE13,SunDongLiang:TSG16}, and for phase balancing \cite{SunLiangDongTaylor:TPS16}. Residential energy storage systems to reduce electricity cost have been considered without renewable \cite{Urgaonkar&Neely:SIGMETRICS2011} and with renewable integration \cite{He&Zhang_TSG12,RahbarXu:TSG15,Wang&etal:TSG14,Huang&Walrand&Ramchandran:SmatGridComm12,
Sergio&Ming&Pan&Yong_TSG13,Li&Dong:ICASSP2013,Li&Dong:acssc2013,Li&Dong:SmartGridComm14,Li&Dong:JSAC15,Li&Dong:TSG16,Qinetal:TSG16}. Only energy buying was considered in these works.  Among them, off-line storage control  strategies for dynamics systems are proposed \cite{He&Zhang_TSG12,RahbarXu:TSG15,Wang&etal:TSG14}, where combined strategies of load prediction and day-ahead scheduling on respective large and small
timescales are proposed. The knowledge of load statistics  and renewable  generation are known ahead of time, while no battery operational cost are considered.


Real-time energy storage management amid unknown system dynamics is much more challenging. Assuming known distributions of system dynamics (\eg load, renewable generation, and prices), the storage control problem is formulated as a Markov Decision Process (MDP) and solved numerically using Dynamic Programming \cite{Zhang&Schaar:JTSP14,RahbarXu:TSG15}. However, this method suffers from high computational complexity to be implementable for practical systems.  In addition, due to unpredictable nature of system dynamics, the required statistics are difficult to acquire or predict in practice. Without the statistical knowledge of system dynamics, Lyapunov optimization technique \cite{book:Neely} has been employed to develop real-time control strategies in
\cite{Li&Dong:JSAC15,Li&Dong:TSG16,Huang&Walrand&Ramchandran:SmatGridComm12,Sergio&Ming&Pan&Yong_TSG13,Li&Dong:ICASSP2013,Li&Dong:acssc2013}. For independent and\ identically distributed  or stationary system dynamics (pricing, renewable, and load), energy control algorithms are proposed in \cite{Huang&Walrand&Ramchandran:SmatGridComm12,Sergio&Ming&Pan&Yong_TSG13} without considering battery operational cost, and in  \cite{Li&Dong:ICASSP2013}  with battery charging and discharging operational cost considered. All the above works  aim to minimize the long-term average system cost. A real-time energy control algorithm to minimize the system cost within a finite time period is designed in \cite{Li&Dong:JSAC15} for arbitrary system dynamics. Furthermore, joint storage control and flexible load scheduling is considered in \cite{Li&Dong:TSG16} where the closed-form sequential solution was developed  to minimize the system cost while meeting the load deadlines.

The idea of  energy selling back or trading  is considered in \cite{Kimetal:JSAC13,Mediwaththe&etal:TSG17,Huang&Mao&Nelms:J_SmartGrid2014}, where    \cite{Kimetal:JSAC13,Mediwaththe&etal:TSG17} focus on demand-side management via pricing schemes using game approaches for load scheduling among customers, and \cite{Huang&Mao&Nelms:J_SmartGrid2014} considers a microgrid operation and supply. In addition, although not explicitly modeled, the system considered in \cite{Qinetal:TSG16} can be generalized to include energy selling under a simplified model, provided that  buying and selling prices are constrained such that the overall cost function is still convex. All these works consider the grid level operation  and the cost associated with it, and use a simple battery storage model without  considering degradation or operational cost. Since the consumers may prefer a cost saving management solution in a customer-defined time period, and system dynamics may not be stationary, it is important to provide a cost-minimizing  solution to meet such need.  To the best of our knowledge, there is no such existing   bidirectional energy  management solution with energy selling-back capability. In addition, most existing works ignore battery inefficiency in charging and discharging, which results in energy loss that affects the storage behaviors and should be taken into account in the energy storage control design.

\subsection{Contributions}
In this paper, we consider a residential energy storage management system with integrated renewable generation and the availability of bidirectional energy flow from and to the grid through  buying and selling. We develop a real-time bidirectional energy  control algorithm,  aiming to minimize the net system cost in a finite time period, subject to the battery operational constraints and energy buying and selling constraints. In considering the system cost, we include the energy storage cost by carefully modeling both battery  operational cost and the inefficiency associated with charging/discharging activities. The system dynamics, including renewable generation, buying/selling electricity price, and the customer load, can have arbitrary distributions which may not be stationary, and are unknown to us.


We formulate the net system cost minimization as a stochastic optimization problem over a finite time horizon. The interaction of storage, renewable, and the grid as well as the cost associated with energy buying/selling and battery operation for storage complicate the energy control decision making and optimization over time. To tackle this difficult  problem, we use special techniques to modify and transform the original problem into one that we are able to apply Lyapunov optimization to develop a real-time  algorithm for the control solution. Our developed real-time    algorithm provides a simple closed-form energy control solution, which only relies on  the current battery energy level, pricing, load, and renewable generation. It has a minimum complexity for real-time implementation. In addition, the closed-form expression  reveals how the battery energy level and prices  affect the decisions of energy buying and selling, storage and usage of the battery, and the priority order  for storing or selling energy  from multiple energy sources. Through analysis, we show that the performance of our proposed real-time algorithm is within a bounded gap to that of the optimal $T$-slot look-ahead solution which has full  system information available ahead of time. The algorithm is also shown to be asymptotically optimal as the battery capacity and the time duration go to infinity.   Simulation results demonstrate the effectiveness
of our proposed algorithm as compared with alternative real-time or non-causal control solutions. Furthermore, we provide simulation studies  to  understand the effects of bidirectional energy control, the selling and buying price ratio, and battery efficiency on the energy storage behavior and the system cost.


\subsection{Organization and Notations} The rest of this paper is organized as follows. In Section\ref{sec:model}, we describe the bidirectional energy storage and management system model. In Section\ref{sec:FHA}, we formulate the  stochastic energy control optimization problem  and develop an approach to transform it  for the real-time control design. In Section\ref{sec:RT alg}, we present our real-time energy control algorithm. In Section\ref{sec:PA}, we analyze the performance of our algorithm. Simulation results are provided in Section\ref{sec:sim}, and followed by conclusion in Section\ref{sec:conclusion}.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\emph{Notations}:
The main symbols used in this paper are summarized in Table \ref{tab:num}.
\begin{table}[t]
\renewcommand{\arraystretch}{1.4}
\centering
\caption{List of main symbols}\label{tab:num}
\begin{tabular}{p{0.7cm}| p{7.1cm}}
\hline\hline
$W_t$ & customer load at time slot $t$\\
\hline
$S_t$ & renewable generation at time slot $t$ \\
\hline
$S_{w,t}$ &  portion of renewable energy serving load $W_t$ at time slot $t$\\
\hline
$S_{c,t}$ & portion of renewable energy sold to grid at time slot $t$\\
\hline
$S_{s,t}$ & portion of renewable energy stored to battery at time slot $t$\\
\hline
$E_t$ & energy bought from conventional grid at time slot $t$ \\
\hline
$Q_t$ & portion of $E_t$ stored into battery at time slot $t$\\
\hline
$F_{d,t}$ & amount of energy from battery serving load $W_t$ at time slot $t$\\
\hline
$F_{s,t}$ & amount of energy from battery sold to grid at time slot $t$\\
\hline
$P_{b,t}$ & energy unit buying price from conventional grid at time slot $t$\\
\hline
$P_{s,t}$ & energy unit selling price to conventional grid at time slot $t$\\
\hline
$B_t$ & battery energy level at time slot $t$\\
\hline
$x_{e,t}$ & entry cost for battery usage at time slot $t$:\newline  $x_{e,t}= 1_{R,t}C_{\textrm{rc}}+1_{D,t}C_{\textrm{dc}}$\\
\hline
$x_{u,t}$ &  net change of battery energy level  in time slot $t$:\newline $x_{u,t}=
\left|Q_t+S_{r,t}-D_t\right|$\\
\hline
$\abf_t$ & control actions at time slot $t$:\newline $\abf_t\triangleq[E_t,Q_t,F_{d,t},F_{s,t},S_{c,t},S_{s,t}]$\\
\hline
$\mubf_t$ & system inputs  at time slot $t$: $\mubf_t\triangleq[W_t,S_t,P_{b,t},P_{s,t}]$\\
\hline
$\overline{x_e}$ & average entry cost for battery usage over  $T_o$ slots\\
\hline
$\overline{x_u}$ & average net change of battery energy level over  $T_o$  slots\\
\hline
$\overline{J}$ & average cost of buying energy from the grid over $T_o$ slots \\
\hline
$C(\cdot)$ & average usage cost function  of the battery\\
\hline
$T_o$ & time period in slots considered for system cost minimization \\
\hline
$\eta_c$ & battery charging efficiency factor\\
\hline
$\eta_d$ & battery discharging efficiency factor\\
\hline
$R_{\max}$ & maximum charging amount into the battery\\
\hline
$D_{\max}$ & maximum discharging amount from the battery\\
\hline
$\Gamma$ & $\max\{\eta_cR_{\max},D_{\max}/\eta_d\}$ \\
\hline
$B_{\min}$ & minimum energy required in battery\\
\hline
$B_{\max}$ & maximum energy allowed in battery\\
\hline
$C_{\textrm{rc}}$ & entry cost for battery usage due to each charging activity\\
\hline
$C_{\textrm{dc}}$ & entry cost for battery usage due to each discharging activity\\
\hline
$\Delta_a$ & desired change amount of battery energy level in $T_o$ slots\\
\hline\hline
\end{tabular}
\end{table}


\section{System Model} \label{sec:model}
We consider a residential-side energy storage  management (ESM) system as shown in Fig.\ref{fig:sellingback_model}. The system contains an energy storage battery which is connected to an on-site renewable generator (RG) and the conventional grid (CG). Energy can be charged into the battery from both the RG and the CG, discharged from the battery for customer electricity demand, or sell back to the CG. Both the RG and the CG can   directly supply energy to the customer. We assume the ESM system operates in discrete time slots with $t\in \{1,2,\cdots\}$, and all energy control operations are performed per time slot $t$.
\begin{figure}[t]
\centerline{
\begin{psfrags}
    \psfrag{C1}{\normalsize $(P_{b,t})$}
    \psfrag{C2}[c]{\normalsize $(P_{s,t})$}
    \psfrag{P}{\normalsize ${E_t}$}
    \psfrag{S}{\normalsize ${S_t}$}
    \psfrag{PQ}{\normalsize ${E_t-Q_t}$}
    \psfrag{FS}{\normalsize ${F_{s,t}+S_{s,t}}$}
    \psfrag{Q}{\normalsize ${Q_t}$}
    \psfrag{S1}{\normalsize ${S_{w,t}}$}
    \psfrag{S2}{\normalsize ${S_{c,t}}$}
    \psfrag{S3}{\normalsize ${S_{s,t}}$}
    \psfrag{F1}{\normalsize ${F_{d,t}}$}
    \psfrag{F2}{\normalsize ${F_{s,t}}$}
    \psfrag{W}{\normalsize ${W_t}$}
    \psfrag{X}{\normalsize $+$}
    \psfrag{K}{\normalsize $+$}
    \psfrag{O}{\normalsize $-$}
    \psfrag{Y}{\normalsize $-$}
    \psfrag{Renew.}{\normalsize RG}
    \psfrag{Grid}{\normalsize CG}
    \psfrag{Battery}{\small Battery}
    \psfrag{Contrl}{\small Control}
    \psfrag{User}{\normalsize Load}
    \includegraphics[width=0.9\linewidth]{model5}
\end{psfrags}
}
\caption{An ESM system with RG and bidirectional energy flow from/to CG.}
\label{fig:sellingback_model}
\end{figure}
\subsubsection{RG} Let $S_t$ be the amount of energy harvested from the RG at time slot $t$. Due to the uncertainty of the renewable source, $S_t$ is random. We assume no prior knowledge of $S_t$ or its statistics.
 Let  $W_t$ be the customer load at time slot $t$. We assume a priority of using $S_t$  to directly serve $W_t$. Let $S_{w,t}$ be this portion of $S_t$ at time slot $t$. We have $S_{w,t}=\min\{W_t,S_t\}$. A controller will determine whether the remaining portion, if any,  should be stored into the battery and/or sold back to the CG. We denote the stored amount and sold amount by $S_{c,t}$ and $S_{s,t}$, respectively, satisfying
\begin{align}
S_{c,t}+S_{s,t}\in[0,S_t-S_{w,t}]\label{eqn:Solar S2 S3 bounds}.
\end{align}
\subsubsection{CG} The customer can buy energy from or sell energy to the CG at real-time unit  buying price $P_{b,t}\in[P_{b}^{\min}, P_{b}^{\max}]$ and selling price $P_{s,t} \in [P_{s}^{\min}, P_{s}^{\max}]$, respectively. Both $P_{b,t}$ and $P_{s,t}$ are known at time slot $t$. To avoid energy arbitrage,
the buying price is strictly greater than the selling price at any time, \ie\  $P_{b,t}>P_{s,t}$. Let $E_t$ denote the amount of energy bought from the CG at time slot $t$. Let $Q_t$ denote the portion of $E_t$ that is stored into the battery. The remaining portion $E_t-Q_t$  directly  serves the customer load. Let $F_{s,t}$ denote the amount of energy  from the battery that is sold back to the CG. The total energy sold  from the battery and the RG is bounded by
\begin{equation}
\label{equ:Et_constraint}
F_{s,t}+S_{s,t} \in[0,U_{\max}]
\end{equation}
where $U_{\max}$ is the maximum amount of energy that can be sold back to the CG\footnote{This amount may be regulated by the utility.}.

Note that while  $S_{s,t}$ from the RG can be sold back to the CG at any time, energy buying from or selling  to the CG should not happen at the same time to avoid energy arbitrage, which is ensured by the constraint $P_{b,t}>P_{s,t}$. With this constraint, we expect the following condition to be satisfied
\begin{equation}
\label{equ:sell buy constraint}
E_t\cdot F_{s,t}=0.
\end{equation}
We will verify that our proposed algorithm satisfies \eqref{equ:sell buy constraint} in Section\ref{sec:PA}. 



%%%%%%%%%%%%%%%%%%%%%
\subsubsection{Battery Storage} The battery operation for storage  causes the battery to deteriorate, contributing to the storage cost that has been ignored in many prior works. We model battery charging and discharging activities and the degradation cost associate to them as follows.

i) {\bf Storage operation}: The battery can be charged from multiple sources (\ie the CG and the RG) at the same time.
The total charging amount at time slot $t$ should satisfy
\begin{align}
S_{c,t}+Q_t\in[0,R_{\max}]\label{eqn:rc_bds}
\end{align}
where $R_{\max}$ is the maximum charging amount per time slot. Similarly, energy stored in the battery can be used to either serve the customer load and/or sell back to the CG. Let $F_{d,t}$ denote the amount of energy from the battery used to serve the customer at time slot $t$.
The total amount of energy discharged is bounded by
\begin{equation}
\label{eqn:dc_bds}
F_{d,t}+F_{s,t}\in[0,D_{\max}]
\end{equation}
where $D_{\max}$ is the maximum discharging amount per time slot. We assume that there is no simultaneous charging and discharging, \ie
\begin{align} \label{eqn:rc_dc_constr}
(S_{c,t}+Q_t)\cdot(F_{d,t}+F_{s,t})= 0.
\end{align}
Let $B_t$ be the battery energy level at time slot $t$, bounded by
\begin{equation} \label{eqn:Yt bds}
 B_t\in [B_{\min}, B_{\max}]
\end{equation}
where $B_{\min}$ and $B_{\max}$ are the minimum  energy required and maximum energy allowed in the battery, respectively, whose values depend on the battery type and capacity. Based on charging and discharging activities and taking the battery charging/discharging inefficiency into account, $B_t$ evolves over time as
\begin{equation}
\label{eqn:dynamics of SOB}
B_{t+1}=B_t+\eta_c(S_{c,t}+Q_t)-(F_{d,t}+F_{s,t})/\eta_d
\end{equation}
where $\eta_c$ and $\eta_d$ denote the battery charging and discharging efficiency factors, respectively, with $\eta_c,\eta_d\in[0,1]$.

Finally, the demand-and-supply balance requirement is given by
\begin{equation}
\label{eqn:Wt_constraint}
W_t=E_t-Q_t+S_{w,t}+F_{d,t}.
\end{equation}

ii) {\bf Battery degradation cost}:
It is well known that frequent charging/discharging activities cause a battery to degrade \cite{Ramadrass:JPS02}.  We model two types of battery degradation cost:  \emph{entry cost} and \emph{usage cost}. The entry cost is a fixed cost incurred due to each charging or discharging activity.  Define two indicator functions to represent charging and discharging activities: ${1_{R,t}=\{1: \textrm{if}\ Q_t+S_{c,t}>0; \; 0: \textrm{otherwise}\}}$ and ${1_{D,t}=\{1: \textrm{if}\ F_{d,t}+F_{s,t}>0; \; 0: \textrm{otherwise}\}}$. Denote the entry cost for charging by $C_{\textrm{rc}}$ and that for discharging by $C_{\textrm{dc}}$. The entry cost for battery usage at time slot $t$ is given by $x_{e,t}\triangleq 1_{R,t}C_{\textrm{rc}}+1_{D,t}C_{\textrm{dc}}$.

The battery usage cost is the cost associated with the charging/discharging amount. Define the net change of battery energy level  at time slot $t$ by  $x_{u,t}\defeq
\left|\eta_c(Q_t+S_{c,t})-(F_{d,t}+F_{s,t})/\eta_d\right|$. From \eqref{eqn:rc_bds} and \eqref{eqn:dc_bds}, it follows that $x_{u,t}$ is bounded by
\begin{align} \label{eqn:x_2}
x_{u,t} \in [0, \Gamma]
\end{align}
where $\Gamma\triangleq \max\{\eta_cR_{\max},D_{\max}/\eta_d\}$.\footnote{Accurate modeling of the battery deterioration due to charging and discharging activities is a challenging problem. Some recent work provides more detailed study on practical modeling of deterioration due to battery operation \cite{Shi&etal:ArXiv2017}.} It is known that typically faster charging/discharging, \ie larger $x_{u,t}$, has a more detrimental effect on the life time of the battery. Thus, we assume the associated cost function for usage $x_{u,t}$, denoted by $C(\cdot)$, is a continuous, convex, non-decreasing function with maximum derivative $C'(\cdot)<\infty$.

\allowdisplaybreaks

\section{ Problem Formulation}\label{sec:FHA}
For the ESM system, the system cost includes the energy buying cost minus selling profit and the battery degradation cost. Within a pre-defined $T_o$-slot time period, the average net cost of energy buying and selling  over the CG  is given by  $\overline{J}\defeq \frac{1}{T_o}\sum_{t=0}^{T_o-1}E_tP_{b,t}-(F_{s,t}+S_{s,t})P_{s,t}$. For the battery operation, the average entry cost and average net change over the $T_o$-slot period are respectively given by
\begin{align} \label{time-avg}
\overline{x_e}
&\triangleq
\frac{1}{T_o}\sum_{t=0}^{T_o-1}x_{e,t}, \quad
\overline{x_u}
\triangleq
\frac{1}{T_o}\sum_{t=0}^{T_o-1}x_{u,t}
\end{align}
where by \eqref{eqn:x_2}, $\overline{x_u}$ is bounded by
%\footnote{Note that tighter bounds can be obtained depending on different initial capacity value or total capacity of the battery and the length of $T_o$.}
\begin{align}
\label{eqn:avg_rc_dc_bds}
\overline{x_u}\in [0, \Gamma],
\end{align}
and the battery average usage cost is $C(\overline{x_u})$. Thus, the average battery degradation cost over the $T_o$-slot period is  $\overline{x_e}+C(\overline{x_u})$.

Denote the system inputs by $\mubf_t\triangleq[W_t,S_t,P_{b,t},P_{s,t}]$ and the control actions for energy storage management by $\abf_t\triangleq[E_t,Q_t,F_{d,t},F_{s,t},S_{c,t},S_{s,t}]$ at time slot $t$. With only current input  $\mubf_t$ known, our objective is to determine a control policy $\{\pi_t\}$ for  $\abf_t$ (\ie a mapping $\pi_t:\mubf_t\rightarrow \abf_t$, $t=0,\ldots,T_o-1$.) to minimize the average system cost within the $T_o$-slot period. This is a stochastic control optimization problem and is formulated by
\begin{align}
\textrm{\bf P1:}\; &\min_{\{\pi_t\}_{t=0}^{T_o-1}} \;\;
\overline{J}+\overline{x_e}+C(\overline{x_u})\nn\\
\rm{s.t.} \;\;&
\eqref{eqn:Solar S2 S3 bounds},\eqref{equ:Et_constraint},\eqref{eqn:rc_dc_constr},\eqref{eqn:Wt_constraint},\eqref{eqn:avg_rc_dc_bds},\textnormal{and} \nonumber\\
&0\leq S_{c,t}+Q_t\leq \min\left\{R_{\max},(B_{\max}-B_t)/\eta_c\right\}\label{eqn:rc_bds_strict}\\
&0\leq F_{d,t}+F_{s,t} \leq \min\{D_{\max},\eta_d(B_t-B_{\min})\}\label{eqn:dc_bds_strict}
\end{align}
where constraints \eqref{eqn:rc_bds_strict} and \eqref{eqn:dc_bds_strict} are the derived results of  constraints \eqref{eqn:rc_bds}--\eqref{eqn:dynamics of SOB}.

{\bf  P1} is a difficult stochastic  optimization problem due to the finite time period and the correlated control actions \{$\abf_t$\} over time as a result of time-coupling dynamics of $B_t$ in  \eqref{eqn:dynamics of SOB}. Furthermore, the input distributions in\ $\mubf_t$ are unknown. The optimal control policy is difficult to obtain. Instead, we develop a real-time  algorithm for  control action $\abf_t$ over time which provides a suboptimal solution for {\bf P1} with  the cost objective being reduced as small as possible. In the following, we fist summarize our approach and technique to develop this real-time algorithm and then present details.


\subsection{Summary of Our Approach}
We develop  our real-time algorithm for {\bf P1} using    the technique of Lyapunov optimization \cite{book:Neely}, which is powerful to design dynamic control. However, to use Lyapunov optimization, the problem needs to have time-averaged objective function and constraints, which is not the case for {\bf P1}. To overcome these difficulties, we first modify {\bf P1} and then transfer the modified problem to an equivalent problem {\bf P3} that belongs to the class of stochastic optimization problem that Lyapunov optimization technique can be applied to. Then, using Lyapunov technique, we develop our real-time algorithm to determine control action $\abf_t$ for {\bf P3}. Our algorithm is to solve a per-slot opportunistic optimization problem {\bf P4} for $\abf_t$ at each time slot $t$, for which the  solution is presented in Section\ref{sec:RT alg}. Finally, since $\{\abf_t\}$ is obtained for {\bf P3}, we design parameters of our algorithm in Section\ref{subsec:feasibility} to ensure that it is also feasible to the original problem {\bf P1}.



\subsection{Problem Modification and Transformation}
\subsubsection{Modification}
To make {\bf P1} tractable, we first  remove the coupling of control actions over time by modifying the constraints  \eqref{eqn:rc_bds_strict} and \eqref{eqn:dc_bds_strict} on the per-slot charging and discharging amounts. We set the  change of $B_t$ over the $T_o$-slot period, \ie $B_{T_o}-B_0$, to be a desired value $\Delta_a$. From \eqref{eqn:dynamics of SOB}, this means
\begin{align}
\label{eqn:delta_a}
\frac{1}{T_o}\sum_{\tau=0}^{T_o-1}\left[\eta_c(Q_\tau+S_{r,\tau})-(F_{d,\tau}+F_{s,\tau})/\eta_d\right]=\frac{\Delta_a}{T_o}
\end{align}
where by \eqref{eqn:rc_bds}\eqref{eqn:dc_bds}\eqref{eqn:Yt bds}, we have $|\Delta_a|\leq\Delta_{\max}$, with $\Delta_{\max} \triangleq \min\{B_{\max}-B_{\min}, T_o\max\{\eta_cR_{\max},D_{\max}/\eta_d\}\}$. We now modify {\bf P1} to the follow optimization problem
\begin{align}
\textrm{\bf P2:}\; &\min_{\{\pi_t\}_{t=0}^{T_o-1}} \;\;%\overline{y_0}+f(\overline{x})\triangleq
\overline{J}+\overline{x_e}+C(\overline{x_u})\nn\\
\rm{s.t} \;\;
&\eqref{eqn:Solar S2 S3 bounds},\eqref{equ:Et_constraint},\eqref{eqn:rc_bds}, \eqref{eqn:dc_bds}, \eqref{eqn:rc_dc_constr},\eqref{eqn:Wt_constraint},\eqref{eqn:avg_rc_dc_bds},\eqref{eqn:delta_a}.\nn
\end{align}

From {\bf P1} to {\bf P2}, by imposing the new constraint \eqref{eqn:delta_a}, we remove the dependency of per-slot charging/discharging amount on $B_t$ in constraints \eqref{eqn:rc_bds_strict} and \eqref{eqn:dc_bds_strict}, and replace them by \eqref{eqn:rc_bds} and \eqref{eqn:dc_bds},  respectively.

We point out that $\Delta_a$ in \eqref{eqn:delta_a} is  only a desired value we set in {\bf P2}. For a feasible control algorithm for  {\bf P1}, only the constraints in {\bf P1} need to be satisfied. Thus, our designed control algorithm may not satisfy  constraint \eqref{eqn:delta_a}  at the end of $T_o$-slot period.\footnote{We use {\bf P2} as an intermediate step to design the control algorithm for {\bf P1}. Thus, the proposed algorithm provides an approximate solution for {\bf P2} that may not satisfy \eqref{eqn:delta_a}.} This point is further discussed in Section\ref{subsec:feasibility}, and in Section\ref{sec:PA}, we will quantify the amount of mismatch with respect to $\Delta_a$ under our proposed control algorithm.

\subsubsection{Problem Transformation}
The objective of {\bf P2} contains   $C(\overline{x_u})$ which is a cost function of a time-averaged net change $\overline{x_u}$. Directly dealing with such function is difficult. Adopting the technique introduced in \cite{Neely:ArXiv2010}, we transform the problem to one that contains the time-averaged  function. To do so, we introduce an auxiliary variable $\gamma_t$ and its time average  $\overline{\gamma}\defeq \frac{1}{T_o}\sum_{\tau=0}^{T_o-1}\gamma_t$ satisfying
\begin{align}
&\gamma_t \in [0, \Gamma], \ \forall t\label{eqn:gamma_bds}\\
&\overline{\gamma}=\overline{x_u}. \label{avg_r=avg_x}
\end{align}
These constraints ensure that the auxiliary variable $\gamma_t$ and $x_{u,t}$ lie in the same range and have the same time-averaged behavior. Define $\overline{C(\gamma)}\triangleq \frac{1}{T_o}\sum_{t=0}^{T_o-1}C(\gamma_t)$
as the time average of $C(\gamma_t)$.  By using $\gamma_t$ instead of $x_{u,t}$, we replace constraint \eqref{eqn:avg_rc_dc_bds} with \eqref{eqn:gamma_bds} and \eqref{avg_r=avg_x}, and transform  {\bf P2} into the following  problem which is to optimize the control policy $\{\pi_t'\}$ for $(\gamma_t,\abf_t)$ (\ie $\pi_t':\mubf_t\rightarrow (\gamma_t,\abf_t)$, $t=0,\ldots,T_o-1$) to minimize the $T_o$-slot time average of system cost
\begin{align}
\textrm{\bf P3:}\; &\min_{\{\pi_t'\}_{t=0}^{T_o-1}} \;\;
\overline{J}+\overline{x_e}+\overline{C(\gamma)}\nn\\
\rm{s.t} \;\;
&\eqref{eqn:Solar S2 S3 bounds},\eqref{equ:Et_constraint},\eqref{eqn:rc_bds}, \eqref{eqn:dc_bds}, \eqref{eqn:rc_dc_constr},\eqref{eqn:Wt_constraint},\eqref{eqn:delta_a},\eqref{eqn:gamma_bds},\eqref{avg_r=avg_x}. \nonumber
\end{align}

It can be shown that {\bf P2} and {\bf P3} are equivalent problems (see Appendix\ref{appA}).
The modification and transformation from {\bf P1} to {\bf P3} has enabled us to utilize Lyapunov optimization techniques  \cite{book:Neely} to design real-time control policy to solve {\bf P3}.


\subsection{Real-Time Control via Lyapunov Optimization}

To design a real-time algorithm, in Lyapunov optimization, virtual queue is introduced for each time-averaged constraint, and Lyapunov drift for the queues is defined. It is shown that keeping the stability of each queue is equivalent to satisfying the constraint \cite{book:Neely}. Thus, instead of the original cost objective in the optimization problem, a drift-plus-cost metric is considered  in Lyapunov optimization and real-time algorithm is developed to minimize this metric. In the following, we develop our algorithm using this technique.

\subsubsection{Virtual queues}
Based on the Lyapunov framework, we introduce two virtual queues $Z_t$ and $H_t$ for time-averaged constraints \eqref{eqn:delta_a} and \eqref{avg_r=avg_x}, respectively, as
\begin{align}
Z_{t+1}&=Z_t+\eta_c(Q_t+S_{c,t})-(F_{d,t}+F_{s,t})/\eta_d-\frac{\Delta_a}{T_o}, \label{eqn:queue Z}\\
H_{t+1}&=H_t+\gamma_t-x_{u,t}. \label{eqn:queue H}
\end{align}
From \eqref{eqn:dynamics of SOB} and \eqref{eqn:queue Z}, $Z_t$ and $B_t$ have the following relation
\begin{align}\label{eqn:dynamic shift Z}
Z_t=B_t-A_t
\end{align}
where $A_t\defeq A_o+\frac{\Delta_a}{T_o}t$ in which  $A_o$ is a constant shift and $\frac{\Delta_a}{T_o}t$  ensures that the left hand side equality in \eqref{eqn:delta_a} is satisfied.
We will revisit the value of $A_o$ to  ensure a feasible solution for {\bf P1}.

\subsubsection{Lyapunov drift}
Define $\Thetabf_t\triangleq[Z_t, H_t]$. Define the quadratic Lyapunov function  $L(\Thetabf_t)\triangleq\frac{1}{2}(Z_t^2+H_t^2)$. Divide $T_o$ slots into $M$ sub-frames of $T$-slot duration as $T_o=MT$, for  $M,T\in \mathbb{N}^+$. We define a one-slot sample path Lyapunov drift as $\Delta(\Thetabf_t)\triangleq L\left(\Thetabf_{t+1}\right)-L(\Thetabf_{t})$, which only depends on the current system inputs $\mubf_t$.


\subsubsection{Drift-plus-cost metric}
We define a drift-plus-cost metric which is a weighted sum of the drift $\Delta(\Thetabf_t)$ and the system cost  at current time slot $t$, given by
\begin{align}\label{drift_cost_metric}
\hspace{-.5em}\Delta(\Thetabf_t)+V[E_tP_{b,t}-(F_{s,t}+S_{s,t})P_{s,t}+x_{e,t}+C(\gamma_t)]
\end{align}
where constant $V>0$ sets the relative weight between the drift and the system cost.In Lyapunov optimization, instead of minimizing the system cost objective in {\bf P3},  we aim to minimize this drift-to-cost metric. However, directly using this metric to design a control policy is still difficult.
Instead, we obtain an upper bound on the drift $\Delta(\Thetabf_t)$, which will be used for designing our  real-time control algorithm.
\begin{lemma}\label{lemma drift upper bound}
Lyapunov drift $\Delta(\Thetabf_t)$ is upper bounded by
\begin{align}\label{eqn:drift delta 1}
\Delta(\Thetabf_t)\leq&\
Z_t\left(E_t+S_{c,t}+S_{w,t}-W_t-F_{s,t}-\frac{\Delta_a}{T_o}\right)\nn\\
&+H_t\gamma_t-g(H_t)(E_t+S_{c,t}+l_t)+G
\end{align}
where $G \triangleq\frac{1}{2}\max\left\{(\eta_cR_{\max}-\frac{\Delta_a}{T_o})^2, (D_{\max}/\eta_d+\frac{\Delta_a}{T_o})^2\right\} +\frac{1}{2}\Gamma^2$, and
\begin{align}
g(H_t) &\triangleq \begin{cases}\eta_cH_t & H_t \ge 0 \\ H_t/\eta_d & H_t <0 \end{cases} \label{g(Ht)}\\
l_t & \triangleq \text{sgn}(H_t)(S_{w,t}-W_t-F_{s,t})
\end{align}
where $\text{sgn}(\cdot)$ is the sign function.
\end{lemma}
\IEEEproof
See Appendix \ref{app drift upper bound}.
\endIEEEproof

By Lemma\ref{lemma drift upper bound}, an upper bound on the per-slot drift-plus-cost metric in \eqref{drift_cost_metric} is readily obtained. In the following, we use this upper bound to develop a real-time control algorithm.


\section{Real-Time Bidirectional  Control Algorithm}\label{sec:RT alg}
We now propose our real-time control algorithm  to minimize the upper bound on the drift-plus-cost metric \emph{per slot}.
Removing all the constant terms in the upper bound of the drift-plus-cost metric that are independent of $\abf_t$ and $\gamma_t$, we have the equivalent optimization problem which can be further separated into two sub problems for $\gamma_t$ and $\abf_t$, respectively, as follows
\begin{align}
 \text{\bf P4}_a:\; &\min_{\gamma_t}
\quad H_t\gamma_t+VC(\gamma_t)
\quad \textrm{s.t.} \;\; \eqref{eqn:gamma_bds}.\nn\\
\text{\bf P4}_b:\; &\min_{\abf_t}
  \quad
E_t(Z_t-g(H_t)+VP_{b,t})+S_{c,t}(Z_t-g(H_t))\nn\\
  &\quad -F_{s,t}(Z_t-|g(H_t)|+VP_{s,t})-S_{s,t}VP_{s,t}+Vx_{e,t} \nn\\
  &\textrm{s.t.} \quad
    \eqref{eqn:Solar S2 S3 bounds},\eqref{equ:Et_constraint},\eqref{eqn:rc_bds},\eqref{eqn:dc_bds},\eqref{eqn:rc_dc_constr},\eqref{eqn:Wt_constraint},\eqref{eqn:delta_a}.\nn
\end{align}


First, we solve $\text{\bf P4}_a$ to obtain the optimal solution $\gamma_t^*$.
Note that $\text{\bf P4}_{a}$ is convex for $C(\cdot)$ being convex. Thus, we can directly solve it and  obtain the optimal  $\gamma^*_t$  of $\text{\bf P4}_a$.
\begin{lemma}\label{lemma33}
The optimal solution $\gamma^*_t$ of $\text{\bf P4}_a$ is given by
\begin{align}
\label{eqn:optimal gamma}
\gamma^*_t=
    \begin{cases}
        0&\text{if}\ H_t\geq 0\\
        \Gamma& \text{if}\ H_t< -VC'(\Gamma)\\
        C'^{-1}\left(-\frac{H_t}{V}\right)&\text{otherwise}
    \end{cases}
\end{align}
where $C'(\cdot)$ is the first derivative of $C(\cdot)$, and $C'^{-1}(\cdot)$  the inverse function of $C'(\cdot)$.
\end{lemma}
\IEEEproof
See Appendix\ref{app:lemma33}.
\endIEEEproof


Next, we obtain the optimal $\abf_t^*$ of $\text{\bf P4}_{b}$ and provide the conditions under which  $\abf_t^*$ is feasible to {\bf P1}.

\subsection{The Optimal Control $\abf^*_t$  for $\text{\bf P4}_{b}$}
Denote the objective function of $\text{\bf P4}_{b}$ by $J(\abf_t)$.
Define the \emph{idle state} of the battery as the state where there is no charging or discharging activity. The control decision in the idle state is given by $\abf_t^\textrm{id}=[E_t^\textrm{id}, Q_t^\textrm{id},F_{d,t}^\textrm{id},F_{s,t}^\textrm{id},S_{c,t}^\textrm{id},S_{s,t}^\textrm{id}]$, where $E_t^\textrm{id}=W_t-S_{w,t}$, $Q_t^\textrm{id}=F_{d,t}^\textrm{id}=F_{s,t}^\textrm{id}=S_{c,t}^\textrm{id}=0$, and $S_{s,t}^\textrm{id}=\min\{S_t-S_{w,t},U_{\max}\}$. Then, in the idle state, we have
$J(\abf_t^\textrm{id})= (W_t-S_{w,t})(Z_t-g(H_t)+VP_{b,t})-VP_{s,t}\min\{S_t-S_{w,t},U_{\max}\}$.
We derive the optimal control decision $\abf_t^*=[E_t^*,Q_t^*,F_{d,t}^*,F_{s,t}^*,S_{c,t}^*,S_{s,t}^*]$   in five cases in Proposition\ref{prop0} below.
Define $[a]^+\triangleq \max\{a,0\}$.
\begin{proposition}\label{prop0}
 Define $(S_{c,t}^\text{a},S_{s,t}^\text{a})$  as follows:
 If $VP_{s,t}\ge {g(H_t)-Z_t}$: $S^\text{a}_{s,t}\triangleq \min\{S_t-S_{w,t},U_{\max}\}$,  $S^\text{a}_{c,t}\triangleq\min\{S_t-S_{w,t}-S^\text{a}_{s,t},R_{\max}\}$;  Otherwise, $S^\text{a}_{c,t}\triangleq\min\{S_t-S_{w,t},R_{\max}\}$,  $S^\text{a}_{s,t}\triangleq\min\{S_t-S_{w,t}-S^\text{a}_{c,t},U_{\max}\}$.

Denote $\abf_t^\w=[E_t^\w,Q_t^\w,F_{d,t}^\w,F_{s,t}^\w,S_{c,t}^\w,S_{s,t}^\w]$ as the control decision in the charging or discharging state.  The optimal control solution $\abf^*_t$ for $\bf \text{\bf P4}_b$ is given in the following cases:\newcounter{qcounter}
\begin{list}{{\it \arabic{qcounter}$\left.\right)$}}
{\usecounter{qcounter}
\setlength\leftmargin{1.5em}
\setlength\labelwidth{2em}
\setlength\labelsep{0em}
\setlength\itemsep{.5em}
}

\item {\it For $Z_t-g(H_t)+VP_{b,t}\leq 0$}: The battery is in either the charging state or the idle state. Let
    \begin{align}\label{case a}
        \hspace*{-0.5em}\begin{cases}
        F^\w_{d,t}=F^\w_{s,t}=0,\ S^\w_{c,t}=S^\text{a}_{c,t},\ S^\w_{s,t}=S^\text{a}_{s,t}\\
        Q^\w_t=R_{\max}-S^\w_{c,t} \\
        E^\w_t=W_t-S_{w,t}+R_{\max}-S^\w_{c,t}.
        \end{cases}
  \end{align}
Then, $\abf^*_t=\arg\min_{\abf_t\in\{\abf_t^\w,\abf_t^\textrm{id}\}} J(\abf_t)$.



\item{\it For $\max\{Z_t-g(H_t),Z_t-|g(H_t)|+VP_{s,t}\}<0\leq Z_t-g(H_t)+VP_{b,t}$}: The battery is in either the charging state (from the RG only), the discharging state (to the customer load only), or the idle state. Let
  \begin{align}\label{case c}
      \begin{cases}
      F^\w_{d,t}=\min\{W_t-S_{w,t},D_{\max}\}\\
      F^\w_{s,t}=Q^\w_t=0,\ S^\w_{c,t}=S^\text{a}_{c,t},\ S^\w_{s,t}=S^\text{a}_{s,t}\\
      E^\w_t=[W_t-S_{w,t}-D_{\max}]^+.
      \end{cases}
  \end{align}
Then, $\abf^*_t=\arg\min_{\abf_t\in\{\abf_t^\w,\abf_t^\textrm{id}\}} J(\abf_t)$.

\item{\it For $Z_t-g(H_t)\le 0\le Z_t-|g(H_t)|+VP_{s,t}$}: The battery is  in either the charging state (from the RG only), the discharging state, or the idle state. Define  $\abf_t^\text{dc}$ in the discharging state as
  \begin{align}\label{case d 2}
\hspace*{-.5em}
      \begin{cases}
      F^\text{dc}_{d,t}=\min\{W_t-S_{w,t},D_{\max}\}\\
      S^\text{dc}_{s,t}=\min\{S_t-S_{w,t},U_{\max}\} \\
      F^\text{dc}_{s,t}=\min\{D_{\max}-F^\text{dc}_{d,t},U_{\max}-S^\text{dc}_{s,t}\}\\
      S^\text{dc}_{c,t}=Q^\text{dc}_t=0, \ E^\text{dc}_t=[W_t-S_{w,t}-D_{\max}]^+;
      \end{cases}
  \end{align}
Define $\abf_t^\text{rc}$ in the charging state as
  \begin{align}\label{case d 3}
\hspace*{-.5em}
      \begin{cases}
      F^\text{rc}_{d,t}=F^\text{rc}_{s,t}=Q^\text{rc}_t=0 \ \\
      S^\text{rc}_{c,t}=S^\text{a}_{c,t}, \ S^\text{rc}_{s,t}=S^\text{a}_{s,t}\\
      E^\text{rc}_t= W_t-S_{w,t}.
      \end{cases}
  \end{align}
Then, $\abf^*_t=\arg\min_{\abf_t\in\{\abf_t^\text{rc},\abf_t^\text{dc},\abf_t^\textrm{id}\}} J(\abf_t)$.

\item{\it For $Z_t-|g(H_t)|+VP_{s,t}<0 \le Z_t-g(H_t)$}: The battery is in either the discharging state (to the customer load only) or the idle state. Let
  \begin{align}\label{case f}
      \begin{cases}
      F^\w_{d,t}=\min\{W_t-S_{w,t},\ D_{\max}\}\\  F^\w_{s,t}=Q^\w_t=0\\
      S^\w_{s,t}=\min\{S_t-S_{w,t},U_{\max}\},S^\w_{c,t}=0\\
      E^\w_t=[W_t-S_{w,t}-D_{\max}]^+.
      \end{cases}
  \end{align}
Then, $\abf^*_t=\arg\min_{\abf_t\in\{\abf_t^\w,\abf_t^\textrm{id}\}} J(\abf_t)$.


\item{\it For $\min\{Z_t-g(H_t),Z_t-|g(H_t)|+VP_{s,t}\}>0$}: The battery is in either the discharging state or the idle state. If $Z_t>|g(H_t)|$, let
  \begin{align} \label{case b 1}
      \begin{cases}
      F^\w_{d,t}=\min\{W_t-S_{w,t},D_{\max}\}\\
      F^\w_{s,t}=\min\{D_{\max}-F^\w_{d,t},U_{\max}\}\\
      S^\w_{s,t}=\min\{S_t-S_{w,t},U_{\max}-F^\w_{s,t}\} \\
      S^\w_{c,t}= Q^\w_t=0,\      E^\w_t=[W_t-S_{w,t}-D_{\max}]^+;
      \end{cases}
  \end{align}
Otherwise,
let  \begin{align} \label{case b 2}
      \begin{cases}
      F^\w_{d,t}=\min\{W_t-S_{w,t},D_{\max}\}\\
      S^\w_{s,t}=\min\{S_t-S_{w,t},U_{\max}\} \\
      F^\w_{s,t}=\min\{D_{\max}-F^\w_{d,t},U_{\max}-S^\w_{s,t}\}\\
      S^\w_{c,t}= Q^\w_t=0, \ E^\w_t=[W_t-S_{w,t}-D_{\max}]^+.
      \end{cases}
  \end{align}
Then, $\abf^*_t=\arg\min_{\abf_t\in\{\abf_t^\w,\abf_t^\textrm{id}\}} J(\abf_t)$.


\end{list}
\end{proposition}
\IEEEproof
See Appendix\ref{app:p4b}.
\endIEEEproof

Proposition \ref{prop0} provides the closed-form control solution in five cases, depending on the battery energy level (via $Z_t$), battery usage cost (via $H_t$), and the prices. In each case, $J(\abf^\w_t)$ in the charging (or discharging) state is compared with $J(\abf_t^\textrm{id})$ in the idle state, and the optimal   $\abf_t^*$ is the control solution of the state with the minimum objective value.

\emph{Remarks:} Note that there are two sources to be controlled for  selling energy back: $F_{s,t}$ from the battery and $S_{s,t}$\ from the RG. From Proposition\ref{prop0}, whether or not to sell energy from the battery back to the grid depends on the battery energy level.  When the battery energy level is low (Case 1), energy is kept in the battery. When the battery has a moderately low energy level (Case 2), it may be  in either the charging or discharging state. For the latter,  the battery only supplies enough energy to the customer but does not sell energy back. When the battery  energy level is higher but still moderate (Case 3),  it may still be  in either the charging or discharging state. For the latter, the battery may sell energy back to the grid. When the battery has just sufficient energy (Case 4), it may supply energy  to the customer, but will not sell energy back to the grid.  When the energy level in the battery is high (Cases 5), it may  supply energy to the customer and at the same time sell energy back. In contrast,  the renewable energy can be sold to the grid regardless of the battery energy level,  state (charging, discharging, or idle), or the price  to make an additional profit. As the result, energy generated by the renewable will be utilized as much as possible. However, when  the system  wants to sell energy from both the battery and the renewable, the order to determine $S_{s,t}$ and $F_{s,t}$ depends on which results in the minimum cost in $\text{\bf P4}_b$. In Case 5, for the control decision in \eqref{case b 1},   $S_{s,t}$ is determined after $F_{s,t}$, while in \eqref{case b 2},  $F_{s,t}$ is determined after $S_{s,t}$.



\subsection{Feasible $\{\abf_t^*\}$ for {\bf P1}}\label{subsec:feasibility}
The optimal solution  $\mathbf{a}^*_t$ of $\text{\bf P4}_b$ provides a real-time solution for {\bf P3}. However, it may not be feasible to {\bf P1}, because  the battery  capacity constraint \eqref{eqn:Yt bds} on $B_t$ may be violated. By properly designing $A_o$ and $V$, we can guarantee that $\abf_t^*$ satisfies  constraint \eqref{eqn:Yt bds}, and ensure the feasibility of the solution. Define $[a]_-\triangleq\min\{a,0\}$. The result is stated below.
\begin{proposition} \label{prop1}
For the proposed real-time control algorithm, by setting $V\in (0,V_{\max}]$ with
\begin{align}\label{eqn:V_max}
&V_{\max}= \nn \\
&\ \ \frac{B_{\max}-B_{\min}-\eta_c R_{\max}-(D_{\max}+2\Gamma)/\eta_d-|\Delta_a|}{P_{b}^{\max}+C'(\Gamma)/\eta_d+[C'(\Gamma)/\eta_d-P_{s}^{\min}]^+},
\end{align}
and
 $A_t$ in \eqref{eqn:dynamic shift Z} with
\begin{align}\label{eqn:A_o}
 A_o = \!\! \ B_{\min}\!+\!VP_{b}^{\max}\!+\!\frac{VC'(\Gamma)\!+\Gamma\!+\!D_{\max}}{\eta_d}\!+\!\frac{\Delta_a}{T_o} \!-\![\Delta_a]_-,
\end{align}
 $B_t$ satisfies the battery capacity constraint \eqref{eqn:Yt bds}, and  control solution $\abf_t^*$ of $\text{\bf P4}_b$, for any $t$, is feasible to {\bf P1}.
\end{proposition}
\IEEEproof
See Appendix \ref{appC}.
\endIEEEproof


Note that  $V_{\max}>0$ in \eqref{eqn:V_max} is generally satisfied for practical battery storage capacity and $|\Delta_a|$ being set relatively small.
We should also point out that since $\Delta_a$ is a desired value set by our proposed algorithm, the solution $\abf_t^*$ of ${\bf P4}_b$ may not necessarily satisfy constraint \eqref{eqn:delta_a} at the end of the $T_o$-slot period, and thus may not be feasible to {\bf P2}. However, Proposition\ref{prop1} provides the values of $A_o$ and $V$ to guarantee the control solutions $\{\abf_t^*\}$ being feasible to {\bf P1}.

The proposed real-time bidirectional energy control algorithm is summarized in Algorithm\ref{alg1}. We emphasize that  i) our proposed algorithm does not require or rely on any statistical distributions of system inputs $\mubf_t$ (prices, load, and renewable generation processes), and thus can be applied to general scenarios, especially when these processes are non-ergodic or difficult to predict in a highly dynamic environment. ii) The control solution provided by our real-time algorithm is given in closed-form which requires little computation, and thus is attractive for practical implementation.

\begin{algorithm}[t]
\caption{Real-time battery management control algorithm}\label{alg1}
Initialize: $Z_0=H_0=0$.\\
Determine $T_o$.\\
Set $\Delta_a\in [-\Delta_{\max},\Delta_{\max}]$.\\
Set $A_o$ and $V\in(0,V_{\max}]$ as in \eqref{eqn:A_o} and \eqref{eqn:V_max}, respectively.\\
At time slot $t$:
\begin{algorithmic}[1]
\State Observe the system inputs $\mubf_t$ and queues $Z_t$ and $H_t$.
\State Solve ${\bf \text{\bf P4}_{a}}$ and obtain $\gamma^*_t$ in \eqref{eqn:optimal gamma}; Solve ${\bf \text{\bf P4}_{b}}$ and obtain $\mathbf{a}^*_t$ by following cases \eqref{case a}-\eqref{case b 2} in Proposition\ref{prop0}.
\State Use $\mathbf{a}^*_t$ and $\gamma^*_t$ to update $Z_{t+1}$ and $H_{t+1}$ in \eqref{eqn:queue Z} and \eqref{eqn:queue H}, respectively.
\State Output control decision $\abf_t^*$.
\end{algorithmic}
\end{algorithm}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Performance Analysis}\label{sec:PA}
To analyze the performance of our real-time solution in Algorithm\ref{alg1} with respect to {\bf P1}, let $u^*(V)$ denote the $T_o$-slot average system cost objective  of {\bf P1} achieved by Algorithm\ref{alg1}, which depends on  the value of $V$ set by Algorithm\ref{alg1}.   For comparison, we partition $T_o$ slots into $T$ frames with $T_o=MT$, for some integers $M,T\in \mathbb{N}^+$. Within each frame $m$, we consider a \emph{$T$-slot look-ahead optimal control policy}, where $\{W_t,S_t,P_{b,t},P_{s,t}\}$ are known non-causally for the entire frame beforehand. Let $u_m^\textrm{opt}$ denote the minimum $T$-slot average cost for frame $m$ achieved by this optimal policy. We can view $u_m^\textrm{opt}$ as the minimum objective value of {\bf P1} with $T_o = T$ under the optimal $T$-slot look-ahead solution. The  performance gap of our proposed real-time algorithm  to the optimal $T$-slot look-ahead policy is bounded in the following theorem.

\begin{theorem} \label{thm1}
For any arbitrary system inputs $\{\mubf_t\}$, and any $M,T\in \mathbb{N}^+$ with $T_o=MT$, the  $T_o$-slot average system cost under  Algorithm\ref{alg1}  to that under the optimal $T$-slot look-ahead policy satisfies
\begin{align}\label{thm1:bd}
&u^*(V)-\frac{1}{M}\sum_{m=0}^{M-1}u_m^\textrm{opt} \nn\\
&\leq
\frac{G T}{V}+\frac{L(\Thetabf_0)-L(\Thetabf_{T_o})}{VT_o}+\frac{C'(\Gamma)(H_0-H_{T_o})}{T_o}
\end{align}
with the bound at the right hand side being finite.
Asymptotically as $T_o\to \infty$, \\[-1.5em]
\begin{align}\label{thm1:bd_longterm}
\lim_{T_o\to \infty}u^*(V)-\lim_{T_o\to \infty}\frac{1}{M}\sum_{m=0}^{M-1}u_m^\textrm{opt}\le \frac{G T}{V}.
\end{align}
\end{theorem}
\IEEEproof
See Appendix\ref{appD}.
\endIEEEproof


By Theorem\ref{thm1}, the performance gap of Algorithm\ref{alg1} to the $T$-slot look-ahead optimal policy is upper bounded in \eqref{thm1:bd}, for any $T$ with $T_o=MT$. To minimize the gap, we should always set $V = V_{\max}$. From \eqref{thm1:bd_longterm}, as the duration goes to infinity, the asymptotic gap is in the order of $\Oc(1/V)$. Since $V_{\max}$ increases with $B_{\max}$, When $V=V_{\max}$, Algorithm\ref{alg1} is asymptotically equivalent to the $T$-slot look-ahead optimal policy as the battery capacity and time duration increases.



As discussed at the end of Section\ref{subsec:feasibility}, constraint \eqref{eqn:delta_a} in {\bf P2} sets a desired value for  $\Delta_a$ which may not be achieved by our proposed algorithm at the end of $T_o$ slots. Denote this mismatch under Algorithm\ref{alg1} by $\epsilon\triangleq \sum_{\tau=0}^{T_o-1}(Q_\tau+S_{r,\tau}-F_{s,\tau}-F_{d,\tau})- \Delta_a$. This mismatch is quantified below.
\begin{proposition}\label{prop3}
For any arbitrary system inputs $\{\mubf_t\}$ and  any initial queue value $Z_{0}\in \mathbb{R}$, the mismatch for constraint \eqref{eqn:delta_a} by Algorithm\ref{alg1} is given by $\epsilon = Z_{T_o}-Z_{0}$, and is bounded by
\begin{align}
|\epsilon|\le & \  2\Gamma/\eta_d+VC'(\Gamma)/\eta_d+V[ C'(\Gamma)/\eta_d-P_{s}^{\min}]^+\nn \\
&+VP_{b}^{\max}+\eta_cR_{\max}+D_{\max}/\eta_d.
\end{align}
\end{proposition}
\IEEEproof
See Appendix\ref{appE}.
\endIEEEproof

Finally, we expect constraint \eqref{equ:sell buy constraint} to be satisfied by Algorithm\ref{alg1}, \ie buying energy ($E_t>0$) and selling stored energy  ($F_{s,t}>0$) should not occur at same time. This is verified in the following result.
\begin{proposition}\label{prop E times P zero}
For any system inputs $\mubf_t$, the optimal control solution $\abf^*_t$ under Algorithm\ref{alg1} guarantees constraint \eqref{equ:sell buy constraint} being satisfied.
\end{proposition}
\IEEEproof
See Appendix\ref{app E times P zero}.
\endIEEEproof

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Simulation Results}\label{sec:sim}

We set the slot duration to be 5 minutes, and assume that system input  $\mubf_t$ remains unchanged within each slot. We set the buying price $P_{b,t}$ using the data collected from Ontario Energy Board \cite{website:Ontario_Elec}. We use solar energy for the RG to generate  $\{S_t\}$. As a result,  $\{S_t\}$ is a non-ergodic process, with the mean  $\overline{S}_t=\mathbb{E}[S_t]$ changing periodically over $24$ hours. As shown in Fig.\ref{fig:C_S_W_distribution} top, we model $\{\overline{S}_t\}$ by  a three-stage pattern as $\{\overline{S^{h}},\overline{S^{m}},\overline{S^{l}}\}=\{1.98,0.96,0.005\}/12$胱璎犷箦篝犷溽蜾溴鲩狒轱ぼ箝珥徇愚辇桨窜秭弪扉铄愚辇が骘ら借憩欷族犰箫盹溴翳祜徜ぷ唪狍铒瞽弪顼溟痱镢弩鏖翳礤犷ぼ秭弪扉铄啕酏杰磲翳忖琵圩唪荬骘祆秣轭翳蝈瀛篝徵疳趑弪秭弪遽汨溽狍ぼ茱鲥蜢轭妍邹椠茱鲥蜢轭妍邹睚茱鲥蜢轭妍邹忑荦杰伯船碑掣爱盾辈胱椠箬秣轭崎绠茯彐骈绾眠舆走溟篝蜷怩糸镱黹滗戾犷箦篝犷溽蜾溴鲩狒轱ぼ箝珥徇邹辇桨曹秭弪扉铄邹辇が骘ら借憩欷迈轭痱殂ば啕猬酏骘祆秣翳蝈瀛篝徵痱殂疳趑弪蝈疱狒邃遽汨溽狍ぼ羞恺掼羞恺揄羞恺揿荦杰埭爱北脯埭爱肮宫埭爱岸耻疱胱璎狍箬秣轭崎绠茯彐骈绾眠舆走溟篝蜷怩糸镱怙趑镯澡忉趑弪犷篝矧徵疳蜥礤翦蝮狎箦狍骘祆秣蠛ぢ啕茼轭桨がひ啕茼狲桨钡胱椠つ啕茼狲桨钡胱椠っ啕荇屮趄睇蜚矫啕荇屮趄睇溷桨鞍堡ふ啕茼狲桨菠胱椠犷翳轭轸獒忉趑弪孱弪琦戾鲥ぢ甙禁逻茼狲昌ぎ疹戾篌箴邈殒殄洮麇箦翳骘祆秣轭溴驷蹯鲠祯弩ぢ啕茼狲匠胱璎犷ぼ弭徇憬苠翎咪桨垢ぎ苕镲纛雉妍豉痖汜涕翳轷憝轱忉趑弪汜徙栝弼ぐ构汨狎玳铉彐骈汩孱泫苠眇棼氧徜蜥糸忉趑弪躞徵泔篝族躞聃徜蜥糸骢钽糸镱骘翳忉趑弪躞徵泔篝狍犷屮屙痨狎汜箦玳鲥怡っㄜ秭弪扉铄啧┙胲秭弪扉铄啧薏が麒弪る景轶翳忉趑弪泔篝泔彐骈汩孱溴疱钿轭镱翳忉趑弪箴邈殒殂狒轱犷ぼ秭弪扉铄啧轶玳鲥轭苠耱彐糸礤狯琮澡镳糸磲ぼ玑眄徇艮镦ぼ翦酐茆写哚轭苠耱彐羼詈镳糸磲玑眄猃轭翳轶汜箦汜忮溴蜷鲥狍椹ぼ玑眄徂唪挨骘と唪挨殚ぼ玑眄徂唪杰轻眄幛骘と唪胫芮犴磲せ殚椹ぼ玑眄徂唪江冗酏ú胫─骘き搽周轻眄莒冗莒挨族躞翳轶泔篝骢钽糸镱翳蝻蹒栾豸秕箝眭灬糸镱篝蹁疹戾篌箴邈殒殄洮麇箦る桨堡狍翳溴驷蹯鲠祯瀹族泔铙殇弪泊栾躜漉蜥糸镱鏖翳ぴ唢讲父箪雉螽娱钽痫箝糸鲥铄玑糸鲥ぼ腻祠徇幛犰祜黧忉趑弪麸汨狎珏ㄤ轶汨狎珏盹蝈翳犷溟筱栳蜱ㄣ栳蜱濠秭弪ぴ唢き疱蜷镤麇犰翦蝾狒翳箝珙镦ぼ腻祠徇幛秭弪眭祠轲戾ぴ唢き箪雉疱蜷镤麸泔铘蝻翳轶翦钿孱泫麇箦ぼ腻祠徇峤悚à悚骘翳镤ㄥ鲥瞟ぴ唢き箪雉疱蜷镤蟋骘箫礤泔铙翎铘ゃ景ぎ疹戾篌箴邈殒殄洮麇箦ぶ街啕茼狲狍翳溴驷蹯鲠祯瀹荏踱篚怏邈糸镱蓬弪琦怩轭犷箦祆轭鲶痱殂弩茆彗轭骈珲蝈埕茔孱翦蜷铉荛钽祯溴珧狃栝泱埙殇翳桨杠扉铄鏖漪栎羞舆走溟篝蜷怩糸镱屦簖荟箴徙濯卞睚茔狃糸镱荏磲祆砒犴痨镦ぷ唪がび唪犷ば啕猬酏秭弪泊栾躜螽莒徕屐骈绾眠舆走溟篝蜷怩糸镱茔孱翦蜷铉荛钽祯溴珧狃栝泱埙殇翳桨杠扉铄鏖漪栎忉蜻拱疱蜻铄鞑屦簖茔狃糸镱荏磲祆瘤弪徵孱弪琦怙蹒梏箫熹轭麸ㄦ蝻愆翳忉趑弪狒溟骀弪孱痱殂弩箦祆轭绛麸怩轭痱殂蜥糸ぼ蜩镞鸾爱工┊莒徕屐骈绾忉蜻拱疱螨茔孱翦蜷铉荛钽祯溴珧狃栝泱埙殇翳桨杠扉铄鏖漪栎忉蜻嘲疱蜻铄鞑屦簖茔狃糸镱荏磲祆瘤弪徵孱弪琦怙蹒梏箫熹轭麸ㄦ蝻愆翳忉趑弪狒溟骀弪孱痱殂弩箦祆轭绛麸怩轭痱殂蜥糸ぼ蜩镞鸾爱长┊莒徕屐骈绾忉蜻嘲疱螨荟箴徙濯卞睚苠钿骈珲蝈族篝蹁翳孱弪琦怩轭犷箦祆轭忮栳鲩矧躅溴溟骀弪孱箦祆轭绛麸怩轭痱殂蜥糸矬腻骈铄翳箦祆轭绛麸怩轭痱殂蜥糸怡ぼ蜩镞疖趄獒铉戾羞蟋酏羞猬酏鏖翳ぐ莒茯栾唣急ぎ婶轶骈邃秭弪ぴ唢糸礤箪雉螽腻骈铄翳狯弪徵犴秕铘镦怙蹒梏犷箫熹孱弪琦狒遽汨痱殂篝徵镦ば啕猬酏ㄨ殓璎礤溟蹴祜鳗狍茆彗轭犰殓瞠荑箴徙濯卞睚茱鲥蜢轭妍艳辇荇蜷犷珈羼苕蜥沱饼茉氵廪辄荏蹴啕糗轭茉氵廪辇堰艮茱鲥蜢轭妍七筠辇荇蜷犷珈羼苕蜥沱饼茉氵筠辄荏蹴啕糗轭茉氵筠辇七蟋酏蕺榻璎憩苠钿犰殓瞠麒弪ぼ糟哜揲荇蜷犷珈羼茺艉羞猬酏叫哜揲荦犷ぼ糟唧揲荇蜷犷珈羼茺艉羞蟋酏羞筠檐ぎ领箫溴铒翦ぼ秭弪扉铄妖犷ぼ秭弪扉铄七簖狍翳秭弪犰孱弪琦怙蹒梏犷箫熹蝈箴邈糸鲥禊崎珞茯彐骈绾忉蜻拱疱螨犷茯彐骈绾忉蜻嘲疱螨箬秣翳狯弪徵犴秕铘镦孱弪琦骘ぼ蜩镞鸾爱工犷ぐ长ㄨ殓犷祜箦祆轭痱殂弩┈蝈箴邈糸鲥禊蔑眇狎轭崎绠茯彐骈绾忉蜻拱疱螨怙趑镯鏖翳崎绠茯彐骈绾忉蜻嘲疱螨怙趑镯麇箦翳狒盹蝈孱弪琦轶箫熹狒栝玷弪ぼ蜩镞黏麸轭泸遽箦翳痱镦轸麒殪狒祜麇ぼ蜩镞黏箦祆轭狒翳痱殂轶铒泔篝彐驽泗轹瀣犷翳簌篝屙翦钿麸脲屦翳孱弪琦轭翳篝矧徵骘骢趱蝈躞徵瀹契螋桢蝽矧瀣轭崎绠茯彐骈绾忉蜻拱疱螨怙趑镯狒栝玷弪ぼ蜩镞黏翳狯弪徵犴秕铘镦孱弪琦箫熹狒ば唧揄犷ば唧掼轭泸遽箦鏖翳翳忉趑弪汜疳汩豉ぢ啕茼狲ぎ澡轶轶忮汜躞灬蜱弪汜疳汩豉镦驽蝮盹蝈骒屮殁殪轸骘汨狎玳铉犷溟筱栳蜱轭徙糸鲩糸弩犷犰祜黧盹蝈孱弪琦麸忮箫熹忉汶狒栝玷弪痱殂弩骑翳筢礤蝈狍镱灬蜱弪汜疳汩豉犰祜黧盹蝈孱弪琦麸忮怙蹒梏狒祜麇痱殂瀣狍箬秣轭崎珞茯彐骈绾忉蜻拱疱螨犷茯彐骈绾忉蜻嘲疱螨麸瓞麒弪瀣狍ぢ啕茼狲轭泸遽箦蟋翳犴秕铘镦孱弪琦怙蹒梏骝镯翳珧殇狒栝玷弪痱殂ば啕猬酏叫哜掼溴泸遽箦犷狒祜麇痱殂ば啕猬酏叫哜揿轭泸遽箦螽荏踱篚怏邈糸镱渝趑轭ぼ腻祠徇幛犷黹箜狒汨ぼ屦箝祜瞍茆彗轭骈珲蝈埕茔孱翦蜷铉荛钽祯溴珧狃栝泱埙殇翳桨杠扉铄鏖漪栎溴祠徇篝狒筮蜩锇巩屦簖茔狃糸镱荏磲祆绣蜴矧磲钽镦领顼蜷翳睨茯彐犰绫狒溟骀弪孱ぼ腻祠徇幛箦趑轭箦祆轭绛麸怩轭痱殂蜥糸ぼ蜩镞鸾爱工┊体骠狯弪徵簌篝屙泔篝狒溟骀弪孱苣屐翎哚せ议玷艉媚镦黹箜狒汨ぼ屦箝祜瞍狒溟骀弪孱ぼ腻祠徇幛莒徕屐骈绾溴祠猃苠钿骈珲蝈崎绠茯彐骈绾溴祠猃箬秣栾翳狯弪徵簌篝屙泔篝鲠蜷弩鏖翳ぼ腻祠徇幛箦怡痱镳矬邃领顼蜷翳睨茯彐犰绫骘ぼ蜩镞鸾爱工族箝眭灬翦翳簌篝屙秭弪眭祠轲戾ぴ唢き箪雉疱蜷镤骘玳鲥苣屐翎哚ぎ婶箬秣翳狒翳簌篝屙泔篝轭泸遽箦鏖翳苣屐翎哚ぎ惋蝈孱弪琦铄邃麸忮怙蹒梏麸忮篝矧邃轭翳忉趑弪骘ぼ腻祠徇峋挨戾徜轭麸栝玷弪簌篝屙泔篝麒殪轸轶翳镳痫箝翦骘ぼ腻祠徇峒挨霄弪犰飕翳簌篝屙泔篝轶翳箜犰戾篝麒孱ぼ腻祠徇峤挨崎绠茯彐骈绾溴祠猃蜷玷箬秣翳媚镦翳黹箜狒汨ぼ屦箝祜瞍狒溟骀弪孱鲠祯镦ぼ腻祠徇幛怡领顼蜷翳睨茯彐犰绫族箦翳狒ぼ屦箝祜瞍狒溟骀弪孱鲠祯弩镦ぼ腻祠徇幛轶蝈灬糸鲥禊箜犰骘ぼ蜩镞鸾爱工狍翳狯衢灬忾扉豉麸箦祆孱弪琦桢祓脲屦翳黹箜狒汨蝈灬糸鲥禊箜犰飚领箫骝镯翳箝珙镦ぼ屦箝祜瞍轸箬秣翳狒翳铄孱弪琦汨犷珏轭翳忉趑弪秭弪翳疱蜷镤翦钿麸忮戾篌翳犷苣屐翎哚ぎ澡黹箜狒汨ぼ屦箝祜瞍轶翳箜犰戾篝麒孱ぼ腻祠徇峤挨箩箦镱翳徕秭蝈篚祠蟋麇泔钽祯溴翳狒箦趑轭ぼ腻祠徇峤挨轭领顼蜷翳轶翳盹篝溴箝蜥忪瀣犷轶躞邃狍翳溴驷蹯鲠祯骘秕箝眭灬糸镱篝蹁荏踱篚怏邈糸镱绣蜴矧磲钽蔑眇狎轶镱茆彗轭骈珲蝈埕茔孱翦蜷铉荛钽祯溴珧狃栝泱埙殇翳桨杠扉铄鏖漪栎马狲屦簖茔狃糸镱荏磲祆瘤弪徵簌篝屙泔篝鲶忉趑弪汜疳汩豉ぢ啕茼狲ぎ莒徕屐骈绾夙狲茔孱翦蜷铉荛钽祯溴珧狃栝泱埙殇翳桨杠扉铄鏖漪栎泔篝喏筮痱殂暹爱垢屦簖茔狃糸镱荏磲祆瘤弪徵簌篝屙泔篝鲶箦祆轭绛麸怩轭痱殂蜥糸ぼ蜩镞黏腻驷蹯艉ぢ啕茼狲匠胱璎る桨堡┊莒徕屐骈绾疱蜚孱趔喏筮泔篝茔孱翦蜷铉荛钽祯溴珧狃栝泱埙殇翳桨杠扉铄鏖漪栎泔篝喏筮痱殂暹弭岙屦簖茔狃糸镱荏磲祆蔑眇狎轶镱镦狯弪徵簌篝屙泔篝秭弪ぼ蜩镞黏狒溟骀弪孱忉趑弪汨狎玳铉ㄤ轶汨狎玳铉彐骈汩孱泫ぼ弭徇悚à杰弭徇浃┊莒徕屐骈绾泔篝喏筮弭猃苠钿骈珲蝈族泔铙殇弪翳蝈雉桢犰顼蜷翳眢骘泔眇狎轶镱椹苠眇棼抄箪雉祜镫徼遽潺澡铒瞽汜躞犰ぴき箪雉祜镫徼遽镳糸磲箫祯糸镱鏖翳ぴ匠が麒弪簌篝屙轭瘐趔ぼ茼踱孢糗骘遽汨抄箪雉骝犴狎腩秣铒瞽汜躞犰禊徼遽镦糸礤澡蝈篚祠轭抄箪雉黹铋眭簌篝屙泔篝轶踹磙荇屮趄睇镳酏骘骝犴ろぎ苕镲纛雉妍澡抄箪雉祜镫徼遽痫扉泫轶镡翎轭邃翳蝻蹒屮栳躞糸鲥箦狎汨深珏铄蜥飕翳镳糸磲箫祯糸镱汜镱禊忮镡翎轭邃骝镯屮栳躞糸鲥箦狎汨麒殂轶溟骀殂蹯骘灬蜱弪ぴぎ殚苠眇棼球邋澌珧邋澌犰顼蜷翳翳狒黹铋黹弩翳疱颦箪雉簌篝屙泔篝忉箦镱翳沲蝌孱轭瘐趔ぼ眭怄唪ぎ骑镱瀛箪雉泔篝黹铋黹狒轱瞵麸狯镩翳忉趑弪镳弪狒轱泔篝翳簌篝屙溟蝈泗禊怩孱弪琦骝镯翳珧殇麸箦蝣翳祜徜鏖翳秕篝矧轭孱弪琦轭麸翳忉趑弪澡躞翳轶珧邋澌礤翳镤轶弩箦铘獒祆礤翳镤鏖翳秕篝矧徵瀹殚椹苠眇棼郁矧徵鏖翳秕箦祆轭绛忉汶组翳铒孱弪琦箦祆轭绛忉汶汜疳忾扉豉轭翳盹溴飕翳痱镡戾轶蝈漉沐麸翳镱泔铙殇弪邃轭茔轸妍涕δ镱绾视撩钡犷翳犰顼蜷翳痱镳矬邃翳弪彘町物翦翳狒犴镱翳翳蝈礤翳镤蟋翳骈蝮镱轶铒瞽汜躞犰狃痱镝汨犷翳蝈篝狎蝈犰糸礤狃痱镝汨弩崎绠茯彐骈绾夙狲泔眇狎弩翳狯弪徵簌篝屙泔篝镦溟骀弪孱犰顼蜷翳眢狒溟骀弪孱忉趑弪汜疳汩豉ぢ啕茼狲が麒弪翳泔篝轶泔铞弪翦轭麸滹祆狎疱溽澡簌篝屙泔篝躅溴领顼蜷翳睨蝈漉沐狍ぢ啕茼狲轭泸遽箦蟋忮汜躞灬蜱弪忉趑弪汜疳汩豉玳鲥盹蝈骒屮殁殪轸镱汨狎玳铉溟筱栳蜱轭绗犰祜鏖铉翳簌篝屙麸怩盹蝈孱弪琦狒祜麇痱殂犷箦祆盹蝈狒栝玷弪痱殂瀹领箫栝玷弪箦祆轭绛麸怩轭痱殂蜥糸ぼ蜩镞鸾爱工蝈篚祠轭祜麇狯弪徵簌篝屙泔篝骑翳珧邋澌犰顼蜷翳憩箝钽轸轶弩箦铘獒祆礤翳镤鏖翳秕翳躞镦篝矧徵瀣翳簌篝屙泔篝滹弩铒鲠蝙鏖翳翳忉趑弪汜疳汩豉蔑眇狎邃鏖翳翳珧邋澌犰顼蜷翳憩秕痱镳矬邃领顼蜷翳睨镦驽蝮盹蝈泔篝蝈漉泗轱狍翳忉趑弪汜疳汩豉忮泔礤灬蜱弪惋蝈秭弪泔眇狎邃鏖翳翳篝矧徵鏖翳秕箦祆轭绛忉汶翳屮趄泔篝筢鲩铉怡翳狯衢灬忾扉豉麸箦祆忉汶孱弪琦狒溟骀弪孱箦祆轭痱殂轶沆遽蜢箦孱崎绠茯彐骈绾疱蜚孱趔喏筮泔篝痱秭殇弩翳泔眇狎轶镱镦簌篝屙泔篝狒鲠蜷秕箦祆轭绛麸怩轭痱殂蜥糸ぼ蜩镞黏鲠祯弩骑雉桢犰顼蜷翳眢溴驷蹯ぢ啕茼狲匠胱犷る桨堡狎躞邃留翳溴驷蹯箦趑轭绗秕痱镳矬邃犰顼蜷翳秕麴弪骘蝽犰雉桢翳蝈礤翳镤骘ぼ蜩镞疖轭郯陛ぎ蛮泔眇狎轭领顼蜷翳睨茯彐犰绫鏖翳翳篝矧徵鏖翳秕箦祆轭绛忉汶礤翳镤麇箦翳泔篝筢鲩铉怡箦祆轭屮趄孱弪琦忉汶麸翳珧殇狒溟骀弪孱ぼ蜩镞黏族犰箫痨雉翳疱蜴矧磲钽镦领顼蜷翳睨茯彐犰绫狒灬蜱弪忉趑弪汜疳汩豉犷狒栝玷弪鲠祯镦るㄨ殓桢忉趑弪躞徵泔篝麸箦翳彐驽泗镦溟骀弪孱忉趑弪箴邈殒殂狒轱铙镱翳泔篝疱蜴矧磲钽瀹崎钺祆轭崎绠茯彐骈绾泔篝喏筮弭猃麇箬秣翳彐驽泗镦溟骀弪孱忉趑弪汨狎玳铉犷溟筱栳蜱轭彐骈汩孱汩弩镱翳疱蜴矧磲钽瀣麒弪麇箦ぼ弭徇憬苠翎咪ぎ腻疱钿轭镱翳聃犰轸镦忉趑弪翳彐骈汩孱泫磲蜥铉骝镯ぐ傅麸ぐ构ぎ馏麇箦瀣泔眇狎邃麸翳抄箪雉祜镫徼遽箫祯糸镱翳轭泸遽箦镦簌篝屙泔篝狒祜麇ぼ弭徇悒苠翎咪─躅溴领顼蜷翳睨茯彐犰绫轶盹蝈铒糸沐徕戾澡疱蜴矧磲钽镦翳珧邋澌犰顼蜷翳滹弩铒汨犷珏鏖翳溟骀弪孱ぼ弭徇悚箝钽翳犰顼蜷翳滹铒躞翳篝矧徵瀹阻孱翳汨狎玳铉彐骈汩孱泫轶祜à爱傅荏轫爱工犷箦祆轭绛麸怩轭痱殂蜥糸轶栝玷翳珧邋澌犷抄箪雉祜镫徼遽礤翳镤汜栳鲥祜麇簌篝屙泔篝轭溟汜糸铉翳狒翳忮铄骈镦篝矧徵溟黹铋箬弩轭翳轶筱孱狎轱荏邈糸镱蔑钽祯箝镱莒徕屐箦愫泔钽祯箝镱深翳轶黠螂麇痱镳矬邃蝈犰糸礤忾溟蝈泗轱钺孱弪琦泔铘蝻犰顼蜷翳骘蝈箝溴铘獒庞簌篝屙麸黹铋黹翳簌篝屙泔篝鏖翳轭玳鲥糸礤疱蜷镤澡庞簌篝屙栳犷轭翦珧狒邃仪忮箝溴泔铑邈翦麸翳们犷轶汜疳忪镦怩箦祆孱弪琦骝镯麸翳们骑翳簌篝屙泔篝忮箝溴翳孱弪琦怩轭泔篝犷箦祆轭痱镦轸麇轭沆蹁邃翳篝矧徵泔篝怡徙泔躅糸铉翳忉趑弪镳弪狒轱钺泔篝犷轭彐骈汩孱泫漉麸汨狎玳铉溟筱栳蜱轭徙糸鲩糸弩硝蝈犰糸礤犰顼蜷翳痱秭殇弩沆矬邃骘蝽泔铘蝻箫祯糸镱骘翳庞簌篝屙麒殂轶鲥蝙箝眇戾麸轫痨屙孱舢婶滹弩铒蝈灬镱犷篝狒轶糸汜腩秣戾溏镦簌篝屙轭瘐趔犷轶狃痨殂徕戾麸狎忾趄狎簌篝屙轭瘐澌钺黹泱族箬秣邃翳狒秕痱镳矬邃犰顼蜷翳痱秭殇弩怙躅溴疱蜴矧磲钽珲狎犷翦麸翳铒瞽汜躞犰ぴき箪雉祜镫徼遽镳糸磲泔铘蝻箫祯糸镱娱眭灬糸镱溴盹铙趄狒邃翳狒秕痱镳矬邃犰顼蜷翳秕麴弪骘蝽雉桢铒瞽汜躞犰矧蝈犰糸礤犰翦蝾狒轹礤翳镤螽族骢螋桢痱秭殇邃箝眭灬糸镱篝蹁麸躅溴蝮翎钿栾翳狯衢灬忾扉豉镦箦祆轭孱弪琦箦祆轭犷怩轭痱殂箦趑轭绗犷忉趑弪轭彐骈汩孱泫徭驽泗翳篝矧徵忮栳鲩矧犷簌篝屙泔篝茚痧孱溟沐荏邈糸镱篷蹰鲠戾钽镦痱镡戾眢茆胁犷茆谐莒徕屐狃鹆澡痱镲骘祆秣翳珏铄蜥狎珲礤铘轭茔轸妍五屐毫蜇轹舶卑澡镳糸磲箫祯糸镱镦荇屮趄睇茆胁筢糸箧殄犰泔铙趄衢铘镦荇屮趄睇茆谐犷翳弪彐矧轸轶驽狍殁戾箫祯糸镱镦茆谐体蹀镞菠犷蹀镞长溴铒翦翳黹铋眭镡赍泗轹鲠祯弩镦茆胁犷茆谐蝈箴邈糸鲥禊族栳鲥蹀镞耻戾蹀镞菠蛮叔铙孱轭羼踽扉豉犷泔铞屮轸镦っㄜ沅雉─麇栳鲥ぼ秭弪扉铄猫茜犴磲茜羼猫茱鲥蜢轭妍茜犴磲┙猫茱鲥蜢轭妍啧─麒殂礤犷蹀镞耻珏蹀镞菠儒钽瀣蹀镞步蹀镞长犷荇屮趄睇茆胁犷荇屮趄睇茆谐狎羼蹰鲠戾铘荏邈糸镱序镲镦体眄狺茯彐戾眄潋殒躔疱怙躅潺莒徕屐狃潋殒躔疱怙躅潺苌排硼蝻镦蛮翳溴骈铋糸镱镦贴狃躅秭潋殒ぼ腻祠屺茉桢翎怄唪─茆彗轭犰殓铨莒徕屐狃鸷潋殒溴祠饼苣屐翎ㄜ澡弭徕孢舂荇蜷犷珈羼台茉桢翎怄啕臬饼┉台茉桢翎怄唪┙苕蜥沱饼昌莒彐舁谵策臬饼谵策臬绒策臬饼绒策糗蜷玷舂茴钴节唪莒彐舁苠翎咩ㄑ唪舆悻酏┉苕蜥沱七洮酏七蟋酏苠翎咪苕蜥沱苣屐翎哚赃稞茯殓梏┸铑苘Λ冗舁茜犴磲唪啕醅酏┇苕蜥沱饼昌ㄜ玑眄徇舡啕醅酏┺曹铑苘Λ苕蜥沱饼昌莒彐舁苠翎咩ㄑ唪舆悻酏┉苕蜥沱七洮酏七蟋酏苠翎咪苕蜥沱苣屐翎哚赃稞茯殓梏┺伯苠钿犰殓铨体ょ唪溴铒翦翳篚镦翳灬篝赭翦蝽轭苠耱彐狃鸷潋殒溴祠饼乞镯苠耱彐羼詈溴祠徇猃麇栳鲥ぼ骝徙苣屐翎哚赃稞莒茼狲茺苠翎咩疫茼狲倪茼狲苠翎咪荦杰轻眄幛骑玳鲥鲠祯镦ぼ腻祠徇幛怡苠耱彐羼詈蜚哜潴苠耱彐羼詈溷哜潴苠耱彐羼詈卟犷苠耱彐羼詈玑眄徇怃簖ょ唪轶躔疱怙躅溴怡茆彗轭犰殓铨莒徕屐羼詈戾眄徇驱邕籀莒苕蜥沱茼狲莒彐糗莒彐舁苠翎咩疫茼狲苕蜥沱苣屐翎哚赃稞茯殓梏┺铂莒彐舁苕蜥沱倪茼狲苠翎咪苕蜥沱苣屐翎哚赃稞茯殓梏┺曹蜷玷糗昌苕蜥沱芮犴磲薏昌荇蜷犷珈羼钱苠钿犰殓铨族铒骈钿翳躔疱怙躅镦き冗豇啕醅酏轭翳箦泔钿翦蝽镦苠耱彐狃鸷潋殒溴祠饼物翦翳狒び啕鳜酏がぷ唪犷と唪狎腩秣骘翳沲蝌孱糸礤箪雉簸领箫铒翦翳狒び啕鳜酏走莒挨忮汜躞び啕鳜酏杰黹钴走衄舆糗ぎ澡躔疱怙躅镦き冗豇啕醅酏轶镡翎轭邃狍骘祆秣蠛茴鬻泔躅翦螓癖泔躅翦螨茆彗轭扉篝荛茚蜥忾沱癖泔躅翦螨ぼ戾骠茯殓梏─}
{\usecounter{q1counter}
\setlength\leftmargin{0em}
\setlength\labelwidth{0em}
\setlength\labelsep{0em}
\setlength\itemsep{0em}
}
\item {\it For $H_t\geq0$}: Let $l_t\triangleq S_{w,t}-W_t-F_{s,t}\le 0$. we have $x_{u,t}=|\eta_c(S_{c,t}+Q_t)-(F_{d,t}+F_{s,t})/\eta_d|\ge \eta_c|(S_{c,t}+Q_t)- (F_{d,t}-F_{s,t})|=\eta_c|E_t+S_{c,t}+S_{w,t}-W_t-F_{s,t}|$, where the last equality is by the supply-demand balance requirement in \eqref{eqn:Wt_constraint}. Thus,
\begin{align*}
-H_tx_{u,t}&\le-H_t\eta_c|E_t+S_{c,t}+S_{w,t}-W_t-F_{s,t}|\nn \\
&\leq-H_t\eta_c(|E_t+S_{c,t}|+S_{w,t}-W_t-F_{s,t}) \nn\\
&\leq-H_t\eta_c(E_t+S_{c,t}+l_t).
\end{align*}
\item {\it For $H_t<0$}: Let $l_t\triangleq W_t-S_{w,t}+F_{s,t}\ge 0$. We have $x_{u,t}\le|(S_{c,t}+Q_t)-(F_{d,t}+F_{s,t})|/\eta_d=|E_t+S_{c,t}+S_{w,t}-W_t-F_{s,t}|/\eta_d$. Thus,
\begin{align*}
-H_tx_{u,t}&\le-H_t|E_t-F_{s,t}+S_{c,t}+S_{w,t}-W_t|/\eta_d\\
&\leq -H_t(|E_t+S_{c,t}|+|S_{w,t}-W_t|+|F_{s,t}|)/\eta_d\\
&=-H_t/\eta_d(E_t+S_{c,t}+l_t).
\end{align*}
\end{list}
Finally, for the first term in \eqref{app:drift delta 1}, we have
$Z_t(\eta_c(Q_t+S_{c,t})-(F_{d,t}+F_{s,t})/{\eta_d}-\frac{\Delta_a}{T_o})\le Z_t (Q_t+S_{c,t}-F_{d,t}-F_{s,t}-\frac{\Delta_a}{T_o})=Z_t (E_t+S_{c,t}+S_{w,t}-W_t-F_{s,t}-\frac{\Delta_a}{T_o})$.
Combining the above results and \eqref{eqn:lemma_G}, we have the upper bound of $\Delta(\Thetabf_t)$ in \eqref{eqn:drift delta 1}.
\endIEEEproof

\section{Proof of Lemma\ref{lemma33}}\label{app:lemma33}
\IEEEproof
The derivation follows the same steps as the one in Lemma 3 in \cite{Li&Dong:JSAC15}. We provide it here briefly. Since $C(\gamma_t)$ is a continuous, convex, non-decreasing function in $\gamma_t$ with $C'(\gamma_t)\ge 0$ and $C'(\gamma_t)$ increasing with $\gamma_t$. Denote the objective of $\text{\bf P4}_a$ by $J(\gamma_t)$. Since $\text{\bf P4}_a$ is convex, we examine the derivative of $J(\gamma_t)$ given by $J'(\gamma_t) = H_t+VC'(\gamma_t)$.

\newcounter{q2counter}
\begin{list}{{\it \arabic{q2counter}$\left.\right)$}}
{\usecounter{q2counter}
\setlength\leftmargin{0em}
\setlength\labelwidth{0em}
\setlength\labelsep{0em}
\setlength\itemsep{0em}
}
\item {\it For $H_t\geq0$}: We have $J'(\gamma_t)>0$, thus $J(\gamma_t)$ monotonically increases, with its minimum obtained at $\gamma_t^*=0$.
\item {\it For $H_t<-VC'(\Gamma)$}: Since $VC'(\Gamma)\ge VC'(\gamma_t)$, we have $H_t+VC'(\gamma_t)<0$.  $J(\gamma_t)$ monotonically decreases, and its minimum is reached with $\gamma^*_t=\Gamma$.
\item  {\it For $-VC'(\Gamma)\le H_t\le 0$}: In this case, $\gamma^*_t$ is the root of $H_t+VC'(\gamma_t)=0$, given by $\gamma^*_t=C'^{-1}\left(-\frac{H_t}{V}\right)$.
\endIEEEproof
\end{list}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Proof of Proposition\ref{prop0}}\label{app:p4b}
\IEEEproof
Removing the constant terms in \eqref{drift_cost_metric} and from $l_t$ in \eqref{eqn:drift delta 1},  and after regrouping the rest of terms, we have the objective function of $\textbf{P4}_{\textbf{b}}$.

{\bf Determine $S^\w_{s,t}$ and $S^\w_{c,t}$}: To determine how to use the remaining renewable $S_t-S_{w,t}$, we need to minimize the term $S^\w_{c,t}(Z_t-g(H_t))+VC_{\textrm{rc}}-S^\w_{s,t}VP_{s,t}$ in the objective of $\text{\bf P4}_b$:
\begin{itemize}
\item[S1)] If $Z_t- g(H_t)> 0$: We should maximize $S^\w_{s,t}$ and minimize $S^\w_{c,t}$. Thus, the remaining amount should be sold back to the grid and not stored into the battery. We have $S^\w_{c,t}=0$, and $S^\w_{s,t}=\min\{S_t-S_{w,t},U_{\max}\}$ or $S^\w_{s,t}=\min\{S_t-S_{w,t}-F^\w_{s,t},U_{\max}\}$.
\item[S2)] If $Z_t-g(H_t)\le0$: The remaining renewable can be    stored into the battery and/or sold back to the grid. To minimize the cost, if $VP_{s,t}\ge {g(H_t)-Z_t}$, we set $S^\text{a}_{s,t}=\min\{S_t-S_{w,t},U_{\max}\}$,  $S^\text{a}_{c,t}=\min\{S_t-S_{w,t}-S^\w_{s,t},R_{\max}\}$, \ie first maximize the renewable sold back to the grid, then to the battery.  If $VP_{s,t}< {g(H_t)-Z_t}$, we set $S^\text{a}_{c,t}=\min\{S_t-S_{w,t},R_{\max}\}$,  $S^\text{a}_{s,t}=\min\{S_t-S_{w,t}-S^\w_{c,t},U_{\max}\}$, \ie first maximize the amount charged into the battery then consider the rest to be sold to the grid.
\end{itemize}

In the objective function  of $\text{\bf P4}_b$,  the optimal  $F_{s,t}$, $E_t$ and $S_{c,t}$ depend on the sign of $Z_t-|g(H_t)|+VP_{s,t}$, $Z_t-g(H_t)+VP_{b,t}$, and $Z_t-g(H_t)$, respectively. These three functions have the following relations: If $H_t\geq0$,
{%\small 
\begin{align}\label{eqn:relation h>0}
Z_t-g(H_t) \le Z_t-g(H_t)+VP_{s,t}<Z_t-g(H_t)+VP_{b,t}.
\end{align}
}
If $H_t<0$, the following two relations are possible
\begin{align}
&Z_t-g(H_t)\le Z_t-|g(H_t)|+VP_{s,t}<Z_t-g(H_t)+VP_{b,t},\label{eqn:relation h<0 1}\\
&Z_t-|g(H_t)|+VP_{s,t}\le Z_t-g(H_t)<Z_t-g(H_t)+VP_{b,t}.\label{eqn:relation h<0 2}
\end{align}
Based on the relations in \eqref{eqn:relation h>0}--\eqref{eqn:relation h<0 2}, we have the following five cases and derive the optimal solution in each case.
\subsubsection{For $Z_t-g(H_t)+VP_{b,t}\leq0$} From \eqref{eqn:relation h>0} and \eqref{eqn:relation h<0 2}, to minimize the objective function of   $\text{\bf P4}_b$, $F_{s,t}=0$, and we want to maximize $E^\w_t$.
This means the battery is in the charging state. We have $1_{R,t}=1$,  $1_{D,t}=0$, $F^\w_{d,t}=F^\w_{s,t}=0$, and use maximum charging rate $S^\w_{c,t}+Q^\w_t=R_{\max}$ if possible.
Since $Z_t-g(H_t)\leq Z_t-g(H_t)+VP_{b,t}\le 0$, between $Q^\w_t$ and $S^\w_{c,t}$,  determining $S^\w_{c,t}$ first will further reduce the objective value of $\text{\bf P4}_b$. Since $Z_t-g(H_t)\le 0$,  $(S^\w_{c,t},S^\w_{s,t})=(S^\text{a}_{c,t},S^\text{a}_{s,t})$ as in S2) given earlier.  By supply-demand balancing equation \eqref{eqn:Wt_constraint}, we obtain $Q^\w_t$ and $E^\w_t$ in \eqref{case a}.
Alternatively, we can keep the battery idle and only buy energy $E_t^\textrm{id}$ from the grid, where $S_{c,t}^\textrm{id}+Q_t^\textrm{id}=0$. In this case,  the battery cost can be avoided: $1_{R,t}=1_{D,t}=0$, but $E_t^\textrm{id}$ will be smaller. The optimal $\abf^*_t$ is the one that achieves the minimum objective value.

\subsubsection{For $\max\{Z_t-g(H_t),Z_t-|g(H_t)|+VP_{s,t}\}<0\leq Z_t-g(H_t)+VP_{b,t}$} In this case, to minimize the objective of  $\text{\bf P4}_b$, we want to set $E^\w_t$ as small as possible and $F^\w_{s,t}=0$. It is possible that the battery is in either charging or discharging state. If we charge the battery, it should only be charged from renewable $S^\w_{c,t}$, while $Q^\w_t=0$. Since $Z_t-g(H_t)< 0$, $(S^\w_{c,t},S^\w_{s,t})=(S^\text{a}_{c,t},S^\text{a}_{s,t})$  as in S2) given earlier. Note that, if in the charging state, it means $S^\w_{c,t}>0$, which happens when  $W_t=S_{w,t}<S_t$, and we have   $F^\w_{d,t}=0$. Thus, constraint \eqref{eqn:rc_dc_constr} is satisfied.  On the other hand, if $W_t>S_{w,t}$, it means $S_t=S_{w,t}$ and $S^\w_{s,t}=S^\w_{c,t}=0$. We could either use the battery and/or buy energy  $E^\w_t$ (\ie idle or discharging state) to serve the load. If the battery is in the discharging state, the amount  $F^\w_{d,t}$ should be set as large as possible to minimize  $E^\w_t$.  Based on the above, we have the control solution $\abf^\w_t$ as shown in \eqref{case c}.
Alternatively, we can keep the battery idle to avoid battery cost, and only buy energy $E_t^\textrm{id}$ from the grid. Thus, the optimal $\abf^*_t$ is chosen by whichever achieves the minimum objective value.

\subsubsection{For $Z_t-g(H_t) \le 0\le Z_t-|g(H_t)|+VP_{s,t}$} This is the case when \eqref{eqn:relation h>0} and \eqref{eqn:relation h<0 1} hold.
To minimize the objective of $\text{\bf P4}_b$, one possible solution is to minimize $E^\w_t$ and maximize $F^\w_{s,t}$. Due to constraint \eqref{eqn:rc_dc_constr}, $S^\w_{c,t}\cdot F^\w_{s,t}=0$ must be satisfied. Thus, we have two conditions: i) If $F^\w_{s,t}\geq0$ and $S^\w_{c,t}=0$, it means the remaining amount $S_t-S_{w,t}$, if any, will be only sold back to the grid. Since $Z_t\le g(H_t)$, it is easy to see that $0<Z_t-|g(H_t)|+VP_{s,t}\le VP_{s,t}$. Thus, we first maximize  $S^\w_{s,t}$ and then maximize $F^\w_{s,t}$. Since $Z_t-g(H_t)\le 0$, $(S^\w_{c,t},S^\w_{s,t})=(S^\text{a}_{c,t},S^\text{a}_{s,t})$  as in S2). The control solution $\abf_t^\w$ is shown as in \eqref{case d 2}.
ii) If $S^\w_{c,t}\geq0$ and $F^\w_{s,t}=0$, the battery will be charged from $S^\w_{c,t}$ only and no energy from the battery will be sold. We have $(S^\w_{c,t},S^\w_{s,t})=(S^\text{a}_{c,t},S^\text{a}_{s,t})$  as in S2). The control solution $\abf^\w_t$ is shown as in \eqref{case d 3}. After comparing i) and ii), $\abf^\w_t$ is the one whichever achieves the less objective value.
Alternatively, we can keep the battery idle. Thus, the optimal $\abf^*_t$ is chosen by whichever achieves the minimum objective value between $\abf^\w_t$ and $\abf_t^\textrm{id}$.

\subsubsection{For $Z_t-|g(H_t)|+VP_{s,t}<0 \le Z_t-g(H_t)$} Note that this case  happens when $H_t<0$ and \eqref{eqn:relation h<0 2} holds.
We want to set  $E^\w_t$ as small as possible and $F^\w_{s,t}=0$. Since $Z_t\ge g(H_t)$, from earlier we have  $S^\w_{c,t}=0$. Thus, the battery  can be in the discharging state, and it is straightforward to obtain $\abf^\w_t$ in \eqref{case f}. After comparing to the alternative idle state, the optimal $\abf^*_t$ is chosen by whichever achieves the minimum objective value.
\subsubsection{For $\min\{Z_t-g(H_t),Z_t-|g(H_t)|+VP_{s,t}\}>0$} Since $Z_t> g(H_t)$,  $S^\w_{c,t}=0$. By \eqref{eqn:relation h>0}-\eqref{eqn:relation h<0 2}, to minimize the objective of $\text{\bf P4}_b$,  we want to minimize $E^\w_t$ and maximize $F^\w_{s,t}$. This means no charging:  $Q^\w_t=0$.
Thus, only the discharging  or idle state could be considered.
 For the discharging state, since $Z_t-|g(H_t)|+VP_{s,t}<Z_t-g(H_t)+VP_{b,t}$, we should first maximize the discharging amount as $F^\w_{d,t}=\min\{W_t-S_{w,t},D_{\max}\}$ to minimize $E^\w_t$, then maximize  $F^\w_{s,t}$. For energy selling, between $F^\w_{s,t}$ and $S^\w_{s,t}$, to minimize the cost, if $Z_t-|g(H_t)|>0$, we should first maximize $F^\w_{s,t}$ from the battery and then sell from the renewable, as $F^\w_{s,t}$ and $S^\w_{s,t}$ in \eqref{case b 1}. Otherwise, we first sell as much as possible from the renewable, and then determine    $F^\w_{s,t}$ as given in \eqref{case b 2}. By supply-demand  equation \eqref{eqn:Wt_constraint},  $E^\w_t$ can be obtained as in \eqref{case b 1} and \eqref{case b 2}.
Alternatively, we can keep the battery idle and only buy energy $E_t^\textrm{id}$ from the grid. The optimal $\abf^*_t$ is the one that achieves the minimum objective value.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Proof of Proposition\ref{prop1}}\label{appC}
\IEEEproof
Before going into the details, we first provide an outline of our proof. Using the solutions $\gamma^*_t$ and $\mathbf{a}^*_t$ of  $\text{\bf P4}_a$ and  $\text{\bf P4}_b$, respectively, we can show that both $Z_t$ and $H_t$ are upper and lower bounded. Then, by applying these bounds to \eqref{eqn:dynamic shift Z} and using the battery capacity constraint $\eqref{eqn:Yt bds}$, we obtain $A_o$ as the minimum value that can be achieved with a given value of $\Delta_a$. With $A_o$ obtained, we derive the upper bound of $V$, \ie $V_{\max}$, to ensure that $\eqref{eqn:Yt bds}$ is satisfied.

To prove Proposition\ref{prop1}, we first introduce Lemma\ref{app lemma of H} and Lemma\ref{app lemma bound of Z} below.
\begin{lemma}\label{app lemma of H}
For $\gamma^*_t$ in \eqref{eqn:optimal gamma}, $H_t$ is bounded by
\begin{align}\label{eqn:app H bound}
H_{\min} \le H_t \le H_{\max}
\end{align}
where $H_{\min}\triangleq-VC'(\Gamma)-\Gamma<0$, and $H_{\max}\triangleq\Gamma$.
\end{lemma}
\IEEEproof
\setcounter{subsubsection}{0}
\subsubsection{Upper bound}
From \eqref{eqn:x_2}, $x_{u,t}\ge 0$. If $H_t\ge 0$, from \eqref{eqn:optimal gamma}, we have $\gamma^*_t=0$. Thus, based on the dynamics of $H_t$ in \eqref{eqn:queue H}, $H_{t+1}\le H_t$, \ie non-increasing. When $H_t < 0$, from \eqref{eqn:optimal gamma}, the maximum increment of $H_{t+1}$ in \eqref{eqn:queue H} is when $\gamma^*_t=\Gamma$ and $x_{u,t}=0$, and thus $H_{t+1} \le \Gamma=H_{\max}$.
\subsubsection{Lower bound}
From \eqref{eqn:optimal gamma}, if $H_t<-VC'(\Gamma)$, we have $\gamma_t^*=\Gamma$, and $H_{t+1}$ is non-decreasing in \eqref{eqn:queue H}. If $H_t\ge -VC'(\Gamma)$, the maximum decrement of $H_{t+1}$ from $H_t$ in \eqref{eqn:queue H} is when $\gamma_t^*=0$ and $x_{u,t}=\Gamma$, and $H_{t+1} \ge -VC'(\Gamma)-\Gamma=H_{\min}$. Since $C(\cdot)$ is non-decreasing, $C'(\cdot)\ge0$, we have $H_{\min}<0$.
\endIEEEproof

\begin{lemma}\label{app lemma bound of Z}
Under the proposed solution in Proposition\ref{prop0}, we have\\
1) If $Z_t<-VP_{b}^{\max}+H_{\min}/\eta_d$, then $F^*_{d,t}+F^*_{s,t}=0$; \\
2) If $Z_t>\max\{\eta_c H_{\max}, |H_{\min}|/\eta_d-VP_{s}^{\min}\}$, then $S^*_{r,t}+Q^*_t=0$.
\end{lemma}

\IEEEproof
Note that $H_{\min}< 0$ and $H_{\max}>0$.
 1) This case corresponds toCase 1) in Proposition\ref{prop0}.
We have $Z_t<-VP_{b}^{\max}+H_{\min}/\eta_d\le -VP_{b}^{\max}+g(H_t)$, thus $F^*_{d,t}+F^*_{s,t}=0$ is the optimal control action.
2) This case corresponds to Case5) in Proposition\ref{prop0}.
From Lemma\ref{app lemma of H}, we know $|H_{\min}|>|H_{\max}|$.
Thus, it is easy to see that if $Z_t>\max\{\eta_cH_{\max}, |H_{\min}|/\eta_d-VP_{s}^{\min}\}$, then $S_{c,t}^*=Q^*_t=0$ are the optimal control action.
\endIEEEproof
Now, we are ready to prove Proposition\ref{prop1}.  When first show that under $A_o$ and $V$ in \eqref{eqn:A_o} and \eqref{eqn:V_max}, $B_t$ is always upper bounded by $B_{\max}$; Then we prove that $B_t$ is lower bounded by $B_{\min}$.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Upper Bound  $B_t\leq B_{\max}$}
Based on Lemma \ref{app lemma bound of Z}.1), we have $F^*_{d,t}+F^*_{s,t}=0$ if $Z_t<-VP_{b}^{\max}+ H_{\min}/\eta_d$, no discharging from the battery.
When $Z_t\geq -VP_{b}^{\max}+H_{\min}/\eta_d$, from \eqref{eqn:dc_bds},  the maximum decreasing amount  from $Z_t$ to $Z_{t+1}$ in \eqref{eqn:queue Z} in the next time slot is $D_{\max}/\eta_d$, and we have, for $t\in [0,T_o-1]$,
\begin{align}\label{eqn:Z_{t+1}_lower bound}
Z_{t+1}\geq -VP_{b}^{\max}-\frac{\Delta_a}{T_o}-\!\frac{D_{\max}\!-\!H_{\min}}{\eta_d}.
\end{align}
In \eqref{eqn:dynamic shift Z}, we have $B_t=Z_t+A_o+\frac{\Delta_a}{T_o}t$. To satisfy the lower bound of $B_t$ in \eqref{eqn:Yt bds}, we must ensure $Z_t+A_o+\frac{\Delta_a}{T_o}t\geq B_{\min}$. From \eqref{eqn:Z_{t+1}_lower bound}, it is sufficient  to let
$-VP_{b}^{\max}-\frac{\Delta_a}{T_o}-(D_{\max}-H_{\min})/\eta_d+A_o+\frac{\Delta_a}{T_o}t\geq B_{\min}$,
which means
\begin{align}\label{eqn:app A_o}
A_o\geq  B_{\min}+VP_{b}^{\max}\!+\!\frac{D_{\max}\!-\!H_{\min}}{\eta_d}+\frac{\Delta_a}{T_o}(1-t),
\end{align}
for all  $t\in [0, T_o]$.
We next determine the minimum possible value of $A_o$ based on the sign of $\Delta_a$.
\setcounter{subsubsection}{0}
\subsubsection{If $\Delta_a\geq0$} The minimum value of $A_o$ in \eqref{eqn:app A_o} is
\begin{align}\label{eqn:app A_o 1}
\hspace*{-.5em}A_{o,\min}&=B_{\min}+VP_{b}^{\max}+\frac{D_{\max}\!-\!H_{\min}}{\eta_d}+\frac{\Delta_a}{T_o}.
\end{align}
As a result, we have $A_t=A_{o,\min}+\frac{\Delta_a}{T_o}t$.


Based on Lemma \ref{app lemma bound of Z}.2), we have $S^*_{r,t}+Q^*_t=0$ if  $Z_t-\frac{\Delta_a}{T_o}>\max\{\eta_cH_{\max},|H_{\min}|/\eta_d-VP_{s}^{\min}\}-\frac{\Delta_a}{T_o}$, \ie no charging for the battery.
When $Z_t-\frac{\Delta_a}{T_o}\leq \max\{\eta_cH_{\max},|H_{\min}|/\eta_d-VP_{s}^{\min}\}-\frac{\Delta_a}{T_o}$, based on the maximum increment of $Z_t$ to $Z_{t+1}$ in \eqref{eqn:queue Z}, we have, for $t\in[0,T_o]$,
\begin{align}\label{eqn:Z_{t+1} upper bound}
\hspace*{-.5em}Z_t\leq \max\{\eta_cH_{\max},\frac{|H_{\min}|}{\eta_d}\!-\!VP_{s}^{\min}\}\!-\frac{\Delta_a}{T_o}\!+\eta_c R_{\max}.
\end{align}
Substituting $A_t$ with  $A_{o,\min}$ in \eqref{eqn:app A_o 1} into \eqref{eqn:dynamic shift Z}, and from \eqref{eqn:Z_{t+1} upper bound}, we have
\begin{align}\label{eqn:app2_Y_1}
B_t\leq& B_{\min}+\max\{\eta_cH_{\max},\frac{|H_{\min}|}{\eta_d}\!-VP_{s}^{\min}\}+\eta_cR_{\max}\nn\\
&+VP_{b}^{\max}+\frac{D_{\max}\!-\!H_{\min}}{\eta_d}+\frac{\Delta_a}{T_o}t.
\end{align}
For the control solution to be feasible, we need $B_t\le B_{\max}$. This is satisfied if RHS of \eqref{eqn:app2_Y_1} $\le B_{\max}$, for all $t\in [0,T_o]$. Using $H_{\min}$ and $H_{\max}$ expressions in  Lemma\ref{app lemma of H}, this means
\begin{align*}
&VP_b^{\max} \le \tilde{B}_t+\frac{H_{\min}}{\eta_d}-\max\{\eta_cH_{\max},\frac{|H_{\min}|}{\eta_d}-VP_{s}^{\min}\} \nn \\
&\le \tilde{B}_t-\frac{VC'(\Gamma)}{\eta_d}-\Gamma(\frac{1}{\eta_d}+\eta_c)\nn \\
&-\max\{0,\ V(\frac{C'(\Gamma)}{\eta_d}-P_{s}^{\min})+\Gamma(\frac{1}{\eta_d}-\eta_c)\} \nn \\
&=\!  \tilde{B}_t\!-\!\frac{VC'(\Gamma)\!-\!2\Gamma }{\eta_d}\!-\!\max\{\Gamma(\eta_c\!-\!\frac{1}{\eta_d}),  V(\frac{C'(\Gamma)}{\eta_d}\!-\!P_{s}^{\min})\}
\end{align*}
where $\tilde{B}_t\triangleq \! B_{\max}\!-B_{\min}\!-\eta_cR_{\max}\!-D_{\max}/\eta_d-\frac{\Delta_a}{T_o}t$.
To satisfy the above inequality, it is suffice that the following holds
\begin{align*}
VP_b^{\max} &\le\tilde{B}_t-\frac{VC'(\Gamma)-2\Gamma }{\eta_d}-V\max\{0,  (\frac{C'(\Gamma)}{\eta_d}-P_{s}^{\min})\},
\end{align*}
which is satisfied if $V\in (0,V_{\max}]$ with
\begin{align}\label{eqn:Vmax for delta_a>0}
V_{\max}=\frac{\tilde{B}_0-2\Gamma/\eta_d-\Delta_a}{P_{b}^{\max}+C'(\Gamma)/\eta_d+[C'(\Gamma)/\eta_d-P_{s}^{\min}]^+}.
\end{align}
%appear in \eqref{eqn:Vmax for delta_a>0}.
\subsubsection{If $\Delta_a<0$} The minimum value of $A_o$ in \eqref{eqn:app A_o} is \begin{align}\label{eqn:app A_o 2}
\hspace*{-.5em}A_{o,\min}=\!B_{\min}\!+\!VP_{b}^{\max}+\frac{D_{\max}-H_{\min}}{\eta_d}+\frac{\Delta_a}{T_o}-\Delta_a.
\end{align}
Substituting $A_{o,\min}$ in $A_t$, and  from \eqref{eqn:dynamic shift Z} and  \eqref{eqn:Z_{t+1} upper bound}, we have
\begin{align}\label{eqn:app2_Y_2}
B_t\leq& B_{\min}+\max\{\eta_cH_{\max},\frac{|H_{\min}|}{\eta_d}\!-VP_{s}^{\min}\}+\eta_cR_{\max}\nn\\
&+VP_{b}^{\max}+\frac{D_{\max}\!-\!H_{\min}}{\eta_d}-\Delta_a+\frac{\Delta_a}{T_o}t.
\end{align}
Again, to satisfy $B_t\le B_{\max}$, it is suffice that RHS of \eqref{eqn:app2_Y_2} $\le B_{\max}$. Using the similar analysis in the case of $\Delta_a\ge0$ , the bound  is satisfied if $V\in (0,V_{\max}]$ with
\begin{align}\label{eqn:Vmax for delta_a<0}
V_{\max}=\frac{\tilde{B}_0-2\Gamma/\eta_d-|\Delta_a|}{P_{b}^{\max}+C'(\Gamma)/\eta_d+[C'(\Gamma)/\eta_d-P_{s}^{\min}]^+}.
\end{align}
Combining \eqref{eqn:Vmax for delta_a>0} and \eqref{eqn:Vmax for delta_a<0} leads to  \eqref{eqn:V_max}, and from  \eqref{eqn:app A_o 1} or \eqref{eqn:app A_o 2}, we have $A_o$ in \eqref{eqn:A_o}.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Lower Bound  $B_t\geq B_{\min}.$}
We now show that using $A_{o,\min}$ in \eqref{eqn:app A_o 1} or \eqref{eqn:app A_o 2} for $\Delta_a\ge 0$ or $\Delta_a<0$, respectively, and $V\in (0,V_{\max}]$ with $V_{\max}$ in \eqref{eqn:Vmax for delta_a>0} or \eqref{eqn:Vmax for delta_a<0}, respectively, we have $B_t\ge B_{\min}$ for all $t$.
\setcounter{subsubsection}{0}
\subsubsection{If $\Delta_a\geq0$} Substitute $A_{o,\min}$ in \eqref{eqn:app A_o 1} in $A_t$, and $Z_t$ in \eqref{eqn:dynamic shift Z} into \eqref{eqn:Z_{t+1}_lower bound}, we have
 $B_{\min}+\frac{\Delta_a}{T_o}t\leq B_t$. Since $\frac{\Delta_a}{T_o}t>0$, for $t\in [0,T_o-1]$, $B_t\geq B_{\min}$ is satisfied for $\Delta_a\geq0$.

\subsubsection{If $\Delta_a<0$}
Substitute $A_{o,\min}$ in \eqref{eqn:app A_o 2} in $A_t$, and $Z_t$ in \eqref{eqn:dynamic shift Z} into \eqref{eqn:Z_{t+1}_lower bound}, we have
 $B_{\min}+\Delta_a(\frac{t}{T_o}-1)\leq B_t$.
Since $\Delta_a(\frac{t}{T_o}-1)>0$, for $t\in [0,T_o-1]$,  $B_t\geq B_{\min}$ is satisfied for $\Delta_a<0$.
\endIEEEproof


%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Proof of Theorem\ref{thm1}}\label{appD}
\IEEEproof
A $T$-slot sample path Lyapunov drift is defined by $\Delta_T(\Theta_t)\triangleq L(\Thetabf_{t+T})-L(\Thetabf_{t})$. We upper bound it as follows
{
\allowdisplaybreaks
\begin{align}\label{eqn:app3_Delta_T}
&\Delta_T(\Theta_t)
=\frac{1}{2}\left( Z^2_{t+T}-Z^2_{t}+H^2_{t+T}-H^2_{t}\right)\nn\\
&=Z_t\sum_{\tau=t}^{t+T-1}\left( \eta_c(Q_\tau+S_{r,\tau})-(F_{d,\tau}+F_{s,\tau})/\eta_d-\frac{\Delta_a}{T_o}\right)\nn\\
&\ +H_t\sum_{\tau=t}^{t+T-1}\left(\gamma_\tau-x_{u,\tau}\right)+\frac{1}{2}\left[\sum_{\tau=t}^{t+T-1}\left(\gamma_\tau-x_{u,\tau}\right)\right]^2\nn\\
&\quad+\frac{1}{2}\left[\sum_{\tau=t}^{t+T-1}\left(\eta_c(Q_\tau+S_{r,\tau})-(F_{d,\tau}+F_{s,\tau})/\eta_d-\frac{\Delta_a}{T_o}\right)\right]^2\nn\\
&\leq Z_t\sum_{\tau=t}^{t+T-1}\left(\eta_c(Q_\tau+S_{r,\tau})-(F_{d,\tau}+F_{s,\tau})/\eta_d-\frac{\Delta_a}{T_o}\right)\nn\\
&\quad+H_t\sum_{\tau=t}^{t+T-1}(\gamma_\tau-x_{u,\tau})+G T^2
\end{align}
}where $G$ is defined in Lemma\ref{lemma drift upper bound}.

Let $T_o=MT$. We consider a per-frame optimization problem below,
with the objective of minimizing the time-averaged system cost within the $m$th frame of length $T$ time slots.
\begin{align}
{\bf \textrm{\bf P}_f:} \; &\min_{\{\abf_t,\gamma_t\}} \;
\frac{1}{T}\sum_{t=mT}^{(m+1)T-1}[E_tP_{b,t}-(F_{s,t}+S_{s,t})P_{s,t}\nn\\
&\hspace{9em}+x_{e,t}+C(\gamma_t)]\nn\\
\rm{s.t} \;\;
&\eqref{eqn:Wt_constraint},\eqref{eqn:Solar S2 S3 bounds},\eqref{eqn:rc_dc_constr},
\eqref{eqn:rc_bds_strict},\eqref{eqn:dc_bds_strict},\eqref{avg_r=avg_x},\ \textnormal{and}\ \eqref{eqn:gamma_bds}.\nn
\end{align}

We show that ${\bf \textrm{\bf P}_f}$ is equivalent to {\bf P1} in which $T_o$ is replaced by $T$.
Let $u_m^f$ denote the minimum objective value of ${\bf \textrm{\bf P}_f}$. The optimal solution of {\bf P1} satisfies all constraints of ${\bf \textrm{\bf P}_f}$ and therefore is feasible to ${\bf \textrm{\bf P}_f}$. Thus, we have $u_m^f\leq u_m^\textrm{opt}$. By Jensen's inequality and convexity of $C(\cdot)$, we have $\overline{C(\gamma)}\geq C(\overline{\gamma})=C(\overline{x_u})$.
Note that introducing the auxiliary variable $\gamma_t$ with constraints \eqref{eqn:gamma_bds} and \eqref{avg_r=avg_x} does not modify the problem.
This means $u_m^f\ge u_m^\textrm{opt}$.
Hence, we have $u_m^f= u_m^\textrm{opt}$ and ${\bf \textrm{\bf P}_f}$ and {\bf P1} are equivalent.

From \eqref{eqn:app3_Delta_T} and the objective of ${\bf \textrm{\bf P}_f}$, we have the $T$-slot drift-plus-cost metric for the $m$th frame upper bounded by
\begin{align}\label{eqn:T slot drift plus penalty}
&\Delta_T(\Theta_t)\nn\\
& +V\!\!\!\sum_{t=mT}^{(m+1)T-1}[E_tP_{b,t}-(F_{s,t}+S_{s,t})P_{s,t}+x_{e,t}+C(\gamma_t)]\nn\\
&\leq Z_{t\!\!\!}\sum_{t=mT}^{(m+1)T-1}\!\!\!\left(\eta_c(Q_\tau+S_{r,\tau})-(F_{d,\tau}+F_{s,\tau})/\eta_d-\frac{\Delta_a}{T_o}\right)\nn\\
&\quad+H_{t}\!\!\!\sum_{t=mT}^{(m+1)T-1}\!\!\!\left(\gamma_t-x_{u,t}\right)+G T^2\nn\\
&+V\!\!\!\!\!\sum_{t=mT}^{(m+1)T-1}\!\!\!\!\![E_tP_{b,t}-(F_{s,t}+S_{s,t})P_{s,t}+x_{e,t}+C(\gamma_t)].
\end{align}
Let $\{\tilde{\abf}_t,\tilde{\gamma}_t\}$ denote a pair of feasible solution of ${\bf \textrm{\bf P}_f}$, satisfying the following relations
\begin{align}
&\hspace*{-.7em}\sum_{t=mT}^{(m+1)T-1}\!\!\!\!\!\! \eta_c\left(\tilde{Q}_t+\tilde{S}_{r,t}\right)=\!\!\!\sum_{t=mT}^{(m+1)T-1}\!\!\left(\frac{\tilde{F}_{d,t}+\tilde{F}_{s,t}}{\eta_d}+\frac{\Delta_a}{T_o}\right)\label{eqn:avg_rc_dc_bds_per_frame_1}\\
&\hspace*{-.7em}\sum_{t=mT}^{(m+1)T-1}\!\!\!\tilde{\gamma}_t=\sum_{t=mT}^{(m+1)T-1}\!\!\!\tilde{x}_{u,t}\label{eqn:avg_rc_dc_bds_per_frame_2}
\end{align}
with the corresponding objective value denoted as $\tilde{u}^f_m$.

Note that comparing with {\bf P1}, we impose per-frame constraints \eqref{eqn:avg_rc_dc_bds_per_frame_1} and \eqref{eqn:avg_rc_dc_bds_per_frame_2} as oppose to \eqref{eqn:delta_a} and \eqref{avg_r=avg_x} for the $T_o$-slot period.
Let $\delta\geq 0$ denote the gap of $\tilde{u}^f_m$ to the optimal objective value $u_m^\textrm{opt}$, \ie $\tilde{u}^f_m=u_m^\textrm{opt}+\delta$.

Among all feasible control solutions satisfying \eqref{eqn:avg_rc_dc_bds_per_frame_1} and \eqref{eqn:avg_rc_dc_bds_per_frame_2}, there exists a solution which leads to $\delta\rightarrow0$. The upper bound in \eqref{eqn:T slot drift plus penalty} can be rewritten as
\begin{align}\label{eqn:T slot drift plus penalty, per frame}
&\Delta_T(\Theta_t) +V\!\!\!\!\!\sum_{t=mT}^{(m+1)T-1}\!\!\!\!\![E_tP_{b,t}-(F_{s,t}+S_{s,t})P_{s,t}+x_{e,t}+C(\gamma_t)]\nn\\
&\leq G T^2+VT\lim_{\delta\rightarrow0}\left(u_m^\textrm{opt}+\delta\right)= G T^2+VTu_m^\textrm{opt}.
\end{align}
Summing both sides of \eqref{eqn:T slot drift plus penalty, per frame} over $m$ for $m=0,\ldots, M-1$, and dividing them by $VMT$, we have
{\small
\begin{align}\label{eqn:T slot drift plus penalty, 2}
&\frac{L(\Thetabf_{T_o})-L(\Thetabf_0)}{VMT}\nn\\
&\ +\frac{1}{MT}\sum_{m=0}^{M-1}\sum_{t=mT}^{(m+1)T-1}\!\!\!\!\![E_tP_{b,t}-(F_{s,t}+S_{s,t})P_{s,t}+x_{e,t}+C(\gamma_t)]\nn\\
&\leq
\frac{1}{M}\sum_{m=0}^{M-1}u_m^\textrm{opt}+\frac{G T}{V}.
\end{align}}

Since $\overline{C(\gamma)}\geq C(\overline{\gamma})$ for the convex function $C(\cdot)$ where $\overline{\gamma}\triangleq \frac{1}{T_o}\sum_{t=0}^{T_o-1}\gamma_t$, from \eqref{eqn:T slot drift plus penalty, 2}, we have
\begin{align}\label{eqn:T slot drift plus penalty, 3}
&\hspace*{-0.5em}\frac{1}{T_o}\sum_{t=0}^{T_o-1}[E_tP_{b,t}-(F_{s,t}+S_{s,t})P_{s,t}]+\overline{x_e}+C(\overline{\gamma})\nn\\
&\hspace*{-0.5em}\leq
\frac{1}{T_o}\sum_{t=0}^{T_o-1}[E_tP_{b,t}-(F_{s,t}+S_{s,t})P_{s,t}+x_{e,t}+C(\gamma_t)].
\end{align}
For a continuously differentiable convex function $f(\cdot)$, the following inequality holds \cite{book:Boyd&Vandenberghe}
\begin{align}\label{eqn:app3 convex}
f(x)\geq f(y)+f'(y)(x-y).
\end{align}
Applying \eqref{eqn:app3 convex} to $C(\overline{x_u})$ and $C(\overline{\gamma})$, we have
\begin{align}\label{eqn:app3 convex2}
C(\overline{x_u})
&\leq C(\overline{\gamma})+C'(\overline{x_u})(\overline{x_u}-\overline{\gamma})
%&=C(\overline{\gamma})+C'(\overline{x_u})(\overline{x_u}-\overline{\gamma})\nn\\
\leq C(\overline{\gamma})+C'(\Gamma)(\overline{x_u}-\overline{\gamma})\nn\\
&=C(\overline{\gamma})-C'(\Gamma)\frac{H_{T_o}-H_0}{T_o}
\end{align}
where the last term in \eqref{eqn:app3 convex2} is obtained by summing both sides of \eqref{eqn:queue H} over $T_o$.

Applying the inequality \eqref{eqn:app3 convex2} to $C(\overline{\gamma})$ at the LHS of \eqref{eqn:T slot drift plus penalty, 3}, and further applying the inequality \eqref{eqn:T slot drift plus penalty, 3} to the LHS of \eqref{eqn:T slot drift plus penalty, 2}, we have the  bound of the objective value $u^*(V)$ of {\bf P1} achieved by Algorithm\ref{alg1}
as in \eqref{thm1:bd}.

For the bound in \eqref{thm1:bd}, note that $H_t$ is bounded as in \eqref{eqn:app H bound}, and $Z_t$ is bounded by \eqref{eqn:Z_{t+1}_lower bound} and \eqref{eqn:Z_{t+1} upper bound}. It follows that $L(\Thetabf_{t})$ is bounded. As $T_o\rightarrow\infty$, we have $\frac{C'(\Gamma)(H_{0}-H_{T_o})}{T_o}\rightarrow0$ and $\frac{L(\Thetabf_{0})-L(\Thetabf_{T_o})}{VT_o}\rightarrow0$, and  \eqref{thm1:bd_longterm} follows.
\endIEEEproof

\section{Proof of Proposition\ref{prop3}}\label{appE}
\IEEEproof
For $t=T_o$, from the dynamic shifting in \eqref{eqn:dynamic shift Z}, we have $Z_{T_o}=B_{T_0}-A_o-\Delta_a$. For $t=0$, we have $Z_{0}=B_{0}-A_o$. Thus, we have the following relation: $\frac{1}{T_o}(Z_{T_o}-Z_{0})=\frac{1}{T_o}(B_{T_o}-B_{0})-\frac{\Delta_a}{T_o}$. Substituting the first equation in \eqref{eqn:delta_a} into the above, we have
\begin{align*}%\label{eqn:app4_Z_2}
\frac{Z_{T_o}-Z_{0}}{T_o}=\frac{\sum_{\tau=0}^{T_o-1}[\eta_c(Q_\tau+S_{r,\tau})-\frac{F_{d,\tau}+F_{s,\tau}}{\eta_d}]-\Delta_a}{T_o}.
\end{align*}
Note that  $Z_t$ in \eqref{eqn:queue Z} is derived from  the above.
Since this finite time horizon algorithm, \eqref{eqn:delta_a} is satisfied with error $\epsilon=Z_{T_o}-Z_{0}$.
Because $Z_t$ is bounded by \eqref{eqn:Z_{t+1}_lower bound} and \eqref{eqn:Z_{t+1} upper bound} and $H_t$ is bounded by \eqref{eqn:app H bound}, the error $\epsilon$ has the following upper bound
\begin{align}
|\epsilon|%&=|Z_{T_o}-Z_0|\nn \\
&\leq \max\{\eta_cH_{\max},|H_{\min}|/\eta_d-VP_{s}^{\min}\}+\eta_cR_{\max}\nn\\
&\quad +VP_{b}^{\max}-H_{\min}/\eta_d+D_{\max}/\eta_d\nn\\
%&\leq H_{\max}+\eta_cR_{\max}+VP_{\max}-H_{\min}/\eta_d+D_{\max}/\eta_d\nn\\
&\leq \max\{H_{\max}/\eta_d+|H_{\min}|/\eta_d, 2|H_{\min}|/\eta_d-VP_{s}^{\min}\}\nn\\
&\hspace{2em}+VP_{b}^{\max}+\eta_cR_{\max}+D_{\max}/\eta_d. \nn \\
&=(2\Gamma+VC'(\Gamma))/\eta_d+\max\{0,VC'(\Gamma)/\eta_d-VP_{s}^{\min}\}\nn \\
&\quad+VP_{b}^{\max}+\eta_cR_{\max}+D_{\max}/\eta_d.
\end{align}
Thus, we complete the proof.
\endIEEEproof

\section{Proof of Proposition \ref{prop E times P zero}}\label{app E times P zero}
\IEEEproof
To ensure \eqref{equ:sell buy constraint} is satisfied, we must show the optimal control solution \eqref{case a}-\eqref{case f} in Proposition\ref{prop0} can ensure \eqref{equ:sell buy constraint} being satisfied.
For Cases 1, 2 and 4, from their optimal control solutions \eqref{case a}, \eqref{case c} and \eqref{case f}, it is easy to see that \eqref{equ:sell buy constraint} is satisfied.
For Cases 3 and 5, from their optimal control solutions \eqref{case b 1} or \eqref{case b 2} and \eqref{case d 2} or \eqref{case d 3}, if $F^\w_{d,t}=W_t-S_{w,t}<D_{\max}$,  $E^\w_t=0$ and $F_{s,t}\geq0$; If $F^\w_{d,t}=D_{\max}$, we have $F^\w_{s,t}=0$ and $E^\w_t\geq0$.
If the battery is in the idle state, we always have $F_{s,t}^\textrm{id}=0$. Thus, \eqref{equ:sell buy constraint} is a sufficient condition for Algorithm\ref{alg1}.
\endIEEEproof

%\def\BibHome{D:/Dropbox/Research/Publications/Bibs}
%\bibliographystyle{IEEEtran}
%\bibliography{IEEEabrv,\BibHome/master,mybibfile}
% Generated by IEEEtran.bst, version: 1.14 (2015/08/26)
\begin{thebibliography}{10}
\providecommand{\url}[1]{#1}
\csname url@samestyle\endcsname
\providecommand{\newblock}{\relax}
\providecommand{\bibinfo}[2]{#2}
\providecommand{\BIBentrySTDinterwordspacing}{\spaceskip=0pt\relax}
\providecommand{\BIBentryALTinterwordstretchfactor}{4}
\providecommand{\BIBentryALTinterwordspacing}{\spaceskip=\fontdimen2\font plus
\BIBentryALTinterwordstretchfactor\fontdimen3\font minus
  \fontdimen4\font\relax}
\providecommand{\BIBforeignlanguage}[2]{{%
\expandafter\ifx\csname l@#1\endcsname\relax
\typeout{** WARNING: IEEEtran.bst: No hyphenation pattern has been}%
\typeout{** loaded for the language `#1'. Using the pattern for}%
\typeout{** the default language instead.}%
\else
\language=\csname l@#1\endcsname
\fi
#2}}
\providecommand{\BIBdecl}{\relax}
\BIBdecl

\bibitem{dek10}
P.Denholm, E.Ela, B.Kirby, and M.Milligan, ``The role of energy storage
  with renewable electricity generation,'' National Renewable Energy
  Laboratory, Tech. Rep. NREL/TP-6A2-47187, Jan. 2010.

\bibitem{CastilloGayme:Elsevier14}
A.Castillo and D.F. Gayme, ``Grid-scale energy storage applications in
  renewable energy integration: A survey,'' \emph{Energy Convers. Manage},
  vol.87, pp. 885--894, Nov. 2014.

\bibitem{SuGamal:TPS13}
H.-I. Su and A.ElGamal, ``Modeling and analysis of the role of energy storage
  for renewable integration: Power balancing,'' \emph{IEEE Trans. Power Syst.},
  vol.28, pp. 4109--4117, Nov. 2013.

\bibitem{SunDongLiang:JSTSP14}
S.Sun, M.Dong, and B.Liang, ``Real-time power balancing in electric grids
  with distributed storage,'' \emph{IEEE J. Select. Topics Signal Processing},
  vol.8, pp. 1167--1181, Dec. 2014.

\bibitem{SunLiangDongTaylor:TPS16}
S.Sun, B.Liang, M.Dong, and J.A. Taylor, ``Phase balancing using energy
  storage in power grids under uncertainty,'' \emph{{IEEE} Trans. Power Syst.},
  vol.31, no.5, pp. 3891--3903, Sep. 2016.

\bibitem{SunDongLiang:TSG16}
S.Sun, M.Dong, and B.Liang, ``Distributed real-time power balancing in
  renewable-integrated power grids with storage and flexible loads,''
  \emph{{IEEE} Trans. Smart Grid}, vol.7, no.5, pp. 2337--2349, Sep. 2016.

\bibitem{ZhangGatsis_TSE13}
Y.Zhang, N.Gatsis, and G.Giannakis, ``Robust energy management for
  microgrids with high-penetration renewables,'' \emph{IEEE Trans. Sustain.
  Energy}, vol.4, pp. 944--953, Oct 2013.

\bibitem{Faruquietal:ElectrJ09}
A.Faruqui, R.Hledik, and J.Tsoukalis, ``The power of dynamic pricing,''
  \emph{Electr. J.}, vol.22, no.3, pp. 42--56, 2009.

\bibitem{Wong&Sen&Ha&Chiang:JSAC2012}
C.Joe-Wong, S.Sen, S.Ha, and M.Chiang, ``Optimized day-ahead pricing for
  smart grids with device-specific scheduling flexibility,'' \emph{{IEEE} J.
  Sel. Areas Commun.}, vol.30, pp. 1075--1085, Jul. 2012.

\bibitem{Wang&etal:TSG14}
Y.Wang, X.Lin, and M.Pedram, ``Adaptive control for energy storage systems
  in households with photovoltaic modules,'' \emph{{IEEE} Trans. Smart Grid},
  vol.5, no.2, pp. 992--1001, Mar. 2014.

\bibitem{He&Zhang_TSG12}
M.He, S.Murugesan, and J.Zhang, ``A multi-timescale scheduling approach for
  stochastic reliability in smart grids with wind generation and opportunistic
  demand,'' \emph{{IEEE} Trans. Smart Grid}, vol.4, pp. 521--529, Mar. 2013.

\bibitem{Li&Dong:JSAC15}
T.Li and M.Dong, ``Real-time energy storage management with renewable
  integration: Finite-time horizon approach,'' \emph{{IEEE} J. Sel. Areas
  Commun.}, vol.33, no.12, pp. 2524--2539, Dec. 2015.

\bibitem{Li&Dong:TSG16}
------, ``Real-time residential-side joint energy storage management and load scheduling with renewable integration,'' \emph{{IEEE} Trans. Smart Grid},
vol.9, pp. 283-298, Jan. 2018.

\bibitem{Zhang&Schaar:JTSP14}
Y.Zhang and M.vander Schaar, ``Structure-aware stochastic storage management
  in smart grids,'' \emph{{IEEE} J. Sel. Topics Signal Process.}, vol.8, pp.
  1098--1110, Dec. 2014.

\bibitem{MoghadamZhangMa:SGCOM14}
M.R.V. Moghadam, R.Zhang, and R.T.B. Ma, ``Demand response for contingency
  management via real-time pricing in smart grids,'' in \emph{Proc. {IEEE} Int.
  Conf. Smart Grid Commun. (SmartGridComm)}, Nov. 2014, pp. 632--637.

\bibitem{ackermann2001overview}
T.Ackermann, G.Andersson, and L.S{\"o}der, ``Overview of government and
  market driven programs for the promotion of renewable power generation,''
  \emph{Renewable Energy}, vol.22, no. 1-3, pp. 197--204, 2001.

\bibitem{Urgaonkar&Neely:SIGMETRICS2011}
R.Urgaonkar, B.Urgaonkar, M.J. Neely, and A.Sivasubramaniam, ``Optimal
  power cost management using stored energy in data centers,'' in \emph{Proc.
  ACM SIGMETRICS}, Jun. 2011.

\bibitem{RahbarXu:TSG15}
K.Rahbar, J.Xu, and R.Zhang, ``Real-time energy storage management for
  renewable integration in microgrid: An off-line optimization approach,''
  \emph{{IEEE} Trans. Smart Grid}, vol.6, pp. 124--134, Jan 2015.

\bibitem{Huang&Walrand&Ramchandran:SmatGridComm12}
L.Huang, J.Walrand, and K.Ramchandran, ``Optimal demand response with energy
  storage management,'' in \emph{Proc. IEEE SmartGridComm}, 2012.

\bibitem{Sergio&Ming&Pan&Yong_TSG13}
S.Salinas, M.Li, P.Li, and Y.Fu, ``Dynamic energy management for the smart
  grid with distributed energy resources,'' \emph{{IEEE} Trans. Smart Grid},
  vol.4, pp. 2139--2151, Sep. 2013.

\bibitem{Li&Dong:ICASSP2013}
T.Li and M.Dong, ``Online control for energy storage management with
  renewable energy integration,'' in \emph{Proc. IEEE Int. Conf. Acoust. Speech Signal Process. (ICASSP)}, May 2013.

\bibitem{Li&Dong:acssc2013}
------, ``Real-time energy storage management with renewable energy of
  arbitrary generation dynamics,'' in \emph{Proc. Asilomar Conf. Signals Syst. Comput.}, Nov. 2013.

\bibitem{Li&Dong:SmartGridComm14}
------, ``Real-time energy storage management: Finite-time horizon approach,''
  in \emph{Proc. {IEEE} Int. Conf. Smart Grid Commun. (SmartGridComm)}, Nov.
  2014, pp. 115--120.

\bibitem{Qinetal:TSG16}
J.Qin, Y.Chow, J.Yang, and R.Rajagopal, ``Distributed online modified
  greedy algorithm for networked storage operation under uncertainty,''
  \emph{{IEEE} Trans. Smart Grid}, vol.7, no.2, pp. 1106--1118, Mar. 2016.

\bibitem{book:Neely}
M.J. Neely, \emph{Stochastic Network Optimization with Application to
  Communication and Queueing Systems}.\hskip 1em plus 0.5em minus 0.4em\relax
  Morgan \& Claypool, 2010.

\bibitem{Kimetal:JSAC13}
B.G. Kim, S.Ren, M.vander Schaar, and J.W. Lee, ``Bidirectional energy
  trading and residential load scheduling with electric vehicles in the smart
  grid,'' \emph{{IEEE} J. Sel. Areas Commun.}, vol.31, no.7, pp. 1219--1234,
  Jul. 2013.

\bibitem{Mediwaththe&etal:TSG17}
C.Mediwaththe, E.Stephens, D.Smith, and A.Mahanti, ``Competitive energy
  trading framework for demand-side management in neighborhood area networks,''
  \emph{{IEEE} Trans. Smart Grid}, 2017.

\bibitem{Huang&Mao&Nelms:J_SmartGrid2014}
Y.Huang, S.Mao, and R.Nelms, ``Adaptive electricity scheduling in
  microgrids,'' \emph{{IEEE} Trans. Smart Grid}, vol.5, pp. 270--281, Jan.
  2014.

\bibitem{Ramadrass:JPS02}
P.Ramadass, B.Haran, R.White, and B.N. Popov, ``Performance study of
  commercial {LiCoO2} and spinel-based {Li-ion} cells,'' \emph{J. Power
  Sources}, vol. 111, pp. 210--220, Sep. 2002.

\bibitem{Shi&etal:ArXiv2017}
Y.Shi, B.Xu, Y.Tan, and B.Zhang, ``A convex cycle-based degradation model
  for battery energy storage planning and operation,'' arXiv:1703.07968, Tech. Rep., Mar. 2017. [Online]. Available:  https://arxiv.org/abs/1703.07968.

\bibitem{Neely:ArXiv2010}
M.J. Neely, ``Universal scheduling for networks with arbitrary traffic,
  channels, and mobility,'' arXiv:1001.0960, Tech. Rep., Jan. 2010. [Online]. Available: https://arxiv.org/abs/1001.0960.

\bibitem{website:Ontario_Elec}
\BIBentryALTinterwordspacing
``Electricity prices,'' Ontario Energy Board, 2012. [Online]. Available:
  \url{http://www.ontarioenergyboard.ca/OEB/Consumers/Electricity}
\BIBentrySTDinterwordspacing

\bibitem{book:Boyd&Vandenberghe}
S.Boyd and L.Vandenberghe, \emph{Convex Optimization}.\hskip 1em plus 0.5em
  minus 0.4em\relax Cambridge University Press, 2004.

\end{thebibliography}




\end{document}

