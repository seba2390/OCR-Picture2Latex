\section{Network-Level Simulation} \label{sec:network}
%\textcolor{red}{
%SJ to do:
%\begin{itemize}
%    \item Describe the network topology with the two carriers
%    \item Create a table with all the parameters
%    \item Describe the channel model
%    \item Describe the arrays, how you performed cell association
%    \item Describe how you computed the SNR
%    \item Show the SNR and rate CDFs
%\end{itemize}}
The above analysis shows that the performance of the RFFE
degrades in the presence of strong out-of-band
interference when the front-end dynamic range is low.
This fact raises a basic question:  \emph{how often
is the adjacent carrier interference strong in practical 
systems?}  In this section, we perform a simple network simulation
to assess the effect of adjacent carrier interference in 
a downlink cellular system with two 
adjacent carriers, carriers A and B.

We take account of a wrap-around \SI{1}{km}~$\times$~\SI{1}{km} network area to conduct the network-level simulation. Subject to a inter-site distance (ISD), gNBs are deployed by homogeneous Poisson point process (HPPP) with density $\lambda = \frac{4}{\pi\times\text{ISD}^2}$, and accordingly, the same number of UEs are uniformly distributed. Furthermore, all gNBs and UEs are 
randomly assigned to carrier A or B.
We use the notation $\text{gNB}_{A}$ and $\text{gNB}_{B}$ for base stations, and  $\text{UE}_{A}$ and $\text{UE}_{B}$ for UEs.
Individual gNBs are multi-sectorized with $8\times8$ uniform rectangular arrays (URA) per sector which is tilted down by $-12^\circ$, while each UE is equiped with a URA. The full 
parameter settings are shown in Table~\ref{tab:sim_param}. 

\begin{figure}[t]
    \centering
    \include{tex/topology}
    \caption{Signal and interfering
    paths in a system with two carriers.}
    \label{fig:network}
\end{figure}

Fig.~\ref{fig:network} shows the scenario for analyzing the interference between adjacent carrier frequencies. A UE in carrier A 
will receive the desired signal from its serving BS and interference signal from non-serving
BSs in
carrier A in the same carrier and
from all BSs in carrier B.

\begin{figure*}[t]
\centering
    \subfigure[\SI{28}{GHz}]{\includegraphics[width=0.49\linewidth]{fig/snr_28-eps-converted-to.pdf}}
    \subfigure[\SI{140}{GHz}]{\includegraphics[width=0.49\linewidth]{fig/snr_140-eps-converted-to.pdf}}
    
 \caption{Estimated distribution of downlink SNRs with different carrier frequencies
    and different RFFE designs.  The plots
    show the SNR under the full model
    \eqref{eq:SNR} with distortion from
    adjacent carrier interference and 
    in-band signal; the SNR 
    with no adjacent carrier interference distortion ($\alpha_2=0)$; and
    the SNR with no in-band or
    adjacent carrier interference distortion ($\alpha_1=\alpha_2=0)$.}
  \label{fig:snr_distributions}
\end{figure*}

% \begin{figure*}[t]
%     \centering
%     \subfigure[\SI{28}{GHz}]{\includegraphics[width=0.45\linewidth]{fig/rate_28.eps}}
%     \subfigure[\SI{140}{GHz}]{\includegraphics[width=0.45\linewidth]{fig/rate_140.eps}}
%     \caption{Estimated distribution of the downlink rates for different carrier frequencies and RFFE designs.  }
%     \label{fig:rate_distributions}
% \end{figure*}

For every gNB-UE pair, we generate a multi-path channel for two different frequency cases, \SI{28}{GHz} and \SI{140}{GHz},  according to~\cite{3GPP38.901} and compute the SNR for downlink case. 
Specifically, we employ the path-loss model specified in~\cite{3GPP38.901} for the Urban Micro Street Canyon (Umi-Street-Canyon) environment. The 3GPP NR standard is very flexible and we assume the channel models described in
\cite{3GPP38.901} will hold for the \SI{140}{GHz} communication systems.
% Since the channel model of \SI{140}{GHz} carrier frequency is not known, we assume that the legacy 3GPP channel model in \cite{3GPP38.901} is still valid at \SI{140}{GHz}. 

Within each carrier, we then assume that each UE
is served by the strongest gNB.  As a simplification, 
the gNBs and UEs then beamform
along the strongest path with no regard to
interference nulling to other UEs.  
A sufficient number of UEs are dropped such
that we can obtain one UE served by each
sector in each gNB.  Hence, the simulation
drop represents one point in time where
each gNB is using its entire bandwidth 
on one UE.

With the channels and beamforming
direction, we can then estimate the effective
SINR at each UE.  
Following the model \eqref{eq:gamout},
we estimate the SINR as:
\begin{equation}
\label{eq:SNR}
    \gamma = \frac{\beta E_\mathrm{sig}^{a}}{E_\mathrm{kT} +
    \alpha_{1}E_\mathrm{tot}^{a} + \alpha_{2}E_\mathrm{tot}^{b}}.
\end{equation}
Here, $E_\mathrm{sig}^{a}$ 
and $E_\mathrm{int}^a$ 
is the energy 
per sample of the serving and interfering
signals including the beamforming and
element gains at the TX and RX,
and $E_\mathrm{kT}$ is the thermal noise.
The distortion from the non-linearities
is modeled by two terms:
$\alpha_{1}E_\mathrm{tot}^{a}$ captures
the distortion from the total power from all base stations in carrier A (serving and non-serving); $\alpha_{2}E_\mathrm{tot}^{b}$
captures the distortion from
the total power from all base stations
in the adjacent carrier, carrier B.
For these terms, we assume that the distortion
is spatially white so we do not 
add the RX beamforming gains on each path.
The terms however do include the TX element
and beamforming gains as well as the RX element
gain.

\begin{table}[t]
    \centering
    \caption{Network simulation parameters.}
    \setlength{\tabcolsep}{3pt}
    \label{tab:sim_param}
    \begin{tabular}{|>{\raggedright}m{1.6in}|c|c|}
        \hline
        \textbf{Parameter} & \multicolumn{2}{c|}{\textbf{Value}}
        \tabularnewline \hline
      
        Carrier frequency, [\SI{}{\GHz}] & $28$ & $140$
        \tabularnewline
        
        Total bandwidth, [\SI{}{\MHz}] & $190.80$ & $380.16$
        \tabularnewline 
        
        Sample rate, %$f_s$,
        [\SI{}{\MHz}] & $491.52$ & $1966.08$
        \tabularnewline 
        
        gNB antenna configuration &{$8\times8$} & {$16\times16$}
        \tabularnewline
        UE antenna configuration &{$4\times4$}& {$8\times8$}
        \tabularnewline \cline{2-3}
        
        Area [\SI{}{\meter}$^2$]  &  \multicolumn{2}{c|}{$1000 \times 1000 $}
        \tabularnewline
        
        UE and gNB min. distance [\SI{}{\meter}] &  \multicolumn{2}{c|}{$10$}
        \tabularnewline
        
        ISD [\SI{}{\meter}] & \multicolumn{2}{c|}{$200$}
        \tabularnewline
        
        gNB height [\SI{}{\meter}] &  \multicolumn{2}{c|}{$\ncalU(2,5)$}
        \tabularnewline
        
        UE height [\SI{}{\meter}] &  \multicolumn{2}{c|}{$1.6$}
        \tabularnewline
        
        gNB TX power [\SI{}{dBm}] & \multicolumn{2}{c|}{$30$}
        \tabularnewline
        
        gNB downtilt angle & \multicolumn{2}{c|}{$-12^\circ$}
        \tabularnewline
        
        gNB number of sectors & \multicolumn{2}{c|}{$3$}
        \tabularnewline
        
        Vertical half-power beamwidth %[$\theta_{\text{3dB}}$] 
        & \multicolumn{2}{c|}{$65^\circ$}
        \tabularnewline
        
        Horizontal half-power beamwidth % [$\phi_{\text{3dB}}$]
        & \multicolumn{2}{c|}{$65^\circ$}
        \tabularnewline \hline
    \end{tabular}
\end{table}


% Sundeep's notes:
% \begin{itemize}
%     \item $E_{\rm sig} = P_A T$ where $T=1/f_{s}$.
% \end{itemize}

Fig.~\ref{fig:snr_distributions} shows the SNR distributions  for the designs discussed in Section~\ref{sec:link} at \SI{28}{GHz} and \SI{140}{GHz}. As a performance benchmark,
we compare the SNR distribution under three models:
\begin{itemize}
    \item SNR with adjacent carrier interference and in-band distortion:  This is the model
    \eqref{eq:SNR} with the parameters
    for $\alpha_1$ and $\alpha_2$ in
    Table~\ref{tab:model_param} found from
    the circuit simulations.  The
    resulting SNR CDF is shown
    in the dashed line in Fig.~\ref{fig:snr_distributions}.
    
    \item SNR with no adjacent carrier interference and in-band distortion:  
    This is the model
    \eqref{eq:SNR} with the parameters
    for $\alpha_1$ in
    Table~\ref{tab:model_param} but
    $\alpha_2 = 0$.  The SNR CDF is shown in the
    dotted line in Fig.~\ref{fig:snr_distributions}.
    
    \item SNR with no adjacent carrier interference and  no in-band distortion:  
    This is the model
    \eqref{eq:SNR} with the parameters
    for $\alpha_1=\alpha_2=0$.  
    The resulting SNR CDF is shown in the
    solid line in Fig.~\ref{fig:snr_distributions}.

    
\end{itemize}
%we show an upper bound of the SNR considering a linear system that includes only the NF from the RFFE devices without any distortion (solid line).
%That is, the SNR in \eqref{eq:SNR} with
%$\alpha_1=\alpha_2=0$ so the effect of the
%distortion is removed.
% Similarly Fig.~\ref{fig:rate_distributions} shows the downlink rate distributions  for the designs discussed in Section~\ref{sec:link} at \SI{28}{GHz} and \SI{140}{GHz}.

Comparing the plots, we observe that the impact of distortion from adjacent carrier interference  is negligible.   This suggests that for these parameters,
there may be no need for extra filtering in the RF/IF or baseband to suppress the adjacent carrier interference.   Thus, we can conclude that by optimizing the RFFE devices and reducing the dynamic range of the system, we can improve the energy efficiency without being vulnerable from the adjacent carrier interference. Furthermore, as expected the designs at \SI{28}{GHz} have lower saturation points comparing to the \SI{140}{GHz} designs, %as they have lower number of antennas and so lower beamforming gain
due to the difference in the beamforming gain resulted from the difference in the number of antennas.

As explained in Section~\ref{sec:link}, at \SI{140}{GHz} we expect the designs to have different performance. In the low-SNR regime Design$^{(1)}$ performs better due to the lower NF, while Design$^{(2)}$ performs better in the high-SNR regime due to the larger number of ADC bits.

% \textcolor{blue}{[SR: I think the rate plots
% are wrong.  It looks like you are computing the
% rate via, $R=B \log_2(1 + \gamma)$.  This allows
% the rate to be very high since the system can
% benefit from very high SNRs.  But, 
% a more realistic model is:
% $R = B \max\{\rho_{\rm max},\alpha \log(1 + \gamma) \}$ where $\alpha=0.6$ and $\rho_{\rm max} = 4.5$ bps/Hz.  
% You should remove the plot, or correct it.]}

% mainly because of the beamforming gains

% We observe that the effect of adjacent carrier interference is negligible, and the SNR values are strongly affected by distortion instead. 

% In comparison with two carrier frequencies, \SI{28}{GHz} and \SI {140}{GHz}, the interference effects are largely imperceptible at \SI{140}{GHz} because of the shorter beam width at higher frequencies. In addition, we leverage the larger number of antenna arrays for \SI{140}{GHz} than \SI{28}{GHz}, which leads to larger saturation point of SNR values caused by the signal distortion than the case of \SI{28}{GHz}. \\
% \textcolor{red}{ 1) we need to explain the SNR gap in 140GHz for linear case and 2) the relationship between the signal distortion and frequency; why 140GHz shows little distortion effect compared to 28GHz case. 3) we might add the the saturation point for each frequency is reasonable considering access paper and antenna configurations, and more explanation. }





%% Notes for SNR plot 
% Desgin (i) = RFFE non linear distortion + interference
% Design (i) (w/o interference) = non-linear rffe w/o the presence of interference.
% Design (i) (linear) = linear RFFE no intereference 
% SJ: Let me know if you have any questions.

%In comparison with \SI{28}{GHz} case, the SNR values of \SI{140}{GHz} saturates at larger 

% \begin{figure*}[t]
% \centering
%     \subfigure[\SI{28}{GHz}]{\includegraphics[width=0.49\textwidth]{fig/snr_28.eps}}
%     \subfigure[\SI{140}{GHz}]{\includegraphics[width=\columnwidth]{fig/snr_140.eps}}
%   \caption{Rate distribution for two different frequency cases}
%   \label{fig:rate_distributions}
% \end{figure*}

%\textcolor{red}{
%Comments for SJ:
%\begin{itemize}
%    \item Explain beamforming in the simulation setup.
%    \item Elaborate on path loss
%    \item Explain figure 5 and 6
%\end{itemize}
%}