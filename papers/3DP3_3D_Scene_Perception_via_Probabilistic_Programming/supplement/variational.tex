\section{Distilling shape distributions via variational inference}

Recall that:
\begin{equation}
p'(\mathbf{O} | \mathbf{I}_{1:T})
= \sum_{k=1}^K w_k p'(\mathbf{O} | \mathbf{M}^{(k)}, \mathbf{x}_{1:T}^{(k)}, \mathbf{I}_{1:T})
\end{equation}
Consider the following variational family:
\begin{equation}
q_{\varphi}(\mathbf{O}) := \prod_{i\in[h]} \prod_{j\in[w]} \prod_{\ell\in[l]} \varphi_{ij\ell}^{O_{ij\ell}} \cdot (1 - \varphi_{ij\ell})^{(1-O_{ij\ell})}
\end{equation}
where each $0 \le \varphi_{ij\ell} \le 1$ can be interpreted as a per-voxel occupancy probability.
Then
\begin{align*}
\mathrm{KL}(p'(\mathbf{O} | \mathbf{I}_{1:T}) || q_{\varphi}(\mathbf{O}))
&= \mathbb{E}_{\mathbf{O} \sim p'(\cdot | \mathbf{I}_{1:T})} \left[
    \log \frac{
        p'(\mathbf{O} | \mathbf{I}_{1:T})
    }{
        q_{\varphi}(\mathbf{O})
    }
    \right]
\end{align*}
Note that minimizing this KL divergence with respect to $\varphi$ is equivalent to maximizing the following quantity:
\begin{align*}
& \mathbb{E}_{\mathbf{O} \sim p'(\cdot | \mathbf{I}_{1:T})} \left[
        \log q_{\varphi}(\mathbf{O})
    \right]\\
&= \sum_{k=1}^K w_k 
    \mathbb{E}_{\mathbf{O} \sim p'(\cdot | \mathbf{M}^{(k)}, \mathbf{x}_{1:T}^{(k)}, \mathbf{I}_{1:T})} \left[
            \log q_{\varphi}(\mathbf{O})
\right]\\
&= \sum_{k=1}^K w_k 
    \mathbb{E}_{\mathbf{O} \sim p'(\cdot | \mathbf{M}^{(k)}, \mathbf{x}_{1:T}^{(k)}, \mathbf{I}_{1:T})} \left[
    \sum_{i \in [h]} \sum_{j \in [w]} \sum_{\ell \in [l]} \log q_{\varphi}(O_{ij\ell})
\right]\\
&= \sum_{k=1}^K w_k 
    \mathbb{E}_{\mathbf{O} \sim p'(\cdot | \mathbf{M}^{(k)}, \mathbf{x}_{1:T}^{(k)}, \mathbf{I}_{1:T})} \left[
    \sum_{i \in [h]} \sum_{j \in [w]} \sum_{\ell \in [l]} O_{ij\ell}\log \varphi_{ij\ell} + (1 - O_{ij\ell}) \log (1 - \varphi_{ij\ell})
\right]\\
&= 
\sum_{i \in [h]} \sum_{j \in [w]} \sum_{\ell \in [l]} 
\sum_{k=1}^K w_k 
    p'(O_{ij\ell} = 1 | \mathbf{M}^{(k)}, \mathbf{x}_{1:T}^{(k)}, \mathbf{I}_{1:T})
    \log \varphi_{ij\ell}
    + p'(O_{ij\ell} = 0 | \mathbf{M}^{(k)}, \mathbf{x}_{1:T}^{(k)}, \mathbf{I}_{1:T})
    \log (1 - \varphi_{ij\ell})
\end{align*}
The optimization decomposes into separate problems for each $\varphi_{ij\ell}$, with global optimum:
\begin{align*}
\varphi_{ij\ell}^* = \sum_{k=1}^K w_k p'(O_{ij\ell} = 1 | \mathbf{M}^{(k)}, \mathbf{x}_{1:T}^{(k)}, \mathbf{I}_{1:T})
\end{align*}
