\section{Introduction}

% (1) Discuss merge conflict problem
Collaborative software development relies on version control systems such as \texttt{git} to manage and track changes across a codebase. In most projects, developers work primarily in a branch of a software repository, periodically synchronizing their code changes with the \texttt{main} branch via merges and pull requests~\citep{gousios2016work}. When multiple developers make concurrent changes to the same line of code, a merge conflict may occur.
Merge commits occur frequently, almost 12\% of all commits are related to a merge~\cite{ghiotto2018nature}, and up to 46\% of those commits result in conflicts. Resolving merge conflicts is a time-consuming, complicated, and error-prone activity~\cite{bird2012assessing}. 
To resolve a conflict, developers must stop their workflow, understand conflicting changes, and identify a correct resolution. The ideal way to resolve a conflict is not always clear, and may require referring to project specification documentation or communicating with their peers about changes~\cite{brun2011proactive,de2019recommending,nelson2019life,guimaraes2012improving,bird2012assessing}. 

%(2) Modern merge tools
Modern version control systems such as \texttt{git} utilize the \texttt{diff3} algorithm for performing unstructured line-based three-way merge of input files~\citep{smith-98}. Thus, it is the \emph{de facto} tool for merging and identifying merge conflicts in software development.
This algorithm aligns the two-way diffs of two versions of the code, $\mathcal{A}$ and $\mathcal{B}$, with the common base, $\mathcal{O}$, into a sequence of diff ``slots''.  
At each slot, a change from either $\mathcal{A}$ or $\mathcal{B}$ is selected. 
In cases where both $\mathcal{A}$ \textbf{and} $\mathcal{B}$ contain changes (relative to $\mathcal{O}$) in the same slot (e.g., on the same line), there is a merge conflict.  Standard merge algorithms cannot automatically determine the correct way to merge these conflicting changes. In these cases, developers must manually intervene in order to correctly resolve the conflicting code and complete the merge. 

% (3) some history
Over the past decade, several approaches have been proposed to improve the detection and automatic resolution of merge conflicts~\cite{mens2002state,apel2010semistructured,lessenich2017renaming,sousa2018verified,cavalcanti2017evaluating,zhu2018conflict,kasi2013cassandra,brun2011proactive}. Some approaches use the abstract syntax trees (ASTs) or other representations of the source code to improve conflict resolution~\cite{westfechtel1991structure,apel2010semistructured, tavares2019semistructured}; others use a data-driven approach which uses deep learning to predict the correct merge~\cite{Dinella2021}. Researchers have also developed tools to help developers visualize and navigate the merge conflict resolution process~\cite{shen2019intellimerge,semanticmerge,beyondcompare}, and identified key needs of the developer community for effective tool support~\cite{nelson2019life}. The sheer body of research dedicated to this problem represents a significant amount of time and effort. Despite these advancements, none of these approaches have been widely adopted into practice, and the git textual-based detection algorithm remains one of the most commonly used merging approaches~\cite{nelson2019life}.  

\input{example_fig}

%(4) Key modeling contribution
In an effort to address this, we introduce \thistool{}: a neural program merge framework based on token-level three-way differencing and a multi-input variant of the bidirectional transformer encoder (BERT) model~\cite{bert}. We formulate the task of generating a merge conflict resolution sequence as a classification task over a set of primitive merge patterns extracted from real-world merge commit data. \thistool{} encodes all inputs that a standard \texttt{diff3} algorithm takes (two two-way diffs of input programs) as well as the edit sequence information, then aggregates them for learning.
%\alexey{Note: LaTex formatting issues. Is it meant to be in the introduction?}
%put the example fig here so it appears on the same page as the motivating example text.
% (5) about empirical investigation
We train and then evaluate \thistool{} on 220,000 and 54,000 (respectively) real world historical merge conflicts and their associated manual resolutions from 100,000 GitHub repositories in JavaScript, TypeScript, Java and C\#, and find that it performs quite well, with precision and accuracy always over 60\% (over 70\% if the top three suggestions are considered).  
Further, we compare \thistool{} to existing state of the art structured and semi-structured merge approaches (which are necessarily language-specific) and show that \thistool{} is able to provide resolution suggestions for more merge conflicts and the suggestions are correct (i.e., match the historical user manual resolution) more often.

To better evaluate the resolutions generated by \thistool{} from users' perspective in practice, we also conduct a user study with 25 developers from large OSS projects. We ask participants to evaluate if \thistool{} resolution suggestions are acceptable on a set of 122 of their {\it own} real-world conflicts. Results show that \thistool{} merge resolutions would be accepted in practice despite not always being syntactically identical to the historical user resolutions, and we identify potential ways to improve \thistool{} and the merge conflict oracles used to evaluate neural program merge approaches. 


% (6) paper contribution summary
We make the following contributions in this paper:
\begin{enumerate}
    \item We introduce \thistool{}, a novel transformer-based program merge framework that leverages token-level three-way differencing and formulates the task of generating the resolution sequence as a classification task.
    \item We evaluate \thistool{} against structured and semi-structured program merge tools like \jsfstmerge{} and \jdime{}, as well as neural program merge models~\cite{Dinella2021}. We demonstrate that \thistool{} outperforms the state-of-the-art, achieving 2--3$\times$ higher accuracy on merge resolution.% (see sections \ref{sec:baselines} and \ref{sec:eval}).
    \item We present an empirical evaluation of the perceptions of \thistool{} resolutions with 25 developers from large OSS projects, contributing the first user study in which developers use and evaluate an automatic merge conflict resolution tool on their own real-world conflicts.
\end{enumerate}

We make available an online data package~\citep{ICSE22Replication} containing the test dataset of conflicts and user resolutions, as well as, the questions and responses gathered from our user study.  We also provide an online Appendix with supplementary details and figures~\cite{FSE22Appendix} (also uploaded with this submission).

