
\begin{tikzpicture}[auto,>=latex', scale = 1.01, transform shape]
\centering
\scriptsize
\node[draw, rectangle,align=center, minimum height = 0.75cm, minimum width= 0.75 cm,rounded corners=.2cm](PUF){$P_X$};
\node[right of =PUF,node distance = 1cm](X){$X^n$};

\node[draw, right of=X,rectangle,align=center, node distance =2.25cm, minimum height = 0.75cm, minimum width= 1.8 cm, text width = 1.0cm,rounded corners=.2cm] (PYX) {$P_{Y|X}$};

\node[right of =PYX,node distance = 3cm](Y){};

\node[above of =Y,node distance = 1cm](Y2){$Y^n$};


\node[draw, above of=X,rectangle,align=center, node distance =2.5cm, minimum height = 0.9cm, minimum width= 1.4 cm, text width = 1.4cm] (VQ) {Polar Decoder $\mathcal{C}_1$};

\node[above of =VQ,node distance = 1cm](U){$U^n$};

\node[draw, above of=U,rectangle,align=center, node distance =1cm, minimum height = 0.9cm, minimum width= 1.4 cm, text width = 1.4cm] (SExt) {Helper Data and Key Extraction};

\node[above of =SExt,node distance = 1.25cm](S){$S$};

\node[right of =SExt,node distance = 2.5cm](W){$W$};

\node[draw, above of=Y,rectangle,align=center,node distance =2.5cm, minimum height = 0.9cm, minimum width= 1.4 cm, text width = 1.4cm] (Dec) {Polar Decoder $\mathcal{C}$};

\node[above of =Dec,node distance = 1cm](Uh){$\hat{U}^n$};

\node[draw, above of=Uh,rectangle,align=center, node distance =1cm, minimum height = 0.9cm, minimum width= 1.4 cm, text width = 1.4cm] (RExt) {Key Extraction};

\node[above of =RExt,node distance = 1.25cm](Sh){$\hat{S}$};

\node[left of =VQ,node distance = 1.36cm](V){$V$};
\node[left of =Dec,node distance = 1.65cm](VW){$W$};
\node[right of =Dec,node distance = 1.65cm](WV){$V$};

\node[draw, right of=VQ,rectangle,align=center, node distance =2.25cm, minimum height = 1cm, minimum width= 1.4 cm, text width = 1.4cm,dashed] (Enc) {Polar Transform};

\node[draw, above of=PYX,rectangle,align=center, node distance =1cm, minimum height = 0.75cm, minimum width= 1.8 cm, text width = 1.7cm,rounded corners=.2cm,dashed] (PXq) {BSC$(q*p_A)$};

\draw[decoration={markings,mark=at position 1 with {\arrow[scale=1.4]{latex}}},
postaction={decorate}, thick, shorten >=1.4pt] (PUF) -- (X); 
\draw[decoration={markings,mark=at position 1 with {\arrow[scale=1.4]{latex}}},
postaction={decorate}, thick, shorten >=1.4pt] (X) -- (PYX); 
\draw[decoration={markings,mark=at position 1 with {\arrow[scale=1.4]{latex}}},
postaction={decorate}, thick, shorten >=1.4pt] (PYX) -| (Y2);
\draw[decoration={markings,mark=at position 1 with {\arrow[scale=1.4]{latex}}},
postaction={decorate}, thick, shorten >=1.4pt] (X) -- (VQ);
\draw[decoration={markings,mark=at position 1 with {\arrow[scale=1.4]{latex}}},
postaction={decorate}, thick, shorten >=1.4pt] (VQ) -- (U);
\draw[decoration={markings,mark=at position 1 with {\arrow[scale=1.4]{latex}}},
postaction={decorate}, thick, shorten >=1.4pt] (U) -- (SExt);
\draw[decoration={markings,mark=at position 1 with {\arrow[scale=1.4]{latex}}},
postaction={decorate}, thick, shorten >=1.4pt] (SExt) -- (S);
\draw[decoration={markings,mark=at position 1 with {\arrow[scale=1.4]{latex}}},
postaction={decorate}, thick, shorten >=1.4pt] (SExt) -- (W);

\draw[decoration={markings,mark=at position 1 with {\arrow[scale=1.4]{latex}}},
postaction={decorate}, thick, shorten >=1.4pt] (Y2) -- (Dec);
\draw[decoration={markings,mark=at position 1 with {\arrow[scale=1.4]{latex}}},
postaction={decorate}, thick, shorten >=1.4pt] (Dec) -- (Uh);
\draw[decoration={markings,mark=at position 1 with {\arrow[scale=1.4]{latex}}},
postaction={decorate}, thick, shorten >=1.4pt] (Uh) -- (RExt);
\draw[decoration={markings,mark=at position 1 with {\arrow[scale=1.4]{latex}}},
postaction={decorate}, thick, shorten >=1.4pt] (RExt) -- (Sh);

\draw[decoration={markings,mark=at position 1 with {\arrow[scale=1.4]{latex}}},
postaction={decorate}, thick, shorten >=1.4pt] (V) -- (VQ);
\draw[decoration={markings,mark=at position 1 with {\arrow[scale=1.4]{latex}}},
postaction={decorate}, thick, shorten >=1.4pt] (VW) -- (Dec);
\draw[decoration={markings,mark=at position 1 with {\arrow[scale=1.4]{latex}}},
postaction={decorate}, thick, shorten >=1.4pt] (WV) -- (Dec);
\draw[decoration={markings,mark=at position 1 with {\arrow[scale=1.4]{latex}}},
postaction={decorate}, thick, shorten >=1.4pt] (W) -| (VW.north);

\draw[decoration={markings,mark=at position 1 with {\arrow[scale=1.4]{latex}}},
postaction={decorate}, thick, shorten >=1.4pt,dashed] (U) -| (Enc);

\draw[decoration={markings,mark=at position 1 with {\arrow[scale=1.4]{latex}}},
postaction={decorate}, thick, shorten >=1.4pt,dashed] (Enc) -- (PXq) node[midway] {$X_q^n$};
\draw[decoration={markings,mark=at position 1 with {\arrow[scale=1.4]{latex}}},
postaction={decorate}, thick, shorten >=1.4pt,dashed] (PXq) -- (Y2);

\node (redrect1) [thick,rectangle, draw, fit=(Dec)(RExt),inner sep=5pt,color=black,solid,rounded corners=.2cm] {};
\node (redrect2) [thick,rectangle, draw, fit=(VQ)(SExt),inner sep=5pt,color=black,solid,rounded corners=.2cm] {};
\small
\node[below of =X,node distance = 0.75cm](Enr){Enrollment};
\node[below of =Y,node distance = 0.75cm](Rec){Reconstruction};

\end{tikzpicture}
