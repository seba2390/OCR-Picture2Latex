\subsection{Phase 2: Satisfying the Agents}\label{additive:allocation}
\subsubsection{An Overview on the State of the Algorithm}
Before going through the second phase, we present an overview of the current state of the agents and items. In Figure \ref{fig:overview}, for every agent $\agent_i \in \cone \cup \ctwo \cup \satagents$, $\firstset_i$ is shown by a gray rectangle and for every agent $\agent_i \in \satagents$, $\secondset_i$  is shown by a hatched rectangle. 

Currently, we know that every agent in $\satagents$ belongs to $\satagents_1^r$ or $\satagents_2^r$. These agents are satisfied in the refinement phases of $\cone$ and $\ctwo$. The rest of the agents will be satisfied in the second phase. For brevity, for $i \leq 2$ we use $\satagents_i^s$ to refer to the agents in $\satagents_i$ that are satisfied in the second phase. More formally, $$\mbox{ for }i=1,2 \qquad \satagents_i^s = \satagents_i \setminus \satagents_i^r .$$

Since we didn't refine Cluster $\cthree$, all the agents in the Cluster $\cthree$ are satisfied in the second phase. As mentioned in the previous section, the item allocation to the semi-satisfied agents in $\cthree$ is temporary; That is, we may alter such allocations later. Therefore, in Figure \ref{fig:overview} we illustrate such allocations by dashed lines. 

 

In this section, we denote the set of free items (the items corresponding to the vertices in $\itemsv''\setminus \itemsv''_{1/2}$ at the end of the first phase) by $\fitems$. By Observations \ref{fsmallc1}, \ref{fsmallc2} and Corollary \ref{small_c3}, we know that the items in $\fitems$ have the following properties:
\begin{enumerate}
\item For every agent $\agent_i$ in $\cone$, $\valu_i(\{\ite_j\}) < \epsilon_i$ holds for all $\ite_j \in \fitems$ (Observation \ref{fsmallc1}).
\item For every agent $\agent_i$ in $\ctwo$, $\valu_i(\{\ite_j\}) < \epsilon_i$ holds for all $\ite_j \in \fitems$ (Observation \ref{fsmallc2}).
\item For every agent $\agent_i$ in $\cthree$, there is at most one item $\ite_j \in \fitems$, such that $\valu_i(\{\ite_j\}) \geq 1/4$ (Corollary \ref{small_c3}).
\end{enumerate}


\input{figs/table0.tex}
In summary, items of $\fitems$ are small enough, therefore we can run a process similar to the $\bagfilling$ algorithm described earlier to allocate them to the agents. Recall that our clustering and refinement methods preserve the conditions stated in Lemmas \ref{forc2c3}, \ref{gsmallc1r}, \ref{forc3}, \ref{cr2smallc1} and \ref{cr2smallc3}. In addition to this, we state Lemma \ref{general} as follows.

\begin{lemma}[value-lemma]
\label{general}
For every agent $\agent_i \in \cone \cup \ctwo \cup \cthree^s$, we have
$$\forall \agent_j \in \cone \cup \ctwo \cup \cthree \qquad \valu_j(\firstset_i)<3/4.$$
\end{lemma}  
A brief summary of Lemmas \ref{forc2c3}, \ref{gsmallc1r}, \ref{forc3}, \ref{cr2smallc1}, \ref{cr2smallc3} and \ref{general} is illustrated in Tables \ref{table0} and \ref{table4}. Moreover, since sets $\cone,\ctwo$ and $\cthree^s$ are cycle-envy-free, Observation \ref{epsofcluster} holds for these sets. 



\subsubsection{Second Phase: $\bagfilling$}
We begin this section with some definitions. In the following, we define the notion of feasible subsets and, based on that, we define $\phi(S)$ for a feasible subset $S$ of items.
\begin{definition}
A subset $S$ of items in $\fitems$ is feasible, if at least one of the following conditions are met:
\begin{minipage}[t]{\linegoal}
\begin{enumerate}[leftmargin=30pt]
    \item There exists an agent $\agent_i \in \cthree^f $ such that  $\valu_i(\{S\}) \geq {1/2}$. 
    \item There exists an agent $\agent_i \in \cone \cup \ctwo \cup \cthree^s \cup \cthree^b$ such that  $\valu_i(\{S\}) \geq \epsilon_i$.
\end{enumerate}
\end{minipage}
\end{definition}

\begin{definition}
For a feasible set $S$, we define $\Phi(S)$ as the set of agents, that set $S$ is feasible for them. 
\end{definition}

Recall the notion of cycle-envy-freeness and the topological ordering of the agents in a cycle-envy-free set of semi-satisfied agents. Based on this, we define a total order $\prec_{pr}$ to prioritize the agents in the $\bagfilling$ algorithm. 

\begin{definition}
\label{priority}
Define a total order $\prec_{pr}$ on the agents of $\cone \cup \ctwo \cup \cthree$ with the following rules: 
\begin{minipage}[t]{\linegoal}
	
\begin{enumerate}[leftmargin=50pt]
    \item $\agent_{i_5} \prec_{pr} \agent_{i_1} \prec_{pr} \agent_{i_2} \prec_{pr} \agent_{i_3}  \prec_{pr} \agent_{i_4} \qquad$  $\forall \agent_{i_1} \in \cone, \agent_{i_2} \in \ctwo, \agent_{i_3} \in \cthree^s, \agent_{i_4} \in \cthree^b, \agent_{i_5} \in \cthree^f$
    \item $\agent_i \prec_{pr} \agent_j \Leftrightarrow \agent_i \prec_o \agent_j \hspace{85pt}$ $\forall \agent_i, \agent_j \in \cone \cup \ctwo \cup \cthree^s,  \agent_i ,\agent_j \mbox{ in the same cluster }$
	\item $\agent_i \prec_{pr} \agent_j \Leftrightarrow i < j \hspace{100pt}$ $\forall \agent_i,\agent_j \in \cthree^b \vee \agent_i,\agent_j \in \cthree^f$
\end{enumerate}
\end{minipage}
\end{definition}    

\begin{comment}
\begin{array}{cll}
(I)&\agent_{i_5} \prec_{pr} \agent_{i_1} \prec_{pr} \agent_{i_2} \prec_{pr} \agent_{i_3}  \prec_{pr} \agent_{i_4}& \forall \agent_{i_1} \in \cone, \agent_{i_2} \in \ctwo, \agent_{i_3} \in \cthree^s, \agent_{i_4} \in \cthree^b, \agent_{i_5} \in \cthree^f\\[6pt]
(II)&\agent_i \prec_{pr} \agent_j \Leftrightarrow \agent_i \prec_o \agent_j  & \forall \agent_i, \agent_j \in \cone \cup \ctwo \cup \cthree^s, \qquad \agent_i ,\agent_j \mbox{ in the same cluster }\\[6pt]

(III)&\agent_i \prec_{pr} \agent_j \Leftrightarrow i < j & \agent_i,\agent_j \in \cthree^b \vee \agent_i,\agent_j \in \cthree^f\\[6pt]
\end{array}.

\end{comment}


Recall that $\prec_o$ refers to the topological ordering of a semi-satisfied set of agents. Roughly speaking, for the semi-satisfied agents in the same cluster, $\prec_{pr}$ behaves in the same way as $\prec_{o}$. Furthermore, for the agents in different clusters, agents in $\cthree^f , \cone , \ctwo, \cthree^s , \cthree^b$ have a lower priority, respectively. Finally, the order of the agents in $\cthree^b$ and $\cthree^f$ is determined by their index, i.e., the agent with a lower index has a lower priority.


The second phase consists of several rounds and every round has two steps. Each of these two steps is described below. We continue running this algorithm until $\fitems$ is no longer feasible for any agent.
\begin{itemize}
\item \textbf{Step1}: In the first step, we run a process very similar to the $\bagfilling$ algorithm described in Section \ref{introduction}. That is, we find a feasible subset $S \subseteq \fitems$, such that $|S|$ is minimal. Such a subset can easily be found, using a slight modification of the $\bagfilling$ process (see Section \ref{sphase}).  

\item \textbf{Step2}: In the second step, we choose an agent to allocate set $S$ to him. In contrast to the $\bagfilling$ algorithm, we do not select an arbitrary agent. Instead, we select the agent in $\Phi(S)$ with the lowest priority regarding $\prec_{pr}$, i.e., smallest element in $\Phi(S)$ regarding $\prec_{pr}$. Let $\agent_i$ be the selected agent. We consider three cases separately:

\begin{minipage}[t]{\linegoal}
\begin{enumerate}[leftmargin=50pt]
    \item $\agent_i \in \cthree^f$: temporarily allocate $S$ to $\agent_i$, i.e., set $\firstset_i = S$. 
    \item $\agent_i \in \cthree^b$: let $\agent_j$ be the agent that $\valu_i(\firstset_j) = {3/4} - \epsilon_j$. 
Take back $\firstset_j$ from $\agent_j$ and allocate $\firstset_j \cup S$ to $\agent_i$ i.e. set $\firstset_i = \firstset_j$, $\firstset_j=\emptyset$ and $\secondset_i = S$. Remove $\agent_i$ from $\cthree$ and add it to $\satagents$.
    \item $\agent_i \in \cone \cup \ctwo \cup \cthree^s$: satisfy agent $\agent_i$ by $S$, i.e., set $\secondset_i = S$ and remove $\agent_i$ from its corresponding cluster and add it to $\satagents$. 
\end{enumerate}
\end{minipage}

By the construction of $\cthree^s,\cthree^b$, and $\cthree^f$, the above process may cause agents in $\cthree$ to move in between $\cthree^s,\cthree^b$ and $\cthree^f$. For example, if the first case happens, then $\agent_i$ is moved from $\cthree^f$ to $\cthree^s$. In addition, all other agents in $\cthree^f$ for which $S$ is feasible are moved to $\cthree^b$. For the second case, $\agent_j$ is moved to one of $\cthree^f$ or $\cthree^b$, based on $\valu_j(\firstset_k)$ for every $\agent_k \in \cthree^s$; that is, if there exists an agent $\agent_k \in \cthree^s$ such that $\valu_j(\firstset_k) \geq 1/2$, $\agent_j$ is moved to $\cthree^b$. Otherwise, $\agent_j$ is moved to $\cthree^f$. For both the second and the third cases, some of the agents in $\cthree^b$ may move to $\cthree^f$. 
\end{itemize}
The second phase terminates, when $\fitems$ is no longer feasible for any agent. More details about the second phase can be found in Algorithm \ref{second-phase}.  In Algorithm \ref{second-phase}, we use $Update(\cthree)$ to refer the process of moving agents among $\cthree^s, \cthree^b$ and $\cthree^f$.
 

\begin{algorithm}[t!]
 \KwData{$\fitems, \cone,\ctwo,\cthree$}
  \While{$\fitems$ is feasible}{
	$S$ = a minimal feasible subset of $\fitems$ \;
	$\agent_i = $ agent in $\Phi(S)$ with lowest order regarding  $\prec_{pr}$\;
	\If{$\agent_i \in C_3^f$}
	{
		$\firstset_i = S$ \;
		$Update(\cthree)$ \;
	}
	\If{$\agent_i \in \cthree^b$}
	{
		Let $\agent_j$ be the agent that $\valu_i(\firstset_j) = 3/4 - \epsilon_i$ \;
		$\firstset_i = \firstset_j$ \;
		$\secondset_i = S$ \;
		$\satagents = \satagents \cup \agent_i$ \;
		$\firstset_j = \emptyset$\;
		$\cthree = \cthree \setminus \agent_i$ \;
		$Update(\cthree)$ \;
	}
	\If {$\agent_i \in \cthree^s$}
	{
		$\secondset_i = S$\;
		$\satagents = \satagents \cup \agent_i$\;
		$\cthree = \cthree \setminus \agent_i$ \;
		$Update(\cthree)$ \;
	}
	\If {$\agent_i \in \cone \cup \ctwo$}
	{
		$\secondset_i = S$\;
		remove $\agent_i$ from its corresponding cluster \;
		$\satagents = \satagents \cup \agent_i$\;

	}
}
 \caption{The Second Phase}
 \label{second-phase}
\end{algorithm}

In each round of the second phase, either an agent is satisfied or an agent in $\cthree^f$ becomes semi-satisfied. In Lemma \ref{c3fsmall}, we show that if an agent $\agent_i \in \cthree^f$ is selected in some round of the second phase, then $\valu_j(\firstset_i)$ is upper bounded by $2\epsilon_j$ for every agent $\agent_j \in \cthree \cup \ctwo \cup \cone^s \cup \cone^b$. As a consequence of Lemma \ref{c3fsmall}, in Lemma \ref{cef} we show that sets $\cone,\ctwo$ and $\cthree$ remain cycle-envy-free during the second phase. For convenience, we use $\mathbb{R}_z$ to refer to the $z$'th round of the second phase. 

\begin{lemma}
\label{c3fsmall}
Let $\mathbb{R}_z$ be a round of the second phase that an agent $\agent_i \in \cthree^f$ is selected. Then, for every agent $\agent_j \in \cthree \cup \ctwo \cup \cone^s \cup \cone^b$, we have $\valu_j(\firstset_i)<2\epsilon_j<3/4$.
\end{lemma}



\begin{lemma}
\label{cef}
During the second phase, the $\cone,\ctwo$ and $\cthree^s$ maintain the property of cycle-envy-freeness. 
\end{lemma}

Finally, for the rounds that an agents $\agent_i$ is satisfied, Lemmas \ref{prvalue} and \ref{m_1} give upper bounds on the value of $\secondset_i$ for remaining agents in different clusters. 

\begin{lemma}[value-lemma]
\label{prvalue}
Let $\agent_i \in \satagents$ be an agent that is satisfied in the second phase. Then, for every other agent $\agent_j \in \cone \cup \ctwo$ we have:

\begin{minipage}[t]{\linegoal}
\begin{enumerate}[leftmargin=30pt]
\item If $\agent_j \prec_{pr} \agent_i$, then $\valu_j(\secondset_i) < \epsilon_j$.
\item If $\agent_i \prec_{pr} \agent_j$, then $\valu_j(\secondset_i) < 2\epsilon_j$.
\end{enumerate}
\end{minipage}
\end{lemma}

\begin{lemma}[value-lemma]
\label{m_1}
Let $\agent_i$ be an agent in $\satagents_1^s \cup \satagents_2^s$. Then, for every agent $\agent_j \in \cthree$, we have $\valu_j(\secondset_i) < {1/2}$.
\end{lemma}

The results of Lemmas \ref{prvalue} and \ref{m_1} are summarized in Table \ref{table1}.





\input{figs/table1.tex}

\input{additiveproofs.tex}