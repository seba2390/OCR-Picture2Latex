\pgfdeclarelayer{foreground}
\pgfsetlayers{background,main,foreground}

\tikzset{radiation/.style={{decorate,decoration={expanding waves,angle=90,segment length=4pt}}}}

\begin{tikzpicture}[->,>=stealth', node distance=2 cm,scale=0.8, every node/.style={scale=0.8}]

  %%{ nodes
  

  \node[state_gray,shift = {(0, 0)}] (solver) {
      \begin{tabular}{c}
        MPC Solver 
      \end{tabular}
    };

  
 \node[state_org, above of = solver, shift = {(-2, 0)}] (fft) {
      \begin{tabular}{c}
        \footnotesize Fast Fourrier \\
        \footnotesize Transform
      \end{tabular}
    };

  \node[state_org,  right of = fft, shift = {(1, 0)}] (kfwave) {
      \begin{tabular}{c}
        KF wave\\
        Prediction 
        
      \end{tabular}
    };
    
  \node[state_green, below of = solver, shift = {(-2, 0)}] (setpoint) {
      \begin{tabular}{c}
        \footnotesize Setpoint \\
        \footnotesize Generator
      \end{tabular}
    };
    
  \node[state_green, right of = setpoint, shift = {(1, 0)}] (uav) {
      \begin{tabular}{c}
        \footnotesize UAV Model
      \end{tabular}
    };


  
  %%}

  %%{ paths

  \path[->] ($(uav.north) + (0.0, 0)$) edge [] node[above, midway, shift = {(0.3, -0.6)}] {
      \begin{tabular}{c}
        \footnotesize $\mathbf{\hat{x}}$ 
    \end{tabular}} ($(solver.south) + (1.0, 0.0)$);
 
    \draw[-] ($(setpoint.north) + (0.3, 0)$) edge [] node[above, midway, shift = {(0.6, 0.5)}] {
      \begin{tabular}{c}
      \footnotesize $\mathbf{r}_d, \eta_d$
    \end{tabular}} ($(setpoint.north) + (0, 0)$) -- ($(setpoint.north |- solver.east)+(0.3, 0)$) edge [->]
    ($(solver.west)+(0, 0)$);
  
  \path[->] ($(fft.south) + (0, 0)$) edge [] node[above, midway, shift = {(-0.55, -0.5)}] {
      \begin{tabular}{c}
        \footnotesize FFT \\
        \footnotesize accuracy
    \end{tabular}} ($(setpoint.north) + (0, 0.0)$);

  \path[->] ($(fft.east) + (0, 0.2)$) edge [] node[below, midway, shift = {(0, 0)}] {
      \begin{tabular}{c}
        \footnotesize $\freqji$,\\
        \footnotesize $\ampji$,\\
        \footnotesize $\phaseji$
    \end{tabular}} ($(kfwave.west) + (0, 0.2)$);
    
  \path[->] ($(kfwave.south) + (-0.0, 0)$) edge [] node[above, midway, shift = {(0.75, -0.4)}] {
      \begin{tabular}{c}
        \footnotesize $[b_{4,n}, b_{5,n}] $ \\
        \footnotesize $n = 1..M_p$
    \end{tabular}} ($(solver.north) + (1, 0.0)$);
    
   \path[->] ($(solver.east)+(0, 0)$) edge [] node[above, near start, shift = {(0.5, -0.1)}] {
      \begin{tabular}{c}
        \footnotesize $\mathbf{\dot{r}}_d, \dot{\eta}_d$
       \end{tabular}} ($(kfwave.south |- solver.east)+(2.5, 0)$) -- ($(kfwave.south |- solver.east)+(2.5, 0)$);
    
   \draw[-] ($(solver.south) + (-0.3, 0)$) edge [] node[above, midway, shift = {(0.3, -1.4)}] {
      \begin{tabular}{c}
      \footnotesize $\mathbf{\hat{\dot{\ddot{r}}}}_d,\mathbf{\hat{\dot{\ddot{\eta}}}}_d$%
    \end{tabular}} ($(solver.south) + (0, 0)$) -- ($(solver.south |- uav.west)+(-0.3, 0)$) edge [->]
    ($(uav.west)+(0, 0)$);
    
    \draw (-2,3.7) -- ($(fft.north)$);
    \draw (1,2.85) -- ($(kfwave.north)$);
    \draw[-] ($(fft.north)+(-1.6, 0.39)$) -- ($(kfwave.north)+(0, 0.39)$);
    \draw[-] ($(fft.north)+(-1.6, 0.4)$) edge [] node[above, near start, shift = {(1.6, 1.9)}] {
      \begin{tabular}{c}
        $\mathbf{b}$ 
       \end{tabular}} ($(fft.north |- setpoint.west)+(-1.6, 0)$) -- ($(fft.north |- setpoint.west)+(-1.6, 0)$)edge [->] ($(setpoint.west)+(0, 0)$);
    
    \draw (1,-3.9) -- ($(uav.south)$);
    \draw[-] ($(uav.south)+(0, -0.47)$) edge [] node[above, near start, shift = {(0, -1.8)}] {
      \begin{tabular}{c}
        $\mathbf{x}$
       \end{tabular}} ($(uav.south) + (0, 0)$) -- ($(uav.south |- setpoint)+(-3.0, -0.7)$) edge [->] ($(setpoint.south)+(0, 0)$);

%%%%
  \begin{pgfonlayer}{background}
    \path (kfwave.west |- kfwave.north)+(3.0,1.1) node (a) {};
    \path (setpoint.south -| setpoint.east)+(-3.0,-1.2) node (b) {};
    \path[fill=red!10,rounded corners, draw=black!70, densely dotted]
      (a) rectangle (b);
  \end{pgfonlayer}
  \node [rectangle, above of=kfwave, shift={(-3.9,-6.1)}, node distance=1.7em] (autopilot) {
  \footnotesize MPC Architecture
  };

  \begin{pgfonlayer}{background}
    \path (kfwave.east |- kfwave.north)+(0.5,0.75) node (a) {};
    \path (fft.south -| fft.west)+(-0.5,-0.75) node (b) {};
    \path[fill=yellow!20,rounded corners, draw=black!70, densely dotted]
      (a) rectangle (b);
  \end{pgfonlayer}
  \node [rectangle, above of=fft, shift={(3,0.45)}, node distance=1.7em] (autopilot) {
  \footnotesize USV Prediction Model
  };

  \begin{pgfonlayer}{background}
    \path (uav.west |- uav.north)+(2.2,0.75) node (a) {};
    \path (setpoint.south -| setpoint.east)+(-2.2,-0.75) node (b) {};
    \path[fill=green!10,rounded corners, draw=black!70, densely dotted]
      (a) rectangle (b);
  \end{pgfonlayer}
  \node [rectangle, above of=kfwave, shift={(-3.0,-5.65)}, node distance=1.7em] (autopilot) {
  \footnotesize UAV Prediction Model
  };
  
  

  %%}

\end{tikzpicture}
