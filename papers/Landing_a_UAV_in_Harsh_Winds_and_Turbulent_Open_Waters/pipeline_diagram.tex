\pgfdeclarelayer{foreground}
\pgfsetlayers{background,main,foreground}

\tikzset{radiation/.style={{decorate,decoration={expanding waves,angle=90,segment length=4pt}}}}
\scalebox{0.85}{%
\begin{tikzpicture}[->,>=stealth', node distance=3.0cm,scale=1.0, every node/.style={scale=1.0}]

  %%{ nodes
  

  \node[color_state, shift = {(0.0, 0.0)}] (navigation) {
      \begin{tabular}{c}
        \footnotesize Prediction\\
        \footnotesize Models\\
        \footnotesize and MPC
      \end{tabular}
    };

\node[state_gray, right of = navigation, shift = {(0.0, 0)}] (tracker) {
      \begin{tabular}{c}
        \footnotesize Reference \\
        \footnotesize Tracker
      \end{tabular}
    };

  \node[state_gray, right of = tracker, shift = {(0.5, 0)}] (controller) {
      \begin{tabular}{c}
        \footnotesize Position/Attitude \\
        \footnotesize Controller
      \end{tabular}
    };
    
  \node [state, above of = controller, shift = {(4.0, -0.8)}] (extractor) {
    \begin{tabular}{c}
      \small Vision-based \\
      \small Detector
    \end{tabular}
  };

  \node[state, right of = controller, shift = {(0.8, -0)}] (attitude) {
      \begin{tabular}{c}
        \footnotesize Attitude rate\\
        \footnotesize Controller
      \end{tabular}
    };
    
  \node[smallstate, below of = attitude, shift = {(-0.6, 2.1)}] (imu) {
      \footnotesize IMU
    };

  \node[state, right of = attitude, shift = {(0.7, -0)}] (actuators) {
      \begin{tabular}{c}
        \footnotesize UAV \\
        \footnotesize Actuators
      \end{tabular}
    };
    
  \node[state, right of = actuators, shift = {(-1.2, -0)}] (sensors) {
      \begin{tabular}{c}
        \footnotesize Onboard \\
        \footnotesize Sensors
      \end{tabular}
    };

  \node[state_gray, below of = attitude, shift = {(0, 0.9)}] (estimator) {
      \begin{tabular}{c}
        \footnotesize State \\
        \footnotesize Estimator
      \end{tabular}
    };

  \node[state_gray, right of = estimator, shift = {(0.8, 0.0)}] (localization) {
      \begin{tabular}{c}
        \footnotesize Odometry \& \\
        \footnotesize Localisation
      \end{tabular}
    };


  %%}

  %%{ paths

 \path[->] ($(navigation.east) + (0.0, 0)$) edge [] node[above, midway, shift = {(0.0, 0.05)}] {
      \begin{tabular}{c}
        %\footnotesize desired reference\\
        \footnotesize $\mathbf{\dot{r}}_d, \dot{\eta}_d$\\
        \footnotesize \SI{100}{\hertz}
    \end{tabular}} ($(tracker.west) + (0.0, 0.00)$);

  \path[->] ($(tracker.east) + (0.0, 0)$) edge [] node[above, midway, shift = {(0.0, 0.05)}] {
      \begin{tabular}{c}
        %\footnotesize full-state reference\\
        \footnotesize $\bm{\chi}_d$\\
        \footnotesize \SI{100}{\hertz}
    \end{tabular}} ($(controller.west) + (0.0, 0.00)$);

  \path[->] ($(controller.east) + (0.0, 0)$) edge [] node[above, midway, shift = {(-0.2, 0.05)}] {
      \begin{tabular}{c}
        \footnotesize $\bm{\omega}_d$\\
        \footnotesize $T_d$ \\
        \footnotesize \SI{100}{\hertz}
    \end{tabular}} ($(attitude.west) + (0.0, 0.00)$);

  \draw[-] ($(controller.south)+(0.25,0)$) -- ($(controller.south |- estimator.west) + (0.25, 0.25)$) edge [->] node[above, near start, shift = {(-0.2, 0.05)}] {
      \begin{tabular}{c}
        \footnotesize $\mathbf{a}_d$
    \end{tabular}} ($(estimator.west) + (0, 0.25)$);

  \path[->] ($(attitude.east) + (0.0, 0)$) edge [] node[above, midway, shift = {(0.1, 0.05)}] {
      \begin{tabular}{c}
        \footnotesize $\bm{\tau}_d$ \\
        \footnotesize $\approx$\SI{1}{\kilo\hertz}
    \end{tabular}} ($(actuators.west) + (0.0, 0.00)$);





  \path[-] ($(estimator.west)+(0, -0.2)$) edge [] node[above, near start, shift = {(-7.6, 0.5)}] {
      \begin{tabular}{c}
        \footnotesize $\mathbf{x}$\\
        \footnotesize \SI{100}{\hertz}
       \end{tabular}} ($(navigation.south |- estimator.west)+(0, -0.2)$) -- ($(navigation.south |- estimator.west)+(0, -0.2)$) edge [->,] ($(navigation.south)+(0, 0)$);

    \path[-] ($(estimator.west)+(0.0,0.0)$) edge [dotted] node[left, midway, shift = {(-3.0, 0.8)}] {
      \begin{tabular}{c}
        \scriptsize initialisation\\[-0.5em]
        \scriptsize only
       \end{tabular}} ($(tracker.south |- estimator.west)$) -- ($(tracker.south |- estimator.west)$) edge [->,dotted] ($(tracker.south)+(0, 0)$);

  \path[-] ($(estimator.west)+(0.0,0.0)$) edge [] node[left, midway, shift = {(-1.3, 0.8)}] {
      \begin{tabular}{c}
        \footnotesize $\mathbf{x}$, $\mathbf{R}$, $\bm{\omega}$\\
        \footnotesize \SI{100}{\hertz}
       \end{tabular}} ($(controller.south |- estimator.west)$) -- ($(controller.south |- estimator.west)$) edge [->,] ($(controller.south)+(0, 0)$);




  \draw[-] ($(imu.east) + (0.0, 0.0)$) -- ($(estimator.north |- imu.east) + (0.3, 0)$) edge [->] node[right, midway, shift = {(-0.2, 0.3)}] {
      \begin{tabular}{c}
        \footnotesize $\mathbf{R}$, $\bm{\omega}$
    \end{tabular}} ($(estimator.north) + (0.3, 0.0)$);

  \draw[-] ($(sensors.south)+(0, 0)$) -- ($(sensors.south |- localization.east)$) edge [->] ($(localization.east)$);
  \draw[-] ($(sensors.south)+(0.1, 0)$) -- ($(sensors.south |- localization.east) + (0.1, -0.1)$) edge [->] ($(localization.east) + (0.0, -0.1)$);
  \draw[-] ($(sensors.south)+(-0.1, 0)$) -- ($(sensors.south |- localization.east) + (-0.1, 0.1)$) edge [->]  ($(localization.east) + (0.0, 0.1)$);

  \draw[->] ($(localization.west)+(0, 0)$) -- ($(estimator.east)$);
  \draw[->] ($(localization.west)+(0, 0.1)$) -- ($(estimator.east) + (0, 0.1)$);
  \draw[->] ($(localization.west)+(0, -0.1)$) -- ($(estimator.east) + (0, -0.1)$);
  
  
  \draw[-] ($(sensors.north) + (0, 0)$) -- ($(sensors.north |- extractor.east)$) edge [->]
  ($(extractor.east)+(0, 0)$);


  %
  \draw[-] ($(extractor.west) + (0, 0)$) -- ($(extractor.west -| navigation.north)$) edge [->] 
  node[above, midway, shift = {(-0.3, -0.3)}] {
      \begin{tabular}{c}
        \footnotesize $\mathbf{b}$
    \end{tabular}} ($(navigation.north)+(0, 0)$);
  

  \begin{pgfonlayer}{background}
    \path (attitude.west |- attitude.north)+(-0.45,0.8) node (a) {};
    \path (imu.south -| sensors.east)+(+0.25,-0.20) node (b) {};
    \path[fill=gray!3,rounded corners, draw=black!70, densely dotted]
      (a) rectangle (b);
  \end{pgfonlayer}
  \node [rectangle, above of=actuators, shift={(-0.6,0.55)}, node distance=1.7em] (autopilot) {\footnotesize UAV plant};

  \begin{pgfonlayer}{background}
    \path (attitude.west |- attitude.north)+(-0.25,0.47) node (a) {};
    \path (imu.south -| attitude.east)+(+0.25,-0.10) node (b) {};
    \path[fill=gray!3,rounded corners, draw=black!70, densely dotted]
      (a) rectangle (b);
  \end{pgfonlayer}
  \node [rectangle, above of=attitude, shift={(0,0.2)}, node distance=1.7em] (autopilot) {\footnotesize Pixhawk autopilot};

  %%}

\end{tikzpicture}
}