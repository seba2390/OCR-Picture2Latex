AMMs are intended to be composed.
A Uniswap v1 AMM typically converts between an ERC-20 token and ether cryptocurrency.
To convert, say, florin tokens to guilder tokens,
one would first convert florins to ether, then ether to guilders.
Bancor uses a proprietary BNT token for the same purpose.
Some form of composition seems to be essential to making AMMs useful,
but we will see that while there are many ways in which AMMs might be composed,
not all of them make sense.
The most basic property one would demand is \emph{closure} under composition:
the result of composing two AMMs should itself be an AMM.

Being closed under composition should not be taken for granted.
For example, consider two constant-product AMMs:
$A := (x, 1 / x)$, initialized in state $(a,1/a)$,
and
$B := (y, 1 / y)$, initialized in state $(b,1/b)$.
Their composition $A \otimes B = (x,h(x))$, where
\begin{equation}
  h(x) = \frac{1}{b + \frac{1}{a} - \frac{1}{x}}
       = \frac{a x}{x - a + a b x}.
\end{equation}
The set of constant-product AMMs is thus not closed under composition.

\subsection{One-to-One Composition}
We first consider the result of composing 2-dimensional AMMs,
that is, AMMs that trade between two asset types.

Consider AMMs $A := (x,f(x))$, initialized to $(a,f(a))$,
and $B := (y,g(y))$, initialized to $(b,g(b))$.
$A$ trades between asset types $X$ and $Y$,
and $B$ between $Y$ and $Z$.
Their composition, initialized to $(a,g(b))$,
trades between $X$ and $Z$.

Operationally, composition is defined as follows.
\begin{itemize}
\item Move $A$ from state $(a,f(a))$ to state $(x,f(x))$,
yielding profit-loss vector $(a-x,f(a)-f(x))$.
\item Add $f(a)-f(x)$ to the $Y$ balance of $B$,
  yielding new state $(b+f(a)-f(x), g(b+f(a)-f(x)))$.
\end{itemize}
This trade
takes the composition from $(a,g(b))$ to $(x, g(b+f(a)-f(x)))$.
Let $h(x) = g(b+f(a)-f(x))$.
The composition $A \otimes B$ is given in the form $(x,h(x))$. Because $f,g$ are twice-differentiable:
\begin{lemma}
  $(A \otimes B)(x,y)$ is twice-differentiable.
\end{lemma}
\begin{lemma}
  $(A \otimes B)(x,y)$ is strictly increasing.
\end{lemma}
\begin{proof}
  We show that if $(x',y') \gneqq (x,y)$, meaning at least one coordinate is strictly greater,
  then $(A \otimes B)(x',y') > (A \otimes B)(x,y)$.
  Recall that $f$ and $g$ are strictly decreasing by hypothesis.
  There are two cases.
  First, suppose $x' > x$ and $y' \geq y$.
\begin{align*}
  x' &> x\\
  f(x') &< f(x)\\
  b+f(a)-f(x') &> b+f(a)-f(x)\\
  g(b+f(a)-f(x')) &< g(b+f(a)-f(x))\\
  y-g(b+f(a)-f(x')) &> y-g(b+f(a)-f(x))\\
  y'-g(b+f(a)-f(x')) &> y-g(b+f(a)-f(x))\\
  (A \otimes B)(x,y') &> (A \otimes B)(x,y)
\end{align*}
  The second case, where $x' \geq x$ and $y' > y$ is similar.
\end{proof}
\begin{lemma}
  The upper contour set $\upper(A \otimes B)$ is strictly convex.
\end{lemma}
\begin{proof}
  Since $\upper(A \otimes B) = \epi(h)$, by \lemmaref{epigraph}, it is enough to check the strict convexity of $h$.
  Pick two distinct $x$ and $x'$.
  Recall that for $t \in (0,1), f(t x + (1-t)x') < t f(x) + (1-t)f(x')$,
  and similarly for $g(y)$ by hypothesis.
  For $t \in (0,1)$,
  \begin{equation*}
    f((1-t)x + t x') \\
    < (1-t)f(x) + t f(x')
  \end{equation*}
  \begin{multline*}
    b+f(a)-f((1-t)x + t x') \\
    > (1-t)(b+f(a)-f(x))\\ + t(b+f(a)-f(x'))
  \end{multline*}
  \begin{multline*}
      g(b+f(a)-f((1-t)x + t x')) \\
      < (1-t)g(b+f(ag)-f(x)) \\+ tg(b+f(a)-f(x')))
  \end{multline*}
  \begin{equation*}
    h((1-t)x + t x) < (1-t)h(x) + t h(x')\\
  \end{equation*}
  which proves the claim.
\end{proof}
The next lemma relates stability and sequential composition
for 2-dimensional AMMs.

\begin{lemma}
  Let $(v,w,v')$ be a valuation for assets $X,Y,Z$.
  If $(a,f(a))$ is the stable point for AMM $A := (x,f(x))$
  for valuation $(v,w)/ \|(v,w)\|_1$
  and $(b,g(b))$ the stable point for AMM $(y,g(y))$
  for valuation $(w,v')/ \|(w,v')\|_1$,
  then $(a,h(a))$ is the stable point for the valuation $(v,v')/\|(v,v')\|_1$.
\end{lemma}

\begin{proof}
If $(a,h(a))$ is not the stable point for $(v,v')$,
there is some $x \neq a$ such that $(x,h(x))$ is the stable point.
By assumption, for $x \neq a$ and $y \neq b$,
\begin{align*}
    &v a + wf(a) < v x + w f(x)\\
    &wb + v'g(b) < wy + v'g(y)
\end{align*}
Also by assumption,
\begin{align*}
  vx + v'h(x)
  &< va + v'h(a)\\
  &= va +v'g(b + f(a) - f(a))\\
  &= va + v'g(b) \\
  &= va + wf(a) - wf(a) + wb - wb + v'g(b) \\
    &< vx + wf(x) - wf(a) + wy + v'g(y) - w b\\
    &= vx + w(f(x) - f(a)) + w(y - b) + v'g(y) \\
    &= vx + w(f(x) - f(a)) + w(f(a) - f(x))\\
    &\quad \quad + v'g(b + f(a) - f(x))\\
    &= vx +v'h(x),
\end{align*}
a contradiction.
(The last step follows by taking $y = b + f(a) - f(x) \neq b$,
possible since $f$ strictly decreasing).
\end{proof}

The converse is false.
Consider two constant product AMMs $A := (x,\frac{1}{x})$
and $B := (y,\frac{1}{y})$,
both initially in state $(1,1)$.
The composed AMM is given by $A \otimes B$ $(x,\frac{x}{2x-1})$ with state $(1,1)$.
Now if $(v,w,v') = (\frac{1}{4},\frac{1}{2},\frac{1}{4})$,
$(1,1)$ is the stable point of $A \otimes B$ with respect to $(v,w,v')$.
However, the stable point for $(v,w)$ on $A$ is
$(\sqrt{2},\frac{\sqrt{2}}{2})$
and $(w,v')$ on $B$ is $(\frac{\sqrt{2}}{2},\sqrt{2})$.


\subsection{Many-to-One Composition}
\seclabel{many-to-one}
AMM $A$ trades asset types $X_1, \ldots, X_m, Z$,
with initial state $(\ba, f(\ba))$,
where $\ba=(a_1,\ldots,a_m)$,
and $f(\ba)$ is the explicit function
defining the $Z$ coordinate in terms of the others.

AMM $B$ trades asset types $Z, Y_1, \ldots, Y_n$,
with initial state $(c,\bb, g(c,\bb))$,
where $\bb=(b_1,\ldots,b_{n-1})$,
and $g(c,\bb)$ is the function
defining the $Y_n$ coordinate in terms of the others.

The $Z$ asset flows between $A$ and $B$ but is
not directly accessible to traders.
The composition $A \otimes B$ trades asset types
$X_1, \ldots, X_m, Y_1, \ldots, Y_n$,
with initial state $(\ba, \bb, h(\ba,\bb))$,
for $h$ to be defined.

Operationally, the composition works as follows.
The trader changes each $a_i$ to $x_i$, $0 \leq i \leq m$,
and each $b_i$ to $y_i$, $0 \leq i \leq n-1$.
Let $\bx=(x_1,\ldots,x_m)$ and $\by=(y_1,\ldots,y_{n-1})$.
The new state of $A$ is $(\bx,f(\bx))$.
The amount of $Z$ that flows from $A$ to $B$ is $f(\ba)-f(\bx)$.
The new state of $B$ is
$(c+f(\ba)-f(\bx), \by, g(c+f(\ba)-f(\bx)))$.
The new state of $A \otimes B$ is
$(\bx,\by,g(c+f(\ba)-f(\bx)))$

Define $h(\bx,\by) = g(c+f(\ba)-f(\bx), \by)$.
$(A \otimes B)(\bx,\by,z) = z - h(\bx,\by)$.
\begin{lemma}
  $(A \otimes B)(\bx,\by,z)$ is twice-differentiable.
\end{lemma}
\begin{proof}
  Immediate because $f,g$ are twice-differentiable by hypothesis.
\end{proof}
\begin{lemma}
  $(A \otimes B)(\bx,\by,z)$ is strictly increasing.
\end{lemma}
\begin{proof}
  We show that if $(\bx',\by',z') \gneqq (\bx,\by,z)$,
  then $(A \otimes B)(\bx',\by',z') > (A \otimes B)(\bx,\by,z)$.
  There are two cases.
  First, suppose $(\bx',\by') \gneqq (\bx,\by)$ and $z' \geq z$.
\begin{align*}
  (\bx',\by') &\gneqq (\bx,\by)\\
  f(\bx',\by') &< f(\bx,\by)\\
  \bb+f(\ba)-f(\bx',\by') &> \bb+f(\ba)-f(\bx,\by)\\
  g(\bb+f(\ba)-f(\bx',\by')) &< g(\bb+f(\ba)-f(\bx,\by))\\
  z-g(\bb+f(\ba)-f(\bx',\by')) &> z-g(\bb+f(\ba)-f(\bx,\by))\\
  z'-g(\bb+f(\ba)-f(\bx',\by')) &> z-g(\bb+f(\ba)-f(\bx,\by))\\
  (A \otimes B)(\bx',\by',z') &> (A \otimes B)(\bx,\by,z)
\end{align*}
  The second case, where $\bx' \geq \bx$ and $z' > z$ is similar.
\end{proof}
\begin{lemma}
  $\upper(A \otimes B)$ is strictly convex.
\end{lemma}
\begin{proof}
   Again it is enough to show $h$ is strictly convex.
   Pick two different points $(\bx,\by)$ and $(\bx',\by')$.
  Recall that $f$ and $g$ are strictly convex by hypothesis.
  For $t \in (0,1)$,
  \begin{multline*}
      f((1-t)(\bx,\by) + t(\bx',\by'))\\
      < (1-t)f(\bx,\by) + t f(\bx',\by')
  \end{multline*}
  \begin{multline*}
      b+f(a)-f((1-t)(\bx,\by) + t (\bx',\by'))\\
      > (1-t)(b+f(a)-f(\bx,\by))\\ + t(b+f(a)-f(\bx',\by'))
  \end{multline*}
  \begin{multline*}
    g(b+f(a)-f((1-t)(\bx,\by) + t(\bx',\by'))) \\
    < (1-t)g((b+f(a)-f(\bx,\by))\\ + tg(b+f(a)-f(\bx',\by'))
  \end{multline*}
  \begin{multline*}
    h((1-t)(\bx,\by) + t(\bx',\by')) \\
    < (1-t)h(\bx,\by) + t h(\bx',\by')
  \end{multline*}
\end{proof}
Here is how stable points behave under sequential composition of multi-dimensional AMMs.

\begin{theorem}
\sloppy
  Let $(\bv,w,\bv')$ be a valuation, $\bv \in \Reals^n$, 
  $w \in \Reals$, and
  $\bv' \in \Reals^m$.
  If $(\ba^{*},f(\ba^{*}))$ is the stable point on AMM $(\bx,f(\bx))$
  for valuation $(\bv,w) / \|(\bv,w)\|_1$ and
  $(c,\bb^{*},g(c,\bb^{*}))$ is the stable point on AMM $(z,\by,g(z,\by))$
  for  valuation $(w,\bv') / \|(w,\bv')\|_1$,
  then $(\ba^{*},\bb^{*},h(\ba^{*},\bb^{*}))$ is the stable point for the valuation
  $(\bv,\bv') / \|(\bv,\bv')\|_1$.
  \end{theorem}

\begin{proof}
if $(\ba^{*},\bb^{*},h(\ba^{*},\bb^{*}))$ is not a stable point for $(\bv,\bv')$,
there is some $(\bx,\by) \neq (\ba^{*},\bb^{*})$ such that
$(\bx,\by,h(\bx,\by))$ is the stable point.
We write $\bv' = (\bv'_{m-1},v'_m)$ to separate the first $m-1$ components from the $m$-th component.
By assumptionm for $\bx \neq \ba^{*}$ and $(z,\by) \neq (c,\bb^{*})$,
\begin{align*}
    bv \cdot \ba^{*} + wf(\ba^{*}) 
    &< \bv \cdot \bx + wf(\bx) wc + \bv'_{m-1} \cdot \bb +  v'_m g(c,\bb) \\
    &< wz + \bv'_{m-1} \cdot \by +  v'_m g(z,\by)
\end{align*}
Also by assumption
\begin{align*}
  \bv \cdot \bx& + \bv'_{n-1} \cdot \by + v'_{m}h(\bx,\by)\\
  &< \bv \cdot \ba^{*} + \bv'_{m-1} \cdot \bb^{*} + v'_{m}h(\ba^{*},\bb^{*}) \\
  &= \bv \cdot \ba^{*} +wf(\ba^{*}) - wf(\ba^{*}) + wc - wc +  \bv'_{m-1} \cdot \bb^{*} \\
  &\quad \quad + v'_{m}g(c,\bb^{*}) \\
    &< \bv \cdot \bx + wf(\bx) - wf(\ba^{*}) + wz +\\
    &\quad \quad\bv'_{m-1} \cdot \by + v'_mg(z,\by) - wc \\
    &= \bv \cdot \bx + \bv'_{m-1} \cdot \by + v'_mg(z,\by)\\ 
    &= \bv \cdot \bx + \bv'_{m-1} \cdot \by + v'_mg(c + f(\ba^{*}) - f(\bx),\by) \\
    &= \bv \cdot \bx + \bv'_{m-1} \cdot \by + v'_mh(\bx,\by)
\end{align*}
a contradiction.

\end{proof}

\subsection{Many-to-Many Composition}
What does it mean to compose two AMMs that share multiple assets?
We will see that this definition requires some care.

Here is the most obvious definition.
Let $W,X,Y,Z$ be asset types.
Consider two 3-dimensional AMMs, $A$ defined by $w x y = 1$ and 
$B$ defined by $x y z = 8$.
where $A$ is in state $(1,1,1)$ and $B$ in state $(2,2,2)$.
We want to compose them into a 2-dimensional AMM $(A \oplus B)$ between $W$ and $Z$
treating $X$ and $Y$ as ``hidden'' intermediate assets.

A trader adds $dx > 0$ units of $X$ to $(A \oplus B)$:
\begin{enumerate}
\item pick any $dy,dz \leq 0$ satisfying $(1+dx)(1+dy)(1+dz) = 1$,
yielding a profit-loss vector on $Y,Z$ of $(dy,dz)$.
\item Subtract this profit-loss vector from the first two components of $B$,
then solve for $dw \leq 0$ so that $(2-dy) (2-dz) (2+dw) = 8$.
\end{enumerate}
More generally,
let $A$ be initialized in $(a,b,c)$, $B$ in $(b',c',d)$.
and $A \oplus B$ in $(a,d)$.
Then $(w,z)$ is in $A \oplus B$ if there exist $dx,dy \leq 0$
(the assets transferred)
such that $(w, b+dx, c+dy)$ is in $A$ and $(b'-dx, c'-dy, z)$ is in $B$.

Here is why this na\"ive definition of composition is flawed.
As before, $A(w,x,y) := wxy= 1$ starts in state $(1,1,1)$, 
$B(x,y,z) := xyz = 8$ starts in $(2,2,2)$.
Let $dw = 3$, $dx= -\frac{1}{2}$, $dy= - \frac{1}{2}$, so $dz$ satisfies:
\begin{equation*}
  (2-dx)(2-dy)(2+dz) = \frac{25}{4}(2+dz) = 2 
\end{equation*}
implying $dz = -\frac{42}{25}$.
If instead $dw = 3$, $dx= -\frac{1}{4}$, $dy= - \frac{2}{3}$, then $dz$ satisfies:
\begin{equation*}
  (2-dx)(2-dy)(2+dz) = 6(2+dz) = 2 
\end{equation*}
meaning $dz = -5/3$.
So both $(4,\frac{8}{25})$ and $(4,\frac{1}{3})$ are valid states in the na\"ive composition,
violating the requirement that each coordinate is a function of the others.

We have just seen that AMMs joined by more than one hidden asset type
provide too many degrees of freedom to allow composition in a simple, well-defined way.
In a practical sense, however,
if two AMMs agree on a valuation for the hidden assets,
then it makes sense to transfer them in proportion
to their agreed-upon relative values.
To define composition for AMMs with multiple hidden assets,
we create a single virtual asset from a convex combination of
the hidden assets (\secref{virtualization}).
Although any convex combination would produce a well-behaved composition,
it makes sense to use the current market valuation,
if one exists.
By reducing the number of hidden assets to one,
virtualization reduces many-to-many composition to many-to-one composition, as analyzed in \secref{many-to-one}.

Our next theorem concerns stable points under this most general type of sequential composition.
\begin{theorem}
\sloppy
Let $(\bv,\bw,\bv')$ be a valuation, $\bv \in \Reals^n,\bw \in \Reals^k,\bv' \in \Reals^m$.
Let $(\ba^{*},\bb^{*})$ be the stable state for
valuation $(\bv,\bw) / \|(\bv,\bw)\|_1$ on the AMM $A(\bx,\by)$
and $(\bc^{*},\bd^{*},e^{*})$ the stable state for
$(\bw,\bv') / \|(\bw,\bv')\|_1$ on the AMM $B(\bz,\br,q)$.
If $A|\bw:=(\bx,f(\bx))$ and $B| \bw:=(z,\br,g(z,\br))$,
then $(\ba^{*},\bd^{*},h(\ba^{*},\bd^{*}))$,
where $e^{*} = h(\ba^{*},\bd^{*})$ is the stable state on $(A | \bw) \oplus (B | \bw)$
for the valuation $(\bv,\bv')  / \|(\bv,\bv')\|_1$.
\end{theorem}

\begin{proof}
Applying \lemmaref{virtual-stable} twice,
$(\ba^{*},f(\ba^{*}))$ is the stable point for valuation
$(\bv,\|\bw\|_2^2) / \|(\bv,\|\bw\|_2^2)\|_1$
and $(t^{*},\bd^{*},g(t^{*},\bd^{*}))$ is the stable point for valuation
$(\|(\bw\|_2^2,\bv') / \|(\|(\bw\|_2^2,\bv')\|_1$,
where $e^{*} = g(t^{*},\bd^{*})$.
Applying \lemmaref{virtual-stable},
$(\ba^{*},\bd^{*},h(\ba^{*},\bd^{*}))$ is stable on $(A | \bw) \oplus (B | \bw)$ with respect to
valuation \\ $(\bv,\bv')/ \|(\bv,\bv')\|_1$.
   
\end{proof}
This result shows that the composition of AMMs at stable points remains stable.


