
Parallel composition arises when a trader is faced with multiple AMMs,
but wants to treat them them as if they were a single AMM.
In sequential composition,
the composed AMMs exchange ``hidden'' assets .
In parallel composition,
the composed AMMs compete for overlapping assets.

Suppose Alice wants to trade asset $X$ for asset $Y$.
Bob and Carol both offer AMMs to convert from $X$ to $Y$.
Bob's AMM is $B(x,y):=x^2y=\frac{3}{4}$ in state $(1,\frac{3}{4})$,
while Carol's AMM is $C(x,y):=x y = 1$ in state $(1,1)$.
Alice would like to compose the two AMMs and treat them as one AMM.
Bob provides a better initial rate of exchange for small trades,
but Carol provides less slippage for large trades.
One can check that if Alice converts 1 unit of $X$,
she gets more $Y$ assets from Bob than from Carol,
while if she converts 3 units,
she gets more from Carol.

This process is not the same as order-book clearing,
because order-book offers are typically expressed in terms of a fixed amount and a fixed price,
while parallel AMM offers are expressed in terms of price curves.
This type of composition occurs, for example,
when a trader is faced with multiple pools as in Uniswap v3~\cite{uniswapv3}.

A rational Alice will split her assets between
Bob and Carol to maximize her return.
Suppose $A(x,y)$ is in state $(a,f(a))$
and $B(x,y)$ in $(b,g(b))$.
Alice splits her $d$ assets,
transferring $t d$ to Bob's AMM
and $(1-t)d$ to Carol's,
returning
\begin{equation*}
  f(a) - f(a+tx) + g(b) - g(b+(1-t)x)
\end{equation*}
units of $Y$.
Let $h(x) = f(a+tx) + g(b+(1-t)x)$.
Define the \emph{parallel composition} of $B$ and $C$
with respect to $v=(t,1-t)$ to be.
\begin{equation*}
    (B\|C)(x,y) := y - h(x) = 0.
\end{equation*}
\begin{lemma}
  $(B\|C)(x,y)$ is a 2-dimensional AMM.
\end{lemma}
\begin{proof}
  $(B\|C)(x,y)$ is twice-differentiable because $f$ and $g$ are twice-differentiable.
  To check that $(B\|C)(x,y)$ is strictly increasing,
  let $x' \geq x$ and $y' \geq y$ where at least one inequality is strict.
  For the first case, suppose $x' > x$ and $y' \geq y$.
  \begin{align*}
    f(a+tx') &< f(a+tx) \\
    g(b+(1-t)x') &< g(b+(1-t)x) \\
    f(a+tx') + g(b+(1-t)x') &< f(a+tx) + g(b+(1-t)x) \\
    h(x') &< h(x) \\
    y - h(x') &> y-h(x)\\
    y' - h(x') &> y-h(x)
  \end{align*}
  The case where $x' \geq x$ and $y'> y$ is similar.

  To check that $\upper((B\|C)(x,y))$ is strictly convex,
  we can verify $h$ is strictly convex.
  Pick distinct $x,x'$.
  For $s \in (0,1)$,
  \begin{multline*}
    s f(a+t x) + (1-s) f(a+t x')\\
    > f(s (a+t x) + (1-s) (a+t x')) 
  \end{multline*}
  \begin{multline*}
    s g(b+(1-t)x) + (1-s) g(b+(1-t)x') \\
    >g(s (b+(1-t)x) + (1-s) (b+(1-t)x'))
  \end{multline*}
  \begin{multline*}
    s (f(a+t x) + g(b+(1-t)x))\\ + (1-s)(f(a + t x')+g(b+(1-t)x'))\\
    > f(s (a + t x) + (1-s) (a + t x'))\\ + 
    g(s (b+(1-t)x) + (1-s) (b+(1-t)x'))
  \end{multline*}
  \begin{equation*}
    s h(x) + (1-s)h(x') > h(s x + (1-s)x')  \\
  \end{equation*}
  which establishes the claim.
\end{proof}

\begin{lemma}
  Let $A := (x,f(x))$, $B := (y,g(y))$ be two AMMs trading assets $X$ and $Y$,
  such that $(a,f(a))$ and $(b,g(b))$ are their respective stable points
  for the valuation $(v,1-v)$.
  If $h_t(x) = f(a + tx) + g(b + (1-t)x)$,
  then $(0,h_t(0))$ is stable point on $A \| B$ with respect to $(v,1-v)$ for all $t \in \Reals$.
\end{lemma}

\begin{proof}
By assumption we have
\begin{align*}
    v a + (1-v)f(a) &< v(a + tx) + (1-v)f(a + tx)\\
    (1-v)f(a) &< tvx + (1-v)f(a + tx)
\end{align*}
and
\begin{align*}
  vb + (1-v)g(b) &< v(b + (1-t)x) + (1-v)g(b + (1-t)x)\\
  (1-v)g(b) &< (1-t)vx + (1-v)g(b + (1-t)x),
\end{align*}
yielding
\begin{align*}
  v 0 + (1-v)h_t(0)
  &= (1-v)h_t(0) \\
  &= (1-v)f(a) + (1-v)g(b) \\
  &< tvx + (1-v)f(a + tx) + (1-t)vx \\
  &\quad \quad + (1-v)g(b + (1-t)x) \\
  &= vx + (1-v)(f(a + tx) + g(b + (1-t)x)) \\
  &= vx + (1-v)h(x)
\end{align*}
so $(0,h_t(0))$ is a stable point for $(v,(1-v))$.
\end{proof}


Parallel composition is well-defined for any valuation,
but what valuation should a rational Alice pick?
Differentiating with respect to $t$ yields
\begin{align}
  0 &= -x f'(a+t x) + x g'(b+(1-t)x)\nonumber\\
  x f'(a+t x) &= x g'(b+(1-t)x) \nonumber\\
  f'(a+t x) &= g'(b+(1-t)x).\eqnlabel{best-split}
\end{align}
Alice maximizes her return when she splits her
assets so that Bob and Carol end up offering the same rate.
Informally, if Bob had ended up providing a better rate,
then Alice should have given him a larger share.
If there is no $t \in (0,1)$ that satisfies \eqnref{best-split},
Alice should give all her assets to the AMM with the better rate.

How should parallel composition be defined for AMMs with multiple asset types?
Suppose Alice has some combination $\bd$ of assets in $X_1,\ldots,X_p$
that she wants to convert into some combination of assets in $Y_1,\ldots,Y_q$.
Alice has a choice of two alternative AMMs:
$B(x_1,\ldots,x_p,y_1,\ldots,y_q)$ and $C(x_1,\ldots,x_p,y_1,\ldots,y_q)$.
Perhaps the most sensible way to define parallel composition is through
asset virtualization.
Alice's input asset vector $\bd$ induces a valuation $\bd/ \|\bd\|_1$
which can be used to define a virtual asset $X$ from $X_1,\ldots,X_p$.
Alice chooses a valuation $\bv$ for her $Y_1,\ldots,Y_q$ outputs
(perhaps the market valuation)
which can be used to define a virtual asset $Y$ from $Y_1,\ldots,Y_q$.
After asset virtualization, the alternative AMMs have the form:
$\tilde{B}(\bx,t)$ and $\tilde{C}(\bx,t)$,
and the definition of parallel composition proceeds as before.

The next lemma describes properties of stable points for two 2-dimensional AMMs composed in parallel.

If $(\bx,f(\bx))$ and $(\by,g(\by))$ are two $n$-dimensional AMMs in states $(\ba,f(\ba))$ and $(\bb,g(\bb))$,
we can define parallel composition as follows.
For $\bt \in [0,1]^{n-1}$,
let $h_{\bt}(\bx) = f(\ba + \bt * \bx) + g(\bb + (\bone - \bt )* \bx)$,
where $*$ is component-wise multiplication.

\begin{lemma}
  \lemmalabel{parallel-stable}
  Let $(\bv,1-\|\bv\|_1))$ be a valuation,
  and let $A := (\bx,f(\bx))$ and $B := (\by,g(\by))$.
  If $(\ba,f(\ba))$ and $(\bb,g(\bb))$ are both stable points with respect to $(\bv,1-\|\bv\|_1))$.
  then $(\bzero,h_{\bt}(\bzero))$ is the stable point on $A \| B$  for $(\bv,1-\|\bv\|_1)$
  for all $\bt \in \Reals^{n-1}$.
  \end{lemma}

  \begin{proof}
    For $\bt \in \Reals^{n-1}$,
    \begin{multline*}
      \bv \cdot \ba + (1-\|\bv\|_1)f(\ba)\\
      < \bv \cdot (\ba + \bt * \bx) + (1-\|\bv\|_1)f(\ba + \bt * \bx)
    \end{multline*}
    \begin{equation*}
      (1-\|\bv\|_1)f(\ba)
      < (\bt * \bx) \cdot \bv + (1-\|\bv\|_1)f(\ba + \bt * \bx)
    \end{equation*}
    and
    \begin{multline*}
      \bv \cdot \bb + (1-\|\bv\|_1)g(\bb)\\
      < \bv \cdot (\bb + (\bone - \bt) * \by) + (1-\|\bv\|_1)g(\bb + (\bone - \bt) * \by)
    \end{multline*}
    \begin{multline*}
      (1-\|\bv\|_1)g(\bb) \\
      < ((\bone - \bt) * \by) \cdot \bv + (1-\|\bv\|_1)g(\bb + (\bone - \bt) * \by),
     \end{multline*}
implying
\begin{align*}
  \bv \cdot \bzero + &(1-\|\bv\|_1)h_t(\bzero) \\
  &= (1-\|\bv\|_1)h_t(\bzero) \\
  &= (1-\|\bv\|_1)f(\ba) +(1-\|\bv\|_1)g(\bb) \\
  &< (\bt * \bx) \cdot \bv + (1-\|\bv\|_1)f(\ba + \bt * \bx) \\
  &\quad \quad+ (\bone-\bt) * \bx \cdot \bv + \\
  &\quad \quad (1-\|\bv\|_1)g(\bb + (\bone-\bt) * \bx)\\
    &= \bv \cdot \bx + (1-\|\bv\|_1)(f(\ba + \bt \cdot \bx) \\
    &\quad \quad + g(\bb + (\bone-\bt) \cdot \bx))  \\
    &= \bv \cdot \bx + (1-\|\bv\|_1)h(\bx)
\end{align*}
so $(0,h_t(0))$ is a stable point for $(\bv,1-\|\bv\|_1)$.
\end{proof}
Most generally, if we have two AMMs $A(\bx,\bz)$ and $B(\by,\bz')$, and valuation $\bw$,
we can write $A| \bw$ as $(\bx,f(\bx))$ and $B| \bw$ as $(\by,g(\by))$.
We then can define parallel composition as before.

\begin{theorem}
    Let $(\bv,\bv')$ be a valuation, and let $A(\bx,\bz)$ and $B(\by,\bz')$ two AMMs.
    If $(\ba^{*},\bb^{*})$ is the stable point for $A$,
    and $(\bc^{*},\bd^{*})$ the stable point for $B$,
    both with respect to $(\bv,\bv')$,
    then $(\bv,\|\bv'\|_2^2)/\|(\bv,\|\bv'\|_2^2)\|_1$ is the stable point for $(A | \bv' ) \| (B | \bv')$.
\end{theorem}

\begin{proof}\sloppy
  \lemmaref{virtual-stable} implies that $(\ba^{*},f(\ba^{*}))$ and $(\bc^{*},g(\bc^{*}))$
  are stable on $A | \bv'$ and $B | \bv'$,
  both with respect to $(\bv,\|\bv'\|_2^2)$. 
\lemmaref{parallel-stable} implies that $(\bzero,h_{\bt}(\bzero))$
is the stable point for
$(A | \bv' ) \| (B | \bv')$ with respect to valuation $(\bv,\|\bv'\|_2^2)$.
\end{proof}
