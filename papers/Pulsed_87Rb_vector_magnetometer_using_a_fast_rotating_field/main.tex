\documentclass[prx,twocolumn,10pt,nofootinbib]{revtex4-1}
\usepackage{inputenc}
\usepackage{natbib}
\usepackage{graphicx}
\usepackage{amsmath}
\usepackage{bm}
\usepackage{multirow}
\usepackage{array}
\usepackage{float}

\begin{document}
\title{Pulsed $^{87}$Rb vector magnetometer using a fast rotating field}
\author{Tao Wang$^{1, 2}$}
\email{tao\_wang@imre.a-star.edu.sg}
\author{Wonjae Lee$^1$}
\author{Michael Romalis$^1$}
\email{romalis@princeton.edu}
\author{Mark Limes$^3$}
\author{Tom Kornack$^3$}
\author{Elizabeth Foley$^3$}
\affiliation{$^1$Department of Physics, Princeton University, Princeton, New Jersey, 08544, USA}
\affiliation{$^2$Quantum Technologies for Engineering, Institute of Materials Research and Engineering (IMRE), Agency for Science, Technology and Research (A*STAR), 2 Fusionopolis Way, Innovis \#08-03, Singapore 138634, Republic of Singapore}
\affiliation{$^3$Twinleaf LLC, 300 Deer Creek Dr., Plainsboro, New Jersey, 08536, USA}

\date{\today}

\begin{abstract}
There are diverse set approaches for vector magnetic ﬁeld measurements involving condensed matter and atomic physics systems. However, they all suﬀer from various limitations, so the most widely used high-sensitivity vector magnetometers are ﬂuxgates using soft magnetically-saturable materials. Here we describe a vector magnetometer by applying an external rotating magnetic ﬁeld to a scalar atomic magnetometer. Such an approach provides simultaneous measurements of the total magnetic ﬁeld and two polar angles relative to the plane of magnetic ﬁeld rotation. Crucially, it avoids several metrological diﬃculties associated with vector magnetometers and gradiometers. We describe in detail the fundamental, systematic, and practical limits of such vector magnetometers. We use a ﬁeld rotation rate faster than the spin relaxation rate. We show that it eliminates a class of systematic eﬀects associated with heading errors in alkali-metal scalar magnetometers. We investigate several other systematic eﬀects, such as Berry’s phase frequency shift and the eﬀects of eddy currents in nearby conductors. We also derive fundamental limits on the sensitivity of such sensors and show that the vector sensitivity can approach the sensitivity of scalar atomic magnetometers.
\end{abstract}
\maketitle

\section{Introduction}
Measurements of magnetic ﬁelds have a rich history starting with the invention of the compass. Among the ﬁrst and still most widely used vector sensors are ﬂuxgate magnetometers based on asymmetry in saturation of a soft magnetic material in an applied oscillating magnetic ﬁeld \cite{koch2001low}. Advanced condensed-matter-based approaches involve SQUID magnetometers \cite{storm2017ultra}, Hall sensors \cite{nhalil2019planar} and magneto-resistive sensors \cite{li2012magneto}. These sensors are intrinsically vector devices that measure one component of the magnetic ﬁeld, so three separate sensors are typically required for full vector sensing. In contrast, atomic magnetometers are intrinsically scalar devices that measure the energy splitting between spin states in a magnetic ﬁeld. Additional interactions are required to deﬁne the vector axes for a scalar sensor.

Sensitive vector magnetometers operating in Earth’s ﬁeld have several metrological challenges. For example, a 50 fT magnetic ﬁeld corresponds to 1 part in $10^9$ of Earth’s ﬁeld. Such relative precision is beyond the capability of most analog voltage measurements. However, frequency measurements can easily achieve much higher relative precision. SQUID magnetometers also can achieve higher fractional resolution using ﬂuxquanta counting techniques \cite{storm2017ultra}. Another challenge is a stable alignment and orthogonality of vector axes directions, which require nano-radian stability. Magnetic gradiometers are particularly important when operating as a vector sensor in Earth’s magnetic ﬁeld to distinguish between magnetic ﬁeld changes and sensor orientation changes.

With these challenges in mind, scalar atomic magnetometers provide a promising approach to vector sensing since they are intrinsically based on frequency measurements. Several diﬀerent approaches have created vector sensitivity for atomic sensors using external magnetic ﬁelds, lasers, or microwave ﬁelds. One of the advantages of using external magnetic ﬁelds is their relative uniformity that allows the same vector axes orientation for multiple sensors. We use an applied rotating ﬁeld to create vector sensitivity. One can show that for any coil imperfections or non-orthogonality, as long as the coils remain linear, a rotating ﬁeld always has a unique rotation plane that deﬁnes the vector axes in our approach.

The sensitivity of atomic magnetometers is on par with the most sensitive condensed-matter-based approaches, such as SQUID magnetometers \cite{storm2017ultra}. While atomic vector sensors operating in spin-exchange relaxation free (SERF) regime are considered the most sensitive \cite{dang2010ultrahigh}, scalar magnetometers based on multi-pass cells have also reached sub-$\mathrm{fT/Hz^{1/2}}$ sensitivity regime \cite{sheng2013subfemtotesla}. Here we explore a scalar magnetometer conﬁguration using a pulsed pump laser similar to \cite{sheng2013subfemtotesla} and show vector sensitivity of the sensor can approach its scalar sensitivity while retaining the accuracy and metrological advantages of scalar sensors. Scalar atomic magnetometers have been widely used outside the lab in various geomagnetic and space applications \cite{slocum1963low}. Recently they have also been used to detect biomagnetic ﬁelds outside of the lab \cite{limes2020portable}. Vector sensing of similar sensitivity will provide better localization accuracy for detecting magnetic sources \cite{wiegert2007demonstration,brookes2021theoretical}, whether in the Earth or the brain.

% Quantum sensing technology comes of age \cite{degen2017quantum}. Especially, the atomic magnetometers have been proven to be the most sensitive magnetic sensors \cite{dang2010ultrahigh, sheng2013subfemtotesla}, which have been promisingly applied in various applications, such as biomedical imaging \cite{boto2018moving, limes2020portable, shah2013compact, borna201720, savukov2013magnetic, de2021measuring}, dark matter detection \cite{afach2021search, kimball2020overview, safronova2018search, budker2014proposal, garcon2017cosmic, wang2018application}, magnetic anomaly detection \cite{sheinker2009magnetic, zhou2017spatial}, space exploration \cite{slocum1963low}, and  fundamental physics \cite{brown2010new, groeger2006laser}. The atomic magnetometers directly measure the Larmor precession frequency of atomic spins. They are intrinsically sensitive to the magnitude of the magnetic field rather than magnetic field projections in three axes. The high-sensitivity atomic magnetometers that can directly work in the geomagnetic fields are of great interest of many applications. For instance, biomedical imaging is based on atomic magnetometers does not require the bulk and expensive magnetic shielded room \cite{bison2009room, zhang2020recording}. Their abilities of directly working in the earth field and heading-error-free are essential for the airborne-exploration applications \cite{thomson2007airborne}.

% However, optical magnetometry in the geophysical magnetic field is very challenging due to the effects that are negligible at the low magnetic field becoming significant in the earth field, such as the nonlinear Zeeman effect, which leads to heading error.  The so-called heading error is an effect the fictitious dependence of the atomic magnetometer readings on the relative orientation of the spin polarization and magnetic field \cite{bao2018suppression, wang2019aeromagnetic}. For a vector atomic magnetometer, the measured transverse magnetic fields can provide information about the angle tilted from the leading field, therefore, the heading error correction can be calculated based on the model of heading error \cite{lee2021heading}.

% Three vector components of the magnetic field can provide a complete determination of the magnetic field and are required for many applications, like real-time localization of buried mines and unexploded ordnance \cite{wiegert2007demonstration}. Furthermore, a vector magnetometer can help to distinguish the brain signals from the magnetic field of the environment and eliminate artefacts caused by head movement \cite{brookes2021theoretical}.

There are several approaches to realizing vector atomic magnetometers: \textbf{Applying sequential scanning magnetic field to scalar magnetometers}, for instance, the polar angles can be measured by comparing the scalar readouts of the proton precession magnetometer with altered polarity and directions of a constant field in the transverse directions by sequential scanning of the magnetic field \cite{alldredge1960proposed}. The second approach is applying a slow-rotating magnetic field. The three-component variometer was developed by adding a perpendicular rotating magnetic field to a scalar optically pumped potassium magnetometer. A small transverse magnetic field change can lead to oscillating components at the same rotating field frequency \cite{alexandrov2004three, vershovskii2006fast}. \textbf{Magnetic field modulation}, e.g., cross-modulation, which extracts three-axis magnetic fields by demodulating the magnetic field cross-modulation assisted by the active three-axis magnetic field compensation to keep the alkali atoms in spin-exchange relaxation-free (SERF) regime \cite{seltzer2004unshielded}. And parametric modulation, by applying a magnetic field modulation along the pump beam direction, a SERF magnetometer can measure the magnetic fields in two transverse directions simultaneously by demodulating the signal at the first and second harmonics of the modulation frequency \cite{li2006parametric}. \textbf{Extract vector information from spin projection}, such as multi-spin projections measurement, for example, applying multiple laser beams to extract vector information based on the measurement of spin projections along different laser beams \cite{fairweather1972vector, afach2015highly, bison2018sensitive, huang2015three}. Another is based on the spin alignment, nonlinear magneto-optical rotation (NMOR) magnetometers with modulated light acquire the direction information of the magnetic field based on atomic alignment, and the components at first and second harmonics of Larmor frequency of the optical anisotropy can be used for determining the tilt angle of the magnetic field from the light propagation direction. However, the power of the pump beam needs to be kept low to avoid the alignment to orientation conversion  \cite{pustelny2006nonlinear, auzinsh2009light}. \textbf{The vector magnetometry based on magneto-optical phenomenons}, such as the vector atomic magnetometers based on the Voigt effect \cite{pyragius2019voigt} and multiple electromagnetically induced transparency (EIT) resonances \cite{cox2011measurements}. Especially, all-optical vector magnetometers can be achieved by modulation of the light shift, which acts as a pseudo-magnetic field modulation \cite{patton2014all}. The other possible approach to accurate vector magnetometry \textbf{uses a microwave polarization ellipse as an absolute 3D reference} \cite{kiehl2021accurate}.

Among them, the sequential modulation and the three-component variometer can provide high absolute accuracy \cite{aleksandrov2009modern}. However, to maintain its quasi-static condition, the frequency of the rotating magnetic field has to be kept smaller than the spin relaxation rate to avoid mixing Zeeman components. Which consequently limited its performance \cite{alexandrov2004three, vershovskii2006fast}. Moreover, they are affected by the heading error caused by the rotating field: For a very slow modulation, the rotating field frequency is far smaller than the spin relaxation rate ($\omega_m \ll 1/T_2$). The slow rotating field modulation, such as the sequential modulation, can lead to a heading error effect equivalent to a residual magnetic field in the transverse directions (Please check Sec. I of the supplemental material for details).
% For instance, a $^{87}$Rb cell in a total magnetic field equals 50 $\mu$T and fully polarized ($P=1$), the dynamic heading error is expected to cause a fictitious transverse magnetic field of 7.7 nT in the transverse direction. 

Herein, we present a vector magnetometer that simultaneously measures three-axis magnetic fields. It can be achieved by simply adding a rotating magnetic field to compact scalar magnetometers based on free spin precession,  which has realized several $\mathrm{fT/Hz^{1/2}}$ gradiometer sensitivity in the earth's ambient environment with multi-pass cells \cite{limes2020portable, lucivero2021femtotesla}. The magnetometer we developed can extract three-axis vector information and does not degrade its scalar resolution. It can be developed into a very compact size using the techniques of microelectromechanical systems \cite{schwindt2004chip, liew2004microfabricated, shah2007subpicotesla, gerginov2020scalar}. Furthermore, the vector axes of our vector magnetometer are defined by the coils. It can provide a common coordinate system for all the sensors integrated with the magnetometer. The plane of the rotating field can rotate freely in three dimensions by simply changing the currents applied in three coils, which can be kept perpendicular to the leading field by feedback control.

 A free spin precession magnetometer acquires the atomic precession's free induction decay (FID) signals during the dark. Consequently, the light shift or any systematic noises corresponding to the instability of the pump beam are fully eliminated. The precession signal is analyzed by calculating the phase shifts relative to a reference signal at the Larmor frequency. This can highly reduce the dependence on the stability of the probe beam's power and wavelength and the cell's temperature. These are very good characteristics for realizing high-accuracy magnetometers with good long-term stability. Moreover, the bandwidth of the FID magnetometer can be extended beyond the Larmor precession frequency by an instantaneous phase retrieval technique \cite{wilson2020wide}. High-accuracy atomic magnetometers are essential for some applications, for example, space exploration and dark matter detection that require the magnetometers to maintain their accuracy during their mission time such as several weeks or several months \cite{anderson2007magnetometer, afach2021search, afach2018characterization}, which is more challenging than achieving a high-sensitivity atomic magnetometer, due to the requirement for additional study and eliminates the systematic errors of the atomic magnetometers. 

We studied the systematic effects of the magnetometer. Besides the conventional Berry's phase shift and the static heading error, we introduce several new systematic effects. First, we investigate the dynamic heading error caused by the rotating magnetic field. To distinguish between the conventional heading error caused by the static magnetic field \cite{oelsner2019sources,lee2021heading}, we name the conventional heading error that depends on the relative orientation of the spin polarization and static leading magnetic field as static heading error and the heading error caused by the rotating magnetic field as dynamic heading error.\footnote{We keep the well-known static heading error caused by the leading static magnetic field and define the dynamic heading error as a heading error caused by the rotating magnetic field. Therefore, the actual heading error caused by the total magnetic field equals the sum of the static and dynamic heading errors.} Based on the density matrix simulation and experimental results, the dynamic heading error can be explained by the fact that the plane of spin precession can adiabatically follow the rotation of the total magnetic field. Moreover, a probe heading error induces a fictitious magnetic field along the probe beam, and its amplitude depends on the relative orientation of the probe beam and the leading magnetic field. Lastly, there is systematically induced by the eddy current, the altering rotating field can generate an eddy current on the electrically conductive aluminum or mu-metal magnetic shield, and the eddy current generates a magnetic field. We discovered that the eddy current magnetic field highly depends on how the rotating magnetic field is switched.

The theories of these systematic effects are discussed in Sec. \ref{sec:systematics}. In Sec. \ref{sec:experiemt}, we describe the experiment and compare the experimental results with the simulation results based on the density matrix. Moreover, we present a unique modulation technique by quickly altering the rotation direction of the rotating field to cancel out all these systematic errors. The performance of the magnetometer is evaluated. Analytical fundamental limits of the vector free-spin-precession magnetometer sensitivity are proposed based on the Cramer-Rao Lower Bound (CRLB) and Minimum-Variance Unbiased (MVU) estimator. This is the first comprehensive study of the systematic effects of vector magnetometers. Compared with the approaches that use sequential modulation, the vector magnetometer we proposed is faster (higher bandwidth) and experiences less systematic effects. Yet, it has a comparable sensitivity in measuring the transverse magnetic fields compared with the vector magnetometers based on slow sequential modulation.

\section{Theory}\label{sec:Theory}

The spin evolution of the polarized alkali atoms can be described by the Bloch equation \cite{bloch1946nuclear}
\begin{equation}
  \frac{d\bm{S}}{dt} = \gamma \bm{B}\times \bm{S} +\bm{s_{p}} R_{OP} -(\bm{s_{p}} R_{OP}+\Gamma) \cdot \bm {S},
\end{equation}
where $\bm{S}$ is the electron spin vector, $\gamma$ is gyromagnetic ratio, $\bm{B}=(B_x,B_y,B_z)$ is the magnetic field vector, $\bm{s_{p}}$ is the unit vector indicates the pumping direction, $R_{OP}$ is the optical pumping rate, $\Gamma$ is the spin relaxation rate. And a rotating magnetic field with a frequency of $\omega_m$ is applied in the x-y plane,
\begin{equation}
\begin{aligned}
	B_x &= b_x + B_m \sin(\omega_m t + \phi_x),\\
	B_y &= b_y + B_m \sin(\omega_m t + \phi_y),
	\label{eq:mod_field}
	\end{aligned}
\end{equation}
where $b_x$, $b_y$ are the residual magnetic fields in the x and y direction, respectively. $B_m$ is the amplitude of the rotating field. $\omega_m$ is the frequency of the rotating magnetic field. $\phi_x$ and $\phi_y$ are the phases of the rotating magnetic field in the x and y directions, and  $|\phi_x-\phi_y|=90^\circ$ to keep the modulation magnetic field as a rotating magnetic field.

\subsection{Vector Magnetometry}

If there are residual magnetic fields in the x and y direction, and a rotating magnetic field is applied in the x-y plane with $\phi_x=90^{\circ}$, $\phi_y=0^{\circ}$, the precession frequency of the total magnetic field can be written as
\begin{equation}
	\begin{aligned}
	&\gamma [B_z^2+(b_x+B_m\cos\omega_m t)^2 +(b_y+B_m\sin\omega_m t)^2]^{1/2}\\
	&\approx \gamma \sqrt{B_m^2+B_z^2}+\frac{\gamma B_m b_x}{\sqrt{B_m^2+B_z^2}}\cos\omega_m t\\
	&+\frac{\gamma B_m b_y}{\sqrt{B_m^2+B_z^2}}\sin\omega_m t.
	\end{aligned}
	\label{eq:field_expension}
\end{equation}
We choose $\omega_0= \gamma \sqrt{B_m^2+B_z^2}$ as the reference frequency. Because $\omega_r \gg \omega_m$, and the integral of Eq. \ref{eq:field_expension} is subtracted from $\omega_0 t$, we can get the phase shift relative to $\omega_0$ caused by the transverse magnetic fields in the unit of time as
\begin{equation}
    \tau_m = \frac{B_m}{\omega_m (B_m^2+B_z^2)}(-b_x \sin\omega_m t + b_y\cos\omega_m t).
    \label{eq:phi_m}
\end{equation}
The residual magnetic fields in x-direction $b_x$ and y-direction $b_y$ are proportional to the amplitudes of the first harmonic $\sin \omega_m t$ and $\cos \omega_m t$, respectively. And the scale factor equals $B_m/[\omega_m (B_m^2+B_z^2)]$.

\subsection{Systematic Effects}\label{sec:systematics}
It is complicated to get analytical solutions to the time-dependent Bloch equation. Instead, we use rotation matrices to evaluate spin evolution. When $b_x$, $b_y$ are all zero, and we assume the spins are fully polarized along minus y-axis initially, and $\phi_x=90^{\circ}$, $\phi_y=0^{\circ}$, the spin evolution can be written as
\begin{equation}
\begin{aligned}
	\bm{P}(t) = & RM[-\omega_m t, ~(0, 0, 1))] \cdot \\
	&RM[-\gamma t \sqrt{B_m^2 + (B_z + \omega_m/\gamma)^2}, ~(B_m, 0, B_z))] \cdot \\
	& (0, -1, 0),
\label{eq:rm}
\end{aligned}
\end{equation}
where $RM[\phi,~\nu]$ is a 3D rotation matrix for a counterclockwise $\phi$-degree rotation around the 3D vector $\nu$. Eventually, the spin projections in three axes can be written as
\begin{equation}
\begin{aligned}
% \begin{flalign}
& P_x(t) = (1,0,0) \cdot \bm{P}(t) =\\
&\cos \omega_0 t \sin \omega_m t-\frac{(\gamma B_z+\omega_m)}{\omega_0} \sin\omega_0t \cos \omega_m t ,
% \end{flalign}
\label{eq:sx}
\end{aligned}
\end{equation}

\begin{equation}
\begin{aligned}
&P_y(t) = (0,1,0) \cdot \bm{P}(t) =\\
&-\cos \omega_0 t \cos \omega_m t- \frac{(\gamma B_z+\omega_m)}{\omega_0} \sin \omega_0t \sin \omega_m t,
\label{eq:sy}
\end{aligned}
\end{equation}

\begin{equation}
\begin{aligned}
P_z(t) = (0,0,1) \cdot \bm{P}(t) = \frac{\gamma B_m }{\omega_0}\sin \omega_0 t,
\label{eq:sz}
\end{aligned}
\end{equation}
where $\omega_0 = \gamma \sqrt{B_m^2+(B_z+\omega_m/\gamma)^2}$. When $\omega_m \ll \omega_0$, $\omega_0 \approx \gamma \sqrt{B_m^2+B_z^2}$. When $\omega_m$ is large enough, a small correction of the scale factor of the magnetometer needs to be taken into account. The scale factor equals $B_m/\{\omega_m[B_m^2+(B_z \pm \omega_m/\gamma)^2]\}$, and $\pm$ depends on the rotation direction of the rotating field. 


\subsubsection{Berry's phase shift and Second harmonic phase shift}\label{berry}

By analyzing the phase shifts of Eq. \ref{eq:sx}, we can get two phase-shift terms contributed from $B_m$. One is Berry's phase shift, which can be written in the unit of time as
\begin{equation}
	\tau_{B}=\frac{B_m^2 \omega_m t}{2 B_z^2 \omega_0} \approx (1-\cos\theta)\frac{\omega_m t}{\omega_0},
	\label{eq:berry}
\end{equation}
where $\theta \approx B_m/B_z$ is the angle between the total magnetic field and z-axis as shown in Fig. \ref{fig:setup}. The Eq. \ref{eq:berry} is consistent with Berry's phase shift described in Ref. \cite{suter1987berry}.

Another phase shift from Eq. \ref{eq:sy} is proportional to $\sin(2\omega_m t)$, which can be written in the unit of time as 
\begin{equation}
	\tau_{2nd} \approx -\frac{B_m^2}{4B_z^2 \omega_0} \sin(2 \omega_m t).
	\label{eq:2nd_harm}
\end{equation}
This term leads to a non-zero second harmonic fitting result even if there is no residual magnetic field and the rotating field is perfectly symmetric in the x-y plane. The amplitude of this term in the unit of time equals $-B_m^2/(4B_z^2\omega_0)$.


\subsubsection{Pump beam heading error}
There is a static heading error effect, and the fictitious magnetic field caused by the static heading error can be written as \cite{lee2021heading}
\begin{equation}
	B_{SH} \approx B_{HM} \sin \beta,
	\label{eq:B_SHE}
\end{equation}
where $B_{HM}$ is the maximum static heading error,
\begin{equation}
B_{HM} = \frac{P(7+P^2)}{5+3P^2} \frac{3 h \gamma B_{tot}^2}{4 \pi A_{hf}},
\end{equation}
where $P$ is spin polarization, $A_{hf} = h \cdot 3.417$ GHz is the hyperfine structure constant for ground state \cite{bize1999high}, $h$ is Planck constant, $\beta$ is the angle of the pump beam relative to the field. The spin projection along the total magnetic field determines the static heading error.

Besides the conventional static heading error, the rotating magnetic field we applied may induce a dynamic heading error. When $1/T_2<\omega_m \ll \omega_0$, the precession plane of the spin projection $\bm{S_{\perp}}$ and the spin projection $\bm{S_{\parallel}}$ along the total magnetic field $\bm{B_{tot}}$ can adiabatically follow the rotation of the total magnetic field $\bm{B_{tot}}$. To understand the dynamic heading error, we separate the initial spin polarization into two parts as shown in Fig. \ref{fig:non-adiabatic_DH}: one is the spin projection ($\bm{S_{\parallel}}$) that is along the total magnetic field after the pump, another is the spin projection ($\bm{S_{\perp}}$) that is perpendicular to the total magnetic field. The previous one results in a constant heading error proportional to the initial spin polarization along the total magnetic field. The latter one results in a zero dynamic heading error because its precession plane is always perpendicular to the total magnetic field.  The experimental results are discussed in detail in Sec. \ref{sec:experiemt}. The density matrix model can well describe an ensemble of spins in a mixed state \cite{walker1997spin}. The density matrix model and simulation results are demonstrated in the Secs. II and V of the supplemental material. The dynamic heading error is determined by $\bm{S_{\perp}}$, and it can be eliminated by choosing the right starting phases of the rotating field that keep $\bm{S_{\perp}}=0$ initially.
\begin{figure}[H]
\centering
\includegraphics[width=0.3\textwidth]{non-adiabatic_DH.pdf}
\caption{If $\bm{B_m}$ is initially along $\bm{S}$, then $\bm{S}$ has a nonzero spin projection $\bm{S_{\parallel}}$ along  $\bm{B_{tot}}$. $\bm{S_{\parallel}}$ is ``locked” to $\bm{B_{tot}}$ and adiabatically follows the rotation of $\bm{B_{tot}}$. Consequently, the spin projection along $\bm{B_{tot}}$ is a constant, which induced a dynamic heading error that equals $B_{HM} \sin \theta$. If there is no spin projection along the total magnetic field right after spin polarization: $\bm{B_m}$ is perpendicular to $\bm{S}$ right after the pumping pulses. There is no spin project from $\bm{S}$ to $\bm{B_{tot}}$. the precession plane of the $\bm{S_{\perp}}$ or $\bm{S}$ adiabatically follows $\bm{B_{tot}}$ and keeps perpendicular to $\bm{B_{tot}}$, there will be no spin projection along $\bm{B_{tot}}$. Consequently, there is no dynamic heading error in this case.}
\label{fig:non-adiabatic_DH}
\end{figure}


\subsubsection{Probe beam heading error}
Assuming the atoms are pumped along the y direction, the sensor rotates in the x-z plane about the y-axis. We define the angle between the probe beam and the x-axis as $\alpha$ as shown in Fig. \ref{fig:setup}. The spin projection along the probe beam can be written as $P_{prob}(t) = P_x(t) \cos \alpha + P_z(t) \sin \alpha$. Inserting the Eqs. \ref{eq:sx} and \ref{eq:sz}, and analyze the first harmonic phase shift that depends on $\alpha$, we can get the phase shift caused by the probe beam heading error in the unit of time
\begin{equation}
	\tau_{prob}\approx -\frac{B_m}{B_z \omega_0}\tan \alpha \cdot \sin \omega_m t.
	\label{eq:tau_prob}
\end{equation}
Dividing Eq. \ref{eq:tau_prob} by the scale factor and converting it into a magnetic field unit. It is equivalent to a fictitious magnetic field $\omega_m /\gamma \cdot \tan \alpha $ along the probe beam direction. To be noted here, the probe beam heading error is not caused by the probe beam pumping effect \cite{fang2014situ}. We named it a probe beam heading error because it induces a fictitious magnetic field that depends on the relative angle between the probe beam and $\bm{B_z}$, which is analogous to the pump beam heading error.

As shown in Table \ref{table:trans_sign}, the sign of probe heading error depends on the rotation direction. Based on the four-shot scheme which is introduced in Sec. \ref{sec:experiemt}, we can easily calculate $\alpha$ by comparing the difference of the fitting amplitudes of $\sin \omega_m t$ of different directions of the rotating field. It can help to determine the plane of the rotating magnetic field which is perpendicular to $\bm{B_z}$. 

\begin{table}[]
\begin{tabular}{|c|c|c|c|c|c|c|c|c|}
\hline
\textbf{Shot No.} &
  \textbf{$\phi_x$} &
  \textbf{$\phi_y$} &
  \textbf{$b_x$} &
  \textbf{$b_y$} &
  \textbf{$\tau_B$} &
  \textbf{$\tau_{2nd}$} &
  \textbf{$\tau_{pump}$} &
  \textbf{$\tau_{prob}$} \\ \hline
1 & 90$^{\circ}$  & 0$^{\circ}$   & - & + & + & - & - & - \\ \hline
2 & 90$^{\circ}$  & 180$^{\circ}$ & - & - & - & + & - & + \\ \hline
3 & 270$^{\circ}$ & 180$^{\circ}$ & + & - & + & - & + & - \\ \hline
4 & 270$^{\circ}$ & 360$^{\circ}$ & + & + & - & + & + & + \\ \hline
\end{tabular}
\caption{The signs of the parameters as a function of the phases of the rotating magnetic field.}
\label{table:trans_sign}
\end{table}

\subsubsection{Eddy current}
The fast-altering rotating magnetic field can generate eddy current on the electrically conductive magnetic shield. Consequently, eddy current magnetic fields are generated. As shown in Fig. \ref{fig:signal}, in our 4-shot scheme, the direction of each modulation magnetic field alters twice per 4 shots. We discovered how the rotating magnetic field is altered can affect the eddy current magnetic field, which is when the direction alteration of the rotating field happens at the peak values of the rotating magnetic field, which is from negative maximum to positive maximum and vice versa, we named this as ``cosine switch'', the average magnetic field caused by the eddy current equals zero. However, if the direction alteration of the rotating field happens at zero rotating magnetic field, we name it as ``sine switch''  would lead to a big magnetic field caused by the eddy current. 

We specifically developed a waveform as shown in Fig. \ref{fig:signal} to ensure the rotation direction alteration always happens at the peak values of the adjacent rotating magnetic field (cosine switch). We can mostly eliminate the systematic effect caused by the eddy current. The experimental results are shown in Sec. \ref{sec:experiemt}. The eddy current effect is analogous to a first-order low-pass filter, and the cut-off frequency can be calculated by the time constant we measured. We measure the eddy current time constant by the accurate vector magnetometer we developed. 

We list the signs of the parameters as a function of the phases of the rotating magnetic field in Table \ref{table:trans_sign}. The signs of the parameters above are based on the rotating field with phases $\phi_x=90^{\circ}$, $\phi_y=0^{\circ}$. This is an essential characteristic of these systematic effects, based on which we can finally cancel out them by fast altering the direction of the rotating field. 

\section{Experiments and Results}\label{sec:experiemt}
An alkali vapor cell is placed in the center of a magnetic shield, a cubic cell of a 5 mm$\times$5 mm$\times$5 mm internal dimensions. It contains a droplet of $^{87}$Rb, 688 Torr N$_2$ as quenching gas and buffer gas. The magnetic shield consists of a two-layers mu-metal magnetic shield and an innermost-layer aluminum shield for attenuating the DC and AC magnetic fields from the environment. The alkali cell is pumped by a sequence of pump pulses from a grating-stabilized diode laser. A set of three coils inside the magnetic shield provide a rotating magnetic field and a leading magnetic field. The cell is heated by an electric heater driven by AC at a frequency of 131.5 kHz, the AC heater is turned on during the pump time and is turned off during the measurement time to reduce the magnetic noise from the heater.

 \begin{figure*}[!hbt]
 \centering
    \includegraphics[width=.75\textwidth]{experimental_setup_3d.pdf}
    \caption{The experimental setup. These three coils define the x, y, and z axes. The sensor head is mounted on a rotation stage. The cell is put on the rotation center of the stage. The sensor head can freely rotate in the x-z plane, and we define the angle between the symmetric centerline of the sensor head and the z-axis as $\alpha$. To investigate the heading error caused by the probe beam, the sensor head is rotated 90$^{\circ}$ as shown in the figure, then the atoms are pumped along the x direction and are probed along the y direction. We define the angle between the centerline of the sensor head and the z-axis as $\beta$. $\theta$ is the angle between the total field and the z-axis. WP stands for Wollaston prism, and Q-PD stands for quadrant photodiode.}
    \label{fig:setup}	
 \end{figure*}
 
To achieve three-axis magnetic field measurement, a rotating magnetic field with an amplitude of approximately 18 $\mathrm{\mu T}$ is applied in the transverse plane (x-y plane), a leading magnetic field $B_z$ is applied along the longitudinal direction (z-axis). The amplitude of the total applied magnetic field is kept to approximately 50 $\mathrm{\mu T}$ to simulate the earth field. The frequency of the pump beam pulse is set to 348 kHz, which is in sync with the Larmor frequency to achieve the highest pumping rate. The duty cycle of a pump beam pulse is approximately 1.4\%. The pump beam is turned off after the pump time, the FID signal of the spin precession is measured by a linearly polarized probe beam which originates from a vertical cavity surface emitting laser (VCSEL), and the optical rotation of the linearly polarized probe beam is measured by a balanced polarimeter consisting of a Wollaston prism and a quadrant photodiode. The signal from the photodiode goes through a differential low-noise amplifier (Thorlabs SR560) and a high-pass filter. The phase shift of the signal relative to the Larmor frequency is analyzed by the HP 53310A modulation domain analyzer (MDA). The MDA detects the zero-crossings of the precession signal and the reference signal. The phase shifts between the zero crossings of the precession signal and reference signal are calculated. The threshold voltage of the MDA needs to be well-tuned. Otherwise, it will curl the measured phase shift signal. Consequently, it will affect the fitting result and lead to a systematic error.

The measured phase shifts from the MDA are further fitted to a model which includes the following terms: offset, slope, amplitudes of the first harmonics, second harmonics of $\omega_m$ and amplitudes of the first harmonics of $\omega_{hp}$. The second harmonic of the $\omega_m$ is also included in the fitting model because either the second harmonic phase shift described in Eq. \ref{eq:2nd_harm} in Sec. \ref{berry} or the asymmetries of the rotating field in amplitude or phase, can lead to a signal at a frequency of 2$\omega_m$. The Zeeman frequencies are split due to the nuclear magnetic moment. The hyperfine Land$\acute{e}$ g-factor can be written as \cite{auzinsh2010optically}
\begin{equation}
\begin{aligned}
	g_F= &g_S\frac{F(F+1)-I(I+1)+S(S+1)}{2F(F+1)}\\
	& -g_I \frac{F(F+1)+I(I+1)-S(S+1)}{2F(F+1)}.
\end{aligned}
\end{equation}
If the alkali atoms are in the earth field (50 $\mathrm{\mu T}$), the term with nuclear Land$\acute{e}$ g-factor $g_I$ cannot be ignored. In the ground state, $F=1$ the gyromagnetic ratio $\gamma_{F=1}=-6.9778$ Hz/nT, $F=2$ the gyromagnetic ratio $\gamma_{F=2}=7.0056$ Hz/nT. Consequently, the atoms in these ground states precess oppositely and their precession frequencies have a difference of approximately $\omega_{hp} =2\pi \times 1.39$ kHz at the earth field. As shown in Fig. \ref{fig:whf}, this frequency is measured when the atoms are not fully polarized and no rotating magnetic field is applied, which the density matrix simulation can describe well.

\begin{figure}
\includegraphics[width=0.45 \textwidth]{whf.pdf}
\caption{The pump beam power is reduced to reduce the spin polarization. The rotating field is turned off. The difference in the precession frequency for the F=1 and F=2 atoms induced an exponentially decaying sinusoidal phase shift at a frequency of $\omega_{hp} = 2 \pi \times 1.39$ kHz.}
\label{fig:whf}	
\end{figure}

 
As shown in Table \ref{table:trans_sign}, the sign of Berry’s phase shift is determined by the rotation direction of the rotating field. In a shot where a modulation magnetic field $B_m\cos \omega_m t$ is applied in the x-axis, a modulation magnetic field $B_m\sin \omega_m t$ is applied in the y-axis, which corresponds to $\phi_x = 90^\circ$ and $\phi_y = 0^\circ$ in Eq. \ref{eq:mod_field}, the magnetic field rotates anti-clockwise. In the next shot, the phases are changed to $\phi_x = 90^\circ$ and $\phi_y = 180^\circ$, the magnetic field rotates clockwise. Eventually, the rotating magnetic field rotates in opposite directions for the first and second shots. The Berry’s phase shifts of the first and second shots had equivalent amplitudes but with opposite signs, which can be canceled out by averaging the fitting slopes of the first and second shots. The sign of the dynamic heading error due to the effect of non-zero spin projection along the total magnetic field depends on the starting sign of the rotating field. To cancel out this heading error, we add two extra shots with opposite start signs whose start phases are $\phi_x = 270^\circ$, $\phi_y = 180^\circ$ and $\phi_x = 270^\circ$, $\phi_y = 0^\circ$; moreover, these extra two shots can help to cancel out the systematic error caused by the threshold voltage of the MDA. Finally, as shown in Fig. \ref{fig:rotating_field}, the rotating field $\bm{B_m}$ in the x-y plane has different rotate directions and start signs in these four shots.

\begin{figure}
     \centering
     \includegraphics[width=0.4 \textwidth]{rotating_field.pdf}
     \caption{The phases for of four shots are ($\phi_x = 90^\circ$, $\phi_y = 0^\circ$), ($\phi_x = 90^\circ$, $\phi_y = 180^\circ$), ($\phi_x = 270^\circ$, $\phi_y = 180^\circ$) and ($\phi_x = 270^\circ$, $\phi_y = 0^\circ$), respectively. For the shot I and II, $\bm{B_m}=\left[b_m\sin(\omega_m t + \phi_x),~b_m\sin(\omega_m t + \phi_y),~0\right]$ is along positive x-direction at the beginning of the measurement time, the field rotates along anti-clockwise in the shot I, the field rotates clockwise in shot II. For shot III and IV, $\bm{B_m}$ is along the negative x-direction at the beginning of the measurement time; the field rotates anti-clockwise in shot III, and the field rotates clockwise in shot IV. }
     \label{fig:rotating_field}
 \end{figure}
 
 We define these four shots in a sequence as one block. The HP 53310A can acquire 80 shots (20 blocks) in one panorama measurement. One block measurement with four shots is shown in Fig. \ref{fig:signal}, and the order of the rotating field of four shots correspond to the order of the four shots shown in Fig. \ref{fig:rotating_field}. The alkali atoms are pumped and heated when the trigger signal is high. The pump beam and the AC heater are turned off when the trigger signal goes low, and the FID signals of the spin precession are acquired. The MDA analyzes the phase shift relative to the reference signal at the Larmor frequency.
 \begin{figure*}[!hbt]
 \centering
    \includegraphics[width=0.85 \textwidth]{signal.pdf}
    \caption{There are four shots of different start phases of $B_x$ and $B_y$ at the beginning of each measurement time. This four-shot scheme is specifically developed to cancel out the systematic effects, such as Berry’s phase shift, dynamic heading error, probe beam heading error, eddy current, and the systematic caused by the threshold voltage of the MDA. The magnetic field only flips during the peak values to suppress the eddy current caused by the rotating field (``cosine switch''). The quadrant photodiode acquires the precession signals, the signals are deferentially amplified by a low-noise amplifier (Thorlabs SR560), and the signals during the preparation time are blanked out. A first-order high-pass filter further filters the signals with a cutoff frequency of 150 kHz before entering the MDA.}
    \label{fig:signal}
 \end{figure*}

 According to Eq. \ref{eq:phi_m}, the $b_x$ and $b_y$ can be measured by fitting the first harmonic of $\omega_m$, $b_x$ and $b_y$ are proportional to the fitting amplitudes of $\sin \omega_m t$ and $\cos \omega_m t$, respectively. The signs of the fitting result for $b_x$ and $b_y$ are shown in Table \ref{table:trans_sign}, which needs to be considered when averaging the fitting results of the four shots to get the transverse residual magnetic fields. 

For instance, when a magnetic field of -87 nT is applied in the y-direction, the frequency of the rotating field $\omega_m= 2 \pi \times$480 Hz. the output from the MDA for one block data is shown in the upper plot of the Fig. \ref{fig:trans_signal}. The phase shift mainly oscillates at a frequency of $\omega_m$.
\begin{figure}[H]
\centering
	\includegraphics[width=0.45 \textwidth]{run1600_by.pdf}
	\caption{One block data acquired by the MDA. $\textbf{Upper:}$ when a magnetic field of -87 nT is applied in the y-direction, one block phase shifts acquired by the MDA as a function of time. $\textbf{Lower:}$  when the magnetic fields in the x and y directions are roughly compensated. The second harmonic signal can be clearly observed.}
	\label{fig:trans_signal}
\end{figure}
When the magnetic field offsets in the transverse directions are roughly compensated, the phase shifts are as shown in the lower plot of Fig. \ref{fig:trans_signal}, and the second harmonic signal becomes significant. It is caused by the effect that is described in Sec. \ref{berry}. Furthermore, the asymmetry of the rotating magnetic field can also induce second harmonic signals. By comparing the fitting result of $\sin 2 \omega_m t$ of the first shot and the second shot and removing the common systematic of the second harmonic caused by the asymmetry of the rotating field, we can get the amplitude of $\sin 2 \omega_m t$ caused by the systematic $\tau_{2nd}$, the experimental results equals approximately 16 ns. For comparison. the prediction based on Eq. \ref{eq:2nd_harm}, $\tau_{2nd}=16$ ns .

As shown in Table \ref{table:slope}, the slope of the fitting result includes contributions from four effects. They are small magnetic field deviation $\delta b_z$ between the reference frequency and $B_z$, $\delta b_z=B_z - \omega_0/\gamma$, static heading error ($B_{SH}$), Berry's phase shift ($B_{Berry}$) and dynamic heading error ($B_{DH}$). $\delta b_z$ and $B_{SH}$ can be calculated by averaging four shots, and $\delta b_z$ and $B_{SH}$ can be distinguished by reversing the pumping direction. Alternatively, $B_{SH}$ can be estimated based on the title angle calculated by the measured transverse magnetic field and the total magnetic field. Eventually, $\delta b_z$ can be distinguished and measured. $B_{Berry}$ can be calculated by averaging the results of four shots multiplied by +1, -1, +1, and -1, respectively. $B_{DH}$ can be calculated by averaging the result of four shots multiplied by +1, +1, -1, and -1, respectively.
\begin{table}[]
\centering
\begin{tabular}{|c|c|c|c|}
\hline
\textbf{Shot No.} & \textbf{$\phi_x$} & \textbf{$\phi_y$} & \textbf{$\mathrm{Slope ~(nT)}$} \\ \hline
1 & 90$^{\circ}$ & 0$^{\circ}$ & $(\delta b_z +B_{SH}) + B_{Berry}+B_{DH}$ \\ \hline
2 & 90$^{\circ}$ & 180$^{\circ}$ & $(\delta b_z +B_{SH}) - B_{Berry}+B_{DH} $ \\ \hline
3 & 270$^{\circ}$ & 180$^{\circ}$ & $(\delta b_z +B_{SH}) + B_{Berry}-B_{DH} $ \\ \hline
4 & 270$^{\circ}$ & 360$^{\circ}$ & $(\delta b_z +B_{SH}) - B_{Berry}-B_{DH} $ \\ \hline
\end{tabular}
\caption{The composition of the slope of the fitting result, and their sign dependence on the phases of the rotating field. }
\label{table:slope}
\end{table}



\subsection{Dynamic Heading Error}

%If the dynamic heading error behaves analogously as the static heading error, we expect to see a fictitious magnetic field offset 7.7 nT in the x direction caused by the heading error. However, as shown in Table \ref{table:heading_error}, the measurement result and density matrix simulation both indicate that the heading error for $B_x$ and $B_y$ are close to zero.

To study the heading error, the sensor is rotated 90$^{\circ}$ anti-clockwise about the z-axis as shown in Fig.\ref{fig:setup}, and the atoms are polarized along the x-direction and probed along the y-direction. The experimental results and the density matrix simulation results as shown in Table. \ref{table:bz_HE}, when the rotating field (RF) initially starts along $\bm{S}$ (RF starts $\parallel~\bm{S}$), there is a dynamic heading error of 2.6 nT, which is caused by the spin projection along the total magnetic field and its adiabatic follow of the total magnetic field rotation. If the rotating field starts from the opposite sign, the dynamic heading error becomes -2.6 nT. When the rotating field initially starts perpendicularly to $\bm{S}$ (RF starts $\perp~\bm{S}$), the dynamic heading error is 0, which is because the spin polarization is perpendicular to the total magnetic field initially. The spin precession plane can adiabatically follow the rotation of the total magnetic field and be perpendicular to it. The average of over four shots can cancel out the dynamic heading error. The experimental results of the dynamic heading error and static heading error are smaller than the density matrix simulation because the actual polarization of the spins is approx. 22\% smaller than the simulation, which is near 100\% polarization. For more data with different $\beta$, please check the Sec. V of the supplemental material. The summary of the experimental results and the theoretical predictions related to $B_{tot}$ based on the density matrix are shown in Table \ref{table:heading_error}.

\begin{table}
\centering
\begin{tabular}{|c|c|c|c|c|}
\hline
\multicolumn{1}{|c|}{$B_{tot}$} & \multicolumn{2}{c|}{RF starts $\parallel~\bm{S}$} & \multicolumn{2}{c|}{RF starts $\perp~\bm{S}$} \\ \hline
\textbf{Shot No.} & Exp (nT) & DM (nT) & Exp (nT) & DM (nT) \\ \hline
1 & 2.6 & 3.0 & 0.1 & 0.0 \\ \hline
2 & 2.6 & 3.0 & 0.4 & 0.0 \\ \hline
3 & -2.6 & -3.0 & -0.1 & 0.0 \\ \hline
4 & -2.6 & -3.0 & -0.4 & 0.0 \\ \hline
\textbf{Average} & \textbf{0.0} & \textbf{0.0} & \textbf{0.0} & \textbf{0.0} \\ \hline
\end{tabular}
\caption{Measured dynamic heading error along the total magnetic field with $\beta \approx 0 ^{\circ}$. ``Exp'' is the experimental data, ``DM'' is the density matrix simulation result.}
\label{table:bz_HE}
\end{table}

\begin{table}[]
\begin{tabular}{|c|c|c|}
\hline
                                & Measured & Predicted \\ \hline
Dynamic heading error for $B_{tot}$ ($\theta \approx 21^{\circ}$) & 2.6 nT   & 3.0 nT    \\ \hline
Berry’s phase for $B_z{tot}$         & 5.1 nT   & 4.7 nT    \\ \hline
Average over 4 shots            & 0.0 nT   & 0.0 nT    \\ \hline
Static heading error for $B_{tot}$ ($|\beta| \approx 24^{\circ}$)  & 2.7 nT  & 3.1 nT    \\ \hline
Amplitude of $\sin 2 \omega_m t$ & 16 ns   & 16 ns   \\ \hline
\end{tabular}
\caption{The measurement results and the predictions are based on the density matrix simulation.}
\label{table:heading_error}
\end{table}

We also evaluate the dynamic heading error effect in the transverse directions. Due to the fast altering of the rotating field in the four-shot scheme, the eddy current produces a magnetic field. It is discussed in Sec. \ref{sec:exp_eddy_current}. To eliminate the eddy current effect, the rotating magnetic field is not switched and is kept the same for one panorama measurement of MDA. The eddy current caused by magnetic switching at the first shot decays out after approx. 60 ms, we average the shots by dumping the beginning 8 shots (approx. 66.7 ms). In the following panorama measurement, the phases of the rotating field are then changed to other phases in the order as shown in Table \ref{table:trans_sign} and repeat the measurements until we get the results for all the phases of the 4 shots. As shown in Table \ref{table:bx_HE}, no matter whether the rotating field starts parallelly or perpendicularly to $\bm{S}$, the dynamic heading error effect is close to zero in the x-direction. These small magnetic fields variation can be caused by the systematic from the mismatching threshold voltage of the MDA. 

\begin{table}
\centering
\begin{tabular}{|c|c|c|c|c|}
\hline
$B_x$ & \multicolumn{2}{c|}{RF starts $\parallel~\bm{S}$} & \multicolumn{2}{c|}{RF starts $\perp~\bm{S}$} \\ \hline
\textbf{Shot No.} & Exp (nT) & DM (nT) & Exp (nT) & DM (nT) \\ \hline
1 & -0.1 & 0.1 & -0.1 & 0.0 \\ \hline
2 & 0.5 & 0.1 & 0.1 & 0.0 \\ \hline
3 & 0.1 & -0.1 & 0.1 & 0.0 \\ \hline
4 & -0.2 & -0.1 & 0.2 & 0.0 \\ \hline
\textbf{Average} & \textbf{0.1} & \textbf{0.1} & \textbf{0.1} & \textbf{0.0} \\ \hline
\end{tabular}
\caption{The dynamic heading error in $B_x$.}
\label{table:bx_HE}
\end{table}

The experimental and simulation results of $B_y$ are shown in Table \ref{table:by_HE}. The measured magnetic fields are slightly bigger than the x-direction because there is one more systematic along the y-direction (now it is probe beam direction), which is the probe beam heading error. If the sensor has a misalignment that causes $\alpha = 1^{\circ}$, it leads to approximately 1.2 nT probe beam heading error in the y-direction. There are more data in the Sec. V of the supplemental material shows that these magnetic field offsets do not change their signs when the polarization direction is reversed. This proves that the dynamic heading error does not cause them.

\begin{table}
\centering
\begin{tabular}{|c|c|c|c|c|}
\hline
$B_y$ & \multicolumn{2}{c|}{RF starts $\parallel~\bm{S}$} & \multicolumn{2}{c|}{RF starts $\perp~\bm{S}$} \\ \hline
\textbf{Shot No.} & Exp (nT) & DM (nT) & Exp (nT) & DM (nT) \\ \hline
1 & -1.5 & -0.1 & -0.8 & 0.0 \\ \hline
2 & 0.4 & 0.1 & 0.8 & 0.0 \\ \hline
3 & -0.3 & -0.1 & -1.0 & 0.0 \\ \hline
4 & 1.6 & 0.0 & 1.3 & 0.0 \\ \hline
\textbf{Average} & \textbf{0.0} & \textbf{0.0} & \textbf{0.1} & \textbf{0.0} \\ \hline
\end{tabular}
\caption{The dynamic heading error in $B_y$.}
\label{table:by_HE}
\end{table}

Overall, the rotating magnetic field can induce dynamic heading error in the total magnetic field measurement. The dynamic heading error can be eliminated by either choosing the right starting phases for the rotating field that starts the rotating field initially at the direction that is perpendicular to the spin polarization or averaging the results of four shots. The dynamic heading error does not contribute to the transverse magnetic fields no matter what the starting phases of the rotating field are.

\subsection{Eddy Current}\label{sec:exp_eddy_current}

In our four-shot scheme that alters the rotation direction, there are two switches in four-shots as shown in Fig. \ref{fig:signal}, for $B_y$, the switch happens during the preparing time of the second shot, another switch happens during the preparing time of the fourth shot.

For $B_y$, the second and fourth shots have the maximum eddy current, and the first and third shots have smaller eddy currents because they measure the decaying eddy current generated during the fourth and second shots. The sign of the magnetic field caused by the eddy current depends on the rotation direction of the rotating field. The eddy current magnetic field generated during the second shot has a negative sign, and the eddy current magnetic field generated during the fourth shot has a positive sign. The eddy current magnetic field measured during the first shot is the decaying eddy current magnetic field generated during the fourth shot, so the first and the fourth shot have the same sign. In the same way, the second shot and the third shot has the same sign.  One panorama (80 shots) measurement result from the MDA is shown in Fig. \ref{fig:sine_cosine_switch}. The sine switch can cause an eddy current magnetic field of approx. 450 nT and the cosine switch can highly suppress the systematic of the eddy current. The small eddy current magnetic field in the ``Cosine switch'' is due to the imperfection of the cosine switch. The instruments have a certain rising time for a sudden signal transition.

\begin{figure}
\centering
\includegraphics[width=0.45 \textwidth]{20210415_sine_cosine_switch.pdf}
\caption{The magnetic field in transverse direction caused by the eddy current. The magnetic fields measured by both the Sine and Cosine switches are subtracted by 16.6 nT to remove the residual magnetic field. }
\label{fig:sine_cosine_switch}	
\end{figure}

The time constant of the eddy current is measured by applying a continuous rotating magnetic field with a constant phase during one panorama measurement.  As shown in Fig. \ref{fig:eddy_time_constant}, there are 79 data points representing 79 shot measurements. The first shot is dumped because it is too big that it overloads the phase shift range of the MDA. For each shot, it takes 1/120 s. The 60 Hz line frequency causes periodic variations in the magnified picture and its harmonics, it can be averaged out by one panorama measurement. We measured the time constant of the eddy current effect for our setup, approximately 10.4 ms, and the corresponding cut-off frequency is 15 Hz.

\begin{figure}
\centering
	\includegraphics[width=0.45 \textwidth]{eddy_by3}
	\caption{The measurement of the eddy current time constant.}
	\label{fig:eddy_time_constant}
\end{figure}

\subsection{Probe Beam Heading Error}

The probe beam heading error can be described by Eq. \ref{eq:tau_prob}, and its sign dependence on the $\phi_x$ and $\phi_y$ is shown in Table \ref{table:trans_sign}.  The measured probe heading error when  $\omega_m =2 \pi \times480$ Hz is shown in Fig. \ref{fig:Probe_HE}.  The sensor rotates about the pump beam axis, the angle $\alpha$ equals the angle between the probe beam and the $B_z$ minus 90$^{\circ}$. The theory is based on Eq. \ref{eq:tau_prob}.  Theory 1 is for anti-clockwise rotations (Shot 1 and Shot 3), which is $-\omega_m /\gamma \cdot \tan \alpha$. Theory 2 is for clockwise rotations (Shots 2 and 4), which is $\omega_m /\gamma \cdot \tan \alpha$. The probe beam heading error can be canceled out by averaging two opposite rotating field measurements.
\begin{figure}
\centering
\includegraphics[width=0.45 \textwidth]{20210412b_PHE.pdf}
\caption{The measurement of the probe beam heading error. The solid points are experimental results, and the dashed lines are the theoretic plots based on our proposed model.}
\label{fig:Probe_HE}
\end{figure}

\subsection{Performance}
The magnetic field calibration is shown in Fig. \ref{fig:sweep_mag}. The transverse residual magnetic fields are measured by the fitting amplitudes of the first harmonic of $\omega_m$. To evaluate the accuracy of the transverse magnetic field, the magnetic field in the y-axis is swept from -52 nT to 52 nT. The calibrated scale factor is 2.55 ns/nT, and the theoretical scale factor is given by $B_m/[\omega_m (B_m^2+B_z^2)]=2.53$ ns/nT, where $B_m \approx 19~\mu$T. There are 20 blocks of data in one panorama measurement of the MDA, and the panorama measurement of each magnetic field is repeated twice by sweeping the magnetic field back and forth.

\begin{figure}[H]
\centering
	\includegraphics[width=0.45 \textwidth]{run1600_sf_fit.pdf}
	\caption{The linear phase shift signal response to magnetic field sweep. Each magnetic field has 40 phase shift data points overlap. Because the experiment was repeated twice by sweeping the magnetic field back and forth, and each panorama had 20 blocks of data.}
	\label{fig:sweep_mag}
\end{figure}

The amplitude and the frequency of the rotating field are two key parameters of the rotating field. The dependences of the magnetic field measurement results on these two parameters are evaluated. The amplitude of the rotating field is swept from 9 $\mu$T to 22 $\mu$T, the measured $B_x$ and $B_y$ only decrease by 0.5 nT, which is shown in Fig. \ref{fig:bxy_swep_amp}. The rotating field frequency is swept from 480 Hz to 1440 Hz, and the measured $B_x$ and $B_y$ decrease within 1 nT, shown in Fig. \ref{fig:bxy_swep_freq}. The higher frequency of the rotating field will result in a higher requirement of the accuracy of the system's timing because higher $\omega_m$ results in a lower period, and the phase shift in the unit of time becomes smaller.

\begin{figure}[H]
\centering
\includegraphics[width=0.45 \textwidth]{20210412b_bxby.pdf}
\caption{The measured transverse residual magnetic fields as a function of the amplitude of the rotating field. The measurement of each data point is repeated 10 times.}
\label{fig:bxy_swep_amp}	
\end{figure}

\begin{figure}[H]
\centering
\includegraphics[width=0.45 \textwidth]{20210415b_rf_freqeuncy}
\caption{The measured transverse residual magnetic fields as a function of the frequency of the rotating field. The measurement of each data point is repeated 10 times.}
\label{fig:bxy_swep_freq}
\end{figure}

The noise of the magnetometer is described by the power spectral density as shown in Fig. \ref{fig:sensitivity}. The sensitivities of $B_x$ and $B_y$ improve as the amplitude of the rotating field increases, which reach their best sensitivity of approximately 6 pT/Hz$^{1/2}$ when the amplitude of the rotating field is larger than 15 $\mathrm{\mu T}$. The sensitivity of $B_z$ is approximately 3 pT/Hz$^{1/2}$, which is independent of the amplitude of the rotating field, the rotating magnetic field does not degrade the scalar resolution, the sensitivity of $B_{tot}$ is limited by the noise from the current source that drives the leading field $B_z$.

\begin{figure}[H]
\centering
\includegraphics[width=0.45\textwidth]{Sensitivity.pdf}
 \caption{The sensitivity of the scalar total magnetic field measurement is independent of the rotating field, and the rotating field doesn't degrade the scalar performance. The sensitivities of the two transverse-direction magnetic field measurements are reversely proportional to the amplitude of the rotating field $B_m$, because $B_{tran}$ is proportional to $\csc \theta$. Moreover, the transverse magnetic fields indicate two polar angles defining the magnetic field vector}
\label{fig:sensitivity}
\end{figure}

\section{Fundamental Limit}
The optical polarimeter measures the spin projection along the transverse direction. The optical rotation can be written as \cite{savukov2005tunable}
\begin{equation}
	\Theta = k P_x= \frac{1}{2} l r_e c f n P_x D(\nu),
	\label{eq:optical_rotation} 
\end{equation}
where $k=l r_e c f n D(\nu)/2$, $l$ is the length of probe beam travel through the cell, $r_e$ is the classical electron radius, $f$ is the typical oscillator strength of the D line transition, $D(\nu) = (\nu - \nu_0)/[(\nu-\nu_0)^2+(\Delta \nu /2)^2]$, where $\Delta \nu$ is the optical FWHM (full width at half maximum), $\nu_0$ is the frequency of the D line transition. 

The noise of the measurement of the precession signal is from the photon shot noise of the probe beam, and the power spectral density of the shot noise in the rotation angle can be written as \cite{seltzer2008developments}
\begin{equation}
	\rho_\Theta = \sqrt{\frac{1}{2 \Phi_{pr}}},
	\label{eq:psn}
\end{equation}
where $\Phi_{pr}$ is the total flux of photons of the probe beam per unit of time.

The limit of the phase estimation of the sinusoidal signal $k \sin(\omega t +\psi) + w$ can be given by Cramer Rao Lower Bound (CRLB) \cite{kay1993fundamentals}
\begin{equation}
	\sigma_\psi \geq \frac{\rho_\Theta}{k \sqrt{t}},
	\label{eq:phase_crlb}
\end{equation}
where $w$ is additive white Gaussian noise (AWGN), whose power spectral density is $\rho_{\Theta}$. In the experiment, the free spin precession signal damps exponentially with a transverse relaxation time $T_2$; if precession frequency $\omega_0 \gg 1/T_2$, the phase shift noise can be considered as white Gaussian noise during each precessing period $\Delta t = 2 \pi/\omega_0$.
\begin{equation}
    \sigma_\psi \geq \frac{\rho_\Theta}{k \sqrt{\Delta t}} e^{\frac{m \Delta t}{T_2}}, ~m = 0,1,2...M-1,
\end{equation}
where $M$ is the period number of $\Delta t$, and the measurement time $t=M \Delta t$. After the phase shift is measured, the slope of the phase shift is fitted to obtain the total magnetic field. And the slope equals the $(\omega- \omega_0)/\omega_0$, the power spectral density of the noise of $\omega$ measurement can be calculated by the Minimum-Variance Unbiased (MVU) estimation (Check Sec. II of the supplemental material for the detailed derivation.)
\begin{equation}
    \rho(\omega) \geq \frac{\rho_{\Theta}}{k \Delta t}\sqrt{2 M \cdot \kappa_1(M)},
    \label{eq:rho_omega}
\end{equation}
where 
\begin{equation}
\begin{aligned}
    & \kappa_1 (M) =\\
    &\frac{(1-z^2)^3(1-z^{2M})}{z^2+z^{2+4M}-z^{2M}(2z^2+M^2(1-z^2)^2)},
 \end{aligned}
\end{equation}
where $z=e^{-\Delta t/T_2}$. The power spectral density $\rho(\omega)$ in Eq. \ref{eq:rho_omega} has a minimum when the measurement time $t \approx 2 T_2$. And the total magnetic field measurement sensitivity is given by 
\begin{equation}
	\delta B_{tot} \geq \frac{4}{\gamma k T_2 \sqrt{\Phi_{pr}}}.
\end{equation}

For the transverse magnetic fields, $b_x$ and $b_y$ are measured by fitting the amplitude of $\sin \omega_m t$ and $\cos \omega_m t$ in the phase shift, respectively.

The power spectral density of the noise of the amplitude estimation of a sinusoidal signal can be written as (Check Sec. II in the supplemental document for the detailed derivation.)
\begin{equation}
    \rho(A) \geq \frac{\rho_{\Theta}}{k}\sqrt{2 M \cdot \kappa_2(M)}.
    \label{eq:rho_A}
\end{equation}
Where $\kappa_2$ is given by
\begin{equation}
    \begin{aligned}
    \kappa_2(M) = \frac{2(1-z^2)}{1-z^{2M}} \approx \frac{4 \Delta t}{T_2(1-e^{-\frac{2t}{T_2}})},
    \end{aligned}
\end{equation}
and $\delta B_{tran} = \rho(A) \cdot \omega_m \sqrt{B_z^2+B_m^2}/(\gamma B_m)$, we can have the transverse magnetic field measurement sensitivity
\begin{equation}
	\delta B_{tran} \geq \frac{\omega_m \csc \theta }{\gamma k \sqrt{ \Phi_{pr}}}\sqrt{ M \cdot \kappa_2(M)}.
\end{equation}


Differing from the total magnetic field measurement, the power spectral density of the transverse magnetic field measurement noise keeps increasing with a longer measurement time. If the measurement time is short enough, $\kappa_2 \rightarrow 2\Delta t/t$, and the transverse magnetic field measurement sensitivity is given by
\begin{equation}
	\delta B_{tran} \geq \frac{\sqrt{2} \omega_m \csc \theta }{\gamma k \sqrt{\Phi_{pr}}}.
\end{equation}
If we keep the measurement time the same as the optimized measurement time of the total magnetic field $t=2T_2$, then the transverse magnetic field measurement sensitivity is given by
\begin{equation}
	\delta B_{tran} \geq \frac{2\sqrt{2} \omega_m \csc \theta }{\gamma k \sqrt{\Phi_{pr}}}.
\end{equation}
The derived fundamental sensitivities of measuring the scalar magnetic field and transverse magnetic field are based on the assumption that the fitting of the scalar magnetic field and the transverse magnetic fields are independent, it is not an accurate assumption when the modulation frequency is not high enough. One can get analytical solution of magnetic field measurement sensitivities that the scalar magnetic field and transverse magnetic fields are fitted at the same time, it can be done by the Minimum-Variance Unbiased (MVU) estimator in the similar way as in Sec. III of supplemental material. The results are more complicated, however, it turns out that when the modulation frequency is fast enough 
($\omega_m \gtrsim \pi/T_2$), the fundamental sensitives are almost the same as considering them independently.

For comparison, the fundamental sensitivity of the transverse magnetic field of the sequential modulation vector magnetometers can be described as (Please check Sec. IV of the supplemental material for details.)
\begin{equation}
    \delta B_{TS} =  \frac{4\sqrt{2}}{\gamma k T_2 \sin \theta \sqrt{\Phi_{pr}}} 
\end{equation}
If we assume $\omega_m = \pi / T_2 $, The sensitivity of the transverse magnetic field of our fast rotating field vector magnetometer can be written as
\begin{equation}
    \delta B_{tran} = \frac{2\sqrt{2} \pi }{\gamma k T_2 \sin \theta \sqrt{\Phi_{pr}}}
\end{equation}
The fast rotating field vector magnetometer has a comparable sensitivity of measuring the transverse magnetic fields compared with the sequential modulation vector magnetometers. Moreover, the fast rotating field magnetometer has a higher bandwidth and experience less systematic. 

In the experiment, the measured standard deviation of the phase $\sigma_{\psi} \approx 2\pi \times 3 \times10^{-4}$, we can estimate the sensitivity limits $\delta B_{tot} = 0.3 ~\mathrm{pT/\sqrt{Hz}}$ and $\delta B_{tran} = 3 ~\mathrm{pT/\sqrt{Hz}}$ based on Eqs. \ref{eq:rho_omega} and \ref{eq:rho_A}. The total magnetic field sensitivity $\delta B_{tot}$ is limited by the noise from the current source (Arroyo 6300 Series ComboSource), which provide approximately 650 mA current to generate the leading magnetic field along z-axis, and whose power spectral density noise measured by Keithley DMM7510 is approximately 50 $\mathrm{nV/\sqrt{Hz}}$, which leads to a magnetic field noise floor of 3 $\mathrm{pT/\sqrt{Hz}}$. We replace the Arroyo current source with SRS DC205 DC Voltage Source, it can slightly improve the sensitivity to 2 $\mathrm{pT/\sqrt{Hz}}$ in the vector mode, because it doesn't have enough bandwidth to compensate the small current fluctuation caused by the cross-talk between the transverse coils and the longitudinal coil as the Arroyo current source. If the rotating fields are turned off to avoid the cross-talk, and the sensitivity of the scalar magnetic field measurement can reach to 0.5 $\mathrm{pT/\sqrt{Hz}}$, it is then limited by the performance of the alkali cell and the optical system.

If a multi-pass cell with $l=$ 1 cm and the probe beam can 10 times multi-pass is used, $T_2=3$ ms, $\omega_m = 480$ Hz, $\theta=30 ^{\circ}$, the probe beam power equals 2 mW, the projected sensitivities $\delta B_{tot} = 218 ~\mathrm{aT/\sqrt{Hz}}$ and $\delta B_{tran} = 3 ~\mathrm{fT/\sqrt{Hz}}$. 

\section{Conclusion}
We demonstrated a vector magnetometer which can measure three-axis magnetic fields simultaneously, it is realized by simply adding a rotating magnetic field. We also investigate several systematics that are specifically introduced in this paper, which are dynamic heading error, probe beam heading error, eddy current and second harmonic phase shift. We designed a four-shot scheme by fast altering the rotating magnetic field to cancel out these systematics. These study of systematics and technologies are useful to develop high accuracy vector magnetometers. We proposed analytical fundamental limits of the magnetometer in measuring the total scalar magnetic field and the transverse magnetic fields.

In this experiment, a single-pass small cell is used to study the vector magnetometer and its systematic effects. We will further develop a vector magnetometer by replacing the single-pass cell with two multi-pass cells with a gradiometer arrangement. It can keep the scalar magnetic field measurement sensitivity of several $\mathrm{fT/Hz^{1/2}}$ as  \cite{limes2020portable}, as well as simultaneously measure two polar angles defining the magnetic field vector at a sensitivity of $\mathrm{fT/Hz^{1/2}}$.

\section*{Acknowledgements}
The authors acknowledge support from the Defense Advanced Research Projects Agency (DARPA) and A*STAR Career Development Fund (Project No. 222D800028).


%\bibliographystyle{unsrt}
\bibliographystyle{apsrev4-1}
\bibliography{references}
\end{document}
