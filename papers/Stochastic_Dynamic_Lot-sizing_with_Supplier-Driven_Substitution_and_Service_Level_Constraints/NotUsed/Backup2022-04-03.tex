%%    TEMPLATE for articles submitted to the IWLS 2011
%%
%%
%%     Please do not remove lines commented out with %+
%%           these are for the editors' use.
%%

\documentclass[10pt]{article}
\usepackage{epsfig}
\usepackage{lscape}
\usepackage{adjustbox}
\usepackage{mathtools}
\usepackage{amsmath}
\usepackage{comment}
\usepackage{booktabs}
\usepackage{graphicx}
\usepackage{array}
\usepackage{xcolor}
\usepackage[margin=1 in]{geometry}
\usepackage[ruled,vlined]{algorithm2e}
\usepackage{amssymb}
\usepackage[colorlinks=true,linkcolor=blue,citecolor=cyan, hypertexnames=false]{hyperref}
\usepackage{textcomp}
\usepackage{caption}
\usepackage{multirow}
\usepackage{here}
\usepackage{amsmath}
\usepackage{dsfont}
\newcommand{\R}{\mathds{R}}
\newcommand{\E}{\mathds{E}}
\usepackage{subfig}
\allowdisplaybreaks

% For the mathematical formulation

\newcommand{\ti}{t} %For the time period index
\newcommand{\TI}{\mathcal{T}}
\newcommand{\Ti}{T}
\newcommand{\ka}{k} % For product index
\newcommand{\KA}{\mathcal{K}}
\newcommand{\Ka}{K}
\newcommand{\jey}{j} % For product index
\newcommand{\Graf}{\mathcal{A}} %For the y variable
\newcommand{\Bi}{B} %For the backlog
\newcommand{\Vi}{v} %For the order upto level
\newcommand{\Es}{S} %For the Substitution
\newcommand{\Zed}{z} %For the z variable
\newcommand{\m}{\omega} %For the scenario m
\newcommand{\Em}{|\Omega|} %For the scenario m
\newcommand{\EM}{\Omega} %For the scenario m

\newcommand{\x}{x} %For the x variable
\newcommand{\y}{y} %For the y variable
\newcommand{\InvPos}{inventory level after production }
\newcommand{\cn}{\mathcal{C}(n) }

\newcommand{\Csub}{\mathcal{K}^+_k}
\newcommand{\Psub}{\mathcal{K}^-_k}

\newcommand{\tAct}{\hat{\ti}} % actual time period in infinite-horizon
\newcommand{\PSpolicy}{``production substitution policy"}

\newcommand{\Sc}{\overline{S}}
\newcommand{\Bc}{\overline{B}}
\newcommand{\Ic}{\overline{I}}




%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%  Do not change these:
%\textwidth=6.0in  \textheight=8.25in

%%  Adjust these for your printer:
%\leftmargin=-0.3in   \topmargin=-0.20in


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%  personal abbreviations and macros
%    the following package contains macros used in this document:
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
%  To include an item in the INDEX of the conference volume,
%           flag it with    \index{<item name>}
%  The use of this macro is illustrated in the text.
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\newcommand{\cred}{\color{red!65!black}}

\def\Title#1{\begin{center} {\Large {\bf #1} } \end{center}}

\begin{document}


\Title{Stochastic dynamic lot-sizing with substitution and service level constraints }

\bigskip\bigskip

%+\addtocontents{toc}{{\it First Author}}
%+\label{AuthorNameStart}

%%    TEMPLATE for articles submitted to the IWLS 2011
%%
%%
%%     Please do not remove lines commented out with %+
%%           these are for the editors' use.
%%







 \textbf{\large Keywords:} Stochastic lot sizing, Product substitution, Joint service level, Decision policy
 %Dual-based decomposition methods


\begin{abstract}


We consider multi-stage lot sizing problem with stochastic demand and the possibility of product substitution. Considering different production costs, the use of substitution can increase the revenue and customer satisfaction specially when the demand is uncertain. The goal is to minimize the total expected cost while satisfying a predetermined service level. We consider joint service level constraints which limits the probability of stock outs, defined as a chance-constraint jointly over multiple products. We present the stochasticity as a scenario set, and we propose different approximation-based decision policies using mixed integer mathematical models. 
%and dual-based decomposition methods modified for this problem.
The policies are applied and evaluated in rolling-horizon framework  in which at each time period we solve a problem with two-stage chance constraints to assure meeting the service level targets and deterministic approximations of future periods. Through extensive numerical experiments we compare different policies, and illustrate the efficiency of proposed  investigate the value of substitution and propose some managerial insights. 
\end{abstract}

\section{Introduction}
{\cred
Contents of this section:

\begin{itemize}
    \item Lot sizing problem 
    \item Stochastic lot sizing problem with service levels
    \item Motivation on substitution
    \item Industrial relevance
    \item Motivation of stochastic lot sizing + random demand +joint service level + substitution 
    \item Industrial relevance
    \item Contributions of the work
\end{itemize}
}
The basic lot sizing problem is a multi-period production planning problem which considers the trade-off between setup costs and inventory holding cost, and defines the optimal timing and quantity of production to minimize the total cost. 
%The lot sizing problem has been extensively studied and applied in real world situations. 
%In the basic lot sizing problem, all the parameters are deterministic. Stochastic lot sizing problems address this restrictive assumption by considering uncertainty in different parameters such as demand and cost parameters.
In situations where there exits uncertainty in demand, which is inevitable in real world applications, the decision maker needs to determine the production policy to minimize the expected cost. Here, it is inevitable to have stock outs and the challenge is to keep them under control. Common approaches to deal with this challenge is whether to consider the backorder cost of tangible or intangible effects which is difficult to estimate or impose a service level criterion. 
In this research, we study the stochastic lot sizing problem with $\alpha$ service level which is an event-oriented service level and impose limits on the probability of stock outs. This service level which is frequently used application is usually defined as a chance-constraint. 

When an item is out of stock, sometimes the firm has the option to substitute it with another product. This type of substitution which is initiated by the firm is called firm-driven substitution and may result in reducing the stock outs, increasing the revenue, cost savings, and customer satisfaction, especially when dealing with demand uncertainty. This problem has a practical relevance in electronics and steel industries where it is possible to substitute a lower-grade product with a higher-grade one. Semiconductors or microchips are good examples of these types of products~\cite{lang2010efficient}. 

In this research, we consider the stochastic lot sizing problem with service level constraint when there is the possibility of product substitution. Having the substitution option, it is not applicable to impose the service levels individually for each product and therefore we consider the service level jointly over multiple products. Substitution option and joint service level over multiple products are in line with each other as in both cases, we consider all products together to reach the required service level and minimizing the total expected cost. 

%In lot sizing problems, we are dealing with the sequence of decisions over the planning horizon, and multi-stage stochastic programming is a method to incorporate uncertainty. In multi-stage stochastic problems, the uncertainty is typically represented as a scenario tree.


%The basic assumption to approximate and solve  these models is that the demand for each product are independent from each other and there is no autocorrelation~\cite{tempelmeier2011column}. 
%In this research, we model the stochastic lot sizing problem with substitution and a joint $\alpha$ service level using scenario tree.
%for which there is no need to have these assumptions and it is possible to use any demand scenarios. 
We consider infinite-horizon problem in which we need to sequentially make decisions on setup timings, and production and substitution amounts based on the current state of the system reflected as the total available inventory and backlog. We follow the ``dynamic" strategy \cite{bookbinder1988strategies} for which different decisions can be dynamically updated throughout the planning horizon when the demands are observed. As defining the optimal solution is computationally intractable, to solve this problem, we consider a finite-horizon problem and apply it in a rolling-horizon environment. The aim is to propose decision policies which map the state of the system to different decisions. These policies are based on the mixed integer programming model for the problem, in which the random demand is represented as a scenario set.
%Having multi-stage problem and following the ``dynamic" strategy \cite{bookbinder1988strategies} the setups and production decisions are defined through the planning horizon and updated with regard to the demand realization. The stochasticity in demand in reflected in scenario tree.

The challenge of these stochastic models is that with increasing the number of scenarios the solution time will increase extensively and makes it difficult to reach a reasonable solution in a reasonable amount of time. To deal with this challenge we choose two different approaches. First, we propose policies based on the deterministic approximation of the model, without directly imposing a service level constraint. Second, we propose a two-stage approximation for the multi-stage model and an efficient branch and cut algorithm to solve the model with service level constraint. 
The contribution of this research can be summarized as follows. 
\begin{itemize}
\item Consider an infinite horizon multi-stage lot sizing problem with substitution and joint service level constraints. (which to the best of our knowledge is new to the literature).

\item Propose a finite-horizon stochastic dynamic program for this problem and deriving approximation-based rolling horizon policies to define different decisions at each point of time. The approximations are based on the two-stage stochastic programming, using sample approximation and a novel separate and recombine strategy. 

\item Apply branch-and-cut algorithm to solve the model which explicitly considers the service level.

%\item Proposing mathematical model for the stochastic dynamic lot sizing problem with joint $\alpha$ service level constraints and firm-driven substitution possibility.
%\item Proposing a dynamic programming formulation for the finite-horizon problem which can be applied in a rolling-horizon fashion.
\item Compare different policies including deterministic ones and a chance-constraint policy using simulation, illustrate the value of substitution and provide managerial insights under different settings.% (as in ~\cite{jiang2017service} and  ~\cite{jiang2017production}) modified for the stochastic lot sizing problem with substitution.
    


\end{itemize}

The rest of this paper is organized as follows. In section 2, we survey the related literature. In section 3, we define the problem and the dynamics of decisions in the system. We also provide the dynamic programming formulation for the finite horizon problem. In section 4, we explain the process of making different decisions at each stage. In this two step process, we first solve a feasibility problem to determine if the demands can be met. Based on the solution of this phase we may allow some backlog in the current stage of the model. We then solve the approximation-based policies including two deterministic and a chance constraint policies. Backlog determination step and the policies are explained in detail in this chapter. In section 5, we present the branch and cut algorithm to solve the chance constraint policy model, in which we explicitly consider the service level. In section 6, we illustrate the computational experiments, including the rolling horizon implementation and simulation procedure, instance generation, methodology evaluation, policy comparison, and sensitivity analysis. Finally, we conclude in section 7.

\section{Literature review}
\label{sec:litrev}
The related literature of this work can be categorized in two streams. The first part is dedicated to the lot sizing and inventory models with substitution in both deterministic and stochastic versions and the second part is dedicated to the stochastic lot sizing problem with joint service level. To the best of our knowledge, no research has investigated stochastic lot sizing problem with substitution and joint service levels.
%and the current research addresses this gap in the literature.  

\subsection{Lot sizing and inventory problems with substitution}
In the literature, there are two types of substitution, the demand-driven substitution and firm-driven substitution. In the demand-driven substitution the customer decides which product to substitute~\cite{zeppetella2017optimal}, while in the firm-driven case, it is the firm which makes the substitution decisions~\cite{rao2004multi}. In the following subsections we address these problems. 
\subsubsection{Deterministic models}
 Hsu et al.~\cite{hsu2005dynamic} study two different versions of the dynamic uncapacitated lot sizing problem with one-way substitution, when there is a need for physical conversion before substitution, and when it does not require any conversion. The authors propose a mathematical model for this problem and solve it using a backward dynamic programming algorithm and a heuristic algorithm based on Silver-Meal heuristic to solve the problem.  Lang and Domschke~\cite{lang2010efficient} consider the uncapacitated lot sizing problem with general substitution in which a specific class of demand can be satisfied by different products based on a substitution graph. They model the problem as a mixed-integer linear program and propose a plant location reformulation in which the amount of production for an item is break down into different amounts based on the period where they are used to satisfy the demand. The authors also propose some valid inequalities for the original model and solve the model using CPLEX solver.
\subsubsection{Stochastic models}
Many studies in the field of the stochastic inventory planning have considered the possibility of substitution. While the majority of them investigated the demand-driven substitution, some research considered the firm-driven substitutions.
%Most of the research about the  product substitution with stochastic demand investigated the demand-driven substitution.
In the demand-driven substitution, the customer may choose another product, if the original item cannot be found. This is also known as ``stock out substitution". Akçay et al.~\cite{akccaycategory} investigate a single-period inventory planning problem with substitutable products. Considering the stochastic customer-driven and stock out  substitution, they propose an optimization based method, which jointly defines the stocking of each product, while satisfying a service level. 
%They adapt the Type II service level or ``fill rate" for each individual product and overall within a category of products.  

In this research, we consider the firm-driven substitutions. In the same vein, Bassok et al.~\cite{bassok1999single} investigate the single-period inventory problem with random demand and downward substitution in which a lower-grade item can be substituted with the ones with a higher-grade. This model is an extension of the newsvendor problem and there is no setup cost in case of ordering. The sequence of decisions is as follows: first, they define the order quantity for each of the items, namely ordering decision. Second, when the demand is observed, they define the allocation decisions. The authors propose a profit maximization formulation and characterize the structure of the optimal policy for this problem. Using some decomposition ideas they propose some bounds on the optimal order amount and use them in an iterative algorithm to solve the model.  Rao et al.~\cite{rao2004multi} also consider a single-period problem with stochastic demand and downward substitution, and model it as a two-stage stochastic program. In their model, they consider the initial inventory and the ordering cost as well. In addition to the extensive form of the model, the author propose two heuristic algorithm to solve this problem.


Another similar research stream considers the possibility of having multiple graded output items from a single input item, which is known as ``co-production"~\cite{ng2012robust}. In these problems, there is a hierarchy in the grade of output items and it is possible to substitute a lower-grade item with the ones with higher-grade~\cite{bitran1992ordering}. Hsu and Bassok~\cite{hsu1999random} consider the single-period production system with random demand  and random yields. 
%Although they do not mention ``co-production" in their research,
They model the problem as a two-stage stochastic program which defines the production amount of a single item and the allocation of its different output items to different demand classes~\cite{hsu1999random}. They propose three different solution methods to solve the problem, including a stochastic linear model. In addition, two decomposition based method in which the subproblems are network flow problems, are proposed for this problem. 
Birtan and Dasu~\cite{bitran1992ordering} study an infinite horizon, multi-item, multi-period co-production problem with deterministic demand and random yield. As solving this problem in a infinite horizon is intractable, they proposed two approximation algorithms to solve it. The first approximation is based on a rolling-horizon implementation of the finite-horizon stochastic model. For the second approximation, they consider a simple heuristic based on the optimal allocation policy, in a multi-period setting. This heuristic includes two modules, a module to determine the production quantities, and module to allocate produced items to the customers. This heuristic can be also applied in a rolling horizon procedure. Bitran and Leong~\cite{bitran1992deterministic} consider the same problem and propose deterministic near-optimal approximations within a fixed planning horizon. To adapt their model to the revealed information, they apply the proposed model using simple heuristics in a rolling planning horizon.  Bitran and Gilbert~\cite{bitran1994co} consider the co-production and random yield in a semiconductor industry and propose heuristic methods to solve it. 
 
%\subsection{chance-constraints optimization}
\subsection{Stochastic lot sizing problem and service level constraints}
This section is dedicated to the stochastic lot sizing problem with random demand. Most of the research in this context consider a scenario set or a scenario tree to represent the stochasticity in demand and propose efficient methodologies to solve them. Haugen et al.~\cite{haugen2001progressive} consider the multi-stage uncapacitated lot sizing problem and propose a progressive hedging algorithm to solve it. Guan and Miller~\cite{guan2008polynomial} propose a dynamic programming algorithm for a similar version. Using the same algorithm, Guan~\cite{guan2011stochastic} study the capacitated version of the problem with the possibility of backlogging. Lulli and Sen~\cite{lulli2004branch} propose a branch and price algorithm for multi-stage stochastic integer programming and apply their general method to the stochastic batch-sizing problem. In this problem, they consider that the demand, production, inventory and set up costs are uncertain. The difference between this problem and the lot sizing problem is that the production quantities are in batches and the production decisions are the number of batches that will be produced, as such integer-valued. This problem is a more general case of lot sizing problem. In another research, Lulli and Sen~\cite{lulli2004branch}  proposed a scenario updating method for the stochastic batch-sizing problem. As backlogging is allowed in this problem, it is considered as a stochastic model with complete fixed recourse.  

A common approach to deal with stochastic demand is using service levels. In this context the planners put  a demand fulfillment criterion to mitigate the risk of stock outs.  Stochastic lot sizing problems with service level constraints have been studied extensively~\cite{tempelmeier2007stochastic} and many types of service levels existed in the literature. One of the main service levels is the $\alpha$ service level which is an event-oriented service level, and imposes limits on the probability of a stock out. This service level is represented as a chance-constraint and is usually defined for each period and product separately. Bookbinder and Tan~\cite{bookbinder1988strategies} investigate stochastic lot sizing problems with an $\alpha$ service level and propose three different strategies based on the timing of the setup and production decisions, for this problem. These strategies are the \textit{static}, \textit{dynamic}, and \textit{static-dynamic}. In the \textit{static} strategy, both the setup and production decisions are determined at the beginning of the planning horizon and they remain fixed when the demand is realized. In the \textit{dynamic} strategy, both the setup and production decisions are dynamically changed with the demand realization throughout the planning horizon. The \textit{static-dynamic} strategy is between these two strategies in which the setups are fixed at the beginning of the planning horizon and the production decisions are updated when the demands are realized. %The $dynamic$ strategy can be modeled as a multi-stage stochastic lot sizing problem.  

There are some studies which define the service level constraint jointly over different planning periods. Liu and K{\"u}{\c{c}}{\"u}kyavuz~\cite{liu2018polyhedral} consider the uncapacitated lot sizing problem with a joint service level constraint and study the polyhedral structure of the problem and propose different valid inequalities and a reformulation for this problem. Jiang et al.~\cite{jiang2017production} consider the same problem with and without pricing decisions. Gicquel and Cheng~\cite{gicquel2018joint} investigate the capacitated version of the same problem. Jiang et al.~\cite{jiang2017production} and Gicquel and Cheng~\cite{gicquel2018joint} similarly use a sample approximation method to solve their problems. This method is a variation of the sample average approximation method which is proposed by Luedtke and Ahmed~\cite{luedtke2008sample} to solve models with chance-constraints using scenario sets. All the mentioned studies consider single item models in which the joint service level is defined over all periods. There are few research which consider the service level jointly over all the products. Akçay et al.~\cite{akccaycategory} adapt the Type II service level or ``fill rate" for each individual product and overall within a category of products, having demand-driven substitution assumption. In this research, we consider substitution and a joint service level that is defined over all products.


\section{Problem definition and formulation}
We consider a stochastic lot sizing problem with the possibility of substitution in an infinite time horizon which is discretized into planning periods. % are indexed by $\tAct$. 
%There are multiple types of products, whose index set is $\KA= \{1,...,\Ka\}$, with random demand, denoted by vector $D_{\tAct} = ({D}_{\tAct 1}, {D}_{\tAct 2},..., {D}_{\tAct \Ka})$.
There are multiple types of products with random demand, and at each stage, we need to make decisions about the production setups, production and substitution amounts, and accordingly define the potential inventory and backlog levels. There is production lead time of one, i.e., what is produced in the current stage is available at the next stages. 
These decisions are made sequentially at each stage, based on the available inventory and backlog in the system, random future demand, and the history of realized demand, such that a joint service level over all products is to be satisfied in the following stage. This is in line with the  ``dynamic'' strategy that is defined for the stochastic lot sizing problem~\cite{bookbinder1988strategies}. 

To provide a decision policy for this infinite-horizon problem we propose a rolling-horizon approach, where at each time period we solve a finite-horizon version of the problem and implement the first-period decision obtained from this problem, as illustrated in Figure~\ref{fig:FiniteVSInfinite}. {\cred Being at period $\tAct$ as the actual time, for the $\Ti$ planning periods for the finite-horizon models, the actual time indices $(\tAct, ..., \tAct +\Ti -1) $ are mapped into $(1, ..., \Ti)$ for convenience.} 
%In this problem, decision-making stages are the same as time periods, and for the rest of this paper, we will use them interchangeably. 
%We will use  $\tAct$ as the time period index for actual period in infinite time horizon.

In this section, we provide the problem definition of the ideal finite horizon problem we would solve in each time period. This problem is a dynamic stochastic program with chance constraints to represent the service level constraints, and hence is intractable to solve exactly. In Section \ref{sec:approx} we discuss our proposed approximate solution strategies.

In the finite-horizon problem, we have multiple types of products, whose index set is $\KA= \{1,...,\Ka\}$, and $\Ti$ planning periods indexed by $\ti \in \TI=\{1 , ..., \Ti\}$. We propose a multi-stage stochastic programming model with joint chance-constraints.
%and the possibility of substitution.
%In this finite-horizon model, we need to decide about the setup timing, and the production and substitution amounts for each product through the planning periods.
Being at period $t=1$  (which is equivalent to an actual decision-making period $\tAct$ in the infinite-horizon model), given the state of the system the model considers decisions for the $\Ti$ stages to guide the implementable first-stage ($\ti =1$) decisions that would satisfy the joint service level in the next period, $\ti=2$.



\begin{figure}[!h]
\begin{center}
\includegraphics[scale=0.6]{FiniteVSInfinite.png}
\caption{Rolling-horizon framework} 
\label{fig:FiniteVSInfinite}
\end{center}
\end{figure}



%This is in line with the  ``dynamic'' strategy that is defined for the stochastic lot sizing problem in which both setup and production decisions are updated when the demand are realized ~\cite{bookbinder1988strategies}. 

Figure~\ref{MultistageDynamics} illustrates the dynamics of decisions for the finite-horizon problem at each stage. 
%There are $\Ka$ different products with random demand and the notations are shorthand for the vectors which corresponding elements are defined for each product.
At each point of time, $\ti$, the demand realization vector $\hat{D}_{\ti} =(\hat{D}_{\ti 1}, \hat{D}_{\ti 2},..., \hat{D}_{\ti \Ka})$ is observed, and also given the initial state of the system, described by the vector of current on-hand inventory, $\hat{\Vi}_{\ti} =(\hat{\Vi}_{\ti 1}, \hat{\Vi}_{\ti 2},..., \hat{\Vi}_{\ti \Ka})$, and the backlog vector, $\hat{\Bi}_{\ti}=(\hat{\Bi}_{\ti 1}, \hat{\Bi}_{\ti 2},..., \hat{\Bi}_{\ti \Ka})$, two sets of decisions are made.
The first set includes substitution, inventory, and backlog decisions denoted by ${\Es}_{\ti}= ({\Es}_{\ti 11}, {\Es}_{\ti 12},\hdots, {\Es}_{\ti \Ka \Ka}), I_{\ti} = ({I}_{\ti 1}, {I}_{\ti 2},..., {I}_{\ti \Ka}), {\Bi}_{\ti} =({\Bi}_{\ti 1}, {\Bi}_{\ti 2},\hdots, {\Bi}_{\ti \Ka})$ vectors, respectively. 
The rest of the decisions in the current period are production, setup, and \InvPos at the end of current period which are denoted by $x_{\ti} = (x_{\ti 1}, x_{\ti 2},..., x_{\ti \Ka}), y_{\ti} = ({y}_{\ti 1}, {y}_{\ti 2},..., {y}_{\ti \Ka}), \Vi_{\ti} = ({\Vi}_{\ti 1}, {\Vi}_{\ti 2},..., {\Vi}_{\ti \Ka})$ vectors, respectively. 
It should be noted that all these decisions are made simultaneously, but having lead time of one period and assuming that demand in period $\ti$ is observed at the beginning of the period, the production quantities made during period $\ti$ can be used only in the next periods, i.e., they are not available to satisfy the same period demand or backlogged demand. Therefore, we defined two different inventory level vectors, namely, $I_{\ti}$ as the inventory level immediately after demand satisfaction, but before production, and $\Vi_{\ti}$ as the inventory level at the end of the period, also taking into account the production in period $\ti$. 
%These two parameters shows the state of the system at beginning of the current period. The rest of the decisions in the current period are production, setup, and inventory position at the end of current period which are denoted by $x, y, v$, respectively.  It should be noted that the last three decisions are used to satisfy the future periods demand. In other words, the production in the current period will not be used for the same period demand.
The values of $\Vi_{\ti}$ and $\Bi_{\ti}$ will be the inputs for the next period, describing the next state of the system.
%In each period, we should define the decisions such that the joint service level in the next stage is satisfied, considering different demand scenarios. 
\begin{figure}[!h]
\begin{center}
\includegraphics[scale=0.6]{Diagram.png}
\caption{Dynamics of decisions at each stage} 
\label{MultistageDynamics}
\end{center}
\end{figure}


The inventory of a product can be used to satisfy its own demand or another product demand based on the substitution graph $G$ with vertex set $\KA$ and arc set $\Graf$. If $(\ka, \jey) \in \Graf$ then product $\ka$  can fulfill demand of product $\jey$ but a substitution cost of $c^{\text{sub}}_{\ti \ka \jey }$ per unit is incurred at period $\ti$. Note that $(\ka, \ka) \in \Graf  \text{ for all } \ka \in \KA$, and $S_{\ti \ka \ka}$ corresponds to the amount of product $\ka$ which is used to satisfy its own demand.  Demand for a specific product is met either from the inventory of that product or from the inventory of another product through substitution, or else the demand is backlogged. In each period $\ti$, while insufficient inventory will lead to backlog denoted by $\Bi_{\ti \ka}$, unnecessary stocks will increase the holding cost. An inventory holding cost of $c^{\text{hold}}_{\ti \ka}$ per unit is charged for the quantity being stored after the demand satisfaction in each period, denoted by $I_{\ti \ka}$. Furthermore, in each period where production occurs, a setup has to be performed which incurs a fixed setup cost of $c^{\text{setup}}_{\ti \ka}$. We consider the trade-off between these costs while making decisions at each period, also ensuring that the random demand in the next period can be satisfied with high probability based on a predefined service level. 


%\begin{figure}[!h]
%\begin{center}
%\includegraphics[scale=0.5]{Diagram.png}
%\caption{Dynamics of the multi period model} 
%\label{Diagram}
%\end{center}
%\end{figure}




%which is adapted from  Lang and Domschke~\cite{lang2010efficient} for deterministic uncapacitated lot sizing problem with substitution. 
%This model considers a general substitution graph in which a demand class can be fulfilled with multiple products based on the substitution graph and at a substitution cost.


\begin{table}[H]
\centering
\caption{Notation for the mathematical model}
\begin{adjustbox}{width=1\textwidth,center=\textwidth}
\begin{tabular}{ll}
\toprule
{\textbf {Sets}} & {\textbf {Definition}} \\ \midrule
%$\hat{\TI}$  & Set of actual planning periods of infinite-horizon, indexed by $1, ..., \hat{\ti}, ... ,\hat{\Ti}$ \\ 
$\TI$  & Set of planning periods, indexed by $1, ... ,\Ti$ \\ 
$\KA$  & Set of products, indexed by $1, ... ,\Ka$ \\
%$N$  & Set of demand classes\\ 
%$V = K \cup N$  & Vertex set of substitution graph\\
$ G = (\KA,\mathcal{A})$  & Substitution graph \\
$ \Graf \subseteq \KA \times \KA$  & Directed arcs of substitution graph denoting feasible substitutions, which include self loops
%: $(k, j) \in \Graf$ if product $\ka$  can fulfill demand of product $\jey$
\\
%$ G = (V,\Graf)$  & Substitution graph \\
$  \Csub = \{\jey \mid (\ka,\jey) \in \Graf\}$  & Set of products whose demand can be fulfilled by product $\ka$  \\
$ \Psub = \{\ka \mid (\jey,\ka) \in \Graf\}$  & Set of products that can fulfill the demand of product $\jey$  \\
$ \mathcal{N} $  & Set of nodes in the scenario tree \\
$ \cn $  & Set of child nodes for node $n$ in the scenario tree \\
\midrule 
{\textbf {Parameters}} & {\textbf {Definition}} \\ \midrule
$c^{\text{setup}}_{\ti \ka}$ & Setup cost for product $\ka$ in period $\ti$ \\ 
$c^{\text{hold}}_{\ti \ka}$  & Inventory holding cost for product $k$ in period $\ti$  \\ 
$c^{\text{sub}}_{\ti \ka \jey }$  & Substitution cost if product $\ka$  is used to fulfill the demand of product $\jey$  in period $\ti$  \\ 
$c^{\text{prod}}_{\ti \ka}$  & Production cost for product $\ka$ in period $\ti$  \\
$c^{\text{back}}_{\ti \ka}$  & Backlog cost for product $\ka$  in period $\ti$ \\
$\alpha$  & Minimum required joint service level \\ 
$M_{\ti \ka}$  & A sufficiently large (Big-M) number (to model the logical constraint) \\ 
%$I_{k0}$ & The initial inventory for product $\ka$  \\ 
%${d}_{jt}$  & Demand for class {\it j} in period $\ti$ (model input)\\ 
${D}_{\ti \ka}$ & Random demand variable for product $\ka $ in period $\ti$  \\ 
${D}^\text{Hist}_{\ti \ka}$ & Random demand history from period 1 to period $\ti$ for product $\ka $  \\ 
%$\ti(n)$ & Time period at node $n$  \\ 
%$\hat{\Vi}_{p(n), \ka} $&  The amount of initial \InvPos for product $\ka$ at parent of node  $n$\\
%$\hat{\Bi}_{p(n), \ka} $&  The amount of initial backlog for product $\ka$ at the parent of node $n$  \\
$\hat{\Vi}_{\ka} $&  The amount of initial inventory level for product $\ka$ \\
$\hat{\Bi}_{\ka} $&  The amount of initial backlog for product $\ka$   \\
$q_{nm} $&  The probability of child node $m$ from node $n$  \\
$\mathbb{P} $&  The probability distribution of the demand process {\cred(It should be demand or demand process??)}\\ 
\midrule
{\textbf {Decision variables}} & {\textbf {Definition}} \\ \midrule
$\y_{\ti \ka}$ & Binary variable which is equal to 1 if there is a setup for product $k$ at period $\ti$, 0 otherwise \\ 
$\x_{\ti \ka}$ & Amount of production for product $\ka$  at period $\ti$  \\ 
$\Es_{\ti \ka \jey}$ & Amount of product $\ka$  used to fulfill the demand of product $\jey$  at period $\ti$   \\
${I}_{\ti \ka}$ & Amount of physical inventory for product $k$ after the demand satisfaction for period $\ti$  \\
${\Bi}_{\ti \ka}$ & Amount of backlog for product $k$ at the end of period $\ti$  \\
${\Vi}_{\ti \ka}$ & The \InvPos for product $\ka$ at the end of period $\ti$  \\
 \bottomrule
% & $^*{ ( \Csub \text{ and }  \Psub  \text{ sets include } k) }$
\end{tabular}
\end{adjustbox}
 \label{tab:Sub_parameters}
\end{table}





 
 





%\begin{flalign}
%&pr((\sum_{t'=1}^{t} \sum_{k\in P_{j}} \overline{S}_{\ka \jey \ti'} -\sum_{t'=1}^{t} \overline{D}_{jt'}) \geq 0~~~~~\forall \jey \in N ) \geq \alpha_{c} &   \forall \ti  \in \TI,  & \label{eq:Sub_ST_Service}
%\end{flalign}


%Constraints (\ref{eq:Sub_ST_Service}) guarantee the minimum service level.
%These chance-constraints ensure that the probability of a stock out is less than (1-$\alpha_{c}$). \\


%\subsection{Dynamic programming model}


%In this section, we present the dynamic programming model for the stochastic lot sizing problem with a firm-driven substitution and joint service level constraint. Different sets, parameters and decision variables are presented in Table~\ref{tab:Sub_parameters}. Considering the underlying scenario tree, the mathematical model \ref{DynamicProgramming} is proposed for the node {\it n} in the tree. This model is based on the inventory position at the beginning and ending of the planning period correspond to current node {\it n}. At each stage $\hat{\Vi}_{p(n),{\ka}}$ and $\hat{\Bi}_{p(n),{\ka}}$ illustrate the state of the system for the current node. Considering $D_{\ka\ti}$ as the random variable for product $\ka$ in period $\ti$, $\hat{D}_{n \ka}$ is its realization at node $n$. Considering the scenario tree, $D^{\ti \ka}$ is the history of  random demand from period 1 to period $\ti$ and $\hat{D}^{nk}$ is its realization until node $n$.  

%In this section, we present the dynamic programming formulation for the finite-horizon stochastic lot sizing problem with a firm-driven substitution and joint service level constraint over all products. 
We model the underlying stochastic process of the demand as a scenario tree, for the finite model with $\Ti$ stages. 
%There are $N$ nodes in the tree, represented by the set $\mathcal{N} = \{1, ..., N\}$, where node 1 is the root node. 
% Each node in the tree has a parent node, $p(n)$, a set of child nodes, $\cn$, and $q_{nm}$ is the transition probability from node $n$ to its child node $m$. $\ti(n)$ is the time period/stage corresponding to node $n$. 
$D_{\ti \ka}$ is the random demand variable for product $\ka$ in period $\ti$, whereas $\hat{D}_{\ti \ka}$ denotes its realization at time $\ti$.
$D^\text{Hist}_{\ti \ka}$ represents the random demand path from period 1 to period $\ti$ for product $\ka$, and $\hat{D}^\text{Hist}_{\ti\ka}$ denotes its realization (the history) until period $\ti$.


We next present our proposed multi-stage stochastic programming model with chance-constraint for the finite-horizon variant of the considered lot sizing problem with substitution.
Notation for different sets, parameters and the decision variables are presented in Table~\ref{tab:Sub_parameters}. 

%the mathematical model (\ref{DynamicProgrammingNoden}) is proposed for each node $n \in \mathcal{N} \setminus \{1\}$ in the tree.
%This model is based on the \InvPos and backlog at the beginning and end of the planning period corresponding to the current node $n$.
 We present a dynamic programming formulation where $F_t(.)$ denotes the cost-to-go function at each period $\ti = 1, 2, ..., \Ti$ and is defined as follows:
%We formulate the multi-stage stochastic lot sizing problem with substitution as the following dynamic program model:

\begin{subequations}
\label{DynamicProgrammingNoden}
\begin{alignat}{2}
F_{t}(\Vi_{\ti -1}, \Bi_{\ti -1}, \hat{D}^\text{Hist}_\ti) = \min \ & \sum_{\ka \in \KA} \left( c^{\text{setup}}_{\ti \ka}\y_{\ti \ka} + c^{\text{prod}}_{\ti \ka}\x_{\ti \ka} + c^{\text{hold}}_{\ti \ka} {I}_{\ti \ka}+  \sum_{\jey \in \Csub}c^{\text{sub}}_{\ti \ka \jey} \Es_{\ti  \ka \jey}\right) + \quad && \notag \\*[0.1cm]
& \mathbb{E}_{D_{\ti+1}} \left[{F}_{\ti+1}(\Vi_{\ti}, \Bi_{\ti} , {D}^{\text{Hist}}_{\ti+1} |{D}^{\text{Hist}}_{\ti} = \hat{D}^{\text{Hist}}_{\ti})\right] \label{eq:Dyn_g2_Sub_ST_Production_Flow} \\
\text{s.t.} \ & \x_{\ti \ka} \leq M_{\ti \ka} \y_{\ti \ka}  && \forall \ka  \in \KA \label{eq:Dyn_Sub_Setup} \\
& \sum_{\jey \in  \Psub} {S}_{\ti \jey \ka} + \Bi_{\ti  \ka}  = \hat{D}_{\ti \ka} + {\Bi}_{\ti-1, \ka} && \forall \ka  \in \KA \label{eq:Bhat} \\
& \sum_{\jey \in  \Csub} {S}_{\ti \ka \jey} + I_{\ti \ka} = {\Vi}_{\ti-1, \ka}  && \forall \ka  \in \KA  \label{eq:vhat} \\
& \Vi_{\ti \ka} = I_{\ti  \ka} + \x_{\ti  \ka}  && \forall \ka \in \KA \label{eq:vdef} \\
& \mathbb{P}_{D_{\ti+1}}\{ ({\Vi}_{\ti}, {\Bi}_{\ti} ) \in Q(D_{\ti+1} )| D^\text{Hist}_{\ti} = \hat{D}^\text{Hist}_{\ti} \} \geq \alpha \label{eq:SL} \\*[0.1cm]
& {x}_{ \ti },  {v}_{ \ti },  {I}_{ \ti } , {\Bi}_{ \ti } \in \mathbb{R}_{+}^{\Ka} , {S}_{\ti} \in \mathbb{R}_{+}^{|\Graf|} ,{y}_{ \ti } \in \{0,1\}^{\Ka} \label{eq:Dyn_F_Sub_ST_bound1} 
\end{alignat} 
\end{subequations}

\begin{comment}
\begin{subequations}
\label{DynamicProgrammingNoden}
\begin{flalign}
F_{t}(\Vi_{\ti -1}, \Bi_{\ti -1}, \hat{D}^\text{Hist}_\ti) =&  \min && \sum_{\ka \in \KA} \left( c^{\text{setup}}_{\ti \ka}\y_{\ti \ka} + c^{\text{prod}}_{\ti \ka}\x_{\ti \ka} + c^{\text{hold}}_{\ti \ka} {I}_{\ti \ka}+  \sum_{\jey \in \Csub}c^{\text{sub}}_{\ti \ka \jey} \Es_{\ti  \ka \jey}\right) +  & \notag \\
& && \mathbb{E}_{D_{\ti+1}}[{F}_{\ti+1}(\Vi_{\ti}, \Bi_{\ti} , {D}^{Hist}_{\ti+1} |{D}^{Hist}_{\ti} = \hat{D}^{Hist}_{\ti})]&&
\label{eq:Dyn_g2_Sub_ST_Production_Flow}& \\
&\text{s.t.} && \x_{\ti \ka} \leq M_{\ti \ka} \y_{\ti \ka} \quad\quad  \forall \ka  \in \KA & & \label{eq:Dyn_Sub_Setup}&\\
& && \sum_{\jey \in  \Psub} {S}_{\ti \jey \ka} + \Bi_{\ti  \ka}  = \hat{D}_{\ti \ka} + {\Bi}_{\ti-1, \ka} \quad\quad \forall \ka  \in \KA&& \label{eq:Bhat}& \\
& &&\sum_{\jey \in  \Csub} {S}_{\ti \ka \jey} + I_{\ti \ka} = {\Vi}_{\ti-1, \ka}  \quad \forall \ka  \in \KA& \label{eq:vhat}&\\
& &&\Vi_{\ti \ka} = I_{\ti  \ka} + \x_{\ti  \ka}  \quad\quad \forall \ka  \in \KA  &\label{eq:vdef}&
%& v^-_{n \ka} = \Bi_{n  \ka}  \quad \forall \ka  \in \KA \\
\\
& &&\mathbb{P}_{D_{\ti+1}}\{ ({\Vi}_{\ti}, {\Bi}_{\ti} ) \in Q(D_{\ti+1} )| D^\text{Hist}_{\ti} = \hat{D}^\text{Hist}_{\ti} \} \geq \alpha &&\label{eq:SL}&
%\\*[0.2cm]
%& &&F_{\Ti+1}(.) =0 &&\label{eq:lastperiod}&
\\*[0.2cm]
%%%%%%%%%%%%%%%%%%%%%%%
& &&{x}_{ \ti },  {v}_{ \ti },  {I}_{ \ti } , {\Bi}_{ \ti } \in \mathbb{R}_{+}^{\Ka} , {S}_{\ti} \in \mathbb{R}_{+}^{|\Graf|} ,{y}_{ \ti } \in \{0,1\}^{\Ka}&& \label{eq:Dyn_F_Sub_ST_bound1}&
%\\
%&{S}_{n \ka \jey} \geq 0 & \forall(k,j) \in \Graf & \label{eq:Dyn_F_Sub_ST_bound3}&
%\\
%& (I_{\cdot n},\Bi_{\cdot n},\Es_{\cdot n}) \in %\mathcal{X}^{\text{rest}}_\ell &&\label{eq:Dyn_F_Sub_ST_bound4}&
\end{flalign}
\end{subequations}
\end{comment}

%Here, $\Vi_{n{\ka}} =$ current inventory position of product $\ka$. \\
%Note: $I_{n{\ka}}$: the ending inventory of node $n$ for product $\ka$\\

%whereas, the expected cost-to-go function is defined as follows:
%equation (\ref{eq:cost-to-go-exp}).
%\begin{align}
%&\overline{F}_{n}(\Vi_{n}, \Bi_{n}) =  \left\{ 
 % \begin{array}{ c l }
  %  0 & \quad \textrm{if } \mathcal{C}(n) = \emptyset \\
  %  \sum\limits_{m \in \cn}  q_{nm}F_{m}(\Vi_{n}, {\Bi_{n}}  )                 & \quad \textrm{otherwise}
 % \end{array}
%\right.&  
%\label{eq:cost-to-go-exp} 
%\end{align}


 The objective function of the model at time $\ti$ shown as (\ref{eq:Dyn_g2_Sub_ST_Production_Flow}). $F(\cdot) $ represents the optimal objective value from period $\ti$ to the end of the horizon given the initial inventory level vector and backlog vector. More specifically it minimizes the current stage total cost plus the expected cost-to-go function, which includes the total setup cost, production cost, holding cost, and substitution cost. 
 %$\Vi_\ti$ and $\Bi_\ti$ are shorthand for the vectors $\{ v_{\ti \ka}: \ka \in \KA\}$ and $\{ B_{\ti \ka}: \ka \in \KA\}$, respectively.
 {\cred It should be noted that $F_{\Ti+1}(\cdot) =0$.}
Constraints (\ref{eq:Dyn_Sub_Setup}) are the set up constraints which guarantee that when there is production, the setup variable is forced to take the value 1. 
Constraints (\ref{eq:Bhat}) show that the demand of each product is satisfied by its own production and the substitution by other products or it will be backlogged to the next period.
%In this constraint, $\Es_{\ka \ka n}$ is equal to the amount which is allocated to satisfy the demand of product $k$ from its own production. 
Constraints (\ref{eq:vhat}) show that the inventory of product $\ka$ at the beginning of the current period may be used to satisfy its own demand or other products demand through substitution or it will be stored as inventory for future periods. 
Constraints (\ref{eq:vdef}) define the \InvPos at the end of the current period which is equal to the amount of inventory (immediately after demand satisfaction) plus the amount of production during the current period.
%Constraints (\ref{eq:vdef}) are to define the inventory position at the end of current period which is equal to the amount inventory plus the amount of production for the future periods.

Constraint~(\ref{eq:SL}) is to ensure the joint service level for period $\ti+1$ which is modeled as a chance-constraint. In this constraint, $Q(D_ {\ti+1})$ is the set of inventory levels after production and backlog quantities such that customer demands given by $D_{\ti+1}$ can all be met and there is no stock out for any of the products.
\begin{align} Q(D_ {\ti +1}) := \{ (v_{\ti},B_{\ti}) \in \mathbb{R}_{+}^{2\Ka} :  \exists \overline{\Es} \in \mathbb{R}_{+}^{|\Graf|} \ \text{s.t.} \ 
 & \sum_{\jey \in  \Psub} \overline{\Es}_{\jey \ka } = D_{\ti+1,\ka} + \Bi_{\ti\ka} \ \forall \ka  \in \KA  \quad \text{and }\notag \\
 & \sum_{\jey \in  \Csub} \overline{\Es}_{\ka \jey} \leq \Vi_{\ti\ka} \ \forall \ka  \in \KA \} & \label{eq:SetQ}
 \end{align}
  The service level constraint guarantees that the probability of having no stock out in the next period is greater than or equal to $\alpha$. 
 This probability is defined over $D_{\ti+1}$, the demand distribution until period $\ti+1$, having that part of the demand history until period $\ti$ is realized and known. Lastly, constraints~(\ref{eq:Dyn_F_Sub_ST_bound1}) define the domains of different variables in the model.
In addition to these constraints it is possible to add different types of constraints such as capacity constraints to the model.
%For example, if the company decide to satisfy a percentage of each product expected demand  by its own production, the following constraint can be added to the model.

%Considering the infinite-horizon, at each period $\tAct$,
The main goal of our finite-horizon model is to compute $F_{1}(\cdot)$, which is the cost-to-go function for the period $\ti =1$. In this case, $\Vi_{t-1}, \Bi_{t-1}$ are equal to $\hat{\Vi}_{0},\hat{\Bi}_{0}$ which indicate the vectors for the initial state of the system, and the service level constraint is defined for the second period in finite-horizon model.
%(eq (\ref{eq:SL_Root})).
%\begin{subequations}
%\label{DynamicProgramming}
%\begin{flalign}
%&F_{1}(\hat{\Vi},\hat{\Bi}) =  \min  \sum_{\ka \in \KA} \left( c^{\text{setup}}_{\ti(1) \ka}\y_{1 \ka} + c^{\text{prod}}_{\ti(1) \ka}\x_{1 \ka} + c^{\text{hold}}_{\ti(1) \ka} {I}_{1 \ka}+  \sum_{\jey \in \Csub}c^{\text{sub}}_{\ti(1) \ka \jey} \Es_{1  \ka \jey}\right) + \overline{F}_{n}(\Vi_{1}, \Bi_{1}) & \label{eq:Dyn_Root} 
%\end{flalign}
%\begin{align}
%\text{s.t.} \ & \x_{1 \ka} \leq M_{1 \ka} \y_{1 \ka} \quad  &\forall \ka  \in \KA  & \label{eq:Dyn_Sub_Setup_Root}\\
%& \sum_{\jey \in  \Psub} {S}_{1 \jey \ka} + \Bi_{1  \ka}  = \hat{D}_{1 \ka} + \hat{\Bi}_{ \ka} \quad &\forall \ka  \in \KA \label{eq:Bhat_Root} \\
%& \sum_{\jey \in  \Csub} {S}_{1 \ka \jey} + I_{1 \ka} = \hat{\Vi}_{\ka}  \quad &\forall \ka  \in \KA \label{eq:vhat_Root}\\
%& \Vi_{1 \ka} = I_{1  \ka} + \x_{1  \ka}  \quad &\forall \ka  \in \KA  \label{eq:vdef_Root}
%& v^-_{n \ka} = \Bi_{n  \ka}  \quad \forall \ka  \in \KA \\
%& \mathbb{P}_{D_2}\{ ({\Vi}_{1}, {\Bi}_{1} ) \in Q(D_2 )| D^\text{Hist}_{1} = \hat{D}^\text{Hist}_{1} \} \geq \alpha& \label{eq:SL_Root}&
%\\*[0.5cm]
%%%%%%%%%%%%%%%%%%%%%%%
%& {x}_{ 1 },  {v}_{ 1 },  {I}_{ 1 } , {\Bi}_{ 1 } \in \mathbb{R}_{+}^{\Ka} , {S}_{1} \in \mathbb{R}_{+}^{|\Graf|} ,{y}_{ 1 } \in \{0,1\}^{\Ka} &  & \label{eq:Dyn_F_Sub_ST_bound1_Root}
%\\
%&{S}_{n \ka \jey} \geq 0 & \forall(k,j) \in \Graf & \label{eq:Dyn_F_Sub_ST_bound3}&
%\\
%& (I_{\cdot n},\Bi_{\cdot n},\Es_{\cdot n}) \in %\mathcal{X}^{\text{rest}}_\ell &&\label{eq:Dyn_F_Sub_ST_bound4}&
%\end{align}
%\end{subequations}


It should be noted that in this model, the feasibility of the next stage service level should be guaranteed. This can be satisfied if we have at least one uncapacitated production option for each product whether by its own production or substitution. As there is no capacity constraint in our model, this feasibility is guaranteed.
%If at each stage, there exist an unlimited source for production of each of the products or some of the products that can substitute others this feasibility condition is satisfied.

\begin{comment}
{\cred Note: I just keep this red part in case we need to have mathematical proof

In this model, it is not explicit that the recourse stage should be feasible. It is using the convention that if it is infeasible, the value function return infinite cost.}


{\cred * Given stage t and the history, $\xi^t, \exists x^t(\xi^t) \in \chi^t(x^t) \rightarrow v(\xi^t)$\\
$s.t.$ \\
$P_{\xi^{t+1}|\xi^t}\{v^{t}(\xi^t)-\sum_{\jey \in  \Csub}\Es_{kj}(\xi^{t+1})+\sum_{\jey \in  \Psub}\Es_{jk}(\xi^{t+1}) \geq D^{t+1}(\xi^{t+1}) $ for some $\Es_{kj}(\xi^{t+1}) , \Es_{jk}(\xi^{t+1}) \in  \chi ^{t+1}(\xi^{t+1}) \} \geq \alpha$ \\
This can be satisfied for instance if we have at least one uncapacitated product option (whether by its own production or substitution) for each product.

}
\end{comment}


\section{Approximate solution policies}
\label{sec:approx}

In this section, we explain how to make different decisions at each period using different policies. 
These policies map the state of the system to different decisions and can be used in a rolling-horizon framework. 
More specifically, we define a type of policies, namely, \PSpolicy \ to be applied at each period, guided by our proposed multi-stage stochastic programming model, and inspired by the dynamics of the decision-making process, as shown in Figure~\ref{MultistageDynamics}. A \PSpolicy aims to make the setup, production, and substitution decisions such that the service level in the next period can be satisfied.
Ideally, we would solve the multi-stage stochastic programming model, apply its optimal solution for $\ti =1$, update the state of the system based on the observed demand, and repeat this process as we move forward in the rolling-horizon framework. However solving this model is challenging to solve due to its complexity and recursive nature. We hence propose different alternative policies in which we use mixed-integer programming (MIP) models as an approximation of the multi-stage model. We propose two deterministic approximations (average and quantile policies), and a two-stage approximation (chance-constraint policy). 
%We later show that while the deterministic policies have the advantage of faster execution time, the chance-constraint policy result in more accurate solutions.
%In this section we propose different policies to approximate the dynamic programming model proposed in the previous section. %These policies which are approximations for the proposed dynamic programming model (not sure), are MIP based. 
%More specifically, we define the policies to be applied at each period, inspired by the dynamics of the decision-making process, where two groups of decisions are made as shown in Figure~\ref{MultistageDynamics}. 

%A \PSpolicy aims to decide on the setup, production, and substitution decisions such that the service level in the next period can be satisfied.
In our multi-stage model and similarly in its approximations, we consider the next period demand where we have the uncertainty, due to one period delay in the order arrivals, whether by considering its expected value, quantile value, or the service level.  Therefore, it is possible that in period 1, based on the solution of the model we do not meet all demands, or even reach the service level even though our model would generally prioritize meeting demands when possible.  
In other words, model~(\ref{DynamicProgrammingNoden}) and its approximation policy models do not impose any constraints to minimize the amount of backorder or satisfy the service level in the first period after the demand is observed. 
To resolve this challenge, in each issue, we first apply an initial step in which we focus on satisfying the current period observed demand. 
In this step, we  define which product observed demand has the potential to be fully satisfied without any backlog, and based on this result extra constraints will be added to the first planning period of the policy model. 
%The decisions of the current period, suggested by the \PSpolicy are implemented, the state of the system is updated based on the observed demand, and this process is repeated as we move forward in the rolling-horizon framework.
This initial step and different types of \PSpolicy \ are explained in detail in the following sections. 
\begin{comment}


%Additional notation used in the policy models, are presented in Table~\ref{tab:Sub_Policy_parameters}. 

\begin{table}[H]
\centering
\caption{Notation for new parameters and decision variables for decision policies}
\begin{adjustbox}{width=1\textwidth,center=\textwidth}
\begin{tabular}{ll}
\toprule
{\textbf {Sets}} & {\textbf {Definition}} \\ \midrule
%$\hat{\TI}$  & Set of actual planning periods of infinite-horizon, indexed by $1, ..., \hat{\ti}, ... ,\hat{\Ti}$ \\ 
%$ \mathcal{N} $  & Set of nodes in the scenario tree \\
$ \EM $  & Set of scenarios \\
\midrule 
{\bf Parameters} & {\bf Definition} \\ \midrule
$\hat{B}_{0, \ka}$  & The amount of initial backlog for product $\ka$ (current state)\\
$\hat{v}_{0, \ka}$  & The amount of initial inventory level for product $\ka$ (current state) \\
$\mathbb{Q}_{i}({D}_{\ti \ka})$& The $i^{th}$ percentile of the demand over all scenarios for product $\ka$ in period $\ti$\\
$q_{nm} $&  The probability of child node $m$ from node $n$  \\
\midrule
{\bf Decision variables} & {\bf Definition} \\ \midrule
$z_{m}$ & Binary variable which is equal to 1 if the joint service level is satisfied for child node $m$, 0 otherwise \\ 
\bottomrule
\end{tabular}
\end{adjustbox}
 \label{tab:Sub_Policy_parameters}
\end{table}
\end{comment}

 \subsection{Backlog determination in the first period }

%In each period, when we apply a \PSpolicy, considering the one period delay in the order arrivals, the service level is considered for the next period demand where we have the uncertainty. Therefore, it is possible that in the current period it will not be possible to meet all demands, or even reach the service level even though our model would generally prioritize meeting demands when possible.  
The backlog determination step is a prerequisite for a \PSpolicy \ which focuses on substitution, inventory and backlog decisions only for the first period to satisfy period $\ti =1$ demand {(or rather to guarantee the feasibility of the current-stage demand satisfaction).} 
To this end, we solve the linear programming (LP) model~(\ref{Currentstage}) which minimizes the total backlog in the current period (corresponding to $\ti=1$ in the model). This is also applicable in reality, as the companies try to satisfy their available orders simultaneously as much as possible. The result of this model is a subset of products for which it is possible to fully satisfy their demand without any backlog. We then force the backlog for this subset equal to zero in period 1 in \PSpolicy \ model. 
It should be noted that in this step, we do not define how the demand should be satisfied, and this will be later defined in the \PSpolicy. The mentioned LP model is presented as follows:
%(question: The $\ti$ index should be 1 or $\tAct$)


\begin{subequations}
\label{Currentstage}

\begin{alignat}{2}
\min \ & \sum_{\ka \in \KA}  {B}_{ 1 \ka}  \label{eq:Current_obj} \\
 \text{s.t.} \ &   \sum_{\jey \in  \Psub} {S}_{1  \jey \ka} + B_{1 \ka}  = \hat{D}_{1 \ka} + \hat{B}_{0 \ka} &&\qquad\forall \ka \in \KA       \label{eq:Current_inventory_tn}\\
&  \sum_{\jey \in  \Csub} {S}_{1 \ka \jey} + I_{ 1 \ka} = \hat{v}_{ 0 \ka} &&\qquad\forall \ka \in \KA      \label{eq:Current_Orderup}\\
& {I}_{ 1 }, {B}_{ 1 } \in \mathbb{R}_{+}^{\Ka} , {S}_{1} \in \mathbb{R}_{+}^{|\Graf|}  \label{eq:Current_bound2}
\end{alignat}
\end{subequations}

The objective function (\ref{eq:Current_obj}) is to minimize the total backlog. Constraints (\ref{eq:Current_inventory_tn}) guarantee that the demand and backlog is either satisfied in the current period or it will be backlogged. Constraints (\ref{eq:Current_Orderup}) show that the available inventory is either used to satisfy the demand of different products, or will be stored as an inventory.
If the optimal value of  $B_{ 1 \ka}$  is equal to zero, we add product $\ka$ to set $\hat{\KA}$. Constraints $B_{ 1 \ka} = 0$ will be added to the model of the \PSpolicy \ for all $ \ka \in \hat{\KA}$. How the demand of this product is satisfied is also defined in the policy model based on different cost parameters.

It should be noted that it is also possible to use other models in this step. For example, minimizing the backlog for each product separately. However, it is not possible to consider substitution option as the products should not have link together. Another option is to add some constraints in the policy model to satisfy the service level, however we may have infeasibility issue, or in case of using soft constraints, we have the challenge of parameter tuning.

The advantage of our proposed method is its simplicity and the fact that it can be easily applied to different versions of \PSpolicy \ by adding extra constraints. In addition, minimizing the total backlog is in line with the notion of joint service level and the possibility of substitution. It is also possible to minimize the weighted sum of backlog, in case the company has priority in satisfying different products demand. 

\subsection{Decision policy} %% it's not just product substitution -- it's all decisions
At period $\ti =1$, based on the current state of the system we apply a \PSpolicy, which takes $\hat{v}_{0}, \hat{B}_{0}$, $\hat{D}_1$, and the set $\hat{\KA}$ from backlog determination step as inputs. 
%This policy approximates the dynamic programming model (\ref{DynamicProgrammingNoden}) at $\ti =1$, which is challenging to solve {\cred due to its complexity and recursive nature.}
%(\ref{DynamicProgrammingNoden}).
%Appr$(\tAct,\hat{v}_{\tAct-1}, \hat{B}_{\tAct-1 })$, which is an approximation for the dynamic programming model at the root node.
%(\ref{DynamicProgramming}).
In this section, we explain two policies with deterministic models (average and quantile policies) and a policy with a chance-constrained two-stage stochastic programming model (chance-constraint policy) as an approximation for the multi-stage model.
We later show that while the deterministic policy models have the advantage of faster execution time, the chance-constraint policy model results in more accurate solutions.
%This policy can be a deterministic policy or any other approximation policies.
\begin{figure} [H]
    \centering 
    \subfloat[\centering Average policy ]{{\includegraphics[width=5cm]{Average.png} }}%
   % \quad
    \subfloat[\centering Quantile policy ]{{\includegraphics[width=5cm]{Quantile.png} }}%
    \subfloat[\centering Chance-constraint policy ]{{\includegraphics[width=5.3cm]{Chance constraint.png} }}%
    \caption{Demand approximation in different decision policies}%
    \label{fig:DemandPolicy}%
\end{figure}


  
\subsubsection{Deterministic policies}

%To evaluate the value of the  stochastic  model, we can compare it against the deterministic models applied in a rolling-horizon environment.
In these policies, we represent the future demand by a single scenario, and we propose two different deterministic policies based on that. 
These policies' model approximate the dynamic programming model
%at the root node
%model~(\ref{DynamicProgramming}) 
by eliminating the chance-constraint and substituting the stochastic demand  with the deterministic value.
%, and solve the resulting lot sizing model. 
In the first policy, namely the ``average policy", the stochastic demand for all the products and in all periods is substituted by its expected value. The second policy which is called the ``quantile policy" differs from the ``average policy" by substituting the stochastic demand for the next immediate period (which corresponds to $\ti =2$) by the quantile of the future demand distribution, which is defined based on the service level. Figure~\ref{fig:DemandPolicy} illustrates the demand pattern for the average and quantile policies in sub-figures (a) and (b), respectively. For both of these policies, we assume that there is no backlog for $\ti > 1$, which means that we should at least satisfy the expected demand in all future periods.
%This model can be solved in a receding horizon environment, in which the first period/stage decision is fixed and the information such as initial inventory and backlog will be updated based on the realized demand. This procedure repeated until the last period. 
%We will next present two deterministic policies.
Model (\ref{mod:Det}) represents the ``average policy".


 
\begin{subequations}
\label{mod:Det}

\begin{alignat}{2}
\min \ & \sum_{\ti \in \TI} \sum_{\ka \in \KA} \left( c^{\text{setup}}_{\ti \ka}y_{\ti \ka} + c^{\text{prod}}_{\ti \ka}x_{\ti \ka}+ c^{\text{hold}}_{\ti \ka}I_{\ti \ka} +\sum_{\jey \in  \Csub}c^{\text{sub}}_{\ti \ka \jey} S_{\ti \ka \jey}  \right) 
%+ bc_{\ti \ka} {B}_{\ti \ka} )
& \label{eq:Sub_Det_obj} \\
\text{s.t.} \ & \  x_{\ti \ka} \leq M_{\ti \ka} y_{\ti \ka} &&  \forall \ti  \in \TI, \forall \ka \in \KA  \label{eq:Sub_Det_Setup}\\
  &  \sum_{\jey \in  \Psub} {S}_{1  \jey \ka} + B_{1 \ka}  = \hat{D}_{1 \ka} + \hat{B}_{0\ka} &&\forall \ka\in \KA       \label{eq:Det_inventory_1}\\
   &  \sum_{\jey \in  \Psub} {S}_{\ti \jey \ka} + B_{\ti \ka} = \mathbb{E}[{D}_{\ti \ka}] + {B}_{\ti-1 , \ka} &&\forall \ti \in \TI \setminus\{1\},\forall \ka\in \KA      \label{eq:Det_inventory_2} \\
&  \sum_{\jey \in  \Csub} {S}_{1 \ka \jey} + I_{ 1 \ka} = \hat{\Vi}_{0\ka} &&\forall \ka \in \KA       \label{eq:Det_inventory_3}\\
&  \sum_{\jey \in  \Csub} {S}_{\ti \ka \jey} + I_{\ti \ka} = \Vi_{\ti-1 , \ka} &&\forall \ti  \in \TI \setminus\{1\},\forall \ka \in \KA       \label{eq:Det_inventory_4}\\
%&  I_{ \ti(n) \ka} - B_{ \ti(n) \ka} = \hat{v}_{\ti(n)-1 , \ka} - \sum_{\jey \in  \Csub} {S}_{\ti(n) \ka \jey} + \sum_{\jey \in  \Psub} {S}_{\ti(n)  \jey \ka}  - \hat{D}_{n \ka} \quad &\forall \ka \in \KA  &     \label{eq:Det_inventory_tn}&\\
%& v_{ \ti(n) \ka} = I_{ \ti(n) \ka} + x_{ \ti(n) \ka}  \quad &\forall \ka \in \KA  &     \label{eq:Det_inventoryPos_tn}& \\
%&  I_{\ti \ka} - B_{\ti \ka} = v_{\ti-1 , \ka} - \sum_{\jey \in  \Csub} {S}_{\ti \ka \jey} + \sum_{\jey \in  \Psub} {S}_{\ti \jey \ka}  - E_{|n}[\overline{D}_{\ti \ka}] \quad &\forall \ti  \in \TI, t > t_{n},\forall \ka \in \KA  &     \label{eq:Dyn_F_Sub_ST_Service}&\\
& v_{\ti \ka} = I_{\ti \ka} + x_{\ti \ka}  \quad &&\forall \ti  \in \TI,\forall \ka \in \KA  \label{eq:Det_inventory_5} \\
%&\sum_{\ka \in \KA} (st_{\ti \ka}y_{\ti \ka} + pt_{\ti \ka}x_{\ti \ka}) \leq Cap_{t} & \forall t  \in T ,  t\geq \ti(n)   & \label{eq:Sub_FD_Capacity}  \\
&\Bi_{1 \ka} =0 &&\forall  \ka \in \hat{\KA} \label{eq:Backlog_determination}\\
&\Bi_{\ti \ka} =0 {\cred\text{we can eliminate this constraint by totally eliminate B in 6}}&&\forall \ti \in \TI \setminus\{1\}, \label{eq:Det_Back}\\
&  {x}_{ \ti },  {v}_{ \ti },  {I}_{ \ti} , {\Bi}_{ \ti } \in \mathbb{R}_{+}^{\Ka} , {S}_{\ti} \in \mathbb{R}_{+}^{|\Graf|} ,{y}_{ \ti } \in \{0,1\}^{\Ka} &&\forall \ti \in \TI  \label{eq:Sub_FD_bound2}
\end{alignat}
\end{subequations}

The objective function (\ref{eq:Sub_Det_obj}) minimizes the total cost of setup, production, holding and substitution cost. Constraints (\ref{eq:Sub_Det_Setup}) guarantee that in each planning period, when there is a production, there will be a setup. Tight big-M values for these constraints can calculated as follows:
{\cred{
\begin{alignat}{2}
  &  M_{\ti \ka} = \hat{B}_{0 \ka}+ \sum_{\jey \in  \Csub}\left( {\hat{D}}_{\ti \jey} + \sum_{\ti = 2 }^\Ti \mathbb{E}[{D}_{\ti \jey}]\right)  &&\qquad \forall \ti \in \TI ,\forall \ka \in \KA   
  \label{eq:BigM_Deterministic_Appr}
  \end{alignat}}}
Constraints (\ref{eq:Det_inventory_1}) to (\ref{eq:Det_inventory_4}) are the inventory, backlog, and substitution balance constraints, which are defined for $\ti=1$ and $\ti > 1$ separately. Constraints (\ref{eq:Det_inventory_5}), define the available inventory after production. Constraints (\ref{eq:Det_Back}) show that the backlog is equal to zero for $\ti > 1 $ which guarantee the average demand satisfaction in those periods. Constraints (\ref{eq:Backlog_determination}) are defined based on the result of backlog determination step and force the backlog equal to 0 in the first period for all the products in set $\hat{\KA}$.


The quantile policy model is the same as model (\ref{mod:Det}), except for one set of constraints. In this policy, for $\ti =2$ constraints (\ref{eq:Det_inventory_2}) are replaced by constraints (\ref{eq:Quan_inventory_2}). The difference between the average policy and the quantile policy is that in the second period, where we need to consider the service level, the average demand is replaced by the $\alpha$ quantile of the demand, denoted by $\mathbb{Q}_{\alpha}$. %This percentile is defined by the service level $\alpha$. 
In the quantile policy the $M$ values in constraints~(\ref{eq:Sub_Det_Setup}) are calculated by equations~(\ref{eq:BigM_Quantile_Appr}).
\begin{alignat}{2}
    & \sum_{\jey \in  \Psub} {S}_{2 \jey \ka} + B_{2 \ka} = \mathbb{Q}_{\alpha}({D}_{2 \ka}) + {B}_{1 \ka} && \quad \quad \forall \ka \in \KA  \label{eq:Quan_inventory_2} \\
     &  M_{\ti \ka} = \hat{B}_{0 \ka}+ \sum_{\jey \in  \Csub}\left( {\hat{D}}_{\ti \jey} + \mathbb{Q}_{\alpha}({D}_{2 \jey})+ \sum_{\ti =3}^\Ti\mathbb{E}[{D}_{\ti \jey}]\right)  &&\qquad \forall \ti \in \TI , \forall \ka \in \KA   
  \label{eq:BigM_Quantile_Appr}
     \end{alignat}


\subsubsection{Chance-constraint policy}

The deterministic policies that we explained in the previous section did not consider the service level constraint explicitly in their models. To consider the service level we add a chance constraint to the deterministic policy models in the second period. To this end, we consider a set of demand scenarios, $\EM$, for period $\ti =2$. $D^{\m}_{\ti\ka}$ denotes the demand of product $\ka \in \KA$ in period $\ti \in \TI$ under scenario $\m \in \EM$. The drawback of this idea is that it fails to capture the cost of substitution implicit in the chance constraint. To solve this issue, we consider different cost elements for each single scenario $\m \in \EM$, in addition to defining the service level constraint using these scenarios. 
For periods $\ti > 2$, the stochastic demand is substituted by its expected value, similar to the deterministic policies. The demand pattern used in this policy in depicted in sub-figure (c) in Figure~\ref{fig:DemandPolicy}. 
We next present the mathematical model for this policy. In addition to previous decision variables, new decision variables are defined for each of the scenarios in the period $2$. In this model, $I'^{\m}_{\ti \ka }$ and $B'^{\m}_{\ti \ka}$ denote the inventory and backlog at period $\ti$  for product $\ka$ under scenario $\m$, respectively. $\Es'^{\m}_{\ti \ka \jey}$ represents the substitution amount of product $\ka$ for product $\jey$ at period $\ti$ under scenario $\m$. The mentioned variables are then connected to the related variable in period 3 by using additional constraints in the model. This model is presented as follows:
\begin{subequations}
\label{mod:ChanceConstraintpolicy}

\begin{alignat}{2}
\min \ &
\sum_{\ka \in \KA} \left( c^{\text{setup}}_{ 1 \ka}y_{ 1 \ka} + c^{\text{prod}}_{ 1 \ka}x_{ 1 \ka}+ \sum_{\jey \in  \Csub}c^{\text{sub}}_{1 \ka \jey} S_{1 \ka \jey}  + c^{\text{hold}}_{ 1 \ka}I_{ 1 \ka} \right) 
%+ bc_{ 1 \ka} {B}_{ 1 \ka} ) 
+ \notag \\
&\sum_{\ka \in \KA} \left( c^{\text{setup}}_{ 2 \ka}y_{2  \ka} + c^{\text{prod}}_{ 2 \ka}x_{2  \ka}+  c^{\text{hold}}_{2  \ka}I_{2  \ka} + c^{\text{back}}_{2 \ka} {B}_{2  \ka} + \frac{1}{\Em} \sum_{\m \in \EM} \sum_{\jey \in  \Csub}  c^{\text{sub}}_{2\ka\jey}   \Es'^{\m}_{2\ka\jey } \right) && + \notag \\
& \sum_{t =3 }^{T} \sum_{\ka \in \KA} \left( c^{\text{setup}}_{\ti \ka}y_{\ti \ka} + c^{\text{prod}}_{\ti \ka}x_{\ti \ka}+ \sum_{\jey \in  \Csub}c^{\text{sub}}_{\ti \ka \jey} S_{\ti \ka \jey}  + c^{\text{hold}}_{\ti \ka}I_{\ti \ka} \right) %+ c^{\text{back}} {B}_{\ti \ka} )
 \label{eq:Sub_Roll_obj_ext} \\
\text{s.t.} \  & \ x_{\ti \ka} \leq M_{\ti \ka} y_{\ti \ka} &&  \forall \ti  \in \TI   ,\forall \ka \in \KA  \label{eq:Sub_cc_Setup}\\
  &  \sum_{\jey \in  \Psub} {S}_{1  \jey \ka} + B_{1 \ka}  = \hat{D}_{1 \ka} + \hat{B}_{0 \ka} &&\forall \ka \in \KA       \label{eq:Det_backorder_tn}\\
  &  \sum_{\jey \in  \Csub} {S}_{1 \ka \jey} + I_{ 1 \ka} = \hat{v}_{0  \ka} &&\forall \ka \in \KA       \label{eq:Det_inventory_tn}\\
   &  \sum_{\jey \in  \Psub} {S}_{\ti \jey \ka} + B_{\ka \ti}  = \mathbb{E}[{D}_{\ti \ka}] + {B}_{\ti -1 ,\ka} &&\forall \ti  \in \TI, \ti > 2,\forall \ka \in \KA     \label{eq:Det_backorder_ext} \\
&  \sum_{\jey \in  \Csub} {S}_{\ti \ka \jey} + I_{\ti \ka} = v_{\ti-1 , \ka} &&\forall \ti  \in \TI, t > 2,\forall \ka \in \KA       \label{eq:Det_inventory_ext}\\
& v_{\ti \ka} = I_{\ti \ka} + x_{\ti \ka}  \quad &&\forall \ti  \in \TI,\forall \ka \in \KA  \label{eq:Chance_OrderUpTo} \\
&\Bi_{1 \ka} =0 &&\forall  \ka \in \hat{\KA} \label{eq:Backlog_determination_CC}\\
&\Bi_{\ti \ka} =0 {\cred\text{we can eliminate this constraint by eliminate B in 7g}}&&\forall \ti \in \TI \setminus\{1,2\}, \forall \ka \in \KA \label{eq:chance_Back}\\
%&  I_{ \ti(n) \ka} - B_{ \ti(n) \ka} = \hat{v}_{\ti(n)-1 , \ka} - \sum_{\jey \in  \Csub} {S}_{\ti(n) \ka \jey} + \sum_{\jey \in  \Psub} {S}_{\ti(n)  \jey \ka}  - \hat{D}_{n \ka} \quad &\forall \ka \in \KA  &     \label{eq:Det_inventory_tn}&\\
%& v_{ \ti(n) \ka} = I_{ \ti(n) \ka} + x_{ \ti(n) \ka}  \quad &\forall \ka \in \KA  &     \label{eq:Det_inventoryPos_tn}& \\
%&  I_{\ti \ka} - B_{\ti \ka} = v_{\ti-1 , \ka} - \sum_{\jey \in  \Csub} {S}_{\ti \ka \jey} + \sum_{\jey \in  \Psub} {S}_{\ti \jey \ka}  - E_{|n}[\overline{D}_{\ti \ka}] \quad &\forall \ti  \in \TI, t > t_{n},\forall \ka \in \KA  &     \label{eq:Dyn_F_Sub_ST_Service}&\\
 &  \sum_{\jey \in  \Psub} {S'}^{\m}_{2 \jey \ka} + B'^{\m}_{2  \ka }  = D^ {\m}_{\ka} + {B}_{1  \ka} &&\forall \ka \in \KA, \forall \m \in \EM     \label{eq:Det_backorder_tnp} \\
&  \sum_{\jey \in  \Csub} {S'}^{\m}_{2 \ka \jey} + I'^{\m}_{2  \ka} = v_{1  \ka} &&\forall \ka \in \KA, \forall \m \in \EM       \label{eq:Det_inventory_tnp}\\
& \frac{1}{\Em} \sum_{\m \in \EM} I'^{\m}_{2 \ka } = I_{2 \ka} &&\forall \ka \in \KA  \label{eq:Average_Inventory} \\
& \frac{1}{\Em} \sum_{\m \in \EM} B'^{\m}_{2 \ka} = B_{2 \ka} &&\forall \ka \in \KA  \label{eq:Average_Backlog}\\
& \sum_ {\m \in \EM}  \mathds{1} {\{ ({\Vi}_{1}, {\Bi}_{1} ) \in Q(D^ {\m}_{\ka} ) \}} \geq \lceil \alpha |\EM|  \rceil \label{eq:chance_ServiceLevel}\\
&{x}_{ \ti },  {v}_{ \ti },  {I}_{ \ti} , {\Bi}_{ \ti } \in \mathbb{R}_{+}^{\Ka} , {S}_{\ti} \in \mathbb{R}_{+}^{|\Graf|} ,{y}_{ \ti } \in \{0,1\}^{\Ka} \label{eq:Sub_FD_bound3}
\end{alignat}

  \end{subequations}
  
To have a more clear description, the objective function of the extensive form model (\ref{eq:Sub_Roll_obj_ext}) has broken into three parts, the cost of period 1, the cost of period $2$, and the cost of periods $3$ to $\Ti$. In period $2$, the substitution cost is defined for each of the scenarios separately and the average substitution cost over all scenarios is used as the total substitution cost. {\cred Only in this period, we also consider backlog cost so that the cost function matches with the service level constraint.} 
 
Constraints~(\ref{eq:Sub_cc_Setup}) are production setup constraints for which the value of $M$ is calculated using equation~\ref{eq:BigM_CC_Appr}. Constraints (\ref{eq:Det_backorder_tn}) to (\ref{eq:Det_inventory_ext}) are the inventory, backlog, and substitution balance constraints.
Constraints (\ref{eq:Det_backorder_tn}) and (\ref{eq:Det_inventory_tn}) are for period $1$ period and constraint (\ref{eq:Det_backorder_ext}) and (\ref{eq:Det_inventory_ext}) are for the periods $3$ to $\Ti$.  Constraints (\ref{eq:Chance_OrderUpTo}) define the inventory after production.
 
 
 
 {\cred{
\begin{alignat}{2}
  &  M_{\ti \ka} = \hat{B}_{0 \ka}+  \sum_{\jey \in  \Csub}\left( {\hat{D}}_{\ti \jey} + \max_{\m \in \EM} {D}^{\m}_{2 \jey}+ \sum_{\ti =3}^\Ti \mathbb{E}[{D}_{\ti \jey}]\right)  &&\qquad \forall \ti \in \TI ,\forall \ka \in \KA   
  \label{eq:BigM_CC_Appr}
  \end{alignat}}}
 
Constraints (\ref{eq:Det_backorder_tnp}) and (\ref{eq:Det_inventory_tnp}) are the inventory, backlog, and substitution balance constraints for period $2$ and each individual scenario.  
Constraints (\ref{eq:Average_Inventory}) and (\ref{eq:Average_Backlog}) recombine the scenarios in period 2 and link the average inventory and backlog over all scenarios in this period to the inventory and backlog amount in the same period. These averages are used in the inventory and backlog balance constraints for period $3$.
Constraint (\ref{eq:chance_ServiceLevel}) is the service level constraint in which the sum of feasible scenarios based on the values of $\Vi_1$ and $B_1$ should be greater than $\alpha$ percent of the number of scenarios. This model is challenging to solve mostly due to the constraints for the joint service level. In the next section we propose an efficient branch-and-cut algorithm to solve this model.\\


    
 
  
  \section{Solving the chance-constrained model}
  
  We now discuss how to solve the proposed model \eqref{mod:ChanceConstraintpolicy}.
We first present a MIP formulation for the service level constraint~(\ref{eq:chance_ServiceLevel}) based on the demand scenario set $\EM$, and then substitute it with the service level constraint in model~\eqref{mod:ChanceConstraintpolicy}. 
  
We define the binary variables $\Zed_\m$, where $\Zed_\m=0$ indicates the available inventory is adequate to meet demands in scenario $\m$ without backlogging, and $\Zed_\m=1$ otherwise. $\Bc^ {\m}$ represents the backlog vector and $\Sc^{\m}$ represents the substitution vector for scenario $\m$. The joint chance constraint~(\ref{eq:chance_ServiceLevel}) in model~(\ref{mod:ChanceConstraintpolicy}) is then replaced by constraints~(\ref{eq:Backorder_Child})-(\ref{eq:Child_Service}). It should be noted that it is possible to use the previously defined decision variables for each of the scenarios (namely $B'^{\m}_{\ti \ka \jey}$ and $\Es'^{\m}_{\ti \ka \jey}$) in the resulting extensive formulation. However, as the branch-and-cut algorithm is used to only deal with the joint chance constraint MIP formulation, we need to define a separate set of decision variables for this set of constraints. To match the service level constraint and the objective function cost for each scenario and the service level constraint, we need to tune the backlog cost parameter, $c^{\text{back}}_{2 \ka}$, in~(\ref{eq:Sub_Roll_obj_ext}).
 %The MIP model for this problem is as follows in which the constraint (\ref{eq:SL_Root}) is represented as constraints (\ref{eq:Backorder_Child} - \ref{eq:Child_Service}).
  %, in which $M'_{km}$ is defined by (\ref{eq:BigM_Child}).
  
  \begin{subequations}
\label{mod:chanceconstraintBigM}
  \begin{alignat}{2}
  & \Bc^ {\m}_{\ka } +\sum_{\jey \in \Psub} \Sc^{\m}_{\jey \ka} = D^ {\m}_{\ka}  +\Bi_{1 \ka}  && \qquad \forall \m \in \EM, \forall \ka  \in \KA \label{eq:Backorder_Child}\\
  & \sum_{\jey \in \Csub} \Sc^{\m}_{\ka \jey} \leq \Vi_{1 \ka}   &&\qquad \forall \m \in \EM, \forall \ka  \in \KA \label{eq:OrderUptoLevel_Child}\\
&  \Bc^ {\m}_{\ka} \leq \overline{M}^{\m}_{\ka }\Zed_{ \m}  && \qquad \forall \m \in \EM , \forall \ka  \in \KA     \label{eq:Child_Service_1}\\
&  \sum_{\m \in \EM} \Zed_\m \leq \lfloor (1-\alpha) |\EM|  \rfloor  && \qquad      \label{eq:Child_Service}
 \end{alignat}
 

Constraints~\eqref{eq:Backorder_Child} and \eqref{eq:OrderUptoLevel_Child} define the backlog and substitution for each scenario $\m$. Constraints~(\ref{eq:Child_Service_1}) guarantee that when there is a backlog for any of the product in scenario $\m$, the indicator variable is turned on, i.e., $\Zed_{ \m} =1$. In these constraints, the $\overline{M}$ values are defined using equation~(\ref{eq:BigM_Child}). Constraint~(\ref{eq:Child_Service}) is the service level constraint.
\begin{alignat}{2}
 & \overline{M}^{\m}_{\ka }=  D^ {\m}_{\ka} + \hat{D}_{1 \ka} + \hat{\Bi}_{0 \ka}  && \qquad \qquad \forall \m \in \EM , \forall \ka  \in \KA      \label{eq:BigM_Child} 
 \end{alignat}
 \end{subequations}

Constraints~(\ref{eq:Child_Service_1}) make the mathematical model challenging to solve, therefore, we propose a branch-and-cut algorithm to solve the extensive form of the two-stage chance constrained  formulation. This method is based on the algorithm proposed by Luedtke~\cite{luedtke2014branch} for joint chance constraints, which is tailored for our problem. 
 %In this model, the binary variables are $\Zed_m$, where $\Zed_m=0$ indicates the current inventory position is adequate to meet demands in child node $m$ without backordering, and $\Zed_m=1$ otherwise, 
 Considering variable $\Zed_\m$ for each $\m \in \EM$, when $\Zed_m=0$, we should enforce that $\Vi_{1}, \Bi_{1}$ lie within the $Q(D^{\m})$ polyhedron.
\begin{align*} Q(D^\m) := \{ (\Vi,\Bi) \in \mathbb{R}_+^{2\Ka} :  \exists \Sc^\m \in \mathbb{R}_+^{|\Graf|}  \ \text{s.t.} \ 
 & \sum_{\jey \in  \Psub} \Sc^\m_{\jey \ka } = D^ {\m}_{\ka} + \Bi_{1\ka} \ \forall \ka  \in \KA \ \ \text{and} \\
 & \sum_{\jey \in  \Csub} \Sc^\m_{\ka \jey} \leq \Vi_{1\ka} \ \forall \ka  \in \KA \}
 \end{align*}
 
\newcommand{\vsol}{\hat{\Vi}}
\newcommand{\zsol}{\hat{\Zed}}
\newcommand{\bsol}{\hat{\Bi}}
\newcommand{\pisol}{\hat{\pi}}
\newcommand{\betasol}{\hat{\beta}}

To solve the model, we consider a  master problem where we eliminate constraints~(\ref{eq:Backorder_Child})-(\ref{eq:Child_Service_1}) from the extensive form of the model. Assume we have solved a master problem and obtained a solution $(\zsol_1,\vsol_1,\bsol_1)$ for period 1. Note that this solution may or may not satisfy the integrality constraints (e.g., if we have solved an LP relaxation of the master problem). Given a demand scenario $\m \in \EM$ with $\zsol_1^\m < 1$, our task is to assess if $(\vsol_1,\bsol_1) \in Q(D^\m)$, and if not, attempt to generate a cut to remove this solution. In the case of an integer feasible solution, we will always be able to do so when $(\vsol_1,\bsol_1) \notin Q(D^\m)$.

We can test if given $(\vsol_1,\bsol_1) \in Q(D^\m)$ by solving the following LP:
\begin{alignat}{3}
V_\m(\vsol_1,\bsol_1) :=  \min_{w,\Sc^\m} \ & \sum_{\ka  \in \KA} w_\ka \notag\\
    \text{s.t. } & \sum_{\jey \in  \Psub} \Sc^\m_{\jey \ka } + w_\ka = D^ {\m}_{\ka} + \bsol_{1\ka} \quad  &&\forall \ka  \in \KA && \qquad(\pi_\ka) \notag\\
    &-\sum_{\jey \in  \Csub} \Sc^\m_{\ka \jey} \geq -\vsol_{1\ka} \ && \forall \ka  \in \KA&& \qquad (\beta_\ka) \notag\\
    & \ w \in \mathbb{R}_+^{\Ka}, \Sc^\m \in \mathbb{R}_+^{|\Graf|} \notag
\end{alignat}
By construction, $(\vsol_1,\bsol_1) \in Q(D^\m)$ if and only if $V_\m(\vsol_1,\bsol_1) \leq 0$, which means that there is no backlog for this scenario. Furthermore, if $(\pisol,\betasol)$ is an optimal dual solution, then by weak duality, the cut
 \[ \sum_{\ka  \in \KA} \pisol_k (D^ {\m}_{\ka} + \Bi_{1\ka}) - \sum_{\ka  \in \KA} \betasol_\ka \Vi_{1\ka} \leq 0 \]
is a valid inequality for $Q(D^\m)$. Rearranging this, it takes the form:
\[ \sum_{\ka  \in \KA} \betasol_{1\ka} \Vi_{1\ka} - \sum_{\ka  \in \KA} \pisol_k \Bi_{1\ka}  \geq  \sum_{\ka  \in \KA} \pisol_k D^ {\m}_{\ka}. \]
If $V_\m(\vsol_1,\bsol_1) > 0$ then the corresponding cut will be violated by $(\vsol_1,\bsol_1)$. 

The inequality derived above is only valid when $\Zed_\m = 0$. We thus need to modify it to make it valid for the master problem.
To derive strong cuts based on this base inequality, we can solve an additional set of subproblems once we have the coefficients $(\pisol,\betasol)$. In particular, for every scenario $\m'$, we can solve:
\begin{alignat}{2}
%h_{m'}(\pisol,\betasol) :=
\min_{v_1,B_1,\Es_1,\Sc^{\m'}} \ & \sum_{\ka  \in \KA} \betasol_\ka \Vi_{1 \ka} - \sum_{\ka  \in \KA} \pisol_k \Bi_{1  \ka} \notag\\
\text{s.t. } &  \sum_{\jey \in  \Psub} \Sc^{\m'}_{\jey \ka } = D_{\ka}^{\m'} + \Bi_{1  \ka} \ &&\qquad \forall \ka  \in \KA \notag \\
    &\sum_{\jey \in  \Csub} \Sc^{\m'}_{\ka \jey } \leq \Vi_{1 \ka} \ && \qquad\forall \ka  \in \KA \notag \\
    & \sum_{\jey \in  \Psub} {S}_{1 \jey \ka} + \Bi_{1  \ka}  = D_{1 \ka} + \hat{\Bi}_{0 \ka} \quad && \qquad\forall \ka  \in \KA \notag\\
    & \sum_{\jey \in  \Csub} {S}_{1 \ka \jey} \leq \hat{\Vi}_{0 \ka}  && \qquad\forall \ka  \in \KA \notag\\
    & \Vi_1 , \Bi_1 \in \mathbb{R}_{+}^{\Ka}, \ \Es_1, \Sc^{\m'}  \in \mathbb{R}_+^{|\Graf|}  \notag
\end{alignat}
Note that in this problem we consider substitution variables both for the period $1$ and for each scenario in period 2 under consideration, $\m'$. The substitution variables for the scenario $\m'$ are to enforce that $(\Vi_1,\Bi_1) \in Q({D^{\m'}})$. The substitution variables for the period 1 are to enforce that $B$ satisfies the scenario constraints. 
%Note that we could also require $v$ to satisfy the current period constraints, by introducing the $I_{1 \ka}$ and $\x_{1 \ka}$ variables and including the constraints \eqref{eq:vdef}, and any constraints on the $x$ variables, such as capacity constraints. However, if our test instances do not have capacity restrictions, this would not likely to be helpful, so we have left this out for simplicity.

%{\bf Potential faster cut generation.} 
{Considering $h_{\m'}(\pisol,\betasol)$ as any lower bound on the optimal objective value, $V_{\m'}(\vsol_1,\bsol_1)$, and given the structure of this problem, we can obtain potentially weaker cuts, but saving significant work. In particular, we use $h_{\m'}(\pisol,\betasol) = \sum_{\ka  \in \KA} \pisol_\ka D^{ \m'}_{\ka}$ for each $\m' \in \EM$, instead of solving the above defined LP and using its optimal solution.} This should be valid because the dual feasible region of the set $ Q(D^{\m'})$ is independent of $\m'$, so a dual solution from one $\m$ can be used to define an inequality valid for any other $\m'$.


After evaluating $h_{\m'}(\pisol,\betasol)$ for each $\m' \in \EM$, we then sort the values to obtain a permutation $\sigma$ of $\EM$ which satisfies:
\[ h_{\sigma_1}(\pisol,\betasol) \geq h_{\sigma_2}(\pisol,\betasol)  \geq \cdots \geq h_{\sigma_{|\EM|}}(\pisol,\betasol)
 \]
Then, letting $p = \lfloor (1-\alpha) |\EM| \rfloor$, the following inequalities are valid for the master problem~\cite{luedtke2014branch}:
\[ \sum_{\ka  \in \KA} \betasol_k \Vi_1k - \sum_{\ka  \in \KA} \pisol_k \Bi_1k + 
\left(h_{\sigma_1}(\pisol,\betasol) - h_{\sigma_i}(\pisol,\betasol)\right)\Zed_{\sigma_1} + 
\left(h_{\sigma_i}(\pisol,\betasol) - h_{\sigma_{p+1}}(\pisol,\betasol)\right)\Zed_{\sigma_i} \geq h_{\sigma_1}(\pisol,\betasol), \quad \forall i=1,\ldots, p \]
Any of these inequalities could be added, if violated by the current solution $(\zsol_1,\vsol_1,\bsol_1)$.

The final step for obtaining strong valid inequalities is to search for {\it mixing inequalities}, which have the following form. Given a subset $T = \{t_1,t_2,\ldots,t_{\ell}\} \subseteq \{\sigma_1,\sigma_2,\ldots,\sigma_p\}$, where $h_{t_{l+1}}= h_{\sigma_{p+1}}$, the inequality
\[  \sum_{\ka  \in \KA} \betasol_k \Vi_{1k} - \sum_{\ka  \in \KA} \pisol_k \Bi_{1k} + 
\sum_{i=1}^{\ell} \left(h_{t_i}(\pisol,\betasol) - h_{t_{i+1}}(\pisol,\betasol)\right)\Zed_{t_i}
\geq  h_{t_1}(\pisol,\betasol) \]
is valid for the master problem. Although the number of such inequalities grows exponentially with $p$, there is an efficient algorithm for finding a most violated inequality~\cite{gunluk2001mixing} for given $(\zsol_1,\bsol_1,\vsol_1)$, which is provided in Algorithm~\ref{alg:mostviolated} in Appendix~\ref{APP1}. 




  

\section{Computational experiments}
In this section, we explain the instance generation, and the rolling horizon framework that we use to conduct the numerical experiments. 
\subsection{Instance generation}

To evaluate different policies and the algorithms, we generate a variety of instances based on Rao et al.~\cite{rao2004multi} and Helber et al.~\cite{helber2013dynamic} with some justifications for our problem. Table~\ref{tab:Sub_FD_parameters} illustrates different cost parameters in the model and how to define them based on data generation parameters. In the base case, one way substitution is available for four consequent products ordered based on their values.
%It should be noted that the backlog cost for the next immediate period in the chance constraint policy model is calculated based on equation~(\ref{eq:backCost}), considering both substitution cost and the backlog cost. 
Table \ref{tab:BaseSensitivity} summarizes the data generation parameters, their base value and their variation for sensitivity analysis.  




\begin{table}[h]
\centering
\caption{Data generation for the cost parameter }
%\footnotesize
\begin{tabular}{ll}
\toprule
%{\bf Sets} &  \\ \midrule
%$\ti$   & Set of planning periods \\ 
%$\ka$   & Set of products  \\ 
%$G$  & Substitution graph (one way substitution) \\
{\bf Parameters} &  \\ \midrule
$c^{\text{prod}}_{\ti \ka}$  & $1+\eta \times(\Ka-\ka)$ 
%, $\eta = 0.1, 0.2 , 0.5$
\\
$c^{\text{sub}}_{\ti \ka \jey }$  & $\max(0,\tau \times (c^{\text{prod}}_{\jey \ti} - c^{\text{prod}}_{\ti \ka}))$ 
%, $\tau = 0 , 0.5 , 1$ 
\\ 
$c^{\text{hold}}_{\ti \ka}$  & $\rho \times c^{\text{prod}}_{\ti \ka} $ 
%, $\rho = 0.005, 0.01, 0.02, 0.05 ,0.8$
\\ 
%$TBO$  &  $TBO = 1, 2, 4$   \\ 
$c^{\text{setup}}_{\ti \ka}$ & $E[\overline{D_{\ti \ka}}] \times TBO^2 \times c^{\text{hold}}_{\ti \ka} /2$ \\ 
%$bc_{\ti \ka}$  &  $\pi \times c^{\text{hold}}_{\ti \ka}$ \\
%$SL$  &  $  80\%, 90\%, 95\%, 99\%$ \\
%${d}_{\ti \ka}$  & Generated based on AR procedure
\bottomrule
\end{tabular}
 \label{tab:Sub_FD_parameters}
\end{table}





\begin{table}[H]
\centering
%\footnotesize
\caption{ Parameters for the base case and the sensitivity analysis} \label{tab:BaseSensitivity}
%\begin{adjustbox}{width=1\textwidth,center=\textwidth}
\begin{tabular}{lll}
\toprule
{\bf Parameters} & Base Case & Variation \\ \midrule
$\Ti$   & 6 & 6, 8 , 10 \\ 
$\Ka$   & 10 & \\ 
$\eta$  &   0.2 & 0.1, 0.2 , 0.5   \\ 
$\tau$  &   1.5 & 1, 1.25 , 1.5, 1.75, 2, 2.5   \\ 
$\rho $  &   0.05 & 0.02, 0.05, 0.1 , 0.2 , 0.5   \\ 
$ TBO $  &   1 & 1, 1.25, 1.5, 1.75, 2   \\ 
$ \alpha $  &95\% & 80\%, 90\%, 95\%, 99\%  \\ 
%$ \pi $  &   2 & 0, 2, 10  \\ 
\bottomrule 
\end{tabular}
%\end{adjustbox}
\end{table}



%\begin{table}[H]
%\centering
%\footnotesize
%\caption{ Parameters for the methodology comparison} \label{tab:BaseMethod}
%\begin{adjustbox}{width=1\textwidth,center=\textwidth}
%\begin{tabular}{lllllll}
%\toprule
%{\bf Parameters} & & values \\\midrule
%$\Ti \in \{  6\}$& $\Ka \in \{ 10 \}$&
%$\eta \in \{  0.2 \} $ \\
%$\tau \in \{0 , 0.5, 1 \}$  &
%$\rho \in \{       0.02,  0.1 \} $ &
%$ TBO \in \{ 1, 2\} $   \\ 
%$ SL\in \{80\%, 90\%, 95\%, 99\% \} $ \\ 
%$ \pi $  &   2 & 0, 2, 10  \\ 
%\bottomrule 
%\end{tabular}
%\end{adjustbox}
%\end{table}

In addition to the mentioned cost parameters, in the chance-constraint policy formulation we have have a backlog cost which needs to be tuned. This parameter is calculated by equation~(\ref{eq:backCost}), which is equal to the maximum possible cost of substitution.
 
\begin{equation}
c^{back}_{ 2 \ka'} = \max_{\ka \in \KA ,\jey \in \Psub }c^{\text{sub}}_{2 \jey \ka  }  \qquad \forall \ka'  \in \KA       \label{eq:backCost}
\end{equation} 

%\subsubsection{AR procedure for demand generation}

To generate the random demand we used autoregressive process model ~\cite{jiang2017production} which considers the correlation in different stage demand as  
\begin{equation}
D_{ \ti+1,\ka} = C + AR_1 \times D_{ \ka \ti} + AR_2 \times \epsilon_{\ti+1,\ka }  \qquad \forall \ka  \in \KA , \forall \ti \in \TI       \label{eq:AR1}
\end{equation}
where $C, AR_1,$ and $AR_2$ are parameters of the model, and $\epsilon_{ \ti+1,\ka}$ is a random noise with normal distribution with the mean of 0 and standard deviation of 1. 
In our data sets, $C = 20$, $AR_1 = 0.8$, and $AR_2 = 0.1 \times 100$. With these data the expected demand for each product in each period is equal to 100. To apply this autoregressive process, we generated a random noise set and used it for both observed demand and the stochastic scenario sets generation for different policy formulations. The scenarios are assigned equal probabilities.

{As we have no production in the first period, without loss of generality, we assume that the demand in the first period is equal to zero, otherwise if there is no initial inventory, the service level constraint will not be satisfied. In the AR data generation procedure we start with the defined average in the first period and then follow the procedure for the rest of the periods. Then to make the first period demand equal to 0 we subtract this average from the first period demand.} 

The algorithms are implemented in Python and MIP models are solved using IBM ILOG CPLEX 12.8. All the experiments are performed on a 2.4 GHz Intel Gold processor with only one thread on the Compute Canada computing grid.
%Demand generation options:











\subsection{Rolling-horizon framework}
\label{Sec:Rolling}

The original problem we consider in this research is an infinite-horizon problem and the decision policies proposed based on the finite-horizon version of this problem are applied and evaluated in a rolling horizon framework. The infinite-horizon time period is indexed by $\tAct \in \{1, 2, ... , \Ti_\text{Sim}\}$ and the finite-horizon model is indexed by $\ti \in \{1, 2, ... , \Ti\}$. In this framework, at each period $\tAct$, a model with $\Ti$ planning periods is solved, and only the decision correspond to first (or the first few) period are implemented. Based on the these decisions and the observed demand, the state of the system is updated and the next $\Ti$ planning period model is solved, as we roll the horizon. 
%  Considering the scenario tree,  at each stage, we solve two-stage approximation for the multistage problem over subtree with initial values of $(\tAct,\hat{\Vi}_{\tAct-1 , \ka},\hat{\Bi}_{\tAct-1 , \ka})$.

We simulate the decision making process in a rolling horizon framework using Algorithm (\ref{Al:PolicyEvaluation}) in which at each time period $\tAct$ we first execute the backlog determination model, and then solve a finite-horizon model  depending on the  selected policy. We then fix the solution for the period $\tAct$ and update the state of the system based on the observed demand.
%To compare the policies we calculate different cost based on the realized demand and solution values. 

We use two different measures to evaluate different policies, the actual total cost and the actual service level. At each period $\tAct$, we calculate the total cost based on the observed demand and implemented solution values, in this period. We consider the average of this cost over all time periods as the total cost of a policy. For the service level we consider the percentage of the periods in which the joint service level is satisfied by checking if there is any backlog after observing the demand in each period. For calculating the confidence intervals, we use the batch-based estimations, with the batch size of 25 periods. 
The simulation time horizon ($\Ti_\text{Sim}$) is 4000 periods, and we ignore few initial periods as the warm up periods.
%The policies are evaluated  using simulation. 
%The demand for each product at each period is generated based on the autoregressive process, and the models are solved repeatedly in a rolling-horizon fashion. 

%Another criteria to compare the policies is the joint service level, which is calculated over all products for each planning period in the simulation. 

%The remaining periods are divided into number of batches, and for each batch the average objective and joint service level are calculated. Based on the number of batches and the calculated averages, the confidence intervals are built.







\begin{algorithm}[H]
\SetAlgoLined
{OUTPUT: The confidence interval of the total cost and the service level}\\
INPUT: \
 Demand simulation over $\Ti_{Sim}$ periods, Production policy\\

 $\tAct =1,\hat{\Vi}_{\ti_0} =0,\hat{\Bi}_{\ti_0} = 0, \mathcal{O} = \emptyset, \mathcal{Z} = \emptyset$\\
 \While{$\tAct \leq \TI_{Sim}$ }{
 %Solve the Current stage modification model, and fix the the selected $\Bi_{\tAct}$ variables equal to 0\;
 Solve the backlog determination model~(\ref{Currentstage})  for period $\tAct$ and let $B^{*}_{\tAct }$ be the optimal backlog solution.
 %, and fix the the selected $\Bi_{\tAct}$ variables equal to 0\\
 \\
 Let $\hat{\Ka} = \{ k \in \KA : B^{*}_{\tAct \ka} = 0 \}$

  Solve the model~(\ref{DynamicProgrammingNoden}) approximation based on selected policy,  $\hat{v}_{\tAct-1 , \ka}, \hat{B}_{\tAct-1 , \ka}$, the observed demand $\hat{D}_{\tAct}$, and set $\hat{\KA}$.\\
 % Let $v^*_{ \tAct}, x^{*}_{\tAct}, y^{*}_{\tAct}, S^{*}_{\tAct},I^{*}_{\tAct},B^{*}_{\tAct}$ be the resulting solution for period $\tAct$, and the $Obj_{\tAct}$ be the total cost of period $\tAct$ based on this solution. \\ 
 Let $x^{*}_{\tAct}, y^{*}_{\tAct}, S^{*}_{\tAct}$ be the resulting solution for period $\tAct$, and the $Obj_{\tAct}$ be the total cost of period $\tAct$ based on this solution. \\ 
  \If{$B^{*}_{\tAct} \geq 0$}{\vskip 0.1cm    
  $Z_{\tAct} = 1$ }
  Add $Obj_{\tAct}$ to the set $\mathcal{O}$ \\
  Add $Z_{\tAct}$ to the set $\mathcal{Z}$ \\
  $\tAct \gets \tAct+1$ }
%  Average Cost $=\sum_{\tAct= n_\text{warm}}^{\Ti_\text{Sim}}Obj_{\tAct}/ |T_{Sim}-n_\text{warm}|$ \\
 % Average Service Level$=\sum_{\tAct= n_\text{warm}}^{\Ti_\text{Sim}}Z_{\tAct}/ |T_\text{Sim}-n_\text{warm}|$
  Build confidence intervals for the cost and service level using $\mathcal{O}$ and $\mathcal{Z}$, respectively.
  \caption{Rolling-horizon implementation}
  \label{Al:PolicyEvaluation}
\end{algorithm}



%\subsection{Numerical experiments}
\subsection{Methodology evaluation}
In this section, we analyze the efficiency of the proposed branch-and-cut algorithm used to solve the chance-constraint policy model against the extensive form formulation. To this end, we generate some instances with different parameters and  solve each instance for 5 different stages of the problem with two different methods. Based on some preliminary analysis we select 24 different challenging instances as follows. $\Ti \in \{  6, 8 , 10\}$, $\Ka = 10$,
$\eta =  0.2 $,
$\tau = 0.5 $,
$\rho = 0.1$,
$ TBO \in \{1, 2\} $, and
$ \alpha \in \{80\%, 90\%, 95\%, 99\% \} $. We consider partial substitution, and the time limit is set to 7200 second. We used the stages after the warm up periods with similar initial state for all the methods. For the branch-and-cut algorithm we use the faster version instead of the stronger version, as the preliminary results does not show significant difference between the two versions. More specifically, the faster version shows slightly better performance. 

%As the first period demand is equal to 0, we decided to use the second period model. To have a fair comparison, we solved the first period model Fast $B\&C$, and used the resulting ${\Bi}$ and ${\Vi}$ as the $\hat{\Bi}$ and $\hat{\Vi}$ for the second period. 
  
We analyse the performance of the two methods using three measures, the average CPU time in second (Time), the average integrality gap (GAP), and the average number of optimal solution (\# OPT) over all the instances in one group.
%Each instance is solved five times.
Table \ref{tab:MethodologyCompare} illustrates this analysis based on the different parameters using the three mentioned measures. 

\begin{comment}

\begin{table}[]
\caption{Comparison of methodology to solve the model with the service level}
\label{tab:MethodologyCompare}
\begin{tabular}{lllllllllllll}
Method      & \multicolumn{4}{c}{Extensive form} & \multicolumn{4}{c}{Strong Cut}    & \multicolumn{4}{c}{Fast Cut}     \\ \hline
\# Branches & Time    & Gap   & \# Opt & BestObj & Time   & Gap   & \# Opt & BestObj & Time  & Gap   & \# Opt & BestObj \\ \hline
100         & 800.2   & 0.2\% & 4.8    & 10612.1 & 9.3    & 0.0\% & 5.0    & 10611.7 & 3.2   & 0.0\% & 5.0    & 10611.7 \\
200         & 2110.8  & 1.4\% & 4.1    & 10513.3 & 45.4   & 0.0\% & 5.0    & 10509.0 & 7.4   & 0.0\% & 5.0    & 10509.0 \\
300         & 3264.9  & 2.5\% & 3.2    & 10419.6 & 131.2  & 0.0\% & 5.0    & 10407.5 & 10.3  & 0.0\% & 5.0    & 10407.5 \\
500         & 4061.1  & 3.8\% & 2.5    & 10752.6 & 582.7  & 0.0\% & 5.0    & 10712.6 & 25.9  & 0.0\% & 5.0    & 10712.6 \\
1000        & 5321.6  & 7.5\% & 1.6    & 12369.2 & 3265.4 & 1.1\% & 4.0    & 10722.1 & 220.3 & 0.0\% & 4.9    & 10700.5 \\ \hline
Average     & 3111.7  & 3.1\% & 3.2    & 10933.4 & 806.8  & 0.2\% & 4.8    & 10592.6 & 53.4  & 0.0\% & 5.0    & 10588.3
\end{tabular}


\end{table}
\end{comment}

\begin{table}[H]
\centering
\caption{Comparison of methodologies to solve the model with the service level}
\label{tab:MethodologyCompare}
\begin{tabular}{lrccrcc}
\toprule
Method      & \multicolumn{3}{c}{ B\&C} &  \multicolumn{3}{c}{Extensive form} \\
\# Branches & Time       & Gap (\%)       & \# Opt      & Time    & Gap(\%)     & \# Opt   \\
\cmidrule(lr){1-1}
\cmidrule(lr){2-4}
\cmidrule(lr){5-7}
100	&	10.3	&	0.1	&	5.0	&	74.6.0	&	0.1	&	5.0	\\
200	&	34.6	&	0.1	&	5.0	&	400.8	&	0.1	&	5.0	\\
300	&	60.6	&	0.1	&	5.0	&		1152.5	&	0.3	&	4.8	\\
500	&	206.1	&	0.1	&	5.0	&	3356.3	&	2.7	&	4.0	\\
1000	&	990.1	&	0.3	&	4.9	&	6170.3	&	8.5	&	1.3	\\
\midrule
Service level (\%) &&&&&&\\
%\cmidrule(lr){1-1}
%\cmidrule(lr){2-4}
%\cmidrule(lr){5-7}
%\cmidrule(lr){8-10}
80&	417.2	&	0.1	&	5.0	&		2486.6	&	1.8	&	3.9	\\
90&	299.5	&	0.1	&	5.0	&	2690.7	&	2.8	&	3.8	\\
95&	202.2	&	0.2	&	5.0	&	2166.3	&	2.6	&	3.9	\\
99&	122.5	&	0.1	&	5.0	&	1579.9	&	2.2	&	4.5	\\
\midrule
\# Periods &&&&&&\\
%\cmidrule(lr){1-1}
%\cmidrule(lr){2-4}
%\cmidrule(lr){5-7}
%\cmidrule(lr){8-10}
%4	&	190.9	&	0.0	&	5.0	&	252.0	&	0.0	&	5.0	&	1202.7	&	0.4	&	4.6	\\
6	&	131.4	&	0.1	&	5.0	&		1780.3	&	1.3	&	4.2	\\
8	&	261.8	&	0.1	&	5.0	&	2040.1	&	1.3	&	4.2	\\
10	&	387.9	&	0.2	&	5.0	&		2872.3	&	3.9	&	3.7	\\
\midrule
Average &	260.4	&	0.1	&	5.0	&		2230.9	&	2.3	&	4.0	\\
\bottomrule
\end{tabular}

\end{table}

The first analysis is based on the size of scenario set. The $B \& C$ hold its superiority in all the scenario set sizes. By increasing the number of scenarios the solution time is increased significantly, but the Branch and cut algorithm find the optimal solution in most cases in a reasonable amount of time. When we have 1000 scenarios, the extensive form finds the optimal solution in less than 25\% of the cases, and considering the time limit the average gap is about 8\%. Considering the service level, we can see that the increasing the service level, result in faster solution time in both methods. In the last analysis we can see that by increasing the number of periods in the finite-horizon model, the solution time is also increased, but this increase is such that the branch-and-cut method is still a reasonable method to use.

In general, the branch-cut algorithm has  better performance compared to the extensive form, and hence we use this method for the rest of the experiments. 
%In the next set of experiments we perform a sensitivity analyse to investigate the performance of the faster branch and cut algorithm based on the change in different parameters. 
%To this end a base case instance is selected and, the solution time is reported based on the changes in different parameters as shown in table ???. 
In the following experiments, due to the large number of simulation iterations (4000) the instances are solved with 100 branches. However, based on the reported solution time of the branch-and-cut algorithm, we can easily scale up the number of scenario set, when we want to solve the problem for one or couple of stages ahead.

\subsection{Policy evaluation}

We compare the three mentioned policies, namely, average, quantile, and chance constraint policies against each other.
%The first two are the deterministic policies, and the third one is the policy which consider the service level explicitly in the model. The first deterministic policy is the average policy which does not consider the service level, and for the demand we substitute it with the average demand which is calculated based on the realized demand and the autoregressive process.
%The second deterministic policy is the quantile policy in which the demand for the next immediate period is substituted based on the quantile percentage in the demand scenario branches of next immediate period, and for the rest of the planning periods we calculate it with the same procedure as the average policy.
%The third policy considers the service level in the next stage. The demand in each planning period in this policy is substitute with the average demand same as the average policy.
This comparison is based on objective function and the joint service level, using the procedure explained in section~\ref{Sec:Rolling}. Table \ref{PolicyComp} compares the three policies using these measures and their confidence interval of 95\% at two different TBOs and four different service levels. Among the three policies the ``chance-constraint policy" is the only policy which respects the service level in all the instances. In all the instances with acceptable service level the ``chance-constraint policy" has the lower cost. Among the three policies the average policy is not sensitive to the service level and it has poor performance in this measure, in which at TBO equal to 1 the joint service level is about 21\%. When the TBO is equal to 2 the service level is slightly more than 78\% for this policy. This result show that this policy is not a reliable policy, and it will not be used in the rest of experiments. The quantile policy has an acceptable performance in both measures. 


\newcolumntype{L}{>{$}l<{$}}
\newcolumntype{C}{>{$}c<{$}}
\newcolumntype{R}{>{$}r<{$}}
\newcommand{\nm}[1]{\textnormal{#1}}


\begin{table} [H]
\centering
\caption{Policy comparison based on total cost and service level}\label{PolicyComp}
\small
\begin{tabular}{RRRRRRRR}
\toprule
\multicolumn{1}{R}{$TBO$} &
\multicolumn{1}{R}{\alpha \ (\%)} &
\multicolumn{3}{c}{Total cost}    &
\multicolumn{3}{c}{Service level (\%)}    \\ 
\cmidrule(lr){3-5}
\cmidrule(lr){6-8}

&&
\multicolumn{1}{r}{Average } &
\multicolumn{1}{r}{Quantile }     &
\multicolumn{1}{r}{Chance constraint } &
\multicolumn{1}{r}{Average } &
\multicolumn{1}{r}{Quantile }     &
\multicolumn{1}{r}{Chance constraint }  \\
\midrule

\multicolumn{1}{c}{1}	&\multicolumn{1}{c}{	80}	&	74.4	\pm	0.4	&	66.4	\pm	0.2	&	66.7	\pm	0.2	&	21.4	\pm	1.4	&	76.5	\pm	1.4	&	84.9	\pm	1.3	\\
	&	\multicolumn{1}{c}{90}	&	74.4	\pm	0.4	&	68.2	\pm	0.1	&	67.1	\pm	0.2	&	21.4	\pm	1.4	&	90.6	\pm	1.1	&	90.3	\pm	1.1	\\
	&\multicolumn{1}{c}{	95}	&	74.4	\pm	0.4	&	71.0	\pm	0.1	&	67.6	\pm	0.2	&	21.4	\pm	1.4	&	94.1	\pm	0.9	&	95.3	\pm	0.7	\\ \vspace{0.2cm}
	&\multicolumn{1}{c}{	99}	&	74.4	\pm	0.4	&	76.1	\pm	0.1	&	69.1	\pm	0.2	&	21.4	\pm	1.4	&	99.1	\pm	0.3	&	99.1	\pm	0.3	\\ 
\multicolumn{1}{c}{2}	&\multicolumn{1}{c}{	80}	&	204.3	\pm	0.6	&	204.3	\pm	0.5	&	191.2	\pm	0.6	&	78.1	\pm	2.7	&	93.2	\pm	1.2	&	98.7	\pm	0.4	\\
	& \multicolumn{1}{c}{	90}	&	204.3	\pm	0.6	&	207.2	\pm	0.4	&	192.4	\pm	0.6	&	78.1	\pm	2.7	&	97.4	\pm	0.6	&	99.5	\pm	0.3	\\
	&\multicolumn{1}{c}{	95}	&	204.3	\pm	0.6	&	210.0	\pm	0.4	&	193.5	\pm	0.6	&	78.1	\pm	2.7	&	98.5	\pm	0.5	&	99.8	\pm	0.2	\\
	&\multicolumn{1}{c}{	99	}&	204.3	\pm	0.6	&	215.3	\pm	0.4	&	195.4	\pm	0.6	&	78.1 \pm	2.7	&	99.7	\pm	0.2	&	100.0	\pm	0.0	\\

%\midrule[\heavyrulewidth]
%\multicolumn{7}{l}{\footnotesize 95\% of confidence interval} \\
\bottomrule
\end{tabular}
\end{table}


The rest of this section is dedicated to compare the chance-constraint and quantile policies additional instances presented in Table~(\ref{tab:BaseSensitivity}). To this end, we use two measures, the joint service level and the relative cost change, $\Delta$Cost, which is defined as: 

\begin{alignat}{2}
  & \Delta \text{Cost} (\%) = \dfrac{\text{Total Cost}_{\text{Quantile}} - \text{Total Cost} _{\text{chance-constraint}}}{\text{Total Cost}_\text{{Quantile}}} \times 100& \label{eq:ِDeltaCost} 
 \end{alignat}
%(\ref{eq:ِDeltaCost}), and the joint service level is used to compare these two policies under different settings.

% The performance of the policies can be also compared base on different cost structure. For example when the backlog cost is equal to 0 we expect that the deterministic model with the average demand does not show a good performance in terms of service level. The service level for the next stage and for the whole planning period.
%As the results show, the deterministic models are sensitive to the cost of backlog and has different pattern in different settings. A low backlog may lead to very low service level, and high one may impose unnecessary cost to the model. Using these policies one should do a sensitivity analysis to come up with a proper backlog cost to come up with an acceptable service level. It should be noted that even if the company come up with the exact cost of backlog, it may not be enough to reach the desired service level. However, in the policy with the service level, it is not necessary to consider the backlog cost as the quality of the solution is not sensitive to it. 



%\subsubsection{Chance-constraint vs quantile policy}

Figure~\ref{fig:TBOComp} shows the comparison of the the quantile policy and the chance-constraint policy under different values of TBO. In all cases, the chance-constraint policy has better performance in terms of service level. The chance-constraint policy has lower cost in all cases in which both policies have acceptable service level. When TBO is more than 1 the service level is over satisfied. This is mostly because of backlog determination step. We later discuss the necessity of this modification and if it imposes any extra costs.  



\begin{figure}[H]
    \centering
    \subfloat[\centering Service level]{{\includegraphics[width=9cm]{TBOSL.pdf} }}%
   % \quad
    \subfloat[\centering Total cost ]{{\includegraphics[width=9cm]{TBOOBJ.pdf} }}%
    \caption{Comparison based on TBO}%
    \label{fig:TBOComp}%
\end{figure}


Figure~\ref{fig:ETAComp} shows the comparison based on different values of $\eta$ under two different values of TBO, 1 and 2. In all cases, the chance-constraint policy has better performance in terms of joint service level and the total cost. 

\begin{figure}%
    \centering
    \subfloat[\centering Service level]{{\includegraphics[width=8.6cm]{ETASL.pdf} }}%
  %  \quad
    \subfloat[\centering Total cost ]{{\includegraphics[width=8.6cm]{ETAOBJ.pdf} }}%
    \caption{Comparison based on $\eta$}%
    \label{fig:ETAComp}%
\end{figure}

Figure~\ref{fig:SLComp} shows the comparison based on different service level values under two different values of TBO, 1 and 2. In all cases, the chance-constraint policy respects the service level and in cases where both policies have acceptable service level, the chance-constraint policy has better performance in terms of joint service level and the total cost. It should be noted that when the service level increases, the performance of chance-constraint policy against the quantile policy improves. Figure~\ref{fig:SLTotalCost} is complementary to Figure~\ref{fig:SLComp} and illustrates the trend of total cost for different values service level. As can be seen in this figure, the total cost of the quantile policy increases significantly with increase in the service level, which is not the case in the chance-constraint policy.

Figure~\ref{fig:TIComp} shows similar comparison based on $\tau$ values. In all cases, the chance-constraint policy has better performance compared to the quantile policy.

\begin{figure}[H]
    \centering
    \subfloat[\centering Service level]{{\includegraphics[width=8.6cm]{SLSL.pdf} }}%
    %\quad
    \subfloat[\centering Total cost ]{{\includegraphics[width=8.6cm]{SLOBJ.pdf} }}%
    \caption{Comparison based on service level}%
    \label{fig:SLComp}%
\end{figure}

\begin{figure}[!h]
\begin{center}
\includegraphics[scale=0.6]{SLTotalCost.pdf}
\caption{Comparison based on total cost trend} 
\label{fig:SLTotalCost}
\end{center}
\end{figure}


\begin{figure}[H]
    \centering
    \subfloat[\centering Service level]{{\includegraphics[width=8.2cm]{TISL.pdf} }}%
    %\quad
    \subfloat[\centering Total cost ]{{\includegraphics[width=9cm]{TIOBJ.pdf} }}%
    \caption{Comparison based on $\tau$}%
    \label{fig:TIComp}%
\end{figure}

\subsection{Sensitivity analysis}
%An interesting option for the sensitivity analysis is to show that having both service level and approximate backlog cost is the better than version when we have both options together. This can be done with a sensitivity analysis for the backlog cost with and without the service level and check how the model is robust in the former case, and may be show underestimating the backlog is better than overestimating that.
In this section, we perform some sensitivity analysis based on different elements of cost function, the setup cost, inventory holding cost and the substitution cost. 
Figure~\ref{fig:TBOSen} shows the cost change based on different values for TBO. It is intuitive that in lot sizing problem, by increase in TBO, there will be an increase in setup cost plus the inventory holding cost. In addition to this increase we can see a constant increase in the substitution cost, which means increase in the amount of substitution. 

\begin{figure}[H]
\begin{center}
\includegraphics[scale=0.3]{TBOSen.pdf}
\caption{Cost analysis based on TBO} 
\label{fig:TBOSen}
\end{center}
\end{figure}

Figure~\ref{fig:TISen} illustrates different cost changes based on changes in parameter $\tau$ for two different TBO values. When TBO is equal to 1, by increasing the substitution cost, the inventory cost slightly increases, and the substitution cost does not increase. We can conclude that by increasing the substitution cost, the amount of inventory will increase and the amount of substitution will decrease. This is more obvious when TBO is equal to 2. In this case, the increase in the substitution cost per unit results in total substitution cost reduction, total holding cost increase, and a slight setup cost increase.  

\begin{figure}[H]
\begin{center}
\includegraphics[scale=0.4]{TISen.pdf}
\caption{Cost analysis based on $\tau$} 
\label{fig:TISen}
\end{center}
\end{figure}


\subsection{The necessity of backlog determination step}
    When TBO is greater than 1 the service level is oversatisfied. This is due to the fact that to save on the setup cost the production amount will be higher than the average demand of one period. By this higher production many of the demands can be satisfied in the current period, when we apply the The backlog determination step. In this section, we show that this oversatisfaction of the service level will not impose a huge cost to the model. In these experiments, we cancel the Backlog determination step. We see that, even with very low service levels, there is very low cost difference compared to the case in which the model tries to minimize the backlog in the current stage as much as possible. These experiments also show the necessity of Backlog determination step, without which it is not possible to satisfy the required service level.
    
    
\begin{figure} [H]
    \centering
    \subfloat[\centering Service level]{{\includegraphics[width=8.6cm]{CurrentStageSL.pdf} }}%
   % \quad
    \subfloat[\centering Total cost ]{{\includegraphics[width=8.6cm]{CurrentStageOBJ.pdf} }}%
    \caption{The necessity of backlog determination}%
    \label{fig:BacklogDetermination}%
\end{figure}




\subsection{Effect of substitution}

In this section we investigate the effect of substitution. To this end we run some experiments and we eliminate the possibility of substitution, fully and partially, for different service levels. Figure~\ref{fig:sustitution} illustrate the percentage of cost decrease when adding the possibility of substitution to the model. The value of substitution is higher at higher service level, and larger TBO.

%Table ??? provide the result on these experiments. In this table the average cost, and average service level their interval and different cost in detail are provided. These result are based on $\pi =0$. As expected, eliminating the possibility of substitution will increase the costs. 

%It should be mentioned that the confidence interval of the objective function is about ??? and for the service level is about ??? which is reasonable.

\begin{figure}[!h]
\begin{center}
\includegraphics[scale=0.6]{Substitution.pdf}
\caption{Effect of substitution (Relative cost decrease)} 
\label{fig:sustitution}
\end{center}
\end{figure}


%\begin{figure}[!h]
%\begin{center}
%\includegraphics[scale=0.6]{SubstitutionCost.pdf}
%\caption{Effect of substitution (Total cost)} 
%\label{fig:sustitution}
%\end{center}
%\end{figure}


\section{Conclusion}

We study the multi-stage stochastic lot sizing problem with firm-driven product substitution option and the joint service level constraint which is defined over different products. 
An extension to this problem is to approximate this the problem as a two stage stochastic problem in addition to have the service level in the next stage. This model will computationally expensive, but it will provide a better approximation for the problem.

Acknowledgements:
Calcule quebec
FRQNT


Appendix 

previous chance constraint policy model



\begin{subequations}
\label{mod:ExtnSL}

\begin{flalign}
\min &
\sum_{\ka \in \KA} ( c^{\text{setup}}_{ \ti(n) \ka}y_{ \ti(n) \ka} + c^{\text{prod}}_{ \ti(n) \ka}x_{ \ti(n) \ka}+ \sum_{\jey \in  \Csub}c^{\text{sub}}_{\ti(n) \ka \jey} S_{\ti(n) \ka \jey}  + c^{\text{hold}}_{ \ti(n) \ka}I_{ \ti(n) \ka} + bc_{ \ti(n) \ka} {B}_{ \ti(n) \ka} ) + \notag \\
&\sum_{\ka \in \KA} ( c^{\text{setup}}_{ \ti(n) \ka}y_{\ti(n)+1 , \ka} + c^{\text{prod}}_{ \ti(n) \ka}x_{\ti(n)+1 , \ka}+  c^{\text{hold}}_{\ti(n)+1 , \ka}I_{\ti(n)+1 , \ka} + bc_{\ti(n)+1 , \ka} {B}_{\ti(n)+1 , \ka} + \frac{1}{|M|} \sum_{m \in M} \sum_{\jey \in  \Csub} c^{\text{sub}}_{\ti(n)+1,\ka,\jey} S_{\ti(n)+1,\ka,\jey,m} ) + \notag \\
& \sum_{t =3 }^{T} \sum_{\ka \in \KA} ( c^{\text{setup}}_{\ti \ka}y_{\ti \ka} + c^{\text{prod}}_{\ti \ka}x_{\ti \ka}+ \sum_{\jey \in  \Csub}c^{\text{sub}}_{\ti \ka \jey} S_{\ti \ka \jey}  + c^{\text{hold}}_{\ti \ka}I_{\ti \ka} + bc_{\ti \ka} {B}_{\ti \ka} ) & \label{eq:Sub_Roll_obj_ext_o} 
\end{flalign}
 subject to:
\begin{flalign}
&x_{\ti \ka} \leq M_{\ti \ka} y_{\ti \ka} &  \forall t  \in T , t \geq \ti(n)  ,\forall \ka \in \KA & \label{eq:Sub_FD_Setup_o}\\
  &  \sum_{\jey \in  \Psub} {S}_{\ti(n)  \jey \ka} + B_{\ti(n) \ka}  = \hat{D}_{n \ka} + \hat{B}_{\ti(n)-1, \ka} &\forall \ka \in \KA  &     \label{eq:Det_backorder_tn_o}&\\
  &  \sum_{\jey \in  \Csub} {S}_{\ti(n) \ka \jey} + I_{ \ti(n) \ka} = \hat{v}_{\ti(n)-1 , \ka} &\forall \ka \in \KA  &     \label{eq:Det_inventory_tn_o}&\\
  &  \sum_{\jey \in  \Psub} {S}_{\ti(n)+1,\jey,\ka,m} + B'_{\ti(n)+1 , \ka,m}  = d_{km} + {B}_{\ti(n) , \ka} &\forall \ka \in \KA, \forall m \in M &     \label{eq:Det_backorder_tnp_o}& \\
&  \sum_{\jey \in  \Csub} {S}_{\ti(n)+1,\ka,\jey,m} + I'_{\ti(n)+1 , \ka,m} = v_{\ti(n) , \ka} &\forall \ka \in \KA, \forall m \in M  &     \label{eq:Det_inventory_tnp_o}&\\
   &  \sum_{\jey \in  \Psub} {S}_{\ti \jey \ka} + B_{k t}  = \mathbb{E}_{|n}[{D}_{\ti \ka}] + {B}_{\ti -1 ,\ka} &\forall \ti  \in \TI, t > t_{n}+1,\forall \ka \in \KA  &   \label{eq:Det_backorder_ext_o}& \\
&  \sum_{\jey \in  \Csub} {S}_{\ti \ka \jey} + I_{\ti \ka} = v_{\ti-1 , \ka} &\forall \ti  \in \TI, t > t_{n}+1,\forall \ka \in \KA  &     \label{eq:Det_inventory_ext_o}&\\
& \frac{1}{|M|} \sum_{m \in M} I'_{\ti(n)+1,k,m} = I_{\ti(n)+1, \ka} &\forall \ka \in \KA & \label{eq:Average_Inventory_o} \\
& \frac{1}{|M|} \sum_{m \in M} B'_{\ti(n)+1,k,m} = B_{\ti(n)+1, \ka} &\forall \ka \in \KA & \label{eq:Average_Backlog_o}\\
%&  I_{ \ti(n) \ka} - B_{ \ti(n) \ka} = \hat{v}_{\ti(n)-1 , \ka} - \sum_{\jey \in  \Csub} {S}_{\ti(n) \ka \jey} + \sum_{\jey \in  \Psub} {S}_{\ti(n)  \jey \ka}  - \hat{D}_{n \ka} \quad &\forall \ka \in \KA  &     \label{eq:Det_inventory_tn}&\\
%& v_{ \ti(n) \ka} = I_{ \ti(n) \ka} + x_{ \ti(n) \ka}  \quad &\forall \ka \in \KA  &     \label{eq:Det_inventoryPos_tn}& \\
%&  I_{\ti \ka} - B_{\ti \ka} = v_{\ti-1 , \ka} - \sum_{\jey \in  \Csub} {S}_{\ti \ka \jey} + \sum_{\jey \in  \Psub} {S}_{\ti \jey \ka}  - E_{|n}[\overline{D}_{\ti \ka}] \quad &\forall \ti  \in \TI, t > t_{n},\forall \ka \in \KA  &     \label{eq:Dyn_F_Sub_ST_Service}&\\
& v_{\ti \ka} = I_{\ti \ka} + x_{\ti \ka}  \quad &\forall \ti  \in \TI, t \geq \ti(n),\forall \ka \in \KA \\
%&\sum_{\ka \in \KA} (st_{\ti \ka}y_{\ti \ka} + pt_{\ti \ka}x_{\ti \ka}) \leq Cap_{t} & \forall t  \in T ,  t\geq \ti(n)   & \label{eq:Sub_FD_Capacity}  \\
%&y_{\ti \ka} \in \{0, 1\} & \forall t  \in T,  t \geq \ti(n) ,\forall\ka \in \KA &\label{eq:Sub_FD_base_bin}\\
%&x_{\ti \ka}  \geq 0 &  \forall t  \in T, t\geq \ti(n),\forall \ka \in \KA  & \label{eq:Sub_FD_bound1}\\
%& I_{\ti \ka} , B_{\ti \ka} \geq 0 &  \forall t  \in T,  t \geq \ti(n) ,\forall \ka \in \KA  & \label{eq:Sub_FD_bound2}\\
%&S_{\ti \ka \jey} \geq 0 &  \forall t  \in T,  t \geq \ti(n) , \forall(k,j) \in \Graf & \label{eq:Sub_FD_bound3}
&{x}_{ \ti },  {v}_{ \ti },  {I}_{ \ti} , {\Bi}_{ \ti } \in \mathbb{R}_{+}^{\Ka} , {S}_{\ti} \in \mathbb{R}_{+}^{|\Graf|} ,{y}_{ n } \in \{0,1\}^{\Ka} & \label{eq:Sub_FD_bound3_o}
\end{flalign}

  \end{subequations}
  
  
  



{\cred
\large{The next section will be eliminated, I just keep it for now in case there was a discussion for the appendix}

  \subsubsection{Benders cuts to project out the second stage substitution variables}
  
  
 To reduce the size of the master problem, we use Benders cuts to eliminate the substitution variables $S_{\ti(n)+1,\jey,\ka,m}$ in the next immediate stage. For each $m \in M$, introduce a variable $\theta_m$ to represent the substitution cost in child node $m \in M$. Then, the term 
 \[ \sum_{\ka \in \KA} \frac{1}{|M|} \sum_{m \in M} \sum_{\jey \in  \Csub} S_{k,j,\ti(n)+1,m} \]
 in the objective is replaced by the term:
 \[ \frac{1}{|M|} \sum_{m \in M} \theta_m. \]

The constraints \eqref{eq:Det_backorder_tnp} and \eqref{eq:Det_inventory_tnp} are eliminated from the master model. 

Given a master problem solution, say with values $\overline{B}'_{\ti(n)+1 , \ka,m}$,$\bar{I}'_{\ti(n)+1 , \ka,m}$,$\bar{B}_{ \ti(n) \ka}$, $\bar{v}_{\ti(n) , \ka}$, $\bar{\theta}_m$ we solve the following subproblem for each $m \in M$:

}


\begin{thebibliography}{99}



%%

%\bibitem{RefJ}
% Format for Journal Reference
%Author, Article title, Journal, Volume, page numbers (year)
% Format for books
%\bibitem{RefB}
%Author, Book title, page numbers. Publisher, place (year)

%a,b

%a,b

\bibitem{akccaycategory}
Akçay Yalçın. and Yunke Li and Harihara Prasad Natarajan, Category Inventory Planning With
Service Level Requirements and Dynamic Substitutions.
Production and Operations Management (2020), https://doi.org/doi:10.1111/poms.13240

\bibitem{bassok1999single}
Bassok, Yehuda and Anupindi, Ravi and Akella, Ram,
Single-period multiproduct inventory models with substitution, Operations Research, 47, 4, 632--642, (1999)
 

\bibitem{bookbinder1988strategies}
 Bookbinder, James H and Tan, Jin-Yan, Strategies for the probabilistic lot-sizing problem with service-level constraints, Management Science, 34, 9, 1096--1108,
 (1988)


\bibitem{bitran1992deterministic}
Bitran, Gabriel R and Leong, Thin-Yin, Deterministic approximations to co-production problems with service constraints and random yields, Management science, 38, 5, 724--742, (1992)
  
  
  \bibitem{bitran1992ordering}
Bitran, Gabriel R and Dasu, Sriram, Ordering policies in an environment of stochastic yields and substitutable demands,
Operations Research,
40, 5,
999--1017, (1992)

\bibitem{bitran1994co}
Bitran, Gabriel R and Gilbert, Stephen M,
  Co-production processes with random yields in the semiconductor industry, Operations Research, 42, 3, 476--491, (1994)
%c,d
\bibitem{chen2020dynamic}
Chen, Boxiao and Chao, Xiuli, Dynamic inventory control with stockout substitution and demand learning, Management Science, (2020) , https://doi.org/10.1287/mnsc.2019.3474
%e,f

%g,h
\bibitem{gicquel2018joint}
Gicquel, C{\'e}line and Cheng, Jianqiang, A joint chance-constrained programming approach for the single-item capacitated lot-sizing problem with stochastic demand, Annals of Operations Research, 264, 1-2, 123--155, (2018)

\bibitem{guan2011stochastic} Guan, Yongpei, Stochastic lot-sizing with backlogging: computational complexity analysis,  Journal of Global Optimization, 49, 4, 651--678, (2011)

\bibitem{guan2008polynomial}
  Guan, Yongpei and Miller, Andrew J, Polynomial-time algorithms for stochastic uncapacitated lot-sizing problems,  Operations Research, 56, 5, 1172--1183,
(2008)

\bibitem{gunluk2001mixing}
G{\"u}nl{\"u}k, Oktay and Pochet, Yves, Mixing mixed-integer inequalities, Mathematical Programming, 90, 3, 429--457, (2001)


\bibitem{helber2013dynamic}
 Helber, Stefan and Sahling, Florian and Schimmelpfeng, Katja, Dynamic capacitated lot sizing with random demand and dynamic safety stocks, OR Spectrum, 35, 1, 75--105, (2013)
 

\bibitem{hsu1999random}
Hsu, Arthur and Bassok, Yehuda, Random yield and random demand in a production system with downward substitution, Operations Research, 47, 2, 277--290,
  (1999)
  
\bibitem{hsu2005dynamic}
Hsu, Vernon Ning and Li, Chung-Lun and Xiao, Wen-Qiang, Dynamic lot size problems with one-way product substitution, IIE transactions, 37, 3, 201--215, (2005)

\bibitem{haugen2001progressive}Haugen, Kjetil K and L{\o}kketangen, Arne and Woodruff, David L, Progressive hedging as a meta-heuristic applied to stochastic lot-sizing, European Journal of Operational Research, 132, 1, 116--122, (2001)

%i,j

%\bibitem{jiang2017service}
 %Jiang, Yuchen and Shi, Cong and Shen, Siqian, Service Level Constrained Inventory Systems, Production and Operations Management, 28, 9, 2365–-2389,
 %(2017)
 
 \bibitem{jiang2017production}
 Jiang, Yuchen and Xu, Juan and Shen, Siqian and Shi, Cong, Production planning problems with joint service-level guarantee: a computational study, International Journal of Production Research, 55, 1, 38--58,
 (2017)
 %l
 
\bibitem{lang2010efficient}
 Lang, Jan Christian and Domschke, Wolfgang, Efficient reformulations for dynamic lot-sizing problems with product substitution, OR spectrum,
32, 2, 263--291, (2010)

\bibitem{lulli2006heuristic} Lulli, Guglielmo and Sen, Suvrajeet, A heuristic procedure for stochastic integer programs with complete recourse, European Journal of Operational Research,
171, 3, 879--890, (2006)

\bibitem{lulli2004branch}Lulli, Guglielmo and Sen, Suvrajeet, A branch-and-price algorithm for multistage stochastic integer programming with application to stochastic batch-sizing problems, Management Science, 50, 6, 786--796, (2004)
\bibitem{liu2018polyhedral}
Liu, Xiao and K{\"u}{\c{c}}{\"u}kyavuz, Simge, A polyhedral study of the static probabilistic lot-sizing problem, Annals of Operations Research, 261, 1-2,
233--254, (2018)

\bibitem{liu2016decomposition}
Liu, Xiao and K{\"u}{\c{c}}{\"u}kyavuz, Simge and Luedtke, James, 
Decomposition algorithms for two-stage chance-constrained programs, Mathematical Programming, 157,
  1, 219--243, (2016)
 

\bibitem{luedtke2008sample}
Luedtke, James and Ahmed, Shabbir, A sample approximation approach for optimization with probabilistic constraints, 
SIAM Journal on Optimization, 19,
2, 674--699, (2008)


\bibitem{luedtke2014branch}
  Luedtke, James, A branch-and-cut decomposition algorithm for solving chance-constrained mathematical programs with finite support,
  Mathematical Programming, 146, 1, 219--244,
 (2014)
%m, n 

\bibitem{ng2012robust}
Ng, Tsan Sheng and Fowler, John and Mok, Ivy, Robust demand service achievement for the co-production newsvendor, IIE Transactions,
  44,
  5,
 327--341,
  (2012)
  
%o, p , q
%R
 \bibitem{rao2004multi}
 Rao, Uday S and Swaminathan, Jayashankar M and Zhang, Jun,
 Multi-product inventory planning with downward substitution, stochastic demand and setup costs,
 IIE Transactions, 36, 1, 59--71, (2004)
 %t 
 
 \bibitem{tempelmeier2007stochastic}
Tempelmeier, Horst, On the stochastic uncapacitated dynamic single-item lotsizing problem with service level constraints, European Journal of Operational Research, 181, 1, 184--194, (2007)
 

 \bibitem{tempelmeier2011column}
Tempelmeier, Horst, A column generation heuristic for dynamic capacitated lot sizing with random demand under a fill rate constraint, Omega, 39, 6, 627--633, (2011)
 % v
 

\bibitem{zeppetella2017optimal}
Zeppetella, Luca and Gebennini, Elisa and Grassi, Andrea and Rimini, Bianca, Optimal production scheduling with customer-driven demand substitution, International Journal of Production Research, 55, 6, 1692--1706, (2017)
 



\end{thebibliography}

\appendix


\section{Algorithm 2} \label{APP1}


\begin{algorithm}[H]
\label{alg:mostviolated}
\SetAlgoLined
{OUTPUT: A most violated mixing inequality defined by ordered index set $\ti$ } \;
INPUT: $\zsol_{\sigma_i}, \sigma_i, h_{\sigma_i}(\pisol,\betasol)$, $i=1,\ldots,p+1$  {\cred is it p or p+1}\;
Sort the $\zsol_{\sigma_i}$ values to obtain permutation $\rho$ of the indices satisfying:
$\zsol_{\rho_1} \leq \zsol_{\rho_2} \leq \cdots \leq \zsol_{\rho_{p+1}} $ \;
$v \gets h_{\sigma_{p+1}}(\pisol,\betasol)$\;
$T \gets \{ \}$\;
$ i \gets 1$\;
\While{$v < h_{\sigma_1}(\pisol,\betasol)$}{
  \If{$h_{\rho_i}(\pisol,\betasol) > v$}{
  $T \gets T \cup \{\rho_i\}$\;
  $v \gets h_{\rho_i}(\pisol,\betasol)$\;  }
  $i \gets i+1$\;
}
\caption{Finding the most violated inequality}
\end{algorithm}









\end{document}