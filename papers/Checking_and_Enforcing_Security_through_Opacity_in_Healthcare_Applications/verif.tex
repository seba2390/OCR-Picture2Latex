\addcontentsline{toc}{section}{Modeling and Verification}
\section{Modeling and Verification}
The case study contains five services, namely, a connected bracelet (Br), a fog node (Fog), a private cloud (CPr), a public cloud (CPub), and a smartphone application (App). Figure \ref{fig:owfnet} depicts the oWF-nets of the Br, Fog, CPr, CPub and the App, respectively. We note that the transitions entailing the sending (respectively reception) of a messages are indicated by adding a ! (respectively a ?) mark.
\input{owfnet.tex}
In this case study we want to illustrate the ability of the SOG-based verification approach to meet privacy demands. The first step is to create the underlying LTS of each oWf-net. Secondly, we identify the observable and unobservable actions of each net as well as the secret states. Then, we build the SOG models from each net’s LTS using the data from the previous step verifying, at the same time, their opacity.

The Br workflow (Figure \ref{fig:brnet}) starts by collecting data ($T_1$) through the sensors mounted in the bracelet, which will then be sent to the closest Fog node. Next it creates the message comprising the data ($T_2$) and sends this message ($T_3?$). Not having any security requirements for the bracelet, thus, there is no need to check its opacity.

The Fog WS (Figure \ref{fig:fognet}) has an internal set of operations, and a set of external cooperative ones. The second set concerns the exchanges of the fog with the Br, the CPr and the App. After receiving the data ($T_1!$), we consider two scenarios. The first is when the Fog communicates for the 1st time with the bracelet ($T_3$). In this case, it sends a request ($T_5?$) to the App to retrieve data from the patient's medical history. Then, it will receive these data through ($T_6!$). The second scenario begins by selecting the last recorded data ($T_4$). The next step is to compare ($T_7$) the data retrieved by one of the mentioned scenarios with the data sent by the Br. When the node detects a change in values ($T_9$), it will immediately transmit the data to CPr ($T_{10}?$). If there is no change ($T_8$), the Fog doesn't perform any processing. Finally, the new data will be stored locally in the Fog ($T_{11}$). To ensure the
privacy of fog secret information, we define the secret state $S=\{S_6\}$ which is related to receiving patient's medical history. To conform with the security needs, the observable transitions of the Fog are $\Sigma_{o} = \{T_1!,T_5?,T_6!,T_{10}?\}$, while
the unobservable part is $\Sigma_{u}=\{T_2,T_3,T_4,T_7,T_8,T_9,T_{11}\}$. Using this data, and after creating the LTS, we proceed to the opacity verification which is done on-the-ﬂy, while creating the SOG-abstraction of the model. We get the SOG in Figure \ref{fig:sogfog} and we note that we have a single secret state belonging to an aggregate which holds other, non secret, states. We can conclude, then that the fog's SOG is both simple, and $K$-step weakly and strongly opaque.

The CPr worflow (Figure \ref{fig:cprnet}) contains two scenarios. The first one starts by receiving the data of a new registered patient ($T_1!$). The CPr subsequently proceeds with the recording ($T_2$) and the anonymization ($T_3$) of the received data. The anonymised data will then be transmitted to the CPub ($T_4?$). After receiving ($T_5!$) the class, this latter is associated with the patient ($T_6$). The second scenario starts when the CPr receives ($T_7!$) the data sent by the Fog. The CPr combines the data with the patient by searching for its unique identifier (ID)($T_8$). If the ID cannot be found ($T_9$), the CPr sends a request to the App so that the patient re-enter his personal information ($T_{10}?$). Thereafter, it receives the requested data ($T_{11}!$) and it  pursues the first scenario. For the second case, when the ID is found, the CPr transmits the data and the class to which the patient belongs to the CPub ($T_{13}?$). Afterwards, the CPr receives and records respectively 3 types of messages, each one belongs to an alert type: low ($T_{14}!$ \& T15), medium ($T_{16}!$ \& $T_{17}$) and high ($T_{19}!$ \& $T_{20}$). To protect the privacy of individual patients, the CPr need to hide the update procedure performed on the patient's personal information. It must keep secret the states related to the new patient registration ($S_4$ \& $S_{16}$) and the anonymization of his data ($S_7$ \& $S_{21}$). It is also required to withhold secret the states related to sending alerts when the symptoms of a heart attack are detected ($S_{22}$ \& $S_{23}$). So the set of secret states for the CPr is $S=\{S_1,S_3,S_4,S_7,S_16,S_{21},S_{22},S_{23}\}$, where $S_1$ stands for the marking related to the reception of the data sent by the fog, while $S_3$ reflects that related to patient ID search. To conform with these needs, the observable transitions of the CPr are $\Sigma_{o}=\{T_1!,T_4?,T_5!,T_7!,T_{10}?,T_{11}!,T_{13}?,T_{14}!,T_{16}!,T_{18}?,T_{19}!,T_{21}?\}$, while the unobservable ones are $\Sigma_{u}=\{T_2,T_3,T_6,T_8,T_9,T_{12},T_{15},T_{17},T_{20}\}$. With this configuration, we conduct the opacity verification and get the SOG in Figure \ref{fig:sogcpr}. Thus, the CPr workflow is not opaque and is not k-step weakly and strongly opaque. Indeed, the two secret states $S_{22}$ and $S_{23}$, each belonging to an aggregate that doesn't hold other non-secret states. An attacker can then disclose secret information after the traces $T_7T_{13}T_{16}T_{18}$ and $T_7T_{13}T_{19}T_{21}$. The CPr service is therefore unsafe and needs to be improved to adapt it to handle private data.
\input{sog.tex}
Taking into account that the public cloud is available for public use, we don't have secrets to be hidden from an external observer. So, in the following, we will only describe the CPub actions (Figure \ref{fig:cpubnet}) and we won't proceed the opacity verification. The first set of CPub operations concerns the internal operations which include the processing of the data sent by the CPr: the classification ($T_2$) and the prediction ($T_5$) which in our case aims to detect the risk of heart attack. As regards the external operations, the CPub receives two messages from the CPr. The first one ($T_1$) includes the anonymised data and the second ($T_4$) includes the data collected by the Br and the class to which the patient belongs. In response to the received messages, the CPub sends the classification result to the CPr ($T_3$) and sends 3 types of alerts according to the results obtained from the prediction: $T_6$ for the low alert, ($T_7$ for the medium alert and $T_8$ for the high alert.

The last service is that of the App (Figure \ref{fig:appnet}). The set of internal operations of the App consists of two actions. The first action concerns the notification ($T_9$) through which the application warns the patient. The second concerns the application to register ($T_1$) which allows a new patient to deposit his information. After registration, the provided information will be sent ($T_2$) to the CPr. The App shares patient information with the Fog ($T_3!$ \& $T_4?$) when this latter communicates for the first time with the Br. It also shares the medical history with the CPr ($T_5!$ \& $T_6$) when it fails to find the patient ID. At the end, the App receives two types of alerts ($T_7?$ for the medium alert and $T_8?$ for the high alert) when the risk of a heart attack is detected. The App must be opaque to both sides of the communication with regards to its set of secret states when dealing with either the CPr or the Fog. To match these needs the
observable transitions of the App is  $\Sigma_{o}=\{T_2?,T_3!,T_4?,T_5!,T_6?,T_7!,T_8!\}$, while the unobservable ones are $\Sigma_{u}=\{T_1,T_9\}$. Moreover, the set of secret states are $S=\{S_2,S_6,S_7,S_9,S_{10},S_{11}\}$, with $S_2$ is the marking related to the request to register of a new patient, $S_6$ is that related to the sending of patient data, $S_7$ is that triggered due to the sending of personal information of a new patient, $S_{11}$ is related to the sending of medical history, and finally $S_9$ and $S_{10}$ reflect the secrets associated with sending the notification to warn the patient. Conducting the opacity verification for the App, we obtain the SOG depicted in Figure \ref{fig:sogapp}. We say that the App SOG is not opaque according to Definition \ref{def:simpleop}. Consequently it is not
$K$-step weakly, and strongly opaque.