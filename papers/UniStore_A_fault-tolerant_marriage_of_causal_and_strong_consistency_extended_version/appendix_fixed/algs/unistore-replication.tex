
\begin{algorithm*}[t]
  \caption{Transaction replication at $p^m_d$}
  \label{alg:unistore-replication}
  \begin{algorithmic}[1]
    \Function{\propagate}{\null} \Comment{Run periodically}
      \label{line:function-propagate}
      \If{$\preparedcausal = \emptyset$}
          \label{line:propagate-preparedcausal-empty}
        \State $\knownVC[d] \gets \clockVar$
          \label{line:propagate-knownvc-clock}
      \Else
        \State $\knownVC[d] \gets
          \min\set{\tsvar \mid \langle \_, \_, \tsvar \rangle \in \preparedcausal} - 1$
        \label{line:propagate-knownvc-ts}
      \EndIf

      \hStatex
      \State \var $\txsvar \gets \set{\langle \_, \_, \commitvc, \lccolor{\_}
        \rangle \in \committedcausal[d] \mid \commitvc[d] \le \knownVC[d]}$
        \label{line:propagate-txs}

      \If{$\txsvar \neq \emptyset$}
        \label{line:propagate-txs-nonempty}
        \State \send $\replicate(d, \txsvar) \sendto p^{m}_{i}$,
          $i \in \D \setminus \set{d}$
          \label{line:propagate-call-replicate}
        \State $\committedcausal[d] \gets \committedcausal[d] \setminus \txsvar$
          \label{line:propagate-committedblue}
      \Else
        \State \send $\heartbeat(d, \knownVC[d]) \sendto p^{m}_{i}$,
          $i \in \D \setminus \set{d}$
          \label{line:propagate-call-heartbeat}
      \EndIf
    \EndFunction

    \Statex
    \WhenRcv[\replicate($i, \txsvar$)]
      \label{line:function-replicate}
      \ForAll{$\langle \tidvar, \wbuffvar, \commitvc, \lccolor{\lcvar} \rangle \in \txsvar$
        in $\commitvc[i]$ order}
        \label{line:replicate-increasing-order}
        \If{$\commitvc[i] > \knownVC[i]$}
          \label{line:replicate-precondition}
          \ForAll{$\langle k, v \rangle \in \wbuffvar$}
            \State $\oplog[k] \gets \oplog[k] \cdot {\langle v, \commitvc, \lccolor{\lcvar} \rangle}$
            \label{line:replicate-oplog}
          \EndFor
          \State $\committedcausal[i] \gets \committedcausal[i] \cup
            \set{\langle \tidvar, \wbuffvar, \commitvc, \lccolor{\lcvar} \rangle}$
            \label{line:replicate-committedcausal}
          \State $\knownVC[i] \gets \commitvc[i]$
            \label{line:replicate-knownvc}
        \EndIf
      \EndFor
    \EndWhenRcv

    \Statex
    \WhenRcv[\heartbeat($i, \tsvar$)]
      \label{line:function-heartbeat}
      \State \pre $\tsvar > \knownVC[i]$
        \label{line:heartbeat-precondition}

      \hStatex
      \State $\knownVC[i] \gets \tsvar$
        \label{line:heartbeat-knownvc}
    \EndWhenRcv

    \Statex
    \Function{\forward}{$i, j$}
      \Comment{forward transactions received from data center $j \neq d$
        to data center $i \notin \set{d, j}$}
      \label{line:function-forward}
      \State \var $\txsvar \gets \set{\langle \tidvar, \_, \commitvc, \lccolor{\_} \rangle
        \in \committedcausal[j] \mid \commitvc[j] > \globalmatrix[i][j]}$
        \label{line:forward-txs}
      \If{$\txsvar \neq \emptyset$}
        \label{line:forward-txs-nonempty}
        \State \send $\replicate(j, \txsvar) \sendto p^m_i$
          \label{line:forward-call-replicate}
      \Else
        \State \send $\heartbeat(j, \knownVC[j]) \sendto p^m_i$
          \label{line:forward-call-heartbeat}
      \EndIf
    \EndFunction
  \end{algorithmic}
\end{algorithm*}