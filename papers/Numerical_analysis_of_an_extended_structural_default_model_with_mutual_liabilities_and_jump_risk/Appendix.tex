\newpage
\appendix
\section{Pricing equations}
\subsection{Credit default swap}
\label{CDS_pricing}
A credit default swap (CDS) is a contract designed to exchange credit risk of a Reference Name (RN) between a Protection Buyer (PB) and a Protection Seller (PS). PB makes periodic coupon payments to PS conditional on no default of RN, up to the nearest payment date, in the exchange for receiving from PS the loss given RN's default.

Consider a CDS contract written on the first bank (RN), denote its price $C_1(t, x)$.\footnote{For the CDS contracts written on the second bank, the similar expression could be provided by analogy.} We assume that the coupon is paid continuously and equals to $c$. Then, the value of a standard CDS contract can be given (\cite{BieleckiRutkowski}) by the solution of  (\ref{kolm_1})--(\ref{kolm_2})  with $\chi(t, x) = c$ and terminal condition
\begin{equation*}
	\psi(x) = 
	\begin{cases}
		1 - \min(R_1, \tilde{R}_1(1)), \quad (x_1, x_2) \in D_2, \\
		1 - \min(R_1, \tilde{R}_1(\omega_2)), \quad (x_1, x_2) \in D_{12}, \\		
	\end{cases}
\end{equation*}
where $\omega_2 = \omega_2(x)$ is defined in (\ref{term_cond}) and 
\begin{equation*}
	\tilde{R}_1(\omega_2) = \min \left[1, \frac{A_1(T) +  \omega_2 L_{2 1}(T)}{L_1(T) + \omega_2 L_{12}(T)}\right].
\end{equation*}
Thus, the pricing problem for CDS contract on the first bank is
\begin{equation}
\begin{aligned}
		& \frac{\partial}{\partial t} C_1(t, x) + \mathcal{L} C_1(t, x) = c, \\
		& C_1(t, 0, x_2) = 1 - R_1, \quad C_1(t, \infty, x_2) = -c(T-t), \\
		& C_1(t, x_1, 0) = \Xi(t, x_1) = 
		\begin{cases}
			c_{1,0}(t, x_1), & x_1 \ge \tilde{\mu}_1, \\
			1-R_1, & x_1 < \tilde{\mu}_i,
		\end{cases} \quad C_1(t, x_1, \infty) = c_{1,\infty}(t, x_1),\\
		& C_1(T, x) = \psi(x) = 
	\begin{cases}
		1 - \min(R_1, \tilde{R}_1(1)), \quad (x_1, x_2) \in D_2, \\
		1 - \min(R_1, \tilde{R}_1(\omega_2)), \quad (x_1, x_2) \in D_{12}, \\		
	\end{cases}
\end{aligned}
\end{equation}
where $c_{1,0}(t, x_1)$ is the solution of the following boundary value problem:
\begin{equation}
\begin{aligned}
		& \frac{\partial}{\partial t} c_{1, 0}(t, x_1) + \mathcal{L}_1 c_{1, 0}(t, x_1) = c, \\
		& c_{1, 0}(t, \tilde{\mu}_1^{<}) = 1 - R_1, \quad c_{1, 0}(t, \infty) = -c(T-t), \\
		& c_{1, 0}(T, x_1) = (1 - R_1) \mathbbm{1}_{\{\tilde{\mu}_1^{<} \le x_1 \le \tilde{\mu}_1^{=}\}}, 
\end{aligned}
\end{equation}
and $c_{1,\infty}(t, x_1)$ is the solution of the following boundary value problem
\begin{equation}
\begin{aligned}
		& \frac{\partial}{\partial t} c_{1, \infty}(t, x_1) + \mathcal{L}_1 c_{1, \infty}(t, x_1) = c, \\
		& c_{1, \infty}(t, 0) = 1 - R_1, \quad c_{1, \infty}(t, \infty) = -c(T-t), \\
		& c_{1, \infty}(T, x_1) = (1 - R_1) \mathbbm{1}_{\{x_1 \le \mu_1^{=}\}}.
\end{aligned}
\end{equation}

\subsection{First-to-default swap}
An FTD contract refers to a basket of reference names (RN). Similar to a regular CDS, the Protection Buyer (PB) pays a regular coupon payment $c$ to the Protection Seller (PS) up to the first default of any of the RN in the basket or maturity time $T$. In return, PS compensates PB the loss caused by the first default.

Consider the FTD contract referenced on $2$ banks, and denote its price $F(t, x)$. We assume that the coupon is paid continuously and equals to $c$. Then, the value of FTD contract can be given (\cite{LiptonItkin2015}) by the solution of  (\ref{kolm_1})--(\ref{kolm_2})  with $\chi(t, x) = c$ and terminal condition
\begin{equation*}
	\psi(x) = \beta_0  \mathbbm{1}_{\{x \in D_{12}\}} + \beta_1 \mathbbm{1}_{\{x \in D_{1}\}} + \beta_2 \mathbbm{1}_{\{x \in D_{2}\}},
\end{equation*}
where
\begin{equation*}
	\begin{aligned}
		\beta_0 = 1 - \min[\min(R_1, \tilde{R}_1(\omega_2), \min(R_2, \tilde{R}_2(\omega_1)], \\
		\beta_1 = 1 - \min(R_2, \tilde{R}_2(1)), \quad \beta_2 = 1 - \min(R_1, \tilde{R}_1(1)),
	\end{aligned}
\end{equation*}
and
\begin{equation*}
	\tilde{R}_1(\omega_2) = \min \left[1, \frac{A_1(T) +  \omega_2 L_{2 1}(T)}{L_1(T) + \omega_2 L_{12}(T)}\right], \quad \tilde{R}_2(\omega_1) = \min \left[1, \frac{A_2(T) +  \omega_1 L_{1 2}(T)}{L_2(T) + \omega_1 L_{21}(T)}\right].
\end{equation*}
with $\omega_1 = \omega_1(x)$ and $\omega_2 = \omega_2(x)$ defined in (\ref{term_cond}).

Thus, the pricing problem for a FTD contract is
\begin{equation}
\begin{aligned}
		& \frac{\partial}{\partial t} F(t, x) + \mathcal{L} F(t, x) = c, \\
		& F(t, x_1, 0) = 1 - R_2,  \quad F(t, 0, x_2) = 1 - R_1, \\
		& F(t, x_1, \infty) = f_{2,\infty}(t, x_1), \quad F(t, \infty, x_2) = f_{1,\infty}(t, x_2), \\
		& F(T, x) = \beta_0  \mathbbm{1}_{\{x \in D_{12}\}} + \beta_1 \mathbbm{1}_{\{x \in D_{1}\}} + \beta_2 \mathbbm{1}_{\{x \in D_{2}\}},
\end{aligned}
\end{equation}
where $f_{1,\infty}(t, x_1)$ and $f_{2,\infty}(t, x_2)$ are the solutions of the following boundary value problems
\begin{equation}
\begin{aligned}
		& \frac{\partial}{\partial t} f_{i, \infty}(t, x_i) + \mathcal{L}_i f_{i, \infty}(t, x_i) = c, \\
		& f_{i, \infty}(t, 0) = 1 - R_i, \quad f_{i, \infty}(t, \infty) = -c(T-t), \\
		& f_{1, \infty}(T, x_i) = (1 - R_i) \mathbbm{1}_{\{x_i \le \mu_i^{=}\}}.
\end{aligned}
\end{equation}

\subsection{Credit and Debt Value Adjustments for CDS}

Credit Value Adjustment and Debt Value Adjustment can be considered either unilateral or bilateral. For unilateral counterparty risk, we need to consider only two banks (RN, and PS for CVA and PB for DVA), and a two-dimensional problem can be formulated, while bilateral counterparty risk requires a three-dimensional problem, where Reference Name, Protection Buyer, and Protection Seller are all taken into account. We follow \cite{LiptonSav} for the pricing problem formulation but include jumps and mutual liabilities, which affects the boundary conditions.

\paragraph{Unilateral CVA and DVA}
The Credit Value Adjustment represents the additional price associated with the possibility of a counterparty's default. Then, CVA can be defined as
\begin{equation}
	V^{CVA} = (1- R_{PS}) \mathbb{E}[\mathbbm{1}_{\{\tau^{PS} < \min(T, \tau^{RN}) \}} (V_{\tau^{PS}}^{CDS})^{+} \, | \mathcal{F}_t],
\end{equation}
where $R_{PS}$ is the recovery rate of PS, $\tau^{PS}$ and $\tau^{RN}$ are the default times of PS and RN, and $V_t^{CDS}$ is the price of a CDS without counterparty credit risk.

We associate $x_1$ with the Protection Seller and $x_2$ with the Reference Name, then CVA can be given by the solution of  (\ref{kolm_1})--(\ref{kolm_2})  with $\chi(t, x) = 0$ and $\psi(x) = 0$. Thus,
\begin{equation}
\begin{aligned}
		& \frac{\partial}{\partial t} V^{CVA}+ \mathcal{L} V^{CVA} = 0, \\
		& V^{CVA}(t, 0, x_2) = (1 - R_{PS}) V^{CDS}(t, x_2)^{+}, \quad V^{CVA}(t, x_1, 0) = 0, \\
		& V^{CVA}(T, x_1, x_2) = 0.
\end{aligned}
\end{equation}

Similar, Debt Value Adjustment represents the additional price associated with the default and defined as
\begin{equation}
	V^{DVA} = (1- R_{PB}) \mathbb{E}[\mathbbm{1}_{\{\tau^{PB} < \min(T, \tau^{RN}) \}} (V_{\tau^{PB}}^{CDS})^{-} \, | \mathcal{F}_t],
\end{equation}
where $R_{PB}$ and $\tau^{PB}$ are the recovery rate and default time of the protection buyer.

Here, we associate $x_1$ with the Protection Buyer and $x_2$ with the Reference Name, then, similar to CVA,  DVA can be given by the solution of  (\ref{kolm_1})--(\ref{kolm_2}),
\begin{equation}
\begin{aligned}
		& \frac{\partial}{\partial t} V^{DVA}+ \mathcal{L} V^{DVA} = 0, \\
		& V^{DVA}(t, 0, x_2) = (1 - R_{PB}) V^{CDS}(t, x_2)^{-}, \quad V^{DVA}(t, x_1, 0) = 0, \\
		& V^{DVA}(T, x_1, x_2) = 0.
\end{aligned}
\end{equation}

\paragraph{Bilateral CVA and DVA}

When we defined unilateral CVA and DVA, we assumed that either protection  buyer, or protection seller are risk-free. Here we assume that they are both risky. Then, 
The Credit Value Adjustment represents the additional price associated with the possibility of counterparty's default and defined as
\begin{equation}
	V^{CVA} = (1 - R_{PS}) \mathbb{E}[\mathbbm{1}_{\{\tau^{PS} < \min(\tau^{PB}, \tau^{RN}, T)\}} (V^{CDS}_{\tau^{PS}})^{+} \, | \mathcal{F}_t],
\end{equation} 

Similar, for DVA
\begin{equation}
	V^{DVA} = (1 - R_{PB}) \mathbb{E}[\mathbbm{1}_{\{\tau^{PB} < \min(\tau^{PS}, \tau^{RN}, T)\}} (V^{CDS}_{\tau^{PB}})^{-} \, | \mathcal{F}_t],
\end{equation} 


We associate $x_1$ with protection seller, $x_2$ with protection buyer, and $x_3$ with reference name. Here, we have a three-dimensional process. Applying three-dimensional version of (\ref{kolm_1})--(\ref{kolm_2}) with $\psi(x) = 0, \chi(t, x) = 0$, we get
\begin{equation}
	\label{CVA_pde}
\begin{aligned}
		& \frac{\partial}{\partial t} V^{CVA} + \mathcal{L}_3 V^{CVA} = 0, \\
		& V^{CVA}(t, 0, x_2, x_3) = (1 - R_{PS}) V^{CDS}(t, x_3)^{+}, \\
		& V^{CVA}(t, x_1, 0, x_3 ) = 0, \quad V^{CVA}(t, x_1, x_2, 0)  = 0, \\
		& V^{CVA}(T, x_1, x_2, x_3) = 0,
\end{aligned}
\end{equation}
and
\begin{equation}
\label{DVA_pde}
\begin{aligned}
		& \frac{\partial}{\partial t} V^{DVA} + \mathcal{L}_3 V^{DVA} = 0, \\
		& V^{DVA}(t, 0, x_2, x_3) = (1 - R_{PB}) V^{CDS}(t, x_3)^{-}, \\
		& V^{DVA}(t, x_1, 0, x_3 ) = 0, \quad V^{DVA}(t, x_1, x_2, 0)  = 0, \\
		& V^{DVA}(T, x_1, x_2, x_3) = 0,
\end{aligned}
\end{equation}
where $\mathcal{L}_3 f$ is the three-dimensional infinitesimal generator.


