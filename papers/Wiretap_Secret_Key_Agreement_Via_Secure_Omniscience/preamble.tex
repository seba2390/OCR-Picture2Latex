\usepackage[font=footnotesize,format=plain,skip=15pt,labelsep=period]{caption}
%\usepackage[OT1,T1]{fontenc}

\usepackage[numbers,sort&compress]{natbib}
\renewcommand{\bibfont}{\footnotesize}
%\usepackage{cite}
%\usepackage{mystyle}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\makeatletter

\usepackage{etex}
\usepackage{enumerate}
%%% Review %%%

\usepackage{zref-savepos}

\newcounter{mnote}%[page]
\renewcommand{\themnote}{p.\thepage\;$\langle$\arabic{mnote}$\rangle$}

\def\xmarginnote{%
  \xymarginnote{\hskip -\marginparsep \hskip -\marginparwidth}}

\def\ymarginnote{%
  \xymarginnote{\hskip\columnwidth \hskip\marginparsep}}

\long\def\xymarginnote#1#2{%
\vadjust{#1%
\smash{\hbox{{%
        \hsize\marginparwidth
        \@parboxrestore
        \@marginparreset
\footnotesize #2}}}}}

\def\mnoteson{%
\gdef\mnote##1{\refstepcounter{mnote}\label{##1}%
  \zsavepos{##1}%
  \ifnum20432158>\number\zposx{##1}%
  \xmarginnote{{\color{blue}\bf $\langle$\arabic{mnote}$\rangle$}}% 
  \else
  \ymarginnote{{\color{blue}\bf $\langle$\arabic{mnote}$\rangle$}}%
  \fi%
}
  }
\gdef\mnotesoff{\gdef\mnote##1{}}
\mnoteson
\mnotesoff








%%% Layout %%%

% \usepackage{geometry} % override layout
% \geometry{tmargin=2.5cm,bmargin=m2.5cm,lmargin=3cm,rmargin=3cm}
% \setlength{\pdfpagewidth}{8.5in} % overrides default pdftex paper size
% \setlength{\pdfpageheight}{11in}

\newlength{\mywidth}

%%% Conventions %%%

% References
\newcommand{\figref}[1]{Fig.~\ref{#1}}
\newcommand{\defref}[1]{Definition~\ref{#1}}
\newcommand{\tabref}[1]{Table~\ref{#1}}
% general
%\usepackage{ifthen,nonfloat,subfigure,rotating,array,framed}
\usepackage{framed}
%\usepackage{subfigure}
%\usepackage{subcaption}
\usepackage{comment}
%\specialcomment{nb}{\begingroup \noindent \framed\textbf{n.b.\ }}{\endframed\endgroup}
%%\usepackage{xtab,arydshln,multirow}
% topcaption defined in xtab. must load nonfloat before xtab
%\PassOptionsToPackage{svgnames,dvipsnames}{xcolor}
\usepackage[svgnames,dvipsnames]{xcolor}
%\definecolor{myblue}{rgb}{.8,.8,1}
%\definecolor{umbra}{rgb}{.8,.8,.5}
%\newcommand*\mybluebox[1]{%
%  \colorbox{myblue}{\hspace{1em}#1\hspace{1em}}}
\usepackage[all]{xy}
%\usepackage{pstricks,pst-node}
\usepackage{tikz}
\usetikzlibrary{positioning,matrix,through,calc,arrows,fit,shapes,decorations.pathreplacing,decorations.markings,trees}

\tikzstyle{block} = [draw,fill=blue!20,minimum size=2em]



% typsetting math
\usepackage{qsymbols,amssymb,mathrsfs}
\usepackage{amsmath}
\usepackage[standard,thmmarks]{ntheorem}
\theoremstyle{plain}
\theoremsymbol{\ensuremath{_\vartriangleleft}}
\theorembodyfont{\itshape}
\theoremheaderfont{\normalfont\bfseries}
\theoremseparator{}
\newtheorem{Claim}{Claim}
\newtheorem{Subclaim}{Subclaim}
\theoremstyle{nonumberplain}
\theoremheaderfont{\scshape}
\theorembodyfont{\normalfont}
\theoremsymbol{\ensuremath{_\blacktriangleleft}}
\newtheorem{Subproof}{Proof}

\theoremnumbering{arabic}
\theoremstyle{plain}
\usepackage{latexsym}
\theoremsymbol{\ensuremath{_\Box}}
\theorembodyfont{\itshape}
\theoremheaderfont{\normalfont\bfseries}
\theoremseparator{}
\newtheorem{Conjecture}{Conjecture}

\theorembodyfont{\upshape}
\theoremprework{\bigskip\hrule}
\theorempostwork{\hrule\bigskip}
\newtheorem{Condition}{Condition}%[section]


%\RequirePckage{amsmath} loaded by empheq
\usepackage[overload]{empheq} % no \intertext and \displaybreak
%\usepackage{breqn}

\let\iftwocolumn\if@twocolumn
\g@addto@macro\@twocolumntrue{\let\iftwocolumn\if@twocolumn}
\g@addto@macro\@twocolumnfalse{\let\iftwocolumn\if@twocolumn}

%\empheqset{box=\mybluebox}
%\usepackage{mathtools}      % to polish math typsetting, loaded
%                                % by empeq
\mathtoolsset{showonlyrefs=false,showmanualtags}
\let\underbrace\LaTeXunderbrace % adapt spacing to font sizes
\let\overbrace\LaTeXoverbrace
\renewcommand{\eqref}[1]{\textup{(\refeq{#1})}} % eqref was not allowed in
                                       % sub/super-scripts
\newtagform{brackets}[]{(}{)}   % new tags for equations
\usetagform{brackets}
% defined commands:
% \shortintertext{}, dcases*, \cramped, \smashoperator[]{}

\usepackage[Smaller]{cancel}
\renewcommand{\CancelColor}{\color{Red}}
%\newcommand\hcancel[2][black]{\setbox0=\hbox{#2}% colored horizontal cross
%  \rlap{\raisebox{.45\ht0}{\color{#1}\rule{\wd0}{1pt}}}#2}

% hyperlink
\PassOptionsToPackage{breaklinks,hyperindex=true,backref=false,bookmarksnumbered,bookmarksopen,linktocpage,colorlinks,linkcolor=BrickRed,citecolor=OliveGreen,urlcolor=Blue,pdfstartview=FitH}{hyperref}
\usepackage{hyperref}

% makeindex style
\newcommand{\indexmain}[1]{\textbf{\hyperpage{#1}}}

\usepackage{graphicx,psfrag}
\graphicspath{{figure/}{image/}} % Search path of figures

% for tabular
\usepackage{diagbox} % \backslashbox{}{} for slashed entries
%\usepackage{threeparttable} % threeparttable, \tnote{},
                                % tablenotes, and \item[]
%\usepackage{colortab} % \cellcolor[gray]{0.9},
%\rowcolor,\columncolor,
%\usepackage{colortab} % \LCC \gray & ...  \ECC \\

% typesetting codes
%\usepackage{maple2e} % need to use \char29 for ^
\usepackage{algorithm2e}
\usepackage{listings} 
\lstdefinelanguage{Maple}{
  morekeywords={proc,module,end, for,from,to,by,while,in,do,od
    ,if,elif,else,then,fi ,use,try,catch,finally}, sensitive,
  morecomment=[l]\#,
  morestring=[b]",morestring=[b]`}[keywords,comments,strings]
\lstset{
  basicstyle=\scriptsize,
  keywordstyle=\color{ForestGreen}\bfseries,
  commentstyle=\color{DarkBlue},
  stringstyle=\color{DimGray}\ttfamily,
  texcl
}
%%% New fonts %%%
\DeclareMathAlphabet{\mathpzc}{OT1}{pzc}{m}{it}
\usepackage{upgreek} % \upalpha,\upbeta, ...
%\usepackage{bbold}   % blackboard math
\usepackage{dsfont}  % \mathds

%%% Macros for multiple definitions %%%

% example usage:
% \multi{M}{\boldsymbol{#1}}  % defines \multiM
% \multi ABC.                 % defines \MA \MB and \MC as
%                             % \boldsymbol{A}, \boldsymbol{B} and
%                             % \boldsymbol{C} respectively.
% 
%  The last period '.' is necessary to terminate the macro expansion.
%
% \multi*{M}{\boldsymbol{#1}} % defines \multiM and \M
% \M{A}                       % expands to \boldsymbol{A}

\def\multi@nostar#1#2{%
  \expandafter\def\csname multi#1\endcsname##1{%
    \if ##1.\let\next=\relax \else
    \def\next{\csname multi#1\endcsname}     
    %\expandafter\def\csname #1##1\endcsname{#2}
    \expandafter\newcommand\csname #1##1\endcsname{#2}
    \fi\next}}

\def\multi@star#1#2{%
  \expandafter\def\csname #1\endcsname##1{#2}
  \multi@nostar{#1}{#2}
}

\newcommand{\multi}{%
  \@ifstar \multi@star \multi@nostar}

%%% new alphabets %%%

\multi*{rm}{\mathrm{#1}}
\multi*{mc}{\mathcal{#1}}
\multi*{op}{\mathop {\operator@font #1}}
% \multi*{op}{\operatorname{#1}}
\multi*{ds}{\mathds{#1}}
\multi*{set}{\mathcal{#1}}
\multi*{rsfs}{\mathscr{#1}}
\multi*{pz}{\mathpzc{#1}}
\multi*{M}{\boldsymbol{#1}}
\multi*{R}{\mathsf{#1}}
\multi*{RM}{\M{\R{#1}}}
\multi*{bb}{\mathbb{#1}}
\multi*{td}{\tilde{#1}}
\multi*{tR}{\tilde{\mathsf{#1}}}
\multi*{trM}{\tilde{\M{\R{#1}}}}
\multi*{tset}{\tilde{\mathcal{#1}}}
\multi*{tM}{\tilde{\M{#1}}}
\multi*{baM}{\bar{\M{#1}}}
\multi*{ol}{\overline{#1}}


\multirm  ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz.
\multiol  ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz.
\multitR   ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz.
\multitd   ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz.
\multitset ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz.
\multitM   ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz.
\multibaM   ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz.
\multitrM   ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz.
\multimc   ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz.
\multiop   ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz.
\multids   ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz.
\multiset  ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz.
\multirsfs ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz.
\multipz   ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz.
\multiM    ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz.
\multiR    ABCDEFGHIJKL NO QRSTUVWXYZabcd fghijklmnopqrstuvwxyz.
\multibb   ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz.
\multiRM   ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz.
\newcommand{\RRM}{\R{M}}
\newcommand{\RRP}{\R{P}}
\newcommand{\RRe}{\R{e}}
\newcommand{\RRS}{\R{S}}
%%% new symbols %%%

%\newcommand{\dotgeq}{\buildrel \textstyle  .\over \geq}
%\newcommand{\dotleq}{\buildrel \textstyle  .\over \leq}
\newcommand{\dotleq}{\buildrel \textstyle  .\over {\smash{\lower
      .2ex\hbox{\ensuremath\leqslant}}\vphantom{=}}}
\newcommand{\dotgeq}{\buildrel \textstyle  .\over {\smash{\lower
      .2ex\hbox{\ensuremath\geqslant}}\vphantom{=}}}

\DeclareMathOperator*{\argmin}{arg\,min}
\DeclareMathOperator*{\argmax}{arg\,max}

%%% abbreviations %%%

% commands
\newcommand{\esm}{\ensuremath}

% environments
\newcommand{\bM}{\begin{bmatrix}}
\newcommand{\eM}{\end{bmatrix}}
\newcommand{\bSM}{\left[\begin{smallmatrix}}
\newcommand{\eSM}{\end{smallmatrix}\right]}
\renewcommand*\env@matrix[1][*\c@MaxMatrixCols c]{%
  \hskip -\arraycolsep
  \let\@ifnextchar\new@ifnextchar
  \array{#1}}



% sets of number
\newqsymbol{`N}{\mathbb{N}}
\newqsymbol{`R}{\mathbb{R}}
%\newqsymbol{`P}{\mathbb{P}}
\newqsymbol{`Z}{\mathbb{Z}}

% symbol short cut
\newqsymbol{`|}{\mid}
% use \| for \parallel
\newqsymbol{`8}{\infty}
\newqsymbol{`1}{\left}
\newqsymbol{`2}{\right}
\newqsymbol{`6}{\partial}
\newqsymbol{`0}{\emptyset}
\newqsymbol{`-}{\leftrightarrow}
%\newqsymbol{`<}{\langle}
%\newqsymbol{`>}{\rangle}

%%% new operators / functions %%%

\newcommand{\sgn}{\operatorname{sgn}}
\newcommand{\Var}{\op{Var}}
\newcommand{\diag}{\operatorname{diag}}
\newcommand{\erf}{\operatorname{erf}}
\newcommand{\erfc}{\operatorname{erfc}}
\newcommand{\erfi}{\operatorname{erfi}}
\newcommand{\adj}{\operatorname{adj}}
\newcommand{\supp}{\operatorname{supp}}
\newcommand{\E}{\opE\nolimits}
\newcommand{\T}{\intercal}
% requires mathtools
% \abs,\abs*,\abs[<size_cmd:\big,\Big,\bigg,\Bigg etc.>]
%\usepackage{MnSymbol}

\DeclareFontFamily{OMX}{MnSymbolE}{}
\DeclareSymbolFont{MnLargeSymbols}{OMX}{MnSymbolE}{m}{n}
\SetSymbolFont{MnLargeSymbols}{bold}{OMX}{MnSymbolE}{b}{n}
\DeclareFontShape{OMX}{MnSymbolE}{m}{n}{
    <-6>  MnSymbolE5
   <6-7>  MnSymbolE6
   <7-8>  MnSymbolE7
   <8-9>  MnSymbolE8
   <9-10> MnSymbolE9
  <10-12> MnSymbolE10
  <12->   MnSymbolE12
}{}
\DeclareFontShape{OMX}{MnSymbolE}{b}{n}{
    <-6>  MnSymbolE-Bold5
   <6-7>  MnSymbolE-Bold6
   <7-8>  MnSymbolE-Bold7
   <8-9>  MnSymbolE-Bold8
   <9-10> MnSymbolE-Bold9
  <10-12> MnSymbolE-Bold10
  <12->   MnSymbolE-Bold12
}{}

\let\llangle\@undefined
\let\rrangle\@undefined
\DeclareMathDelimiter{\llangle}{\mathopen} {MnLargeSymbols}{'164}{MnLargeSymbols}{'164}
\DeclareMathDelimiter{\rrangle}{\mathclose} {MnLargeSymbols}{'171}{MnLargeSymbols}{'171}

\DeclarePairedDelimiter\Span{\llangle}{\rrangle}
\DeclarePairedDelimiter\abs{\lvert}{\rvert} 
\DeclarePairedDelimiter\norm{\lVert}{\rVert}
\DeclarePairedDelimiter\ceil{\lceil}{\rceil}
\DeclarePairedDelimiter\floor{\lfloor}{\rfloor}
\DeclarePairedDelimiter\Set{\{}{\}}
\newcommand{\imod}[1]{\allowbreak\mkern10mu({\operator@font mod}\,\,#1)}

%%% new formats %%%
\newcommand{\leftexp}[2]{{\vphantom{#2}}^{#1}{#2}}


% non-floating figures that can be put inside tables
\newenvironment{nffigure}[1][\relax]{\vskip \intextsep
  \noindent\minipage{\linewidth}\def\@captype{figure}}{\endminipage\vskip \intextsep}

\newcommand{\threecols}[3]{
\hbox to \textwidth{%
      \normalfont\rlap{\parbox[b]{\textwidth}{\raggedright#1\strut}}%
        \hss\parbox[b]{\textwidth}{\centering#2\strut}\hss
        \llap{\parbox[b]{\textwidth}{\raggedleft#3\strut}}%
    }% hbox 
}

\newcommand{\reason}[2][\relax]{
  \ifthenelse{\equal{#1}{\relax}}{
    \left(\text{#2}\right)
  }{
    \left(\parbox{#1}{\raggedright #2}\right)
  }
}

\newcommand{\marginlabel}[1]
{\mbox[]\marginpar{\color{ForestGreen} \sffamily \small \raggedright\hspace{0pt}#1}}


% up-tag an equation
\newcommand{\utag}[2]{\mathop{#2}\limits^{\text{(#1)}}}
\newcommand{\uref}[1]{(#1)}


% Notation table

\newcommand{\Hline}{\noalign{\vskip 0.1in \hrule height 0.1pt \vskip
    0.1in}}
  
\def\Malign#1{\tabskip=0in
  \halign to\columnwidth{
    \ensuremath{\displaystyle ##}\hfil
    \tabskip=0in plus 1 fil minus 1 fil
    &
    \parbox[t]{0.8\columnwidth}{##}
    \tabskip=0in
    \cr #1}}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% MISCELLANEOUS

% Modification from braket.sty by Donald Arseneau
% Command defined is: \extendvert{ }
% The "small versions" use fixed-size brackets independent of their
% contents, whereas the expand the first vertical line '|' or '\|' to
% envelop the content
\let\SavedDoubleVert\relax
\let\protect\relax
{\catcode`\|=\active
  \xdef\extendvert{\protect\expandafter\noexpand\csname extendvert \endcsname}
  \expandafter\gdef\csname extendvert \endcsname#1{\mskip-5mu \left.%
      \ifx\SavedDoubleVert\relax \let\SavedDoubleVert\|\fi
     \:{\let\|\SetDoubleVert
       \mathcode`\|32768\let|\SetVert
     #1}\:\right.\mskip-5mu}
}
\def\SetVert{\@ifnextchar|{\|\@gobble}% turn || into \|
    {\egroup\;\mid@vertical\;\bgroup}}
\def\SetDoubleVert{\egroup\;\mid@dblvertical\;\bgroup}

% If the user is using e-TeX with its \middle primitive, use that for
% verticals instead of \vrule.
%
\begingroup
 \edef\@tempa{\meaning\middle}
 \edef\@tempb{\string\middle}
\expandafter \endgroup \ifx\@tempa\@tempb
 \def\mid@vertical{\middle|}
 \def\mid@dblvertical{\middle\SavedDoubleVert}
\else
 \def\mid@vertical{\mskip1mu\vrule\mskip1mu}
 \def\mid@dblvertical{\mskip1mu\vrule\mskip2.5mu\vrule\mskip1mu}
\fi

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\makeatother

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%\usepackage{ctable}
\usepackage{fouridx}
%\usepackage{calc}
\usepackage{framed}
\usetikzlibrary{positioning,matrix}

\usepackage{paralist}
%\usepackage{refcheck}
\usepackage{enumerate}

\usepackage[normalem]{ulem}
\newcommand{\Ans}[1]{\uuline{\raisebox{.15em}{#1}}}



% \numberwithin{equation}{section}
% \makeatletter
% \@addtoreset{equation}{section}
% \renewcommand{\theequation}{\arabic{section}.\arabic{equation}}
% \@addtoreset{Theorem}{section}
% \renewcommand{\theTheorem}{\arabic{section}.\arabic{Theorem}}
% \@addtoreset{Lemma}{section}
% \renewcommand{\theLemma}{\arabic{section}.\arabic{Lemma}}
% \@addtoreset{Corollary}{section}
% \renewcommand{\theCorollary}{\arabic{section}.\arabic{Corollary}}
% \@addtoreset{Example}{section}
% \renewcommand{\theExample}{\arabic{section}.\arabic{Example}}
% \@addtoreset{Remark}{section}
% \renewcommand{\theRemark}{\arabic{section}.\arabic{Remark}}
% \@addtoreset{Proposition}{section}
% \renewcommand{\theProposition}{\arabic{section}.\arabic{Proposition}}
% \@addtoreset{Definition}{section}
% \renewcommand{\theDefinition}{\arabic{section}.\arabic{Definition}}
% \@addtoreset{Claim}{section}
% \renewcommand{\theClaim}{\arabic{section}.\arabic{Claim}}
% \@addtoreset{Subclaim}{Theorem}
% \renewcommand{\theSubclaim}{\theTheorem\Alph{Subclaim}}
% \makeatother

\newcommand{\Null}{\op{Null}}
%\newcommand{\T}{\op{T}\nolimits}
\newcommand{\Bern}{\op{Bern}\nolimits}
\newcommand{\odd}{\op{odd}}
\newcommand{\even}{\op{even}}
\newcommand{\Sym}{\op{Sym}}
\newcommand{\si}{s_{\op{div}}}
\newcommand{\sv}{s_{\op{var}}}
\newcommand{\Wtyp}{W_{\op{typ}}}
\newcommand{\Rco}{R_{\op{CO}}}
\newcommand{\Tm}{\op{T}\nolimits}
\newcommand{\JGK}{J_{\op{GK}}}

\newcommand{\diff}{\mathrm{d}}

\newenvironment{lbox}{
  \setlength{\FrameSep}{1.5mm}
  \setlength{\FrameRule}{0mm}
  \def\FrameCommand{\fboxsep=\FrameSep \fcolorbox{black!20}{white}}%
  \MakeFramed {\FrameRestore}}%
{\endMakeFramed}

\newenvironment{ybox}{
	\setlength{\FrameSep}{1.5mm}
	\setlength{\FrameRule}{0mm}
  \def\FrameCommand{\fboxsep=\FrameSep \fcolorbox{black!10}{yellow!8}}%
  \MakeFramed {\FrameRestore}}%
{\endMakeFramed}

\newenvironment{gbox}{
	\setlength{\FrameSep}{1.5mm}
\setlength{\FrameRule}{0mm}
  \def\FrameCommand{\fboxsep=\FrameSep \fcolorbox{black!10}{green!8}}%
  \MakeFramed {\FrameRestore}}%
{\endMakeFramed}

\newenvironment{bbox}{
	\setlength{\FrameSep}{1.5mm}
\setlength{\FrameRule}{0mm}
  \def\FrameCommand{\fboxsep=\FrameSep \fcolorbox{black!10}{blue!8}}%
  \MakeFramed {\FrameRestore}}%
{\endMakeFramed}

\newenvironment{yleftbar}{%
  \def\FrameCommand{{\color{yellow!20}\vrule width 3pt} \hspace{10pt}}%
  \MakeFramed {\advance\hsize-\width \FrameRestore}}%
 {\endMakeFramed}

\newcommand{\tbox}[2][\relax]{
 \setlength{\FrameSep}{1.5mm}
  \setlength{\FrameRule}{0mm}
  \begin{ybox}
    \noindent\underline{#1:}\newline
    #2
  \end{ybox}
}

\newcommand{\pbox}[2][\relax]{
  \setlength{\FrameSep}{1.5mm}
 \setlength{\FrameRule}{0mm}
  \begin{gbox}
    \noindent\underline{#1:}\newline
    #2
  \end{gbox}
}

\newcommand{\gtag}[1]{\text{\color{green!50!black!60} #1}}
\let\labelindent\relax
\usepackage{enumitem}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% fix subequations
% http://tex.stackexchange.com/questions/80134/nesting-subequations-within-align
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\usepackage{etoolbox}

% let \theparentequation use the same definition as equation
\let\theparentequation\theequation
% change every occurence of "equation" to "parentequation"
\patchcmd{\theparentequation}{equation}{parentequation}{}{}

\renewenvironment{subequations}[1][]{%              optional argument: label-name for (first) parent equation
	\refstepcounter{equation}%
	%  \def\theparentequation{\arabic{parentequation}}% we patched it already :)
	\setcounter{parentequation}{\value{equation}}%    parentequation = equation
	\setcounter{equation}{0}%                         (sub)equation  = 0
	\def\theequation{\theparentequation\alph{equation}}% 
	\let\parentlabel\label%                           Evade sanitation performed by amsmath
	\ifx\\#1\\\relax\else\label{#1}\fi%               #1 given: \label{#1}, otherwise: nothing
	\ignorespaces
}{%
	\setcounter{equation}{\value{parentequation}}%    equation = subequation
	\ignorespacesafterend
}

\newcommand*{\nextParentEquation}[1][]{%            optional argument: label-name for (first) parent equation
	\refstepcounter{parentequation}%                  parentequation++
	\setcounter{equation}{0}%                         equation = 0
	\ifx\\#1\\\relax\else\parentlabel{#1}\fi%         #1 given: \label{#1}, otherwise: nothing
}
