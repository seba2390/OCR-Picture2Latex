

\section{Letter-Bounded Constraint Languages}
\label{sec:strictly_bounded_case}



% % begriff einführen, das man annehemn kann "nachbarn" verschieden
% % dann hom

% % L' = \{ b_1^n ... : a^n b^{n_\} ist das eindeutig?

% \begin{proposition}
%  hom verschieden, eine richtung klar
% \end{proposition}
% \begin{proof} % Gamma = {b1,..,bk}
% Let $\mathcal A = (\Gamma, Q, \delta)$ be an input automaton
% for which we want to know if it has a synchronizing word in $U$. %L' über Gamma
% Set $Q' = Q \times \{ 1, \ldots, k \}$
% and $\delta' : Q' \times \Sigma \to Q'$
% with 
% \[
%  \delta'((q, i), x) = \left\{
%  \begin{array}{ll}
%   (\delta(q, x), j)     & \mbox{if } x = \varphi(b_j); \\
%  % (\delta(q, x), i + 1) & \mbox{if } i < k \mbox{ and } x = \varphi(b_{i+1}); \\
%   (q, i)                & \mbox{otherwise.}
%  \end{array}\right.
% \]
% Then, $\mathcal A' = (\Sigma, Q', \delta')$
% has a synchronizing word in $L$
% if and only if $\mathcal A$ has a synchronizing word in $U$.
% % aber man muss jeweils mind einmal "rübergehen"




% \end{proof}



%  Let $L \subseteq w_1^* \cdots w_n^*$.
%  As $w^* w^* = w^*$, we can suppose that $w_i \ne w_{i+1}$
%  for $i \in \{1,\ldots,n-1\}$, which we will assume for the rest of this section.
%  In particular in the strictly bounded case we assume
%  that consecutive letter are distinct.\todo{wo brauche ich diese annahmen genau?}
 
 
 %In this section, we 
 Fix a constraint automaton $\mathcal B = (\Sigma, P, \mu, p_0, F)$.
 Let $a_1, \ldots, a_k \in \Sigma$ be a sequence of (not necessarily distinct)
 letters.
 In this section, we assume $L(\mathcal B) \subseteq a_1^* \cdots a_k^*$.
 A language which fulfills the above condition
 is called \emph{letter-bounded}.
 Note that the language $ab^*a$ given in the introduction as an example
 %, and in~\cite{DBLP:conf/mfcs/FernauGHHVW19} as the smallest, in terms of recognizing automata,
 %constraint language giving an \NP-complete problem,
 is letter-bounded. In fact, it is the language with the smallest
 recognizing automaton yielding an \NP-complete constrained problem~\cite{DBLP:conf/mfcs/FernauGHHVW19}.
 
 A language such that the $a_i$ are pairwise distinct, i.e., $a_i \ne a_j$
 for $i \ne j$, is called \emph{strictly bounded}.
 The class of strictly bounded languages has been extensively studied~\cite{DBLP:journals/mst/BlattnerC77,DBLP:journals/dam/DassowP99,Ginsburg66,GinsburgSpanier64,GinsburgSpanier66,HerrmannKMW17},
 where in~\cite{Ginsburg66,GinsburgSpanier64,GinsburgSpanier66} no name was introduced for them
 and in~\cite{HerrmannKMW17} they were called strongly bounded.
 %\footnote{The work~\cite{HerrmannKMW17}
 %seems to deviate from the standard terminology in other ways too by calling bounded languages
 %as introduced here word-bounded and refers to letter-bounded simply as bounded languages.}.
 The class of letter-bounded languages properly contains the strictly bounded languages.
 
 \begin{toappendix} 
 Note that the work~\cite{HerrmannKMW17}
 seems to deviate from the standard terminology, for example by calling bounded languages
 as introduced here word-bounded and refers to letter-bounded simply as bounded languages.
 \end{toappendix}
 

 
 \begin{remark}%[Motivation]%[A Motivation for Strictly Bounded Constraint Languages]
 \label{rem:motivation_strictly_bounded}
Let $\Sigma = \{b_1, \ldots, b_r\}$
be an alphabet of size $r$.
%and $\psi : \Sigma^* \to \mathbb N_0^m$
%be the \emph{Parikh morphism}
%given by $\psi(w) = (|w|_{b_1}, \ldots, |w|_{b_k})$
%for $w \in \Sigma^*$.
%Then, for $L \subseteq \Sigma$,
%set $\perm(L) = \{ w \in \Sigma^* \mid \exists u \in L \forall a \in \Sigma : |u|_a = |w|_a \}$,
%the \emph{commutative closure} of $L$.
Then, 
%between the commutative languages over $\Sigma$
%and the strictly bounded languages in $b_1^* \cdots b_k^*$, 
the mappings
\[
\Phi(L) = L \cap b_1^* \cdots b_r^* \mbox{ and }
\perm(L) = \{ w \in \Sigma^* \mid \exists u \in L\  \forall a \in \Sigma : |u|_a = |w|_a \}
\]
for $L \subseteq \Sigma^*$ are mutually inverse and inclusion preserving
between the languages in $b_1^* \cdots b_r^*$ and the commutative languages
in $\Sigma^*$, where a language $L \subseteq \Sigma^*$ is commutative 
if $\perm(L) = L$.
Furthermore, for strictly bounded languages of the form $B_1 \cdots B_r \subseteq b_1^* \cdots b_r^*$
with $B_j \subseteq \{b_j\}^*$, $j \in \{1,\ldots, r\}$, we have
$
 \perm(B_1 \cdots B_r) = B_1 \shuffle \cdots \shuffle B_r,
$
where
$U \shuffle V = \{ u_1 v_1 \cdots u_n v_n \mid u_i, v_i \in \Sigma^*, u_1 \cdots u_n \in U, v_1 \cdots v_n \in  V \}$ for $U, V \subseteq \Sigma^*$.
Hence, $\perm(L)$ is regularity-preserving
for strictly bounded languages.
More specifically, the above correspondence between
the two language classes is regularity-preserving in both directions.
For commutative constraint languages, a classification
of the complexity landscape has been achieved~\cite{DBLP:conf/cocoon/Hoffmann20}.
By the close relationship between commutative and certain strictly
bounded languages, it is natural to tackle
this language class next.
However, as shown in~\cite{DBLP:conf/cocoon/Hoffmann20},
for commutative constraint languages, we can realize $\PSPACE$-complete
problems, but, by Theorem~\ref{thm:sparse_in_NP},
for strictly bounded languages, the constrained problem is always in $\NP$.
However, by the above relations, Theorem~\ref{thm:bounded_regular_form} for languages in $b_1^* \cdots b_r^*$ is equivalent to~\cite[Theorem 5]{DBLP:conf/cocoon/Hoffmann20}, a representation result
for commutative regular languages.
\end{remark}
 
\begin{comment}

Next, we link the representation
of bounded languages given in Theorem~\ref{thm:bounded_regular_form}
to the languages $L_{j_1, j_2, j_3}$ defined in the beginning of
this section.

\begin{lemma}
\label{lem:L_j1j2j3_intersection}
 Let $L(\mathcal B) = \bigcup_{i=1}^n A_1^{(i)} \cdots A_k^{(i)}$
 with unary regular languages $A_j^{(i)} \subseteq \{a_j\}^*$.
 Then,
 $
  L(\mathcal B) \cap L_{j_1, j_2, j_3} \ne \emptyset 
 $
 if and only if we can find $i_0 \in \{1,\ldots,n\}$
 such that $A_{j_1}^{(i_0)}$ and $A_{j_3}^{(i_0)}$
 do not equal~$\{\varepsilon\}$
 and $A_{j_2}^{(i_0)}$ is infinite.
\end{lemma}
\begin{proof}
 First, suppose we have
   some $w \in L(\mathcal B) \cap L_{j_1, j_2, j_3}$.
   %Then, for some $i_0 \in \{1,\ldots, n\}$, we have
   %$w \in A_1^{(i_0)} \cdots A_k^{(i_0)} \cap L_{j_1, j_2, j_3}$.
   As $L(\mathcal B) \subseteq a_1^* \cdots a_k^*$, we have
   \[
    w = a_1^{|w|_{a_1}} \cdots a_k^{|w|_{a_k}}
   \]
   with $|w|_{a_{j_1}} > 0$, $|w|_{a_{j_3}} > 0$
   and $|w|_{a_{j_2}} \ge |P|$.
   By the pigeonhole principle, as $w$ is read in $\mathcal B$,
      it has to traverse some state twice as it reads 
      the factor $a_{j_2}^{|w|_{a_{j_2}}}$. So, we can pump
      some non-empty factor $a_{j_2}^p$ of it with $0 < p \le |P|$.
      Hence, writing $w = ua_{j_2}^{|w|_{a_{j_2}}}v$ with $u,v \in \Sigma^*$,
      we have, for any $r \ge 0$,
      \[
             ua_{j_2}^{|w|_{a_{j_2}} + rp}v \subseteq L(\mathcal B).
      \] % set u ,v
   Again, using the pigeonhole principle, as we have a 
   finite union \[ L(\mathcal B) = \bigcup_{i=1}^n A_1^{(i)} \cdots A_k^{(i)}, \]
   there
   exists $i_0 \in \{1,\ldots, n\}$ such that
   \[
    ua_{j_2}^{|w|_{a_{j_2}} + rp}v \in A_1^{(i_0)} \cdots A_k^{(i_0)}
   \]
   for infinitely many $r \ge 0$. 
   \todo{Ne, das geht nur bei strictly bounded.}
   This implies $a_{j_2}^{|w|_{a_{j_2}} + rp} \subseteq A_{j_2}^{(i_0)}$
   for infinitely many $r$. Hence $A_{j_2}^{(i_0)}$
   is infinite. Furthermore, we
   get $a_{j_1}^{|w|_{a_{j_1}}} \in A_{j_1}^{(i_0)}$
   and $a_{j_3}^{|w|_{a_{j_3}}} \in A_{j_3}^{(i_0)}$.
  
  
   Conversely, if we have $i_0 \in \{1,\ldots,n\}$
   such that $A_{j_1}^{(i_0)}$ and $A_{j_3}^{(i_0)}$
   do not equal $\{\varepsilon\}$ and $A_{j_2}^{(i_0)}$
   is infinite, then obviously
   \[
    A_1^{(i_0)} \cdots A_k^{(i_0)} \cap L_{j_1,j_2,j_3} \ne \emptyset 
   \]
   and as $A_1^{(i_0)} \cdots A_k^{(i_0)} \subseteq L(\mathcal B)$
   the claim follows.
   
   
   \medskip 
   
   % alternativ mit SCCs und Pfaden, zeigen dass die A_j^i durch Automaten mit weniger als
   % |P| Zuständen erkennbar.
   \qed
\end{proof}
\end{comment}

 Our first result says, intuitively,  
 that if in $A_1 \cdots A_k$ with $A_j$ unary and regular,
 if no infinite unary language $A_j$ over $\{a_j\}$ lies %strictly in the middle 
 between 
 non-empty unary languages
 over a distinct letter\footnote{Hence different from $\{\varepsilon\}$, as $\{\varepsilon\} \subseteq \{a\}^*$
 for $a \in \Sigma$.}  than $a_j$, %than the infinite unary language,
 then $(A_1 \cdots A_k)$\textsc{-Constr-Sync} is in~$\PTIME$.
 
%  Later, in Lemma~\ref{lem:np_hardness} and Theorem~\ref{thm:dichotomy}, we will use
%  the languages $L_{j_1, j_2, j_3}$. They
%  allow us to single out which letters appear infinitely
%  often between other letters in~$L(\mathcal B)$, i.e.,
%  express the opposite of the condition mentioned in Proposition~\ref{prop:stricly_bounded_P}.
 
\begin{propositionrep}
\label{prop:stricly_bounded_P}
 Let $A_j \subseteq \{a_j\}^*$ be unary regular languages
 %, recognized
 %by automata with a single final state, 
 for $j \in \{1,\ldots, k\}$.
 Set $L = A_1 \cdot\ldots\cdot A_k$.
 If for all $j \in \{1,\ldots, k\}$, $A_j$ infinite implies that $A_i \subseteq \{a_j\}^*$
 for all $i < j$ or $A_i \subseteq \{a_j\}^*$ for all $i > j$ (or both), then $L\textsc{-Constr-Sync} \in \PTIME$. 
\end{propositionrep} 
\begin{proof}
 Let $L = A_1 \cdots A_k$ with $A_j \subseteq \{a_j\}^*$ fulfill the assumption.
 If $A_j$ is infinite and for all $i < j$ we have $A_i \subseteq \{a_j\}^*$,
 then $A_1 \cdots A_j \subseteq \{a_j\}^*$, and similarly if
 for all $i > j$ we have $A_i \subseteq \{a_j\}^*$.
 So, by considering $(A_1 \cdots A_j) A_{j+1} \cdots A_k$
 or $A_1 \cdots A_{j-1} (A_j \cdots A_k)$, with $j$ maximal in the former case and minimal in the latter,
 without loss of generality, we can assume $j = 1$
 or $j = k$, i.e., we only have the cases $A_1$
 is infinite, $A_k$ is infinite or both are infinite or none is infinite,
 and, by maximality or minimality of $j$,
 in all these cases the languages $A_2, \ldots, A_{k-1}$ are all finite.
 
 
 
 
 Then, by Lemma~\ref{lem:union_single_final_state}, we can write $A_1$ and $A_k$
 as a finite union of unary languages recognizable by automata with a single final state.
 As concatenation distributes over union, if we do this for
 $A_1$ and $A_k$ and rewrite the language using the mentioned distributivity,
 we get a finite union of languages of the form
 \[
  A_1' A_2 \cdots A_{k_1} A_k'
 \]
 where $A_1'$ and $A_k'$ are recognizable by unary automata with a single final state
 and are either finite or infinite. Hence, by Lemma~\ref{lem:union},
 if we can show that the problem is in $\PTIME$ for each such language,
 the result follows. 
 So, without loss of generality, we assume
 from the start that $A_1$ or $A_k$ are recognizable by automata
 with a single final state.
 
 
 If all $A_j$, $j \in \{1,\ldots,k\}$ are finite, then $L$ is finite, and $L\textsc{-Constr-Sync}\in \PTIME$
 by Lemma~\ref{lem:finite}.
 We handle the remaining cases separately.
 
 \begin{enumerate}
 \item[(i)] Only $A_1$ is infinite.
  
  By assumption, every $A_j \subseteq \{a_j\}^*$, $j \in \{1,\ldots,k\}$,
  is recognizable by a single state automaton. Hence, by Lemma~\ref{lem::unary_single_final}, we can write, as $A_1$ is infinite,
   $A_1 = a_1^i (a_1^p)^*$ with $i \ge 0$ and $p > 0$.
  Let $\mathcal A = (\Sigma, Q, \delta)$ be an input semi-automaton
  for $L\textsc{-Constr-Sync}$.
  As $\delta(Q, a_1) \subseteq Q$,
  we have, for any $n \ge 0$, $\delta(Q, a_1^{n+1}) \subseteq \delta(Q, a_1^n)$.
  So, as $Q$ is finite and the sequence of subsets
  cannot get arbitarily small, for some $0 \le n < |Q|$
  we have $|\delta(Q, a_1^{n+1})| = |\delta(Q, a_1^n)|$.
  But $|\delta(Q, a_1^{n+1})| = |\delta(Q, a_1^n)|$,
  as $\delta(Q, a_1^{n+1}) \subseteq \delta(Q, a_1^n)$,
  implies $\delta(Q, a_1^{n+1}) = \delta(Q, a_1^n)$.
  Then, the symbol $a_1$
  permutes the set $\delta(Q, a_1^n)$.
  Hence, $\delta(Q, a_1^{n+m}) = \delta(Q, a_1^n)$ for any $m \ge 0$.
  So, combining these observations,
  \begin{equation}\label{eqn:case_one_P}
   \{ \delta(Q, a_1^n) \mid n \ge 0 \} = \{ \delta(Q, a_1^n) \mid n \in \{0,\ldots, |Q|-1\} \}
  \end{equation}
  and $\delta(Q, a_1^{|Q| - 1 + m}) = \delta(Q, a_1^{|Q|-1})$
  for any $m \ge 0$. 
  Now, note that the language $A_2 \cdots A_k$
  is finite. So, to find out if we have any
  $a_1^{i + lp} u$ with $u \in A_2 \cdots A_k$
  that synchronizes the input semi-automaton,
  we only have to test if any of the words
  $
   a_i^{i + lp} u,
  $
  with $u \in A_2 \cdots A_k$
  and $l$ such that $i + lp \le \max\{|Q|-1 + p, i\}$,
  synchronizes $\mathcal A$.
  The number (and the length) of these words is linear bounded in $|Q|$ 
  and each could be checked in polynomial time by 
  feeding it into the input semi-automaton for each state and checking
  if a unique state results.
  Hence the problem is solvable in polynomial time.
   
 \item[(ii)] Only $A_k$ is infinite.
 
  Let $u \in A_1 \cdots A_{k-1}$. By assumption, there are only finitely many such
  words $u$. Set $S = \delta(Q, u)$ and $T = \delta(Q, a_k^{|Q|-1})$.
  As in case (i), $a_k$ permutes the states in $T$
  and as $S \subseteq Q$, we have  $\delta(S, a_k^{|Q|- 1}) \subseteq T$.
  So, as $a_k$ permutes $T$, it acts injective on the
  subset $\delta(S, a_k^{|Q|- 1})$.
  This gives $|\delta(S, a_k^{|Q|- 1 + n})| = |\delta(S, a_k^{|Q|- 1})|$
  for any $n \ge 0$. Together with $|\delta(S, a_k^{n + 1})| \le |\delta(S, a_k^{n})|$,
  we have
  \begin{equation}\label{eqn:case_two_P}
   \exists n \in \mathbb N_0 : |\delta(S, a_k^{n})| = 1 \Leftrightarrow |\delta(S, a_k^{|Q|- 1})| = 1.
  \end{equation}
%   If $|S| = 1$, then $u$ is already a synchronizing word and so any
%   word in $u \cdot A_k$ is also synchronizing by Lemma~\ref{lem:append_sync}.
%   So, suppose $|S| > 1$.
%   If $|\delta(S, a_k^n)| = 1$ for any $n$, then there exists
%   some $m \le |Q| - 1$ such that $|\delta(S, a_k^m)| = 1$
%   and $|\delta(S, a_k^{|Q| - 1})| = |\delta(S, a_k^{|Q| - 1 + n})|$
%   for any\footnote{But here, the sets might not be equal, for example, consider
%   some, but not all, states taken from a cycle for $a_k$} $n \ge 0$.
%   The last property is implied as $\delta(S, a_k^{|Q|- 1}) \subseteq T$,
%   and it implies the former, for if we have not mapped $S$ to a singleton
%   before reading $a_k$ at most $|Q|-1$ times, we will never do behind that point. 
%   Similarly, as in case (i), write $A_k = a_k^i(a_k^p)^*$.
  Choose any fixed $N \ge |Q| - 1$ with $a_k^N \in A_k$.
  Then, with the above considerations, we only have to test the finite
  number of words
  \[
   u\cdot a_k^{N}, \quad u \in A_1 \cdots A_{k-1}.
  \]
  The length of these words is linear bounded in $|Q|$ and 
  as each test, i.e., feeding the word into the input semi-automaton
  for each state and testing if a unique state results,
  could be performed in polynomial time, the problem is solvable in polynomial time.
  
 \item[(iii)] Both $A_1$ and $A_k$ are infinite.
  
  This is essentially a combination of the arguments of case (i) and (ii).
  Let $\mathcal A = (\Sigma, Q, \delta)$ be an input semi-automaton
  and $\mathcal B = (\Sigma, P, \mu, p_0, F)$
  be a constraint automaton with $L = L(\mathcal B)$.
  First, consider only the language $A_1 \cdots A_{k-1}$.
  Then, as in case (i), see Equation~\eqref{eqn:case_one_P},% todo argument geht auch für A_1 infinite, ohne dass unitär...
  \[
   \{ \delta(Q, a_1^n) \mid a_1^n \in A_1  \}
    = \{ \delta(Q, a_1^n) \mid 0 \le n < |Q| - 1 + |P|\mbox{ and } a_1^n \in A_1 \}.
  \]
  Note that we have written $0 \le n < |Q| - 1 + |P|$
  and not merely $\le |Q| - 1$ as an upper bound.
  The reason is that otherwise, if $a_1^{|Q|-1} \notin A_1$,
  we might miss the set $\delta(Q, a_1^{|Q|-1})$,
  but as $\delta(Q, a_1^{|Q|-1+m}) = \delta(Q, a_1^{|Q|-1})$
  for any $m \ge 0$ and $A_1$ is infinite, $\delta(Q, a_1^{|Q|-1}) \in \{ \delta(Q, a_1^n) \mid a_1^n \in A_1  \}$.
  However, if $a_1^n \in A_1$ for some $n \ge |Q| - 1 + |P|$,
  then, with $s = \mu(p_0, a_1^{|Q| - 1})$,
  by finiteness of $P$, among
  the states $s, \mu(s,a_1), \ldots, \mu(s, a_1^{n - |Q| + 1})$
  we find $0 \le m \le |P| - 1$ and $0 < r \le |P|$ with $m + r \le |P|$
  such that $\mu(s, a_1^{m+r}) = \mu(s, a_1^m)$.
  Then we have found a cycle and we can skip it, i.e.,
  \begin{align*}
   \mu(p_0, a_1^n) & = \mu(s, a_1^{n - |Q| + 1}) 
                     = \mu(\mu(s, a_1^{m+r}), a_1^{n - |Q| + 1 - (m+r)}) \\
                   & = \mu(\mu(s, a_1^m), a_1^{n - |Q| + 1 - (m+r)}) \\
                   & = \mu(s, a_1^{m + n - |Q| + 1 - m - r}) \\
                   & = \mu(p_0, a_1^{n-r}).
  \end{align*}
  But, as then $\mu(s, a_1^{n - r}) = \mu(s, a_1^n) \in F$
  we find $a_1^{n-r} \in A_1$. 
  Repeating this procedure, if $n - r \ge |Q| - 1 + |P|$,
  we ultimately find $|Q| - 1 \le m < |Q| - 1 + |P|$
  such that $a_1^m \in A_1$
  and $\delta(Q, a_1^{|Q| - 1}) = \delta(Q, a_1^m)$.
  Note that the language $A_2 \cdots A_{k-1}$
  is finite.
  Then, as in case (i), 
  we only have to consider the  words,
  whose length and number is linear bounded in $|Q|$,
  \[
   a_1^n \cdot u,\quad  0 \le n < |Q| - 1 + |P|, a_1^n \in A_1, u \in A_2 \cdots A_{k-1}
  \]
  and the corresponding sets
  \[
   S = \delta(Q, a_1^n \cdot u),
  \]
  and these are all possible sets in $\{ \delta(Q, a_1^n u) \mid a_1^n \in A_1, u \in A_2 \cdots A_{k-1} \}$.
  Fix any such subset $S$.
  Then, as in case (ii) and Equation~\eqref{eqn:case_two_P}, 
  choose any $N \ge |Q| - 1$ with $a_k^N \in A_k$ and
  we only have to compute $\delta(S, a_k^N)$
  and test if it is a singleton set.
  So, in total, we only have to test the words
  \[
   a_1^n \cdot u a_k^N, 0 \le n < |Q| - 1 + |P|, a_1^n \in A_1, u \in A_2 \cdots A_{k-1}.
  \]
  Their length and number is linear bounded in $|Q|$
  and computing the reachable state from each state of the input automaton,
  and testing if a unique state results, could be performed in polynomial
  time. Hence, the overall procedure could be performed in polynomial time.
 \end{enumerate}
 So, we have handled every case and the proof is complete.\qed
 % oder zeigen A_1 oder A_k finite -> nur endlich viele wörter müssen getestet werden
 % mit (iii)
\end{proof}

Now, we state a sufficient condition for \NP-hardness over binary alphabets. 
This condition, together with Proposition~\ref{prop:hom_lower_bound_complexity},
allows us to handle the general case in Theorem~\ref{thm:dichotomy}.
Its application together with Proposition~\ref{prop:hom_lower_bound_complexity} shows, in some respect, that the language $ab^*a$
is the prototypical language giving \NP-hardness.
We give a proof sketch of Lemma~\ref{lem:np_hardness} at the end of this section.

\begin{toappendix}

In the proof of Lemma~\ref{lem:np_hardness}
we will need the following two lemmata.
For $n > 0$, set
\[
 L_n = (\Sigma^* a \Sigma^* b^{|P|} \Sigma^*)^n.
\]
Recall that $\mathcal B = (\Sigma, P, \mu, p_0, F)$.

\begin{lemma}
\label{lem:number_of_b_blocks}
 Let $\Sigma = \{a,b\}$ and $L(\mathcal B) \subseteq a_1^* \cdots a_k^*$
 with $a_i \in \Sigma $ and $n > 0$.
 Then, the following are equivalent:
 \begin{enumerate} 
 \item $L(\mathcal B) \cap L_n \ne \emptyset$,
 
 \item there exist $u_0, \ldots, u_n \in \Sigma^* a \Sigma^*$
  and $p_1, \ldots, p_n \ge |P|$
  such that \[
  u_0 b^{p_n} u_1 \cdots u_{n-1} b^{p_n} u_n \in L(\mathcal B),
  \]
 \item there exist $u_0, \ldots, u_n \in \Sigma^* a \Sigma^*$
  and $p_1, \ldots, p_n > 0$
  such that 
  \[ 
  u_0 (b^{p_1})^* u_1 \cdots u_{n-1} (b^{p_n})^* u_n \subseteq L(\mathcal B).
  \]
 \end{enumerate}
\end{lemma}
\begin{proof}
 That (1) implies (2) is obvious.
 As $p_i \ge |P|$, when reading these factors they have to induce a loop in $\mathcal B$,
 which implies (3).
 Lastly, if (3) holds true, as
 \[
  u_0 b^{|P|\cdot p_1} u_1 \cdots u_{n-1} b^{|P| \cdot p_n} u_n \in L(\mathcal B)
 \]
 and $u_i \in \Sigma^* a \Sigma^*$,
 we also find $u_0 b^{|P|\cdot p_1} u_1 \cdots u_{n-1} b^{|P| \cdot p_n} u_n \in L_n$
 and (1) follows.\qed
\end{proof}

\begin{lemma}
\label{lem:maximal_n}
 Let $\Sigma = \{a,b\}$ and $L(\mathcal B) \subseteq a_1^* \cdots a_k^*$
 with $a_i \in \Sigma $.
 Then, there exists a maximal $n$
 such that $L(\mathcal B) \cap L_n \ne \emptyset$
 and for this maximal $n$,
 we can assume that $u_i \notin \Sigma^* b^{|P|} \Sigma^*$
 for the $u_i$, $i \in \{0,\ldots,n\}$, as in the previous lemma
 and $n \le |P|$. 
\end{lemma}
\begin{proof}
 Recall $\mathcal B = (\Sigma, P, \mu, p_0, F)$
 Note that $\mathcal B$ must necessarily be polycylic (this is a slightly stronger
 claim than Theorem~\ref{thm:bounded_characterization}, as this theorem
 only asserts existence of some polycyclic automaton)
 after removing all states that are not coaccessible, i.e., states from which no final state is reachable,
 which could obviously be done without altering $L(\mathcal B)$.
 For if $\mathcal B$ is then not polycyclic, then some strongly
 connected component does not consists of a single cycle only
 and we find two distinct words $u, v$ and a state $p \in P$
 such that $\mu(p, u) = \mu(p, v) = p$ (see also the forbidden
 pattern in~\cite[Theorem 4.29]{Pin2020}).
 But then, if we choose $x,y \in \Sigma^*$
 such that $\mu(p_0, x) = p$
 and $\mu(p, y) \in F$, we find $x(u+v)^*y \subseteq L(\mathcal B)$.
 Set $m = \max\{|u|, |v|\}$
 Then, for $i > 0$,
 \[
  \{ w \in x(u+v)^*y : |w| \le |x| + i \cdot m\}
 \]
 contains $x(u+v)^i$, and $|x(u+v)^i| = 2^i$.
 So, $L(\mathcal B) \cap \{ w \in \Sigma^* : |w| \le n \}$
 contains at least $2^{\lfloor n - (|x| - |y|) / m \rfloor}$
 many words, i.e., it not sparse.
 Furthermore, as $L \cap \Sigma^n \in O(n^c)$
 as a function of $n$ if and only if $L \cap \{ w \in \Sigma^* : |w| \le n \} \in O(n^{c'})$
 as a function of $n$ for some $c,c' \ge 0$,
 the claim follows.
 
 So, we can assume $\mathcal B$ is polycyclic and every state is coaccessible.
 Now, note that this implies that every loop in $\mathcal B$ (or strongly connected component
 in this case) must be labelled by a single letter, for if we
 have $\mu(p, u) = p$ with $|u|_a > 0$ and $|u|_b > 0$
 and choose again $x,y$ such that $\mu(p_0, x) = p$
 and $\mu(p, y) \in F$,
 we find $xu^ky \in L(\mathcal B)$, which contradict $L(\mathcal B) \subseteq a_1^* \cdots a_k^*$.
 
 But then, note that if, for example, $aba \in L(\mathcal B)$,
 we must have $|P| \ge 2$, as $\mu(p_0, ab) \notin \{ p_0, \mu(p_0,a) \}$.
 Similarly, if we have a word that switches letters, every time a letter-switch
 occurs the state we end up in $\mathcal B$ must be a new state not visited before,
 for otherwise we would have a loop whose transition are not exclusively
 labelled by a single letter.
 
 So, this implies that 
 if we have a word as written in Lemma~\ref{lem:number_of_b_blocks}
 in $L(\mathcal B)$, then $n \le |P|$
 which implies that we can find a maximal $n$.
 That $u_i \notin \Sigma^* b^{|P|} \Sigma^*$
 is also implied by Lemma~\ref{lem:number_of_b_blocks}
 and the maximality of $n$. \qed
\end{proof}
\end{toappendix}


\begin{lemmarep}
\label{lem:np_hardness}
 Suppose $\Sigma = \{a,b\}$. %und a,b vertauscht unten mit homsatz.
 Let $L(\mathcal B) \subseteq \Sigma^*$ be letter-bounded.
 Then, $L(\mathcal B)$\textsc{-Constr-Sync}
 is $\NP$-hard %if and only %nebenbei zwischen die a^+ nochmal sigma packen bringt nichts.
 % da man annehmen kann a_{i+1} ungleich a_i
 if $L(\mathcal B) \cap \Sigma^* a  b^{|P|}b^*  a \Sigma^* \ne \emptyset$.
 % nur if teil, weil if and only wird impliziert im theorem!
\end{lemmarep}
\input{np_hardness_proof_full}



So, finally, we can state our main theorem of this section.
Recall that by Theorem~\ref{thm:sparse_in_NP},
and as the class of bounded regular languages equals
the class of sparse regular languages~\cite{DBLP:journals/eik/LatteuxT84}, for bounded regular constraint
languages, the constrained problem is, in our case, in \NP. 
 
 
\begin{theoremrep}[Dichotomy Theorem]
\label{thm:dichotomy}
 % a_i != a_{i+1} sonst nichts weiter
 % dann a_{j_1} auf a und so weiter hom bild
 % hom bild a^* b^* a^*
 % aber a_{j_2} verschieden von a_{j_1}, a_{j_3} über die vereinigne
 % wie in entscheidungsverfahren.
 %
 % aber aufpassen, P ist anders!!!! aber dann schlussfolgern für das P' auch unendlich
 % oder 2^{|P|} nehmen
 %
 % oder wie so eine "sigma"-menge, also für jedes n existiert eins - schnitt/vereinigung - schreiben. aber da nicht klar ob regulär.
 Let $a_1, \ldots, a_k \in \Sigma$ be a sequence of letters
 and $L \subseteq a_1^* \cdots a_k^*$ be regular.
 The problem $L\textsc{-Constr-Sync}$
 is \NP-complete if
 \[
  L \cap \left(\bigcup_{\substack{1 \le j_1 < j_2 < j_3 \le k \\ a_{j_2} \notin \{a_{j_1}, a_{j_3}\} }} L_{j_1,j_2,j_3} \right) \ne \emptyset
 \]
 with $L_{j_1, j_2, j_3} = \Sigma^* a_{j_1} \Sigma^* a_{j_2}^{|P|} \Sigma^* a_{j_3} \Sigma^*$
 for $1 \le j_1 < j_2 < j_3 \le k$ and solvable in polynomial time otherwise.
\end{theoremrep}
\begin{proof}
 Set $L = L(\mathcal B)$.
 %By Theorem~\ref{thm:bounded_regular_form}, we can
 %write % auf lemma/theorem verweisen, dass es immer so geht.
 %$L(\mathcal B) = \bigcup_{i=1}^n A_1^{(i)} \cdots A_k^{(i)}$ % erwähnen k gleich da man eps wählen kann, vielleicht als lemma diese form hinschreiben. todo
 %with unary regular languages $A_j^{(i)} \subseteq \{a_j\}^*$
 %for $j \in \{1,\ldots,k\}$.
 Let $j_1, j_2, j_3 \in \{1,\ldots,k\}$
 be such that $a_{j_2}\notin\{a_{j_1},a_{j_3}\}$, $j_1 < j_2 < j_3$
 and
 \[
  L(\mathcal B) \cap L_{j_1, j_2, j_3} \ne \emptyset.
 \]
 Then, there exists a word $u_1 a_{j_1} u_2 a_{j_2}^{|P|} u_3 a_{j_3} u_4 \in L(\mathcal B)$
 with $u_1, u_2, u_3, u_4 \in \Sigma^*$.
 By the pigeonhole principle, when reading the factor $b^{|P|}$,
 at least one state has to be traversed twice 
 and we find $p > 0$ such that $u_1 a u_2 b^{|P| + i\cdot p} u_3 a u_4$
 for any $i \ge 0$.
 
 
 
 Define a homomorphism $\varphi : \Sigma^* \to \{a,b\}^*$
 by $\varphi(a_{j_1}) = \varphi(a_{j_3}) = a$,
 $\varphi(a_{j_2}) = b$
 and, for the remaining letters, $\varphi(a) = \varepsilon$,
 if $a \in \Sigma \setminus \{a_{j_1}, a_{j_2}, a_{j_3}\}$.
 Then, $\varphi(L) \subseteq \varphi(a_1)^* \cdots \varphi(a_k)^*$
 is letter-bounded. % zeigen, dass unter hom abgeschlossen. aber klar
 Set $\Gamma = \{a,b\}$ and let $\mathcal B' = (\Gamma, P', \mu', p_0', F')$
 be a recognizing PDFA for $\varphi(L)$.
 %By Lemma~\ref{lem:L_j1j2j3_intersection},
 %there exists $i_0 \in \{1,\ldots,n\}$
 %such that $A_{j_1}^{(i_0)}$ and $A_{j_3}^{(i_0)}$
 %do not equal~$\{\varepsilon\}$
 %and $A_{j_2}^{(i_0)}$ is infinite.
 %As $\varphi$ is a homomorphism, we have 
 %$\varphi(A_1^{(i_0)} \cdots A_k^{(i_0)}) = \varphi(A_1^{(i_0)}) \cdots \varphi(A_k^{(i_0)})$. Furthermore,
 %$a^+ \cap \varphi(A_{j_1}^{(i_0)}) \ne \emptyset$,
 %$a^+ \cap \varphi(A_{j_3}^{(i_0)}) \ne \emptyset$
 %and $b^{|P'|}b^* \cap \varphi(A_{j_2}^{(i_0)}) \ne \emptyset$.
 %As the language $\varphi(A_1^{(i_0)}) \cdots \varphi(A_k^{(i_0)})$
 %is contained in $\varphi(L)$,
 %this yields
 We have
 \[
  \varphi(u_1) a \varphi(u_2) b^{|P| + i\cdot p} \varphi(u_3) a \varphi(u_4) \in \varphi(L) 
 \]
 for any $i \ge 0$. So,
 $
 \varphi(L) \cap \Gamma^* a^+ \Gamma^* b^{|P'|}b^* \Gamma^* a^+ \Gamma^* \ne \emptyset.
 $
%  However, note that, for $u \in \{a,b\}^*$,
%  \begin{multline*}
%       u \in \varphi(A_1^{(i_0)}) \cdots \varphi(A_k^{(i_0)}) \cap \Gamma^* a^+ \Gamma^* b^{|P'|}b^* \Gamma^* a^+ \Gamma^*
%   \\ \Leftrightarrow 
%   u \in \varphi(A_1^{(i_0)}) \cdots \varphi(A_k^{(i_0)}) \cap \Gamma^* a^+  b^{|P'|}b^* a^+ \Gamma^*.
%  \end{multline*}
% So,
% $
%  \varphi(L) \cap \Gamma^* a^+ b^{|P'|} b^* a^+ \Gamma^* \ne \emptyset. %todo genauer
% $
 By Lemma~\ref{lem:np_hardness}, $\varphi(L)$\textsc{-Constr-Sync}
 is \NP-hard and so, by Proposition~\ref{prop:hom_lower_bound_complexity},
 also $L\textsc{-Constr-Sync}$ is \NP-hard, and so, with Theorem~\ref{thm:sparse_in_NP},
 \NP-complete.
 
 
 Now, suppose
  $
 L(\mathcal B) \cap \left(\bigcup_{\substack{1 \le j_1 < j_2 < j_3 \le k \\ a_{j_2} \notin \{a_{j_1}, a_{j_3}\} }} L_{j_1,j_2,j_3} \right) = \emptyset.
 $
  By Theorem~\ref{thm:bounded_regular_form}, we can
 write % auf lemma/theorem verweisen, dass es immer so geht.
 $L(\mathcal B) = \bigcup_{i=1}^n A_1^{(i)} \cdots A_k^{(i)}$ % erwähnen k gleich da man eps wählen kann, vielleicht als lemma diese form hinschreiben. todo
 with unary regular languages $A_j^{(i)} \subseteq \{a_j\}^*$
 for $j \in \{1,\ldots,k\}$.
 Then, 
 \[ 
 ( A_1^{(i)} \cdots A_k^{(i)} ) \cap \left(\bigcup_{\substack{1 \le j_1 < j_2 < j_3 \le k \\ a_{j_2} \notin \{a_{j_1}, a_{j_3}\} }} L_{j_1,j_2,j_3} \right) = \emptyset
 \]
 for any $i \in \{1, \ldots, n\}$.
 However, this implies that for any $i \in \{1,\ldots,n\}$, if there exists $j \in \{1,\ldots, k\}$
 such that $A_j^{(i)}$ is infinite, 
 then for all $j' < j$, or for all $j' > j$, % besonders wenn es keine gibt, als remark nach der proposition?
 we have $A_{j'} \subseteq \{a_j\}^*$ (recall that if $A_{j'} = \{\varepsilon\}$, then
 this is also fulfilled).
 Hence, by Proposition~\ref{prop:stricly_bounded_P},
 we have $(A_1^{(i)} \cdots A_k^{(i)})\textsc{-Constr-Sync} \in \PTIME$
 and then, by Lemma~\ref{lem:union},
 $L(\mathcal B)\textsc{-Constr-Sync} \in \PTIME$.\qed
\end{proof}

As the languages $L_{j_1, j_2, j_3}$ are regular, we
can devise a polynomial-time algorithm which checks the condition
mentioned in Theorem~\ref{thm:dichotomy}. 
 
\begin{corollary} %\todo{nicht $sigma = {a-1, ...m, a_k}$ schreiben, weil es suggeriert die buchstaben wären alle verschieden.}
 Given a PDFA $\mathcal B$ and a sequence of letters $a_1, \ldots, a_k$
 as input such that $L(\mathcal B) \subseteq a_1^* \cdots a_k^*$,
 the complexity of $L(\mathcal B)$\textsc{-Constr-Sync}
 is decidable in polynomial-time.
\end{corollary}
\begin{proof}
 An automaton for each $L_{j_1, j_2, j_3}$
 has size linear in~$|P|$. So, by the product automaton construction~\cite{HopUll79}, non-emptiness of
 $L(\mathcal B)$ with each $L_{j_1, j_2, j_3}$
 could be checked in time $O(|P|^2)$.
 Doing this for every $L_{j_1, j_2, j_3}$
 gives a polynomial-time algorithm
 to check non-emptiness of the language written
 in Theorem~\ref{thm:dichotomy}.~\qed
\end{proof}

\begin{example}
 For the following constraint languages CSP is \NP-complete: $ab^*a$,
 $aa(aaa)^*bbb^*d \cup a^*b \cup d^*$, $bbcc^*d^* \cup a$.
 
 For the following constraint languages CSP is in \PTIME: $a^5bd \cup cd^4$,
 $a^5bd \cup cd^*$, $aa^*bbbbcd^* \cup bbbdd^*d$.
\end{example}

\input{np_hardness_proof}