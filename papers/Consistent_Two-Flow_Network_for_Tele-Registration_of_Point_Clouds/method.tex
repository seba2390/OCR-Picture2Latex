
\input{figures/net_comp.tex}

\section{Method} \label{sec:method}


\subsection{Input and output}
The input of our method is a pair of partial point clouds, denoted as $\mathcal{P}_1$ and $\mathcal{P}_2$,  with little overlap  extracted from the same shape $\mathcal{S}$.  The point cloud pairs are centered at the origin point and randomly rotated in 3D. We achieve the goal of tele-registering the point cloud pairs and complete the missing part by making use of our key idea to combine the registration and completion tasks in a way that reinforces each other.
Our outputs include the completion of those two parts in their original states denoted respectively as $\mathcal{S}_1$ and $\mathcal{S}_2$, and the relative transformation between them with $\mathcal{M}_{21}$ denoting the transformation that registers $\mathcal{P}_2 \rightarrow \mathcal{P}_1$ and $\mathcal{M}_{12}$ denoting the transformation that registers $\mathcal{P}_1 \rightarrow \mathcal{P}_2$. 

CTF-Net consists of two flows: \textit{C-R flow} and \textit{R-C flow}. Since each flow provides a set of outputs, we use superscripts to distinguish the two sets of outputs. 

In the \textit{C-R flow},  $\mathcal{P}_1$ and $\mathcal{P}_2$ are first passed through the completion network to get the completion results $\mathcal{S}_1^{\text{C-R }} = \text{C}(\mathcal{P}_1)$ and  $\mathcal{S}_2^{\text{C-R }} = \text{C}(\mathcal{P}_2)$. Subsequently, the two completions are passed to the registration network to output their relative transformation $\mathcal{M}_{12}^{\text{C-R }}$ and $\mathcal{M}_{21}^{\text{C-R }}$. 
In the \textit{R-C flow}, $\mathcal{P}_1$ and $\mathcal{P}_2$, which can come in arbitrary poses, are first passed through the registration network to get their relative transformations $\mathcal{M}_{12}^{\text{R-C }}$ and $\mathcal{M}_{21}^{\text{R-C}}$. The aligned parts are first combined, before passing to the completion network to get the final results $\mathcal{S}_1^{\text{R-C}} = \text{C}(\mathcal{P}_1 \cup \mathcal{M}_{21}^{\text{R-C}} \mathcal{P}_2)$ and $\mathcal{S}_2^{\text{R-C}} = \text{C}(\mathcal{P}_2 \cup \mathcal{M}_{12}^{\text{R-C}} \mathcal{P}_1)$.
	
Our goal is to make sure that the completion and registration outputs of both flows are close to the ground-truth, denoted as  $\mathcal{S}_1^{*}$, $\mathcal{S}_2^{*}$, $\mathcal{M}_1^{*}$ and $\mathcal{M}_2^{*}$, and more importantly, making the two flows mutually consistent. 




\subsection{Network Architecture}

\subsubsection{Completion Network}

The completion network, as shown in Fig.~\ref{fig:net_comp}, takes a partial shape $\mathcal{P}$ as input and outputs the completed shape $\mathcal{S} = \text{C}(\mathcal{P})$. Note that similar to~\cite{huang2020pf}, for the given partial shape $\mathcal{P}$, we only generate the missing part $\mathcal{G}$ and thus the final completed shape is a union of those two  $\mathcal{S} =\mathcal{P} \cup \mathcal{G} $. Moreover, different from most of the previous works on completion which assume that the input shapes are all well-aligned, our input partial shape $\mathcal{P}$ are given in an arbitrary orientation. Therefore, our completion network is composed of two modules: one orientation module and one generation module, where the orientation module rotates $\mathcal{P}$ into a canonical pose to facilitate the following generation module and then the generation module generates the missing part to complete the shape. 

Specifically, the orientation module takes the partial shape $\mathcal{P}$ as input, and outputs the rotation transformation $\mathcal{R}_o$, which is then applied to $\mathcal{P}$ to obtain the oriented shape $\mathcal{P}_o$. 
The generation module is adapted from the PF-Net proposed in~\cite{huang2020pf}. The original PF-Net assumes that the input partial shape covers a large portion of the whole shape, thus the number of the generated points is far less than the input.
However, in our work, since the input is usually a much smaller part of the shape, we set the output point number to equal to the input point number. Note that directly modify the output points of the original PF-Net will highly increase the number of network parameters and lead to huge memory cost and slow training speed, so we modify the parameters of each layer to enlarge the output size gradually.
In more detail, we first pass $\mathcal{P}_o$ to a encoder that extracts the feature of dimension $n_c=1920$, which is then passed to a decoder that generates the missing part in three levels: primary $\mathcal{G}_p$, secondary $\mathcal{G}_s$ and the final detailed output $\mathcal{G}_o$, with the points number of 128, 512, 2048, respectively. $\mathcal{G}_o$ is then concatenated with $\mathcal{P}_o$ to form the complete shape. Finally, we multiply $\mathcal{G}_o \cup \mathcal{P}_o$ with the inverse of $\mathcal{R}_o$ to obtain the final complete shape $\mathcal{S}= \text{C}(\mathcal{P}) = \mathcal{G} \cup \mathcal{P} $.


\input{figures/net_regi.tex}
\subsubsection{Registration Network}

The registration network, as shown in Fig.~\ref{fig:net_regi}, takes two shapes, $\mathcal{P}_1$ and $\mathcal{P}_2$, either complete or partial, and outputs the relative transformation $\mathcal{M}_{12}$ from $\mathcal{P}_1 \rightarrow \mathcal{P}_2$ by taking $\mathcal{P}_2$ as the anchor. 	
We decompose the transformation $\mathcal{M}_{12}$ into rotation $\mathcal{R}_{12}$ and translation $\mathcal{T}_{12}$ to reduce the complexity of 3D transformation, i.e., the network first rotates $\mathcal{P}_1$ to make it have the same pose of $\mathcal{P}_2$, and then translates it to align with $\mathcal{P}_2$.
 
Specifically, we first pass the input pair through a PointNet~\cite{qi2017pointnet} encoder, to obtain the feature vector of dimension $n_r=512$ for $\mathcal{P}_1$ and $\mathcal{P}_2$, respectively. The feature vectors are concatenated and passed to a decoder composed of several linear layers, which provides the quaternion parameters that represent the 3D rotation. The quaternion is then converted to rotation matrix $\mathcal{R}_{12}$ and multiplied with $\mathcal{P}_1$ to obtain the rotated part $\mathcal{P}_{1R}$. Note that all the quaternions are normalized in each process. Afterwards, $\mathcal{P}_{1R}$ is passed to the PointNet encoder again to obtain the feature vector of dimension $\mathbb{R}^{n_r}$ ($n_r=512$). The feature is then concatenated again with that extracted from $\mathcal{P}_{2}$ and passed to another set of linear layers to output the set of translation parameters $(dx, dy, dz)$, which are then converted to the translation matrix $\mathcal{T}_{12}$ and multiplied with $\mathcal{P}_{1R}$ to obtain the final registered part. The final transformation matrix is calculated by $\mathcal{M}_{12} = \mathcal{T}_{12} * \mathcal{R}_{12}$.

In both flows, our registration network also takes those two shapes with the other order and output the relative transformation $\mathcal{M}_{21}$ from $\mathcal{P}_2$ to $\mathcal{P}_1$.
Furthermore, in the \textit{C-R flow}, the registration network takes two completed shapes $\mathcal{S}_1$ and $\mathcal{S}_2$ as input. We further apply the transformation on the moving shape, say $\mathcal{S}_1$, and combine it with the anchor shape $\mathcal{S}_2$ to get the registered full shapes. 
Note that since the points size of the registered point cloud is twice that of each input partial point cloud, we down-sample it to half of its original points size in order to keep all the point clouds in the flows to have the same size.

\subsection{Loss Functions}
To train this two-flow network, we design suitable loss functions to account for each type of output and also the consistency between two flows. We define the loss function of our CTF-network as:
\begin{equation}
L = L_{\text{c}} + L_{\text{r}} + L_{\text{s}}.
\end{equation}
where $L_{\text{c}}$ and $L_{\text{r}}$ are the completion and registration loss against the ground-truth, and $L_{\text{s}}$ is the loss to ensure the consistency between two flows.%

\subsubsection{Completion loss.}

Note that our completion network works for input parts with arbitrary orientation, and we rotate the parts into the canonical view first and then generate the missing part to complete the shape. Therefore, the completion loss is computed for outputs from the \textit{R-C} and \textit{C-R} flows against the respective ground truth missing part geometry and rotation transformation as $L_{\text{c}} = \omega_c^{\text{c-r}}L_{\text{c}}^{\text{C-R}} + \omega_o^{\text{c-r}}L_{\text{o}}^{\text{C-R}} + \omega_c^{\text{r-c}}L_{\text{c}}^{\text{R-C}} + \omega_o^{\text{r-c}}L_{\text{o}}^{\text{R-C}} $ with 
\begin{align}
L_{\text{c}}^{\text{C-R}} &= \left(\text{D}_{emd}(\mathcal{G}_1^{\text{C-R}} , \mathcal{G}_1^{\text{C-R}*}) + \text{D}_{emd}(\mathcal{G}_2^{\text{C-R}} , \mathcal{G}_2^{\text{C-R}*})\right) / 2, 
\notag \\ 
L_{\text{c}}^{\text{R-C}} &= \left(\text{D}_{emd}(\mathcal{G}_1^{\text{R-C}} , \mathcal{G}_1^{\text{R-C}*} ) + \text{D}_{emd}(\mathcal{G}_2^{\text{R-C}}, \mathcal{G}_2^{\text{R-C}*})\right) / 2,
\notag \\ 
L_{\text{o}}^{\text{C-R}} &= \left(\text{D}_r(\mathcal{R}_{1o}^{\text{C-R}} , \mathcal{R}_{1o}^{*}) + \text{D}_r(\mathcal{R}_{2o}^{\text{C-R}} , \mathcal{R}_{2o}^{*})\right) / 2,
\notag \\ 
L_{\text{o}}^{\text{R-C}} &= \left(\text{D}_r(\mathcal{R}_{1o}^{\text{R-C}} , \mathcal{R}_{1o}^{*}) + \text{D}_r(\mathcal{R}_{2o}^{\text{R-C}} , \mathcal{R}_{2o}^{*})\right) / 2,
\end{align}
where the weights $\omega_c^{\text{c-r}}$, $\omega_o^{\text{c-r}}$, $\omega_c^{\text{r-c}}$, $\omega_o^{\text{r-c}}$ are set as 1, 3, 0.5, and 1.5, respectively. $\text{D}_{emd}$ is the distance measure between the generated part and the corresponding ground truth, which is defined as the mean of the earth mover's distance (EMD)~\cite{liu2020morphing} computed for all three generated levels($\mathcal{G}_p$, $\mathcal{G}_s$, $\mathcal{G}_o$), and $\text{D}_r$ is the distance measure between two rotations. In more detail, the rotation matrix is converted to a quaternion $\mathcal{Q} = q(\mathcal{R})$. 
Since a quaternion $\mathcal{Q}$ is equivalent to its minus $-\mathcal{Q}$ when representing a rotational transformation, we measure the distance as follows :
\begin{align}
\text{D}_r(\mathcal{R}_1, \mathcal{R}_2) &= \text{D}_q(q(\mathcal{R}_1), q(\mathcal{R}_2)),
\notag \\ 
\text{D}_q(\mathcal{Q}_1, \mathcal{Q}_2) &= min(norm(\mathcal{Q}_1 - \mathcal{Q}_2), norm(\mathcal{Q}_1 + \mathcal{Q}_2)).
\end{align}


Note that for the same part, for example $\mathcal{P}_1$, the ground truth missing part is different in two flows. In the \textit{R-C flow}, $\mathcal{P}_1$ will first be registered and combined with $\mathcal{P}_2$ before completion, so the missing part would be smaller than the one in \textit{C-R flow}. All the ground truth missing parts are extracted and subsampled from the corresponding ground truth complete shape $\mathcal{S}^*$.

\subsubsection{Registration loss.}
The registration loss is also computed for outputs from the \textit{C-R} and \textit{R-C} flows against the respective ground truth transformations as $L_{\text{r}} = \omega_r^{\text{c-r}}L_{\text{r}}^{\text{C-R}} + \omega_r^{\text{r-c}}L_{\text{r}}^{\text{R-C}}$ with 
\begin{align}
L_{\text{r}}^{\text{C-R}} &= \left(\text{D}_m(\mathcal{M}_{12}^{\text{C-R}}, \mathcal{M}_{12}^{*}) + \text{D}_m(\mathcal{M}_{21}^{\text{C-R}}, \mathcal{M}_{21}^{* })\right) / 2,
\notag \\ 
L_{\text{r}}^{\text{R-C}} &= \left(\text{D}_m(\mathcal{M}_{12}^{\text{R-C}}, \mathcal{M}_{12}^{*}) + \text{D}_m(\mathcal{M}_{21}^{\text{R-C}}, \mathcal{M}_{21}^{*})\right) / 2.
\end{align}
where $\text{D}_m$ is the distance measure between two transformations, which is defined as the $\text{D}_q$ between their quaternions plus the mean square error between the translations in the x, z, y axis. The weights $\omega_r^{\text{c-r}}$ and $\omega_r^{\text{r-c}}$ are set as 3 and 9, respectively.

\input{figures/gallery.tex}
\subsubsection{Consistency loss.}
The consistency loss consists of four components:
\begin{equation}
L_{\text{s}} = \omega_{\text{so}} L_{\text{s}}^{\text{O}} + \omega_{\text{sc}} L_{\text{s}}^{\text{C}}+ \omega_{\text{sr}} L_{\text{s}}^{\text{R}} + \omega_{\text{st}} L_{\text{s}}^{\text{T}}.
\end{equation}
where $L_{\text{s}}^{\text{O}}$, $L_{\text{s}}^{\text{C}}$ and $L_{\text{s}}^{\text{R}}$ are the consistency loss defined on the orientation correction, completion and registration in those two flows, while $L_{\text{s}}^{\text{T}}$ is the consistency loss defined on the relative transformations between two shapes with either one as the anchor. In more detail:
\begin{align}
L_{\text{s}}^{\text{O}} &= \left(\text{D}_r(\mathcal{R}_{1o}^{\text{C-R}}, \mathcal{R}_{1o}^{\text{R-C}}) + \text{D}_r(\mathcal{R}_{2o}^{\text{C-R}}, \mathcal{R}_{2o}^{\text{R-C}}) \right) / 2,
\notag \\ 
L_{\text{s}}^{\text{C}} &= \left(\text{D}_{emd}(\mathcal{S}_1^{\text{C-R}}, \mathcal{S}_1^{\text{R-C}}) + \text{D}_{emd}(\mathcal{S}_2^{\text{C-R}}, \mathcal{S}_2^{\text{R-C}}) \right) / 2,
\notag \\ 
L_{\text{s}}^{\text{R}} &= \left(\text{D}_r(\mathcal{M}_{12}^{\text{C-R}}, \mathcal{M}_{12}^{\text{R-C}}) + \text{D}_r(\mathcal{M}_{21}^{\text{C-R}}, \mathcal{M}_{21}^{\text{R-C}}) \right) / 2,
\notag \\ 
L_{\text{s}}^{\text{T}} &= \left(\text{D}_r(\mathcal{M}_{12}^{\text{C-R}}\mathcal{M}_{21}^{\text{C-R}}, I) + \text{D}_r(\mathcal{M}_{12}^{\text{R-C}}\mathcal{M}_{21}^{\text{R-C}}, I) \right) / 2.
\end{align}
where $I$ is the $4\times4$ identity matrix. The weights $\omega_{\text{so}} $, $\omega_{\text{sc}} $, $\omega_{\text{sr}}$ and $\omega_{\text{st}}$ are set as to 3, 1, 3 and 3, respectively by default. For the details about how we choose this set of weights, please refer to the supplementary material.

