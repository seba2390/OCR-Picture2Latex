
\begin{algorithm}[tb]
\caption{Bidirectional Analysis for Instrumentation}\label{alg:composition}
\footnotesize
\SetInd{0.15em}{0.85em}
\DontPrintSemicolon
\KwIn{$F_\textit{set}$: a set of functions in a target program.}
\KwOut{$\textit{Ins}_\textit{out}$: a set of variables to instrument.}
\SetKwBlock{Begin}{function}{end function}
\Begin($\textsc{BidirectionalAnalysis} {(}F_\mathit{set}{)}$)
{
  \Let{$\textit{Ins}_\textit{out}$}{ $\{\}$ }

  \For{ $\forall F_i \in F_\textit{set}$ }
  {
    \For{ $\forall v_i \in F_i$ }
    {
      \uIf{ $v_i$ \textup{is from a trusted source} }
      {
        {\textsc{ForwardAnalysis}(\textsc{CreateDepTree}($v_i$, $F_i$, \textsc{trusted}), $v_i$)}

      }
      \uElseIf{ $v_i$ \textup{is from an untrusted source} }
      {
        {\textsc{ForwardAnalysis}(\textsc{CreateDepTree}($v_i$, $F_i$, \textsc{untrusted}), $v_i$)}

      }
    }
  }
  
  \For{ $\forall F_i \in F_\textit{set}$ }
  {
    \For{ $\forall S_i \in F_i$ }
    {
      \uIf{ $S_i$ \textup{is a sink function} }
      {
        \Let{$V_\textit{args}$}{ \textsc{args}($S_i$) }
        
        \For{ $\forall V_i \in V_\textit{args}$ }
        {  
          {\textsc{BackwardAnalysis}($V_i$, $F_i$)}
        }
      }
    }
  }
  \Return {$\textit{Ins}_\textit{out}$}
}

\SetKwBlock{Proc}{procedure}{end procedure}
\Proc($\textsc{ForwardAnalysis} {(}T_\textit{cur}, V{)}$)
{
  \For{ $\forall V_\textit{use} \in $\ \textsc{GetUses}($V$) }
  {
    \uIf{$V$ \textup{is an argument} $x$ \textup{of a function} $F$}
    {
      {\textsc{ForwardAnalysis}(\textsc{AppendNode}($T_\textit{cur}$, $F$), $x$)}
    }
    \ElseIf{$V$ \textup{is a variable in an assignment} `$x = \textit{expression}$'}
    {
      {\textsc{ForwardAnalysis}(\textsc{AppendNode}($T_\textit{cur}$, $x$), $x$)}
    }
  }
}

\SetKwBlock{Proc}{procedure}{end procedure}
\Proc($\textsc{BackwardAnalysis} {(}V, F{)}$)
{
  \uIf{$V$ \textup{is a command from a trusted source}}
  {
    \Let{$\textit{Ins}_\textit{out}$}{ $\textit{Ins}_\textit{out} \ \cup \  V$ }
    
  }
  \uElseIf{$V$ \textup{is from an untrusted source}}
  {
    {\bf return}

  }
  \uElse
  {
    \Let{$V_\textit{defs}$}{\textsc{GetDefVars}($V$)}
    
    \For{ $\forall V_i \in V_\textit{defs}$ }
    {
      \uIf{ $V_i$ $\in$ \textsc{args}($F$) }
      {
         \Let{$F_\textit{callers}$}{\textsc{GetCallers}($F$)}
         
         
         \For{ $\forall F_i \in V_\textit{callers}$ }
         {
            {\textsc{BackwardAnalysis}(\textsc{GetCallerArg}($V_i$, $F_i$), $F_i$)}
         }
         
      }
      \uElseIf{ $V_i$ is a global variable }
      {
        \Let{$V_\textit{gdefs}$}{\textsc{GetGlobalDefVars}($V_i$)}
        
        \For{ $\forall V_j \in V_\textit{gdefs}$ }
         {
            {\textsc{BackwardAnalysis}($V_j$, \textsc{GetContainingFunc}($V_j$))}
         }
         
      }
      \uElse
      {
        {\textsc{BackwardAnalysis}($V_i$, $F$)}
      }
    }
  }
}
\end{algorithm}
