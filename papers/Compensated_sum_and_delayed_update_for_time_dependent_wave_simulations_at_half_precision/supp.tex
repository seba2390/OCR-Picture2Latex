%!TEX root = ./main.tex

% \input{shrd}
% \usepackage{xr}\externaldocument{main}

% \title{\large Supplementary Material for ``Compensated sum and delayed update for time dependent wave simulations at half precision''}

% \author{\small Longfei Gao\thanks{Email address: longfei.gao@anl.gov}
% \\ {\it \small Argonne National Laboratory, 9700 S Cass Ave, Lemont, IL 60439} 
% }
% \date{}

% \allowdisplaybreaks

% \def\bgnEqn{\begin{equation}}
% \def\endEqn{\end{equation}}

% \begin{document}

% \linenumbers

% \newlength{\phantomWidth} % used in algorithm for alignment
% \newlength{\commentWidth} % used in algorithm for alignment

% \maketitle

\begin{center}
\large
Supplementary Materials
\end{center}

\supp

\section{Additional figures for refinement study at double precision for longer time duration}\label{SM_double_additional}
%
This supplementary material contains additional figures corresponding to the refinement validation mentioned in section \ref{sec_1D_double} of the main text.
%
Figures comparing the simulation results at later segments of a longer simulation (100~s) are shown below.
%
(Plots on the top row of Figures \ref{double_Refinement_V_segments} and \ref{double_Refinement_E_segments} are the same as Figures \ref{double_Refinement_V} and \ref{double_Refinement_E} of the main text, respectively, which are included here again for convenience.)


From Figure \ref{double_Refinement_V_segments} (bottom), which corresponds to the segment between 98 s and 100 s, we can observe that at the later stage of the simulation, discretization error (dispersion error in particular) starts to creep in for the $N_\text{ppw} = 10$ case due to low resolution (which is expected behavior). 


As mentioned in section \ref{sec_example_1D_configuration} of the main text, the maximal frequency in the source content is counted as 12.5~Hz. 
%
In other words, the wave component with the fastest oscillation goes through 12.5 periods in one second. 
%
The top, middle, and bottom figures below correspond to 25, 150, and 1250 periods, respectively. 
%
We note here that the simulation duration corresponding to the bottom figures, and the middle figures to a lesser degree, often exceeds the practical needs in applications.


\input{./input/supp_double_refinement}


\newpage
\section{Additional figures and remarks for simulations at single precision}\label{SM_single_additional}
%
This supplementary material contains additional comparison figures and remarks on the implementation details of the single precision simulations presented in section \ref{sec_1D_single} of the main text.

The single precision simulations are conducted in MATLAB using the ``chop'' package \cite{higham2019simulating}.
% 
The ``chop'' function is applied at each arithmetic operation (rather than only at the final assignment) during the simulations.
%
Moreover, the ``chop'' function is used to truncate the stencils before entering the time stepping loop.
%
Finally, although the energy calculation inputs are at single precision, the energy calculation is conducted at double precision.


\subsection{Additional comparison}\label{SM_single_comparison}

Additional comparison plots (between single and double simulations) are shown below, containing segments from longer simulations with different grid resolutions.
%
Figure \ref{comparison_V_single_double_segments_ppw_10} (top) and Figure \ref{comparison_E_single_double_segments_ppw_10} (top) are the same as Figure \ref{comparison_V_single_double_ppw_10} and Figure \ref{comparison_E_single_double_ppw_10} of the main text, respectively, which are included below for convenience.

\input{./input/supp_single_double_comparison_ppw_10} 
\input{./input/supp_single_double_comparison_ppw_30}
\input{./input/supp_single_double_comparison_ppw_50}

\ \newline


\subsection{Refinement results}\label{SM_single_refinement}
Refinement study results, similar to those presented in Figures \ref{double_Refinement_V_segments} and \ref{double_Refinement_E_segments}, but conducted at single precision, are shown below. 
%
From Figure \ref{single_Refinement_V_segments} (bottom), we observe the same characteristic as in the double precision case that the discretization error is visible for $N_\text{ppw} = 10$ due to low resolution.
%
\input{./input/supp_single_refinement}


\newpage
\section{Additional figures and comments for naively switching to half precision}\label{SM_half_naive}
%
This supplementary material contains additional figures that compare the simulation results from naively switching to half precision with those from the single and double precision simulations, supplementing section \ref{sec_1D_half_naive} of the main text.


\subsection{Comparison plots}\label{SM_half_naive_plots}
%
Figures \ref{comparison_V_half_naive_segments_ppw_10}-\ref{comparison_E_half_naive_single_double_seg_0_100} contain the comparison plots for $N_\text{ppw}=10$, $N_\text{ppw}=30$, and $N_\text{ppw}=50$.
%
Figure \ref{comparison_V_half_naive_segments_ppw_10} and Figure \ref{comparison_E_half_naive_single_double_seg_0_100} (top) contain the same plots as those already presented in section \ref{sec_1D_half_naive} of the main text, which are included here again for convenience.
%
The time step length is $\Delta t = \text{\rm1.000165939331055e-04 s}$ for all three cases.


Several observations can be made from these figures.
%
First, from Figure \ref{comparison_E_half_naive_single_double_seg_0_100}, we observe that for all three grid resolutions tested (i.e., $N_\text{ppw} = 10$, $N_\text{ppw} = 30$, and $N_\text{ppw} = 50$), there is noticeable energy loss as the half precision simulations progress.
%
Second, there are noticeable oscillations superposed on the signals for all three cases, which are particularly pronounced in the bottom plots of Figures \ref{comparison_V_half_naive_segments_ppw_10}, \ref{comparison_V_half_naive_segments_ppw_30}, and \ref{comparison_V_half_naive_segments_ppw_50}.
%
Finally, there are noticeable phase shifts in the cases of $N_\text{ppw}=30$ and $N_\text{ppw}=50$.


The first two observations mentioned above will be improved upon by using compensated sum in the half precision simulations.
%
The third observation will be addressed by tweaking how the discretization parameters are combined and by carefully adjusting the discretization parameter $\Delta t$ for the half precision simulations, as explained in Supplementary Material \ref{SM_half_compensated} below.


\input{./input/supp_half_naive_comparison_ppw_10}\ \newline
\input{./input/supp_half_naive_comparison_ppw_30}\ \newline
\input{./input/supp_half_naive_comparison_ppw_50}\ \newline
\input{./input/supp_half_naive_comparison_energy_entire}


\subsection{Comparison plots using the same procedure as explained in section \ref{SM_half_compensated_plots}}
\label{SM_half_naive_more_plots}
%
This supplementary material contains figures from simulations using the same procedure as that explained below in section \ref{SM_half_compensated_plots}, with $\Delta t$ adjusted to \text{\rm9.997558593750000e-05 s} to address the phase shift issue mentioned in section \ref{SM_half_naive_plots}, but without using compensated sum,
%
so that the differences between the figures here and those presented in section \ref{SM_half_compensated_plots} are only due to applying compensated sum or not.

\input{./input/supp_half_naive_comparison_D_3_dt_dx_3_ppw_10}\ \newline
\input{./input/supp_half_naive_comparison_D_3_dt_dx_3_ppw_30}\ \newline
\input{./input/supp_half_naive_comparison_D_3_dt_dx_3_ppw_50}\ \newline
\input{./input/supp_half_naive_comparison_D_3_dt_dx_3_energy_entire}


\newpage
\section{Additional figures and comments for half precision simulations with compensated sum}\label{SM_half_compensated}


This supplementary material contains additional figures and comments that supplements section \ref{sec_1D_half_compensated} of the main text.


\subsection{Comparison plots}\label{SM_half_compensated_plots}

Figures \ref{comparison_V_half_compensated_segments_ppw_10}-\ref{comparison_E_half_compensated_single_double_seg_0_100} contain the comparison plots for $N_\text{ppw}=10$, $N_\text{ppw}=30$, and $N_\text{ppw}=50$.
%
Figure \ref{comparison_V_half_compensated_segments_ppw_10} and Figure \ref{comparison_E_half_compensated_single_double_seg_0_100} (top) contain the same plots as those already presented in section \ref{sec_1D_half_compensated} of the main text, which are included here again for convenience.
%
The time step length is $\Delta t = \text{\rm9.997558593750000e-05 s}$ for all three cases.
%
\textbf{\texttt{\small fast2sum}} is used for all figures shown below.


Comparing Figures \ref{comparison_V_half_compensated_segments_ppw_10}-\ref{comparison_E_half_compensated_single_double_seg_0_100} to their correspondences from section \ref{SM_half_naive_plots}, we observe marked improvements in all three unsatisfactory aspects observed in section \ref{SM_half_naive_plots} (energy loss, oscillation\footnotemark, and phase shift).
%
While the issues of energy loss and oscillation are readily improved upon by applying compensated sum, additional care is needed for the issue of phase shift, which is explained below.
%
\footnotetext{Some oscillations can still be observed, e.g., in Figure \ref{comparison_V_half_compensated_segments_ppw_50} (bottom). 
%
The same comments from footnote \ref{fnt_oscillations} of the main text also apply here.}


For this work, there are three discretization parameters that we should be cautious about in half precision simulations because of (implicit) truncation.
%
These are the stencil, $[\nicefrac{1}{24}, -\nicefrac{9}{8}, \nicefrac{9}{8}, -\nicefrac{1}{24}]$ in this case and denoted as $\mathbb D$ hereafter, the spatial grid spacing $\Delta x$, and the temporal step length $\Delta t$.
%
When calculating the right hand sides ($R^V$ and $R^\Sigma$ in Algorithms \ref{algTimeStepping} and \ref{algTimeSteppingComSum}) at each time step, the combined effect of $\mathbb D \cdot \frac{1}{\Delta x} \cdot \Delta t$ needs to be applied to the solution vectors.
% ($\Sigma$ and $V$).


As mentioned in Remark \ref{rmk_time_step_length}, the half precision representations of these numbers can deviate considerably from their double (and single) precision representations.
%
For example, {\rm 1e-4} would become {\rm 1.000165939331055e-4} after truncation; $\nicefrac{1}{24}$ would become {\rm 4.165649414062500e-2} rather than {\rm 4.166666666666667e-2}.


The effect of truncation depends on how the applications of $\mathbb D$, $\frac{1}{\Delta x}$, and $\Delta t$ are carried out.
%
To avoid truncation as much as we can, we combine their applications as $(\mathbb D \cdot 3) (\frac{\Delta t}{3 \cdot \Delta x})$. With $\mathbb D$ scaled up by 3, all numbers in the stencil can be represented exactly at half precision.
%
Given a pre-selected $\Delta x$, $\Delta t$ is chosen so that $\frac{\Delta t}{3 \cdot \Delta x}$ can be represented exactly at half precision, which is why $\Delta t$ is chosen as \text{\rm9.997558593750000e-05 s} for these simulations.


\input{./input/supp_half_compensated_comparison_ppw_10}\ \newline
\input{./input/supp_half_compensated_comparison_ppw_30}\ \newline
\input{./input/supp_half_compensated_comparison_ppw_50}\ \newline
\input{./input/supp_half_compensated_comparison_energy_entire}


\subsection{Zoom-in plots}\label{SM_half_compensated_zoom_in}
%
Below, zoom-in plots for segments of Figure \ref{comparison_V_half_compensated_segments_ppw_10} and Figure \ref{comparison_E_half_compensated_single_double_seg_0_100} (top) are shown.
%
From Figure \ref{comparison_V_half_compensated_zoom_in_ppw_10}, we observe that signals from the half precision simulations exhibit a ``staircase'' characteristic when zoomed in closely.
%
From Figure \ref{comparison_E_half_compensated_zoom_in_ppw_10}, we observe that energy evolution of the half precision simulations fluctuates and oscillates at high frequency when zoomed in closely. (Figure \ref{comparison_E_half_compensated_zoom_in_ppw_10} is zoomed in 200 times vertically compared to Figure \ref{comparison_E_half_compensated_single_double_seg_0_100}.)

\input{./input/supp_half_compensated_comparison_zoom_in}


\subsection{Plots using \textbf{\texttt{\small slow2sum}}}\label{SM_half_compensated_slow2sum}
%
Below, half precision simulation results using \textbf{\texttt{\small slow2sum}} is presented. 
%
Other than the algorithm used for compensated sum, the remaining simulation configuration and procedure are the same as those presented in section \ref{SM_half_compensated_plots}.
%
We observe little qualitative improvement in the figures below, compared to those shown in section \ref{SM_half_compensated_plots} using \textbf{\texttt{\small fast2sum}}.


\input{./input/supp_half_compensated_comparison_ppw_10_slow2sum}\ \newline
\input{./input/supp_half_compensated_comparison_ppw_30_slow2sum}\ \newline
\input{./input/supp_half_compensated_comparison_ppw_50_slow2sum}\ \newline
\input{./input/supp_half_compensated_comparison_energy_entire_slow2sum}


\newpage
\section{Additional figures and discussions for the 2D experiments}\label{SM_2D}

\subsection{Illustration of the model parameters}\label{SM_2D_model}
The shear wave-speed and density of the parameter model are illustrated below (along with the compressional wave-speed that has already been shown in Figure \ref{model_vp} of the main text). 

\begin{figure}[H]
\captionsetup{width=0.95\textwidth,font=footnotesize,labelfont=footnotesize}
\centering
%
\begin{subfigure}[b]{1\textwidth}
%
\centering\includegraphics[scale=0.2]{\string"./fig/2D_example/2D_model/Marmousi2/101_401/vp_101_401\string".png}
%
\vspace{-0.5em}
\caption{Compressional wave-speed.}
\end{subfigure}\hfill
\\[1ex]
%
\begin{subfigure}[b]{1\textwidth}
%
\centering\includegraphics[scale=0.2]{\string"./fig/2D_example/2D_model/Marmousi2/101_401/vs_101_401\string".png}
%
\vspace{-0.5em}
\caption{Shear wave-speed.}
\end{subfigure}\hfill
\\[1ex]
%
\begin{subfigure}[b]{1\textwidth}
%
\centering\includegraphics[scale=0.2]{\string"./fig/2D_example/2D_model/Marmousi2/101_401/rho_101_401\string".png}
%
\vspace{-0.5em}
\caption{Density.}
\end{subfigure}\hfill
%
\caption{Medium parameters.}
\label{SM_medium_parameters}
\end{figure}


\subsection{Comparison of signals from simulations with larger time step length}\label{SM_2D_signal_larger_dt}
%
Figure \ref{comparison_V_half_compensated_single_double_ppw_10_marmousi2_1e-3} 
supplement 
Figures \ref{comparison_V_half_compensated_single_double_ppw_10_seg_0_2_marmousi2}-\ref{comparison_V_half_compensated_single_double_ppw_10_seg_98_100_marmousi2}
of the main text, 
and compares the recorded signals from half precision (with \textbf{\texttt{\small slow2sum}}), single precision, and double precision simulations using $\Delta t = \text{1e-3 s}$, i.e., 10 times larger than that used for 
Figures \ref{comparison_V_half_compensated_single_double_ppw_10_seg_0_2_marmousi2}-\ref{comparison_V_half_compensated_single_double_ppw_10_seg_98_100_marmousi2} of the main text.%
%
\footnotemark
\footnotetext{
Given the chosen $\Delta x = \nicefrac{1}{128}$~km and the maximal wave-speed at about 4.5~km/s, 
the maximal time step length allowed by the interior stencil 
$
[\nicefrac{1}{24}, -\nicefrac{9}{8}, \nicefrac{9}{8}, -\nicefrac{1}{24}]
$
is about 1.064e-3~s, while the boundary operators may incur additional penalty on the time step length allowed (see \cite[Appendix A]{gao2022strongly} for more detail).
%
In other words, $\Delta t = \text{1e-3~s}$ is pretty much at the CFL limit.
}
%
We again observe satisfactory agreements from these figures.


\renewcommand{\folderPath}{\string"./fig/2D_example/marmousi2_101_401/nvidia_plot_dt_h_10_1p000404357910156e-03_6R_dt_s_10_1p000000047497451e-03_6R_dt_d_10_1p000000000000000e-03_6R/half_chop_D_chop_dx_chop_dt_single_double/\string"}
%
\begin{figure}[H]
\captionsetup{width=0.95\textwidth,font=footnotesize,labelfont=footnotesize}
\centering
%
\begin{subfigure}[b]{1\textwidth}
%
\centering\includegraphics[scale=0.2]{\string"\folderPath/V_comparison_ppw_10_100001_seg_0_2\string".png}
%
\end{subfigure}\hfill
\\[2ex]
%
\begin{subfigure}[b]{1\textwidth}
%
\centering\includegraphics[scale=0.2]{\string"\folderPath/V_comparison_ppw_10_100001_seg_10_12\string".png}
%
\end{subfigure}\hfill
\\[2ex]
%
\begin{subfigure}[b]{1\textwidth}
%
\centering\includegraphics[scale=0.2]{\string"\folderPath/V_comparison_ppw_10_100001_seg_98_100\string".png}
%
\end{subfigure}\hfill
%
\caption{Recorded signals from simulations using half (with \textbf{\texttt{\footnotesize slow2sum}}), single, and double precisions.}
\label{comparison_V_half_compensated_single_double_ppw_10_marmousi2_1e-3}
\end{figure}
%
\renewcommand{\folderPath}{\string"/dev/null\string"}


\subsection{Comparison of energy evolution}\label{SM_2D_energy}
%
Comparison of the energy evolution are shown in Figures \ref{comparison_E_half_compensated_single_double_marmousi2}-\ref{comparison_E_half_compensated_single_double_marmousi2_0_0p01} for simulations using $\Delta t = \text{1e-4~s}$.
%
Figure \ref{comparison_E_half_compensated_single_double_marmousi2_0_0p01} contains the zoom-in plots in the vertical axis. 
%
From these plots, we observe that the energy evoluation of the half precision simulation (with \textbf{\texttt{\small slow2sum}}) largely follows the supposed trend (i.e., remaining flat after the initial period when the source takes effect). 


Curiously, for the half precision simulation, the energy dips lower at the end of the period when the source takes effect, which can be observed 
% most obviously 
from Figure \ref{comparison_E_half_compensated_single_double_marmousi2_0_0p01} (bottom).
%
The exact reason behind this behavior is unclear to the author at this stage.

\input{./input/supp_half_compensated_comparison_energy_marmousi2}


\subsection{Simulation results from naively switching to half precision}\label{SM_2D_naive}
%
Simulation results from naively switching to half precision (i.e., without compensated sum) using $\Delta t = \text{1e-4~s}$ are shown below. We observe more wiggles in the half precision simulation results for all three segments when compared to those from Figures \ref{comparison_V_half_compensated_single_double_ppw_10_seg_0_2_marmousi2}-\ref{comparison_V_half_compensated_single_double_ppw_10_seg_98_100_marmousi2} of the main text.


\renewcommand{\folderPath}{\string"./fig/2D_example/marmousi2_101_401/nvidia_plot_dt_h_10_1p000165939331055e-04_00_dt_s_10_9p999999747378752e-05_00_dt_d_10_1p000000000000000e-04_00/half_chop_D_chop_dx_chop_dt_single_double/\string"}
%
\begin{figure}[H]
\captionsetup{width=1\textwidth, font=footnotesize,labelfont=footnotesize}
\centering\includegraphics[scale=0.2]{\string"\folderPath/V_comparison_ppw_10_1000001_seg_0_2\string".png}
\caption{Recorded signals from simulations using half, single, and double.}
\label{comparison_V_half_compensated_single_double_ppw_10_seg_0_2_marmousi2_naive}
\end{figure}
%
\begin{figure}[H]
\captionsetup{width=1\textwidth, font=footnotesize,labelfont=footnotesize}
\centering\includegraphics[scale=0.2]{\string"\folderPath/V_comparison_ppw_10_1000001_seg_10_12\string".png}
\caption{Recorded signals from simulations using half, single, and double.}
\label{comparison_V_half_compensated_single_double_ppw_10_seg_10_12_marmousi2_naive}
\end{figure}
%
\begin{figure}[H]
\captionsetup{width=1\textwidth, font=footnotesize,labelfont=footnotesize}
\centering\includegraphics[scale=0.2]{\string"\folderPath/V_comparison_ppw_10_1000001_seg_98_100\string".png}
\caption{Recorded signals from simulations using half, single, and double.}
\label{comparison_V_half_compensated_single_double_ppw_10_seg_98_100_marmousi2_naive}
\end{figure}
%
\renewcommand{\folderPath}{\string"/dev/null\string"}


% \newpage
% \renewcommand{\bibfont}{\normalfont\small}
% \bibliographystyle{./bst_base/abbrv.bst}
% \bibliography{refs}


% \end{document}