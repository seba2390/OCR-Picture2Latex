\definecolor{almostwhite}{RGB}{240,240,240}
\ifdefined\shiftforposter\else
    \newcommand{\shiftforposter}{0mm}
\fi
\tikzset{
    >={Latex[width=1.5mm,length=1.5mm]},
    end/.style = {circle, minimum width=2mm, minimum height=2mm},
    block/.style = {rectangle, fill=white, draw=black, minimum width=40mm, minimum height=10mm},
    duplicate/.style = {rectangle, fill=none, draw=gray, dashed, minimum width=4cm},
}

\trimbox{0 0 0 5mm}{ % left, bottom, right, top
\begin{tikzpicture}
% \begin{tikzpicture}[background rectangle/.style={fill=white}, show background rectangle]

\node (eval) [block, double copy shadow={fill=almostwhite, draw=black, shadow xshift=1mm, shadow yshift=1mm}, label={[yshift=-(\shiftforposter/2)]below:\textbf{policy evaluation}}, label={[anchor=south west, xshift=\shiftforposter+3mm, yshift=\shiftforposter+1.5mm]north west:{$n$ parallel MCTS simulations}}] {\resizebox{5cm}{!}{\input{figures/diagrams/mcts-betazero}}};

\node (improve) [block, below=17mm of eval, label={[yshift=(\shiftforposter/2)]above:\textbf{policy improvement}}] {$f'_\theta = \textsc{Train}(f_\theta, \mathcal{D})$};

% \node (input) [left=10mm of eval, label={below:\shortstack{\scriptsize initial network\\\scriptsize$\mathbf{p}=P_\theta(\tilde{b})$, $v = V_\theta(\tilde{b})$}}] {$(\mathbf{p},v) = f_\theta(\tilde{b})$};

\node (input) [left=10mm of eval, label={[xshift=(-\shiftforposter/2),yshift=-\shiftforposter]below:\shortstack{initial network}}] {$(\mathbf{p},v) = f_\theta(\tilde{b})$\hspace*{\shiftforposter}};

\draw[->] (input.east) -- (eval.west);

\draw[->] ($(eval.east)+(2mm,0mm)$) -| ++(4mm,0mm) |- (improve.east) node [pos=0.25, xshift=\shiftforposter, label={right:\shortstack{$\mathcal{D}=\left\{\big\{(b_t, \pi_t, g_t)\big\}_{t=1}^T\right\}_{i=1}^n$\\{collected data}}}] {};

\draw[-] (improve.west) -| ($(eval.west)+(-4mm,0)$) node [pos=0.75, xshift=-\shiftforposter, label={left:$f_\theta = f'_\theta$}] {};


% \node (input) [] {input size = $32 \times 32 \times 2$};

% \node (input_norm) [block, below of=input] {normalization}; 
% \node (conv1) [block, below of=input] {$\text{convolution}(5,5) \Rightarrow \text{relu}$};
% \node (conv2) [block, below of=conv1] {$\text{convolution}(5,5) \Rightarrow \text{relu}$};
% \node (flatten) [block, below of=conv2] {flatten};


% % \node (dense1) [block, below=6mm of input_norm] {fully connected};
% \node (bnorm1) [block, below=6mm of flatten] {fc $\Rightarrow$ batch norm};
% \node (dense1) [block, below=6mm of bnorm1] {relu};
% \node (dropout1) [block, below of=dense1] {dropout};

% \path let \p1=(bnorm1.north), \p2=(dropout1.south) in node (duplicate_block) [fit={($(\x1,\y1)+(0mm,1mm)$) ($(\x2,\y2)+(0mm,0mm)$)}, duplicate, minimum width=35mm]{};
% \node at ($(duplicate_block.south west)+(3mm,2mm)$) [font={\small}, text=gray] {$\times 2$};

% \node (vbnorm1) [block, below left=8mm and -15mm of duplicate_block, label={above:{\tiny value head}}] {fc $\Rightarrow$ batch norm};
% \node (vdense1) [block, below of=vbnorm1] {relu};
% \node (vdropout) [block, below of=vdense1] {dropout};
% \node (vdense2) [block, below of=vdropout] {relu};
% \node (vnorm) [block, below of=vdense2, label={below:$V_\theta(\tilde{b})$}] {denormalization};

% \node (pbnorm1) [block, below right=8mm and -15mm of duplicate_block, label={above:{\tiny policy head}}] {fc $\Rightarrow$ batch norm};
% \node (pdense1) [block, below of=pbnorm1] {relu};
% \node (pdropout) [block, below of=pdense1] {dropout};
% \node (pdense2) [block, below of=pdropout] {relu};
% \node (psoftmax) [block, below of=pdense2, label={below:$P_\theta(\tilde{b},\cdot)$}] {softmax};

% \draw[->] (input.south) -- (conv1.north);
% \draw[->] (conv1.south) -- (conv2.north) node [pos=0.4, label={[label distance=-2mm]right:{\tiny $\ell=64$}}] {};
% \draw[->] (conv2.south) -- (flatten.north) node [pos=0.4, label={[label distance=-2mm]right:{\tiny $\ell=128$}}] {};
% \draw[->] (flatten.south) -- (bnorm1.north) node [pos=0.4, label={[label distance=-2mm]right:{\tiny $\ell=73728$}}] {};
% \draw[->] (bnorm1.south) -- (dense1.north) node [pos=0.4, label={[label distance=-2mm]right:{\tiny $\ell=256$}}] {};
% \draw[->] (dense1.south) -- (dropout1.north) node [pos=0.4, label={[label distance=-2mm]right:{\tiny $\ell=256$}}] {};

% \draw[->] ($(dropout1.south)+(-0.2mm,0)$) -| ++(0,-3mm) -| ($(vbnorm1.north)+(0,2.7mm)$);
% \draw[->] ($(dropout1.south)+(0.2mm,0)$) -| ++(0,-3mm) -| ($(pbnorm1.north)+(0,2.7mm)$);

% \draw[->] (vbnorm1.south) -- (vdense1.north) node [pos=0.4, label={[label distance=-2mm]right:{\tiny $\ell=256$}}] {};
% \draw[->] (vdense1.south) -- (vdropout.north) node [pos=0.4, label={[label distance=-2mm]right:{\tiny $\ell=256$}}] {};
% \draw[->] (vdropout.south) -- (vdense2.north) node [pos=0.4, label={[label distance=-2mm]right:{\tiny $\ell=256$}}] {};
% \draw[->] (vdense2.south) -- (vnorm.north) node [pos=0.4, label={[label distance=-2mm]right:{\tiny $\ell=1$}}] {};

% \draw[->] (pbnorm1.south) -- (pdense1.north) node [pos=0.4, label={[label distance=-2mm]right:{\tiny $\ell=256$}}] {};
% \draw[->] (pdense1.south) -- (pdropout.north) node [pos=0.4, label={[label distance=-2mm]right:{\tiny $\ell=256$}}] {};
% \draw[->] (pdropout.south) -- (pdense2.north) node [pos=0.4, label={[label distance=-2mm]right:{\tiny $\ell=256$}}] {};
% \draw[->] (pdense2.south) -- (psoftmax.north) node [pos=0.4, label={[label distance=-2mm]right:{\tiny $\ell=|\mathcal{A}|=38$}}] {};



% \node (falsification) [sectionstyle, label={above:\textsc{Falsification}}] {
% \begin{tikzpicture}
%     \node (start) [startstyle] {};

%     \node (success) [successstyle, above right=3mm and 25mm of start, label={right:{\color{darkgreen}success}}] {};
%     \node (failure) [failurestyle, below right=3mm and 25mm of start, label={right:{\color{darkred}failure}}] {};

%     \draw [semithick,->] plot [smooth] coordinates {(start.east) ($(start.east)+(3mm,0mm)$)  ($(start.east)+(6mm,-3mm)$) ($(start.east)+(13mm,1mm)$) ($(start.east)+(20mm,-10mm)$) (failure.south west)};
% \end{tikzpicture}
% };

% \draw [gray] ($(falsification.east) + (0.4cm,-2)$) -- ($(falsification.east) + (0.4cm,2)$);

% \node (mostlikely) [sectionstyle, right=of falsification, label={[align=center]above:\textsc{Most-likely}\\\textsc{Failure Analysis}}] {
% \begin{tikzpicture}
%     \node (start) [startstyle] {};
    
%     \node (success) [successstyle, above right=3mm and 25mm of start, label={right:{\color{darkgreen}success}}] {};   
%     \node (failure) [failurestyle, below right=3mm and 25mm of start, label={right:{\color{darkred}failure}}] {};

%     \draw [semithick,->] plot [smooth] coordinates {(start.east) ($(start.east)+(10mm,1mm)$) (failure.north west)};
% \end{tikzpicture}
% };

% \draw [gray] ($(mostlikely.east) + (0.4cm,-2)$) -- ($(mostlikely.east) + (0.4cm,2)$);

% \node (failureprob) [sectionstyle, right=of mostlikely, label={[align=center]above:\textsc{Failure Probability}\\\textsc{Estimation}}] {
% \begin{tikzpicture}
%     \node (start) [startstyle] {};
    
%     \node (success) [successstyle, above right=3mm and 25mm of start, label={right:{\color{darkgreen}success}}] {};
%     \node (failure) [failurestyle, below right=3mm and 25mm of start, label={right:{\color{darkred}failure}}] {};

%     \draw [semithick,gray4,->] plot [smooth] coordinates {(start.east) ($(start.east)+(3mm,0mm)$)  ($(start.east)+(6mm,-3mm)$) ($(start.east)+(13mm,1mm)$) ($(start.east)+(20mm,-10mm)$) (failure.south west)};
%     \draw [semithick,gray4,->] plot [smooth] coordinates {(start.east) ($(start.east)+(5mm,-2mm)$) ($(start.east)+(16mm,-12mm)$) (failure.south)};
%     \draw [semithick,gray3,->] plot [smooth] coordinates {(start.east) ($(start.east)+(15mm,6mm)$) (failure.north)};
%     \draw [semithick,gray2,->] plot [smooth] coordinates {(start.east) ($(start.east)+(5mm,-1mm)$) ($(start.east)+(15mm,-9mm)$) (failure.south west)};
%     \draw [semithick,gray1,->] plot [smooth] coordinates {(start.east) ($(start.east)+(6mm,-1mm)$) ($(start.east)+(15mm,-6mm)$) (failure.west)};
%     \draw [semithick,->] plot [smooth] coordinates {(start.east) ($(start.east)+(10mm,1mm)$) (failure.north west)};
% \end{tikzpicture}
% };

\end{tikzpicture}
} % trimbox