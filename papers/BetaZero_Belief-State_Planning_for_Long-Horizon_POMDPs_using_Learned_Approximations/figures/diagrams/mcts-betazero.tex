\ifdefined\shiftforposter\else
    \newcommand{\shiftforposter}{0mm}
\fi
\tikzset{
    nodes={draw=\primarycolor, fill=\secondarycolor, circle}, >=latex, -, level distance=11mm,
    level 1/.style={sibling distance=24mm},
    level 2/.style={sibling distance=10mm, level distance=16mm},
    every node/.style={draw=\primarycolor, fill=\secondarycolor, text=\primarycolor, thin, minimum size=7mm, scale=1.2},
    every path/.append style={draw=\primarycolor},
    norm/.style={edge from parent/.style={thin,draw}},
    emph1/.style={edge from parent/.style={line width=1.6pt}},
    emph2/.style={edge from parent/.style={line width=2.0pt,draw}},
    emph3/.style={edge from parent/.style={line width=2.4pt,draw}},
    emph4/.style={edge from parent/.style={line width=1.6pt,draw}}, % rollout
    semiselected/.style={line width=2pt},
    invisible/.style={draw=none, fill=none},
    selected/.style={line width=2pt},
    root/.style={label=\textsc{#1}},
    baseline=(selection.base),
    state/.style={circle, norm, -},
    action/.style={rectangle, norm, sibling distance=2in},
    rollout-end/.style={draw=none, rectangle, minimum height=0mm, text=\primarycolor},
    rollout-edge/.style={->, decorate, decoration={snake, amplitude=1mm, post length=10pt, segment length=12pt}, dotted, line cap=round, dash pattern=on 0pt off 2\pgflinewidth},
}
\newcommand{\spacing}{3.5cm}
\trimbox{4mm 12mm 0 2mm}{ % left, bottom, right, top
\begin{tikzpicture}
    % \node [root={Selection/Branching}, state, selected] (selection) {$b$}
    % \node [root={Selection}, state, selected, label={[label distance=10mm]below:\small{$\left(\text{where } \tilde{b}\leftarrow\textsc{Representation}(b)\right)$}}] (selection) {$b$}
    \node [root={Selection}, state, selected, label={[label distance=10mm]below:\small{$\left(\text{where } \tilde{b}\leftarrow\phi(b)\right)$}}] (selection) {$b$}
        % child [emph1, ->] { node [action, selected, label={[label distance=-0mm]below:\small{\shortstack{$a\leftarrow\textsc{Select}\bigl(P_\theta(\tilde{b}, \cdot)\bigr)$}}}] {$a$}
        child [emph1, ->] { node [action, selected, label={[label distance=-(1mm-\shiftforposter)]right:\small{$\sim P_\theta(\tilde{b})$}}] {$a$}
            child [] { edge from parent[invisible] node[invisible] {} }
            child [] { edge from parent[invisible] node[invisible] {} }
        }
        % child [state] {node [action] {}}
        child [state] {node [action] {}
            % child [state] { node {} }
            % child [state] { node {} }
        };

    \node [root=Expansion, state, right=\spacing of selection] (expansion) {$b$}
        child { node [action, semiselected] {$a$}
            child [state, emph1, ->] { node [semiselected, label={[label distance=-10.5mm]below:\small{\shortstack{$b'\leftarrow\textsc{Update}(b,a,o)$}}}] {$b'$} edge from parent node[right, draw=none, fill=none, text=\primarycolor, pos=0.63, xshift=\shiftforposter] {\ \small{\shortstack[l]{$s\phantom{'}\sim b\phantom{T()}$\\$s' \sim T(s,a)$\\$o\phantom{'} \sim O(a,s')$}}}}
            % child [] { edge from parent[invisible] node[invisible] {} }
        }
        % child [state] {node [action] {}}
        child [state] {node [action] {}
            % child [state] { node {} }
            % child [state] { node {} }
        };

    % \node [root=Simulation/Rollout, state, right of=expansion] (simulation) {$b$}
    \node [root=Simulation, state, right=\spacing of expansion] (simulation) {$b$}
        child { node [action] {$a$}
            child [state] { node [state, selected] {$b'$}
                child [state, emph4, draw=none, level distance=0.6in] { node [rollout-end, invisible] {$r + \gamma V_\theta(\tilde{b}')$}
                    edge from parent [rollout-edge]
                }
            }
            % child [] { edge from parent[invisible] node[invisible] {} }
        }
        % child [state] {node [action] {}}
        child [state] {node [action] {}
            % child [state] { node {} }
            % child [state] { node {} }
        };

    \node [root=Backpropagation, state, selected, right=\spacing of simulation] (backprop) {$b$}
        child [<-,emph1] { node [action, selected] {$a$}
            child [state, emph1, <-] { node [state, selected] {$b'$} edge from parent node[right, pos=0.65, xshift=\shiftforposter, draw=none, fill=none, text=\primarycolor] {\small{$Q$-value}}}
            % child [] { edge from parent[invisible] node[invisible] {} }
        }
        % child [state] {node [action] {}}
        child [state] {node [action] {}
            % child [state] { node {} }
            % child [state] { node {} }
        };
\end{tikzpicture}
}
