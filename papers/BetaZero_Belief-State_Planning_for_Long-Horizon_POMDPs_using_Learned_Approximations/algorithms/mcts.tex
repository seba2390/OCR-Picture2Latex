\begin{algorithm}[H]
    \small
    \caption{BetaZero MCTS simulation.}
    \label{alg:betazero-mcts}
    \begin{algorithmic}[1]
        \Function{Simulate$(f_\theta, b, d)$}{} \GrayComment{where $P_\theta, V_\theta \leftarrow f_\theta$}
            \State \textbf{if}\ $d=0$\ \textbf{return}\ $0$
            \If {$b \not\in \mathcal{T}$}
                \State $\mathcal{T} \leftarrow \mathcal{T} \cup \{b\}$ \GrayComment{add belief-state node to the tree $\mathcal{T}$}
                \State $N(b) \leftarrow N_0(b)$
                \State $\tilde{b} \leftarrow \phi(b)$ \GrayComment{belief representation \cref{eq:belief_rep}}
                \State \Return $V_\theta(\tilde{b})$  \label{line:mcts_lookup} \GrayComment{value-estimate lookup}
            \EndIf
            \State $N(b) \leftarrow N(b) + 1$
            \State $a \leftarrow \textproc{ActionSelection}(f_\theta, b)$ \label{line:mcts_selection} \GrayComment{\cref{alg:betazero-action-pw}}
            \State $(b^\prime, r) \leftarrow \textproc{BeliefStateExpansion}(b,a)$\label{line:mcts_expansion} \GrayComment{\cref{alg:betazero-state-pw}}
            \State $q \leftarrow r + \gamma \textproc{Simulate}(f_\theta, b^\prime, d-1)$ \label{line:mcts_simulation} \GrayComment{\cref{alg:betazero-mcts}}
            \State $N(b,a) \leftarrow N(b,a)+1$
            \State $Q(b,a) \leftarrow Q(b,a)+\frac{q-Q(b,a)}{N(b,a)}$  \label{line:mcts_backprop} \GrayComment{backpropagation}
            \State \Return $q$
        \EndFunction
    \end{algorithmic}
\end{algorithm}
