
\newcommand{\mymul}[1]{{\mu}_{\mkern-0.66\thinmuskip\mathcal{L}, #1} }

\pgfdeclarelayer{bg}
\pgfsetlayers{bg,main}

\begin{tikzpicture}[x=0.2cm]

  \FPeval{\spahalf}{clip(0.9)}
  \FPeval{\spamore}{clip(0.2)}

  \node[latent] (x-1)  {$X_1$} ;
  \node[latent, below=of x-1] (mu-1)  {$\mymul{1}$} ;
  \foreach \i in {2,...,5}{
    \FPeval{\prev}{clip(\i - 1)}
    \node[latent, right=of x-\prev] (x-\i)  {$X_{\i}$} ;
    \node[latent, below=of x-\i] (mu-\i)  {$\mymul{\i}$} ;
  }
  \node[latent, right=of x-5, xshift=\spamore cm] (x-6)  {$X_6$} ;
  \node[latent, below=of x-6] (mu-6)  {$\mymul{6}$} ;
  \foreach \i in {7,...,8}{
    \FPeval{\prev}{clip(\i - 1)}
    \node[latent, right=of x-\prev] (x-\i)  {$X_{\i}$} ;
    \node[latent, below=of x-\i] (mu-\i)  {$\mymul{\i}$} ;
  }
  \node[const, right=of x-8] (x-ellipsis)  {...} ;
  \node[latent, right=of x-ellipsis] (x-97)  {$X_{97}$} ;
  \node[latent, right=of x-97]       (x-98)  {$X_{98}$} ;
  \node[latent, right=of x-98]       (x-99)  {$X_{99}$} ;
  \node[const, right=of mu-8] (mu-ellipsis)  {...} ;
  \node[latent, below=of x-97] (mu-97)  {$\mymul{97}$} ;
  \node[latent, below=of x-98] (mu-98)  {$\mymul{98}$} ;
  \node[latent, below=of x-99] (mu-99)  {$\mymul{99}$} ;
  \foreach \i in {1,...,8,97,98,99}{
    \edge[-] {x-\i} {mu-\i}
  }

  \gate {} {(x-1)(x-2)(x-3)(x-4)(x-5)} {}
  \gate {} {(x-6)(x-7)(x-8)} {}
  \gate {lastcluster} {(x-97)(x-98)(x-99)} {}
  \node[const, right=of lastcluster]    (cl-comment)  {$\longleftarrow$ clusters} ;

  
  % thetas
  \node[latent, below=of mu-3]    (t-1)  {$\theta_{1}$} ;
  \node[latent, below=of mu-7]    (t-2)  {$\theta_{2}$} ;
  \node[const, right=of t-2, xshift=\spahalf cm]   (t-ellipsis)  {...} ;
  \node[latent, below=of mu-98]    (t-k)  {$\theta_{K}$} ;
  \foreach \i in {1,...,5}{
    \edge[-] {mu-\i} {t-1}
  }
  \foreach \i in {6,...,8}{
    \edge[-] {mu-\i} {t-2}
  }
  \foreach \i in {97,...,99}{
    \edge[-] {mu-\i} {t-k}
  }

  % below
  \begin{pgfonlayer}{bg}
    \newcommand{\colorforb}{lightgray!75!blue}
    \newcommand{\colorforbb}{lightgray!75!green}
    \newcommand{\colorforL}{white!50!red}
    % b
    \node[latent, text=\colorforb, draw=\colorforb, below=of t-2, xshift=1.3cm]    (b)  {$\bm{b}$} ;
    \node[const, right=of b]    (b-comment)  {$\longleftarrow$ common bias} ;
    \foreach \i in {1,...,8,97,98,99}{
      \edge[-,color=\colorforb] {mu-\i} {b}
    }
    \edge[-,color=\colorforbb] {t-1} {b}
    \edge[-,color=\colorforbb] {t-2} {b}
    \edge[-,color=\colorforbb] {t-k} {b}
    % landmarks
    \node[latent, text=\colorforL, draw=\colorforL, right=of mu-99, xshift=0.5cm, yshift=-1.3cm] (L)  {$\bm{\mathcal{L}}$} ;
    %\edge[-,color=\colorforL] {mu-1} {L} % (no loop) good enough visually
    \foreach \i in {1,...,8,97,98,99}{
      \edge[-,color=\colorforL] {mu-\i} {L}
    }
    \node[const, right=of L]    (L-comment)  {$\longleftarrow$ landmarks} ;
  \end{pgfonlayer}

\end{tikzpicture}
