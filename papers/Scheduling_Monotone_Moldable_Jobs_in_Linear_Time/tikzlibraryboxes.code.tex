\RequirePackage{etoolbox}

\def\packing@x@min{0pt}
\def\packing@x@max{0pt}
\def\packing@x@diff{0pt}
\def\packing@x@lasti{min}
\def\packing@x@lastii{max}
\def\packing@y@min{0pt}
\def\packing@y@max{0pt}
\def\packing@y@diff{0pt}
\def\packing@y@lasti{min}
\def\packing@y@lastii{max}

\newcommand{\packing@setvar}[3]{% 1: x or y 2: min, max, diff 3: point
  \tikz@scan@one@point\pgfutil@firstofone #3\relax
  \csedef{packing@#1@#2}{\expandafter\the\csname pgf@#1\endcsname}%
  \ifcsstring{packing@#1@lasti}{#2}{%
  }{%
    \csletcs{packing@#1@lastii}{packing@#1@lasti}%
    \csedef{packing@#1@lasti}{#2}%
  }%
}

\pgfqkeys{/packing}{
  align left/.value required,
  align left/.code={\packing@setvar{x}{min}{#1}},
  align right/.value required,
  align right/.code={\packing@setvar{x}{max}{#1}},
  align bottom/.value required,
  align bottom/.code={\packing@setvar{y}{min}{#1}},
  align top/.value required,
  align top/.code={\packing@setvar{y}{max}{#1}},
  %
  width/.value required,
  width/.code={\packing@setvar{x}{diff}{(#1,0)}{x}},
  height/.value required,
  height/.code={\packing@setvar{y}{diff}{(0,#1)}},
  %
  x-min/.style={align left={(#1,0)}},
  x-max/.style={align right={(#1,0)}},
  y-min/.style={align bottom={(0,#1)}},
  y-max/.style={align top={(0,#1)}},
  %
  right of/.style={align left=(#1.east)},
  left of/.style={align right=(#1.west)},
  above of/.style={align bottom=(#1.north)},
  below of/.style={align top=(#1.south)},
}

\newcommand{\packing@ifhas}[4]{% If list #1 contains #2 execute #3 else #4
  \ifcsstring{packing@#1@lasti}{#2}{%
    #3%
  }{%
    \ifcsstring{packing@#1@lastii}{#2}{%
      #3%
    }{%
      #4%
    }%
  }%
}

% Calculate width/height if not set
\newcommand{\packing@calcmissing}[1]{%
  \packing@ifhas{#1}{diff}{%
    \packing@ifhas{#1}{min}{}{%
      \pgfmathparse{\csname packing@#1@max\endcsname-\csname packing@#1@diff\endcsname}%
      \csedef{packing@#1@min}{\pgfmathresult pt}%
    }%
  }{%
    \pgfmathparse{\csname packing@#1@max\endcsname-\csname packing@#1@min\endcsname}%
    \csedef{packing@#1@diff}{\pgfmathresult pt}%
  }
}

\tikzset{every pnode/.style={}}

\newcommand{\pnode}[3][]{%
    \pgfqkeys{/packing}{#2}
    \packing@calcmissing{x}
    \packing@calcmissing{y}
    \node[draw,every pnode,#1,anchor=south west,inner sep=0pt,outer sep=0pt,minimum width=\packing@x@diff,minimum height=\packing@y@diff]
      at (\packing@x@min,\packing@y@min) {#3};
}

\newcommand{\namedpnode}[4][]{%
    \pgfqkeys{/packing}{#2}
    \packing@calcmissing{x}
    \packing@calcmissing{y}
    \node[draw,every pnode,#1,anchor=south west,inner sep=0pt,outer sep=0pt,minimum width=\packing@x@diff,minimum height=\packing@y@diff]
      (#3) at (\packing@x@min,\packing@y@min) {#4};
}

\newcommand{\drawschedule}[2][]{%
	\draw[#1] (#2.north east)+(0,0.3) [dotted]-- +(0,1);
	\draw[#1] (#2.north east)+(0,0.3) -- (#2.south east);
	\draw[#1] (#2.south east) -- (#2.south west);
	\draw[#1] (#2.north west)+(0,0.3) -- (#2.south west);
	\draw[#1] (#2.north west)+(0,0.3) [dotted]-- +(0,1);
}
