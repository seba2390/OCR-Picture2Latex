\begin{figure*}[ht]
    \centering
    \begin{tikzpicture}
    
        \tikzstyle{green_circle} = [shape=circle, minimum size=0.2cm, circular drop shadow, text=black, very thick, draw=black!55, top color=white,bottom color=green!80, text width=0.2cm, align=center]
        \tikzstyle{red_circle} = [shape=circle, minimum size=0.2cm, circular drop shadow, text=black, very thick, draw=black!55, top color=white,bottom color=red!80, text width=0.2cm, align=center]
        \tikzstyle{embs} = [shape = rectangle, rounded corners]
        
        \tikzset{>=stealth'}
        
        \node at (-8.5,-5) {$X$};
        \draw [thin, double, rounded corners] (-7,-4.5) rectangle (6.5,-5.5);
        \node at (-6,-5) {My};
        \node (v3) at (-3.5,-5) {hovercraft};
        \node (v1) at (-0.5,-5) {is};
        \node at (1,-5) {full};
        \node at (2.5,-5) {of};
        \node at (4,-5) {eels};
        \node at (5.5,-5) {.};
        
        \node at (-8.5,-3.75) {$\tau$};
        \draw [thin, double, rounded corners] (-6.5,-3.5) rectangle (-5.5,-4);
        \draw [fill=white,thin, double, rounded corners] (-5,-3.5) rectangle (-3.55,-4);
        \draw [thin, double, rounded corners] (-3.45,-3.5) rectangle (-2,-4) node (v2) {};
        \draw [fill=gray!15, thin, double, rounded corners] (-1.25,-3.5) rectangle (0.25,-4);
        \draw [thin, double, rounded corners] (0.5,-3.5) rectangle (1.5,-4);
        \draw [fill=gray!15, thin, double, rounded corners] (1.75,-3.5) rectangle (3.25,-4);
        \draw [thin, double, rounded corners] (3.5,-3.5) rectangle (4.5,-4);
        \draw [thin, double, rounded corners] (5,-3.5) rectangle (6,-4);
        \node (t1) at (-6,-3.82) {my};
        \node (t2) at (-3.5,-3.25) {};
        \node (t21) at (-4.25,-3.75) {hover};
        \node (t22) at (-2.75,-3.75) {\#\#craft};
        \node (t3) at (-0.5,-3.78) {\small [MASK]};
        \node (t4) at (1,-3.75) {full};
        \node (t5) at (2.5,-3.78) {\small [MASK]};
        \node (t6) at (4,-3.75) {eels};
        \node (t7) at (5.5,-3.75) {.};
        
        \node at (-8.5,-2.5) {$\pi^t$};
        \node (p1) [green_circle] at (-6,-2.5) {\small \checkmark};
        \node (p2) [red_circle] at (-3.5,-2.5) {\small $\times$};
        \node (p3) [green_circle] at (-0.5,-2.5) {\small \checkmark};
        \node (p4) [green_circle] at (1,-2.5) {\small \checkmark};
        \node (p5) [green_circle] at (2.5,-2.5) {\small \checkmark};
        \node (p6) [green_circle] at (4,-2.5) {\small \checkmark};
        \node (p7) [green_circle] at (5.5,-2.5) {\small \checkmark};
        
        \draw[->]  (t1) edge (p1.south);
        \draw (t21) -- (t2) -- (t22);
        \draw[->]  (t2) edge (p2.south);
        \draw[->]  (t3) edge (p3.south);
        \draw[->]  (t4) edge (p4.south);
        \draw[->]  (t5) edge (p5.south);
        \draw[->]  (t6) edge (p6.south);
        \draw[->]  (t7) edge (p7.south);
        
        \node at (-8.5,-1.5) {$\mathbf{E}$};
        \draw [thin, rounded corners, fill=yellow!25] (-6.65,-1.3) rectangle (-5.35,-1.7);
              \node [matrix] (e1) at (-6,-1.5) {
              \draw [fill=orange!55] circle (1mm); & \draw [fill=orange!55] circle (1mm); & \draw [fill=orange!55] circle (1mm); & \draw [fill=orange!55] circle (1mm); & \draw [fill=orange!55] circle (1mm); \\
              };
        \draw [thin, rounded corners, fill=yellow!25] (-1.15,-1.3) rectangle (0.15,-1.7);
              \node [matrix] (e3) at (-0.5,-1.5) {
              \draw [fill=orange!55] circle (1mm); & \draw [fill=orange!55] circle (1mm); & \draw [fill=orange!55] circle (1mm); & \draw [fill=orange!55] circle (1mm); & \draw [fill=orange!55] circle (1mm); \\
              };
        \draw [thin, rounded corners, fill=yellow!25] (0.35,-1.3) rectangle (1.65,-1.7);
              \node [matrix] (e4) at (1,-1.5) {
              \draw [fill=orange!55] circle (1mm); & \draw [fill=orange!55] circle (1mm); & \draw [fill=orange!55] circle (1mm); & \draw [fill=orange!55] circle (1mm); & \draw [fill=orange!55] circle (1mm); \\
              };
        \draw [thin, rounded corners, fill=yellow!25] (1.85,-1.3) rectangle (3.15,-1.7);
              \node [matrix] (e5) at (2.5,-1.5) {
              \draw [fill=orange!55] circle (1mm); & \draw [fill=orange!55] circle (1mm); & \draw [fill=orange!55] circle (1mm); & \draw [fill=orange!55] circle (1mm); & \draw [fill=orange!55] circle (1mm); \\
              };
        \draw [thin, rounded corners, fill=yellow!25] (3.35,-1.3) rectangle (4.65,-1.7);
              \node [matrix] (e6) at (4,-1.5) {
              \draw [fill=orange!55] circle (1mm); & \draw [fill=orange!55] circle (1mm); & \draw [fill=orange!55] circle (1mm); & \draw [fill=orange!55] circle (1mm); & \draw [fill=orange!55] circle (1mm); \\
              };
        \draw [thin, rounded corners, fill=yellow!25] (4.85,-1.3) rectangle (6.15,-1.7);
              \node [matrix] (e7) at (5.5,-1.5) {
              \draw [fill=orange!55] circle (1mm); & \draw [fill=orange!55] circle (1mm); & \draw [fill=orange!55] circle (1mm); & \draw [fill=orange!55] circle (1mm); & \draw [fill=orange!55] circle (1mm); \\
              };
        \draw[->]  (p1) edge (e1.south);
        \draw[->]  (p3) edge (e3.south);
        \draw[->]  (p4) edge (e4.south);
        \draw[->]  (p5) edge (e5.south);
        \draw[->]  (p6) edge (e6.south);
        \draw[->]  (p7) edge (e7.south);
            
        \node at (-8.5,-0.5) {\tok};
        \draw [thin, double, rounded corners] (-5.2,-0.75) rectangle (-1.8,-1.2);
        \node (ph2) at (-3.5,-1) {\tiny {\texttt{h o v e r c r a f t /w}}};
        \draw [thin, rounded corners, fill=blue!25] (-4.15,0) rectangle (-2.85,-0.4);
              \node [matrix] (e2) at (-3.5,-0.2) {
              \draw [fill=blue!55] circle (1mm); & \draw [fill=blue!55] circle (1mm); & \draw [fill=blue!55] circle (1mm); & \draw [fill=blue!55] circle (1mm); & \draw [fill=blue!55] circle (1mm); \\
              };
        \begin{pgfonlayer}{background}
              \draw[bend left, ->] (v3) edge (ph2);
        \end{pgfonlayer}
        \draw[->]  (ph2) edge (e2.south);
        
        \node at (-8.5,1.5) {\mmod{}};
        \draw [fill=gray!25, thin, double, rounded corners] (-7,2.5) rectangle (6.5,0.5);
        \draw[->]  (e1) edge (-6,0.5);
        \draw[->]  (e2) edge (-3.5,0.5);
        \draw[->]  (e3) edge (-0.5,0.5);
        \draw[->]  (e4) edge (1,0.5);
        \draw[->]  (e5) edge (2.5,0.5);
        \draw[->]  (e6) edge (4,0.5);
        \draw[->]  (e7) edge (5.5,0.5);
        
        \draw [thin, rounded corners, fill=green!25] (-6.65,3.2) rectangle (-5.35,2.8);
              \node [matrix] (o1) at (-6,3) {
              \draw [fill=green] circle (1mm); & \draw [fill=green] circle (1mm); & \draw [fill=green] circle (1mm); & \draw [fill=green] circle (1mm); & \draw [fill=green] circle (1mm); \\
              };
        \draw [thin, rounded corners, fill=green!25] (-4.15,3.2) rectangle (-2.85,2.8);
              \node [matrix] (o2) at (-3.5,3) {
              \draw [fill=green] circle (1mm); & \draw [fill=green] circle (1mm); & \draw [fill=green] circle (1mm); & \draw [fill=green] circle (1mm); & \draw [fill=green] circle (1mm); \\
              };
        \draw [thin, rounded corners, fill=green!25] (-1.15,3.2) rectangle (0.15,2.8);
              \node [matrix] (o3) at (-0.5,3) {
              \draw [fill=green] circle (1mm); & \draw [fill=green] circle (1mm); & \draw [fill=green] circle (1mm); & \draw [fill=green] circle (1mm); & \draw [fill=green] circle (1mm); \\
              };
        \draw [thin, rounded corners, fill=green!25] (0.35,3.2) rectangle (1.65,2.8);
              \node [matrix] (o4) at (1,3) {
              \draw [fill=green] circle (1mm); & \draw [fill=green] circle (1mm); & \draw [fill=green] circle (1mm); & \draw [fill=green] circle (1mm); & \draw [fill=green] circle (1mm); \\
              };
        \draw [thin, rounded corners, fill=green!25] (1.85,3.2) rectangle (3.15,2.8);
              \node [matrix] (o5) at (2.5,3) {
              \draw [fill=green] circle (1mm); & \draw [fill=green] circle (1mm); & \draw [fill=green] circle (1mm); & \draw [fill=green] circle (1mm); & \draw [fill=green] circle (1mm); \\
              };
        \draw [thin, rounded corners, fill=green!25] (3.35,3.2) rectangle (4.65,2.8);
              \node [matrix] (o6) at (4,3) {
              \draw [fill=green] circle (1mm); & \draw [fill=green] circle (1mm); & \draw [fill=green] circle (1mm); & \draw [fill=green] circle (1mm); & \draw [fill=green] circle (1mm); \\
              };
        \draw [thin, rounded corners, fill=green!25] (4.85,3.2) rectangle (6.15,2.8);
              \node [matrix] (o7) at (5.5,3) {
              \draw [fill=green] circle (1mm); & \draw [fill=green] circle (1mm); & \draw [fill=green] circle (1mm); & \draw [fill=green] circle (1mm); & \draw [fill=green] circle (1mm); \\
              };
        \draw[->] (-6,2.5) -> (o1);
        \draw[->] (-3.5,2.5) -> (o2);
        \draw[->] (-0.5,2.5) -> (o3);
        \draw[->] (1,2.5) -> (o4);
        \draw[->] (2.5,2.5) -> (o5);
        \draw[->] (4,2.5) -> (o6);
        \draw[->] (5.5,2.5) -> (o7);
              
        \node at (-8.5,4) {$\pi^g$};
        \node [red_circle] (g3) at (-0.5,4) {\small $\times$};
        \node [green_circle] (g5) at (2.5,4) {\small \checkmark};
        \node [red_circle] (g6) at (4,4) {\small $\times$};
        \draw[->]  (o5) edge (g5.south);
        
        \node at (-8.5,5) {\textsc{\gen{}}};
        \draw [rounded corners, fill=yellow!25]  (1.5,5.25) node (v4) {} rectangle (3.5,4.75);
        \node (gn3) at (1.68,5.4) {\tiny {\texttt{of}}};
        \node (gn5) at (2.5,4.85) {};
        \draw [fill=orange] (1.6,5.16) rectangle (1.75,4.80);
        \draw [fill=orange!40] (1.8,4.96) rectangle (1.95,4.80);
        \draw [fill=orange!40] (2.0,4.80) rectangle (2.15,4.80);
        \draw [fill=orange!40] (2.2,4.90) rectangle (2.35,4.80);
        \draw [fill=orange!40] (2.4,5.05) rectangle (2.55,4.80);
        \draw [fill=orange!40] (2.6,5.00) rectangle (2.75,4.80);
        \draw [fill=orange!40] (2.8,4.85) rectangle (2.95,4.80);
        \draw [fill=orange!40] (3.0,4.83) rectangle (3.15,4.80);
        \draw [fill=orange!40] (3.2,4.86) rectangle (3.35,4.80);
        \draw[->] (g5) edge (gn5.south);
        
        \node at (-8.5,6) {\textsc{\detok{}}};
        \node (gn3) at (-0.5,6) {\tiny {\texttt{i~~s~~/w}}};
        \draw[->,>=to] (-0.95,5.8) to [bend right] (-0.6,5.8);
        \draw[->,>=to] (-0.5,5.8) to [bend right] (-0.15,5.8);
        \node (gn6) at (4,6) {\tiny {\texttt{e~~e~~l~~s~~/w}}};
        \draw[->,>=to] (3.15,5.8) to [bend right] (3.5,5.8);
        \draw[->,>=to] (3.55,5.8) to [bend right] (3.9,5.8);
        \draw[->,>=to] (4,5.8) to [bend right] (4.35,5.8);
        \draw[->,>=to] (4.4,5.8) to [bend right] (4.8,5.8);
        \draw[bend left, ->] (o3) edge (gn3.south west);
        \begin{pgfonlayer}{background}
              \draw[bend left, ->] (o6) edge (gn6.south west);
        \end{pgfonlayer}
    
    \end{tikzpicture}
    
    \caption{\tokdetok{} integration into a masked language model. $\pi^t$ is set to send all multi-\wpc{} words into \tok{}; $\pi^g$ is set to generate every third word using \detok{}. {\texttt{/w}} is a reserved end-of-word character.}
    \label{fig:algo}
\end{figure*}


