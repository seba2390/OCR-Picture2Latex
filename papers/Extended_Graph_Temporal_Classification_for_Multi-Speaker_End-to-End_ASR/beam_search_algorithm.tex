\begin{algorithm}[t]
    \caption{The modified time-synchronous prefix beam search for extended GTC. We use $A_{\text{prev}}$ to store every prefix $l$ at every time step. We denote the alphabet by $\mathcal{U}$ and number of speakers by ${S}$. We denote the symbol posterior by $p(\cdot)$ and the speaker transition posterior by $p^\omega(\cdot)$.}
    \label{alg:beamsearch}
    \begin{algorithmic}[1]
        \State $\ell \leftarrow \left(\left(\left\langle sos \right\rangle,0 \right),\right)$
        \State $p_b(\ell) \leftarrow 1$, $p_{nb}(\ell) \leftarrow 0$
        \State $A_{\text{prev}} \leftarrow \{\ell\}$
        \For{t=1,\dots,T}
            \State $A_{\text{next}} \leftarrow \{\}$
            \For{$\ell$ \textbf{in} $A_\text{prev}$}
              \For{$c$ \textbf{in} $\mathcal{U}$}
                  \If{$c = \text{blank}$}
                      \State{
                          $\begin{aligned}
                          p_b(\ell) &\leftarrow p(\text{blank}; x_t) p^\omega(\text{blank}; x_t) ( p_b(\ell; x_{1:t-1}) +  \\ 
                          &\hspace{3.95cm}p_{nb}(\ell; x_{1:t-1}) )
                          \end{aligned}$
                      }
                      \State add $\ell$ to $A_\text{next}$
                  \Else
                      \For{$s = 1, \dots, S$} \Comment{Loop over speaker index}
                          \State $\ell^{+} \leftarrow \text{ append } \left(c, s\right) \text{ to } \ell $
                          \If{$\left(c,s\right) = \ell_\text{end}$}
                              \State $p_{nb}(\ell^{+}; x_{1:t}) \leftarrow p(c; x_t) p_b(\ell;x_{1:t-1}) p^{\omega}(s; x_t)$
                              \State $p_{nb}(\ell; x_{1:t}) \leftarrow p(c; x_t) p_{nb}(\ell;x_{1:t-1}) p^{\omega}(s; x_t)$
                          \Else
                              \State{
                              $\begin{aligned}
                              p_{nb}(\ell^+; x_{1:t}) &\leftarrow  p(c; x_t)  (p_b(\ell; x_{1:t-1}) +  \\ 
                              &\hspace{.8cm}  p_{nb}(\ell; x_{1:t-1})) p^{\omega}(s; x_t) 
                              \end{aligned}$
                              }
                          \EndIf
                          \If{$\ell^+ \text{\bf{not in}} A_{\text{prev}}$}
                              \State{
                              $\begin{aligned}
                                  p_{b}(\ell^+; x_{1:t}) &\leftarrow  p(\text{blank}; x_t)  (p_b(\ell^+; x_{1:t-1}) + \\ 
                              &\hspace{.5cm}p_{nb}(\ell^+; x_{1:t-1})) p^{\omega}(\text{blank}; x_t)
                              \end{aligned}$
                              }
                              \State{
                              $\begin{aligned}
                              p_{nb}(\ell^+; x_{1:t}) \leftarrow p(c; x_t) & p_{nb}(\ell^+; x_{1:t-1}) \cdot \\
                              &\hspace{1.5cm} p^{\omega}(s; x_t)
                              \end{aligned}$
                              }
                              
                            
                          \EndIf
                          \State add $\ell^+$ to $A_{\text{next}}$
                      \EndFor
                  \EndIf
              \EndFor
            \EndFor
            \State $A_{\text{prev}} \leftarrow k \text{ most probable prefixes in } A_{\text{next}}$ \Comment{Track the LM scores of different speakers separately.}
        \EndFor
    \end{algorithmic}
    \vspace{-1pt}
\end{algorithm}