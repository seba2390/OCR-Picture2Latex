\numberwithin{equation}{section}
\numberwithin{algorithm}{section}
\numberwithin{figure}{section}

\newpage\onecolumn
\appendix
\section{Iterative Diffusion EM algorithm}

Algorithm~\ref{alg:diffEM} summarizes the Diffusion EM algorithm described in sections 3.1 and 3.2.
\begin{algorithm}
    \caption{Diffusion EM algorithm}
    %\caption{EM DPS / $\Pi$GDM}
    \label{alg:diffEM}
    \begin{algorithmic}
        \Require $y, \sigma, H_0, L$,
        \Ensure $H \approx \arg\min_{H} p(y|H)$ and %\\ $n$ samples 
        $x_0^i \sim p(x_0|y,H)$

        \For{$l=1$ \textbf{to} $L$}
            \State $\boldsymbol{x} = \textit{E-step}(y, H_{l-1}, \sigma)$ 
            \Comment{$n$ samples from Alg.~1}
            \State $\color{blue}{H_{l} = \textit{M-step}(y, \boldsymbol{x}, \sigma)}$ \Comment{Iterate~(24)~and~(25)}
        \EndFor
        \State \Return $\boldsymbol{x}$, $H_L$
    \end{algorithmic}
\end{algorithm}


\section{M-step computations}\label{sec:Mstep}

\newcommand{\fourier}[1]{{\mathcal{F}(#1)}}

In this section, we derive the computation of the M-step. In particular, we solve Equation~(22) from the main paper:
\begin{align}
Z^* = \arg\min_{Z\in \mathcal{C}} \frac{1}{2\sigma^2 n}\sum_{i=1}^n{\|Z x^i -y\|_2^2} + \frac{\beta}{2}\|Z-H\|_2^2.
\end{align}
with $\mathcal{C}$ the space of convolution operators. 
\newline
In order to account for the fact that $H \in \mathcal{C}$ and $Z_t \in \mathcal{C}$ are convolution operators, we rewrite the same equation in the Fourier domain, where the operators $H$ and $Z$ become diagonal:
\begin{equation}
\fourier{H} = \operatorname{diag}(h(1),\dots,h(d)),
\end{equation}
%
\begin{equation}
\fourier{Z} = \operatorname{diag}(z(1),\dots,z(d)).
\end{equation}
%
Re-writing the minimization in the Fourier domain leads to:
\begin{align}
\label{eq:Mstep_appendix_1}
\fourier{Z^*} & = \arg\min_{Z\in\mathcal{C}} \frac{1}{2\sigma^2 n}\sum_{i=1}^n{\|\fourier{Z} \fourier{x^i} -\fourier{y}\|_2^2} + \frac{\beta}{2}\|\fourier{Z}-\fourier{H}\|_2^2 \\
& = \arg\min_{z} \frac{1}{2\sigma^2 n}\sum_{i=1}^n{\sum_{j=1}^d{|z(j) \fourier{x^i}(j) - \fourier{y}(j)|^2}} + \frac{\beta}{2}\sum_{j=1}^d{|z(j) - h(j)|^2}.
\end{align}
It is straightforward that the solution to the problem is also diagonal, thus we have:
\begin{equation}
\fourier{Z^*} = \operatorname{diag}(z^*(1),\dots,z^*(d)).
\end{equation}
Using the first-order condition and the diagonal structure of the problem, we get the following:
\begin{align}
& \frac{1}{\sigma^2 n}\sum_{i=1}^n{\left[z^*(j) \fourier{x^i}(j) -\fourier{y}(j)\right]\overline{\fourier{x^i}(j)}} + \beta (z^*(j) - k(j)) = 0 \\
\Leftrightarrow & z^*(j) \left(\frac{1}{n}\sum_{i=1}^n{|\fourier{x^i}(j)|^2} + \sigma^2 \beta\right) = \fourier{y}(j)\frac{1}{n}\sum_{i=1}^n{\overline{\fourier{x^i}(j)}} + \sigma^2 \beta k(j) \\
\Leftrightarrow & z^*(j) = \frac{\fourier{y}(j)\frac{1}{n}\sum_{i=1}^n{\overline{\fourier{x^i}(j)}} + \sigma^2 \beta k(j)}{\frac{1}{n}\sum_{i=1}^n{|\fourier{x^i}(j)|^2} + \sigma^2 \beta}.
\end{align}

\section{M-step computations with DPS approximation}\label{sec:Mstep-dps}

In this section, we develop the computation of the M-step in Fast EM for DPS. We start from Equation~(32) of the main paper:
\begin{align}\label{eq:proxQ-dps}
    \widehat{Q}(Z, Z_t) = \frac{-1}{2\sigma^2 n}\sum_{i=1}^n{\|Z\widehat{x}_0^i(t)-y\|_2^2]}.
\end{align}
Our goal is to compute:
\begin{align}
    Z^* = arg\min_{Z\in \mathcal{C}} -\widehat{Q}(Z, Z_t) + (\beta/2)\|Z-H\|_2^2.
\end{align}
We can notice that it is similar to Equation~\eqref{eq:Mstep_appendix_1} with $\widehat{x}_0^i(t)$ instead of $x^i$. Thus we have that:
\begin{equation}
    z^*(j) = \frac{\fourier{y}(j)\frac{1}{n}\sum_{i=1}^n{\overline{\mathcal{F}(\widehat{x}_0^i(t))(j)}} + \sigma^2 \beta h(j)}{\frac{1}{n}\sum_{i=1}^n{|\mathcal{F}(\widehat{x}_0^i(t))(j)|^2} + \sigma^2 \beta}.
\end{equation}


\section{M-step computations with $\Pi$GDM approximations}\label{sec:Mstep-pigdm}
%
In this section, we develop the computation of the M-step in Fast EM for $\Pi$GDM. We start from Equation~(33) of the main paper:
\begin{align}\label{eq:proxQ}
    \widehat{Q}(H, H_t) = \frac{-1}{2\sigma^2 n}\sum_{i=1}^n{ E_{x \sim \mathcal{N}( \widehat{x}_0^i(t), r_t^2)}[\|Hx-y\|_2^2]}.
\end{align}
Our goal is to compute:
\begin{align}
    Z^* = \arg\min_{Z \in \mathcal{C}} -\widehat{Q}(Z, Z_t) + (\beta/2)\|Z-H\|_2^2.
\end{align}
Similarly to Section~\ref{sec:Mstep}, we work with diagonal operators so we have:
\begin{equation}
\fourier{H} = \operatorname{diag}(h(1),\dots,h(d))
\end{equation}
%
\begin{equation}
\fourier{Z} = \operatorname{diag}(z(1),\dots,z(d)).
\end{equation}
and thus: 
\begin{equation}
\fourier{Z^*} = \operatorname{diag}(z^*(1),\dots,z^*(d)).
\end{equation}
We start by rewriting Equation~\ref{eq:proxQ} in the Fourier domain using the fact that the Fourier transform preserves norms:
\begin{align}
    \fourier{Z^*} = \arg\min_z  \frac{1}{2\sigma^2 n}\sum_{i=1}^n{\sum_{j=1}^d{ E_{x \sim \mathcal{N}(\widehat{x}_0^i(t), r_t^2)}[|z(j)\fourier{x}(j)-\fourier{y}(j)|^2]}} + (\beta/2)\sum_{j=1}^d{|z(j)-h(j)|^2}.
\end{align}
We solve this problem using the first-order condition element by element since the problem is diagonal, the derivation inside the expectancy can be done using Fisher identity \cite[Proposition D.4]{Douc2014}:
\begin{align}
     & \frac{1}{\sigma^2 n}\sum_{i=1}^n{ E_{x \sim \mathcal{N}( \widehat{x}_0^i(t), r_t^2)}[|z(j)\fourier{x}(j)-\fourier{y}(j)|\overline{\fourier{x}(j)}]} + \beta(z(j)-h(j)) = 0 \\
     \Leftrightarrow & z(j)\left[ \frac{1}{n}\sum_{i=1}^n{E_{x \sim \mathcal{N}( \widehat{x}_0^i(t), r_t^2)}[|\fourier{x}(j)|^2]} + \sigma^2\beta \right] = \fourier{y}(j) \frac{1}{n}\sum_{i=1}^n{E_{x \sim \mathcal{N}( \widehat{x}_0^i(t), r_t^2)}[\overline{\fourier{x}(j)}]} + \sigma^2\beta h(j)
\end{align}
%
Using the fact that the Fourier transform of a white Gaussian noise of variance $\sigma^2$ is a white Gaussian noise of variance $\sigma^2$, the expected values yield:
$$ E_{x \sim \mathcal{N}(\widehat{x}_0, r_t^2)}[|\fourier{x}(j)|^2] = r_t^2 + |\mathcal{F}(\widehat{x}_0)(j)|^2 $$
$$ E_{x \sim \mathcal{N}(\widehat{x}_0, r_t^2)}[\overline{\fourier{x}(j)}] =  \overline{\mathcal{F}(\widehat{x}_0)(j)} $$
So we can conclude that:
\begin{equation}\label{eq:proxQbis}
z^*(j) = \frac{\fourier{y}(j)\frac{1}{n}\sum_{i=1}^n{\overline{\mathcal{F}(\widehat{x}_0^i(t))(j)}} + \sigma^2 \beta h(j)}{\frac{1}{n}\sum_{i=1}^n{|\mathcal{F}(\widehat{x}_0^i(t))(j)|^2}  + r_t^2 + \sigma^2 \beta }
\end{equation}
The main difference with DPS approximation is that we have an extra term in the denominator $r_t^2$.

\section{Additional results}\label{sec:additional_results}

See Figure~\ref{fig:add_res_1}.

\setlength{\tabcolsep}{0.1 pt}
\begin{figure*}[t]
\centering
\resizebox{0.95\columnwidth}{!}{%
\begin{tabular}{c|cccccc|c}
     LR & Anger $\ell_0$ & Self-Deblur & MPRNet & BlindDPS & Ours + DPS & Ours + $\Pi$GDM & HR\\
    \includegraphics[width=0.125\linewidth]{images/appendix/lr_200.png} &
    \includegraphics[width=0.125\linewidth]{images/appendix/anger_l0_200.png} &
    \includegraphics[width=0.125\linewidth]{images/appendix/self_deblur_200.png} &
    \includegraphics[width=0.125\linewidth]{images/appendix/MPRNet_200.png} &
    \includegraphics[width=0.125\linewidth]{images/appendix/blind_dps_200.png} &
    \includegraphics[width=0.125\linewidth]{images/appendix/fastem_dps_200.png} &
    \includegraphics[width=0.125\linewidth]{images/appendix/fastem_pigdm_200.png} &
    \includegraphics[width=0.125\linewidth]{images/appendix/ref_200.png} \\
    \includegraphics[width=0.125\linewidth]{images/appendix/lr_201.png} &
    \includegraphics[width=0.125\linewidth]{images/appendix/anger_l0_201.png} &
    \includegraphics[width=0.125\linewidth]{images/appendix/self_deblur_201.png} &
    \includegraphics[width=0.125\linewidth]{images/appendix/MPRNet_201.png} &
    \includegraphics[width=0.125\linewidth]{images/appendix/blind_dps_201.png} &
    \includegraphics[width=0.125\linewidth]{images/appendix/fastem_dps_201.png} &
    \includegraphics[width=0.125\linewidth]{images/appendix/fastem_pigdm_201.png} &
    \includegraphics[width=0.125\linewidth]{images/appendix/ref_201.png} \\
    \includegraphics[width=0.125\linewidth]{images/appendix/lr_202.png} &
    \includegraphics[width=0.125\linewidth]{images/appendix/anger_l0_202.png} &
    \includegraphics[width=0.125\linewidth]{images/appendix/self_deblur_202.png} &
    \includegraphics[width=0.125\linewidth]{images/appendix/MPRNet_202.png} &
    \includegraphics[width=0.125\linewidth]{images/appendix/blind_dps_202.png} &
    \includegraphics[width=0.125\linewidth]{images/appendix/fastem_dps_202.png} &
    \includegraphics[width=0.125\linewidth]{images/appendix/fastem_pigdm_202.png} &
    \includegraphics[width=0.125\linewidth]{images/appendix/ref_202.png} \\
        \includegraphics[width=0.125\linewidth]{images/appendix/lr_203.png} &
    \includegraphics[width=0.125\linewidth]{images/appendix/anger_l0_203.png} &
    \includegraphics[width=0.125\linewidth]{images/appendix/self_deblur_203.png} &
    \includegraphics[width=0.125\linewidth]{images/appendix/MPRNet_203.png} &
    \includegraphics[width=0.125\linewidth]{images/appendix/blind_dps_203.png} &
    \includegraphics[width=0.125\linewidth]{images/appendix/fastem_dps_203.png} &
    \includegraphics[width=0.125\linewidth]{images/appendix/fastem_pigdm_203.png} &
    \includegraphics[width=0.125\linewidth]{images/appendix/ref_203.png} \\
        \includegraphics[width=0.125\linewidth]{images/appendix/lr_204.png} &
    \includegraphics[width=0.125\linewidth]{images/appendix/anger_l0_204.png} &
    \includegraphics[width=0.125\linewidth]{images/appendix/self_deblur_204.png} &
    \includegraphics[width=0.125\linewidth]{images/appendix/MPRNet_204.png} &
    \includegraphics[width=0.125\linewidth]{images/appendix/blind_dps_204.png} &
    \includegraphics[width=0.125\linewidth]{images/appendix/fastem_dps_204.png} &
    \includegraphics[width=0.125\linewidth]{images/appendix/fastem_pigdm_204.png} &
    \includegraphics[width=0.125\linewidth]{images/appendix/ref_204.png} \\
        \includegraphics[width=0.125\linewidth]{images/appendix/lr_205.png} &
    \includegraphics[width=0.125\linewidth]{images/appendix/anger_l0_205.png} &
    \includegraphics[width=0.125\linewidth]{images/appendix/self_deblur_205.png} &
    \includegraphics[width=0.125\linewidth]{images/appendix/MPRNet_205.png} &
    \includegraphics[width=0.125\linewidth]{images/appendix/blind_dps_205.png} &
    \includegraphics[width=0.125\linewidth]{images/appendix/fastem_dps_205.png} &
    \includegraphics[width=0.125\linewidth]{images/appendix/fastem_pigdm_205.png} &
    \includegraphics[width=0.125\linewidth]{images/appendix/ref_205.png} \\
        \includegraphics[width=0.125\linewidth]{images/appendix/lr_206.png} &
    \includegraphics[width=0.125\linewidth]{images/appendix/anger_l0_206.png} &
    \includegraphics[width=0.125\linewidth]{images/appendix/self_deblur_206.png} &
    \includegraphics[width=0.125\linewidth]{images/appendix/MPRNet_206.png} &
    \includegraphics[width=0.125\linewidth]{images/appendix/blind_dps_206.png} &
    \includegraphics[width=0.125\linewidth]{images/appendix/fastem_dps_206.png} &
    \includegraphics[width=0.125\linewidth]{images/appendix/fastem_pigdm_206.png} &
    \includegraphics[width=0.125\linewidth]{images/appendix/ref_206.png} \\
        \includegraphics[width=0.125\linewidth]{images/appendix/lr_207.png} &
    \includegraphics[width=0.125\linewidth]{images/appendix/anger_l0_207.png} &
    \includegraphics[width=0.125\linewidth]{images/appendix/self_deblur_207.png} &
    \includegraphics[width=0.125\linewidth]{images/appendix/MPRNet_207.png} &
    \includegraphics[width=0.125\linewidth]{images/appendix/blind_dps_207.png} &
    \includegraphics[width=0.125\linewidth]{images/appendix/fastem_dps_207.png} &
    \includegraphics[width=0.125\linewidth]{images/appendix/fastem_pigdm_207.png} &
    \includegraphics[width=0.125\linewidth]{images/appendix/ref_207.png} \\
        \includegraphics[width=0.125\linewidth]{images/appendix/lr_208.png} &
    \includegraphics[width=0.125\linewidth]{images/appendix/anger_l0_208.png} &
    \includegraphics[width=0.125\linewidth]{images/appendix/self_deblur_208.png} &
    \includegraphics[width=0.125\linewidth]{images/appendix/MPRNet_208.png} &
    \includegraphics[width=0.125\linewidth]{images/appendix/blind_dps_208.png} &
    \includegraphics[width=0.125\linewidth]{images/appendix/fastem_dps_208.png} &
    \includegraphics[width=0.125\linewidth]{images/appendix/fastem_pigdm_208.png} &
    \includegraphics[width=0.125\linewidth]{images/appendix/ref_208.png} \\
        \includegraphics[width=0.125\linewidth]{images/appendix/lr_209.png} &
    \includegraphics[width=0.125\linewidth]{images/appendix/anger_l0_209.png} &
    \includegraphics[width=0.125\linewidth]{images/appendix/self_deblur_209.png} &
    \includegraphics[width=0.125\linewidth]{images/appendix/MPRNet_209.png} &
    \includegraphics[width=0.125\linewidth]{images/appendix/blind_dps_209.png} &
    \includegraphics[width=0.125\linewidth]{images/appendix/fastem_dps_209.png} &
    \includegraphics[width=0.125\linewidth]{images/appendix/fastem_pigdm_209.png} &
    \includegraphics[width=0.125\linewidth]{images/appendix/ref_209.png} \\
\end{tabular}%
}
\caption{Visual comparison of the different models on a degraded version of FFHQ 256x256 dataset. Ours correspond to Fast EM.}
\vspace{-10pt}
\label{fig:add_res_1}
\end{figure*}
