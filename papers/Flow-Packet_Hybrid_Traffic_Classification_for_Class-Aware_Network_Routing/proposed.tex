
\section{Flow-Packet Hybrid Traffic Classification}
\label{sec:proposed}

We propose FPHTC for a router that needs to conduct class-aware traffic processing. In this section, we provide a detailed description of our scheme. A diagram illustrating the overall framework of FPHTC is given in Fig.~\ref{fig:scheme}.


\subsection{Core Components of FPHTC}
\subsubsection{Router}
The router accepts an incoming stream of packets and processes them according to their service classes using the routing policy. The basic structure and function of such a routing policy are well-defined in prior works on packet classification \cite{Gupta99, Gupta01}. Throughout our work, we focus on how to generate routing
policy rules by training a machine learning model for packet-based traffic classification, where the chosen header fields of each packet are its features, i.e., the inputs into the learning model, and the packet is classified by the learning model to determine its CoS. For example, the chosen header fields may be the source IP address, destination IP address, source port number, and destination port number, among others, and the possible actions may be to route a packet as delay sensitive, delay moderate, or delay tolerant.

\subsubsection{Flow-based Traffic Classifier}
The flow-based traffic classifier resides outside the router, in some powerful equipment that can handle the heavy computation required by sophisticated machine learning techniques. It is a complex and highly accurate machine learning model that can classify a traffic flow in terms of CoS for all of its packets. It is trained using a number of bidirectional TCP flows with a set of flow-level statistical features extracted from the raw dataset.

Various methods are possible to generate the training dataset for the flow-based traffic classifier. In this work, since we are ultimately interested in online classification to handle changing traffic pattern over time, we propose to use a continuously updated recording of the past traffic. Specifically, we use a traffic mirror and a traffic selector, as shown in Fig.~\ref{fig:scheme}, to separate a selected small portion of the incoming traffic flows. The selected flows are then labeled using a Deep Packet Inspection (DPI) module according to their CoS. The true CoS labels obtained by DPI are used to train the flow-based classifier. We note that DPI cannot be used to replace the role of the flow-based classifier for all flows, due to its prohibitive cost and delay for common encrypted traffic. 

The role of the flow-based traffic classifier designer includes data preprocessing, hyperparameter selection, and finally, training the flow-based classifier. Once the flow-based classifier is trained, we use it to infer the CoS labels of all incoming flows captured by the traffic mirror. Then all packets belonging to a flow can be tagged by CoS label of the flow. We note that the CoS labels generated in this way, by a flow-based classifier, are too late to be used in the \textit{routing} of the labeled packets. However, what this achieves is to create a packet-level dataset for \textit{training} the packet-based routing policy as explained below.

\subsubsection{Packet-based Routing Policy Designer}

The packet-based routing policy designer takes labeled packets from the flow-based classifier as input, and it outputs a routing policy for the router. Specifically,  the routing policy designer trains a packet-based classifier using the labeled packets as the training dataset. 

In this work, we use the binary decision tree learning model for the packet-based classifier. In the decision tree, each path from the root to a node is a routing policy rule. Thus, to obtain routing policy rules that can be used in the router, the routing policy designer only needs to train a decision tree on the packet-level dataset. Furthermore, we note that the number of routing policy rules equals the number of leaf nodes in the decision tree. This provides an easy way to control the size of the routing policy, i.e., the routing policy designer can limit the maximum number of leaf nodes while training the decision tree.

\subsection{Construction of Routing Policy}

The construction of the routing policy in FPHTC involves transferring learned knowledge from the flow-based classifier to the routing policy designer. In the machine learning literature, knowledge distillation \cite{Hinton15, Vapnik16} is a technique where a simple student model is trained on the predictions supplied by a highly accurate and complex teacher model. In FPHTC, we train a decision tree at the routing policy designer using the predictions from the flow-based classifier as training targets. In essence, the routing policy designer tries to approximate the performance of the flow-based classifier. 

The flow-based classifier is trained with flow-level statistical features whereas the routing policy designer uses only some features that can be read directly from the packet header. Therefore, it is clear that the learned routing policy will perform worse than the flow-based classifier given the same traffic data for training. However, since there are unlabeled training data available, i.e., those that have not been labeled by DPI, we can label those data samples using our flow-based classifier to substantially enlarge the training dataset for the routing policy designer. Since the decision tree at the routing policy designer is trained on a much larger dataset than that of the flow-based classifier, the performance of the routing policy can be close to that of the flow-based classifier. More importantly, since the routing policy created by FPHTC utilizes information learned from a more powerful flow-based classifier, it can substantially outperform a regular packet-based classifier trained using only the small amount of labels generated by DPI.


\subsection{Routing Policy Update Procedure in Online Setting}

In a practical system, the data pattern of the incoming traffic changes over time, e.g., due to new applications appearing in the network, or changing user behavior. Therefore, we design FPHTC to dynamically update the routing policy over time.

In Fig.~\ref{fig:online}, we illustrate how the modules sequentially function over a continuous stream of traffic. At any given time slot, we collect and label a small portion of the incoming traffic flows using DPI to train the flow-based classifier. Meanwhile, we continue to collect flows to be used in the training of the routing policy. Once the flow-based classifier is trained, we use it to label those collected flows not labeled by DPI. Then, the routing policy designer trains a decision tree to generate the routing policy, which is then updated to the router. 

One important question is whether we should repeat these steps and update the routing policy at each time slot. If the traffic data pattern does not change too frequently, routing policy update at every time slot would be a waste of resources. To re-train the flow-based classifier, the labeling cost using DPI would also be expensive. A cost-effective solution is to update the routing policy only when the traffic pattern has altered significantly. This can be inferred by measuring the performance deterioration at the router. A feedback signal can be generated, for example, based on the increase in packet drop or congestion, to indicate that a routing policy update is necessary. We demonstrate the adaptiveness of FPHTC in the online setting in Section \ref{sec:results}.

\begin{figure}[t]
	\centering
	\includegraphics[width=9cm]{"figures/online".pdf}
	\caption{FPHTC in online setting.}
	\label{fig:online}
\end{figure}