\section{A Domain Metamodel and Type System for Particle Methods}
\label{sec:model-and-type-system}
A crucial step to overcome the current shortcomings of PPML is to develop a metamodel that 
structurally represents the domain of particle methods.  This ``domain model'' enables compile-time reasoning by providing a
structural basis for developing PPM programs. In this section, we describe such a model for particle methods, 
% JCM: Sentence below soudns quite like a report ``that we have developed''. I changed it for ``here is what it is'' ;-)
%we first discuss excerpts of the metamodel that we have
%developed to represent particle simulations in PPME. 
resulting in a static type system.

\subsection{Domain Metamodel}
\label{sec:domain-metamodel}%
%
\begin{figure}%
\includegraphics[width=\textwidth]{img/ppme_classes.pdf}%
\caption{A metamodel to describe the domain of particle methods.}%
\label{fig:domain-model}%
\end{figure}%
%
The current PPML only supports a small fraction of the concepts that 
constitute a complete model. For instance, it provides constructs for defining computations over properties 
of particles in a domain, as well as loops for defining numerical simulations over a series of discrete time steps.
However, since these concepts are only specified partially in PPML, it is not possible to reason about the actual
computation steps. 

%\jc{Similar to tex-comment above: I would suggest suggest to change a bit the writing. Instead of ``our metamodel needs to consider'' or ``it should provide means'', write ``our metamodel considers'' and ``... provides means''. It otherwise sounds like a wish-list.}
\revii{In contrast to PPML, we propose a complete metamodel for particle 
methods that captures particles, particle data and computations over these
data. 
More precisely, it provides a means to specify particle data
structures and properties. 
It supports high-level statements that group transformations of particle data, which allow modifying data within a certain scope. 
Furthermore, the model includes mathematical expressions to describe the actual governing equations. 
Finally, our metamodel defines the set and structure of potential data types supported in PPME.}

% JC: Next as separate paragraph - (issue 13)
Figure~\ref{fig:domain-model} shows an excerpt of the model as a UML class diagram. We derived its major ingredients from our experience of developing HPC applications with PPML. A single top-level concept \inline{Module} contains a list of 
statements that describe a particle-based simulation. A statement, for instance, can be a composite \inline{Timeloop} 
or an elementary command for creating a topology. Single computation steps are described using expression statements
(\inline{ExprStmt}). Expressions are binary or unary arithmetic and logical expressions that access constants,
particle properties, and collections of particles. Furthermore, expressions can define differential operators (\inline{DiffOp}s)
evaluated over particle properties, e.g., the Laplacian. 
%
Our model also provides a simple \inline{Type} hierarchy with a set of primitive types (e.g., integers) and built-in domain-specific 
types. The domain-specific types can be atomic (e.g., \inline{Particle} or \inline{Topology}) or container types such as 
\inline{Vector} or \inline{ParticleList}. 

When considering the model in Figure~\ref{fig:domain-model}, it is evident that it only provides structural
information, since it is limited to \emph{potential} relations between objects and types, such as inheritance, 
composition, and reference. Hence, while an instance of this model (i.e., a concrete specification of a particle method) 
may be syntactically correct, it may not fulfill requirements that are not specified in the model. 
Properties that impose such additional constrains need to be formulated as supplementary rules that derive additional information 
or check consistency of a specification~\cite{buerger_reference_2011}. 
%
As an example of where additional information needs to be derived, consider the \inline{decl} reference that associates 
an access of a variable with a corresponding declaration. This is required because users would not ``draw'' the corresponding 
connection but just ``use'' the variable via its name. 
%
Another important analysis computes the types of expressions, as, for instance, represented by the \inline{derivedType} reference 
in the model, which associates an expression with a specific type. The rules that define this analysis can be captured 
conveniently using a formal type system~\cite{Plotkin1981}. 
% JCM: And again, but I leave it up to you ;-) 
%In the following, we present an according domain-specific 
%formal type system for our model, which was implemented in PPME.

\input{40-typesystem}
