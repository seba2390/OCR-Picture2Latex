%!TEX root = main.tex

\begin{algorithm}
\SetKwFunction{facq}{acquire}
\SetKwFunction{frel}{release}
\SetKwFunction{fork}{fork}
\SetKwFunction{join}{join}
\SetKwFunction{read}{read}
\SetKwFunction{wr}{write}
\SetKwFunction{init}{Initialization}

\myalg{\init}{
	\lForEach{$t$}{
	% $\Cc_t$ := $\lambda u: \mathtt{if}\; (u = t)\; \mathtt{then}\; 1\; \mathtt{else}\; 0$
	$\Cc_t$ := $\bot[1/t]$
	} 
	\lForEach{$\ell$}{
	$\Ll_\ell$ := $\bot$ % $\lambda t: 0$
	} 
	\lForEach{$x$}{
	$\Rr_x$ := $\bot$; % $\lambda t: 0$ ; 
	$\Ww_x$ := $\bot$; % $\lambda t: 0$ ; 
	$\LW_x$ := $\bot$ % $\lambda t: 0$ \\
	} 
	\lForEach{$x,t,t'$}{
	$\WALR_x^{t,t'}$ := $\nil$
	}
}

\myalg{\facq{$t$, $\ell$}}{ %
	$\Cc_t$ := $\Cc_t \mx \Ll_\ell$ ;
}

\myalg{\frel{$t$, $\ell$}}{
	$\Ll_\ell$ := $\Cc_t$ ;\\
	$\Cc_t(t)$ := $\Cc_t(t) + 1$ ; \quad \texttt{(* for next event *)}
}

\myalg{\fork{$t$, $u$}}{
	$\Cc_u$ := $\Cc_t[1/u]$ ; \\
	$\Cc_t(t)$ := $\Cc_t(t) + 1$ ; \quad \texttt{(* for next event *)}
}

\myalg{\join{$t$, $u$}}{
	$\Cc_t$ := $\Cc_t \mx \Cc_u$ ;
}

\myalg{\read{$t$, $x$}}{
	\If{$\neg (\LW_x \cle \Cc_t)$}{
    	declare `\textbf{race with last-write}'; \\
    	$\Cc_t$ := $\Cc_t \mx \LW_x$;
   	}
   	\If{$\neg (\Ww_x \cle \Cc_t)$}{
      declare `\textbf{race with write}';
   	}
   	$\Rr_x(t)$ := $\Cc_t(t)$;\\

   	\lForEach{$u \in \textsf{Threads}$}{
	$\WALR_x^{t,u}$ := $\nil$
	}
}

\myalg{\wr{$t$, $x$}}{
	% \nl \If{$\neg (\Rr_x \cle \Cc_t)$}{
 %      \nl declare `\textbf{race with read}'; \\
 %   	}
 	\For{$u \in \textsf{Threads}$}{
 		\If{$\Rr_x(u) > \Cc_t(u)$}{
    		\If{$\forall t'\cdot (\WALR_x^{u, t'} \neq \nil) \implies (\WALR_x^{u, t'} > \Cc_t(t'))$}{
				declare `\textbf{race with a previous read by thread u}'; 
      		}
      		% \Else{
      		% declare `\textbf{Cannot confirm a race with a previous read}';
      		% }
   		}
	}
   	\If{$\neg (\Ww_x \cle \Cc_t)$}{
    	declare `\textbf{race with write}'; \\
   	} 
   	$\Ww_x(t)$ := $\Cc_t(t)$;\\
   	$\LW_x$ := $\Cc_t$ ; \\
   	\For{$u \in \textsf{Threads}$}{
   		\If{$\WALR_x^{u,t} = \nil$}{
			$\WALR_x^{u,t}$ := $\Cc_t(t)$ ; \\
   		}
	}
   	$\Cc_t(t)$ := $\Cc_t(t) + 1$ ; \quad \texttt{(* for next event *)}
}

\caption{\textit{Checking the Sufficient Condition}}
\label{algo:vc_sound}
\end{algorithm}
