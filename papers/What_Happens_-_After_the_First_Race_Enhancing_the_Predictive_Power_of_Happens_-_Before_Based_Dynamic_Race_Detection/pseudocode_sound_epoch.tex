%!TEX root = main.tex
% \begin{Centering}
\SetKwProg{myalg}{procedure}{}{}

\begin{algorithm*}
\begin{multicols}{2}
\SetKwFunction{facq}{acquire}
\SetKwFunction{frel}{release}
\SetKwFunction{fork}{fork}
\SetKwFunction{join}{join}
\SetKwFunction{read}{read}
\SetKwFunction{wr}{write}
\SetKwFunction{init}{Initialization}

% \myalg{\init}{
%     \lForEach{$t$}{
%     $\Cc_t$ := $\bot[1/t]$
%     } 
%     \lForEach{$\ell$}{
%     $\Ll_\ell$ := $\bot$ % $\lambda t: 0$
%     } 
%     \For{$x \in \vars{}$}{ 
%     $\LW_x$ := $\bot$; \\ % $\lambda t: 0$ 
%     $\Rr_x$ := $0@0$; \\% $\lambda t: 0$ ; 
%     $\Ww_x$ := $0@0$;  % $\lambda t: 0$ ;
%     }
% }

\myalg{\read{$t$, $x$}}{
    \If{$\neg (\Ww_x \cle \Cc_t)$}{
      declare `\textbf{race with write}';
    }
    $\Cc_t$ := $\Cc_t \mx \LW_x$; \\
   \eIf{$\Rr_x$ is an epoch $c@u$}{
		\eIf{$c \leq \Cc_t(u)$}{
			$\Rr_x$ := $\Cc_t(t)@t$;
		}{
			$\Rr_x$ := $\bot[\Cc_t(t)/t][c/u]$;
		}
	}{
		$\Rr_x(t)$ := $\Cc_t(t)$;
	}
}

\myalg{\wr{$t$, $x$}}{
    \If{$\neg (\Rr_x \cle \Cc_t)$}{
      declare `\textbf{race with read}'; \\
    }
    % \If{$\neg (\Ww_x \cle \Cc_t)$}{
    %   declare `\textbf{race with write}'; \\
    % } 
    \eIf{$(\Ww_x \cle \Cc_t)$}{
		$\Ww_x$ := $\Cc_t(t)@t$
   	}{
   		declare `\textbf{race with write}'; \\	
   		\eIf{$\Ww_x$ is an epoch $c@u$}{
			$\Ww_x$ := $\bot[\Cc_t(t)/t][c/u]$;
   		}{
   			$\Ww_x(t)$ := $\Cc_t(t)$;
   		}

   	}
    $\LW_x$ := $\Cc_t$ ; \\
    $\Ww_x(t)$ := $\Cc_t(t)$; \\
    $\Cc_t(t)$ := $\Cc_t(t) + 1$ ; {\scriptsize \texttt{(* next event *)}}
}
\end{multicols}
\vspace*{0.25cm}
\caption{\textit{Epoch Optimization for Algorithm~\ref{algo:vc}}}
\label{algo:epoch}
\end{algorithm*}