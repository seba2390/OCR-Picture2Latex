%!TEX root = main.tex

The example in Fig.~\ref{fig:example1} shows that not every HB-race
corresponds to an actual data race in the program. The goal of this
section is to characterize those HB-races which correspond to actual
data races. We do this by introducing a new partial order, called
schedulable happens-before, and using it to identify the actual data
races amongst the HB-races of a trace. We begin by characterizing the
HB-races that correspond to actual data races.
%
\begin{definition}[$\hb{\tr}$-schedulable race]
\label{def:hb-sched-race}
Let $\tr$ be a trace and let $e \trord{\tr} e'$ be conflicting events in $\tr$.
We say that $(e,e')$ is a $\hb{\tr}$-schedulable race if there is a correct
reordering $\tr'$ of $\tr$ that respects $\hb{\tr}$ and $\tr' = \tr''
ee'$ or $\tr' = \tr'' e'e$ for some trace $\tr''$. 
%
% We should keep this definition more general than needed.
% \ucomment{Only $\tr''ee'$}
\end{definition}

Note that any $\hb{\tr}$-schedulable race is a valid data race in
$\tr$. Our aim is to characterize $\hb{\tr}$-schedulable races by means
of a new partial order. 
The new partial order, given below, is a strengthening of $\hb{}$.
%
\begin{definition}[Schedulable Happens-Before]
\label{def:shb}
Let $\tr$ be a trace. Schedulable happens-before, denoted by
$\shb{\tr}$, is the smallest partial order on $\events{\tr}$ such that
\begin{enumerate}[label=({\alph*})]
\item $\hb{\tr} \subseteq \shb{\tr}$
\item $\forall e,e' \in \events{\tr}, e' \in \reads{\tr} \land 
  e = \lw{\sigma}(e') \implies e \shb{\tr} e'$
\end{enumerate}
\end{definition}
%
The partial order $\shb{\tr}$ can be used to characterize
$\hb{\tr}$-schedulable races. We state this result, before giving
examples illustrating the definition of $\shb{\tr}$.
%
% \begin{theorem}%[SHB Soundness]
% \label{thm:SHBSoundness}
% Let $\tr$ be a trace and $(e_1, e_2)$ be an HB-race. 
% \begin{enumerate}
% \item\label{lbl:necessary} If there is an event $e \in \events{\tr} 
%   \setminus \{e_1, e_2\}$ such that $e_1 \shb{\tr} e \shb{\tr} e_2$
%   then $(e_1,e_2)$ is not a $\hb{\tr}$-schedulable race.
% \item\label{lbl:sufficient-write} Suppose $e_1 \in \writes{\tr}$ and 
%   there is no event $e \in \events{\tr} \setminus \{e_1, e_2\}$ such
%   that $e_1 \shb{\tr} e \shb{\tr} e_2$. Then $(e_1,e_2)$ is a
%   $\hb{\tr}$-schedulable race.
% \item\label{lbl:sufficient-read} Let $e_1 \in \reads{\tr}(x)$, for some 
%   variable $x$, such that there is no event
%   $e \in \writes{\tr}(x) \setminus \{e_2\}$ such that $e_1 \trord{\tr}
%   e \shb{\tr} e_2$. Further, suppose that there is no event
%   $e \in \events{\tr} \setminus \{e_1, e_2\}$ such that $e_1 \shb{\tr}
%   e \shb{\tr} e_2$.  Then $(e_1,e_2)$ is a $\hb{\tr}$-schedulable
%   race.
% \end{enumerate}
% \end{theorem} 
% \begin{proof}(Sketch)
% The full proof is presented in Appendix~\ref{app:shb-proof}; here we
% sketch the main ideas. Part~(\ref{lbl:necessary}) follows from the
% observation that any correct reordering of $\tr'$ of $\tr$ that also
% respects $\hb{\tr}$, also respects $\shb{\tr}$. That is, for any
% $e,e'$ such that $e \shb{\tr} e'$ and $e' \in \events{\tr'}$, we have
% $e \in \events{\tr'}$ and $e \trord{\tr'}
% e'$. Parts~(\ref{lbl:sufficient-write})
% and~(\ref{lbl:sufficient-read}) are established as follows. Let
% $\tr''$ be the trace consisting of events that are $\shb{\tr}$-below
% $e_1$ or $e_2$, ordered as in $\tr$. Define $\tr' = \tr''e_2e_1$, when
% $e_2 \in \reads{\tr}$ and $e_1 \neq \lw{\tr}(e_2)$, and $\tr'
% = \tr''e_1e_2$, otherwise. We prove that when the conditions in
% parts~(\ref{lbl:sufficient-write}) and~(\ref{lbl:sufficient-read})
% hold, $\tr'$ as defined here, is a correct reordering.
% \end{proof}
\begin{theorem}%[SHB Soundness]
\label{thm:SHBSoundness}
Let $\tr$ be a trace and $e_1 \trord{\tr} e_2$ be conflicting events in $\tr$.
$(e_1, e_2)$ is an $\hb{\tr}$-schedulable race iff 
either $\ltho{\tr}(e_2)$ is undefined, or $e_1 \not\leq^\tr_{\mathsf{SHB}} \ltho{\tr}(e_2)$.
  % $\neg (e_1 \shb{\tr} \ltho{\tr}(e_2))$.
% there is no event $e \in \events{\tr} \setminus \{e_1, e_2\}$ such
%   that $e_1 \shb{\tr} e \shb{\tr} e_2$.
\end{theorem}

\begin{proof}(Sketch)
The full proof is presented in Appendix~\ref{app:shb-proof}; here we
sketch the main ideas.  We observe that if $\tr'$ is a correct
reordering of $\tr$ that also respects $\hb{\tr}$, then $\tr'$ also
respects $\shb{\tr}$ except possibly for the last events of every
thread in $\tr'$. That is, for any $e,e'$ such that $e \shb{\tr} e'$,
$e' \in \events{\tr'}$, and $e'$ is not the last event of some thread
in $\tr'$, we have $e \in \events{\tr'}$ and $e \trord{\tr'}
e'$. Therefore, if $e \shb{\tr} \ltho{\tr}(e_2)$, then any correct
reordering $\tr'$ respecting $\hb{\tr}$ that contains both $e_1$ and
$e_2$ will also have $e = \ltho{\tr}(e_2)$. Further since $e$ is not
the last event of its thread (since $e_2$ is present in $\tr'$) and
$e_1 \shb{\tr} e$, $e$ must occur between $e_1$ and $e_2$ in
$\tr'$. Therefore $(e_1,e_2)$ is not a $\hb{\tr}$-schedulable race.
The other direction can be established as follows. Let $\tr''$ be the
trace consisting of events that are $\shb{\tr}$-before $e_1$ or
$\ltho{\tr}(e_2)$ (if defined), ordered as in $\tr$. Define
$\tr'= \tr''e_1e_2$.  We prove that when $e_1$ and $e_2$ satisfy the
condition in the theorem, $\tr'$ as defined here, is a correct
reordering and also respects $\hb{\tr}$.
\end{proof}

\input{ntrace3}

We now illustrate the use of $\shb{}$ through some examples.
%
\begin{example}
In this example, we will look at different traces, and see how
$\shb{}$ reasons. Like in the introduction, we will use $e_i$ to refer
to the $i$th event of a given trace (which will be clear from
context). Let us begin by considering the example program and trace
$\tr_1$ from Fig.~\ref{fig:example1}. Notice that $\hb{\tr_1}
= \tho{\tr_1}$, and so $(e_1,e_4)$ and $(e_2,e_3)$ are
HB-races. Because $e_2 = \lw{\tr_1}(e_3)$, we have $e_1 \shb{\tr_1}
e_2 \shb{\tr_1} e_3 \shb{\tr_1} e_4$. Using
Theorem~\ref{thm:SHBSoundness}, we can conclude correctly that (a)
$(e_2,e_3)$ is $\hb{\tr_1}$-schedulable as $\ltho{\tr_1}(e_3)$ is
undefined, but (b) $(e_1,e_4)$ is not, as
$e_1 \shb{\tr} \ltho{\tr}(e_4) = e_3$.

Let us now consider trace $\tr_2$ from
Fig.~\ref{fig:example2}. Observe that $\hb{\tr_2} = \shb{\tr_2}
= \tho{\tr_2}$, and so both $(e_1,e_4)$ and $(e_2,e_3)$ are
$\hb{\tr_2}$-schedulable races by Theorem~\ref{thm:SHBSoundness}. Note
that, unlike force ordering, $\shb{\tr_2}$ correctly identifies all
real data races.

Finally, let us consider two trace examples that highlight the kind of
subtle reasoning $\shb{}$ is capable of. Let us begin with $\tr_3$
from Fig.~\ref{fig:example3}. As observed in Example~\ref{ex:hb-race},
the only HB-races in this trace are $(e_2,e_7)$, $(e_5,e_7)$,
$(e_2,e_9)$, $(e_5,e_9)$, $(e_2,e_{10})$, $(e_5,e_{10})$,
$(e_2,e_{12})$, and $(e_5,e_{12})$. Both $(e_2,e_7)$ and $(e_5,e_7)$
are $\hb{\tr_3}$-schedulable as demonstrated by the reorderings
$\rho_1$ and $\rho_3$ from Example~\ref{ex:reorderings}. However, the
remaining are not real data races. Let us consider the pairs
$(e_2,e_9)$ and $(e_5,e_9)$ for
example. Theorem~\ref{thm:SHBSoundness}'s justification for it is as
follows: $e_2 \hb{\tr_3} e_5 = \lw{\tr_3}(e_7) \tho{\tr_3} e_8
= \ltho{\tr_3}(e_9)$. But, let us unravel the reasoning behind why
neither $(e_2,e_9)$ nor $(e_5,e_9)$ are data races. Consider an
arbitary correct reordering $\tr'$ of $\tr_3$ that respects
$\hb{\tr_3}$ and contains $e_9$. Since $e_8$ is also an event of
$t_4$, $e_8 \in \events{\tr'}$. In addition, $e_7 \in \events{\tr'}$
as $e_7 \tho{\tr_3} e_8$. Now, since $e_5 = \lw{\tr_3}(e_7)$, $e_5$ is
before $e_7$ in $\tr'$ and since $e_2 \hb{\tr_3} e_5$, $e_2$ must also
be before $e_7$. Therefore, $e_7$ and $e_8$ will be between $e_2$ and
$e_9$ and between $e_5$ and $e_9$. Similar reasoning can be used to
conclude that the other pairs are not $\hb{\tr_3}$-schedulable as
well. 

Lastly, consider trace $\tr_4$ shown in Fig.~\ref{fig:example4}. In
this case, $\shb{\tr_4} = \trord{\tr_4}$. All conflicting memory
accesses are in HB-race.  While HB correctly identifies the first race
$(e_2, e_3)$ as valid, there are 3 HB-races that are not real data
races --- $(e_2,e_5)$, $(e_9,e_{12})$, and $(e_4,e_{11})$. $(e_2,e_5)$
is not valid because any correct reordering of $\tr_4$ must have $e_2$
before $e_3$ and $e_3$ before $e_5$. This is also captured by SHB
reasoning because $e_2 \shb{\tr_4} e_3 \tho{\tr_4} e_4
= \ltho{\tr_4}(e_5)$. A similar reasoning shows that $(e_9,e_{12})$ is
not valid. The interesting case is that of $(e_4,e_{11})$. Here, in
any correct reordering $\tr'$ of $\tr_4$, the following must be true:
(a) if $e_4 \in \events{\tr'}$ then $e_1 \in \events{\tr'}$; (b) if
$e_{11} \in \events{\tr'}$ then $e_8 \in \events{\tr'}$; (c) if
$\{e_1,e_4,e_7\} \subseteq \events{\tr'}$ then $e_1 \trord{\tr'}
e_4 \trord{\tr'} e_7$; and (d) if
$\{e_8,e_{11},e_{14}\} \subseteq \events{\tr'}$ then $e_8 \trord{\tr'}
e_{11} \trord{\tr'} e_{14}$. Therefore, any correct reordering $\tr'$
of $\tr_4$ containing both $e_4$ and $e_{11}$ contains $e_1$ and $e_8$
(because of (a) and (b)) and must contain at least one of $e_7$ or
$e_{14}$ to ensure that critical sections of $\lk$ don't overlap. Then
in $\tr'$, $e_4$ and $e_{11}$ cannot be consecutive because either
$e_7$ or $e_{14}$ will appear between them (properties (c) and
(d)). This is captured using SHB and Theorem~\ref{thm:SHBSoundness} by
the fact that $e_4 \shb{\tr_3} e_7 \shb{\tr_3} e_{10}
= \ltho{\tr_4}(e_{11})$.
\end{example}

We conclude this section by observing that the soundness guarantees of
HB (Theorem~\ref{thm:hb_sound}) follows from
Theorem~\ref{thm:SHBSoundness}. Consider a trace $\tr$ whose first
HB-race is $(e_1,e_2)$. We claim that $(e_1,e_2)$ is a
$\hb{\tr}$-schedulable race. Suppose (for contradiction) it is
not. Then by Theorem~\ref{thm:SHBSoundness}, $e = \ltho{\tr}(e_2)$ is
defined and $e_1 \shb{\tr} e$.  Now observe that we must have
$\neg(e_1 \hb{\tr} e)$ (or otherwise $e_1 \hb{\tr} e_2$, contradicting
our assumption that $(e_1, e_2)$ is an HB-race).  Then, by the
definition of $\shb{\tr}$ (Definition~\ref{def:shb}), there are two
events $e_3$ and $e_4$ (possibly same as $e_1$ and $e$) such that
$e_1 \shb{\tr} e_3$, $e_3 = \lw{\tr}(e_4)$, $e_4 \shb{\tr} e$, and
$\neg (e_3 \hb{\tr} e_4)$.  Then $(e_3,e_4)$ is an HB-race, and it
contradicts the assumption that $(e_1,e_2)$ is the first HB-race.

The above argument that Theorem~\ref{thm:hb_sound} follows from
Theorem~\ref{thm:SHBSoundness}, establishes that our SHB-based
analysis using Theorem~\ref{thm:SHBSoundness} does not miss the race
detected by a \emph{sound} HB-based race detection algorithm.

% \subsection{Discussion}
% \label{sec:shb-discussion}

% Consider an HB-race $(e_1,e_2)$ of trace $\tr$ such that
% $e_1 \in \writes{\tr}$. Conditions~\ref{lbl:necessary}
% and~\ref{lbl:sufficient-write} of Theorem~\ref{thm:SHBSoundness} are
% converses of each other. Thus, if $(e_1,e_2)$ is an HB-race with
% $e_1 \in \writes{\tr}$ then $(e_1,e_2)$ is $\hb{\tr}$-schedulable if
% and only if there is no event $e \not\in \{e_1,e_2\}$, with
% $e_1 \shb{\tr} e \shb{\tr} e_2$. If $\shb{\tr}$ can be computed
% efficiently, we can use it, together with Theorem~\ref{thm:SHBSoundness}, to
% detect all $\hb{\tr}$-schedulable races $(e_1,e_2)$, where
% $e_1 \in \writes{\tr}$.

% However, when $e_1 \in \reads{\tr}$, Theorem~\ref{thm:SHBSoundness}
% does not provide an exact characterization. Getting an exact
% characterization in this case seems difficult. In
% Appendix~\ref{app:shb-examples}, we present examples that highlight
% some of the subtle challenges in this enterprise.

% Even if one obtains an exact characterization of all read-write
% $\hb{\tr}$-schedulable races, computing this set is likely to be much
% more difficult than detecting races $(e_1,e_2)$, where
% $e_1 \in \writes{\tr}$. In Section~\ref{sec:algo} we present a vector
% clock based algorithm to compute $\shb{}$ which has the same
% characteristics as the vector clock algorithm for $\hb{}$ --- it is a
% single pass algorithm that processes every event of the trace exactly
% once, and if the trace has constantly many threads, locks, and
% variables, uses only $O(\log n)$ memory, where $n$ is the length of the
% trace (Theorem~\ref{thm:complexityVC}). On the other hand, we prove
% that any streaming algorithm detecting all $\hb{}$-schedulable
% read-write races requres at least $\Omega(n)$ memory.

% \begin{theorem}
% \label{thm:lowerbound}
% Let $\tr$ be a trace with $n$ events and constantly many threads,
% variables, and locks. Let $(e_1,e_2)$ be a HB-race with
% $e_1 \in \reads{\tr}$. Any single pass, streaming algorithm that
% determines if $(e_1,e_2)$ is a $\hb{\tr}$-schedulable race, must use
% $\Omega(n)$ space.
% \end{theorem}

% The proof of this theorem is postponed to
% Appendix~\ref{app:lowerbound}.
