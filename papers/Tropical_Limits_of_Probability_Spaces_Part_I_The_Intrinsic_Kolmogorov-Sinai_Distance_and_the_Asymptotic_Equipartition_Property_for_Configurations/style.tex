\usepackage{environ}
\usepackage{pgffor}
\newcommand{\skipthis}[2][]{\relax}
\let\comment=\skipthis





%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% apply
\def\mkmathletter#1#2{%
    \expandafter\gdef\csname#1#2\endcsname%
           {\ensuremath{\csname math#2\endcsname{#1}}}%
}
\def\mkmathletters#1{%
\mkmathletter{A}{#1}%
\mkmathletter{B}{#1}%
\mkmathletter{C}{#1}%
\mkmathletter{D}{#1}
\mkmathletter{E}{#1}
\mkmathletter{F}{#1}
\mkmathletter{G}{#1}
\mkmathletter{H}{#1}
\mkmathletter{I}{#1}
\mkmathletter{J}{#1}
\mkmathletter{K}{#1}
\mkmathletter{L}{#1}
\mkmathletter{M}{#1}
\mkmathletter{N}{#1}
\mkmathletter{O}{#1}
\mkmathletter{P}{#1}
\mkmathletter{Q}{#1}
\mkmathletter{R}{#1}
\mkmathletter{S}{#1}
\mkmathletter{T}{#1}
\mkmathletter{U}{#1}
\mkmathletter{V}{#1}
\mkmathletter{W}{#1}
\mkmathletter{X}{#1}
\mkmathletter{Y}{#1}
\mkmathletter{Z}{#1}
\mkmathletter{a}{#1}
\mkmathletter{b}{#1}
\mkmathletter{c}{#1}
\mkmathletter{d}{#1}
\mkmathletter{e}{#1}
\mkmathletter{f}{#1}
\mkmathletter{g}{#1}
\mkmathletter{h}{#1}
\mkmathletter{i}{#1}
\mkmathletter{j}{#1}
\mkmathletter{k}{#1}
\mkmathletter{l}{#1}
\mkmathletter{m}{#1}
\mkmathletter{n}{#1}
\mkmathletter{o}{#1}
\mkmathletter{p}{#1}
\mkmathletter{q}{#1}
\mkmathletter{r}{#1}
\mkmathletter{s}{#1}
\mkmathletter{t}{#1}
\mkmathletter{u}{#1}
\mkmathletter{v}{#1}
\mkmathletter{w}{#1}
\mkmathletter{x}{#1}
\mkmathletter{y}{#1}
\mkmathletter{z}{#1}
}
\mkmathletters{frak}
\mkmathletters{bb}
\mkmathletters{cal}
\mkmathletters{bf}
\mkmathletters{rm}
\mkmathletters{sc}
\mkmathletters{sf}
\def\alphabf{\ensuremath{\bm\alpha}}
\def\betabf{\ensuremath{\bm\beta}}
\def\gammabf{\ensuremath{\bm\gamma}}
\def\deltabf{\ensuremath{\bm\delta}}
\def\epsilonbf{\ensuremath{\bm\epsilon}}
\def\zetabf{\ensuremath{\bm\zeta}}
\def\etabf{\ensuremath{\bm\eta}}
\def\thetabf{\ensuremath{\bm\theta}}
\def\jotabf{\ensuremath{\bm\jota}}
\def\kappabf{\ensuremath{\bm\kappa}}
\def\lambdabf{\ensuremath{\bm\lambda}}
\def\mubf{\ensuremath{\bm\mu}}
\def\nubf{\ensuremath{\bm\nu}}
\def\xibf{\ensuremath{\bm\xi}}
\def\pibf{\ensuremath{\bm\pi}}
\def\omikronbf{\ensuremath{\bm\omikron}}
\def\rhobf{\ensuremath{\bm\rho}}
\def\sigmabf{\ensuremath{\bm\sigma}}
\def\taubf{\ensuremath{\bm\tau}}
\def\upsilonbf{\ensuremath{\bm\upsilon}}
\def\phibf{\ensuremath{\bm\phi\phi}}
\def\chibf{\ensuremath{\bm\chi}}
\def\psibf{\ensuremath{\bm\psi}}
\def\omegabf{\ensuremath{\bm\omega}}

\def\Alphabf{\ensuremath{\bm\Alpha}}
\def\Betabf{\ensuremath{\bm\Beta}}
\def\Gammabf{\ensuremath{\bm\Gamma}}
\def\Deltabf{\ensuremath{\bm\Delta}}
\def\Epsilonbf{\ensuremath{\bm\Epsilon}}
\def\Zetabf{\ensuremath{\bm\Zeta}}
\def\Etabf{\ensuremath{\bm\Eta}}
\def\Thetabf{\ensuremath{\bm\Theta}}
\def\Jotabf{\ensuremath{\bm\Jota}}
\def\Kappabf{\ensuremath{\bm\Kappa}}
\def\Lambdabf{\ensuremath{\bm\Lambda}}
\def\Mubf{\ensuremath{\bm\Mu}}
\def\Nubf{\ensuremath{\bm\Nu}}
\def\Xibf{\ensuremath{\bm\Xi}}
\def\Pibf{\ensuremath{\bm\Pi}}
\def\Omikronbf{\ensuremath{\bm\Omikron}}
\def\Rhobf{\ensuremath{\bm\Rho}}
\def\Sigmabf{\ensuremath{\bm\Sigma}}
\def\Taubf{\ensuremath{\bm\Tau}}
\def\Upsilonbf{\ensuremath{\bm\Upsilon}}
\def\Phibf{\ensuremath{\bm\phi\Phi}}
\def\Chibf{\ensuremath{\bm\Chi}}
\def\Psibf{\ensuremath{\bm\Psi}}
\def\Omegabf{\ensuremath{\bm\Omega}}



%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% remark

%\setlength{\marginparsep}{6mm}
\setlength{\marginparwidth}{15mm}
\newcounter{remarkcounter}\setcounter{remarkcounter}{0}
\def\printremarkcounter{\raisebox{1ex}{%
    \normalfont%
    \footnotesize%
    (\hspace{-0.1em}\alph{remarkcounter}\hspace{-0.1em})}%
}
\def\remark#1{%
  \stepcounter{remarkcounter}%
  \unskip\nopagebreak\printremarkcounter%
  \marginpar{%
    \renewcommand{\baselinestretch}{0.9}%
    \begin{flushleft}
      \makebox[0mm][r]{\printremarkcounter}%
      \small#1
    \end{flushleft}%
  }%
}

\let\ToDo=\todo

%% Remark
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% SET
\def\st{\,\middle\vert\mkern-3mu\middle|\,}
\def\set#1{\left\{#1\right\}}
%% SET
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% CHOOSE
\def\choose#1{
\begin{pmatrix}
        #1
\end{pmatrix}
}
%% CHOOSE
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% DELIMS
\def\<#1>{\left\langle#1\right\rangle}
\def\|#1|{\left|\left|#1\right|\right|}
\def\I#1{\left\lfloor#1\right\rfloor}
\def\cI#1{\left\lceil#1\right\rceil}
\def\cci#1{\left\lceil\hspace{-0.7mm}\left\lceil%
           #1\right\rceil\hspace{-0.7mm}\right\rceil}
\let\ci=\cI
\def\T#1{\left\lceil#1\right\rceil}
\def\TT#1{\left\lceil\hspace{-0.9mm}\left\lceil%
           #1\right\rceil\hspace{-0.9mm}\right\rceil}
\def\L#1{\left\lfloor#1\right\rfloor}

\newcommand\dperp{\protect\mathpalette{\protect\independenT}{\perp}}
\def\independenT#1#2{\mathrel{\rlap{$#1#2$}\mkern2mu{#1#2}}}

\def\pre#1#2#3#4{}

%% DELIMS
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% HYPERLINKS


\let\termtexthook=\relax
\let\termmarginhook=\relax
\let\seehook=\relax
\def\termmargin{no}

\def\termtexthook{\em}
\def\termmarginhook#1{\color{blue}\fbox{\parbox{\marginparwidth}{\raggedright#1}}}
\def\seehook#1{\color{gray}\underline{#1}}

\def\allterms{}

\newcommand{\term}[2][EMPTY]{%
  \ifthenelse{\equal{#1}{EMPTY}}%
    {\hypertarget{t:#2}{{\termtexthook{#2}}}%
      \xdef\allterms{\allterms\ #2 \thepage,}}%
    {\hypertarget{t:#1}{{\termtexthook{#2}}}%
      \xdef\allterms{\allterms\ #1 \thepage,}}%
  \ifthenelse{\equal{\termmargin}{yes}}
    {\marginpar{\termmarginhook{#2}}}%
    {\relax}%
}


\renewcommand{\see}[2][EMPTY]{%
  \hypersetup{linkcolor=blue}      
  \ifthenelse{\equal{#1}{EMPTY}}%
    {\hyperlink{t:#2}{{\seehook{#2}}}}%
    {\hyperlink{t:#1}{{\seehook{#2}}}}%
  \hypersetup{linkcolor=red}  
}  

%% HYPERLINKS
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% EQUATION TAGS
\newcounter{subequation}[equation]
\makeatletter\@addtoreset{equation}{section}\makeatother
\def\defaulteqtag{\thesection.\arabic{equation}}
\def\defaultsubeqtag{\defaulteqtag.\alpha{subequation}}
\def\printeqlabel#1{\protect\makebox[0mm][l]{%
    \hspace{-3mm}\protect\raisebox{1em}{\tiny\color{red}#1}}}
\newcommand{\tageq}[2][empty]{%
   \ifthenelse{\equal{#1}{empty}}
     {%
      \stepcounter{equation}%
      %\tag{\defaulteqtag\printeqlabel{eq:#2}}%
      \tag{\defaulteqtag}%
     }
     {%
     %\tag*{#1\printeqlabel{eq:#2}}%
     \tag{#1}%
     }%
     \label{eq:#2}%
}
%% EQUATION TAGS
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% THEOREMS etc
\def\empty{}
\xdef\listofclaims{}
\def\globallet#1#2{\global\let#1#2}
\def\epropsymbol{$\boxtimes$}
\def\eprop{ \rule{0.00mm}{3mm}\nolinebreak\hfill\epropsymbol}
\def\printlabel#1{\makebox[0mm][l]{%
    \hspace{-3mm}\raisebox{1em}{\tiny\color{red}#1}}}
\def\Label#1{\printlabel{#1}\label{#1}}
\newcommand{\NewTheorem}[3]{% {envname}{title}{countername}
  \newtheorem{#1nosave}[#3]{#2}
  \NewEnviron{#1}[1]
  {
    \xdef\lastclaim{##1}%
    \expandafter\xdef\csname##1countername\endcsname{the#3}
    \expandafter\xdef\csname##1envname\endcsname{#1nosave}
    \expandafter\globallet\csname##1content\endcsname=\BODY
    \xdef\listofclaims{\listofclaims,##1}
    \begin{#1nosave}\label{##1}%
      \expandafter\xdef\csname##1number\endcsname{\csname
        the#3\endcsname}
      % for draft
        %\printlabel{##1}%
        \expandafter\ifx\csname r@##1.rep\endcsname\relax\else
          \hyperref[##1.rep]{\boldmath$\downarrow$}
        \fi          
        \BODY\eprop
    \end{#1nosave}
  }
}

\newif\ifclaimismissing
\claimismissingfalse

\newcommand{\repeatclaim}[1]{%
  \xdef\lastclaim{#1}%
   \expandafter\ifx\csname#1content\endcsname\relax
      {\mbox{\relax}\par\noindent\color{red}\bf Missing claim
      ``#1''.\par%
      \global\claimismissingtrue%
      }
   \else
     \global\claimismissingfalse%
     \begingroup%
     \expandafter\def\csname\csname#1countername\endcsname\endcsname{%
       \csname#1number\endcsname}
     \begin{\csname#1envname\endcsname}\label{#1.rep}
       % For draft
         %\printlabel{#1.rep}%
         \hyperref[#1]{\boldmath$\uparrow$} 
       \let\label=\skipthis
       \let\Label=\skipthis
       \let\marginpar=\skipthis
       \let\todo=\skipthis
       \csname#1content\endcsname
       \eprop
     \end{\csname#1envname\endcsname}
   \endgroup%
   \fi
}

\def\repeatallclaimsaux,#1;EndOfTheArgs{
  \foreach \claim in {#1}{
    \repeatclaim{\claim}
  }
}

\def\repeatallclaims{%
  \ifx\listofclaims\empty%
    \relax%
  \else%
    \expandafter\repeatallclaimsaux\listofclaims;EndOfTheArgs%
  \fi%
}
\newtheorem{independent}{XXX}
\newtheorem{withinsection}{XXX}[section]
\newtheorem{withinsection1}{XXX}[section]

\NewTheorem{definition}{Definition}{withinsection}
\NewTheorem{proposition}{Proposition}{withinsection}
\NewTheorem{theorem}{Theorem}{withinsection}
\NewTheorem{corollary}{Corollary}{withinsection}
\NewTheorem{lemma}{Lemma}{withinsection}
\NewTheorem{tlemma}{Lemma}{withinsection1}
 
\newtheorem{conjecture}{Conjecture}
\newtheorem{question}[conjecture]{Question}
\renewcommand{\theconjecture}{Q\arabic{conjecture}}

\def\eproofsymbol{$\blacklozenge$}
\def\eproofsymbol{$\boxtimes$}

\NewEnviron{Proof}[1][\lastclaim]{%
  \expandafter\ifx\csname#1content\endcsname\relax
     {\mbox{\relax}\par\color{red}\bf Skipping proof of ``#1''.%
      \nolinebreak\hfill\eproofsymbol\par}%
   \else
     \par\noindent\textit{Proof:} \BODY%
     \rule{0.00mm}{3mm}\nolinebreak\hfill\eproofsymbol\par
   \fi  
}
\def\eproof{\rule{0.00mm}{3mm}\nolinebreak\hfill\eproofsymbol\par}

%% THEOREMS etc
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%% SECTIONS
% 
% \let\Section=\section
% \renewcommand{\section}[2][empty]{%
%   \Section{#2}%
%   \ifthenelse{\equal{#1}{empty}}%
%                {\xdef\SectionName{#2}}%
%                {\xdef\SectionName{#1}}%
% }
% 
% \let\Subsection=\subsection
% \renewcommand{\subsection}[2][empty]{%
%   \Subsection{#2}%
%   \ifthenelse{\equal{#1}{empty}}%
%                {\xdef\SubsectionName{#2}}%
%                {\xdef\SubsectionName{#1}}%
% }
% 
%%% SECTIONS
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%% COLOR

\def\skippar#1\par{\relax\par}
\def\justpar#1\par{#1\par}
\newcommand{\justins}[2][]{#2}
\newcommand{\justrm}[2][]{#1}

\def\specialpar#1#2#3#4\par{%
  \rule{0mm}{3mm}\par%
  #3%
  \textcolor{#1}{%
    \makebox[0mm][r]{#2}\unskip%
    {#4}%
  }%
  \par%
}

\def\csletsecond#1#2{%
  \expandafter\let\expandafter#1\csname#2\endcsname}

\def\cslet#1#2{%
  \expandafter\csletsecond\csname#1\endcsname{#2}}


%\getoption{prefix}{optionname}{defaultvalue}{optionsstring}

\newcommand{\getoption}[4]{%
  \def\get@option##1#2=##2,##3ENDOFTHEARGS{%
    \expandafter\gdef\csname#1#2\endcsname{##2}}%
  \get@option#4,#2=#3,ENDOFTHEARGS}

% \setcolors[rmcolor=cyan,
%            commentcolor=purple,
%            inscolor=blue,
%            symbol=$\mathbb{J}\,\,$]
%            commentsymbol=on,
%            rmsymbol=on,
%            inssymbol=on,
%           {jim}

\newcommand{\setcolors}[2][]{%
  \getoption{#2}{rmcolor}{green}{#1}%
  \getoption{#2}{inscolor}{blue}{#1}%
  \getoption{#2}{commentcolor}{red}{#1}%
  \getoption{#2}{symbol}{$bullet\,\,$}{#1}%
  \getoption{#2}{commentsymbol}{off}{#1}%
  \getoption{#2}{rmsymbol}{off}{#1}%
  \getoption{#2}{inssymbol}{off}{#1}%
  \expandafter\gdef\csname#2@par\endcsname{%
    \specialpar{\csname#2commentcolor\endcsname}%
               {}%
               {\noindent}%
    \ifthenelse{\equal{\csname#2commentsymbol\endcsname}{on}}{%
    \marginpar{\center\textcolor{\csname#2commentcolor\endcsname}{%
               \csname#2symbol\endcsname}}}{\relax}%           
  }
  \expandafter\gdef\csname#2@inspar\endcsname{%    
    \specialpar{\csname#2inscolor\endcsname}%
               {}%
               {}%
    \ifthenelse{\equal{\csname#2inssymbol\endcsname}{on}}{%
    \marginpar{\center\textcolor{\csname#2inscolor\endcsname}{%
               \csname#2symbol\endcsname}}}{\relax}%
  }
  \expandafter\gdef\csname#2@rmpar\endcsname{%
    \specialpar{\csname#2rmcolor\endcsname}%
               {}%
               {}%
    \ifthenelse{\equal{\csname#2rmsymbol\endcsname}{on}}{%
    \marginpar{\center\textcolor{\csname#2rmcolor\endcsname}{%
               \csname#2symbol\endcsname}}}{\relax}%
  }
  \expandafter\def\csname#2@rm\endcsname{\relax}
  \expandafter\renewcommand\csname#2@rm\endcsname[2][]{%
    \ifthenelse{\equal{\csname#2rmsymbol\endcsname}{on}}{%
    \marginpar{\center\textcolor{\csname#2rmcolor\endcsname}{%
               \csname#2symbol\endcsname}}}{\relax}%
    \textcolor{\csname#2inscolor\endcsname}{##1}%
    \ifthenelse{\equal{##1}{}}{\relax}{/}%
    \textcolor{\csname#2rmcolor\endcsname}{##2}%
  }%
  \expandafter\def\csname#2@ins\endcsname{\relax}
  \expandafter\renewcommand\csname#2@ins\endcsname[2][]{%
    \ifthenelse{\equal{\csname#2inssymbol\endcsname}{on}}{%
    \marginpar{\center\textcolor{\csname#2inscolor\endcsname}{%
               \csname#2symbol\endcsname}}}{\relax}%
    \textcolor{\csname#2rmcolor\endcsname}{##1}%
    \ifthenelse{\equal{##1}{}}{\relax}{/}%
    \textcolor{\csname#2inscolor\endcsname}{##2}%
  }%
  \expandafter\gdef\csname#2on\endcsname{%
    \cslet{#2par}{#2@par}%
    \cslet{#2inspar}{#2@inspar}%
    \cslet{#2rmpar}{#2@rmpar}%
    \cslet{#2ins}{#2@ins}%
    \cslet{#2rm}{#2@rm}%
  }%   
  \expandafter\gdef\csname#2off\endcsname{%
    \cslet{#2par}{skippar}%
    \cslet{#2inspar}{justpar}%
    \cslet{#2rmpar}{skippar}%
    \cslet{#2ins}{justins}%
    \cslet{#2rm}{justrm}%
  }%   
  \csname#2on\endcsname
} 

%%% COLOR
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
