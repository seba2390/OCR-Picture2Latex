\section{Problem Formulation}
\label{sec:problem}

% \input{composite.tex}
% \input{UPA_Codebook.tex}

% \subsection{UPA Dual Beamforming}

% Suppose an $M_h \times M_v$ UPA is placed at the $x-z$ plane, and let $M = M_h M_v$. Let the distance between the antennas that are placed parallel to $z$ axis, be $d_z$, and $d_x$ respectively. One can define,

% \begin{align}
% \mathbf{d}_{M_{a}}\left(\psi_{a}\right) = \left[1, e^{j \psi_{a}} \cdots e^{j\left(M_{a}-1\right) \psi_{a}}\right]^{T} \in \mathbb{C}^{M_{a}}
% \end{align}
% where, $\zeta=\frac{2 \pi d_{x}}{\lambda} \sin \theta \cos \phi \text { and } \xi=\frac{2 \pi d_{z}}{\lambda} \sin \phi$, and $a$ takes value in the set $\{v, h\}$.  
% The array response vector is then defined as 

% \begin{align}
%     \mathbf{d}_{M}\left(\xi, \zeta\right) =
%     \mathbf{d}_{M_{v}}\left(\xi\right) \otimes
%     \mathbf{d}_{M_{h}}\left(\zeta\right)  \in \mathbb{C}^{M}
% \end{align}
% Define the reference gain at $(\zeta, \xi) $ as, 

% \begin{equation}
%     G\left(\xi, \zeta, \mathbf{c}\right) =\left|\left(\mathbf{d}_{M_{v}}\left(\xi\right)\otimes\mathbf{d}_{M_{h}}\left(\zeta\right)  \right)^{H} \mathbf{c}\right|^{2}
% \end{equation}



Prior to formulating the multi-beamforming design problem, we proceed with a few preliminary definitions. Let us define the \emph{multi-beam}  $\mathcal{D} =(\mathcal{D}_1, \ldots \mathcal{D}_k)$ as collection of $k$ \emph{compound beams} $\mathcal{D}_i, i = 1,\ldots, k$ where $\mathcal{D}_i \subseteq \mathcal{B}^{\psi}$ and $\mathcal{D}_i = {\bigcup}_{{(p,q) \in \mathcal{A}_i}} \mathcal{B}^{\psi}_{p,q}$, with $\mathcal{A}_i$ being the set of all pairs $(p,q)$ that all beams $\mathcal{B}^{\psi}_{p,q}$ cover $\mathcal{D}_i$. The union of $\mathcal{B}^{\psi}_{p,q}$ is in fact approximating the shape of the solid angle for the desired compound beam corresponding to $\mathcal{D}_i$. By using larger number of division, i.e., finer beams, one can make the approximation better. We have 
\begin{align}
    &\mathcal{A}_i = \underset{\{\mathcal{\hat{A}}|\mathcal{D}_i \subseteq \underset{(p,q) \in \mathcal{A}}{\bigcup} \mathcal{B}_{p,q}\}}{\arg\min} |\mathcal{\hat{A}}|
\end{align}
% where, $i\in \{1,2\}$ and define further $\mathcal{A} = (\mathcal{A}_1, \mathcal{A}_2)$. 

Further define $\mathcal{A} = {{\bigcup}_{i=1}^k}\mathcal{A}_i$. 
%Let $\c$ denote the configuration of RIS (a.k.a beamformer) to control the gain and the phase of the exchanged signals, i.e. $c_{m_v, m_h} = \beta_{m_v, m_h}e^{j\theta_{m_v, m_h}}$, $m_v = 1\ldots M_v$, $m_h = 1\ldots M_h$. 
%
% Let $\c = \mbox{diag}( \Theta )$ denote a vector of length $M$ consisting of the diagonal elements of the matrix $\Theta$. For antenna element located at $(m_v, m_h)$ in the ULA grid, we define $c_{m_v, m_h} = \beta_{m_v, m_h}e^{j\theta_{m_v, m_h}}$, $m_v = 0, \ldots,  M_v-1$, $m_h = 0, \ldots, M_h-1$, and hence the vector $\c$ is given by
% \begin{equation}
%     \c = [c_{0,0}, \ldots, c_{0,M_h-1}, c_{1,0}, \ldots, c_{M_v-1, M_h-1}]
% \end{equation}
%
We aim to design a beamforming vector $\c$ such that the multi-beam $\mathcal{D}$ is covered when the RIS is excited by an incident wave received at solid angle $\Omega_1$. Using (\ref{channel})-(\ref{channel_t}), the contribution of the RIS in the channel matrix for a receiver at the solid angle $\Omega_2$ is given by
% \begin{align}
%     \Gamma = \d^{H}_{M}\{\Omega_{1}\} \Theta \d_{M}\{\Omega_{2}\} = \boldsymbol\lambda^H \d_{M}\{\Omega_{2}\} 
% \end{align}
\begin{align}
    \Gamma = \a^{H}_{M}(\Omega_2) \Theta \a_{M}(\Omega_1) = \d^H_M(\Omega_2) \boldsymbol{\lambda}  
\end{align}
where  $\boldsymbol{\lambda} \in \mathbb{C}^M$  is defined as follows. For antenna element located at position $(m_v, m_h)$ in the UPA grid,  we have 
\begin{align}
    \lambda_{m_v, m_h} = \beta_{m_v, m_h}e^{-j(\theta_{m_v, m_h}- m_v\xi_{1} - m_h\zeta_{1})}
\end{align} 
where $(\xi_{1}, \zeta_{1})$ is the representation of $\Omega_1$ in the $\psi$-domain, and hence the vector $\boldsymbol{\lambda}$ is given by
\begin{equation}
    \boldsymbol{\lambda} = [\lambda_{0,0}, \ldots, \lambda_{0,M_h-1}, \lambda_{1,0}, \ldots, \lambda_{M_v-1, M_h-1}]
\end{equation}

We note that $\boldsymbol{\lambda}$ depends on the AoA of the incident beams at the RIS, i.e., $\Omega_1$, as well as the RIS parameters. The reference gain of RIS in direction $(\zeta, \xi) $ in terms of $\boldsymbol{\lambda}$ is given by 
\begin{align}
    G\left(\xi, \zeta, \boldsymbol{\lambda} \right) =\left|\left(\mathbf{d}_{M_{v}}\left(\xi\right)\otimes\mathbf{d}_{M_{h}}\left(\zeta\right)  \right)^{H} \boldsymbol{\lambda} \right|^{2}
\end{align}

% The RIS parameters, i.e., the phase shift $\theta_m$ and the attenuation value $\beta_m$ for the $m^{th}$ elements of the RIS, are obtained by by using the corresponding coefficients of the vector $\boldsymbol{\lambda}$ and the directivity vector $\a_{M}(\Omega_{1})$ for any receive incident solid angle $\Omega_1$. To design $\boldsymbol{\lambda}$, we first define and work on the normalized beamforming vector $\c = \frac{\boldsymbol{\lambda}}{\|\boldsymbol{\lambda}\|}$, and then we compute $\boldsymbol{\lambda} = \frac{\c}{\|\c\|_{\infty}}$ based on the obtained value for $\c$. 

On the other hand, the gain of UPA antenna with the feed coefficients $\c$ is given by
\begin{equation}
    G\left(\xi, \zeta, \c \right) =\left|\left(\mathbf{d}_{M_{v}}\left(\xi\right)\otimes\mathbf{d}_{M_{h}}\left(\zeta\right)  \right)^{H} \c \right|^{2} \label{UPA_beamforming_c}
\end{equation}
that has a clear similarity.
%where $\|\c\| \leq 1$.
This means that to design the RIS-UPA for the STMR problem with receive zone $\mathcal{D}$ we can use the multi-beamforming design framework to cover the ACI's included in $\mathcal{D}$ for the UPA antenna. In particular, a RIS-UPA with parameters $\boldsymbol{\lambda}$ and a UPA-antenna with beamforming parameters $\c$ have the same beamforming gain pattern if UPA structures are the same and $\boldsymbol{\lambda}=\c$. Hence, a RIS-UPA which is excited from the solid angle $\Omega_1$ has the same beamforming gain as its UPA antenna counterpart if $\boldsymbol{\Theta}= \mbox{diag} \{\c^T \odot \a_M^H(\Omega_1)\}$.
%\amir{Please note that in the equation of the reference gain, $\d$ and $\c$ are both normalized with respect to the maximum values of the gain to be one. This means that the norm of every element of the directivity vector $\d$ is one. Also, the gain of every element of the beamforming coefficient is also less than or equal to one since the RIS is assumed to be passive.}
For any normalized beamforming vector $\c$, it is straightforward to show that, 
% Let us define the \emph{dual beam}  $ \mathcal{D} =(\mathcal{D}_1, \mathcal{D}_2) , \text{ given } \mathcal{D}_1 , \mathcal{D}_2\subseteq \mathcal{B}_s$. Let $\mathcal{A}_1$, and $\mathcal{A}_2$ denote the smallest set of index pairs $(p,q)$ the corresponding beams to which collectively cover the area marked by the desired beams $\mathcal{D}_1$ and $\mathcal{D}_2$ respectively. More precisely, we can write 
% where $c^{\mathrm{D}}_1 = (\phi^{\mathrm{D}}_1, \theta^{\mathrm{D}}_1)$ and $c^{\mathrm{D}}_2 = (\phi^{\mathrm{D}}_2, \theta^{\mathrm{D}}_2)$ are the directions of the centers of the two beams respectively.
% \begin{align}
%     &\mathcal{A}_i = \underset{\{\mathcal{A}|\mathcal{D}_i \subseteq \underset{(p,q) \in \mathcal{A}}{\bigcup} \mathcal{B}_{p,q}\}}{\arg\min} Card(\mathcal{A})
% \end{align}
% where, $i\in \{1,2\}$ and define further $\mathcal{A} = (\mathcal{A}_1, \mathcal{A}_2)$. 
\begin{equation}
    \int_{-\pi}^{\pi} \int_{-\pi}^{\pi} G\left(\xi, \zeta, \mathbf{c}\right) d \xi d \zeta={(2 \pi)^{2}}
\end{equation}

We wish to design beamformers that provide high, sharp, and constant gain within the desired ACI's and zero gain everywhere else. We have then for the ideal gain corresponding to such beamformer $\c$ that,
\begin{align}
&\iint_{\mathcal{B}^{\psi}} G^\text {ideal }_{\mathcal{D}}(\xi, \zeta) d \xi d \zeta =\sum_{i=1}^k\iint_{\mathcal{D}_i} t d \xi d \zeta \nonumber\\
&= \sum_{(p,q) \in \mathcal{A} }{\iint_{\mathcal{B}^\psi_{p,q}} t d \xi d \zeta} = \sum_{(p,q) \in \mathcal{A}}\delta_{p,q} t=(2 \pi)^2 \label{composite}
\end{align}

where $\delta_{p,q}$ denotes the area of the $(p,q)$-th beam in the $(\xi, \zeta)$ domain. Therefore, we can derive $t= \frac{(2\pi)^2}{|\mathcal{A}|\delta_{p,q}}$. It holds that, 
\begin{equation}
    G^{\text {ideal }}_{ \mathcal{D}}\left(\xi, \zeta\right)=\frac{(2\pi)^2}{|\mathcal{A}|\delta_{p,q}} \mathds{1}_{\mathcal{D}}\left(\xi, \zeta\right)\label{ideal_compound}
\end{equation}

Using the beamformer $\c$ we wish to mimic the deal gain in equation \eqref{ideal_compound}. Therefore, we formulate the following optimization problem, 
\begin{align}
& \c^{opt}_{\mathcal{D}} = \underset{\c, \|\c\|=1}{\arg \min } \underset{\mathcal{B}^{\psi}}{\iint}\left|G^{\text {ideal }}_{\mathcal{D}}\left(\xi, \zeta\right)-G\left(\xi, \zeta, \c\right)\right| d \xi d \zeta \label{init_opt}
\end{align}

By partitioning the range of $(\xi, \zeta)$ into the pre-defined intervals, and then uniformly sampling with the rate $(L_v, L_h)$ per interval along both axis,  we can rewrite the optimization problem as follows, 
% \begin{align}
% & \c^{opt}_{\mathcal{D}} = \underset{\c, \|\c\|=1}{\arg \min } \sum_{r=1}^{Q_v}\sum_{s=1}^{Q_h}\iint_{\mathcal{B}^{\psi}_{r,s}}\left|G_{\mathcal{D}}^{\text {ideal }}\left(\xi, \zeta\right)-G\left(\xi, \zeta, \c\right)\right| d \xi d \zeta \nonumber\\&
%  = \underset{L_h, L_v \rightarrow \infty}{\lim}\sum_{r=1}^{Q_v}\sum_{s=1}^{Q_h}\sum_{l_v =1}^{L_v}\sum_{l_h =1}^{L_h}\frac{\delta_v\delta_h}{L_hL_v}\nonumber\\&
% \left|G_{\mathcal{D}}^{\text {ideal }}\left(\psi^{r,s}_{v}[l_v], \psi^{r,s}_{h}[l_h]\right)-G\left(\psi^{r,s}_{v}[l_v], \psi^{r,s}_{h}[l_h], \c\right)\right| \label{alternative_opt}
% \end{align}
% where, 
% \begin{align}
%     & \psi^{r,s}_v = -\psi^{\mathrm{B}}_v + r\delta_v, \quad \psi^{r,s}_h = -\psi^{\mathrm{B}}_h + s\delta_h \\
%     &\psi^{r,s}_v[l_v] = \psi^{r-1, s}_v + l_v\frac{\delta_v}{L_v},  \quad \psi^{r,s}_h[l_h] = \psi^{r, s-1}_h + l_h\frac{\delta_h}{L_h} \label{l_vl_h}
% \end{align}
\begin{align}
 \c^{opt}_{\mathcal{D}} &= \underset{{\c, \|\c\|=1}}{{\arg \min }} \sum_{r=1}^{Q_v}\sum_{s=1}^{Q_h}\iint_{\mathcal{B}^{\psi}_{r,s}}\left|G_{\mathcal{D}}^{\text {ideal }}\left(\xi, \zeta \right)-G\left(\xi, \zeta, \c\right)\right| d \xi d \zeta \nonumber\\&
 = \underset{L_h, L_v \rightarrow \infty}{\lim}\sum_{r=1}^{Q_v}\sum_{s=1}^{Q_h}\sum_{l_v =1}^{L_v}\sum_{l_h =1}^{L_h}\nonumber\\&\frac{\delta_v\delta_h}{L_hL_v}
%\left|G_{\mathcal{D}}^{\text {ideal }}\left(\psi^{r,s}_{v}[l_v], \psi^{r,s}_{h}[l_h]\right)-G\left(\psi^{r,s}_{v}[l_v], \psi^{r,s}_{h}[l_h], \c\right)\right|
\left|G_{\mathcal{D}}^{\text {ideal }}\left(\xi_{r, l_v}, \zeta_{s,l_h}\right)-G\left(\xi_{r, l_v}, \zeta_{s,l_h}, \c\right)\right|\label{alternative_opt}
\end{align}
where, 
\begin{align}
    &\xi_{r,l_v} = \xi^{r-1} + l_v\frac{\delta_v}{L_v}, \quad \zeta_{s, l_h} = \zeta^{s-1} + l_h\frac{\delta_h}{L_h} \label{l_v_l_h}
\end{align}




\noindent with $\delta_a = \frac{2\psi_a^{\mathrm{B}}}{Q_a}$, for $a \in \{v, h\}$. Note that it holds for all $(p,q)$ pairs that, $\delta_{p,q} = \delta_v\delta_h$. 
We can rewrite equation \eqref{alternative_opt} as, 
\begin{align}
    \c_{\mathcal{D}}^{opt}=\arg \min _{\c, \|\c\|=1} \underset{L_h, L_v \rightarrow \infty}{\lim}\frac{1}{L_hL_v}\left|\mathbf{G}^{\text {ideal }}_{\mathcal{D}}-\mathbf{G}(\c)\right|\label{init_normed_opt}
\end{align}
where, 
\begin{align}
    \mathbf{G}(\c) =&  \delta_{p,q}\left[G\left(\xi_{1,1}, \zeta_{1,1}, \c\right) \cdots G\left(\xi_{Q_{v}, L_{v}}, \zeta_{Q_{h}, L_{h}}, \c\right)\right]^{T}  
\end{align}
and,
\begin{align}
    \mathbf{G}^{\text {ideal }}_{ \mathcal{D}} =& \delta_{p,q}\left[G^{\text {ideal }}_{ \mathcal{D}}\left(\xi_{1,1}, \zeta_{1,1} \right) \cdots  G^{\text {ideal }}_{ \mathcal{D}}\left(\xi_{Q_{v}, L_v}, \zeta_{ Q_{h}, L_{h}}\right)\right]^{T} 
\end{align}

% \begin{align}
%     \mathbf{G}(\c) =&  \delta_v\delta_h\left[G\left(\xi^{1}[1], \zeta^{1}[1], \c\right) \cdots \right. \nonumber\\ &\left. G\left(\xi^{Q_{v}}\left[L_{v}\right], \zeta^{Q_{h}}\left[L_{h}\right], \c\right)\right]^{T} 
% \end{align}

% and, 
% \begin{align}
%     \mathbf{G}^{\text {ideal }}_{ \mathcal{D}} =& \delta_v\delta_h\left[G^{\text {ideal }}_{ \mathcal{D}}\left(\xi^{1}[1], \zeta^{1}[1] \right) \cdots \right. \nonumber\\ &\left. G^{\text {ideal }}_{ \mathcal{D}}\left(\xi^{Q_{v}}\left[L_{v}\right], \zeta^{ Q_{h}}\left[L_{h}\right]\right)\right]^{T} 
% \end{align}


Unfortunately, the optimization problem in \eqref{init_normed_opt} does not admit an optimal closed-form solution as is, due to the absolute values of the complex numbers existing in the formulation. However, note that, 
\begin{align}
    \mathbf{G}^{\text {ideal }}_{\mathcal{D}}&=\sum_{(p,q) \in \mathcal{A}}\delta_{p,q}\frac{(2\pi)^2}{|\mathcal{A}|\delta_{p,q}}\left(\mathbf{e}_{p,q} \otimes \mathbf{1}_{L, 1}\right) \nonumber\\&= \frac{(2\pi)^2}{|\mathcal{A}|}\sum_{(p,q) \in \mathcal{A}}{\mathbf{e}_{p,q} \otimes \mathbf{1}_{L, 1}}
    \label{ideal}
\end{align}
with $\mathbf{e}_{p,q} \in \mathbb{Z}^{Q}$ being the standard basis vector for the $(p,q)$-th axis among $(Q_v, Q_h)$ pairs. Now, note that $\mathbf{1}_{L, 1}=\mathbf{g} \odot \mathbf{g}^{*}$ for any equal gain $\mathbf{g} \in \mathbb{C}^L$ where $L = L_hL_v$. An equal-gain  vector $\g \in \mathbb{C}^L$ is a vector where all elements have equal absolute values (in this case, equal to $1$). Therefore, we can write: 
% $$\mathcal{G}_{L}=\left\{\mathbf{g} \in \mathbb{C}^{L}:\left(\mathbf{g} \mathbf{g}^{H}\right)_{\ell, \ell}=1,1 \leq \ell \leq L\right\}$$
\begin{align}
\mathbf{G}^{\text {ideal }}_{\mathcal{D}} &= \sum_{(p,q) \in \mathcal{A}}\frac{(2\pi)^2}{|\mathcal{A}|}\left(\mathbf{e}_{p,q} \otimes\left(\mathbf{g} \odot \mathbf{g}^{*}\right)\right) \nonumber\\
&=\frac{(2\pi)^2}{|\mathcal{A}|}\sum_{(p,q) \in \mathcal{A}}\left(\mathbf{e}_{p,q} \otimes \mathbf{g}\right) \odot\left(\mathbf{e}_{p,q} \otimes \mathbf{g}\right)^{*} \nonumber\\
&=\left(\sum_{(p,q) \in \mathcal{A}}\frac{2\pi}{\sqrt{|\mathcal{A}|}}\left(\mathbf{e}_{p,q} \otimes \mathbf{g}\right)\right)  \nonumber\\&\odot \left(\sum_{(p,q) \in \mathcal{A}}\frac{2\pi}{\sqrt{|\mathcal{A}|}}\left(\mathbf{e}_{p,q} \otimes \mathbf{g}\right)\right)^* \label{final_gik}
\end{align}

Also, it is straightforward to write, 
% \begin{align}
%     \mathbf{G}(\c)=\left(\left(\mathbf{D}_{h}^{H} \otimes \mathbf{D}_{v}^{H}\right) \c\right) \odot\left(\left(\mathbf{D}_{h}^{H} \otimes \mathbf{D}_{v}^{H}\right) \c\right)^{*}
% \end{align}
\begin{align}
    \mathbf{G}(\c)=\left(\D^H \c\right) \odot\left(\D^H \c\right)^{*}\label{dc}
\end{align}

\noindent where, $\D^H = \sqrt{\delta_v\delta_h}(\mathbf{D}_{v}^{H} \otimes \mathbf{D}_{h}^{H})$, and for $a \in \{v,h\}$, and $b= 1\ldots Q_a$ we have, 
\begin{align}
\mathbf{D}_{a} &=\left[\mathbf{D}_{a, 1}, \cdots, \mathbf{D}_{a, Q_{a}}\right] \in \mathbb{C}^{M_{a} \times L_{a} Q_{a}}
% \mathbf{D}_{a, b} &=\left[\mathbf{d}_{M_{a}}\left(\psi_{a}^{b}[1]\right), \cdots, \mathbf{d}_{M_{a}}\left(\psi_{a}^{b}\left[L_{a}\right]\right)\right] \in \mathbb{C}^{M_{a} \times L_{a}}
\end{align}
where, 
\begin{align}
    &\mathbf{D}_{v, b} =\left[\mathbf{d}_{M_{v}}\left(\xi_{b,1}\right), \cdots, \mathbf{d}_{M_{v}}\left(\xi_{b, L_v}\right)\right] \in \mathbb{C}^{M_{v} \times L_{v}} \\
    &\mathbf{D}_{h, b} =\left[\mathbf{d}_{M_{h}}\left(\zeta_{b,1}\right), \cdots, \mathbf{d}_{M_{h}}\left(\zeta_{b, L_h}\right)\right] \in \mathbb{C}^{M_{h} \times L_{h}}
\end{align}

Comparing the expressions \eqref{init_normed_opt}, \eqref{final_gik}, and \eqref{dc}, one can show that the optimal choice of $\c_\mathcal{D}$ in \eqref{init_opt} is the solution to the following optimization problem for proper choices of $\g_{p,q}$. 

\begin{problem}
Given equal-gain vectors $\g_{p,q} \in \mathbb{C}^L$, for $(p,q) \in \mathcal{A}$  find vector $\c_{\mathcal{D}} \in \mathbb{C}^{M}$ such that
\begin{align}
\c_{\mathcal{D}}=&{\arg \min }_{\c, \|\c\|=1}\nonumber\\& \lim_{L\rightarrow \infty} \left\|\sum_{(p,q) \in \mathcal{A}}\frac{2\pi}{\sqrt{|\mathcal{A}|}}\left(\mathbf{e}_{p,q} \otimes \mathbf{g}_{p,q}\right)- \D^H \c\right\|^{2} \label{obj_func}
\end{align}
\label{main_problem_UPA}
\end{problem}

However, we now need to find the optimal choices of $\g_{p,q}$ that minimize the objective in \eqref{init_normed_opt}. Using \eqref{final_gik}, and \eqref{dc}, we have the following optimization problem.

\begin{problem}
Find equal-gain vectors $\g^*_{p,q} \in \mathbb{C}^L$, $(p,q) \in \mathcal{A}$ such that
\begin{align}
 &<\g^*_{p,q}>_{(p,q)\in\mathcal{A}} = \underset{<\g_{p,q}>_{(p,q)\in\mathcal{A}}}{\arg\min }\nonumber\\
 &\left\| abs(\D^H \c_{\mathcal{D}})- \frac{{2\pi}}{\sqrt{|\mathcal{A}|}} abs(\sum_{(p,q)\in \mathcal{A}}\mathbf{e}_{p,q} \otimes \mathbf{g}_{p,q})\right\|^{2} \label{g_final_eq}
\end{align} 
where $abs(.)$ denotes the element-wise absolute value of a vector.
\label{g_problem}
\end{problem}

Next, we continue with the solution of Problems ~\ref{main_problem_UPA}, and~\ref{g_problem}.
