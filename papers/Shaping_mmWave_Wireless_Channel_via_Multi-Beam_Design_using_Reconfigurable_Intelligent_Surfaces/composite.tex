\subsection{Composite Codebook Design Problem}

Let us define a \textit{composite beam} $\omega_k$ as a union of multiple disjoint, possibly non-neighboring beams $\nu_{q} \text { for } q \in \mathcal{Q} = \left\{1, \cdots, Q\right\}$. Let $\mathcal{C'}=\left\{\mathbf{c}_{1}, \cdots, \mathbf{c}_{K}\right\}$ be the codebook corresponding to the composite problem.

% $$\bigcup_{k = 1}^{2^{B'}}{\omega_k} = [-\pi, \pi], \quad \text{and} \quad \omega_k \cap \omega_l = \emptyset, \quad \forall k\neq l.$$

Moreover, define for each composite beam $\omega_k$ the set $\mathcal{W}_k \subseteq \mathcal{Q}$ to be the set of indices of the single beams that form $\omega_k$. i.e. $\mathcal{W}_k = \{q \in \mathcal{Q}: v_q \subseteq \omega_k\}$. 
For any codeword $\c$, it holds that, 

\begin{equation}
    \int_{-\pi}^{\pi} G(\psi, \mathbf{c}) d \psi=2 \pi\|\mathbf{c}\|^{2}=2 \pi
\end{equation}
We have then for the ideal gain corresponding to  each codeword $\textbf{c}_k$, 

\begin{align}
&\int_{-\pi}^{\pi} G_{\text {ideal }, k}(\psi) d \psi =\int_{\omega_{k}} t d \psi+\int_{[-\pi, \pi] \backslash \omega_{k}} 0 d \psi \nonumber\\
&= \sum_{q \in {\mathcal{W}_k}}{\int_{\nu_{q}} t d \psi} = \sum_{q \in \mathcal{W}_k}\delta_q t=2 \pi \label{composite}
\end{align}

Therefore, $t = \frac{2 \pi}{\Delta_k}$, where $\Delta_k = \sum_{q \in \mathcal{W}_k}\delta_q$. It follows that, 

\begin{equation}
    G_{\text {ideal }, k}(\psi)=\frac{2 \pi}{\Delta_k} \mathds{1}_{\omega_{k}}(\psi), \quad \psi \in[-\pi, \pi] \label{composite_ideal_gain}
\end{equation}

The new MSE problem for the $k$-th codeword can therefore be written as follows.



\begin{align}
\c_k^{opt} &=\underset{\c, \|\c\|=1}{\arg \min } \int_{-\pi}^{\pi}\left|G_{\text {ideal }, k}(\psi)-G(\psi, \c)\right| d \psi 
\end{align}




By uniformly sampling on the range of   we can rewrite
the optimization problem as follows,

\begin{align}
    \c_k^{opt} &= \nonumber \\&\underset{\c, \|\c\|=1}{\arg \min }\left[\lim _{L \rightarrow \infty} \sum_{p=1}^{Q} \delta_p\sum_{\ell=1}^{L} \frac{\left|G_{\text {ideal }, k}\left(\psi_{p, \ell}\right)-G\left(\psi_{p, \ell}, \c\right)\right|}{L}\right]\label{composite_MSE}
\end{align}

 where, for $q = 1 \ldots Q$, 
 $$\delta_q = \psi_{q}-\psi_{q-1}, \quad \psi_{q, \ell}=\psi_{q-1}+\frac{\delta_q(\ell-0.5)}{L} $$

We can rewrite equation \eqref{composite_MSE} as follows, 

\begin{align}
 &\c_k^{opt} = \underset{\c,  \|\c\|=1}{\arg \min } \lim_{L\rightarrow \infty}\frac{1}{L}\left\|\mathbf{G}_{\text {ideal }, k}-\mathbf{G}(\c)\right\| \label{init_opt}
 \end{align}
 
 where,  $$\mathbf{G}(\c)=\left[{\delta_1} G\left(\psi_{1,1}, \c\right) \ldots {\delta_{Q}}G\left(\psi_{Q, L}, \c\right)\right]^{T} \in \mathbb{Z}^{L Q}$$

and, 
$$ \mathbf{G}_{\text {ideal }, k}=\left[{\delta_1} G_{\text {ideal }, k}\left(\psi_{1,1}\right) \ldots {\delta_{Q}}G_{\text {ideal }, k}\left(\psi_{Q, L}\right)\right]^{T} \in \mathbb{Z}^{L Q}$$


Note that it holds that 

\begin{equation}
    \mathbf{G}_{\text {ideal },k}=\sum_{q \in \mathcal{W}_k}\delta_q\frac{2\pi}{\Delta_k}\left(\mathbf{e}_{q} \otimes \mathbf{1}_{L, 1}\right) \label{ideal}
\end{equation}

with $\mathbf{e}_{q} \in \mathbb{Z}^{Q}$ being the standard basis vector for the $q$-th axis among $Q$ ones. Now, note that $\mathbf{1}_{L, 1}=\mathbf{g} \odot \mathbf{g}^{*}$ for any equal gain $\mathbf{g} \in \mathbb{C}^L$. Therefore, for a suitable choice of $\g$ we can write: 

% $$\mathcal{G}_{L}=\left\{\mathbf{g} \in \mathbb{C}^{L}:\left(\mathbf{g} \mathbf{g}^{H}\right)_{\ell, \ell}=1,1 \leq \ell \leq L\right\}$$


\begin{align}
\mathbf{G}_{\text {ideal }, k} &= \sum_{q \in \mathcal{W}_k}\gamma_q\left(\mathbf{e}_{q} \otimes\left(\mathbf{g} \odot \mathbf{g}^{*}\right)\right) \nonumber\\
&=\sum_{q \in \mathcal{W}_k}\left(\sqrt{\gamma_q}\left(\mathbf{e}_{q} \otimes \mathbf{g}\right)\right) \odot\left(\sqrt{{\gamma_q}}\left(\mathbf{e}_{q} \otimes \mathbf{g}\right)\right)^{*} \nonumber\\
&=\left(\sum_{q \in \mathcal{W}_k}\sqrt{\gamma_q}\left(\mathbf{e}_{q} \otimes \mathbf{g}_q\right)\right)  \odot \left(\sum_{q \in \mathcal{W}_k}\sqrt{\gamma_q}\left(\mathbf{e}_{q} \otimes \mathbf{g}_q\right)\right)^{*} \label{final_gik}
\end{align}




















% \begin{align}
% \left(\mathbf{F}_{k}, \mathbf{v}_{k}\right) &=\underset{\mathbf{F}, \mathbf{v}}{\arg \min } \sum_{p=1}^{Q} \sum_{\ell=1}^{L}\left|G_{\text {ideal }, k}\left(\psi_{p, \ell}\right)-G\left(\psi_{p, \ell}, \mathbf{F} \mathbf{v}\right)\right|^{2} \nonumber\\
% &=\underset{\mathbf{F}, \mathbf{v}}{\arg \min }\lim_{L\longrightarrow \infty} \frac{1}{L}\left\|\mathbf{G}_{\text {ideal }, k}-\mathbf{G}(\mathbf{F} \mathbf{v})\right\|_{2}^{2} \label{init_opt}
% \end{align}

% where,  $$\mathbf{G}(\mathbf{F} \mathbf{v})=\left[G\left(\psi_{1,1}, \mathbf{F} \mathbf{v}\right) \cdots G\left(\psi_{Q, L}, \mathbf{F} \mathbf{v}\right)\right]^{T} \in \mathbb{Z}^{L Q}$$

% and, 
% $$ \mathbf{G}_{\text {ideal }, k}=\left[G_{\text {ideal }, k}\left(\psi_{1,1}\right) \cdots G_{\text {ideal }, k}\left(\psi_{Q, L}\right)\right]^{T} \in \mathbb{Z}^{L Q}$$

% Note that we can write using the definition of $\mathcal{W}_k$ that, 

% $$G_{\text {ideal }, k}\left(\psi_{p, \ell}\right)=\left\{\begin{array}{ll}
% \frac{Q}{|\mathcal{W}_k| M_{t}}, & p \in \mathcal{W}_k \\
% 0, & p \notin \mathcal{W}_k 
% \end{array},\right.$$

% Or in the matrix form, 

% \begin{align}
%     &\mathbf{G}_{\text {ideal }, k}=\frac{Q}{|\mathcal{W}_k| M_{t}}\left((\bigoplus_{q \in \mathcal{W}_k}{\mathbf{e}_{q}}) \otimes \mathbf{1}_{L, 1}\right)  \nonumber \\ 
%     & = \sum_{q \in \mathcal{W}_k}{\frac{Q}{|\mathcal{W}_k| M_{t}}\left(\mathbf{e}_{q} \otimes \mathbf{1}_{L, 1}\right)} \label{G_ideal_k}
% \end{align}

% with $\mathbf{e}_{q} \in \mathbb{Z}^{Q}$ being the standard basis vector for the $q$-th axis among $Q$ ones. Now, note that $\mathbf{1}_{L, 1}=\mathbf{g} \odot \mathbf{g}^{*}$ for any $\mathbf{g} \in \mathcal{G}_L$, where, 

% $$\mathcal{G}_{L}=\left\{\mathbf{g} \in \mathbb{C}^{L}:\left(\mathbf{g} \mathbf{g}^{H}\right)_{\ell, \ell}=1,1 \leq \ell \leq L\right\}$$



% Therefore, equation \eqref{G_ideal_k} can be rewritten as:
% \begin{align}
% &\mathbf{G}_{\text {ideal }, k} = \sum_{q \in \mathcal{W}_k}\frac{Q}{|\mathcal{W}_k| M_{t}}\left(\mathbf{e}_{q} \otimes\left(\mathbf{g}_q \odot \mathbf{g}_q^{*}\right)\right) \nonumber\\
% &=\sum_{q \in \mathcal{W}_k}\left(\sigma\left(\mathbf{e}_{q} \otimes \mathbf{g}_q\right)\right) \odot\left(\sigma\left(\mathbf{e}_{q} \otimes \mathbf{g}_q\right)\right)^{*} \nonumber\\
% &=\left(\sum_{q \in \mathcal{W}_k}\sigma\left(\mathbf{e}_{q} \otimes \mathbf{g}_q\right)\right)  \odot \left(\sum_{q \in \mathcal{W}_k}\sigma\left(\mathbf{e}_{q} \otimes \mathbf{g}_q\right)\right)^{*} \label{final_gik}
% \end{align}

% where $\sigma = \sqrt{\frac{Q}{|\mathcal{W}_k|M_{t}}}$. 

Similarly, it is straightforward to observe,


\begin{align}
\mathbf{G}(\c) &=\left(\mathbf{D}^{H} \c\right) \odot\left(\mathbf{D}^{H} \c\right)^{*} \label{dc}
\end{align}
where $\mathbf{D} =\left[\sqrt{\delta_1}\mathbf{D}_{1} \cdots \sqrt{\delta_{Q}}\mathbf{D}_{Q} \right] \in \mathbb{C}^{M_{t} \times L Q}$, and 
$\mathbf{D}_{q}=\left[\mathbf{d}_{M_{t}}\left(\psi_{q, 1}\right) \cdots \mathbf{d}_{M_{t}}\left(\psi_{q, L}\right)\right] \in \mathbb{C}^{M_{t} \times L}.$
 







% On the other hand note that $\mathbf{G}(\mathbf{F} \mathbf{v})$ can be written as,


% \begin{equation}
%     \mathbf{G}(\mathbf{F} \mathbf{v}) =\left(\mathbf{D}^{H} \mathbf{F} \mathbf{v}\right) \odot\left(\mathbf{D}^{H} \mathbf{F} \mathbf{v}\right)^{*}\label{dfv_decomp}
% \end{equation}

% where, 
% $$\mathbf{D} =\left[\mathbf{D}_{1} \cdots \mathbf{D}_{Q}\right] \in \mathbb{C}^{M_{t} \times L Q}$$

% and, $\mathbf{D}_{q}=\left[\mathbf{d}_{M_{t}}\left(\psi_{q, 1}\right) \cdots \mathbf{d}_{M_{t}}\left(\psi_{q, L}\right)\right] \in \mathbb{C}^{M_{t} \times L}$. 

Comparing the expressions \eqref{init_opt}, \eqref{final_gik}, and \eqref{dc}, one can show that the optimal choice of $\c_q$ in \eqref{init_opt} is the solution to the following optimization problem for a proper choice of $\g_q$. 
\begin{problem}
Given an equal-gain vector $\g_q \in \mathbb{C}^L$, $q \in \{1, \cdots, Q\}$, find vector $\c_q \in \mathbb{C}^{M_t}$ such that
\begin{align}
&\c_q=\underset{\c, \|c\|=1}{\arg \min } \lim_{L\rightarrow \infty} \left\|\sum_{q \in \mathcal{W}_k}\sqrt{\gamma_q}\left(\mathbf{e}_{q} \otimes \mathbf{g}_q\right)- \mathbf{D}^{H} \c\right\|^{2} \label{obj_func}
\end{align}
\label{main_problem}
\end{problem}


However, we now need to find the optimal choice of $\g_q$ that minimizes the objective in \eqref{init_opt}. Using \eqref{final_gik}, and \eqref{dc}, we have the following optimization problem.
\begin{problem}
Find a set of equal-gain $\g_q \in \mathbb{C}^L$, i.e. $\mathcal{G}_k$ such that
\begin{equation}
 \mathcal{G}_k = \underset{\mathcal{G}}{\arg\min }\left\| abs(\D^H \c_q)- abs(\sum_{q \in \mathcal{W}_k}\sqrt{\gamma_q}(\mathbf{e}_{q} \otimes \mathbf{g}_q))\right\|^{2} \label{g_final_eq}
\end{equation} 
where $\mathcal{G}_k = \{\g_q| q \in \mathcal{W}_k\}$, and $abs(.)$ denotes the element-wise absolute value of a vector.
\label{g_problem}
\end{problem}

Hence, the codebook design for a system with full-digital beamforming capability is found by solving Problem~\ref{main_problem} for proper choice of $\g_q$ obtained as a solution to Problem ~\ref{g_problem}. The codebook for Hybrid beamforming, is then found as
\begin{align}
    \underset{\mathbf{F}_{q},\mathbf{v}_{q}}{\arg\min } \|\mathbf{F}_{q}\mathbf{v}_{q} - \c_q\|^2
\end{align}
where the columns of $\F_q \in \mathbb{C}^{M_t \times N_{RF}}$ are equal-gain vectors and $\v_q \in \mathbb{C}^{N_{RF}}$. The solution may be obtained using simple, yet effective suboptimal algorithm such as orthogonal matching pursuit (OMP) \cite{love15}\cite{noh17}\cite{Hussain17}. In the next section we continue with the solution of Problem~\ref{main_problem}, and~\ref{g_problem}.





% Comparing the expressions in equations \eqref{final_gik}, and, \eqref{dc}, a perfect solution to the optimization problem in \eqref{init_opt}, could be a pair $\textbf{(F, v)}$, for which the following equality holds.  



% \begin{align}
%     \mathbf{D}^{H} \mathbf{F} \mathbf{v}=\sum_{q \in \mathcal{W}_k}\sigma\left(\mathbf{e}_{q} \otimes \mathbf{g}_q\right) \label{potential_answer}
% \end{align}

% However, we have that $M_t > N_{RF}$ and therefore, the matrix $\textbf{D}^H \textbf{F}$ may not be full-rank, resulting in the RHS of equation \eqref{potential_answer} being in the null space of LHS. Therefore, given some $\g_q \in \mathcal{G}_L$ we formulate the following two-step optimization problem to search for $\textbf{(F, v)}$ that gets as close as possible to the desired value. 

% \begin{problem}

% a) For all $q \in \{1, \cdots, Q\}$, given $\g_q \in \mathcal{G}_L$, find the unit-norm vector $\c_q \in \mathbb{C}^{M_t}$ such that
% \begin{align}
% &\c^{|\g_q}_q=\underset{\c}{\arg \min } \lim_{L\longrightarrow \infty} \frac{1}{L}\left\|\left(\sum_{q \in \mathcal{W}_k}\sigma\left(\mathbf{e}_{q} \otimes \mathbf{g}_q\right)\right)- \mathbf{D}^{H} \c\right\|_{2}^{2} \label{obj_func}
% \end{align}

% \noindent
% b) For every given $\c_q$, find $\F_q \in \mathbb{C}^{M_t \times N_{RF}}$ , and $\v_q \in \mathbb{C}^{N_RF}$ that satisfy $\mathbf{F}_{q}\mathbf{v}_{q} = \c_q$ the condition $\f_n \in \mathcal{B}_{M_t}$ as in equation \eqref{f_constant_gain}. 

% \begin{align}
%     \mathbf{F}_{\mid \g_q}\mathbf{v}_{\mid \g_q} = \c_q
% \end{align}

% \end{problem}



Note that the solution to problem \ref{main_problem} is the limit of the sequence of solutions to a least-square optimization problem as $L$ goes to infinity. For each $L$ we find that,
 \begin{align}
& {\c}^{(L)}_k = \sum_{q \in \mathcal{W}_k}\sqrt{\gamma_q}(\D \D^H)^{-1} \D  \left(\mathbf{e}_q \otimes \mathbf{g}_q\right) \\
& {\c}^{(L)}_k = \sum_{q \in \mathcal{W}_k}\sigma_q \D_q\g_q \label{c_final_eq}
\end{align}
where $\sigma_q = \frac{\sqrt{ 2\pi \delta_q \frac{\delta_q}{\Delta_k}}}{L \sum_{p=1}^{2^B}\delta_p} = \frac{\delta_q}{L\sqrt{2\pi\Delta_k}}$, noting that it holds that, 

% $$\mathbf{D D}^{H}=\left({L \sum_{p=1}^{2^B}\delta_p}\right) \mathbf{I}_{M_{t}}$$.
% % Dividing by $\|\Tilde{\c}^{(L)}_q\|$ and taking the limit as L goes to infinity we will find the optimal $\c_q$. i.e. 


Using \eqref{c_final_eq}, equation \eqref{g_final_eq} can now be rewritten as, 

\begin{align}
 &\mathcal{G}_k = \underset{\mathcal{G}}{\arg\min } \nonumber
 \\&\left\| abs(\D^H \D\sum_{q \in \mathcal{W}_k}\sigma_q(\mathbf{e}_{q} \otimes \mathbf{g}_q))-abs(\sum_{q \in \mathcal{W}_k}\sqrt{\gamma_q}(\mathbf{e}_{q} \otimes \mathbf{g}_q))\right\|^{2} \label{g_simple_final_eq}
\end{align} 

% where $\sigma' = \frac{1}{2\pi L}$. We will state the following theorem without formal proof.
\begin{proposition}
The maximizer of \eqref{g_simple_final_eq} is in the form $\g_q = \left[{\begin{array}{cccc} 1& \alpha^\eta &\cdots & \alpha^{\eta (L -1)} \end{array}}\right]^T$ for some $\eta$ where $\alpha = e^{j(\frac{\delta_q}{L})}$. \label{proposiiton_g}
\end{proposition}

An analytical closed form solution for $\c_q$ can be found as follows. We have, 
 \begin{align}
     {\c_k}^{(L)} & = \sum_{q \in \mathcal{W}_k} \sigma_q \left(\sum_{l=1}^{L}g_{q, l}\mathbf{d}_{M_t}(\psi_{q, l})\right)  \nonumber\\
     & = \sum_{q \in \mathcal{W}_k} \left(\sum_{l=1}^L \sigma_qg_q^{(l)}\left[{\begin{array}{ccc}
     1 &\cdots & e^{j(M_t-1)\psi_{q, l}}\\
     \end{array}}\right]^T \right)  \nonumber\\
     & = \sum_{q \in \mathcal{W}_k} \sigma_q \left[{\begin{array}{ccc}
     \sum_{l=1}^L g_{q, l}& \cdots & \sum_{l=1}^L g_{q, l}e^{j(M_t-1)\psi_{q, l}}\\
     \end{array}}\right]^T 
\end{align}

 
Let us write, 

\begin{equation}
    \c_k^{(L)} = \sum_{q \in \mathcal{W}_k} \c_q^{(L)}
\end{equation}

where, 

\begin{equation}
{\c_q}^{(L)}  = \sigma_q \sum_{l=1}^{L}g_{q, l}\mathbf{d}_{M_t}(\psi_{q, l})
\end{equation}


Choosing $\g_q$ as in proposition \ref{proposiiton_g},  the $m$-th element of the vector ${\c}_q = \lim_{L\rightarrow \infty}{\c_q}^{(L)} $, i.e. $c_{q,m}$, is given by 

\begin{equation}
    c_{q,m} = \frac{\delta_q}{\sqrt{2\pi}\Delta_k}\lim_{L\rightarrow \infty} \frac{1}{L}\sum_{l=0}^{L-1} g_{q, l} e^{j(m\psi_{q, l+1})}
\end{equation}

% With a choice of $\g_q = \left[{\begin{array}{cccc} 1& \alpha^\eta &\cdots & \alpha^{\eta (L -1)} \end{array}}\right]^T$ where we set 
% % $\alpha = e^j(\frac{2\pi}{L2^B})$
% $\alpha = e^{j(\frac{\delta_q}{L})}$ and suitable $\eta$ (to be determined later), we can write


% \begin{equation}
%     \Tilde{c}_q^{(m)} = \lim_{L\longrightarrow \infty} \frac{1}{L}\sum_{l=0}^{L-1} g_l e^{jm(\psi_{q-1}+\frac{2 \pi(\ell+0.5)}{L2^B})}
% \end{equation}

\begin{equation}
    c_{q,m} = \frac{\delta_q}{\sqrt{2\pi}\Delta_k}\lim_{L\rightarrow \infty} \frac{1}{L}\sum_{l=0}^{L-1} g_{q, l} e^{jm(\psi_{q-1}+\frac{\delta_q(\ell+0.5)}{L})}
\end{equation}

% After some basic manipulations we get, 
\begin{equation}
    c_{q,m} = \frac{\delta_q}{\sqrt{2\pi}\Delta_k}\lim_{L\rightarrow \infty} \frac{1}{L}\sum_{l=0}^{L-1} \alpha^{(\eta+m) l} e^{jm(\psi_{q-1}+\frac{0.5\delta_q}{L})} 
\end{equation}


\begin{equation}
    c_{q,m} = \frac{\delta_q}{\sqrt{2\pi}\Delta_k}e^{jm(\psi_{q-1})}\lim_{L\longrightarrow \infty} \frac{1}{L}\sum_{l=0}^{L-1} \alpha^{(\eta+m) l}   
\end{equation}

\begin{equation}
    c_{q,m} = \frac{\delta_q}{\sqrt{2\pi}\Delta_k}e^{jm(\psi_{q-1})} \int_{0}^{1} \alpha^{(\eta + m)Lx}dx
\end{equation}


\begin{equation}
    c_{q,m} = \frac{\delta_q}{\sqrt{2\pi}\Delta_k}e^{jm(\psi_{q-1})} \int_{0}^{1} e^{j\frac{2\pi(\eta + m)L}{L2^B}x}dx
\end{equation}


\begin{align}
 c_{q,m} &= \frac{\delta_q}{\sqrt{2\pi}\Delta_k}e^{jm\psi_{q-1}} \int_{0}^{1} e^{j\xi x}dx \nonumber \\
 &= \frac{\delta_q}{\sqrt{2\pi}\Delta_k}e^{j(m\psi_{q-1} + \frac{\xi}{2})} sinc(\frac{\xi}{2\pi}) \label{final_g}
\end{align}

where $\xi = \delta_q (\eta +m )$.


% \begin{equation}
%     c_{q,m} = e^{jm(\psi_{q-1})} \frac{e^{j\xi}-1}{j\xi}
% \end{equation}

% \begin{equation}
%     c_{q,m} = e^{j(m\psi_{q-1} + \frac{\xi}{2})} \frac{e^{j\xi/2}-e^{-j\xi/2}}{j\xi/2}
% \end{equation}

% \begin{equation}
%     c_{q,m} = e^{j(m\psi_{q-1} + \frac{\xi}{2})} sinc(\frac{\xi}{2\pi}) \label{final_g}
% \end{equation}






% Note that the solution to part \textit{(a)} is the limit of the sequence of solutions to a least-square optimization problem as $L$ goes to infinity.
%  \begin{align}
% & \Tilde{\c}^{(L)}_q = (\D \D^H)^{-1} \D \sigma \left(\mathbf{e}_q \otimes \mathbf{g}_q\right) \\
% & \Tilde{\c}^{(L)}_q =  \sigma' \D \left(\mathbf{e}_q \otimes \mathbf{g}_q\right) = \sigma' \D_q\g_q
% \end{align}
% Dividing by $\|\Tilde{\c}^{(L)}_q\|$ and taking the limit as L goes to infinity we will find the optimal $\c_q$. i.e. 

% \begin{equation}
%     \c_q = \lim_{L\longrightarrow \infty} \frac{\Tilde{\c}^{(L)}_q}{L\|\Tilde{\c}^{(L)}_q\|}
% \end{equation}

% We aim to find $\g_q$ such that

% \begin{align}
% & \left\| abs(\D^H \gamma' \D_q \mathbf{g}_q)- abs(\gamma \left(\mathbf{e}_{q} \otimes \mathbf{g}_q\right)) \right\|_{2}^{2}
% \end{align}

% is minimized.

% % Is it possible to show that $\g_q$ is independent of $q$ (assume regular scenario)? If true, i.e., $\g_q = \g$ we have

% We will provide a suboptimal structure for the choice of $\g$. Let us assume $\g_q = \g, $  for all $ q \in \{1, \cdots, Q\}$. Then we can write
% \begin{align}
%      &\Tilde{\c_q}^{(L)} = D_q\mathbf{g} = \sum_{l=1}^{L}g_l\mathbf{d}_{M_t}(\psi_{q, l})  \nonumber\\
%      & = \sum_{l=1}^L g_l\left[{\begin{array}{cccc}
%      1& e^{j\psi_{q, l}} &\cdots & e^{j(M_t-1)\psi_{q, l}}\\
%      \end{array}}\right]^T  = \nonumber\\
%      & \left[{\begin{array}{cccc}
%      \sum_{l=1}^L g_l& \sum_{l=1}^L g_le^{j\psi_{q, l}} &\cdots & \sum_{l=1}^L g_le^{j(M_t-1)\psi_{q, l}}\\
%      \end{array}}\right]^T
%  \end{align}
 
 

%  We have for the $m$-th element of the vector $\Tilde{\c}_q$, i.e. $\Tilde{c}^{(m)}_q$  for $ 0 \leq m \leq M_t-1$

% \begin{equation}
%     \Tilde{c}_q^{(m)} = \lim_{L\longrightarrow \infty} \frac{1}{L}\sum_{l=0}^{L-1} g_l e^{j(m\psi_{q, l+1})}
% \end{equation}

% With a choice of $\g = \left[{\begin{array}{cccc} 1& \alpha^\eta &\cdots & \alpha^{\eta (L -1)} \end{array}}\right]^T$ where we set 
% % $\alpha = e^j(\frac{2\pi}{LQ})$
% $\alpha = e^j(\frac{\psi_{q}-\psi_{q-1}}{L})$ and suitable $\eta$ (to be determined later), we can write


% % \begin{equation}
% %     \Tilde{c}_q^{(m)} = \lim_{L\longrightarrow \infty} \frac{1}{L}\sum_{l=0}^{L-1} g_l e^{jm(\psi_{q-1}+\frac{2 \pi(\ell+0.5)}{LQ})}
% % \end{equation}

% \begin{equation}
%     \Tilde{c}_q^{(m)} = \lim_{L\longrightarrow \infty} \frac{1}{L}\sum_{l=0}^{L-1} g_l e^{jm(\psi_{q-1}+\frac{(\psi_{q}-\psi_{q-1})(\ell+0.5)}{L})}
% \end{equation}

% \begin{equation}
%     c_q^{(m)} = \lim_{L\longrightarrow \infty} \frac{1}{L}\sum_{l=0}^{L-1} \alpha^{(\eta+m) l} e^{jm(\psi_{q-1}+\frac{0.5(\psi_{q}-\psi_{q-1})}{L})} 
% \end{equation}


% \begin{equation}
%     c_q^{(m)} = e^{jm(\psi_{q-1})}\lim_{L\longrightarrow \infty} \frac{1}{L}\sum_{l=0}^{L-1} \alpha^{(\eta+m) l}   
% \end{equation}

% \begin{equation}
%     c_q^{(m)} = e^{jm(\psi_{q-1})} \int_{0}^{1} \alpha^{(\eta + m)Lx}dx
% \end{equation}


% % \begin{equation}
% %     c_q^{(m)} = e^{jm(\psi_{q-1})} \int_{0}^{1} e^{j\frac{2\pi(\eta + m)L}{LQ}x}dx
% % \end{equation}


% \begin{equation}
%     c_q^{(m)} = e^{jm(\psi_{q-1})} \int_{0}^{1} e^{j\xi x}dx
% \end{equation}

% where $\xi = (\psi_{q}-\psi_{q-1}) (\eta +m )$.


% \begin{equation}
%     c_q^{(m)} = e^{jm(\psi_{q-1})} \frac{e^{j\xi}-1}{j\xi}
% \end{equation}

% \begin{equation}
%     c_q^{(m)} = e^{j(m\psi_{q-1} + \frac{\xi}{2})} \frac{e^{j\xi/2}-e^{-j\xi/2}}{j\xi/2}
% \end{equation}

% \begin{equation}
%     c_q^{(m)} = e^{j(m\psi_{q-1} + \frac{\xi}{2})} sinc(\frac{\xi}{2\pi})
% \end{equation}

% where, $sinc(t) = \frac{sin(\pi t)}{\pi t}$.
















% We first optimize for $\alpha$ by setting the derivative of \eqref{obj_func} to zero, to get: 

% $$\hat{\alpha}=\frac{\sum_{q \in \mathcal{W}_k}\sqrt{\frac{Q}{M_{t}}}(\mathbf{F} \mathbf{v})^{H} \mathbf{D}_{q} \mathbf{g}_q}{\left\|\mathbf{D}^{H} \mathbf{F} \mathbf{v}\right\|_{2}^{2}}$$

% Replacing the value of $\alpha$ as above we get to the following optimization problem. 

% \begin{align}
% \left(\mathbf{F}_{\mid \mathbf{g}}, \mathbf{v}_{\mid \mathbf{g}}\right) &=\underset{\mathbf{F}, \mathbf{v}}{\arg \max } \frac{\left|\sum_{q \in \mathcal{W}_k}\sqrt{\frac{2^{\mathbf{B}}}{M_{t}}}\left(\mathbf{D}_{q} \mathbf{g}_q\right)^{H} \mathbf{F} \mathbf{v}\right|^{2}}{\left\|\mathbf{D}^{H} \mathbf{F} \mathbf{v}\right\|_{2}^{2}} \nonumber \\
% &=\underset{\mathbf{F}, \mathbf{v}}{\arg \max }\left|\sum_{q \in \mathcal{W}_k}\left(\mathbf{D}_{q} \mathbf{g}\right)^{H} \mathbf{F} \mathbf{v}\right|^{2}
% \end{align}


% \section{Codebook Design Problem Formulation}
% \label{sec: formulation}

% % Let $\mathbf{c} \doteq \mathbf{F} \mathbf{v} \in \mathbb{C}^{M_{t}}$ be the unit-norm transmit beam-forming codeword, where analog beamsteering matrix $\mathbf{F}=\left[\mathbf{f}_{1}, \cdots, \mathbf{f}_{N_{R F}}\right] \in \mathbb{C}^{M_{t} \times N_{R F}}$ contains $N_{RF}$ equal-gain analog beamsteering vectors $\mathbf{f}_{n}$ and the baseband beamforming vector $\mathbf{v} \in \mathbb{C}^{N_{R F}}$ is such that $\|\c\|_{2}=1$ holds. The equal-gain constraint holds if $\mathbf{f}_{n} \in \mathcal{B}_{M_{t}}$ for 

% % \begin{equation}
% %     \mathcal{B}_{M_{t}}=\left\{\mathbf{w} \in \mathbb{C}^{M_{t}}:\left(\mathbf{w} \mathbf{w}^{H}\right)_{\ell, \ell}=1 / M_{t}, 1 \leq \ell \leq M_{t}\right\}
% %     \label{f_constant_gain}
% % \end{equation}

% % Let $\mathcal{C}=\left\{\mathbf{c}_{1}, \cdots, \mathbf{c}_{Q}\right\}$ be the codebook with codewords taking value as $\mathbf{c}_{q}=\mathbf{F}_{q} \mathbf{v}_{q}$. Consider a half-wavelength uniform linear array (ULA) of antennas as in the previous subsection, i.e. $d = \frac{\lambda}{2}$, with an array response vector as in \eqref{array_factor}.

% % % %$$\mathbf{d}_{M_{t}}(\psi)=\frac{1}{\sqrt{M_{t}}}\left[1 e^{j \psi} \cdots e^{j\left(M_{t}-1\right) \psi}\right]^{T} \in \mathbb{C}^{M_{t}}$$
% % % $$\mathbf{d}_{M_{t}}(\psi)=\left[1, e^{j \psi}, \cdots, e^{j\left(M_{t}-1\right) \psi}\right]^{T} \in \mathbb{C}^{M_{t}}$$

%  For convenience, in this section, we will drop the index \emph{ula} from the expression of the array factor $\d_{ula, M_t}(\psi)$ and gain $G^{ula}(\psi, \mathbf{c})$.  Before presenting the formulation of the codebook design problem, we introduce some new notations. We divide the angular range of $\theta \in [-\pi, 0]$  into equal-length beams $\omega_{q} \text { for } q \in\left\{1, \cdots, Q\right\}$. i.e. 
% $$
% \begin{aligned}
% \omega_{q} &=\left[\theta_{q-1}, \theta_{q}\right) ,& \theta_{q}= -\pi+ \frac{ \pi}{Q} q
% \end{aligned}
% $$

% % Further we introduce the change of variable $\psi = \frac{2 \pi d}{\lambda} \cos(\theta)$ where $\psi \in [-\pi, \pi]$. For $d = \frac{\lambda}{2}$,

% Corresponding to $\omega_q$ intervals, there exists $\nu_q$ ranges with respect to $\psi$ such that, 

% $$
% \begin{aligned}
% \nu_{q} &=\left[\psi_{q-1}, \psi_{q}\right), & \psi_q = -\pi\cos(\frac{\pi}{Q}q)
% \end{aligned}
% $$


% Under the reference gain as in \eqref{reference gain} and using Parseval's theorem \cite{parseval}, we will have:
% % and assuming $|\c| = 1$
% \begin{equation}
% \int_{-\pi}^{\pi} G(\psi, \mathbf{c}) d \psi=2 \pi\left\| \mathbf{c}\right\|^{2}=2 \pi\label{parseval}
% \end{equation}

% Let  $G_{\text {ideal }, q}(\psi)$ denote the desired ideal gain which is supposed to be constant on $\nu_q$ and zero otherwise. It must hold that, 
% % \begin{equation}
% % \int_{-\pi}^{\pi} G(\psi, \mathbf{c}) d \psi=2 \pi\left\|\frac{1}{\sqrt{M_{t}}} \mathbf{c}\right\|_{2}^{2}=\frac{2 \pi}{M_{t}}    \label{parseval}
% % \end{equation}





% \begin{align}
% &\int_{-\pi}^{\pi} G_{\text {ideal }, q}(\psi) d \psi =\int_{\nu_{q}} t d \psi+\int_{[-\pi, \pi] \backslash \nu_{q}} 0 d \psi \nonumber\\
% &=(\psi_q - \psi_{q-1}) t={2 \pi} \label{plain}
% \end{align}

% which in turn will give: 

% \begin{equation}
%     G_{\text {ideal }, q}(\psi)=\frac{2\pi}{(\psi_q - \psi_{q-1})} \mathds{1}_{\nu_{q}}(\psi), \quad \psi \in[-\pi, \pi] \label{ideal_gain}
% \end{equation}

% We aim to design the codebooks so as to mimic the ideal gain computed in equation \eqref{ideal_gain}. Therefore, the plain codebook design problem is formulated as a minimization of a MSE as follows: 


% % \begin{align}
% % &\left(\mathbf{F}_{\text {opt }, q}, \mathbf{v}_{\mathrm{opt}, q}\right) \nonumber \\&=\underset{\mathbf{F}, \mathbf{v}}{\arg \min } \int_{-\pi}^{\pi}\left|G_{\text {ideal }, q}(\psi)-G(\psi, \mathbf{F} \mathbf{v})\right|^{2} d \psi
% % \end{align}

% \begin{align}
% &\c_q^{opt}=\underset{\c, \|\c\|=1}{\arg \min } \int_{-\pi}^{\pi}\left|G_{\text {ideal }, q}(\psi)-G(\psi, \c)\right| d \psi
% \label{composite_MSE}
% \end{align}

% By uniformly sampling on the range of $\psi$ we can rewrite the optimization problem as follows, 
% \begin{align}
%     &\underset{\c, \|\c\|=1}{\arg \min }\left[\lim _{L \rightarrow \infty} \sum_{p=1}^{Q} \delta_p \sum_{\ell=1}^{L} \frac{\left|G_{\text {ideal }, q}\left(\psi_{p, \ell}\right)-G\left(\psi_{p, \ell}, \c \right)\right|}{L}\right]\label{equivalent_MSE}
% \end{align}

%  where for $q = 1 \ldots Q$, 
%  $$\delta_q = \psi_{q}-\psi_{q-1}, \quad \psi_{q, \ell}=\psi_{q-1}+\frac{\delta_q(\ell-0.5)}{L} $$

 
%  We can write equation \eqref{equivalent_MSE}, as 
%  \begin{align}
%  &\c_q^{opt} = \underset{\c,  \|\c\|=1}{\arg \min } \lim_{L\rightarrow \infty}\frac{1}{L}\left\|\mathbf{G}_{\text {ideal }, q}-\mathbf{G}(\c)\right\| \label{init_opt}
%  \end{align}
 
%  where,  $$\mathbf{G}(\c)=\left[{\delta_1} G\left(\psi_{1,1}, \c\right) \ldots {\delta_{Q}}G\left(\psi_{Q, L}, \c\right)\right]^{T} \in \mathbb{Z}^{L Q}$$

% and, 
% $$ \mathbf{G}_{\text {ideal }, q}=\left[{\delta_1} G_{\text {ideal }, q}\left(\psi_{1,1}\right) \ldots {\delta_{Q}}G_{\text {ideal }, q}\left(\psi_{Q, L}\right)\right]^{T} \in \mathbb{Z}^{L Q}$$

% Note that it holds that 

% \begin{equation}
%     \mathbf{G}_{\text {ideal }, q}={2\pi}\left(\mathbf{e}_{q} \otimes \mathbf{1}_{L, 1}\right) \label{ideal}
% \end{equation}

% with $\mathbf{e}_{q} \in \mathbb{Z}^{Q}$ being the standard basis vector for the $q$-th axis among $Q$ ones. Now, note that $\mathbf{1}_{L, 1}=\mathbf{g} \odot \mathbf{g}^{*}$ for any equal gain $\mathbf{g} \in \mathbb{C}^L$. Therefore, for a suitable choice of $\g$ we can write: 

% % $$\mathcal{G}_{L}=\left\{\mathbf{g} \in \mathbb{C}^{L}:\left(\mathbf{g} \mathbf{g}^{H}\right)_{\ell, \ell}=1,1 \leq \ell \leq L\right\}$$


% \begin{align}
% \mathbf{G}_{\text {ideal }, q} &={2\pi}\left(\mathbf{e}_{q} \otimes\left(\mathbf{g} \odot \mathbf{g}^{*}\right)\right) \nonumber\\
% &=\left(\sqrt{2\pi}\left(\mathbf{e}_{q} \otimes \mathbf{g}\right)\right) \odot\left(\sqrt{{2\pi}}\left(\mathbf{e}_{q} \otimes \mathbf{g}\right)\right)^{*} \label{g_id_q_equivalent}
% \end{align}


% Similarly, it is straightforward to observe,


% \begin{align}
% \mathbf{G}(\c) &=\left(\mathbf{D}^{H} \c\right) \odot\left(\mathbf{D}^{H} \c\right)^{*} \label{dc}
% \end{align}
% where $\mathbf{D} =\left[\sqrt{\delta_1}\mathbf{D}_{1} \cdots \sqrt{\delta_{Q}}\mathbf{D}_{Q} \right] \in \mathbb{C}^{M_{t} \times L Q}$, and 
% $\mathbf{D}_{q}=\left[\mathbf{d}_{M_{t}}\left(\psi_{q, 1}\right) \cdots \mathbf{d}_{M_{t}}\left(\psi_{q, L}\right)\right] \in \mathbb{C}^{M_{t} \times L}.$
 

% % Comparing the expressions in equations \eqref{g_id_q_equivalent} and \eqref{dc},  we formulate the following two-step optimization for the codebook design problem for hybrid beamforming, presented below as \textit{Problem \ref{main_problem}}. Given a suitable $\g_q$, in the first step, we search for a unit-norm codeword $\c_q$ for fully-digital beamforming, and in the second step we find a suitable pair $(\F_q, \v_q)$ to complete the hybrid beamforming codebook design.  

 

% % \begin{problem}

% % a) For all $q \in \{1, \cdots, Q\}$, given equal-gain $\g_q \in \mathbb{C}^L$, find vector $\c_q \in \mathbb{C}^{M_t}$ such that
% % \begin{align}
% % &\c_q=\underset{\c, \|c\|=1}{\arg \min } \lim_{L\longrightarrow \infty} \left\|\sqrt{2\pi}\left(\mathbf{e}_{q} \otimes \mathbf{g}_q\right)- \mathbf{D}^{H} \c\right\|^{2} \label{obj_func}
% % \end{align}

% % \vspace{2mm}
% % \noindent
% % b) Find $\F_q \in \mathbb{C}^{M_t \times N_{RF}}$ , and $\v_q \in \mathbb{C}^{N_{RF}}$ that solve $\mathbf{F}_{q}\mathbf{v}_{q} = \c_q$ subject to the equal-gain condition on the columns of $\F_q$. 

% % % \begin{align}
% % %     \mathbf{F}_{\mid \g_q}\mathbf{v}_{\mid \g_q} = \c_q
% % % \end{align}
% % \label{main_problem}
% % \end{problem}

% % The solution to the last problem provides the optimal codebook designed for hybrid beamforming under a ULA structure, given the choice of $\g_q$. Note that we were initially trying to solve the optimization problem in equation \eqref{init_opt}. In light of modifications \eqref{g_id_q_equivalent}, and \eqref{dc}, the quantity to be minimized in the limit of equation \eqref{init_opt} can be written as follows,

% % \begin{align}
% %     & \left\|\mathbf{G}_{\text {ideal }, q}-\mathbf{G}(\c)\right\| = \left\| abs(\D^H \c_q)- \sqrt{2\pi} abs(\mathbf{e}_{q} \otimes \mathbf{g})\right\| \label{g_init}
% % \end{align}
% % where $abs(.)$ denotes the element-wise absolute value of a vector.

% % Equation \eqref{g_init} reveals the central role of the vector $\g_q$ in minimizing the MSE in equation \eqref{init_opt}. In fact, the choice of $\g_q$ has to be optimized in a way that norm in \eqref{g_init} is minimized; i.e. the result gain designed by codebook $\c_q$ gets as close as possible to the ideal gain. To optimize the choice of $\g_q$, we formulate the following optimization problem, presented as \textit{Problem \ref{g_problem}}.

% % \begin{problem}
% % For all $q = 1, \ldots, Q$, find equal-gain $\g_q \in \mathbb{C}^L$ such that

% % \begin{equation}
% %  \g_q = \underset{\g}{\arg\min }\left\| abs(\D^H \c_q)- \sqrt{2\pi} abs(\mathbf{e}_{q} \otimes \mathbf{g})\right\|^{2} \label{g_final_eq}
% % \end{equation} 

% % \label{g_problem}
% % \end{problem}

% % In the next session we propose our approach to solve problems \ref{main_problem} and \ref{g_problem}.

% %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Comparing the expressions \eqref{init_opt}, \eqref{g_id_q_equivalent}, and \eqref{dc}, one can show that the optimal choice of $\c_q$ in \eqref{init_opt} is the solution to the following optimization problem for a proper choice of $\g_q$. 
% \begin{problem}
% Given an equal-gain vector $\g_q \in \mathbb{C}^L$, $q \in \{1, \cdots, Q\}$, find vector $\c_q \in \mathbb{C}^{M_t}$ such that
% \begin{align}
% &\c_q=\underset{\c, \|c\|=1}{\arg \min } \lim_{L\longrightarrow \infty} \left\|\sqrt{2\pi}\left(\mathbf{e}_{q} \otimes \mathbf{g}_q\right)- \mathbf{D}^{H} \c\right\|^{2} \label{obj_func}
% \end{align}
% \label{main_problem}
% \end{problem}
% However, we now need to find the optimal choice of $\g_q$ that minimizes the objective in \eqref{init_opt}. Using \eqref{g_id_q_equivalent}, and \eqref{dc}, we have the following optimization problem.
% \begin{problem}
% Find equal-gain $\g_q \in \mathbb{C}^L$, $q = 1, \ldots, Q$, such that
% \begin{equation}
%  \g_q = \underset{\g}{\arg\min }\left\| abs(\D^H \c_q)- \sqrt{2\pi} abs(\mathbf{e}_{q} \otimes \mathbf{g})\right\|^{2} \label{g_final_eq}
% \end{equation} 
% where $abs(.)$ denotes the element-wise absolute value of a vector.
% \label{g_problem}
% \end{problem}

% Hence, the codebook design for a system with full-digital beamforming capability is found by solving Problem~\ref{main_problem} for proper choice of $\g_q$ obtained as a solution to Problem ~\ref{g_problem}. The codebook for Hybrid beamforming, is then found as
% \begin{align}
%     \underset{\mathbf{F}_{q},\mathbf{v}_{q}}{\arg\min } \|\mathbf{F}_{q}\mathbf{v}_{q} - \c_q\|^2
% \end{align}
% where the columns of $\F_q \in \mathbb{C}^{M_t \times N_{RF}}$ are equal-gain vectors and $\v_q \in \mathbb{C}^{N_{RF}}$. The solution may be obtained using simple, yet effective suboptimal algorithm such as orthogonal matching pursuit (OMP) \cite{love15}\cite{noh17}\cite{Hussain17}. In the next section we continue with the solution of Problem~\ref{main_problem}, and~\ref{g_problem}.


% %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% % Note that the solution to part \textit{(a)} is the limit of the sequence of solutions to a least-square optimization problem as $L$ goes to infinity.
% %  \begin{align}
% % & \Tilde{\c}^{(L)}_q = (\D \D^H)^{-1} \D \sigma \left(\mathbf{e}_q \otimes \mathbf{g}_q\right) \\
% % & \Tilde{\c}^{(L)}_q =  \sigma' \D \left(\mathbf{e}_q \otimes \mathbf{g}_q\right) = \sigma' \D_q\g_q
% % \end{align}
% % Dividing by $\|\Tilde{\c}^{(L)}_q\|$ and taking the limit as L goes to infinity we will find the optimal $\c_q$. i.e. 

% % \begin{equation}
% %     \c_q = \lim_{L\longrightarrow \infty} \frac{\Tilde{\c}^{(L)}_q}{L\|\Tilde{\c}^{(L)}_q\|}
% % \end{equation}

% % We aim to find $\g_q$ such that

% % \begin{align}
% % & \left\| abs(\D^H \gamma' \D_q \mathbf{g}_q)- abs(\gamma \left(\mathbf{e}_{q} \otimes \mathbf{g}_q\right)) \right\|_{2}^{2}
% % \end{align}

% % is minimized.

% % % Is it possible to show that $\g_q$ is independent of $q$ (assume regular scenario)? If true, i.e., $\g_q = \g$ we have

% % We will provide a suboptimal structure for the choice of $\g$. Let us assume $\g_q = \g, $  for all $ q \in \{1, \cdots, Q\}$. Then we can write
% % \begin{align}
% %      &\Tilde{\c_q}^{(L)} = D_q\mathbf{g} = \sum_{l=1}^{L}g_l\mathbf{d}_{M_t}(\psi_{q, l})  \nonumber\\
% %      & = \sum_{l=1}^L g_l\left[{\begin{array}{cccc}
% %      1& e^{j\psi_{q, l}} &\cdots & e^{j(M_t-1)\psi_{q, l}}\\
% %      \end{array}}\right]^T  = \nonumber\\
% %      & \left[{\begin{array}{cccc}
% %      \sum_{l=1}^L g_l& \sum_{l=1}^L g_le^{j\psi_{q, l}} &\cdots & \sum_{l=1}^L g_le^{j(M_t-1)\psi_{q, l}}\\
% %      \end{array}}\right]^T
% %  \end{align}
 
 

% %  We have for the $m$-th element of the vector $\Tilde{\c}_q$, i.e. $\Tilde{c}^{(m)}_q$  for $ 0 \leq m \leq M_t-1$

% % \begin{equation}
% %     \Tilde{c}_q^{(m)} = \lim_{L\longrightarrow \infty} \frac{1}{L}\sum_{l=0}^{L-1} g_l e^{j(m\psi_{q, l+1})}
% % \end{equation}

% % With a choice of $\g = \left[{\begin{array}{cccc} 1& \alpha^\eta &\cdots & \alpha^{\eta (L -1)} \end{array}}\right]^T$ where we set 
% % % $\alpha = e^j(\frac{2\pi}{LQ})$
% % $\alpha = e^{j(\frac{\psi_{q}-\psi_{q-1}}{L})}$ and suitable $\eta$ (to be determined later), we can write


% % % \begin{equation}
% % %     \Tilde{c}_q^{(m)} = \lim_{L\longrightarrow \infty} \frac{1}{L}\sum_{l=0}^{L-1} g_l e^{jm(\psi_{q-1}+\frac{2 \pi(\ell+0.5)}{LQ})}
% % % \end{equation}

% % \begin{equation}
% %     \Tilde{c}_q^{(m)} = \lim_{L\longrightarrow \infty} \frac{1}{L}\sum_{l=0}^{L-1} g_l e^{jm(\psi_{q-1}+\frac{(\psi_{q}-\psi_{q-1})(\ell+0.5)}{L})}
% % \end{equation}

% % \begin{equation}
% %     c_q^{(m)} = \lim_{L\longrightarrow \infty} \frac{1}{L}\sum_{l=0}^{L-1} \alpha^{(\eta+m) l} e^{jm(\psi_{q-1}+\frac{0.5(\psi_{q}-\psi_{q-1})}{L})} 
% % \end{equation}


% % \begin{equation}
% %     c_q^{(m)} = e^{jm(\psi_{q-1})}\lim_{L\longrightarrow \infty} \frac{1}{L}\sum_{l=0}^{L-1} \alpha^{(\eta+m) l}   
% % \end{equation}

% % \begin{equation}
% %     c_q^{(m)} = e^{jm(\psi_{q-1})} \int_{0}^{1} \alpha^{(\eta + m)Lx}dx
% % \end{equation}


% % % \begin{equation}
% % %     c_q^{(m)} = e^{jm(\psi_{q-1})} \int_{0}^{1} e^{j\frac{2\pi(\eta + m)L}{LQ}x}dx
% % % \end{equation}


% % \begin{equation}
% %     c_q^{(m)} = e^{jm(\psi_{q-1})} \int_{0}^{1} e^{j\xi x}dx
% % \end{equation}

% % where $\xi = (\psi_{q}-\psi_{q-1}) (\eta +m )$.


% % \begin{equation}
% %     c_q^{(m)} = e^{jm(\psi_{q-1})} \frac{e^{j\xi}-1}{j\xi}
% % \end{equation}

% % \begin{equation}
% %     c_q^{(m)} = e^{j(m\psi_{q-1} + \frac{\xi}{2})} \frac{e^{j\xi/2}-e^{-j\xi/2}}{j\xi/2}
% % \end{equation}

% % \begin{equation}
% %     c_q^{(m)} = e^{j(m\psi_{q-1} + \frac{\xi}{2})} sinc(\frac{\xi}{2\pi})
% % \end{equation}

% % where, $sinc(t) = \frac{sin(\pi t)}{\pi t}$.

% % \subsection{Twin-ULA Setting}

% % We start from problem \eqref{main_problem}, and particularly, equation \eqref{obj_func}. Let $\{\s_m\}_{m =0}^{M_t -1}$ denote the columns of $D^H$. We can write: 

% % \begin{align}
% % &\s_m c_q^{(m)} + \s_{m+M_t/2} c_q^{(m+M_t/2)} \nonumber\\
% % &= \s_m (c_q^{(m)} + e^{-j \frac{2\pi d_y}{\lambda} \sin(\theta)} c_q^{(m+M_t/2)}) \nonumber\\
% % & \approx \s_m \Tilde{c}_q^{(m)}, \quad  m = 0 \ldots \frac{M_t}{2}-1\end{align}

% % where we define 
% % \begin{equation}
% %     \Tilde{c}_q^{(m)} = c_q^{(m)} + e^{-j \frac{2\pi d_y}{\lambda} \sin(\theta^{(m)}_q)} c_q^{(m+M_t/2)} \label{c_defn}
% % \end{equation}

% % with $\theta_{q-1}\leq\theta^{(m)}_q \leq \theta_{q}$ being a constant value.  

% % Therefore, the solution to part $(a)$ of problem \eqref{main_problem}, under the twin-ULA setup can be expressed as:

% %  \begin{align}
% % & \Tilde{\c}_q = (\Tilde{\D} \Tilde{\D}^H)^{-1} \Tilde{\D} \sigma \left(\mathbf{e}_q \otimes \mathbf{g}_q\right) \\
% % & \Tilde{\c}_q =  \sigma' \Tilde{\D} \left(\mathbf{e}_q \otimes \mathbf{g}_q\right) = \sigma' \Tilde{\D}_q\g_q
% % \end{align}

% % where it holds that $\Tilde{\D} \Tilde{\D}^H = \I_{\frac{M_t}{2}}$, and


% % $$\Tilde{\D}_{q}=\left[\d_{\frac{M_{t}}{2}}\left(\psi_{q, 1}\right) \cdots \d_{\frac{M_{t}}{2}}\left(\psi_{q, L}\right)\right] \in \mathbb{C}^{\frac{M_{t}}{2} \times L}$$

% % In other words, one can approximately think of the codebook design problem over a twin ULA of $M_t$ antennas, as such a problem over a ULA of size $\frac{M_t}{2}$.

% % Following the approach in the previous subsection, we can infer, 

% % \begin{equation}
% %     \Tilde{c}_q^{(m)} = e^{j(m\psi_{q-1} + \frac{\xi}{2})} sinc(\frac{\xi}{2\pi}), \quad m = 0 \ldots \frac{M_t}{2} -1
% %     \label{twin_c_result}
% % \end{equation}

% % Having $d_y = \frac{\lambda}{3}$, equating equations \eqref{c_defn}, and \eqref{twin_c_result}, by further assuming $c_q^{(m + \frac{M_t}{2})} = e^{j\beta_m} c_q^{(m)}$, after basic operations we get: 

% % \begin{equation}
% %     c_q^{(m)} = \frac{e^{j(m\psi_{q-1} + \frac{\xi}{2})} sinc(\frac{\xi}{2\pi})}{1+ e^{-j(\frac{2\pi}{3}\sin(\theta_q^{(m)}) + \beta_m)}}
% % \end{equation}

% % % \begin{equation}
% % %     c_q^{(m)} = \frac{e^{j(m\psi_{q-1} + \frac{\xi}{2} +\frac{\pi}{3}\sin(\theta_q^{(m)})+\frac{\beta_m}{2}) sinc(\frac{\xi}{2\pi})}}{2\cos(\frac{\pi}{3}\sin(\theta_q^{(m)}) + \frac{\beta_m}{2})}
% % % \end{equation}

% % Therefore, for each codeword entry $c_q^{(m)}$, it remains to pick $\beta_m$ and $\theta_q^{(m)}$. We relax this decision by setting $\beta_m = \beta$, and $\theta_q^{(m)} = \theta_q$, $ m = 1 \ldots M_t$. Next we explicitly right the expression for the reference gain as $G(\theta, \c_{twin}) = \left|\d_{twin, M_{t}}^{H}(\theta) \c_{twin}\right|^{2}$ where 

% % \begin{align}
% %     &\d_{twin, M_{t}}(\theta) = \left[\d_{\frac{M_{t}}{2}}^{T}(\theta), e^{j(\frac{2\pi}{3}\sin(\theta))}\d_{\frac{M_{t}}{2}}^{T}(\theta)\right]^T\\
% %     & \c_{twin} = \left[\c^T_{twin, \frac{M_t}{2}}, e^{j\beta}\c^T_{twin, \frac{M_t}{2}}\right]^T
% % \end{align}

% % We can  therefore write, 

% % \begin{align}
% %     G(\theta, \c_{twin}) &= \left|\d_{\frac{M_{t}}{2}}^{H}(\theta)\c_{twin, \frac{M_t}{2}} (1 + e^{j(\beta-\frac{2\pi}{3}\sin(\theta))})\right|^2\nonumber\\
% %     & = \left|\d_{\frac{M_{t}}{2}}^{H}(\theta)\c\right|^2 \left| \frac{1 + e^{j(\beta-\frac{2\pi}{3}\sin(\theta))}}{1 + e^{-j(\beta+\frac{2\pi}{3}\sin(\theta))}}\right|^2
% % \end{align}

% % Further define 
% % $$ L(\theta) = \left| \frac{1 + e^{j(\beta-\frac{2\pi}{3}\sin(\theta))}}{1 + e^{-j(\beta+\frac{2\pi}{3}\sin(\theta))}}\right|$$
% % The last equation consists of two parts, the first part being the gain corresponding to a ULA of size $\frac{M_t}{2}$ and the second part being  $L^2(\theta)$. For any $\omega_q = \left[\theta_{q-1}, \theta_{q}\right)$, there exist a $\omega'_q \doteq \left(- \theta_{q}, -\theta_{q-1}\right]$. The gain of a ULA is symmetric over $\omega_q$, and $\omega'_q$ by definition. However utilizing a twin ULA we wish to suppress the gain over $\omega'_q$ as much as we can and contribute to the gain over $\omega_q$ for each codeword $c_q, \quad q = 1\ldots Q$. To this end, we define the \emph{isolation factor} $\mu$ as follows,

% % \begin{align}
% %     \mu = \underset{\omega_q}{\int}{\frac{L(-\theta)}{L(\theta)}} d\theta
% % \end{align}
% %  to denote the level of isolation between each $\omega_q$ and its counterpart.
 
 















% % % \subsection{Composite Codebook Design Problem}

% % % Let us define a \textit{composite beam} $\omega_k$ as a union of multiple disjoint, possibly non-neighboring beams $\nu_{q} \text { for } q \in \mathcal{Q} = \left\{1, \cdots, Q\right\}$. Let $\mathcal{C'}=\left\{\mathbf{c}_{1}, \cdots, \mathbf{c}_{K}\right\}$ be the codebook corresponding to the composite problem.

% % % % $$\bigcup_{k = 1}^{2^{B'}}{\omega_k} = [-\pi, \pi], \quad \text{and} \quad \omega_k \cap \omega_l = \emptyset, \quad \forall k\neq l.$$

% % % Moreover, define for each composite beam $\omega_k$ the set $\mathcal{W}_k \subseteq \mathcal{Q}$ to be the set of indices of the single beams that form $\omega_k$. i.e. $\mathcal{W}_k = \{q \in \mathcal{Q}: v_q \subseteq \omega_k\}$. 
% % % We have then for the new ideal gain for each new codeword $\textbf{c}_k$, 

% % % \begin{align}
% % % &\int_{-\pi}^{\pi} G_{\text {ideal }, k}(\psi) d \psi =\int_{\omega_{k}} t' d \psi+\int_{[-\pi, \pi] \backslash \omega_{k}} 0 d \psi \nonumber\\
% % % &= \sum_{q \in {\mathcal{W}_k}}{\int_{\nu_{q}} t' d \psi} = |\mathcal{W}_k|\frac{2 \pi}{Q} t'=\frac{2 \pi}{M_{t}} \label{composite}
% % % \end{align}

% % % Therefore, $t' = \frac{Q}{|\mathcal{W}_k| M_t}$. It follows that, 

% % % \begin{equation}
% % %     G_{\text {ideal }, k}(\psi)=\frac{Q}{|\mathcal{W}_k| M_{t}} \mathds{1}_{\omega_{k}}(\psi), \quad \psi \in[-\pi, \pi] \label{composite_ideal_gain}
% % % \end{equation}

% % % The new MSE problem for the $k$-th codeword can therefore be written as follows.

% % % \begin{align}
% % % &\left(\mathbf{F}_{\text {opt }, k}, \mathbf{v}_{\mathrm{opt}, k}\right) \nonumber \\&=\underset{\mathbf{F}, \mathbf{v}}{\arg \min } \int_{-\pi}^{\pi}\left|G_{\text {ideal }, k}(\psi)-G(\psi, \mathbf{F} \mathbf{v})\right|^{2} d \psi \nonumber \\&= \underset{\mathbf{F}, \mathbf{v}}{\arg \min }\left[\lim _{L \rightarrow \infty} \sum_{p=1}^{Q} \sum_{\ell=1}^{L} \frac{\left|G_{\text {ideal }, k}\left(\psi_{p, \ell}\right)-G\left(\psi_{p, \ell}, \mathbf{F} \mathbf{v}\right)\right|^{2}}{L Q / 2 \pi}\right]\label{composite_MSE}
% % % \end{align}


% % % \begin{align}
% % % \left(\mathbf{F}_{k}, \mathbf{v}_{k}\right) &=\underset{\mathbf{F}, \mathbf{v}}{\arg \min } \sum_{p=1}^{Q} \sum_{\ell=1}^{L}\left|G_{\text {ideal }, k}\left(\psi_{p, \ell}\right)-G\left(\psi_{p, \ell}, \mathbf{F} \mathbf{v}\right)\right|^{2} \nonumber\\
% % % &=\underset{\mathbf{F}, \mathbf{v}}{\arg \min }\lim_{L\longrightarrow \infty} \frac{1}{L}\left\|\mathbf{G}_{\text {ideal }, k}-\mathbf{G}(\mathbf{F} \mathbf{v})\right\|_{2}^{2} \label{init_opt}
% % % \end{align}

% % % where,  $$\mathbf{G}(\mathbf{F} \mathbf{v})=\left[G\left(\psi_{1,1}, \mathbf{F} \mathbf{v}\right) \cdots G\left(\psi_{Q, L}, \mathbf{F} \mathbf{v}\right)\right]^{T} \in \mathbb{Z}^{L Q}$$

% % % and, 
% % % $$ \mathbf{G}_{\text {ideal }, k}=\left[G_{\text {ideal }, k}\left(\psi_{1,1}\right) \cdots G_{\text {ideal }, k}\left(\psi_{Q, L}\right)\right]^{T} \in \mathbb{Z}^{L Q}$$

% % % Note that we can write using the definition of $\mathcal{W}_k$ that, 

% % % $$G_{\text {ideal }, k}\left(\psi_{p, \ell}\right)=\left\{\begin{array}{ll}
% % % \frac{Q}{|\mathcal{W}_k| M_{t}}, & p \in \mathcal{W}_k \\
% % % 0, & p \notin \mathcal{W}_k 
% % % \end{array},\right.$$

% % % Or in the matrix form, 

% % % \begin{align}
% % %     &\mathbf{G}_{\text {ideal }, k}=\frac{Q}{|\mathcal{W}_k| M_{t}}\left((\bigoplus_{q \in \mathcal{W}_k}{\mathbf{e}_{q}}) \otimes \mathbf{1}_{L, 1}\right)  \nonumber \\ 
% % %     & = \sum_{q \in \mathcal{W}_k}{\frac{Q}{|\mathcal{W}_k| M_{t}}\left(\mathbf{e}_{q} \otimes \mathbf{1}_{L, 1}\right)} \label{G_ideal_k}
% % % \end{align}

% % % with $\mathbf{e}_{q} \in \mathbb{Z}^{Q}$ being the standard basis vector for the $q$-th axis among $Q$ ones. Now, note that $\mathbf{1}_{L, 1}=\mathbf{g} \odot \mathbf{g}^{*}$ for any $\mathbf{g} \in \mathcal{G}_L$, where, 

% % % $$\mathcal{G}_{L}=\left\{\mathbf{g} \in \mathbb{C}^{L}:\left(\mathbf{g} \mathbf{g}^{H}\right)_{\ell, \ell}=1,1 \leq \ell \leq L\right\}$$



% % % Therefore, equation \eqref{G_ideal_k} can be rewritten as:
% % % \begin{align}
% % % &\mathbf{G}_{\text {ideal }, k} = \sum_{q \in \mathcal{W}_k}\frac{Q}{|\mathcal{W}_k| M_{t}}\left(\mathbf{e}_{q} \otimes\left(\mathbf{g}_q \odot \mathbf{g}_q^{*}\right)\right) \nonumber\\
% % % &=\sum_{q \in \mathcal{W}_k}\left(\sigma\left(\mathbf{e}_{q} \otimes \mathbf{g}_q\right)\right) \odot\left(\sigma\left(\mathbf{e}_{q} \otimes \mathbf{g}_q\right)\right)^{*} \nonumber\\
% % % &=\left(\sum_{q \in \mathcal{W}_k}\sigma\left(\mathbf{e}_{q} \otimes \mathbf{g}_q\right)\right)  \odot \left(\sum_{q \in \mathcal{W}_k}\sigma\left(\mathbf{e}_{q} \otimes \mathbf{g}_q\right)\right)^{*} \label{final_gik}
% % % \end{align}

% % % where $\sigma = \sqrt{\frac{Q}{|\mathcal{W}_k|M_{t}}}$. 
% % % On the other hand note that $\mathbf{G}(\mathbf{F} \mathbf{v})$ can be written as,


% % % \begin{equation}
% % %     \mathbf{G}(\mathbf{F} \mathbf{v}) =\left(\mathbf{D}^{H} \mathbf{F} \mathbf{v}\right) \odot\left(\mathbf{D}^{H} \mathbf{F} \mathbf{v}\right)^{*}\label{dfv_decomp}
% % % \end{equation}

% % % where, 
% % % $$\mathbf{D} =\left[\mathbf{D}_{1} \cdots \mathbf{D}_{Q}\right] \in \mathbb{C}^{M_{t} \times L Q}$$

% % % and, $\mathbf{D}_{q}=\left[\mathbf{d}_{M_{t}}\left(\psi_{q, 1}\right) \cdots \mathbf{d}_{M_{t}}\left(\psi_{q, L}\right)\right] \in \mathbb{C}^{M_{t} \times L}$. 

% % % Comparing the expressions in equations \eqref{final_gik}, and, \eqref{dfv_decomp}, a perfect solution to the optimization problem in \eqref{init_opt}, could be a pair $\textbf{(F, v)}$, for which the following equality holds.  



% % % \begin{align}
% % %     \mathbf{D}^{H} \mathbf{F} \mathbf{v}=\sum_{q \in \mathcal{W}_k}\sigma\left(\mathbf{e}_{q} \otimes \mathbf{g}_q\right) \label{potential_answer}
% % % \end{align}

% % % However, we have that $M_t > N_{RF}$ and therefore, the matrix $\textbf{D}^H \textbf{F}$ may not be full-rank, resulting in the RHS of equation \eqref{potential_answer} being in the null space of LHS. Therefore, given some $\g_q \in \mathcal{G}_L$ we formulate the following two-step optimization problem to search for $\textbf{(F, v)}$ that gets as close as possible to the desired value. 

% % % \begin{problem}

% % % a) For all $q \in \{1, \cdots, Q\}$, given $\g_q \in \mathcal{G}_L$, find the unit-norm vector $\c_q \in \mathbb{C}^{M_t}$ such that
% % % \begin{align}
% % % &\c^{|\g_q}_q=\underset{\c}{\arg \min } \lim_{L\longrightarrow \infty} \frac{1}{L}\left\|\left(\sum_{q \in \mathcal{W}_k}\sigma\left(\mathbf{e}_{q} \otimes \mathbf{g}_q\right)\right)- \mathbf{D}^{H} \c\right\|_{2}^{2} \label{obj_func}
% % % \end{align}

% % % \noindent
% % % b) For every given $\c_q$, find $\F_q \in \mathbb{C}^{M_t \times N_{RF}}$ , and $\v_q \in \mathbb{C}^{N_RF}$ that satisfy $\mathbf{F}_{q}\mathbf{v}_{q} = \c_q$ the condition $\f_n \in \mathcal{B}_{M_t}$ as in equation \eqref{f_constant_gain}. 

% % % % \begin{align}
% % % %     \mathbf{F}_{\mid \g_q}\mathbf{v}_{\mid \g_q} = \c_q
% % % % \end{align}

% % % \end{problem}

% % % Note that the solution to part \textit{(a)} is the limit of the sequence of solutions to a least-square optimization problem as $L$ goes to infinity.
% % %  \begin{align}
% % % & \Tilde{\c}^{(L)}_q = (\D \D^H)^{-1} \D \sigma \left(\mathbf{e}_q \otimes \mathbf{g}_q\right) \\
% % % & \Tilde{\c}^{(L)}_q =  \sigma' \D \left(\mathbf{e}_q \otimes \mathbf{g}_q\right) = \sigma' \D_q\g_q
% % % \end{align}
% % % Dividing by $\|\Tilde{\c}^{(L)}_q\|$ and taking the limit as L goes to infinity we will find the optimal $\c_q$. i.e. 

% % % \begin{equation}
% % %     \c_q = \lim_{L\longrightarrow \infty} \frac{\Tilde{\c}^{(L)}_q}{L\|\Tilde{\c}^{(L)}_q\|}
% % % \end{equation}

% % % We aim to find $\g_q$ such that

% % % \begin{align}
% % % & \left\| abs(\D^H \gamma' \D_q \mathbf{g}_q)- abs(\gamma \left(\mathbf{e}_{q} \otimes \mathbf{g}_q\right)) \right\|_{2}^{2}
% % % \end{align}

% % % is minimized.

% % % % Is it possible to show that $\g_q$ is independent of $q$ (assume regular scenario)? If true, i.e., $\g_q = \g$ we have

% % % We will provide a suboptimal structure for the choice of $\g$. Let us assume $\g_q = \g, $  for all $ q \in \{1, \cdots, Q\}$. Then we can write
% % % \begin{align}
% % %      &\Tilde{\c_q}^{(L)} = D_q\mathbf{g} = \sum_{l=1}^{L}g_l\mathbf{d}_{M_t}(\psi_{q, l})  \nonumber\\
% % %      & = \sum_{l=1}^L g_l\left[{\begin{array}{cccc}
% % %      1& e^{j\psi_{q, l}} &\cdots & e^{j(M_t-1)\psi_{q, l}}\\
% % %      \end{array}}\right]^T  = \nonumber\\
% % %      & \left[{\begin{array}{cccc}
% % %      \sum_{l=1}^L g_l& \sum_{l=1}^L g_le^{j\psi_{q, l}} &\cdots & \sum_{l=1}^L g_le^{j(M_t-1)\psi_{q, l}}\\
% % %      \end{array}}\right]^T
% % %  \end{align}
 
 

% % %  We have for the $m$-th element of the vector $\Tilde{\c}_q$, i.e. $\Tilde{c}^{(m)}_q$  for $ 0 \leq m \leq M_t-1$

% % % \begin{equation}
% % %     \Tilde{c}_q^{(m)} = \lim_{L\longrightarrow \infty} \frac{1}{L}\sum_{l=0}^{L-1} g_l e^{j(m\psi_{q, l+1})}
% % % \end{equation}

% % % With a choice of $\g = \left[{\begin{array}{cccc} 1& \alpha^\eta &\cdots & \alpha^{\eta (L -1)} \end{array}}\right]^T$ where we set 
% % % % $\alpha = e^j(\frac{2\pi}{LQ})$
% % % $\alpha = e^j(\frac{\psi_{q}-\psi_{q-1}}{L})$ and suitable $\eta$ (to be determined later), we can write


% % % % \begin{equation}
% % % %     \Tilde{c}_q^{(m)} = \lim_{L\longrightarrow \infty} \frac{1}{L}\sum_{l=0}^{L-1} g_l e^{jm(\psi_{q-1}+\frac{2 \pi(\ell+0.5)}{LQ})}
% % % % \end{equation}

% % % \begin{equation}
% % %     \Tilde{c}_q^{(m)} = \lim_{L\longrightarrow \infty} \frac{1}{L}\sum_{l=0}^{L-1} g_l e^{jm(\psi_{q-1}+\frac{(\psi_{q}-\psi_{q-1})(\ell+0.5)}{L})}
% % % \end{equation}

% % % \begin{equation}
% % %     c_q^{(m)} = \lim_{L\longrightarrow \infty} \frac{1}{L}\sum_{l=0}^{L-1} \alpha^{(\eta+m) l} e^{jm(\psi_{q-1}+\frac{0.5(\psi_{q}-\psi_{q-1})}{L})} 
% % % \end{equation}


% % % \begin{equation}
% % %     c_q^{(m)} = e^{jm(\psi_{q-1})}\lim_{L\longrightarrow \infty} \frac{1}{L}\sum_{l=0}^{L-1} \alpha^{(\eta+m) l}   
% % % \end{equation}

% % % \begin{equation}
% % %     c_q^{(m)} = e^{jm(\psi_{q-1})} \int_{0}^{1} \alpha^{(\eta + m)Lx}dx
% % % \end{equation}


% % % % \begin{equation}
% % % %     c_q^{(m)} = e^{jm(\psi_{q-1})} \int_{0}^{1} e^{j\frac{2\pi(\eta + m)L}{LQ}x}dx
% % % % \end{equation}


% % % \begin{equation}
% % %     c_q^{(m)} = e^{jm(\psi_{q-1})} \int_{0}^{1} e^{j\xi x}dx
% % % \end{equation}

% % % where $\xi = (\psi_{q}-\psi_{q-1}) (\eta +m )$.


% % % \begin{equation}
% % %     c_q^{(m)} = e^{jm(\psi_{q-1})} \frac{e^{j\xi}-1}{j\xi}
% % % \end{equation}

% % % \begin{equation}
% % %     c_q^{(m)} = e^{j(m\psi_{q-1} + \frac{\xi}{2})} \frac{e^{j\xi/2}-e^{-j\xi/2}}{j\xi/2}
% % % \end{equation}

% % % \begin{equation}
% % %     c_q^{(m)} = e^{j(m\psi_{q-1} + \frac{\xi}{2})} sinc(\frac{\xi}{2\pi})
% % % \end{equation}

% % % where, $sinc(t) = \frac{sin(\pi t)}{\pi t}$.
















% % % % We first optimize for $\alpha$ by setting the derivative of \eqref{obj_func} to zero, to get: 

% % % % $$\hat{\alpha}=\frac{\sum_{q \in \mathcal{W}_k}\sqrt{\frac{Q}{M_{t}}}(\mathbf{F} \mathbf{v})^{H} \mathbf{D}_{q} \mathbf{g}_q}{\left\|\mathbf{D}^{H} \mathbf{F} \mathbf{v}\right\|_{2}^{2}}$$

% % % % Replacing the value of $\alpha$ as above we get to the following optimization problem. 

% % % % \begin{align}
% % % % \left(\mathbf{F}_{\mid \mathbf{g}}, \mathbf{v}_{\mid \mathbf{g}}\right) &=\underset{\mathbf{F}, \mathbf{v}}{\arg \max } \frac{\left|\sum_{q \in \mathcal{W}_k}\sqrt{\frac{2^{\mathbf{B}}}{M_{t}}}\left(\mathbf{D}_{q} \mathbf{g}_q\right)^{H} \mathbf{F} \mathbf{v}\right|^{2}}{\left\|\mathbf{D}^{H} \mathbf{F} \mathbf{v}\right\|_{2}^{2}} \nonumber \\
% % % % &=\underset{\mathbf{F}, \mathbf{v}}{\arg \max }\left|\sum_{q \in \mathcal{W}_k}\left(\mathbf{D}_{q} \mathbf{g}\right)^{H} \mathbf{F} \mathbf{v}\right|^{2}
% % % % \end{align}


% \subsection{UPA Codebook Design Prolem}

% Suppose an $M_h \times M_v$ UPA is placed at the $x-z$ plane, and let $M = M_h M_v$. Let the distance between the antennas that are placed parallel to $z$ axis, be $d_z$, and $d_x$ respectively. One can define,

% \begin{align}
% \mathbf{d}_{M_{a}}\left(\psi_{a}\right) = \left[1, e^{j \psi_{a}} \cdots e^{j\left(M_{a}-1\right) \psi_{a}}\right]^{T} \in \mathbb{C}^{M_{a}}
% \end{align}
% where, $\psi_{h}=\frac{2 \pi d_{x}}{\lambda} \sin \theta \cos \phi \text { and } \psi_{v}=\frac{2 \pi d_{z}}{\lambda} \sin \phi$, and $a$ takes value in the set $\{v, h\}$.  
% The array response vector is then defined as 

% \begin{align}
%     \mathbf{d}_{M}\left(\psi_{v}, \psi_{h}\right) =
%     \mathbf{d}_{M_{v}}\left(\psi_{v}\right) \otimes
%     \mathbf{d}_{M_{h}}\left(\psi_{h}\right)  \in \mathbb{C}^{M}
% \end{align}
% Let $\mathcal{B}_s$ be the angular range under cover. We have, 

% \begin{equation}
%     \mathcal{B}_{s} \doteq \left[-\phi^{\mathrm{B}}, \phi^{\mathrm{B}}\right)
%     \times \left[-\theta^{\mathrm{B}}, \theta^{\mathrm{B}}\right) \label{range_angle}
% \end{equation}

% Notation $\psi^{p,q}_{h}[1:L_h,1 :L_v], \psi^{p,q}_{v}[1:L_v]$

% Let us uniformly divide the angular range  into $Q=Q_{v} Q_{h}$ subregions. For each subregion we have, 

% $$ \mathcal{B}_{p, q} =  \omega_{\phi, p} \times \omega_{\theta, q}$$

% Let $\Delta_{\theta} =  2 \theta^{\mathrm{B}} / Q_{v}$, and $\Delta_\phi =  2 \phi^{\mathrm{B}} / Q_{h}$ be the length of each sub-interval along axis $\theta$, and $\phi$. We have $\omega_{\theta, q} = [\theta_{q-1}, \theta_q)$, and, $\omega_{\phi, p} = [\phi_{p-1},\phi_p)$ where  $\theta_q = -\theta^B + q\Delta_\theta$, and $\phi_p = -\phi^B + p\Delta_\phi$. 


% In the $(\psi_h, \psi_v)$ domain, we can rewrite equation \eqref{range_angle} as, 

% \begin{equation}
%     \mathcal{B}^\psi_{s} \doteq\left[-\psi_h^{\mathrm{B}}, \psi_h^{\mathrm{B}}\right) \times\left[-\psi_v^{\mathrm{B}}, \psi_v^{\mathrm{B}}\right)
% \end{equation}

% and each sub-region similarly can be rewritten in the $\psi$ domain as

% $$ \mathcal{B}^\psi_{ p, q} \doteq \nu_{v}^{p, q} \times \nu_{h}^ {p, q}$$

% % We can then write for each $v_{a, b}$, i.e the $b$-th sub-interval along axis $a$,

% % \begin{equation}
% %     \nu_{v, p} =-\psi_{a}^{\mathrm{B}}+(b-1)\Delta_{a}+\left[0, \Delta_{a}\right)
% % \end{equation}

% Define the reference gain at $(\psi_{h}, \psi_{v}) $ as, 

% \begin{equation}
%     G\left(\psi_{v}, \psi_{h}, \mathbf{c}\right) =\left|\left(\mathbf{d}_{M_{v}}\left(\psi_{v}\right)\otimes\mathbf{d}_{M_{h}}\left(\psi_{h}\right)  \right)^{H} \mathbf{c}\right|^{2}
% \end{equation}

% It is straightforward to show that, 

% \begin{equation}
%     \int_{-\pi}^{\pi} \int_{-\pi}^{\pi} G\left(\psi_{v}, \psi_{h}, \mathbf{c}\right) d \psi_{v} d \psi_{h}={(2 \pi)^{2}}
% \end{equation}

% Therefore, for every interval $\mathcal{B}_{ p, q}$ we can derive the ideal gain expression as, 

% \begin{equation}
%     G_{p, q}^{\text {ideal }}\left(\psi_{v}, \psi_{h}\right)=G_{p,q} \mathds{1}_{\mathcal{B}^\psi_{p, q}}\left(\psi_{v}, \psi_{h}\right)
% \end{equation}

% where $G_{q,p} = \frac{(2\pi)^2}{\delta_{p,q}}$, where $\delta_{p,q}$ is the area of the interval $\mathcal{B}^\psi_{p,q}$. We define the codebook design problem under the UPA structure as follows. 
% % where $G_{q,p} = \frac{(2\pi)^2}{\delta^{p,q}_h\delta^p_v}$, $\delta^p_v = \psi^p_v - \psi^{p-1}_v $, and $\delta^{q, p}_h = \psi^{q,p}_h - \psi^{q-1, p}_h $. Also, let us define $\delta_{q,p} = \delta^{q, p}_h\delta^p_v$. 



% \begin{align}
% & \c^{opt}_{p, q} = \nonumber\\&\underset{\c, \|\c\|=1}{\arg \min } \iint_{\mathcal{B}_{s}}\left|G_{p, q}^{\text {ideal }}\left(\psi_{v}, \psi_{h}\right)-G\left(\psi_{v}, \psi_{h}, \c\right)\right| d \psi_{v} d \psi_{h} \label{init_opt}
% \end{align}

% By partitioning the range of $(\psi_h, \psi_v)$ into the pre-defined intervals, we can rewrite the optimization problem as follows, 

% \begin{align}
% & \c^{opt}_{p, q} = \underset{\c, \|\c\|=1}{\arg \min }\nonumber\\& \sum_{r=1}^{Q_v}\sum_{s=1}^{Q_h}\iint_{\mathcal{B}^{\psi}_{r,s}}\left|G_{p, q}^{\text {ideal }}\left(\psi_{v}, \psi_{h}\right)-G\left(\psi_{v}, \psi_{h}, \c\right)\right| d \psi_{v} d \psi_{h} \nonumber\\&
%  = \underset{L_h, L_v \rightarrow \infty}{\lim}\sum_{r=1}^{Q_v}\sum_{s=1}^{Q_h}\sum_{l_v =1}^{L_v}\sum_{l_h =1}^{L_h}\frac{\delta^r_v\delta^{r,s,l_v}_h}{L_hL_v}\nonumber\\&
% \left|G_{p, q}^{\text {ideal }}\left(\psi^{r,s}_{v}[l_v], \psi^{r,s}_{h}[l_v][l_h]\right)-G\left(\psi^{r,s}_{v}[l_v], \psi^{r,s}_{h}[l_v][l_h], \c\right)\right| \label{alternative_opt}
% \end{align}
% where, 

% \begin{align}
%     &\psi^{r,s}_v[l_v] = \psi^{r-1, s}_v + l_v\frac{\delta_v^r}{L_v}\nonumber\\
%     &\psi^{r,s}_h[l_v][l_h] = \psi^{r, s-1}_h[l_v] + l_h\frac{\delta_h^{r,s, l_v}}{L_h}
% \end{align}

% We can rewrite the optimization problem \eqref{alternative_opt} as, 

% \begin{align}
%     \c_{p,q}^{opt}=\arg \min _{\c, \|\c\|=1} \underset{L_h, L_v \rightarrow \infty}{\lim}\frac{1}{L_hL_v}\left\|\mathbf{G}^{\text {ideal }}_{p,q}-\mathbf{G}(\c)\right\|
% \end{align}


% where, 

% \begin{align}
%     &\mathbf{G}(\c) = \nonumber\\&\left[\delta^1_v\delta^{1,1,1}_hG\left(\psi_{v}^{1,1}[1], \psi_{h}^{1,1}[1][1], \c\right) \cdots \right. \nonumber\\ &\left. \delta^{Q_v}_v\delta^{Q_v,Q_h,L_v}_hG\left(\psi_{v}^{Q_{v}, Q_{h}}\left[L_{v}\right], \psi_{h}^{Q_{v}, Q_{h}}\left[L_{v}\right]\left[L_{h}\right], \c\right)\right]^{T} 
% \end{align}

% and, 

% \begin{align}
%     &\mathbf{G}^{\text {ideal }}_{ p, q} = \nonumber\\&\left[\delta^1_v\delta^{1,1,1}_hG^{\text {ideal }}_{ p, q}\left(\psi_{v}^{1,1}[1], \psi_{h}^{1,1}[1][1] \right) \cdots \right. \nonumber\\ &\left. \delta^{Q_v}_v\delta^{Q_v,Q_h,L_v}_hG^{\text {ideal }}_{ p, q}\left(\psi_{v}^{Q_{v}, Q_{h}}\left[L_{v}\right], \psi_{h}^{Q_{v}, Q_{h}}\left[L_{v}\right]\left[L_{h}\right]\right)\right]^{T} 
% \end{align}


% % \begin{align}
% %      &\mathbf{G}^{\text {ideal }}_{ q, p}= \nonumber\\&\left[{\delta_{1,1}} G^{\text {ideal }} _{q, p}\left(\psi^{1}_{h}[1], \psi^{1}_{v}[1], \c\right) \ldots {\delta_{Q_h, Q_v}}G^{\text {ideal }} _{q, p}\left(\psi^{Q_h}_{h}[L_h], \psi^{Q_v}_{v}[L_v], \c\right)\right]^{T} 
% % \end{align}


% Note that we can write, 

% \begin{align}
%     \mathbf{G}^{\text{ideal }}_{p,q} = \frac{{(2\pi)}^2}{\delta_{p,q}} \left(\e_{p,q} \otimes (\boldsymbol{\delta}_{p,q}\odot\mathbf{1}_{L, 1})\right)
% \end{align}

% where, $\boldsymbol\delta_{p,q} = $
% with $\mathbf{e}_{p,q} \in \mathbb{Z}^{Q}$ being the standard basis vector for the $(p,q)$-th axis among $Q$ ones. 








% Now, note that $\mathbf{1}_{L, 1}=\mathbf{g} \odot \mathbf{g}^{*}$ for any equal gain $\mathbf{g} \in \mathbb{C}^L$. Therefore, we can write: 

% % $$\mathcal{G}_{L}=\left\{\mathbf{g} \in \mathbb{C}^{L}:\left(\mathbf{g} \mathbf{g}^{H}\right)_{\ell, \ell}=1,1 \leq \ell \leq L\right\}$$


% \begin{align}
% \mathbf{G}^{\text {ideal }}_{p,q} &=\frac{{2\pi}^2}{\delta_{p,q}}\left(\mathbf{e}_{p,q} \otimes\left((\boldsymbol\delta^{(\frac{1}{2})}_{p,q}\odot\boldsymbol\delta^{(\frac{1}{2})}_{p,q})\odot(\mathbf{g} \odot \mathbf{g}^{*})\right)\right) \nonumber\\
% &=\left(\frac{{2\pi}}{\sqrt{\delta_{p,q}}}\left(\mathbf{e}_{p,q} \otimes (\boldsymbol\delta^{(\frac{1}{2})}_{p,q}\odot\mathbf{g})\right)\right) \nonumber\\&\odot\left(\frac{{(2\pi)}}{\sqrt{\delta_{p,q}}}\left(\mathbf{e}_{p,q} \otimes (\boldsymbol\delta^{(\frac{1}{2})}_{p,q}\odot\mathbf{g})\right)\right)^{*} \label{g_id_q_equivalent}
% \end{align}

% Also, note that we can write, 

% % \begin{align}
% %     \mathbf{G}(\c)=\left(\left(\mathbf{D}_{h}^{H} \otimes \mathbf{D}_{v}^{H}\right) \c\right) \odot\left(\left(\mathbf{D}_{h}^{H} \otimes \mathbf{D}_{v}^{H}\right) \c\right)^{*}
% % \end{align}
% \begin{align}
%     \mathbf{G}(\c)=\left(\D^H \c\right) \odot\left(\D^H \c\right)^{*}
% \end{align}

% where 

% \begin{align}
%     \D = \left[D^{1,1}_{vh}, \cdots, D^{Q_v,Q_h}_{vh}\right] \in \mathbb{C}^{M_vM_h\times L_vL_hQ_vQ_h}
% \end{align}

% % \begin{align}
% % % &\mathbf{D}_{v} =\left[\mathbf{D}_{v, 1}, \cdots, \mathbf{D}_{v, Q_{v}}\right] \in \mathbb{C}^{M_{v} \times L_{v} Q_{v}} \\
% % % &\mathbf{D}_{h} =\left[\mathbf{D}_{h, 1}, \cdots, \mathbf{D}_{h, Q_{h}}\right] \in \mathbb{C}^{M_{h} \times L_{h} Q_{h}} \\
% % % &\mathbf{D}_{v, p} =\left[\mathbf{d}_{M_{v}}\left(\psi_{v}^{p}[1]\right), \cdots, \mathbf{d}_{M_{v}}\left(\psi_{v}^{p}\left[L_{v}\right]\right)\right] \in \mathbb{C}^{M_{v} \times L_{v}}\\
% % % &\mathbf{D}_{h, q} =\left[\mathbf{d}_{M_{h}}\left(\psi_{h}^{q}[1]\right), \cdots, \mathbf{d}_{M_{h}}\left(\psi_{h}^{q}\left[L_{h}\right]\right)\right] \in \mathbb{C}^{M_{h} \times L_{h}}\\
% % &\mathbf{D}_{h, q}(\chi) =\left[\mathbf{d}_{M_{h}}\left(\psi_{h}^{q}[1], \chi \right), \cdots, \mathbf{d}_{M_{h}}\left(\psi_{h}^{q}\left[L_{h}\right], \chi \right)\right] \in \mathbb{C}^{M_{h} \times L_{h}}\\
% % &\mathbf{D}_{vh, p,q} =\left[\mathbf{d}_{M_{v}}\left(\psi_{v}^{p}[1]\right) \otimes \mathbf{D}_{h, q}(\psi_{v}^{p}[1]), \cdots, \mathbf{d}_{M_{v}}\left(\psi_{v}^{p}\left[L_{v}\right]\right) \otimes \mathbf{D}_{h, q}(\psi_{v}^{p}\left[L_{v}\right]) \right] \in \mathbb{C}^{M_{v}M_{h} \times L_{v}L_{h}}
% % \end{align}

% \begin{align}
% % &\mathbf{D}_{v} =\left[\mathbf{D}_{v, 1}, \cdots, \mathbf{D}_{v, Q_{v}}\right] \in \mathbb{C}^{M_{v} \times L_{v} Q_{v}} \\
% % &\mathbf{D}_{h} =\left[\mathbf{D}_{h, 1}, \cdots, \mathbf{D}_{h, Q_{h}}\right] \in \mathbb{C}^{M_{h} \times L_{h} Q_{h}} \\
% % &\mathbf{D}_{v, p} =\left[\mathbf{d}_{M_{v}}\left(\psi_{v}^{p}[1]\right), \cdots, \mathbf{d}_{M_{v}}\left(\psi_{v}^{p}\left[L_{v}\right]\right)\right] \in \mathbb{C}^{M_{v} \times L_{v}}\\
% % &\mathbf{D}_{h, q} =\left[\mathbf{d}_{M_{h}}\left(\psi_{h}^{q}[1]\right), \cdots, \mathbf{d}_{M_{h}}\left(\psi_{h}^{q}\left[L_{h}\right]\right)\right] \in \mathbb{C}^{M_{h} \times L_{h}}\\
% \mathbf{D}^{p,q}_{h}(\ell) =&\sqrt{\delta_v^{p}\delta^{p,q,\ell}_h}\left[\mathbf{d}_{M_{h}}\left(\psi_{h}^{p,q}[\ell][1] \right), \cdots, \right.\nonumber\\&\left. \mathbf{d}_{M_{h}}\left(\psi_{h}^{p,q}\left[\ell] [L_{h} \right] \right)\right] \in \mathbb{C}^{M_{h} \times L_{h}}, 
% \end{align}

% \begin{align}
%     \mathbf{D}_{vh}^{p,q} =&\left[\mathbf{d}_{M_{v}}\left(\psi_{v}^{p,q}[1]\right) \otimes \mathbf{D}_{h}^{p,q}(1), \cdots, \right.\nonumber\\&\left. \mathbf{d}_{M_{v}}\left(\psi_{v}^{p,q}\left[L_{v}\right]\right) \otimes \mathbf{D}_{h}^{p,q}(L_{v}) \right] \in \mathbb{C}^{M_{v}M_{h} \times L_{v}L_{h}}
% \end{align}
% \begin{problem}
% Given an equal-gain vector $\g_{p,q} \in \mathbb{C}^L$, $(p,q) \in \{(1,1), \cdots, (Q_v, Q_h)\}$, find vector $\c_{p,q} \in \mathbb{C}^{M_t}$ such that
% \begin{align}
% &\c_{p,q}=\underset{\c, \|c\|=1}{\arg \min } \lim_{L\rightarrow \infty} \left\|\frac{{2\pi}}{\sqrt{\delta_{p,q}}}\left(\mathbf{e}_{p,q} \otimes (\boldsymbol\delta^{(\frac{1}{2})}_{L,1}\odot\mathbf{g}_{p,q})\right)- \D^H \c\right\|^{2} \label{obj_func}
% \end{align}
% \label{main_problem_UPA}
% \end{problem}


% Note that the solution to problem \ref{main_problem_UPA} is the limit of the sequence of solutions to a least-square optimization problem as $L$ goes to infinity. For each $L$ we find that,
%  \begin{align}
%  {\c}^{(L)}_{p,q} &= {\frac{{2\pi}}{\sqrt{\delta_{p,q}}}}(\D \D^H)^{-1} \D  \left(\mathbf{e}_{p,q} \otimes (\boldsymbol\delta^{(\frac{1}{2})}_{L,1}\odot\mathbf{g}_{p,q})\right) \nonumber\\& =\sigma \D^{p,q}(\boldsymbol\delta^{(\frac{1}{2})}_{L,1}\odot\mathbf{g}_{p,q})
% \end{align}
% where $\sigma = \frac{2\pi \sqrt{\delta_{p,q}}}{L\sum_{(q,p)= (1,1)}^{(Q_h, Q_v)} \delta_{p,q}}$, noting that it holds that, 

% Noting that it holds that, 

% \begin{align}
%     (\D\D^H) = \left(L\sum_{(p,q)= (1,1)}^{(Q_h, Q_v)}\sum_{(l_v,l_h)= (1,1)}^{(L_h, L_v)} \delta_{v}^p\delta^{p,q,l_v}_{h}\right)\I_{M_t}
% \end{align}

% \begin{problem}
% Find equal-gain $\g_{p,q} \in \mathbb{C}^L$, $(q,p) = (1,1), \ldots, (Q_h, Q_v)$, such that
% \begin{equation}
%  \g_{q,p} = \underset{\g}{\arg\min }\left\| abs(\D^H \c_{q,p})- {2\pi} abs(\mathbf{e}_{q,p} \otimes \mathbf{g})\right\|^{2} \label{g_final_eq}
% \end{equation} 
% where $abs(.)$ denotes the element-wise absolute value of a vector.
% \label{g_problem}
% \end{problem}


% \begin{proposition}
% The minimizer of \eqref{g_simple_final_eq} is in the form $\g_q = \left[{\begin{array}{cccc} 1& \alpha^\eta &\cdots & \alpha_h^{\eta (L_h -1)}\alpha_v^{\eta (L_v -1)} \end{array}}\right]^T$ for some $\eta$ where $\alpha_h = e^{j(\frac{\delta^{q,p}_h}{L_h})}$ and $\alpha_v = e^{j(\frac{\delta^p_v}{L_v})}$. \label{proposiiton_g}
% \end{proposition}

%  \begin{align}
%      {\c_{p,q}}^{(L)} & = \sigma \sum_{(l_v, l_h)=(1,1)}^{(L_v, L_h)}g_{p,q, l}\mathbf{d}_{M_t}\left(\psi^{p,q}_{v}[l_v], \psi^{p,q}_{h}[l_v][l_h]\right)  \nonumber\\
%      & = \sigma \sum_{l=1}^L g_{q,p,l}\left[{\begin{array}{ccc}
%      1 &\cdots & e^{j\left( (M_v-1)\psi^{p,q}_{v}[l_v] + (M_h-1)\psi^{p,q}_{h}[l_v][l_h]\right)}\\
%      \end{array}}\right]^T   
%     %  \nonumber\\& = \left[{\begin{array}{ccc}
%     %  \sigma\sum_{l=1}^L g_{q, p, l}& \cdots & \sigma\sum_{l=1}^L g_{q,p, l}e^{j\left((M_h-1)\psi^q_{h}[l] + (M_v-1)\psi^p_{v}[l]\right)}\\
%     %  \end{array}}\right]^T
% \end{align}

% We can then write 

% \begin{align}
%     c_{p,q, m_v, m_h} &= \lim_{L_h, L_v\rightarrow \infty} \frac{1}{L_hL_v}\sum_{(l_h, l_v)=(1,1)}^{(L_h, L_v)} \nonumber \\&\delta^p_v\delta_h^{p,q,l_v}g_{p,q, l_v, l_h}e^{j\left(m_v\psi^{p,q}_{v}[l_v]+ m_h\psi^{p,q}_{h}[l_v][l_h] \right)}
% \end{align}


% \begin{align}
%     c_{p,q, m_v, m_h} &=  \nonumber\\&\lim_{L_h, L_v\rightarrow \infty} \frac{1}{L_hL_v}\sum_{(l_h, l_v)=(1,1)}^{(L_h, L_v)} \delta^p_v\delta_h^{p,q,l_v}g_{p,q, l_v, l_h}\nonumber \\&e^{j\left(m_v(\psi^{p-1,q}_{v}+l_v\frac{\delta^p_v}{L_v})+ m_h(\psi^{p,q-1}_{h}[l_v] + l_h\frac{\delta^{p,q,l_v}_h}{L_h}) \right)}
% \end{align}


% \begin{align}
%     c_{p,q, m_v, m_h} &=  \lim_{ L_v\rightarrow \infty} \frac{\delta^p_v}{L_v}\sum_{l_v=1}^{L_v} e^{j(m_v(\psi^{p-1,q}_{v}+l_v\frac{\delta^p_v}{L_v}) + x\eta\frac{l_v}{L_v})} S^{(l_v)}
% \end{align}

% where, 

% \begin{align}
%     S^{(l_v)} &= \lim_{ L_h\rightarrow \infty}\frac{\delta^{p,q,l_v}_h}{L_h}\sum_{l_h=1}^{L_h}e^{j(m_h(\psi^{p,q-1}_{h}[l_v] + l_h\frac{\delta^{p,q,l_v}_h}{L_h}) + y\gamma \frac{l_h}{L_h})} \nonumber\\& = \delta^{p,q,l_v}_h e^{jm_h\psi^{p,q-1}_{h}[l_v]}sinc(\frac{\xi}{2\pi})
% \end{align}

% with $\xi = {\delta^{p,q,l_v}_h}{m} + y\gamma$. Therefore, it. holds that, 

% \begin{align}
%     c_{p,q, m_v, m_h} &=  \lim_{ L_v\rightarrow \infty} \frac{\delta^p_v}{L_v}\sum_{l_v=1}^{L_v} e^{j(m_v(\psi^{p-1,q}_{v}+l_v\frac{\delta^p_v}{L_v}) + x\eta\frac{l_v}{L_v})} \delta^{p,q,l_v}_h e^{jm_h\psi^{p,q-1}_{h}[l_v]}sinc(\frac{\xi}{2\pi})
% \end{align}