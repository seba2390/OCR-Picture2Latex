\subsection{UPA Codebook Design Prolem}

Suppose an $M_h \times M_v$ UPA is placed at the $x-z$ plane, and let $M = M_h M_v$. Let the distance between the antennas that are placed parallel to $z$ axis, be $d_z$, and $d_x$ respectively. One can define,

\begin{align}
\mathbf{d}_{M_{a}}\left(\psi_{a}\right) = \left[1, e^{j \psi_{a}} \cdots e^{j\left(M_{a}-1\right) \psi_{a}}\right]^{T} \in \mathbb{C}^{M_{a}}
\end{align}
where, $\psi_{h}=\frac{2 \pi d_{x}}{\lambda} \sin \theta \cos \phi \text { and } \psi_{v}=\frac{2 \pi d_{z}}{\lambda} \sin \phi$, and $a$ takes value in the set $\{v, h\}$.  
The array response vector is then defined as 

\begin{align}
    \mathbf{d}_{M}\left(\psi_{v}, \psi_{h}\right) =
    \mathbf{d}_{M_{v}}\left(\psi_{v}\right) \otimes
    \mathbf{d}_{M_{h}}\left(\psi_{h}\right)  \in \mathbb{C}^{M}
\end{align}
Let $\mathcal{B}_s$ be the angular range under cover in the $(\psi_h, \psi_v)$ domain. We have, 

\begin{equation}
    \mathcal{B}^\psi_{s} \doteq\left[-\psi_h^{\mathrm{B}}, \psi_h^{\mathrm{B}}\right) \times\left[-\psi_v^{\mathrm{B}}, \psi_v^{\mathrm{B}}\right)
\end{equation}

% \begin{equation}
%     \mathcal{B}_{s} \doteq \left[-\phi^{\mathrm{B}}, \phi^{\mathrm{B}}\right)
%     \times \left[-\theta^{\mathrm{B}}, \theta^{\mathrm{B}}\right) \label{range_angle}
% \end{equation}

% Notation $\psi^{p,q}_{h}[1:L_h,1 :L_v], \psi^{p,q}_{v}[1:L_v]$

Let us uniformly divide the angular range  into $Q=Q_{v} Q_{h}$ subregions. For each subregion we have, 

% $$ \mathcal{B}_{p, q} =  \omega_{\phi, p} \times \omega_{\theta, q}$$

% Let $\Delta_{\theta} =  2 \theta^{\mathrm{B}} / Q_{v}$, and $\Delta_\phi =  2 \phi^{\mathrm{B}} / Q_{h}$ be the length of each sub-interval along axis $\theta$, and $\phi$. We have $\omega_{\theta, q} = [\theta_{q-1}, \theta_q)$, and, $\omega_{\phi, p} = [\phi_{p-1},\phi_p)$ where  $\theta_q = -\theta^B + q\Delta_\theta$, and $\phi_p = -\phi^B + p\Delta_\phi$. 


$$ \mathcal{B}_{ p, q} \doteq \nu_{v}^{p, q} \times \nu_{h}^ {p, q}$$

% We can then write for each $v_{a, b}$, i.e the $b$-th sub-interval along axis $a$,

% \begin{equation}
%     \nu_{v, p} =-\psi_{a}^{\mathrm{B}}+(b-1)\Delta_{a}+\left[0, \Delta_{a}\right)
% \end{equation}

Define the reference gain at $(\psi_{h}, \psi_{v}) $ as, 

\begin{equation}
    G\left(\psi_{v}, \psi_{h}, \mathbf{c}\right) =\left|\left(\mathbf{d}_{M_{v}}\left(\psi_{v}\right)\otimes\mathbf{d}_{M_{h}}\left(\psi_{h}\right)  \right)^{H} \mathbf{c}\right|^{2}
\end{equation}

It is straightforward to show that, 

\begin{equation}
    \int_{-\pi}^{\pi} \int_{-\pi}^{\pi} G\left(\psi_{v}, \psi_{h}, \mathbf{c}\right) d \psi_{v} d \psi_{h}={(2 \pi)^{2}}
\end{equation}

Therefore, for every interval $\mathcal{B}_{ p, q}$ we can derive the ideal gain expression as, 

\begin{equation}
    G_{p, q}^{\text {ideal }}\left(\psi_{v}, \psi_{h}\right)=G_{p,q} \mathds{1}_{\mathcal{B}^\psi_{p, q}}\left(\psi_{v}, \psi_{h}\right)
\end{equation}

where $G_{q,p} = \frac{(2\pi)^2}{\delta_{p,q}}$, where $\delta_{p,q}$ is the area of the interval $\mathcal{B}^\psi_{p,q}$. We can write $\delta_{p,q} = \delta_v\delta_h = (\frac{2\psi^B_v}{Q_v})(\frac{2\psi^B_h}{Q_h})$. Therefore, We define the codebook design problem under the UPA structure as follows. 
% where $G_{q,p} = \frac{(2\pi)^2}{\delta^{p,q}_h\delta^p_v}$, $\delta^p_v = \psi^p_v - \psi^{p-1}_v $, and $\delta^{q, p}_h = \psi^{q,p}_h - \psi^{q-1, p}_h $. Also, let us define $\delta_{q,p} = \delta^{q, p}_h\delta^p_v$. 



\begin{align}
& \c^{opt}_{p, q} = \nonumber\\&\underset{\c, \|\c\|=1}{\arg \min } \iint_{\mathcal{B}_{s}}\left|G_{p, q}^{\text {ideal }}\left(\psi_{v}, \psi_{h}\right)-G\left(\psi_{v}, \psi_{h}, \c\right)\right| d \psi_{v} d \psi_{h} \label{init_opt}
\end{align}

By partitioning the range of $(\psi_h, \psi_v)$ into the pre-defined intervals, we can rewrite the optimization problem as follows, 

\begin{align}
& \c^{opt}_{p, q} = \underset{\c, \|\c\|=1}{\arg \min }\nonumber\\& \sum_{r=1}^{Q_v}\sum_{s=1}^{Q_h}\iint_{\mathcal{B}^{\psi}_{r,s}}\left|G_{p, q}^{\text {ideal }}\left(\psi_{v}, \psi_{h}\right)-G\left(\psi_{v}, \psi_{h}, \c\right)\right| d \psi_{v} d \psi_{h} \nonumber\\&
 = \underset{L_h, L_v \rightarrow \infty}{\lim}\sum_{r=1}^{Q_v}\sum_{s=1}^{Q_h}\sum_{l_v =1}^{L_v}\sum_{l_h =1}^{L_h}\frac{\delta_v\delta_h}{L_hL_v}\nonumber\\&
\left|G_{p, q}^{\text {ideal }}\left(\psi^{r,s}_{v}[l_v], \psi^{r,s}_{h}[l_h]\right)-G\left(\psi^{r,s}_{v}[l_v], \psi^{r,s}_{h}[l_h], \c\right)\right| \label{alternative_opt}
\end{align}
where, 

\begin{align}
    &\psi^{r,s}_v[l_v] = \psi^{r-1, s}_v + l_v\frac{\delta_v}{L_v}\nonumber\\
    &\psi^{r,s}_h[l_h] = \psi^{r, s-1}_h + l_h\frac{\delta_h}{L_h}
\end{align}

We can rewrite the optimization problem \eqref{alternative_opt} as, 

\begin{align}
    \c_{p,q}^{opt}=\arg \min _{\c, \|\c\|=1} \underset{L_h, L_v \rightarrow \infty}{\lim}\frac{1}{L_hL_v}\left\|\mathbf{G}^{\text {ideal }}_{p,q}-\mathbf{G}(\c)\right\|
\end{align}


where, 

\begin{align}
    \mathbf{G}(\c) =& \delta_v\delta_h\left[G\left(\psi_{v}^{1,1}[1], \psi_{h}^{1,1}[1], \c\right) \cdots \right. \nonumber\\ &\left. G\left(\psi_{v}^{Q_{v}, Q_{h}}\left[L_{v}\right], \psi_{h}^{Q_{v}, Q_{h}}\left[L_{h}\right], \c\right)\right]^{T} 
\end{align}

and, 

\begin{align}
    \mathbf{G}^{\text {ideal }}_{ p, q} =& \delta_v\delta_h\left[G^{\text {ideal }}_{ p, q}\left(\psi_{v}^{1,1}[1], \psi_{h}^{1,1}[1] \right) \cdots \right. \nonumber\\ &\left. G^{\text {ideal }}_{ p, q}\left(\psi_{v}^{Q_{v}, Q_{h}}\left[L_{v}\right], \psi_{h}^{Q_{v}, Q_{h}}\left[L_{h}\right]\right)\right]^{T} 
\end{align}


% \begin{align}
%      &\mathbf{G}^{\text {ideal }}_{ q, p}= \nonumber\\&\left[{\delta_{1,1}} G^{\text {ideal }} _{q, p}\left(\psi^{1}_{h}[1], \psi^{1}_{v}[1], \c\right) \ldots {\delta_{Q_h, Q_v}}G^{\text {ideal }} _{q, p}\left(\psi^{Q_h}_{h}[L_h], \psi^{Q_v}_{v}[L_v], \c\right)\right]^{T} 
% \end{align}


Note that we can write, 

\begin{align}
    \mathbf{G}^{\text{ideal }}_{p,q} = \delta_v\delta_h\frac{{(2\pi)}^2}{\delta_v\delta_h} \left(\e_{p,q} \otimes \mathbf{1}_{L, 1}\right)
\end{align}


with $\mathbf{e}_{p,q} \in \mathbb{Z}^{Q}$ being the standard basis vector for the $(p,q)$-th axis among $Q$ ones. 








Now, note that $\mathbf{1}_{L, 1}=\mathbf{g} \odot \mathbf{g}^{*}$ for any equal gain $\mathbf{g} \in \mathbb{C}^L$. Therefore, we can write: 

% $$\mathcal{G}_{L}=\left\{\mathbf{g} \in \mathbb{C}^{L}:\left(\mathbf{g} \mathbf{g}^{H}\right)_{\ell, \ell}=1,1 \leq \ell \leq L\right\}$$


\begin{align}
\mathbf{G}^{\text {ideal }}_{p,q} &={{(2\pi)}^2}\left(\mathbf{e}_{p,q} \otimes(\mathbf{g} \odot \mathbf{g}^{*})\right) \nonumber\\
&=\left({{2\pi}}\left(\mathbf{e}_{p,q} \otimes \mathbf{g}\right)\right) \odot \left({{2\pi}}\left(\mathbf{e}_{p,q} \otimes \mathbf{g}\right)\right)^* \label{g_id_q_equivalent}
\end{align}

Also, note that we can write, 

% \begin{align}
%     \mathbf{G}(\c)=\left(\left(\mathbf{D}_{h}^{H} \otimes \mathbf{D}_{v}^{H}\right) \c\right) \odot\left(\left(\mathbf{D}_{h}^{H} \otimes \mathbf{D}_{v}^{H}\right) \c\right)^{*}
% \end{align}
\begin{align}
    \mathbf{G}(\c)=\left(\D^H \c\right) \odot\left(\D^H \c\right)^{*}
\end{align}

\noindent where, $\D^H = \sqrt{\delta_v\delta_h}(\mathbf{D}_{v}^{H} \otimes \mathbf{D}_{h}^{H})$, and for $a \in \{v,h\}$, we have, 

\begin{align}
\mathbf{D}_{a} &=\left[\mathbf{D}_{a, 1}, \cdots, \mathbf{D}_{a, Q_{a}}\right] \in \mathbb{C}^{M_{a} \times L_{a} Q_{a}} \\
\mathbf{D}_{a, b} &=\left[\mathbf{d}_{M_{a}}\left(\psi_{a}^{b}[1]\right), \cdots, \mathbf{d}_{M_{a}}\left(\psi_{a}^{b}\left[L_{a}\right]\right)\right] \in \mathbb{C}^{M_{a} \times L_{a}}
\end{align}




% where 

% \begin{align}
%     \D = \left[D^{1,1}_{vh}, \cdots, D^{Q_v,Q_h}_{vh}\right] \in \mathbb{C}^{M_vM_h\times L_vL_hQ_vQ_h}
% \end{align}

% \begin{align}
% % &\mathbf{D}_{v} =\left[\mathbf{D}_{v, 1}, \cdots, \mathbf{D}_{v, Q_{v}}\right] \in \mathbb{C}^{M_{v} \times L_{v} Q_{v}} \\
% % &\mathbf{D}_{h} =\left[\mathbf{D}_{h, 1}, \cdots, \mathbf{D}_{h, Q_{h}}\right] \in \mathbb{C}^{M_{h} \times L_{h} Q_{h}} \\
% % &\mathbf{D}_{v, p} =\left[\mathbf{d}_{M_{v}}\left(\psi_{v}^{p}[1]\right), \cdots, \mathbf{d}_{M_{v}}\left(\psi_{v}^{p}\left[L_{v}\right]\right)\right] \in \mathbb{C}^{M_{v} \times L_{v}}\\
% % &\mathbf{D}_{h, q} =\left[\mathbf{d}_{M_{h}}\left(\psi_{h}^{q}[1]\right), \cdots, \mathbf{d}_{M_{h}}\left(\psi_{h}^{q}\left[L_{h}\right]\right)\right] \in \mathbb{C}^{M_{h} \times L_{h}}\\
% &\mathbf{D}_{h, q}(\chi) =\left[\mathbf{d}_{M_{h}}\left(\psi_{h}^{q}[1], \chi \right), \cdots, \mathbf{d}_{M_{h}}\left(\psi_{h}^{q}\left[L_{h}\right], \chi \right)\right] \in \mathbb{C}^{M_{h} \times L_{h}}\\
% &\mathbf{D}_{vh, p,q} =\left[\mathbf{d}_{M_{v}}\left(\psi_{v}^{p}[1]\right) \otimes \mathbf{D}_{h, q}(\psi_{v}^{p}[1]), \cdots, \mathbf{d}_{M_{v}}\left(\psi_{v}^{p}\left[L_{v}\right]\right) \otimes \mathbf{D}_{h, q}(\psi_{v}^{p}\left[L_{v}\right]) \right] \in \mathbb{C}^{M_{v}M_{h} \times L_{v}L_{h}}
% \end{align}

% \begin{align}
% % &\mathbf{D}_{v} =\left[\mathbf{D}_{v, 1}, \cdots, \mathbf{D}_{v, Q_{v}}\right] \in \mathbb{C}^{M_{v} \times L_{v} Q_{v}} \\
% % &\mathbf{D}_{h} =\left[\mathbf{D}_{h, 1}, \cdots, \mathbf{D}_{h, Q_{h}}\right] \in \mathbb{C}^{M_{h} \times L_{h} Q_{h}} \\
% % &\mathbf{D}_{v, p} =\left[\mathbf{d}_{M_{v}}\left(\psi_{v}^{p}[1]\right), \cdots, \mathbf{d}_{M_{v}}\left(\psi_{v}^{p}\left[L_{v}\right]\right)\right] \in \mathbb{C}^{M_{v} \times L_{v}}\\
% % &\mathbf{D}_{h, q} =\left[\mathbf{d}_{M_{h}}\left(\psi_{h}^{q}[1]\right), \cdots, \mathbf{d}_{M_{h}}\left(\psi_{h}^{q}\left[L_{h}\right]\right)\right] \in \mathbb{C}^{M_{h} \times L_{h}}\\
% \mathbf{D}^{p,q}_{h}(\ell) =&\sqrt{\delta_v^{p}\delta^{p,q,\ell}_h}\left[\mathbf{d}_{M_{h}}\left(\psi_{h}^{p,q}[\ell][1] \right), \cdots, \right.\nonumber\\&\left. \mathbf{d}_{M_{h}}\left(\psi_{h}^{p,q}\left[\ell] [L_{h} \right] \right)\right] \in \mathbb{C}^{M_{h} \times L_{h}}, 
% \end{align}

% \begin{align}
%     \mathbf{D}_{vh}^{p,q} =&\left[\mathbf{d}_{M_{v}}\left(\psi_{v}^{p,q}[1]\right) \otimes \mathbf{D}_{h}^{p,q}(1), \cdots, \right.\nonumber\\&\left. \mathbf{d}_{M_{v}}\left(\psi_{v}^{p,q}\left[L_{v}\right]\right) \otimes \mathbf{D}_{h}^{p,q}(L_{v}) \right] \in \mathbb{C}^{M_{v}M_{h} \times L_{v}L_{h}}
% \end{align}

\begin{problem}
Given an equal-gain vector $\g_{p,q} \in \mathbb{C}^L$, $(p,q) \in \{(1,1), \cdots, (Q_v, Q_h)\}$, find vector $\c_{p,q} \in \mathbb{C}^{M_t}$ such that
\begin{align}
&\c_{p,q}=\underset{\c, \|c\|=1}{\arg \min } \lim_{L\rightarrow \infty} \left\|{{2\pi}}\left(\mathbf{e}_{p,q} \otimes \mathbf{g}\right)- \D^H \c\right\|^{2} \label{obj_func}
\end{align}
\label{main_problem_UPA}
\end{problem}


Note that the solution to problem \ref{main_problem_UPA} is the limit of the sequence of solutions to a least-square optimization problem as $L$ goes to infinity. For each $L$ we find that,
 \begin{align}
 {\c}^{(L)}_{p,q} &= {{{2\pi}}}(\D \D^H)^{-1} \D  \left(\mathbf{e}_{p,q} \otimes \mathbf{g}_{p,q}\right) \nonumber\\& =\sigma \D_{p,q}\mathbf{g}_{p,q}
\end{align}
where $\sigma = \frac{2\pi \sqrt{\delta_{v}\delta_{h}}}{LQ\delta_{v}\delta_{h}} = \frac{2\pi}{LQ\sqrt{\delta_v\delta_h}}$, noting that it holds that, 

Noting that it holds that, 

\begin{align}
    (\D\D^H) = \left(L\sum_{(p,q)= (1,1)}^{(Q_h, Q_v)}\sum_{(l_v,l_h)= (1,1)}^{(L_h, L_v)} \delta_{v}\delta_{h}\right)\I_{M_t}
\end{align}

\begin{problem}
Find equal-gain $\g_{p,q} \in \mathbb{C}^L$, $(p,q) = (1,1), \ldots, (Q_h, Q_v)$, such that
\begin{equation}
 \g_{q,p} = \underset{\g}{\arg\min }\left\| abs(\D^H \c_{p,q})- {2\pi} abs(\mathbf{e}_{p,q} \otimes \mathbf{g})\right\|^{2} \label{g_final_eq}
\end{equation} 
where $abs(.)$ denotes the element-wise absolute value of a vector.
\label{g_problem}
\end{problem}


\begin{proposition}
The minimizer of \eqref{g_simple_final_eq} is in the form $\g_q = \left[{\begin{array}{cccc} 1& \alpha^\eta &\cdots & \alpha_v^{\eta (L_v -1)}\alpha_h^{\eta (L_h -1)} \end{array}}\right]^T$ for some $\eta$ where $\alpha_v = e^{j(\frac{\eta_v}{L_v})}$ and $\alpha_h = e^{j(\frac{\eta_h}{L_h})}$. \label{proposiiton_g}
\end{proposition}

 \begin{align}
     {\c_{p,q}}^{(L)} & = \sigma \sum_{(l_v, l_h)=(1,1)}^{(L_v, L_h)}g_{p,q, l}\mathbf{d}_{M_t}\left(\psi^{p}_{v}[l_v], \psi^{q}_{h}[l_h]\right)  \nonumber\\
     & = \sigma \sum_{l=1}^L g_{q,p,l}\left[{\begin{array}{ccc}
     1 &\cdots & e^{j\phi_{p,q}^{M_v-1, M_h-1}}\\
     \end{array}}\right]^T   
    %  \nonumber\\& = \left[{\begin{array}{ccc}
    %  \sigma\sum_{l=1}^L g_{q, p, l}& \cdots & \sigma\sum_{l=1}^L g_{q,p, l}e^{j\left((M_h-1)\psi^q_{h}[l] + (M_v-1)\psi^p_{v}[l]\right)}\\
    %  \end{array}}\right]^T
\end{align}

where $ \phi_{p,q}^{m_v, m_h} = \left( m_v\psi^{p}_{v}[l_v] + m_h\psi^{q}_{h}[l_h]\right)$. We can then write 

\begin{align}
    c_{p,q, m_v, m_h} &= \nonumber\\& \lim_{L_h, L_v\rightarrow \infty} \frac{1}{L_hL_v}\sum_{(l_h, l_v)=(1,1)}^{(L_h, L_v)} g_{p,q, l_v, l_h}e^{j\phi_{p,q}^{M_v-1, M_h-1}}
\end{align}


\begin{align}
    c_{p,q, m_v, m_h} &=  \lim_{L_h, L_v\rightarrow \infty} \frac{1}{L_hL_v}\sum_{(l_h, l_v)=(1,1)}^{(L_h, L_v)} g_{p,q, l_v, l_h}\nonumber \\&e^{j\left(m_v(\psi^{p-1}_{v}+l_v\frac{\delta_v}{L_v})+ m_h(\psi^{q-1}_{h} + l_h\frac{\delta_h}{L_h}) \right)}
\end{align}


\begin{align}
    c_{p,q, m_v, m_h} =&  \frac{2\pi}{Q}e^{j\phi_{p-1, q-1}^{m_v, m_h}}
    \left(\frac{1}{L_v}\lim_{ L_v\rightarrow \infty} \sum_{l_v=1}^{L_v} e^{j\frac{\eta_v+ m_v\delta_v}{L_v} l_v}\right) \nonumber\\&
    \left(\frac{1}{L_h}\lim_{ L_h\rightarrow \infty} \sum_{l_h=1}^{L_h} e^{j\frac{\eta_h+ m_h\delta_h}{L_h} l_h}\right)
\end{align}

\begin{align}
    c_{p,q, m_v, m_h} &=  \frac{2\pi}{Q}e^{j\phi_{p-1, q-1}^{m_v, m_h}}
    \int_{0}^{1} e^{j\xi_v x}dx\int_{0}^{1} e^{j\xi_h x}dx \nonumber\\&
    = \frac{2\pi}{Q}e^{j(\phi_{p-1, q-1}^{m_v, m_h}+ \frac{\xi_v+\xi_h}{2})} sinc(\frac{\xi_v}{2\pi})sinc(\frac{\xi_h}{2\pi})
\end{align}

with $\xi_a = {\delta_a}{m_a} + \eta_a$, where $a\in \{v,h\}$. 
% Therefore, it. holds that, 

% \begin{align}
%     c_{p,q, m_v, m_h} &=  \lim_{ L_v\rightarrow \infty} \frac{\delta^p_v}{L_v}\sum_{l_v=1}^{L_v} e^{j(m_v(\psi^{p-1,q}_{v}+l_v\frac{\delta^p_v}{L_v}) + x\eta\frac{l_v}{L_v})} \delta^{p,q,l_v}_h e^{jm_h\psi^{p,q-1}_{h}[l_v]}sinc(\frac{\xi}{2\pi}) 
% \end{align}