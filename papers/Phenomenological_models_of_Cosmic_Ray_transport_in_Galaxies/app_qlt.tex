% !TEX root = ./main.tex
\section{Calculation of diffusion coefficient in quasilinear-theory}
\label{app:diffusioncoefficient}

In this appendix, we explore the interaction between charged particles and an astrophysical plasma to derive the spatial diffusion coefficient using the quasilinear theory (QLT). 
%
QLT allows to directly compute this coefficient and other transport parameters based on the previous knowledge of the turbulent spectra.
%
The quasilinear approximation can be seen as a first-order perturbation theory and here we follow standard derivations as in~\cite{Blandford1987pr,Shalchi2009book,Blasi2013aar}.

Recent developments on this subject are given in the P.~Blasi and A.~Marcowith lecture notes in this volume.

First, we consider the equations of motion for a particle traveling within an ordered magnetic field aligned with the $\hat{\vb z}$ axis, denoted as $\vb B_0 = B_0 \hat{\vb z}$. In the absence of a large-scale electric field, the particle's motion is described by the Lorentz force:
%
\begin{equation}
\frac{d \vb p}{dt} = \frac{q}{c} (\vb v \wedge \vb B_0)
\label{eq:lorentz}
\end{equation}

The Lorentz force acts perpendicular to the particle's motion, preserving the velocity's magnitude. By splitting the motion into its components, we obtain:
%
\begin{equation}
m \gamma \frac{d \vb v}{dt} = \frac{q}{c} (\vb v \wedge \vb B_0) \quad \rightarrow \quad 
\begin{cases}
m \gamma \frac{dv_x}{dt} = \frac{q}{c} v_y B_0 \\
m \gamma \frac{dv_y}{dt} = -\frac{q}{c} v_x B_0\\
\frac{dv_z}{dt} = 0
\end{cases}
\label{eq:lorentzcomponents}
\end{equation}

The last equation shows that $v_z = v_\| = v \cos \theta$ remains constant. Consequently, the pitch angle, defined as the cosine of the angle between the particle velocity and the magnetic field direction ($\mu = \cos \theta$), is a conserved quantity, as $dv_z/dt = v d\mu/dt = 0$.

Combining the first two equations yields two second-order differential equations:
%
\begin{equation}
\frac{d^2 v_{x,y}}{dt^2} = - \Omega^2 v_{x,y}
\end{equation}

Here, we introduce the Larmor frequency $\Omega = \frac{q B_0}{m \gamma c}$.

This equation can be easily solved as simple harmonic motion along the $\hat{\vb x}$ axis, where $v_{x} = v_{0,x} \cos (\Omega t)$. Using this solution, we can solve the system~\eqref{eq:lorentzcomponents} as follows:
%
\begin{equation}
\begin{cases}
v_x = v_{0,\perp} \cos (\phi - \Omega t) \\
v_y = - v_{0,\perp} \sin (\phi - \Omega t) \\
v_z = v_{0,\parallel}
\end{cases}
\rightarrow \, 
\begin{cases}
v_x = v_{0} (1 - \mu^2)^{\frac{1}{2}} \cos (\phi - \Omega t) \\
v_y = - v_{0} (1 - \mu^2)^{\frac{1}{2}} \sin (\phi - \Omega t) \\
v_z = v_{0} \mu
\end{cases}
\end{equation}

Here, $\phi$ is an arbitrary phase, $v_{0,\perp}$ represents the initial velocity of the particle in the $xy$-plane, given by $v_{0,\perp} = v_0 \sin \theta = v_0 (1-\mu^2)^{1/2}$.

The solution above represents a helical motion with a uniform drift along $\hat{\vb z}$, described by the equation of motion $z = v \mu t$.

Now we consider introducing a perturbation to the magnetic field with components $\delta \mathbf{B} \equiv (\delta {\rm B}_x, \delta {\rm B}_y, \delta {\rm B}_z)$, where $|\delta \mathbf{B}| \ll |\mathbf{B}_0|$. In this case, we assume a pure Alfvénic wave propagating along the background magnetic field, which implies $\delta {\rm B}_z = 0$ and the wave oscillates such that $\delta \mathbf{B} \perp \mathbf{k}$.

This allows us to express the system of equations~\eqref{eq:lorentz} as follows:
%
\begin{equation}
m \gamma \frac{d\vb v}{dt} = \frac{q}{c}
\left|
\begin{array}{ccc}
\hat {\vb x}  & \hat {\vb y}  & \hat {\vb z}  \\
v_x & v_y & v_z \\
\delta {\rm B}_x & \delta {\rm B}_y & {\rm B}_0 
\end{array}
\right|
\oset{\delta {\rm B} \ll {\rm B}_0} \simeq
\frac{q}{c}
\left(
\begin{array}{c}
v_y {\rm B}_0 \\
-v_x {\rm B}_0 \\
v_x \delta {\rm B}_y - v_y \delta {\rm B}_x
\end{array}
\right)
\end{equation}

As prescribed by QLT, we neglect the perturbation field in the $x$ and $y$ components. This implies that the circular orbits in the plane perpendicular to the background field are approximately unaffected. However, the perturbation does cause a change in the $z$ component of the velocity, leading to a modification in the pitch angle $\mu$ of the particle. It's important to note that the perturbation does not affect the particle's momentum value; we are describing the motion in the reference frame of the perturbation, where the only force acting on the particle is the Lorentz force. Consequently, while numerous pitch-angle changes can eventually reverse the parallel velocity of the particle, they cannot shift the guiding center of the orbits.

To examine the extent of this change, we focus on the last equation of the system mentioned above, which governs the \emph{perturbed} motion along $z$:
%
\begin{equation}
m \gamma \frac{dv_z}{dt} = \frac{q}{c} \left[v_x(t) \delta {\rm B}_y - v_y(t) \delta {\rm B}_x \right]
\end{equation}

As a consequence, the pitch angle changes with time according to:
%
\begin{equation}
m\gamma v \frac{d\mu}{dt} = \frac{q}{c}v_{0,\perp} \left[\cos(\phi-\Omega t) \delta {\rm B}_y - \sin(\phi - \Omega t) \delta {\rm B}_x\right]
\label{eq:pitchanglemotion}
\end{equation}

To proceed, we make the simplifying assumption that the perturbed field is circularly polarized, meaning the wave components have the same amplitude: $|\delta {\rm B}_{x}| = |\delta {\rm B}_{y}| = |\delta {\rm B}|$. Thus, we can express the perturbation as:
%
\begin{equation}
\begin{cases}
\delta {\rm B}_y = &  \delta {\rm B} \exp \left[ i (kz - \omega t) \right] \\ %= \cos(kz - \omega t + \psi) + i \sin ((kz - \omega t + \psi)\\
\delta {\rm B}_x = & \pm i \delta {\rm B}
\end{cases}
\end{equation}

Taking the real part gives:
%
\begin{equation}
\begin{cases}\delta {\rm B}_y = & \delta {\rm B} \cos (kz - \omega t) \\
\delta {\rm B}_x = & \mp\delta {\rm B} \sin (kz - \omega t) 
\end{cases}
\end{equation}
%
therefore, by substituting in equation~\eqref{eq:pitchanglemotion}, we find
%
\begin{equation}
m\gamma v \frac{d\mu}{dt} = 
\frac{q}{c}v_{0,\perp} \delta{\rm B} \left[\cos(\phi-\Omega t) \cos (kz - \omega t) \pm \sin(\phi - \Omega t) \sin (kz - \omega t)\right]
\end{equation}
%
which simplifies to\footnote{We use the trigonometric relation $\cos \alpha \cos \beta \pm \sin \alpha \sin \beta = \cos (\alpha \mp \beta)$}:
%
\begin{equation}
m\gamma v \frac{d\mu}{dt} = 
\frac{q}{c}v_{0,\perp} \delta {\rm B} \cos(\phi-\Omega t \mp kz \pm \omega t)
\end{equation}

For Alfvén waves, the dispersion relation is given by $\omega = k v_{\rm A}$, where $v_{\rm A}$ represents the Alfvén velocity. By comparing the spatial frequency with the temporal frequency in the argument of the cosine function, we can derive the following relation:
%
\begin{equation}
\frac{kz}{\omega t} \simeq \frac{k v \mu t}{k v_{\rm A} t} \sim \frac{v}{v_{\rm A}} \mu
\label{eq:kmomegat}
\end{equation}

Here, we utilize the fact that for an unperturbed orbit, the position $z$ of the particle is given by $z = v \mu t$.

Considering that $v$ is of the order of the speed of light, while $v_{\rm A}$ in the average ISM is approximately 10 km/s, we find that the ratio in equation~\eqref{eq:kmomegat} is significantly greater than 1 unless $\mu \ll v_{\rm A} / v$.

Consequently, we can neglect the term $\omega t$ in comparison to $kz$. This choice is equivalent to selecting a reference frame in which the waves appear stationary. In this frame, there is no electric field associated with the waves.

We can approximate the pitch angle equation of motion as
%
\begin{equation}
\frac{d\mu}{dt} \simeq \Omega
(1-\mu^2)^{\frac 1 2} \frac{\delta {\rm B}}{{\rm B}_0} \cos\left[\phi + (\Omega \pm k v \mu) t \right]
\end{equation}

The equation above implies a periodic variation in the pitch angle. When we integrate this equation over a sufficiently long time interval, the average of the integrated quantity becomes zero. This result is physically expected since the particle orbits are concentric circles.

However, if we instead consider the square of the pitch-angle variation: 
%
\begin{multline}
\langle \Delta \mu \Delta \mu \rangle = \int_0^{2\pi} \frac{d\phi}{2\pi} \int_0^{\Delta t} dt \frac{d\mu}{dt}(t) \, \int_0^{\Delta t} dt^\prime \frac{d\mu}{dt}(t^\prime) \\ = \Omega^2 (1 - \mu^2) \left( \frac{\delta {\rm B}}{{\rm B}_0} \right)^2 \int_{0}^{\Delta t} dt \int_{0}^{\Delta t} dt^\prime \, \cos[(\Omega \pm k v \mu) t] \cos[(\Omega \pm k v \mu) t^\prime]
\end{multline}

The integrand functions are even, so we can double the interval of the $dt^\prime$ integral as $\int_{-\Delta t}^{\Delta t} dt^\prime$ and add a factor of $\frac{1}{2}$. Additionally, as we are considering sufficiently large times to evaluate the effect of scattering ($\Delta t \gg t, t^\prime$), the same interval can be approximated as $\int_{-\infty}^{\infty} dt^\prime$.

Therefore, we have\cite{Shalchi2009book}:
%
\begin{multline}
\langle \Delta \mu \Delta \mu \rangle = \\ \Omega^2 \frac{(1 - \mu^2)}{2} \left( \frac{\delta {\rm B}}{{\rm B}_0} \right)^2 \int_{0}^{\Delta t} \!\! dt \, {\rm Re} \{ \exp[i(\Omega \pm k v \mu) t] \} \, \int_{-\infty}^{\infty} \!\! dt^\prime \,  {\rm Re}\{\exp[i(\Omega \pm k v \mu) t^\prime]\}
\end{multline}
%
and solve the integral on $t^\prime$\footnote{We use the property $\delta(x-a) = \frac{1}{2\pi}\int_{-\infty}^\infty dy {\rm e}^{iy(x-a)}$}, as to obtain:
%
\begin{equation}
\langle \Delta \mu \Delta \mu \rangle = \Omega^2 \frac{(1 - \mu^2)}{2} \left( \frac{\delta {\rm B}}{{\rm B}_0} \right)^2 \int_{0}^{\Delta t} \!\! dt \, {\rm Re} \{ \exp[i(\Omega \pm k v \mu) t] \} \, 2\pi \delta (\Omega \pm k v \mu)
\end{equation}

The motion of the pitch angle, having null mean and variance different from zero, is typical of a diffusive process with diffusion coefficient $D_{\mu\mu}$, which represents the average rate of change of the square of the pitch angle over the time interval $\Delta t$.

Now the second integral, because of the presence of the~\emph{delta} function, gives just a factor $\int_{0}^{\Delta t} dt = \Delta t$, and we can write:
%
\begin{equation}
D_{\mu\mu} \equiv \left\langle \frac{\Delta \mu \Delta \mu}{\Delta t} \right\rangle = \Omega^2 \left( \frac{\delta {\rm B}}{{\rm B}_0} \right)^2 (1 - \mu^2) \, \pi \delta(\Omega \pm k v_{\parallel})
\label{eq:dmumuvar}
\end{equation}

In general, one must consider a packet of turbulent waves with energy distribution per wave number denoted as $W(k) dk$. This distribution represents the energy density contained within the range of wavenumbers $[k, k + dk]$ and is normalized to the energy density of the background magnetic field, $\frac{B_0^2}{8\pi}$. Specifically:
%
\begin{equation}
\left( \frac{\delta {\rm B}(k)}{{\rm B}_0} \right)^2 = W(k) dk.
\end{equation}

By incorporating this consideration, we can extend equation~\eqref{eq:dmumuvar} to obtain:
%
\begin{equation}
D_{\mu \mu} \equiv \left\langle \frac{\Delta \mu \Delta \mu}{\Delta t} \right\rangle = \Omega^2 (1 - \mu^2) \pi \int dk \, W(k) \delta(\Omega \pm k v_{\parallel}) \, .
\end{equation}

Introducing the resonant wavenumber $k_{\rm res}$, defined as the inverse of the Larmor radius $k_{\rm res} = r_{\rm L}^{-1} = \Omega/ v_\|$, we can express $D_{\mu \mu}$ as follows\footnote{We use the property $\int dx \delta (c x) = \frac{1}{|c|} \int dx \delta (x)$}:
%
\begin{equation} 
D_{\mu \mu} = \Omega (1 - \mu^2) \pi k_{\mathrm{res}} \int dk \, W(k) \delta(k \pm k_{\mathrm{res}}) = \Omega (1 - \mu^2) \pi k_{\mathrm{res}} W(k_{\rm res})
\end{equation}

These equations reveal that a wave-particle interaction is only possible when the inverse Larmor radius of the particle matches (i.e., is resonant) with the wavenumber of the turbulent wave. This type of process is commonly referred to as \emph{gyroresonant} scattering\footnote{It is worth noting that the QLT is consistently inadequate when attempting to describe pitch-angle diffusion at 90 degrees ($\mu = 0$) and reversing direction becomes a consideration. To address these and other limitations, several Nonlinear Theories have been formulated and developed.}.

The typical diffusion time, defined as the timescale to invert the pitch angle by about one radian is
%
\begin{equation}
\tau_{\rm diff} \simeq \frac{1}{D_{\theta\theta}} = \frac{1-\mu^2}{D_{\mu\mu}} = \frac{1}{\pi \Omega k_{\rm res} W(k_{\rm res})}
\end{equation}
%
where $D_{\theta\theta}$ is the diffusion coefficient in angle.

As in a diffusion timescale the particle moves by a distance of about $\Delta z = v \tau_{\rm diff}$, the spatial diffusion coefficient coefficient can be roughly estimated as
%
\begin{equation}
D_{zz} = v (v \tau_{\rm diff}) = \frac{v^2}{\pi \Omega k_{\rm res} W(k_{\rm res})} \simeq \frac{1}{3} r_{\rm L} v \frac{1}{k_{\rm res} W(k_{\rm res})} 
\end{equation}
%
where we have made the approximation $\pi \sim 3$. This informs us that the spatial diffusion coefficient is always much larger than the Bohm diffusion ($D_{\rm B} = \frac{1}{3} r_{\rm L} v$) since $k_{\rm res} W(k_{\rm res}) \ll 1$ at the relevant scales.