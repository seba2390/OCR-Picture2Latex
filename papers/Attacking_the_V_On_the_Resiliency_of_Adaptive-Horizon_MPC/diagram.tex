%%%%%%%%%%%%%%%%%%% colors
\definecolor{ShineSky}{rgb}{0, 0.9, 1}
\definecolor{ShineGrass}{rgb}{0.85, 0.88, 0.59}
\definecolor{InfosysDarkGrey}{gray}{0.4}
\definecolor{InfosysLightGrey}{gray}{0.6}
\definecolor{TuWienBlue}{cmyk}{1,0.38,0,0.15}
\definecolor{TuInfRed}{cmyk}{0,1,1,0}

%%%%%%%%%%%%%%%% blocks
\tikzstyle{block} = [draw, fill=ShineSky!20, rectangle, 
minimum height=3em, minimum width=6em]
\tikzstyle{conf} = [draw, fill=ShineSky!20, circle, node distance=0.7cm]
\tikzstyle{inv} = [draw, circle, node distance=0.7cm]
\tikzstyle{dots} = [->,>=stealth',shorten >=1pt,auto,node distance=2cm,
main node/.style={thick,circle,draw,font=\sffamily\Large}]
\tikzstyle{process} = [rectangle, minimum width=3cm, minimum height=1cm, text 
centered, draw=black, fill=orange!30]
\tikzstyle{arrow} = [thick,->,>=stealth]
\tikzstyle{pso} = [rectangle, rounded corners, minimum width=0.5cm, minimum 
height=0.5cm,text centered, draw=black, fill=gray!30]
\tikzstyle{fit} = [rectangle, rounded corners, minimum width=0.5cm, minimum 
height=0.5cm,text centered, draw=black, fill=gray!30]
\tikzstyle{box} = [fill=lightgray!45,rounded corners,minimum 
width=1.1cm,minimum height=4.02cm, anchor=north]
\tikzstyle{decision} = [diamond, aspect=1, minimum width=1cm, text 
centered, draw=black, fill=ShineGrass]
\tikzstyle{output} = [coordinate]

\begin{tikzpicture}[auto, node distance=2cm,>=latex', cross/.style={path 
	picture={ 
		\draw[black]
		(path picture bounding box.south east) -- (path picture bounding 
		box.north west) (path picture bounding box.south west) -- (path picture 
		bounding box.north east);
	}}]
	
	%%%%%%%%%%%%%% clones
	\node (start) [conf] {};
    \node [above = .2mm of start,text width=.3cm,align = center]{\scriptsize{$s_0$}};
	
% 	\node (c1) [conf, right = 5mm of start] {};
% 	\node (c2) [conf, above of=c1] {};
% 	\node (c3) [conf, above of=c2] {};
% 	\node (cn) [conf, below = 15mm of c1] {};
	
% 	\path (c1) -- node (dots) [auto=false]{\vdots} (cn);
	
% 	\draw [->] (start) -- (c1);
% 	\draw [->] ($ (start) !0.5! (c1) $) |- (c2);
% 	\draw [->] ($ (start) !0.5! (c1) $) |- (c3);
% 	\draw [->] ($ (start) !0.5! (c1) $) |- (c3);
% 	\draw [->] ($ (start) !0.5! (c1) $) |- (cn);
% 	\node [above = 0.2mm of c3,text width=2cm,align = 
% 	center]{\scriptsize{$s_0$}};
	
	%%%%%%%%%%%%% PSO	
	\node(pso1) [pso, right=3mm of start] {\scriptsize{PSO}};

	\draw [->] (start) -- (pso1);
	
	\node (c1n) [conf, right = 6mm of pso1] {};

	\draw [->] (pso1) -- node {\scriptsize{$\va^{h}$}} (c1n);
	
	%%%%%%%%%%%%%%%%%%%%% Fitness
	
	\node(fit1) [fit, right=6mm of c1n] {\scriptsize{${J}$}};

	\draw [->] (c1n) -- (fit1);
	
	%%%%%%%%%%%%%%%%%% Conditions
	\node (dec1) [decision, right = 1cm of fit1] {\scriptsize{$\ell_{i-1} - 
	\widehat{J} > \Delta_1$}}; 
	\draw[->] (fit1) -- node{\scriptsize{}}(dec1);
	\node (dec2) [decision,aspect=3, below = .5cm of dec1] {\scriptsize{${h} < 
	{h}_{max}$}};

	
    
    \node (step) [rectangle, text centered, draw=black, rounded corners, fill=gray!30, right = 7mm of dec1]{\scriptsize{Apply $a^1$}};
	
	\node (incH) [rectangle, text centered, draw=black, rounded corners, 
	fill=gray!30, left = 10mm of dec2]{\scriptsize{$h\mathrel{++}$}};
	
	\node (dec5) [decision,aspect=3, below = 4mm of dec2] {\scriptsize{${p} < 
	{p}_{max}$}};
	
	\node (incP) [rectangle, text centered, draw=black, text width=1.5cm, 
	rounded corners, fill=gray!30] at (incH |- dec5){\scriptsize{$h:=1;$}\\\scriptsize{$p\mathrel{+}=p_{inc};$}};
	
	\node (stuff) [rectangle, text centered, draw=black, rounded corners, 
	fill=gray!30, right = 12mm of step]{\scriptsize{$\ell_i:=\widehat{J}$}};
    
    \node (dec3) [decision,aspect=3, below = 4.1cm of stuff] 
	{\scriptsize{$\ell_i > \varphi$}};
    
    \node (dec4) [decision,aspect=3, below = 4mm of dec5] 
	{\scriptsize{$i < m$}};
    
    \node (incL) [rectangle, text centered, draw=black, rounded corners, 
	fill=gray!30] at (pso1 |- dec4){\scriptsize{$i\mathrel{++}$}};
  
	%%%%%%%%%%%%%% Arrows
	\draw[->](dec1.south) -- node(arr3){\scriptsize{No}} (dec2.north);
    
    \draw[->](dec1.east) -- node(arrApply){\scriptsize{Yes}}(step.west);
	
	\draw[->](stuff.south) |- (dec3.north);
    
	\draw[->](dec3.west) -- node(arr1)[above]{\scriptsize{Yes}} (dec4.east);
	\draw[->] (dec4.west) -- node(arr5)[above]{\scriptsize{Yes}} (incL.east);
	\draw[->] (incL.north) -- (pso1.south);
	\draw[->](dec2.west) -- node(arr6)[above,near start]{\scriptsize{Yes}} 
	(incH.east);
	\draw[->](incH.west) --  (incH -| incL);%(psoBox.south);
	
	\draw[->](step.east) -- (stuff);
	
	\draw[->](dec2.south) -- node[right]{\scriptsize{No}} (dec5.north);
	\draw[->] (dec5.west) -- node(arr7)[above,near 
	start]{\scriptsize{Yes}}(incP);
	\draw[->] (incP) -- (incP -| incL);%(psoBox.south);
	\node(V) [below = 4mm of dec3,text width=2cm,align = 
	center]{\scriptsize{\textbf{Stable state}}};
	\draw[->] (dec3.south) --node[right]{\scriptsize{No}} (V);
	\node(time) [below = 4mm of dec4,text width=2cm,align = 
	center]{\scriptsize{\textbf{Timeout}}};
	
	\draw[->] (dec4.south) --node[right]{\scriptsize{No}} (time);
	\node(exaust) [right = 6mm of dec5,text width=2.8cm,align = 
	center]{\scriptsize{\textbf{Particle exhaustion}}};
	\draw[->] (dec5.east) --node[above]{\scriptsize{No}} (exaust);
	
	\end{tikzpicture}