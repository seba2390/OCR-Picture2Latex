%%%%%%%%%%%%%%%%%%% colors
\definecolor{ShineSky}{rgb}{0, 0.9, 1}
\definecolor{ShineGrass}{rgb}{0.85, 0.88, 0.59}
\definecolor{InfosysDarkGrey}{gray}{0.4}
\definecolor{InfosysLightGrey}{gray}{0.6}
\definecolor{TuWienBlue}{cmyk}{1,0.38,0,0.15}
\definecolor{TuInfRed}{cmyk}{0,1,1,0}

%%%%%%%%%%%%%%%% blocks
\tikzstyle{conf} = [draw, fill=Yellow!20, circle, node distance=0.7cm]
\tikzstyle{inv} = [draw, circle, node distance=0.7cm]
\tikzstyle{arrow} = [thick,->,>=stealth]
\tikzstyle{pso} = [rectangle, rounded corners, minimum width=0.5cm, minimum 
height=0.5cm,text centered, draw=black, fill=ShineSky!20]
\tikzstyle{fit} = [rectangle, rounded corners, minimum width=0.5cm, minimum 
height=0.5cm,text centered, draw=black, fill=ShineSky!20]
\tikzstyle{decision} = [diamond, aspect=1, minimum width=1cm, text 
centered, draw=black, fill=ShineSky!20]
\tikzstyle{output} = [coordinate]

\begin{tikzpicture}[auto, node distance=2cm,>=latex', cross/.style={path 
	picture={ 
		\draw[black]
		(path picture bounding box.south east) -- (path picture bounding 
		box.north west) (path picture bounding box.south west) -- (path picture 
		bounding box.north east);
	}}]
	
	%%%%%%%%%%%%%% configuration
	\node (start) [conf] {};
    \node [above = .2mm of start,text width=.3cm,align = center]{\scriptsize{$s_0$}};
	
	%%%%%%%%%%%%% PSO	
	\node(pso1) [pso, right=3mm of start] {\scriptsize{PSO}};

	\draw [->] (start) -- (pso1);
	
	\node (c1n) [conf, right = 6mm of pso1] {};

	\draw [->] (pso1) -- node {\scriptsize{$\va^{h}$}} (c1n);
	
	%%%%%%%%%%%%%%%%%%%%% Fitness
	
	\node(fit1) [fit, right=4mm of c1n] {\scriptsize{${J}$}};

	\draw [->] (c1n) -- (fit1);
	
	%%%%%%%%%%%%%%%%%% Conditions
	\node (dec1) [decision, right = 0.4cm of fit1] {\scriptsize{$\ell_{i-1} - 
	J > \Delta$}}; 
	\draw[->] (fit1) -- node{\scriptsize{}}(dec1);
    
    \node (fitCheck) [decision, aspect=3, below = 5mm of dec1]{\scriptsize{$J < \widehat{J}$}};
    
	\node (dec2) [decision,aspect=3, below = 5mm of fitCheck] {\scriptsize{${h} < 
	{h}_{max}$}};

% 	\node (applyMaxA) [rectangle, text centered, draw=black, rounded corners, fill=gray!50, below = 5mm of dec2] {\scriptsize{\textbf{Apply $a^h_1$}}};

 \node (setJh) [pso,text width=1cm, right =6mm of dec1]{\scriptsize{$\widehat{h}:=h$}\\\scriptsize{$\widehat{J}:=J$}};
    
    \node (step) [pso,right = 4mm of setJh]{\scriptsize{Apply $a^{\widehat{h}}_1$}};
	
	\node (incH) [pso,left = 10mm of dec2]{\scriptsize{$h\mathrel{++}$}};
	
% 	\node (dec5) [decision,aspect=3, below = 4mm of dec2] {\scriptsize{${p} < 
% 	{p}_{max}$}};
	
% 	\node (incP) [rectangle, text centered, draw=black, text width=1.5cm, 
% 	rounded corners, fill=gray!30] at (incH |- dec5){\scriptsize{$h:=1;$}\\\scriptsize{$p\mathrel{+}=p_{inc};$}};
	
 	\node (replace) [pso,text width=1cm] at (setJh |- fitCheck) {\scriptsize{$\widehat{J} \mathrel{:}= J$}\\\scriptsize{$\widehat{h} := h$}};
%     
	\node (incL) [coordinate,below = 4.5cm of pso1]{};
    
    
%     \node (dec4) [decision,aspect=3, below = 10mm of dec2] 
% 	{\scriptsize{$i < m$}};

%     \node (dec3) [decision,aspect=3] at (stuff |- dec4)
% 	{\scriptsize{$\ell_i > \varphi$}};

    \node (stuff) [pso,text width=1.2cm,align=left,right = 4mm of step] {\scriptsize{$\ell_i:=\widehat{J}$}\\\scriptsize{$i\mathrel{++}$}\\\scriptsize{$h:=1$}\\\scriptsize{$\widehat{J}:=inf$}};
    
    
    \node (setP) [pso, text width=1.5cm] at (incL |- replace){\scriptsize{$p\mathrel{:}=n \cdot h \cdot 2$}};

%     \node (resH) [rectangle, text centered, draw=black, rounded corners, 
% 	fill=gray!30, above = 3mm of incL]{\scriptsize{$h:=1$}};

	
  
	%%%%%%%%%%%%%% Arrows
	\draw[->](dec1.south) -- node(arr3){\scriptsize{No}} (fitCheck.north);
    \draw[->](fitCheck.south) -- node[right]{\scriptsize{No}}(dec2.north);
    \draw[->](dec1.east) -- node(arrApply){\scriptsize{Yes}}(setJh.west);
    \draw[->](setJh.east) -- (step);
	
	%\draw[->](stuff.south) -- (dec3.north);
    
	%\draw[->](dec3.west) -- node(arr1)[above]{\scriptsize{Yes}} (dec4.east);
	%\draw[->] (dec4.west) -- node(arr5)[above]{\scriptsize{Yes}} (incL.east);
% 	\draw[->] (incL.north) -- (resH.south);
%   \draw[->] (resH.north) -- (pso1.south);

	%\draw[->] (incL.north) -- (pso1.south);
    
    \draw[->] (incL.north) -- (setP.south);
    \draw[->] (setP.north) -- (pso1.south);
    
	%\draw[->](dec5.west) -- node(arr6)[above,near start]{\scriptsize{Yes}} 
	%(resH.east);
    \draw[->](dec2.west) -- node(arr6)[above,near start]{\scriptsize{Yes}} 
	(incH.east);
	\draw[->](incH.west) --  (incH -| incL);%(psoBox.south);
    %\draw[->](dec2.south) -- node[right]{\scriptsize{No}}(applyMaxA);
    
%     \draw[->](applyMaxA) -- (dec4);
	
	\draw[->](step.east) -- (stuff);
    \draw[->](fitCheck.east) -- node[above,near start]{\scriptsize{Yes}} (replace.west);
    \draw[->](replace.south) |- (dec2.east);

% 	\node(V) [below = 4mm of dec3,text width=2cm,align = 
% 	center]{\scriptsize{\textbf{Stable state}}};
% 	\draw[->] (dec3.south) --node[right]{\scriptsize{No}} (V);
% 	\node(time) [below = 4mm of dec4,text width=2cm,align = 
% 	center]{\scriptsize{\textbf{Timeout}}};
	
% 	\draw[->] (dec4.south) --node[right]{\scriptsize{No}} (time);

	\draw[-] (stuff.south) |- (incL.east);
	\draw[->] (dec2.south) --node[right]{\scriptsize{No}} ++(0,-.5) -|  (step.south);
	
	\end{tikzpicture}